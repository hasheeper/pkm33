<?xml version="1.0" ?>
<pkm_project>
    <directory name=".vite">
        <directory name="deps">
            <file name="_metadata.json"><![CDATA[{
  "hash": "9b451d1c",
  "configHash": "3ab7af57",
  "lockfileHash": "0db37eff",
  "browserHash": "eb07abbc",
  "optimized": {},
  "chunks": {}
}]]></file>
            <file name="package.json"><![CDATA[{
  "type": "module"
}
]]></file>
        </directory>
    </directory>
    <directory name="battle">
        <file name="battle-calc.js"><![CDATA[/**
 * ===========================================
 * BATTLE-CALC.JS - ä¼¤å®³è®¡ç®—å¼•æ“
 * ===========================================
 * 
 * ä» engine/battle-engine.js è¿ç§»
 * 
 * èŒè´£:
 * - çº¯ä¼¤å®³æ•°å€¼è®¡ç®—
 * - å±æ€§å…‹åˆ¶è®¡ç®—
 * - æš´å‡»/å‘½ä¸­åˆ¤å®š
 * - å¤šæ®µæ”»å‡»
 * - ç‰¹æ€§/é“å…·ä¿®æ­£
 * 
 * ä¾èµ–: pokedex-data.js, moves-data.js, ability-handlers.js, items-data.js
 */
/**
 * ä¼¤å®³è®¡ç®— (å«èƒ½åŠ›ç­‰çº§ä¿®æ­£ã€å‘½ä¸­åˆ¤å®šã€å¤šæ®µæ”»å‡»ã€æš´å‡»ç‡)
 * @param {Pokemon} attacker 
 * @param {Pokemon} defender 
 * @param {object} move - { type, power, cat, accuracy }
 * @param {object} options - { isSimulation: boolean } å¯é€‰å‚æ•°
 * @returns {object} - { damage, effectiveness, isCrit, miss, hitCount, blocked }
 */
export function calcDamage(attacker, defender, move, options = {}) {
    // è·å– battle å¯¹è±¡
    const battle = (typeof window !== 'undefined') ? window.battle : null;
    // è·å–å®Œæ•´æŠ€èƒ½æ•°æ®
    const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    // === ã€ç‰¹æ€§é’©å­ã€‘onModifyMove - ä¿®æ”¹æ‹›å¼å±æ€§/å¨åŠ› (Liquid Voice ç­‰) ===
    if (typeof AbilityHandlers !== 'undefined' && attacker.ability) {
        const abilityHandler = AbilityHandlers[attacker.ability];
        if (abilityHandler && abilityHandler.onModifyMove) {
            abilityHandler.onModifyMove(move, attacker);
        }
    }
    const accuracy = move.accuracy ?? fullMoveData.accuracy;
    let category = fullMoveData.category || (move.cat === 'spec' ? 'Special' : (move.cat === 'phys' ? 'Physical' : 'Status'));
    let basePower = move.power ?? fullMoveData.basePower ?? 0;
    // =====================================================
    // === ã€æå·¨åŒ–/Zæ‹›å¼å¨åŠ›ä¿®æ­£è¡¥ä¸ã€‘ ===
    // =====================================================
    const moveName = move.name || '';
    const isMaxMoveName = moveName.startsWith('Max ') || moveName.startsWith('G-Max ');
    const isZMoveName = moveName.includes('10,000,000') || 
                        moveName.includes('Catastropika') || 
                        moveName.includes('Stoked Sparksurfer') ||
                        moveName.includes('Pulverizing Pancake') ||
                        (fullMoveData.isZ && basePower < 100);
    if (isMaxMoveName && basePower < 100) {
        const oldPower = basePower;
        basePower = 130;
        console.warn(`[ENGINE FIX] Max/G-Max å¨åŠ›ä¿®æ­£: ${moveName} (${oldPower} -> ${basePower})`);
    }
    if (isZMoveName && basePower < 100) {
        const oldPower = basePower;
        basePower = 180;
        console.warn(`[ENGINE FIX] Z-Move å¨åŠ›ä¿®æ­£: ${moveName} (${oldPower} -> ${basePower})`);
    }
    // =====================================================
    // === ã€Tera Blast ç‰¹åˆ¤ã€‘ ===
    // =====================================================
    if (moveName === 'Tera Blast' && attacker.isTerastallized) {
        move.type = attacker.teraType;
        const atkStat = attacker.getStat ? attacker.getStat('atk') : attacker.atk;
        const spaStat = attacker.getStat ? attacker.getStat('spa') : attacker.spa;
        if (atkStat > spaStat) {
            move.cat = 'phys';
            category = 'Physical';
        } else {
            move.cat = 'spec';
            category = 'Special';
        }
        console.log(`[TERA BLAST] ${attacker.name} ä½¿ç”¨ Tera Blast: å±æ€§=${move.type}, åˆ†ç±»=${category} (Atk=${atkStat}, SpA=${spaStat})`);
    }
    // === ç­–ç•¥æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç‰¹æ®Šå¤„ç†å™¨ ===
    const handler = (typeof getMoveHandler === 'function') ? getMoveHandler(move.name) : null;
    // === ã€æ‹›å¼é’©å­ã€‘onModifyType - åŠ¨æ€ä¿®æ”¹æ‹›å¼å±æ€§ (Aura Wheel, Weather Ball ç­‰) ===
    if (handler && handler.onModifyType) {
        const newType = handler.onModifyType(move, attacker, window.battle);
        if (newType) {
            move.type = newType;
            console.log(`[MOVE TYPE] ${move.name} å±æ€§å˜ä¸º ${newType}`);
        }
    }
    // === ã€ç‰¹æ€§é’©å­ã€‘onModifyType - çš®è‚¤ç³»ç‰¹æ€§å±æ€§è½¬æ¢ (Pixilate, Aerilate ç­‰) ===
    if (typeof AbilityHandlers !== 'undefined' && attacker.ability && AbilityHandlers[attacker.ability]) {
        const ah = AbilityHandlers[attacker.ability];
        if (ah.onModifyType) {
            const typeResult = ah.onModifyType(move, attacker, window.battle);
            if (typeResult && typeResult.newType) {
                move.type = typeResult.newType;
                // çš®è‚¤ç³»ç‰¹æ€§çš„å¨åŠ›åŠ æˆæ ‡è®°
                if (typeResult.powerBoost) {
                    move._ateBoost = typeResult.powerBoost;
                }
                console.log(`[ABILITY TYPE] ${attacker.ability} å°† ${move.name} å±æ€§å˜ä¸º ${typeResult.newType}`);
            }
        }
    }
    // === å›ºå®šä¼¤å®³æŠ€èƒ½ (damageCallback) ===
    if (handler && handler.damageCallback) {
        const fixedDamage = handler.damageCallback(attacker, defender);
        return { 
            damage: fixedDamage, 
            effectiveness: 1, 
            isCrit: false, 
            miss: false, 
            hitCount: 1,
            fixedDamage: true
        };
    }
    // === åŠ¨æ€å¨åŠ›æŠ€èƒ½ (basePowerCallback) ===
    if (handler && handler.basePowerCallback) {
        basePower = handler.basePowerCallback(attacker, defender);
    }
    // === ç‰¹æ€§å¨åŠ›åŠ æˆ Hook (æŠ€å¸ˆã€çŒ›ç«ã€æ¿€æµç­‰) ===
    if (typeof AbilityHandlers !== 'undefined' && attacker.ability && AbilityHandlers[attacker.ability]) {
        const ah = AbilityHandlers[attacker.ability];
        if (ah.onBasePower) {
            basePower = ah.onBasePower(basePower, attacker, defender, move);
        }
    }
    // === ã€çš®è‚¤ç³»ç‰¹æ€§ã€‘å±æ€§è½¬æ¢åçš„å¨åŠ›åŠ æˆ (x1.2) ===
    if (move._ateBoost) {
        basePower = Math.floor(basePower * move._ateBoost);
        console.log(`[ATE BOOST] çš®è‚¤ç³»ç‰¹æ€§å¨åŠ›åŠ æˆ x${move._ateBoost}`);
    }
    // === ã€Chronal Rift æŠ€èƒ½é»‘ç®±ã€‘ç§‘æŠ€ç±»æ‹›å¼RNG ===
    let moveGlitchLog = null;
    if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.checkMoveGlitch) {
        const weather = (typeof battle !== 'undefined' && battle) ? (battle.weather || battle.environmentWeather || '') : '';
        const glitchResult = window.WeatherEffects.checkMoveGlitch(weather, move, attacker);
        if (glitchResult.triggered) {
            if (glitchResult.effect === 'fail') {
                // æ‹›å¼å¤±è´¥
                moveGlitchLog = glitchResult.message;
                return {
                    damage: 0,
                    effectiveness: 1,
                    isCrit: false,
                    miss: false,
                    hitCount: 0,
                    moveGlitchLog: moveGlitchLog
                };
            } else if (glitchResult.effect === 'critical') {
                // å¨åŠ›ç¿»å€
                basePower = Math.floor(basePower * glitchResult.powerMultiplier);
                moveGlitchLog = glitchResult.message;
                console.log(`[CHRONAL RIFT] ğŸ’¥ æŠ€èƒ½é»‘ç®±ï¼šå¨åŠ› x${glitchResult.powerMultiplier} -> ${basePower}`);
            }
        }
    }
    // === ã€å……ç”µ Chargeã€‘ç”µç³»æ‹›å¼å¨åŠ›ç¿»å€ ===
    const chargeMoveType = move.type || fullMoveData.type || 'Normal';
    if (attacker.volatile && attacker.volatile.charge && chargeMoveType === 'Electric') {
        basePower = Math.floor(basePower * 2);
        console.log(`[CHARGE] ${attacker.cnName} çš„å……ç”µä½¿ç”µç³»æ‹›å¼å¨åŠ›ç¿»å€ï¼(${basePower / 2} -> ${basePower})`);
        // ä½¿ç”¨åæ¶ˆè€—
        delete attacker.volatile.charge;
    }
    // === ã€å¤©æ°”å¨åŠ›ä¿®æ­£ã€‘ä½¿ç”¨ MoveEffects æ¨¡å— ===
    const currentWeather = (typeof window !== 'undefined' && window.battle && window.battle.weather) || '';
    const moveType = move.type || fullMoveData.type || 'Normal';
    if (currentWeather && typeof MoveEffects !== 'undefined' && MoveEffects.getWeatherModifier) {
        const weatherResult = MoveEffects.getWeatherModifier(currentWeather, moveType, move.name);
        if (weatherResult.modifier !== 1) {
            const oldPower = basePower;
            basePower = Math.floor(basePower * weatherResult.modifier);
            console.log(`[WEATHER] ${weatherResult.log} (${oldPower} -> ${basePower})`);
            if (!options.isSimulation && weatherResult.log) {
                move._weatherPowerLog = weatherResult.log;
            }
            // ã€å§‹æºå¤©æ°”ã€‘å¨åŠ›å½’é›¶ = æ‹›å¼å¤±æ•ˆï¼Œç«‹å³è¿”å›å¹¶æ˜¾ç¤ºæ—¥å¿—
            if (weatherResult.modifier === 0 && oldPower > 0) {
                const blockMsg = (currentWeather === 'harshsun') 
                    ? `<span style="color:#f59e0b">ğŸ”¥ æ°´è¢«å¼ºçƒˆçš„é˜³å…‰è’¸å‘äº†ï¼</span>`
                    : `<span style="color:#3b82f6">ğŸŒŠ ç«è¢«æš´é£é›¨æµ‡ç­äº†ï¼</span>`;
                return { 
                    damage: 0, 
                    effectiveness: 0, 
                    isCrit: false, 
                    miss: false, 
                    hitCount: 0, 
                    blocked: true,
                    weatherBlocked: true,
                    weatherBlockMessage: blockMsg
                };
            }
        }
        // å¤©æ°”çƒ (Weather Ball) å¨åŠ›å˜åŒ–
        if (move.name === 'Weather Ball' && currentWeather !== 'none') {
            const oldPower = basePower;
            basePower = 100;
            console.log(`[WEATHER BALL] å¤©æ°” ${currentWeather}ï¼Œå¨åŠ›ç¿»å€ï¼(${oldPower} -> ${basePower})`);
        }
    }
    // === ã€åŒºåŸŸå¤©æ°”å¨åŠ›ä¿®æ­£å·²è¿ç§»è‡³ Environment Overlay APIã€‘===
    // å‚è§: systems/environment-overlay.js çš„ getDamageMod()
    // === ã€ç£¨ç º Laser Focusã€‘ä¸‹å›åˆå¿…å®šæš´å‡» ===
    // åœ¨æš´å‡»åˆ¤å®šå¤„å¤„ç†ï¼Œè¿™é‡Œåªåšæ ‡è®°æ£€æŸ¥
    // === Mirror Coat / Counter ç®€åŒ–å¤„ç† ===
    if (move.name === 'Mirror Coat') {
        basePower = 100;
        move.cat = 'spec';
    } else if (move.name === 'Counter') {
        basePower = 80;
        move.cat = 'phys';
    }
    // === ã€ç¡çœ ç›¸å…³æ‹›å¼æ£€æŸ¥ã€‘ ===
    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥å®å¯æ¢¦æ˜¯å¦å¤„äºç¡çœ çŠ¶æ€ï¼ˆåŒ…æ‹¬ç»å¯¹ç¡çœ ç‰¹æ€§ï¼‰
    const isAsleep = (poke) => {
        if (poke.status === 'slp') return true;
        const ability = (poke.ability || '').toLowerCase().replace(/[^a-z]/g, '');
        return ability === 'comatose'; // ç»å¯¹ç¡çœ è§†ä¸ºæ°¸ä¹…ç¡çœ 
    };
    // ã€æ¢¦è¯/æ‰“é¼¾ (Sleep Talk/Snore)ã€‘éœ€è¦ä½¿ç”¨è€…ç¡çœ æ‰èƒ½ä½¿ç”¨
    const isSleepTalkOrSnore = moveName === 'Sleep Talk' || moveName === 'Snore';
    if (isSleepTalkOrSnore && !isAsleep(attacker)) {
        console.log(`[SLEEP CHECK] ${move.name} å¤±è´¥ï¼š${attacker.cnName} æ²¡æœ‰ç¡çœ `);
        return { 
            damage: 0, 
            effectiveness: 0, 
            isCrit: false, 
            miss: false, 
            hitCount: 0, 
            failed: true,
            failMessage: `ä½†æ˜¯æ‹›å¼å¤±è´¥äº†ï¼`
        };
    }
    // ã€é£Ÿæ¢¦ (Dream Eater)ã€‘éœ€è¦ç›®æ ‡ç¡çœ æ‰èƒ½ä½¿ç”¨
    const isDreamEater = moveName === 'Dream Eater';
    if (isDreamEater && !isAsleep(defender)) {
        console.log(`[SLEEP CHECK] ${move.name} å¤±è´¥ï¼š${defender.cnName} æ²¡æœ‰ç¡çœ `);
        return { 
            damage: 0, 
            effectiveness: 0, 
            isCrit: false, 
            miss: false, 
            hitCount: 0, 
            failed: true,
            failMessage: `ä½†æ˜¯æ‹›å¼å¤±è´¥äº†ï¼`
        };
    }
    // === åŠæ— æ•ŒçŠ¶æ€æ£€æµ‹ (Semi-Invulnerable) ===
    // æ£€æŸ¥ç›®æ ‡æ˜¯å¦å¤„äºé£ç¿”/æŒ–æ´/æ½œæ°´ç­‰åŠæ— æ•ŒçŠ¶æ€
    // ã€é‡è¦ã€‘è·³è¿‡ä¸é’ˆå¯¹ç‰¹å®šç›®æ ‡çš„æŠ€èƒ½ï¼š
    // - self: å¯¹è‡ªå·±ä½¿ç”¨ï¼ˆå¦‚ Geomancy, Swords Danceï¼‰
    // - allySide/allyTeam: å¯¹å·±æ–¹åœºåœ°ä½¿ç”¨ï¼ˆå¦‚ Light Screen, Reflectï¼‰
    // - all: åœºåœ°æŠ€èƒ½ï¼ˆå¦‚ Rain Dance, Sunny Day, Trick Roomï¼‰
    // - foeSide: å¯¹æ•Œæ–¹åœºåœ°ä½¿ç”¨ï¼ˆå¦‚ Stealth Rock, Spikesï¼‰
    // - allAdjacent/allAdjacentFoes: èŒƒå›´æ”»å‡»ï¼ˆå¦‚ Earthquake, Surfï¼‰- è¿™äº›ä»éœ€æ£€æµ‹
    const moveTarget = fullMoveData.target || move.target || 'normal';
    const nonTargetingMoves = ['self', 'allySide', 'allyTeam', 'all', 'foeSide', 'adjacentAlly', 'adjacentAllyOrSelf'];
    const isNonTargeting = nonTargetingMoves.includes(moveTarget);
    const isStatusMove = fullMoveData.category === 'Status' || move.cat === 'status';
    if (defender.volatile && typeof checkInvulnerability === 'function' && !isNonTargeting) {
        const invulnResult = checkInvulnerability(defender, move);
        if (invulnResult.invulnerable && !invulnResult.canHit) {
            console.log(`[INVULN] ${defender.cnName} å¤„äº ${invulnResult.status} çŠ¶æ€ï¼Œ${move.name} æ— æ³•å‘½ä¸­`);
            return {
                damage: 0,
                effectiveness: 1,
                isCrit: false,
                miss: true,
                hitCount: 0,
                invulnerableMiss: true,
                invulnStatus: invulnResult.status
            };
        }
        // å¦‚æœå¯ä»¥å‘½ä¸­ä¸”åŒå€ä¼¤å®³ï¼Œæ ‡è®°åœ¨ move ä¸Š
        if (invulnResult.doubleDamage) {
            move._invulnDoubleDamage = true;
            console.log(`[INVULN] ${move.name} å¯¹ ${invulnResult.status} çŠ¶æ€çš„ç›®æ ‡é€ æˆåŒå€ä¼¤å®³`);
        }
    }
    // === Protect/Detect å®ˆä½åˆ¤å®š ===
    // ã€ä¸¥é‡BUGä¿®å¤ã€‘å®ˆä½åº”è¯¥é˜»æŒ¡æ‰€æœ‰æ”»å‡»å’Œå˜åŒ–æŠ€ï¼ˆé™¤äº†ç‰¹å®šç©¿é€æŠ€èƒ½ï¼‰
    // åŸé€»è¾‘é”™è¯¯ï¼šåªæ£€æŸ¥ basePower > 0ï¼Œå¯¼è‡´å˜åŒ–æŠ€ï¼ˆå¦‚è˜‘è‡å­¢å­ï¼‰ä¸è¢«é˜»æŒ¡
    // ã€ä¿®å¤ã€‘å®ˆä½ä¸åº”è¯¥é˜»æŒ¡ target: "self" çš„æ‹›å¼ï¼ˆå¦‚ç£¨çˆªã€å‰‘èˆç­‰è‡ªæˆ‘å¼ºåŒ–æŠ€ï¼‰
    if (defender.volatile && defender.volatile.protect) {
        const isContact = fullMoveData.flags && fullMoveData.flags.contact;
        let protectEffect = null;
        // ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥æ‹›å¼ç›®æ ‡ - è‡ªæˆ‘å¼ºåŒ–æŠ€å’Œåœºåœ°æŠ€ä¸åº”è¢«å®ˆä½é˜»æŒ¡
        // target: "self" è¡¨ç¤ºæ‹›å¼ç›®æ ‡æ˜¯ä½¿ç”¨è€…è‡ªå·±ï¼Œä¸æŒ‡å‘å¯¹æ‰‹
        // target: "all" è¡¨ç¤ºå½±å“æ•´ä¸ªåœºåœ°ï¼ˆå¦‚å¤©æ°”æŠ€èƒ½ Sandstormã€Rain Dance ç­‰ï¼‰
        const moveTarget = fullMoveData.target || 'normal';
        const nonTargetingMoves = ['self', 'allySide', 'allyTeam', 'adjacentAllyOrSelf', 'all'];
        const isNonTargeting = nonTargetingMoves.includes(moveTarget);
        if (isNonTargeting) {
            // è‡ªæˆ‘å¼ºåŒ–æŠ€ï¼ˆå¦‚ç£¨çˆªã€å‰‘èˆã€é¾™èˆç­‰ï¼‰å’Œåœºåœ°æŠ€ï¼ˆå¦‚æ²™æš´ã€ç¥ˆé›¨ç­‰ï¼‰ä¸è¢«å®ˆä½é˜»æŒ¡
            // è¿™äº›æ‹›å¼ä¸æŒ‡å‘å¯¹æ‰‹ï¼Œå®ˆä½åªèƒ½é˜²å¾¡æŒ‡å‘è‡ªå·±çš„æ‹›å¼
            console.log(`[PROTECT IGNORE] ${move.name} ç›®æ ‡æ˜¯ ${moveTarget}ï¼Œä¸å—å®ˆä½å½±å“`);
            // ä¸ returnï¼Œç»§ç»­æ‰§è¡Œæ‹›å¼
        }
        // æ£€æŸ¥æ˜¯å¦ä¸ºç©¿é€å®ˆä½çš„æ‹›å¼ï¼ˆä½¯æ”» Feintã€æš—å½±è¢­å‡» Shadow Force ç­‰ï¼‰
        const bypassProtectMoves = ['feint', 'shadowforce', 'phantomforce', 'hyperspacefury', 'hyperspacehole'];
        const canBypassProtect = bypassProtectMoves.includes(moveId);
        if (isNonTargeting) {
            // å·²åœ¨ä¸Šé¢å¤„ç†ï¼Œè·³è¿‡å®ˆä½åˆ¤å®š
        } else if (canBypassProtect) {
            console.log(`[PROTECT BYPASS] ${move.name} ç©¿é€äº†å®ˆä½ï¼`);
            // ç©¿é€å®ˆä½çš„æ‹›å¼ï¼Œç»§ç»­æ‰§è¡Œ
        } else {
            // ã€æ— å½¢æ‹³ (Unseen Fist)ã€‘æ¥è§¦ç±»æ‹›å¼ç©¿é€å®ˆä½ï¼ˆä½†åªå¯¹æ”»å‡»æŠ€æœ‰æ•ˆï¼Œå˜åŒ–æŠ€ä»è¢«æŒ¡ï¼‰
            const attackerAbility = (attacker.ability || '').toLowerCase().replace(/[^a-z]/g, '');
            const isStatusMove = basePower === 0 || category === 'Status';
            if (isContact && attackerAbility === 'unseenfist' && !isStatusMove) {
                console.log(`[Unseen Fist] ${attacker.cnName} çš„æ— å½¢æ‹³ç©¿é€äº†å®ˆä½ï¼`);
                // ä¸ return blockedï¼Œç»§ç»­è®¡ç®—ä¼¤å®³
                // ä½†ä»ç„¶è§¦å‘å®ˆä½çš„æ¥è§¦å‰¯ä½œç”¨ï¼ˆå¦‚ç‹ç›¾é™æ”»ï¼‰
                if (defender.volatile.kingsShield) {
                    if (!attacker.boosts) attacker.boosts = {};
                    attacker.boosts.atk = Math.max(-6, (attacker.boosts.atk || 0) - 2);
                    protectEffect = { type: 'statDrop', msg: `${attacker.cnName} çš„æ”»å‡»å¤§å¹…ä¸‹é™ï¼` };
                }
                // æ— å½¢æ‹³ç©¿é€åç»§ç»­æ‰§è¡Œä¼¤å®³è®¡ç®—ï¼Œä¸åœ¨è¿™é‡Œ return
            } else if (isContact && !isStatusMove) {
                // ç¢‰å ¡ (Baneful Bunker): æ¥è§¦æ”»å‡»è€…ä¸­æ¯’
                if (defender.volatile.banefulBunker) {
                    const attackerTypes = attacker.types || [];
                    const canPoison = !attackerTypes.includes('Poison') && !attackerTypes.includes('Steel');
                    if (canPoison && !attacker.status) {
                        attacker.status = 'psn';
                        protectEffect = { type: 'poison', msg: `${attacker.cnName} æ¥è§¦äº†ç¢‰å ¡ï¼Œä¸­æ¯’äº†ï¼` };
                    }
                }
                // å°–åˆºé˜²å®ˆ (Spiky Shield)
                else if (defender.volatile.spikyShield) {
                    const spikeDmg = Math.floor(attacker.maxHp / 8);
                    attacker.takeDamage(spikeDmg);
                    protectEffect = { type: 'damage', msg: `${attacker.cnName} è¢«å°–åˆºåˆºä¼¤äº†ï¼(-${spikeDmg})` };
                }
                // ç‹è€…ç›¾ç‰Œ (King's Shield)
                else if (defender.volatile.kingsShield) {
                    if (!attacker.boosts) attacker.boosts = {};
                    attacker.boosts.atk = Math.max(-6, (attacker.boosts.atk || 0) - 2);
                    protectEffect = { type: 'statDrop', msg: `${attacker.cnName} çš„æ”»å‡»å¤§å¹…ä¸‹é™ï¼` };
                }
                // æ‹¦å µ (Obstruct)
                else if (defender.volatile.obstruct) {
                    if (!attacker.boosts) attacker.boosts = {};
                    attacker.boosts.def = Math.max(-6, (attacker.boosts.def || 0) - 2);
                    protectEffect = { type: 'statDrop', msg: `${attacker.cnName} çš„é˜²å¾¡å¤§å¹…ä¸‹é™ï¼` };
                }
                // ä¸ç»¸é™·é˜± (Silk Trap)
                else if (defender.volatile.silkTrap) {
                    if (!attacker.boosts) attacker.boosts = {};
                    attacker.boosts.spe = Math.max(-6, (attacker.boosts.spe || 0) - 1);
                    protectEffect = { type: 'statDrop', msg: `${attacker.cnName} çš„é€Ÿåº¦ä¸‹é™äº†ï¼` };
                }
                // ç«ç„°å®ˆæŠ¤ (Burning Bulwark)
                else if (defender.volatile.burningBulwark) {
                    const attackerTypes = attacker.types || [];
                    const canBurn = !attackerTypes.includes('Fire');
                    if (canBurn && !attacker.status) {
                        attacker.status = 'brn';
                        protectEffect = { type: 'burn', msg: `${attacker.cnName} è¢«ç¼ä¼¤äº†ï¼` };
                    }
                }
                // æ¥è§¦ç±»æ”»å‡»æŠ€è¢«å®ˆä½
                return { 
                    damage: 0, effectiveness: 0, isCrit: false, miss: false, hitCount: 0, blocked: true,
                    protectEffect 
                };
            } else {
                // ã€å…³é”®ä¿®å¤ã€‘éæ¥è§¦ç±»æ‹›å¼ï¼ˆåŒ…æ‹¬å˜åŒ–æŠ€å¦‚è˜‘è‡å­¢å­ï¼‰ä¹Ÿè¢«å®ˆä½æŒ¡ä½
                console.log(`[PROTECT] ${defender.cnName} çš„å®ˆä½é˜»æŒ¡äº† ${move.name}ï¼`);
                return { 
                    damage: 0, effectiveness: 0, isCrit: false, miss: false, hitCount: 0, blocked: true,
                    protectEffect: null,
                    protectBlocked: true // æ ‡è®°è¢«å®ˆä½é˜»æŒ¡
                };
            }
        }
    }
    // === ã€ç ´æ ¼ç³»ç‰¹æ€§ã€‘åˆ¤å®š ===
    const attackerAbilityId = (attacker.ability || '').toLowerCase().replace(/[^a-z]/g, '');
    const moldBreakerAbilities = ['moldbreaker', 'teravolt', 'turboblaze'];
    const moldBreakerMoves = ['sunsteelstrike', 'moongeistbeam', 'photongeyser', 'menacingmoonrazemaelstrom', 'searingsunrazesmash'];
    const ignoresAbilities = moldBreakerAbilities.includes(attackerAbilityId) || 
                             moldBreakerMoves.includes(moveId);
    // =========================================================
    // ã€å§‹æºå¤©æ°”ã€‘æ‹›å¼å¤±æ•ˆåˆ¤å®š
    // Desolate Land (harshsun): æ°´ç³»æ”»å‡»æ‹›å¼å¤±æ•ˆ
    // Primordial Sea (heavyrain): ç«ç³»æ”»å‡»æ‹›å¼å¤±æ•ˆ
    // =========================================================
    if (battle && basePower > 0) {
        const attackMoveType = move.type || fullMoveData.type || 'Normal';
        // ã€ç»ˆç»“ä¹‹åœ° Desolate Landã€‘æ°´ç³»æ”»å‡»æ‹›å¼å¤±æ•ˆ
        if (battle.weather === 'harshsun' && attackMoveType === 'Water') {
            console.log(`[DESOLATE LAND] ğŸ”¥ æ°´ç³»æ‹›å¼ ${move.name} è¢«å¼ºçƒˆçš„é˜³å…‰è’¸å‘äº†ï¼`);
            return { 
                damage: 0, 
                effectiveness: 0, 
                isCrit: false, 
                miss: false, 
                hitCount: 0, 
                blocked: true,
                weatherBlocked: true,
                weatherBlockMessage: `<span style="color:#f59e0b">ğŸ”¥ æ°´è¢«å¼ºçƒˆçš„é˜³å…‰è’¸å‘äº†ï¼</span>`
            };
        }
        // ã€å§‹æºä¹‹æµ· Primordial Seaã€‘ç«ç³»æ”»å‡»æ‹›å¼å¤±æ•ˆ
        if (battle.weather === 'heavyrain' && attackMoveType === 'Fire') {
            console.log(`[PRIMORDIAL SEA] ğŸŒŠ ç«ç³»æ‹›å¼ ${move.name} è¢«æš´é£é›¨æµ‡ç­äº†ï¼`);
            return { 
                damage: 0, 
                effectiveness: 0, 
                isCrit: false, 
                miss: false, 
                hitCount: 0, 
                blocked: true,
                weatherBlocked: true,
                weatherBlockMessage: `<span style="color:#3b82f6">ğŸŒŠ ç«è¢«æš´é£é›¨æµ‡ç­äº†ï¼</span>`
            };
        }
    }
    // === ç‰¹æ€§å…ç–«åˆ¤å®š Hook ===
    if (!ignoresAbilities && typeof AbilityHandlers !== 'undefined' && defender.ability && AbilityHandlers[defender.ability]) {
        const ahDef = AbilityHandlers[defender.ability];
        if (ahDef.onImmunity && ahDef.onImmunity(move.type, move)) {
            console.log(`[ABILITY IMMUNE] ${defender.cnName} çš„ ${defender.ability} å…ç–«äº† ${move.name}ï¼`);
            return { damage: 0, effectiveness: 0, isCrit: false, miss: false, hitCount: 0, blocked: true, abilityImmune: defender.ability };
        }
        // ã€ä¿®å¤ã€‘onTryHit éœ€è¦é¢„è®¡ç®— effectiveness ç”¨äº Wonder Guard ç­‰ç‰¹æ€§
        if (ahDef.onTryHit) {
            // é¢„è®¡ç®—å±æ€§å…‹åˆ¶å€ç‡
            const defensiveTypes = defender.types || ['Normal'];
            const preEffectiveness = getTypeEffectiveness(move.type || 'Normal', defensiveTypes, move.name);
            const tryHitResult = ahDef.onTryHit(attacker, defender, move, preEffectiveness);
            if (tryHitResult && tryHitResult.blocked) {
                console.log(`[ABILITY BLOCK] ${tryHitResult.message || defender.ability + ' é˜»æ­¢äº†æ”»å‡»'}`);
                return { damage: 0, effectiveness: 0, isCrit: false, miss: false, hitCount: 0, blocked: true, abilityImmune: defender.ability };
            }
        }
    }
    if (ignoresAbilities && defender.ability) {
        console.log(`[MOLD BREAKER] ${attacker.cnName} çš„ç‰¹æ€§/æ‹›å¼æ— è§†äº† ${defender.cnName} çš„ ${defender.ability}ï¼`);
    }
    // å˜åŒ–æŠ€ä¸é€ æˆä¼¤å®³
    if (basePower === 0 || category === 'Status') {
        // === ã€æ¶ä½œå‰§ä¹‹å¿ƒã€‘æ¶ç³»å…ç–«æ£€æŸ¥ ===
        const isPrankster = attackerAbilityId === 'prankster';
        const defenderTypes = defender.types || [];
        const defenderIsDark = defenderTypes.includes('Dark');
        const moveTarget = fullMoveData.target || 'normal';
        const targetsOpponent = ['normal', 'randomNormal', 'allAdjacentFoes', 'foeSide', 'any', 'adjacentFoe'].includes(moveTarget);
        if (isPrankster && defenderIsDark && targetsOpponent) {
            console.log(`[PRANKSTER IMMUNITY] ${defender.cnName} æ˜¯æ¶ç³»ï¼Œå…ç–«äº† ${attacker.cnName} çš„æ¶ä½œå‰§ä¹‹å¿ƒå˜åŒ–æŠ€ï¼`);
            return { 
                damage: 0, effectiveness: 0, isCrit: false, miss: false, hitCount: 0, blocked: true, 
                pranksterImmune: true,
                message: `${defender.cnName} æ˜¯æ¶å±æ€§ï¼Œå…ç–«äº†æ¶ä½œå‰§ä¹‹å¿ƒçš„æ•ˆæœï¼`
            };
        }
        // å˜åŒ–æŠ€å‘½ä¸­åˆ¤å®š
        let statusAcc = (accuracy === true || accuracy === undefined) ? 100 : accuracy;
        const accStage = attacker.boosts.accuracy;
        const evaStage = defender.boosts.evasion;
        const finalStage = Math.min(6, Math.max(-6, accStage - evaStage));
        let accMult = 1.0;
        if (finalStage >= 0) accMult = (3 + finalStage) / 3;
        else accMult = 3 / (3 + Math.abs(finalStage));
        const finalAcc = statusAcc * accMult;
        if (statusAcc < 100 && Math.random() * 100 >= finalAcc) {
            return { damage: 0, effectiveness: 1, isCrit: false, miss: true, hitCount: 0 };
        }
        return { damage: 0, effectiveness: 1, isCrit: false, miss: false, hitCount: 0 };
    }
    // === å‘½ä¸­åˆ¤å®š ===
    let moveAcc = (accuracy === true || accuracy === undefined) ? 100 : accuracy;
    // === ã€å¤©æ°”å‘½ä¸­ç‡ä¿®æ­£ã€‘ä½¿ç”¨ MoveEffects æ¨¡å— ===
    // ã€å…³é”®ã€‘weatherGuaranteedHit æ ‡è®°å¤©æ°”å¯¼è‡´çš„å¿…ä¸­ï¼ˆå¦‚é›ªå¤©æš´é£é›ªï¼‰
    let weatherGuaranteedHit = false;
    const weatherForAcc = (typeof window !== 'undefined' && window.battle && window.battle.weather) || '';
    if (weatherForAcc && typeof MoveEffects !== 'undefined' && MoveEffects.getWeatherAccuracyModifier) {
        const accResult = MoveEffects.getWeatherAccuracyModifier(weatherForAcc, move.name);
        if (accResult.accuracy !== null) {
            moveAcc = accResult.accuracy;
            // å¦‚æœå¤©æ°”è¿”å› 100 å‘½ä¸­ç‡ï¼Œæ ‡è®°ä¸ºå¿…ä¸­
            if (accResult.accuracy === 100 || accResult.accuracy === true) {
                weatherGuaranteedHit = true;
            }
            console.log(`[WEATHER ACC] ${accResult.log}`);
        }
    }
    // æ— é˜²å®ˆ (No Guard)
    const attackerHasNoGuard = attackerAbilityId === 'noguard';
    const defenderHasNoGuard = (defender.ability || '').toLowerCase().replace(/[^a-z]/g, '') === 'noguard';
    const alwaysHit = accuracy === true || attackerHasNoGuard || defenderHasNoGuard;
    // å¿…ä¸­æ‹›å¼åˆ—è¡¨
    const neverMissMoves = ['aerialace', 'aurasphere', 'clearsmog', 'disarmingvoice', 'feintattack', 
        'magicalleaf', 'magnetbomb', 'shadowpunch', 'shockwave', 'smartstrike', 'swift', 'vitalthrow'];
    const isNeverMiss = neverMissMoves.includes(moveId);
    // å‘½ä¸­/é—ªé¿ä¿®æ­£
    const accStage = attacker.boosts.accuracy || 0;
    let evaStage = defender.boosts.evasion || 0;
    // === ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘é—ªé¿ç­‰çº§ä¿®æ­£ ===
    if (typeof window !== 'undefined' && window.envOverlay) {
        const envEvasionBoost = window.envOverlay.getEvasionStage(defender);
        if (envEvasionBoost !== 0) {
            evaStage += envEvasionBoost;
            console.log(`[ENV OVERLAY] é—ªé¿ç­‰çº§ä¿®æ­£: ${defender.cnName || defender.name} +${envEvasionBoost}`);
        }
    }
    const getAccuracyMultiplier = (stage) => {
        const clampedStage = Math.min(6, Math.max(-6, stage));
        if (clampedStage >= 0) return (3 + clampedStage) / 3;
        return 3 / (3 - clampedStage);
    };
    const accMult = getAccuracyMultiplier(accStage);
    const evaMult = getAccuracyMultiplier(-evaStage);
    // ã€å¹¿è§’é•œ Wide Lensã€‘å‘½ä¸­ç‡x1.1
    let itemAccMod = 1;
    if (typeof ItemEffects !== 'undefined' && ItemEffects.getAccuracyMod) {
        itemAccMod = ItemEffects.getAccuracyMod(attacker);
    }
    // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘å‘½ä¸­ç‡ä¿®æ­£
    let envAccMod = 1;
    if (typeof window !== 'undefined' && window.envOverlay) {
        envAccMod = window.envOverlay.getAccuracyMod(attacker, move);
        if (envAccMod !== 1) {
            console.log(`[ENV OVERLAY] å‘½ä¸­ç‡ä¿®æ­£: x${envAccMod}`);
        }
    }
    // è®¡ç®—å‘½ä¸­ç‡
    let hitRate = moveAcc * accMult / evaMult * itemAccMod * envAccMod;
    if (alwaysHit || isNeverMiss) {
        hitRate = 100;
    }
    // Z æ‹›å¼å’Œæå·¨æ‹›å¼å¿…ä¸­
    const isZMove = move.isZ || (move.name && (
        move.name.includes('10,000,000') ||
        move.name.includes('Catastropika') ||
        move.name.includes('Breakneck Blitz') ||
        move.name.includes('Inferno Overdrive') ||
        move.name.includes('Hydro Vortex') ||
        move.name.includes('Gigavolt Havoc')
    ));
    const isMaxMove = move.isMax || (move.name && (
        move.name.startsWith('Max ') ||
        move.name.startsWith('G-Max ')
    ));
    // ã€å…³é”®ä¿®å¤ã€‘åŠ å…¥ weatherGuaranteedHit åˆ¤æ–­å¤©æ°”å¿…ä¸­
    const isSureHit = isZMove || isMaxMove || accuracy === true || weatherGuaranteedHit;
    // === Insight å¥‡è¿¹é—ªé¿ ===
    if (isSureHit && defender.isAce && defender.avs && defender.avs.insight >= 250) {
        const baseInsight = defender.getEffectiveAVs('insight');
        const effectiveInsight = defender.avsEvolutionBoost ? baseInsight * 2 : baseInsight;
        const miracleChance = effectiveInsight >= 255 ? 10 : 5;
        if (Math.random() * 100 < miracleChance) {
            console.log(`[Insight] MIRACLE DODGE TRIGGERED! Bypassed Sure-Hit.`);
            return {
                damage: 0, effectiveness: 0, isCrit: false, miss: true, hitCount: 0,
                insightMiracle: true
            };
        }
    }
    // === AVs: Insight é—ªé¿åŠ æˆ ===
    // ã€çº¿æ€§æœºåˆ¶ã€‘é—ªé¿åŠ æˆ = (effectiveInsight / 255) * 20
    // æ»¡å€¼ 255 æ—¶ 20% é—ªé¿åŠ æˆï¼Œ100 æ—¶çº¦ 8% é—ªé¿åŠ æˆ
    // ã€Ambrosiaã€‘ç¥ä¹‹ç¼æµ†å¤©æ°”ä¸‹ AVS æ•ˆæœ x2
    if (defender.isAce && defender.avs && !isSureHit) {
        const baseInsight = defender.getEffectiveAVs('insight');
        // ã€å…¨å±€å¼€å…³ã€‘AVS å…³é—­æ—¶ getEffectiveAVs è¿”å› 0ï¼Œè·³è¿‡è®¡ç®—
        if (baseInsight > 0) {
            const effectiveInsight = defender.avsEvolutionBoost ? baseInsight * 2 : baseInsight;
            // çº¿æ€§é—ªé¿åŠ æˆï¼šæ»¡å€¼ 10%ï¼ˆä» 20% ä¸‹è°ƒï¼‰ï¼Œæœ€ä½ 1%
            let evasionBonus = Math.max(1, Math.floor((Math.min(effectiveInsight, 255) / 255) * 10));
            // ã€Ambrosia ç¥ä¹‹ç¼æµ†ã€‘AVS æ•ˆæœ x2
            if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.getAVSMultiplier) {
                const avsMultiplier = window.WeatherEffects.getAVSMultiplier(weatherForAcc);
                if (avsMultiplier > 1) {
                    evasionBonus = Math.floor(evasionBonus * avsMultiplier);
                    console.log(`[AMBROSIA] ğŸ’« ç¥ä¹‹ç¼æµ†ï¼šInsight é—ªé¿åŠ æˆ x${avsMultiplier}`);
                }
            }
            hitRate = Math.max(50, hitRate - evasionBonus); // æœ€ä½å‘½ä¸­ç‡æé«˜è‡³ 50%
            console.log(`[AVs] Insight é—ªé¿åŠ æˆ: -${evasionBonus}% (Insight: ${baseInsight}${defender.avsEvolutionBoost ? ' x2' : ''})`);
        }
    }
    // ã€æˆ˜æœ¯æŒ‡æŒ¥ã€‘DODGE! æŒ‡ä»¤ï¼šåŸºç¡€ 30% é—ªé¿ + Insight AVS åŠ æˆ
    // ç‚¹å‡»åä»…å½“å›åˆç”Ÿæ•ˆ
    // ã€å¹³è¡¡è°ƒæ•´ã€‘DODGE æŒ‡ä»¤ä¸è¢«åŠ¨ Insight é—ªé¿ä¸å åŠ ï¼Œå–è¾ƒé«˜å€¼
    if (defender.commandDodgeActive && !isSureHit) {
        let dodgeBonus = 30; // åŸºç¡€ 30% é—ªé¿ï¼ˆä» 40% ä¸‹è°ƒï¼‰
        // Insight AVS åŠ æˆï¼šæ»¡å€¼ 255 æ—¶ +30%ï¼ˆæ€»è®¡ 60%ï¼‰
        // ã€å…¨å±€å¼€å…³ã€‘ä½¿ç”¨ getEffectiveAVs æ£€æŸ¥æœ‰æ•ˆå€¼
        if (defender.isAce && defender.avs && defender.getEffectiveAVs) {
            const baseInsight = defender.getEffectiveAVs('insight');
            if (baseInsight > 0) {
                const effectiveInsight = defender.avsEvolutionBoost ? baseInsight * 2 : baseInsight;
                const insightBonus = (Math.min(effectiveInsight, 255) / 255) * 30;
                dodgeBonus += insightBonus;
                console.log(`[COMMANDER] DODGE! Insight åŠ æˆ: +${insightBonus.toFixed(1)}% (Insight: ${baseInsight})`);
            }
        }
        dodgeBonus = Math.min(dodgeBonus, 60); // ä¸Šé™ 60%ï¼ˆä¿è¯è‡³å°‘ 40% å‘½ä¸­ç‡ï¼‰
        // DODGE æŒ‡ä»¤è¦†ç›–è¢«åŠ¨é—ªé¿ï¼Œä¸å åŠ ï¼ˆé‡ç½® hitRate åå†å‡ï¼‰
        hitRate = Math.max(40, 100 - dodgeBonus);
        console.log(`[COMMANDER] DODGE! æŒ‡ä»¤æ¿€æ´»ï¼é—ªé¿ -${dodgeBonus.toFixed(1)}% (å‘½ä¸­ç‡: ${hitRate}%)`);
    }
    // Miss æ£€æµ‹
    // ã€å…³é”®ã€‘isSureHit åŒ…å« weatherGuaranteedHitï¼Œå¤©æ°”å¿…ä¸­æ‹›å¼è·³è¿‡ miss æ£€æµ‹
    if (!isSureHit && !alwaysHit && !isNeverMiss) {
        if (Math.random() * 100 > hitRate) {
            // ã€è·¯ç—´ä¿é™© Blunder Policyã€‘Missåé€Ÿåº¦+2
            // æ³¨æ„ï¼šè¿™é‡Œåªè¿”å› miss æ ‡è®°ï¼Œå®é™…è§¦å‘åœ¨ battle-damage.js ä¸­å¤„ç†
            console.log(`[MISS] å‘½ä¸­ç‡=${hitRate.toFixed(1)}%, æ‹›å¼MISS`);
            return { damage: 0, effectiveness: 0, isCrit: false, miss: true, hitCount: 0, insightDodge: defender.avs?.insight >= 100, triggerBlunderPolicy: true };
        }
    }
    // === å¤šæ®µæ”»å‡» (Multi-Hit) ===
    let hitCount = 1;
    const multihit = fullMoveData.multihit;
    if (multihit) {
        if (Array.isArray(multihit)) {
            const [min, max] = multihit;
            if (attackerAbilityId === 'skilllink') {
                hitCount = max;
                console.log(`[SKILL LINK] ${attacker.cnName} çš„è¿ç»­æ”»å‡»ç‰¹æ€§å‘åŠ¨ï¼å¼ºåˆ¶å‘½ä¸­ ${max} æ¬¡ï¼`);
            } else {
                // ã€å‡ç­‰ä¹‹éª° Loaded Diceã€‘ä¿åº•4-5æ¬¡
                if (typeof ItemEffects !== 'undefined' && ItemEffects.getMultiHitCount) {
                    hitCount = ItemEffects.getMultiHitCount(attacker, min, max);
                } else {
                    hitCount = Math.floor(Math.random() * (max - min + 1)) + min;
                }
            }
        } else {
            hitCount = multihit;
        }
    }
    // === é€‰æ‹©æ”»å‡»/é˜²å¾¡èƒ½åŠ› ===
    const isSpecial = (move.cat === 'spec' || category === 'Special');
    let atkStat = isSpecial ? attacker.getStat('spa') : attacker.getStat('atk');
    let defStat = isSpecial ? defender.getStat('spd') : defender.getStat('def');
    // === ã€å¤©æ°”é˜²å¾¡åŠ æˆã€‘ä½¿ç”¨ MoveEffects æ¨¡å— ===
    const weatherForDef = (typeof window !== 'undefined' && window.battle && window.battle.weather) || '';
    const defenderTypesForWeather = defender.types || [];
    if (weatherForDef && typeof MoveEffects !== 'undefined' && MoveEffects.getWeatherDefenseBoost) {
        const defResult = MoveEffects.getWeatherDefenseBoost(weatherForDef, defenderTypesForWeather, isSpecial);
        if (defResult.multiplier !== 1) {
            const oldDef = defStat;
            defStat = Math.floor(defStat * defResult.multiplier);
            console.log(`[WEATHER DEF] ${defResult.log} (${oldDef} -> ${defStat})`);
        }
    }
    // === ã€çº¯æœ´ Unawareã€‘ç‰¹æ€§å¤„ç† ===
    if (typeof AbilityHandlers !== 'undefined') {
        const attackerHandler = attacker.ability ? AbilityHandlers[attacker.ability] : null;
        const defenderHandler = defender.ability ? AbilityHandlers[defender.ability] : null;
        if (attackerHandler && attackerHandler.ignoreDefenderBoosts) {
            const baseDefStat = isSpecial ? defender.spd : defender.def;
            if (defStat > baseDefStat) {
                console.log(`[UNAWARE] ${attacker.cnName} çš„çº¯æœ´æ— è§†äº† ${defender.cnName} çš„é˜²å¾¡æå‡`);
                defStat = baseDefStat;
            }
        }
        if (defenderHandler && defenderHandler.ignoreAttackerBoosts) {
            const baseAtkStat = isSpecial ? attacker.spa : attacker.atk;
            if (atkStat > baseAtkStat) {
                console.log(`[UNAWARE] ${defender.cnName} çš„çº¯æœ´æ— è§†äº† ${attacker.cnName} çš„æ”»å‡»æå‡`);
                atkStat = baseAtkStat;
            }
        }
    }
    // === ç­–ç•¥æ¨¡å¼ï¼šç‰¹æ®Šæ”»é˜²è®¡ç®— ===
    if (handler && handler.modifyAtk) {
        atkStat = handler.modifyAtk(attacker, defender, isSpecial);
    }
    if (handler && handler.modifyDef) {
        defStat = handler.modifyDef(attacker, defender, isSpecial);
    }
    // === ç¼ä¼¤å‡åŠç‰©æ”» ===
    const ignoresBurnDrop = attacker.ability === 'Guts';
    if (!isSpecial && attacker.status === 'brn' && !ignoresBurnDrop) {
        atkStat = Math.floor(atkStat * 0.5);
    }
    // === ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘é˜²å¾¡ä¿®æ­£ ===
    if (typeof window !== 'undefined' && window.envOverlay) {
        const statKey = isSpecial ? 'spd' : 'def';
        const envDefMod = window.envOverlay.getStatMod(defender, statKey);
        if (envDefMod !== 1) {
            const oldDef = defStat;
            defStat = Math.floor(defStat * envDefMod);
            console.log(`[ENV OVERLAY] é˜²å¾¡ä¿®æ­£: ${defender.cnName || defender.name} ${statKey} x${envDefMod} (${oldDef} -> ${defStat})`);
        }
    }
    // === é˜²å¾¡æ–¹å±æ€§åˆ¤å®š ===
    let defensiveTypes = defender.types || ['Normal'];
    if (defender.isTerastallized) {
        if (defender.teraType === 'Stellar') {
            defensiveTypes = defender.originalTypes || defender.types;
            console.log(`[STELLAR] ${defender.name} æ˜¯æ˜Ÿæ™¶çŠ¶æ€ï¼Œé˜²å¾¡å±æ€§å›å½’ä¸º: ${defensiveTypes.join('/')}`);
        } else {
            defensiveTypes = [defender.teraType];
        }
    }
    // å±æ€§å…‹åˆ¶
    // ã€ä¿®å¤ã€‘ç¡®ä¿ moveType æœ‰æ•ˆï¼Œä¼˜å…ˆä½¿ç”¨ move.typeï¼Œå›é€€åˆ° fullMoveData.type
    // æ³¨æ„ï¼šmoveType å·²åœ¨å¤©æ°”å¨åŠ›ä¿®æ­£å¤„å£°æ˜ï¼Œæ­¤å¤„ç›´æ¥ä½¿ç”¨
    let effectiveMoveType = move.type || fullMoveData.type || 'Normal';
    // === ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘ç±»å‹è½¬æ¢ (ToType:Src>Dest) ===
    if (typeof window !== 'undefined' && window.envOverlay && window.envOverlay.getMoveTypeConversion) {
        const convertedType = window.envOverlay.getMoveTypeConversion(move);
        if (convertedType !== effectiveMoveType) {
            console.log(`[ENV OVERLAY] ğŸ”„ æŠ€èƒ½ç±»å‹è½¬æ¢: ${move.cn || move.name} ${effectiveMoveType} â†’ ${convertedType}`);
            effectiveMoveType = convertedType;
        }
    }
    let effectiveness = getTypeEffectiveness(effectiveMoveType, defensiveTypes, move.name);
    // === ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘ç±»å‹è¦†ç›– (å…ç–«/å¼±ç‚¹) ===
    if (typeof window !== 'undefined' && window.envOverlay) {
        const typeOverrides = window.envOverlay.getTypeOverrides(defender);
        // å…ç–«è¦†ç›–ï¼šå¦‚æœç¯å¢ƒèµ‹äºˆå…ç–«ï¼Œeffectiveness = 0
        if (typeOverrides.immuneTypes.includes(effectiveMoveType)) {
            console.log(`[ENV OVERLAY] ğŸ›¡ï¸ ç¯å¢ƒå…ç–«: ${defender.cnName || defender.name} å…ç–« ${effectiveMoveType}`);
            effectiveness = 0;
        }
        // å¼±ç‚¹è¿½åŠ ï¼šå¦‚æœç¯å¢ƒè¿½åŠ å¼±ç‚¹ï¼Œeffectiveness x2
        else if (typeOverrides.weakTypes.includes(effectiveMoveType)) {
            const oldEff = effectiveness;
            effectiveness *= 2;
            console.log(`[ENV OVERLAY] âš¡ ç¯å¢ƒå¼±ç‚¹: ${defender.cnName || defender.name} å¯¹ ${effectiveMoveType} å¼±ç‚¹ (${oldEff} -> ${effectiveness})`);
        }
    }
    // =========================================================
    // ã€Delta Stream å¾·å°”å¡”æ°”æµã€‘é£è¡Œç³»å…‹åˆ¶ä¼¤å®³å˜ä¸º 1 å€
    // ç”µ/å†°/å²© å¯¹é£è¡Œç³»çš„æ•ˆæœç»ä½³ -> å¼ºåˆ¶å˜ä¸º 1 å€
    // =========================================================
    if (battle && battle.weather === 'deltastream') {
        const defenderTypes = defender.types || [];
        const isFlying = defenderTypes.includes('Flying');
        const isSuperEffectiveAgainstFlying = ['Electric', 'Ice', 'Rock'].includes(effectiveMoveType);
        if (isFlying && isSuperEffectiveAgainstFlying && effectiveness > 1) {
            // è®¡ç®—é£è¡Œç³»è¢«å…‹åˆ¶çš„å€ç‡è´¡çŒ®
            // ä¾‹å¦‚ï¼šå†°æ‰“é¾™é£ = 2(é¾™) * 2(é£) = 4ï¼Œéœ€è¦é™¤ä»¥ 2 å˜æˆ 2
            // ä¾‹å¦‚ï¼šå²©æ‰“é£ = 2(é£) = 2ï¼Œéœ€è¦é™¤ä»¥ 2 å˜æˆ 1
            const flyingWeakness = ['Electric', 'Ice', 'Rock'].includes(effectiveMoveType) ? 2 : 1;
            const originalEffectiveness = effectiveness;
            effectiveness = effectiveness / flyingWeakness;
            console.log(`[DELTA STREAM] ğŸŒªï¸ å¾·å°”å¡”æ°”æµä¿æŠ¤äº†é£è¡Œç³»ï¼${effectiveMoveType} å…‹åˆ¶å€ç‡: ${originalEffectiveness} -> ${effectiveness}`);
        }
    }
    // === æœ¬ç³»åŠ æˆ (STAB) ===
    let stab = 1;
    if (attacker.isTerastallized) {
        const teraType = attacker.teraType;
        const originalTypes = attacker.originalTypes || [];
        const stabMoveType = moveType; // ä½¿ç”¨ä¸Šé¢å·²ä¿®å¤çš„ moveType
        if (teraType === 'Stellar') {
            if (originalTypes.includes(moveType)) {
                stab = 2.0; 
                console.log(`[STELLAR STAB] ${attacker.name} åŸç”Ÿæœ¬ç³»å¼ºåŒ– (${moveType}) -> 2.0x`);
            } else {
                stab = 1.2;
                console.log(`[STELLAR STAB] ${attacker.name} æ˜Ÿæ™¶å…¨èƒ½å¼ºåŒ– (${moveType}) -> 1.2x`);
            }
            if (move.name === 'Tera Blast') {
                stab = 2.0; 
            }
        } else {
            let teraTrackBonus = 0;
            if (moveType === teraType) {
                teraTrackBonus = 1.5;
                if (originalTypes.includes(teraType)) {
                    teraTrackBonus = 2.0;
                }
            }
            let recallTrackBonus = 0;
            if (originalTypes.includes(moveType)) {
                recallTrackBonus = 1.5;
            }
            stab = Math.max(teraTrackBonus, recallTrackBonus, 1);
            if (stab > 1) {
                console.log(`[TERA STAB] ${attacker.name} (Tera: ${teraType}, Original: ${originalTypes.join('/')}) ä½¿ç”¨ ${moveType} æ‹›å¼, STAB: ${stab}x`);
            }
        }
    } else {
        // é˜²æŠ¤ï¼šç¡®ä¿ attacker.types æ˜¯æœ‰æ•ˆæ•°ç»„ï¼Œä½¿ç”¨ä¿®å¤åçš„ moveType
        stab = (Array.isArray(attacker.types) && attacker.types.includes(moveType)) ? 1.5 : 1;
    }
    // === é€‚åº”åŠ›ç‰¹æ€§ ===
    if (!attacker.isTerastallized && stab > 1 && attacker.ability === 'Adaptability') {
        stab = 2;
    }
    // === ç”Ÿå‘½å®ç  ===
    let lifeOrbBoost = 1;
    const attackerItem = (attacker.item || '').toLowerCase().replace(/[^a-z]/g, '');
    if (attackerItem === 'lifeorb') {
        lifeOrbBoost = 1.3;
    }
    // === æ˜Ÿæ™¶å¤ªæ™¶çˆ†å‘ç‰¹åˆ¤ ===
    if (attacker.isTerastallized && attacker.teraType === 'Stellar' && move.name === 'Tera Blast') {
        if (defender.isTerastallized) {
            console.log(`[STELLAR KILLER] æ˜Ÿæ™¶çˆ†å‘å‡»ä¸­äº†å¤ªæ™¶åŒ–çš„å¯¹æ‰‹ï¼å¼ºåˆ¶æ•ˆæœæ‹”ç¾¤ã€‚`);
            effectiveness = 2.0; 
        } else {
            if (effectiveness < 1 && effectiveness > 0) {
                effectiveness = 1;
            }
        }
    }
    // === ä¼šå¿ƒä¸€å‡»åˆ¤å®š ===
    let isCrit = false;
    let commandCritTriggered = false;
    // =====================================================
    // ã€é˜²æš´å‡»åˆ¤å®šã€‘ä¼˜å…ˆçº§æœ€é«˜
    // =====================================================
    const defenderAbility = defender.ability || '';
    const defenderAh = (typeof AbilityHandlers !== 'undefined' && AbilityHandlers[defenderAbility]) || {};
    const preventCrit = defenderAh.preventCrit === true; // Battle Armor / Shell Armor
    if (preventCrit) {
        isCrit = false;
        console.log(`[CRIT BLOCKED] ${defender.cnName} çš„ ${defenderAbility} é˜»æ­¢äº†æš´å‡»ï¼`);
    }
    // =====================================================
    // ã€å¼ºåˆ¶æš´å‡»åˆ¤å®šã€‘
    // =====================================================
    else if (attacker.volatile && attacker.volatile.laserfocus) {
        // ã€ç£¨ç º Laser Focusã€‘å¿…å®šæš´å‡»
        isCrit = true;
        console.log(`[LASER FOCUS] ${attacker.cnName} çš„ç£¨ç ºä½¿æ”»å‡»å¿…å®šæš´å‡»ï¼`);
        delete attacker.volatile.laserfocus;
    } else if (fullMoveData.willCrit) {
        // ã€å¿…æš´æ‹›å¼ã€‘å†°æ¯ã€å±±å²šæ‘”ã€æš—å†¥å¼ºå‡»ã€æ°´æµè¿æ‰“ã€åƒå˜ä¸‡èŠ±
        isCrit = true;
        console.log(`[WILL CRIT] ${fullMoveData.name} å¿…å®šæš´å‡»ï¼`);
    } else {
        // ã€ä¸ä»ä¸ä¹‰ Mercilessã€‘æ”»å‡»ä¸­æ¯’ç›®æ ‡å¿…æš´
        const attackerAbility = attacker.ability || '';
        const attackerAh = (typeof AbilityHandlers !== 'undefined' && AbilityHandlers[attackerAbility]) || {};
        if (attackerAh.onCheckCrit) {
            const forceCrit = attackerAh.onCheckCrit(attacker, defender);
            if (forceCrit === true) {
                isCrit = true;
            }
        }
        if (!isCrit) {
            // =====================================================
            // === æš´å‡»ç­‰çº§è®¡ç®—ï¼ˆæ­£ç‰ˆæœºåˆ¶ï¼‰ ===
            // Stage 0: 1/24 (~4.17%), 1: 1/8 (12.5%), 2: 1/2 (50%), 3+: 100%
            // =====================================================
            let critStage = 0;
            // 1. æ‹›å¼è‡ªå¸¦æš´å‡»ç­‰çº§ (critRatio - 1)
            const moveCritRatio = fullMoveData.critRatio || 1;
            critStage += (moveCritRatio - 1);
            // 2. èšæ°”çŠ¶æ€ (+2)
            if (attacker.volatile && attacker.volatile.focusenergy) {
                critStage += 2;
                console.log(`[Focus Energy] ${attacker.cnName} å¤„äºèšæ°”çŠ¶æ€ï¼Œæš´å‡»ç­‰çº§ +2`);
            }
            // 3. ç‰¹æ€§åŠ æˆ (Super Luck +1)
            if (attackerAh.critStageBoost) {
                critStage += attackerAh.critStageBoost;
                console.log(`[${attackerAbility}] æš´å‡»ç­‰çº§ +${attackerAh.critStageBoost}`);
            }
            // 4. é“å…·åŠ æˆ (Scope Lens/Razor Claw +1, Leek/Lucky Punch +2)
            const itemId = (attacker.item || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const itemData = (typeof ITEMS !== 'undefined' && ITEMS[itemId]) || {};
            if (itemData.critBoost) {
                // æ£€æŸ¥ä¸“å±é“å…·é™åˆ¶
                let canUseCritBoost = true;
                if (itemData.itemUser && itemData.itemUser.length > 0) {
                    const pokemonName = (attacker.name || '').replace(/-/g, '');
                    canUseCritBoost = itemData.itemUser.some(user => 
                        pokemonName.toLowerCase().includes(user.toLowerCase().replace(/-/g, ''))
                    );
                }
                if (canUseCritBoost) {
                    critStage += itemData.critBoost;
                    console.log(`[${itemData.name}] æš´å‡»ç­‰çº§ +${itemData.critBoost}`);
                }
            }
            // 5. ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘æš´å‡»ç­‰çº§ä¿®æ­£
            if (typeof window !== 'undefined' && window.envOverlay) {
                // ç¡®ä¿ move å¯¹è±¡åŒ…å«å®Œæ•´çš„ flags æ•°æ®
                const moveWithFlags = { ...move, flags: move.flags || fullMoveData.flags || {} };
                const envCritBoost = window.envOverlay.getCritStage(attacker, moveWithFlags);
                if (envCritBoost !== 0) {
                    critStage += envCritBoost;
                    console.log(`[ENV OVERLAY] æš´å‡»ç­‰çº§ä¿®æ­£: +${envCritBoost}`);
                }
            }
            // 5.6 ã€Ambrosia å”¯å¿ƒå®ä½“åŒ–ã€‘å…¨å‘˜æš´å‡»ç‡ +1
            if (currentWeather && typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.getPsychicMindCritBoost) {
                const psychicMindBoost = window.WeatherEffects.getPsychicMindCritBoost(currentWeather);
                if (psychicMindBoost > 0) {
                    critStage += psychicMindBoost;
                    console.log(`[AMBROSIA] ğŸŒ¸ å”¯å¿ƒå®ä½“åŒ–ï¼šå…¨å‘˜æš´å‡»ç­‰çº§ +${psychicMindBoost}`);
                }
            }
            // 6. æš´å‡»ç­‰çº§ä¸Šé™ä¸º 3
            critStage = Math.min(3, critStage);
            // 7. æ ¹æ®æš´å‡»ç­‰çº§è®¡ç®—æ¦‚ç‡
            // Stage 0: 1/24, 1: 1/8, 2: 1/2, 3+: 1/1
            const critRates = [1/24, 1/8, 1/2, 1];
            let critChance = critRates[critStage] || critRates[0];
            // 8. AVs: Passion æš´å‡»åŠ æˆï¼ˆä»…é™ isAce å®å¯æ¢¦ï¼Œé¢å¤–å åŠ ï¼‰
            // ã€Ambrosiaã€‘ç¥ä¹‹ç¼æµ†å¤©æ°”ä¸‹ AVS æ•ˆæœ x2
            if (attacker.isAce && attacker.avs) {
                const basePassion = attacker.getEffectiveAVs('passion');
                if (basePassion > 0) {
                    const effectivePassion = attacker.avsEvolutionBoost ? basePassion * 2 : basePassion;
                    let passionBonus = (Math.min(effectivePassion, 255) / 255) * 0.20;
                    // ã€Ambrosia ç¥ä¹‹ç¼æµ†ã€‘AVS æ•ˆæœ x2
                    if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.getAVSMultiplier) {
                        const avsMultiplier = window.WeatherEffects.getAVSMultiplier(currentWeather);
                        if (avsMultiplier > 1) {
                            passionBonus *= avsMultiplier;
                            console.log(`[AMBROSIA] ğŸ’« ç¥ä¹‹ç¼æµ†ï¼šPassion æš´å‡»åŠ æˆ x${avsMultiplier}`);
                        }
                    }
                    critChance += passionBonus;
                    console.log(`[AVs] Passion æš´å‡»åŠ æˆ: +${(passionBonus * 100).toFixed(1)}% (Passion: ${basePassion}${attacker.avsEvolutionBoost ? ' x2' : ''})`);
                }
            }
            // 8. ã€æˆ˜æœ¯æŒ‡æŒ¥ã€‘FOCUS! æŒ‡ä»¤ï¼šå½“å›åˆ +40% æš´å‡»ç‡
            if (attacker.commandCritActive) {
                critChance += 0.40;
                commandCritTriggered = true;
                console.log(`[COMMANDER] FOCUS! æŒ‡ä»¤æ¿€æ´»ï¼+40% æš´å‡»ç‡ï¼`);
                if (!options.isSimulation) {
                    attacker.commandCritActive = false;
                }
            }
            critChance = Math.min(critChance, 1.0);
            console.log(`[CRIT CHECK] æš´å‡»ç­‰çº§=${critStage}, æœ€ç»ˆæ¦‚ç‡=${(critChance * 100).toFixed(1)}%`);
            if (Math.random() < critChance) isCrit = true;
        }
    }
    // === æš´å‡»ä¼¤å®³å€ç‡ ===
    let critMod = isCrit ? 1.5 : 1;
    // ã€ç‹™å‡»æ‰‹ Sniperã€‘æš´å‡»ä¼¤å®³ x1.5 (æ€»è®¡ 2.25x)
    if (isCrit) {
        const attackerAbility = attacker.ability || '';
        const attackerAh = (typeof AbilityHandlers !== 'undefined' && AbilityHandlers[attackerAbility]) || {};
        if (attackerAh.onCritDamage) {
            const baseCritDamage = 100; // ç”¨äºè®¡ç®—å€ç‡
            const modifiedDamage = attackerAh.onCritDamage(baseCritDamage);
            critMod = critMod * (modifiedDamage / baseCritDamage);
            console.log(`[${attackerAbility}] æš´å‡»ä¼¤å®³ä¿®æ­£: ${critMod.toFixed(2)}x`);
        }
    }
    // ä¹±æ•°
    const random = 0.85 + Math.random() * 0.15;
    // é˜²æ­¢é™¤ä»¥0
    const finalDef = Math.max(1, defStat);
    // ä¼¤å®³å…¬å¼
    let singleHitDamage = Math.floor(
        ((2 * attacker.level / 5 + 2) * basePower * (atkStat / finalDef) / 50 + 2)
        * stab * effectiveness * critMod * random * lifeOrbBoost
    );
    if (effectiveness > 0 && singleHitDamage < 1) singleHitDamage = 1;
    if (effectiveness === 0) singleHitDamage = 0;
    // === ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘ä¼¤å®³ä¿®æ­£ ===
    if (typeof window !== 'undefined' && window.envOverlay) {
        // ç¡®ä¿ move å¯¹è±¡åŒ…å«å®Œæ•´çš„ flags æ•°æ®ï¼ˆç”¨äº Flag:Pulse ç­‰é€‰æ‹©å™¨ï¼‰
        const moveWithFlags = { ...move, flags: move.flags || fullMoveData.flags || {} };
        const envDmgMod = window.envOverlay.getDamageMod(attacker, defender, moveWithFlags);
        if (envDmgMod !== 1) {
            const oldDmg = singleHitDamage;
            singleHitDamage = Math.floor(singleHitDamage * envDmgMod);
            console.log(`[ENV OVERLAY] ğŸŒ ä¼¤å®³ä¿®æ­£: ${oldDmg} Ã— ${envDmgMod} = ${singleHitDamage}`);
        }
    }
    // === é˜²å¾¡æ–¹ç‰¹æ€§ä¼¤å®³ä¿®æ­£ ===
    // ã€é‡è¦ã€‘ä¼ é€’ isSimulation æ ‡è®°ï¼Œé¿å… AI æ¨¡æ‹Ÿæ—¶è§¦å‘å½¢æ€å˜åŒ–ç­‰å‰¯ä½œç”¨
    let defenderAbilityLog = null;
    if (!ignoresAbilities && typeof AbilityHandlers !== 'undefined' && defender.ability && AbilityHandlers[defender.ability]) {
        const ahDef = AbilityHandlers[defender.ability];
        if (ahDef.onDefenderModifyDamage) {
            const originalDamage = singleHitDamage;
            const result = ahDef.onDefenderModifyDamage(singleHitDamage, attacker, defender, move, effectiveness, options.isSimulation);
            // æ”¯æŒè¿”å›å¯¹è±¡ { damage, log } æˆ–ç›´æ¥è¿”å›æ•°å­—
            if (typeof result === 'object' && result !== null) {
                singleHitDamage = result.damage;
                defenderAbilityLog = result.log || null;
            } else {
                singleHitDamage = result;
            }
            // ã€å¹²ç‡¥çš®è‚¤ç­‰ç‰¹æ€§ã€‘å¦‚æœä¼¤å®³å¢åŠ ä¸”æ²¡æœ‰è‡ªå®šä¹‰æ—¥å¿—ï¼Œç”Ÿæˆé»˜è®¤æ—¥å¿—
            if (!options.isSimulation && singleHitDamage > originalDamage && !defenderAbilityLog) {
                const abilityName = defender.ability;
                if (abilityName === 'Dry Skin' && move.type === 'Fire') {
                    defenderAbilityLog = `ğŸ”¥ ${defender.cnName} çš„å¹²ç‡¥çš®è‚¤è®©ç«ç³»ä¼¤å®³å¢åŠ äº†!`;
                }
            }
        }
    }
    // === ã€Chronal Rift å¼‚å…½æ°”åœºã€‘Ultra Beast ä¼¤å®³å‡å… ===
    let beastAuraLog = null;
    if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.checkBeastAura) {
        const weather = (typeof battle !== 'undefined' && battle) ? (battle.weather || battle.environmentWeather || '') : '';
        const auraResult = window.WeatherEffects.checkBeastAura(weather, defender, attacker);
        if (auraResult.hasAura) {
            singleHitDamage = Math.floor(singleHitDamage * auraResult.damageMultiplier);
            beastAuraLog = auraResult.message;
            console.log(`[CHRONAL RIFT] ğŸ›¡ï¸ å¼‚å…½æ°”åœºï¼šä¼¤å®³ ${singleHitDamage}`);
        }
    }
    // === åŒå¢™/æå…‰å¹•å‡ä¼¤ ===
    // ã€Infiltratorã€‘ç©¿é€ç‰¹æ€§æ— è§†å…‰å¢™/åå°„å£/æå…‰å¹•
    const attackerIgnoresScreens = (typeof AbilityHandlers !== 'undefined' && attacker.ability && AbilityHandlers[attacker.ability])
        ? AbilityHandlers[attacker.ability].ignoreScreens
        : false;
    if (typeof battle !== 'undefined' && battle && !attackerIgnoresScreens) {
        const defenderSide = (defender === battle.getPlayer?.()) ? battle.playerSide : battle.enemySide;
        if (defenderSide) {
            if (defenderSide.auroraVeil > 0) {
                singleHitDamage = Math.floor(singleHitDamage * 0.5);
            }
            else if (!isSpecial && defenderSide.reflect > 0) {
                singleHitDamage = Math.floor(singleHitDamage * 0.5);
            }
            else if (isSpecial && defenderSide.lightScreen > 0) {
                singleHitDamage = Math.floor(singleHitDamage * 0.5);
            }
        }
    }
    // === æŠ—æ€§æ ‘æœå‡ä¼¤ ===
    let resistBerryTriggered = false;
    let resistBerryMessage = '';
    if (typeof ItemEffects !== 'undefined' && ItemEffects.checkResistBerry && effectiveness >= 2) {
        const berryResult = ItemEffects.checkResistBerry(defender, move.type, effectiveness);
        if (berryResult.triggered) {
            singleHitDamage = Math.floor(singleHitDamage * berryResult.damageMultiplier);
            resistBerryTriggered = true;
            resistBerryMessage = berryResult.message;
            console.log(`[RESIST BERRY] ${resistBerryMessage}`);
        }
    }
    // === ç»“å®ç‰¹æ€§ Hook ===
    if (typeof AbilityHandlers !== 'undefined' && defender.ability && AbilityHandlers[defender.ability]) {
        const ahDef = AbilityHandlers[defender.ability];
        if (ahDef.onDamageHack) {
            singleHitDamage = ahDef.onDamageHack(singleHitDamage * hitCount, defender);
            return { 
                damage: singleHitDamage, 
                singleHitDamage,
                effectiveness, 
                isCrit, 
                miss: false, 
                hitCount,
                sturdyActivated: singleHitDamage === defender.currHp - 1
            };
        }
    }
    // æ€»ä¼¤å®³
    let totalDamage = singleHitDamage * hitCount;
    // ã€åŠæ— æ•ŒçŠ¶æ€åŒå€ä¼¤å®³ã€‘åœ°éœ‡å¯¹æŒ–æ´ã€å†²æµªå¯¹æ½œæ°´ç­‰
    if (move._invulnDoubleDamage) {
        totalDamage = totalDamage * 2;
        console.log(`[INVULN] åŒå€ä¼¤å®³ç”Ÿæ•ˆ: ${totalDamage / 2} Ã— 2 = ${totalDamage}`);
        delete move._invulnDoubleDamage; // æ¸…é™¤æ ‡è®°
    }
    // ã€å¯¹å†²ç³»ç»Ÿã€‘åº”ç”¨å¯¹å†²ä¼¤å®³å€ç‡
    if (move.clashDamageMultiplier !== undefined && move.clashDamageMultiplier < 1) {
        const originalDamage = totalDamage;
        totalDamage = Math.floor(totalDamage * move.clashDamageMultiplier);
        console.log(`[CLASH] å¯¹å†²ä¼¤å®³å‰Šå‡: ${originalDamage} Ã— ${move.clashDamageMultiplier} = ${totalDamage}`);
    }
    return { 
        damage: totalDamage, 
        singleHitDamage,
        effectiveness, 
        isCrit, 
        miss: false, 
        hitCount,
        resistBerryTriggered,
        resistBerryMessage,
        commandCritTriggered,
        defenderAbilityLog,
        moveGlitchLog    // Chronal Rift æŠ€èƒ½é»‘ç®±æ—¥å¿—
    };
}
// ============================================
// å¯¼å‡ºåˆ°å…¨å±€
// ============================================
if (typeof window !== 'undefined') {
    window.calcDamage = calcDamage;
}
]]></file>
        <file name="battle-damage.js"><![CDATA[/**
 * ===========================================
 * BATTLE-DAMAGE.JS - ä¼¤å®³ç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - ä¼¤å®³è®¡ç®—ä¸åº”ç”¨
 * - å‘½ä¸­/Miss å¤„ç†
 * - ç‰¹æ€§å…ç–«æ£€æµ‹
 * - Protect å®ˆä½æ‹¦æˆª
 * - æ›¿èº«å¸æ”¶
 * - å‰¯ä½œç”¨è§¦å‘
 */
// ============================================
// ä¼¤å®³è®¡ç®—ä¸åº”ç”¨
// ============================================
/**
 * ä¼¤å®³è®¡ç®—ä¸åº”ç”¨ (å«å¤šæ®µæ”»å‡»ã€åä¼¤ã€å¸è¡€ã€èƒ½åŠ›å˜åŒ–)
 * @param {Object} attacker æ”»å‡»æ–¹
 * @param {Object} defender é˜²å¾¡æ–¹
 * @param {Object} move æ‹›å¼
 * @param {string} spriteIdRef ç›®æ ‡ç²¾çµå›¾ ID ('player-sprite' æˆ– 'enemy-sprite')
 * @returns {Object} ä¼¤å®³ç»“æœ
 */
export function applyDamage(attacker, defender, move, spriteIdRef) {
    const battle = window.battle;
    // === å…³é”®ä¿®å¤ï¼šåœ¨è®¡ç®—ä¼¤å®³å‰æ£€æŸ¥ onUseï¼ˆå¦‚ Fake Out é¦–å›åˆé™åˆ¶ï¼‰ ===
    const handler = (typeof getMoveHandler === 'function') ? getMoveHandler(move.name) : null;
    const isPlayerAttacking = spriteIdRef !== 'player-sprite';
    // åªå¯¹æ”»å‡»æŠ€åšå‰ç½®æ£€æŸ¥ï¼Œå˜åŒ–æŠ€çš„ onUse åœ¨åé¢å¤„ç†
    const moveCategory = move.cat || '';
    const isStatusMove = moveCategory === 'status' || move.power === 0;
    // =========================================================
    // ã€Magic Bounce é­”æ³•é•œã€‘åå¼¹å˜åŒ–æŠ€
    // =========================================================
    const defenderAbility = (defender.ability || '').toLowerCase().replace(/[^a-z]/g, '');
    const attackerAbility = (attacker.ability || '').toLowerCase().replace(/[^a-z]/g, '');
    // æ£€æŸ¥æ˜¯å¦ä¸ºå¯åå¼¹çš„å˜åŒ–æŠ€ï¼ˆæ’é™¤æ”»å‡»è€…æœ‰ç ´æ ¼ç‰¹æ€§çš„æƒ…å†µï¼‰
    // ã€è½¯ç¼–ç ã€‘ç ´æ ¼ç‰¹æ€§åˆ—è¡¨ä» ability-handlers.js è¯»å–
    const moldBreakerAbilities = (typeof AbilityHandlers !== 'undefined' && AbilityHandlers._moldBreakerAbilities) 
        ? AbilityHandlers._moldBreakerAbilities 
        : ['moldbreaker', 'teravolt', 'turboblaze'];
    const hasMoldBreaker = moldBreakerAbilities.includes(attackerAbility);
    if (defenderAbility === 'magicbounce' && isStatusMove && !hasMoldBreaker && !move._bounced) {
        // ã€è½¯ç¼–ç ã€‘ä» moves-data.js è¯»å– reflectable æ ‡è®°
        const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
        // æ£€æŸ¥æ‹›å¼æ˜¯å¦æœ‰ reflectable æ ‡è®°
        const isReflectable = fullMoveData.flags?.reflectable === 1 || fullMoveData.flags?.reflectable === true;
        if (isReflectable) {
            log(`<b style='color:#e056fd'>âœ¨ ${defender.cnName} çš„é­”æ³•é•œåå¼¹äº† ${move.cn || move.name}ï¼</b>`);
            // åå¼¹æ‹›å¼ï¼šäº¤æ¢æ”»å‡»è€…å’Œé˜²å¾¡è€…
            const bouncedSpriteId = isPlayerAttacking ? 'player-sprite' : 'enemy-sprite';
            // é€’å½’è°ƒç”¨ï¼Œä½†æ ‡è®°ä¸ºå·²åå¼¹é˜²æ­¢æ— é™å¾ªç¯
            const bouncedMove = { ...move, _bounced: true };
            return applyDamage(defender, attacker, bouncedMove, bouncedSpriteId);
        }
    }
    if (handler && handler.onUse && !isStatusMove) {
        let preLogs = [];
        const preCheck = handler.onUse(attacker, defender, preLogs, battle, isPlayerAttacking);
        if (preCheck && preCheck.failed) {
            preLogs.forEach(txt => log(`<span style="color:#e74c3c">${txt}</span>`));
            return { damage: 0, effectiveness: 0, miss: false, failed: true };
        }
        // ã€è“„åŠ›æŠ€èƒ½ã€‘æ­£åœ¨è“„åŠ›ä¸­ï¼Œè·³è¿‡ä¼¤å®³è®¡ç®—
        if (preCheck && preCheck.charging && preCheck.skipDamage) {
            preLogs.forEach(txt => log(txt));
            console.log(`[CHARGE MOVE] ${move.name} is charging, skipping damage calculation`);
            return { damage: 0, effectiveness: 1, miss: false, charging: true };
        }
        preLogs.forEach(txt => log(txt));
    }
    // ä½¿ç”¨ battle-engine çš„ä¼¤å®³è®¡ç®—
    const result = window.calcDamage(attacker, defender, move);
    // 0. å¤„ç†æ‹›å¼å¤±è´¥ï¼ˆå¦‚é£Ÿæ¢¦å¯¹æœªç¡çœ ç›®æ ‡ï¼‰
    if (result.failed) {
        log(`<b style='color:#e74c3c'>${result.failMessage || 'ä½†æ˜¯æ‹›å¼å¤±è´¥äº†ï¼'}</b>`);
        return result;
    }
    // 0. ã€Chronal Rift æŠ€èƒ½é»‘ç®±ã€‘å¤„ç†æŠ€èƒ½å´©æºƒï¼ˆä¼¤å®³å½’é›¶ï¼‰
    if (result.moveGlitchLog && result.damage === 0 && result.hitCount === 0) {
        log(result.moveGlitchLog);
        return result;
    }
    // 0. å¤„ç†ç‰¹æ€§å…ç–« (é£˜æµ®ã€é¿é›·é’ˆç­‰)
    if (result.abilityImmune) {
        log(`<b style='color:#9b59b6'>${defender.cnName} çš„ ${result.abilityImmune} å¸æ”¶/å…ç–«äº†æ”»å‡»!</b>`);
        return result;
    }
    // 0. å¤„ç†æ¶ä½œå‰§ä¹‹å¿ƒå…ç–« (æ¶ç³»å…ç–«å˜åŒ–æŠ€)
    if (result.pranksterImmune) {
        log(`<b style='color:#8b5cf6'>${result.message || defender.cnName + ' æ˜¯æ¶å±æ€§ï¼Œå…ç–«äº†æ¶ä½œå‰§ä¹‹å¿ƒçš„æ•ˆæœï¼'}</b>`);
        return result;
    }
    // 0. å¤„ç†å§‹æºå¤©æ°”æ‹›å¼å¤±æ•ˆ (Desolate Land / Primordial Sea)
    if (result.weatherBlocked) {
        log(result.weatherBlockMessage || `<b style='color:#9b59b6'>æ‹›å¼è¢«å¤©æ°”é˜»æ­¢äº†ï¼</b>`);
        return result;
    }
    // 0. å¤„ç† Protect å®ˆä½æ‹¦æˆª
    if (result.blocked && (result.protectBlocked || defender.volatile?.protect !== undefined)) {
        // ã€ä¿®å¤ã€‘åŒºåˆ†æ”»å‡»æŠ€å’Œå˜åŒ–æŠ€çš„å®ˆä½æ—¥å¿—
        if (result.protectBlocked) {
            // å˜åŒ–æŠ€è¢«å®ˆä½ï¼ˆå¦‚è˜‘è‡å­¢å­ï¼‰
            log(`<b style='color:#3498db'>${defender.cnName} å®ˆä½äº†è‡ªå·±ï¼Œ${move.cn || move.name} è¢«é˜²ä½äº†!</b>`);
        } else {
            // æ”»å‡»æŠ€è¢«å®ˆä½
            log(`<b style='color:#3498db'>${defender.cnName} å®ˆä½äº†è‡ªå·±ï¼Œå…å—äº†æ”»å‡»!</b>`);
        }
        // å®ˆä½ç±»æ‹›å¼çš„æ¥è§¦ååˆ¶æ•ˆæœ
        if (result.protectEffect) {
            log(`<b style='color:#e74c3c'>${result.protectEffect.msg}</b>`);
            updateAllVisuals();
        }
        // æ¸…é™¤å®ˆä½çŠ¶æ€ï¼ˆå·²ä½¿ç”¨ï¼‰
        if (defender.volatile) {
            defender.volatile.protect = false;
            defender.volatile.banefulBunker = false;
            defender.volatile.spikyShield = false;
            defender.volatile.kingsShield = false;
            defender.volatile.obstruct = false;
            defender.volatile.silkTrap = false;
            defender.volatile.burningBulwark = false;
        }
        // High Jump Kick / Jump Kick å¤±è´¥åä¼¤
        if (move.name === 'High Jump Kick' || move.name === 'Jump Kick') {
            const crashDmg = Math.floor(attacker.maxHp / 2);
            attacker.takeDamage(crashDmg);
            log(`<b style='color:#e74c3c'>${attacker.cnName} å¤±å»äº†å¹³è¡¡ï¼Œæ‘”å€’å—åˆ°äº† ${crashDmg} ç‚¹ä¼¤å®³!</b>`);
        }
        // ã€å…³é”®ä¿®å¤ã€‘selfdestruct: "always" çš„æ‹›å¼å³ä½¿è¢«å®ˆä½ä¹Ÿè¦æ­»
        // Explosion, Self-Destruct, Misty Explosion ç­‰
        const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
        if (fullMoveData.selfdestruct === 'always') {
            attacker.currHp = 0;
            log(`<b style='color:#e74c3c'>${attacker.cnName} çš„çˆ†ç‚¸æ³¢åŠäº†è‡ªå·±ï¼</b>`);
            console.log(`[SELFDESTRUCT] ${attacker.cnName} å³ä½¿è¢«å®ˆä½ä¹Ÿè‡ªçˆ†äº†`);
        }
        // ã€å…³é”®ä¿®å¤ã€‘mindBlownRecoil çš„æ‹›å¼å³ä½¿è¢«å®ˆä½ä¹Ÿè¦æ‰£ 50% HP
        // Mind Blown, Steel Beam, Chloroblast ç­‰
        if (fullMoveData.mindBlownRecoil) {
            const recoil = Math.ceil(attacker.maxHp / 2);
            attacker.takeDamage(recoil);
            log(`<b style='color:#e74c3c'>${attacker.cnName} æ‰¿å—äº†åä½œç”¨åŠ›ï¼(-${recoil})</b>`);
            console.log(`[MIND BLOWN RECOIL] ${attacker.cnName} å³ä½¿è¢«å®ˆä½ä¹Ÿæ‰£è¡€ ${recoil}`);
        }
        return result;
    }
    // I. å¤„ç† MISS
    if (result.miss) {
        if (result.invulnerableMiss) {
            // ã€åŠæ— æ•ŒçŠ¶æ€ã€‘ç›®æ ‡å¤„äºé£ç¿”/æŒ–æ´/æ½œæ°´ç­‰çŠ¶æ€
            const statusTexts = {
                flying: 'é£åœ¨å¤©ç©ºä¸­',
                underground: 'èº²åœ¨åœ°ä¸‹',
                underwater: 'æ½œåœ¨æ°´ä¸­',
                shadow: 'éšè—åœ¨æš—å½±ä¸­'
            };
            const statusText = statusTexts[result.invulnStatus] || 'å¤„äºåŠæ— æ•ŒçŠ¶æ€';
            log(`<b style='color:#aaa'>${defender.cnName} ${statusText}ï¼Œæ”»å‡»æ²¡æœ‰å‘½ä¸­!</b>`);
        } else if (result.insightMiracle) {
            log(`<b style="color:#d4ac0d; text-shadow:0 0 5px gold;">âœ¨ ä¸å¯èƒ½çš„å¥‡è¿¹ï¼${defender.cnName} çœ‹ç©¿äº†ç»å¯¹å‘½ä¸­çš„è½¨è¿¹ï¼(Insight EX)</b>`);
        } else if (defender.commandDodgeActive) {
            // ã€æˆ˜æœ¯æŒ‡æŒ¥ã€‘DODGE! æŒ‡ä»¤æˆåŠŸé—ªé¿
            log(`<b style='color:#aaa'>ä½†æ˜¯æ”»å‡»æ²¡æœ‰å‘½ä¸­!</b>`);
            log(`<b style="color:#00cec9; text-shadow:0 0 8px #00cec9;">ğŸ‘ï¸ ${defender.cnName} å¬ä»äº†è®­ç»ƒå®¶çš„æŒ‡æŒ¥ï¼Œåä¸½åœ°é—ªé¿äº†æ”»å‡»ï¼[DODGE!]</b>`);
            defender.commandDodgeActive = false; // ä½¿ç”¨åæ¶ˆè€—
        } else if (result.insightDodge && defender.avs && defender.avs.insight >= 100) {
            log(`<b style='color:#aaa'>ä½†æ˜¯æ”»å‡»æ²¡æœ‰å‘½ä¸­!</b>`);
            log(`<b style="color:#a78bfa">âœ¨ ${defender.cnName} å‡­å€ŸçµçŠ€æ„Ÿåº”é¢„åˆ¤äº†æ”»å‡»è½¨è¿¹! (Insight${defender.avsEvolutionBoost ? ' x2' : ''})</b>`);
        } else {
            log(`<b style='color:#aaa'>ä½†æ˜¯æ”»å‡»æ²¡æœ‰å‘½ä¸­!</b>`);
        }
        // High Jump Kick / Jump Kick å¤±è´¥åä¼¤
        if (move.name === 'High Jump Kick' || move.name === 'Jump Kick') {
            const crashDmg = Math.floor(attacker.maxHp / 2);
            attacker.takeDamage(crashDmg);
            log(`<b style='color:#e74c3c'>${attacker.cnName} å¤±å»äº†å¹³è¡¡ï¼Œæ‘”å€’å—åˆ°äº† ${crashDmg} ç‚¹ä¼¤å®³!</b>`);
        }
        // ã€è·¯ç—´ä¿é™© Blunder Policyã€‘Missåé€Ÿåº¦+2
        if (result.triggerBlunderPolicy && typeof ItemEffects !== 'undefined' && ItemEffects.checkBlunderPolicy) {
            let blunderLogs = [];
            ItemEffects.checkBlunderPolicy(attacker, blunderLogs);
            blunderLogs.forEach(txt => log(txt));
        }
        // ã€å…³é”®ä¿®å¤ã€‘selfdestruct: "always" çš„æ‹›å¼å³ä½¿ MISS ä¹Ÿè¦æ­»
        const moveIdMiss = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        const fullMoveDataMiss = (typeof MOVES !== 'undefined' && MOVES[moveIdMiss]) ? MOVES[moveIdMiss] : {};
        if (fullMoveDataMiss.selfdestruct === 'always') {
            attacker.currHp = 0;
            log(`<b style='color:#e74c3c'>${attacker.cnName} çš„çˆ†ç‚¸æ³¢åŠäº†è‡ªå·±ï¼</b>`);
            console.log(`[SELFDESTRUCT] ${attacker.cnName} å³ä½¿ MISS ä¹Ÿè‡ªçˆ†äº†`);
        }
        // ã€å…³é”®ä¿®å¤ã€‘mindBlownRecoil çš„æ‹›å¼å³ä½¿ MISS ä¹Ÿè¦æ‰£ 50% HP
        if (fullMoveDataMiss.mindBlownRecoil) {
            const recoil = Math.ceil(attacker.maxHp / 2);
            attacker.takeDamage(recoil);
            log(`<b style='color:#e74c3c'>${attacker.cnName} æ‰¿å—äº†åä½œç”¨åŠ›ï¼(-${recoil})</b>`);
            console.log(`[MIND BLOWN RECOIL] ${attacker.cnName} å³ä½¿ MISS ä¹Ÿæ‰£è¡€ ${recoil}`);
        }
        return result;
    }
    // II. å˜åŒ–æŠ€ (Power=0, Status Move)
    if (result.damage === 0 && move.power === 0) {
        // æ£€æŸ¥æ˜¯å¦ä¸ºåå¼¹æŠ€èƒ½ï¼ˆCounter/Mirror Coat/Metal Burstï¼‰
        const reflectHandler = (typeof getMoveHandler === 'function') ? getMoveHandler(move.name) : null;
        if (reflectHandler && reflectHandler.isReflectMove) {
            let reflectLogs = [];
            const reflectResult = reflectHandler.onUse(attacker, defender, reflectLogs, battle, spriteIdRef !== 'player-sprite');
            reflectLogs.forEach(txt => log(txt));
            if (reflectResult && reflectResult.failed) {
                return result;
            }
            if (reflectResult && reflectResult.damage > 0) {
                defender.takeDamage(reflectResult.damage);
                log(`é€ æˆäº† <b style="color:#e74c3c">${reflectResult.damage}</b> ä¼¤å®³ï¼`);
                const targetEl = document.getElementById(spriteIdRef);
                if (targetEl) {
                    targetEl.classList.remove('shake-hit-anim');
                    void targetEl.offsetWidth;
                    targetEl.classList.add('shake-hit-anim');
                    if (defender.currHp <= 0) {
                        targetEl.classList.add('fainting');
                    }
                }
                result.damage = reflectResult.damage;
                updateAllVisuals();
            }
            return result;
        }
        // å˜åŒ–æŠ€ Miss åˆ¤å®š
        if (result.miss) {
            log(`<b style='color:#aaa'>ä½†æ˜¯æ²¡æœ‰å‘½ä¸­!</b>`);
            return result;
        }
        // å¤„ç† Volatile çŠ¶æ€æŠ€èƒ½ (Taunt, Substitute ç­‰)
        if (typeof MoveEffects !== 'undefined' && MoveEffects.applyVolatileStatus) {
            const volatileResult = MoveEffects.applyVolatileStatus(attacker, defender, move);
            if (volatileResult.success) {
                volatileResult.logs.forEach(txt => log(txt));
                return result;
            } else if (volatileResult.logs.length > 0) {
                volatileResult.logs.forEach(txt => log(txt));
                return result;
            }
        }
        // å¤„ç†å˜åŒ–æŠ€çš„èƒ½åŠ›å˜åŒ–
        const fxResult = applyMoveSecondaryEffects(attacker, defender, move, 0, battle, spriteIdRef !== 'player-sprite');
        const fxLogs = Array.isArray(fxResult) ? fxResult : (fxResult.logs || []);
        if (fxLogs.length > 0) {
            fxLogs.forEach(txt => log(txt));
        } else {
            log(`...${move.cn}! (å˜åŒ–æŠ€èƒ½)`);
        }
        result.pivot = fxResult.pivot || false;
        return result;
    }
    // === Disguise (ç”»çš®) ç‰¹æ€§å¤„ç† ===
    if (defender.disguiseBustDamage && defender.disguiseBustDamage > 0) {
        log(`<b style="color:#9b59b6">ğŸ­ ${defender.cnName} çš„ç”»çš®ç ´æŸäº†!</b>`);
        log(`<b style="color:#3498db">${defender.cnName} å…ç–«äº†è¿™æ¬¡æ”»å‡»!</b>`);
        defender.takeDamage(defender.disguiseBustDamage);
        log(`<span style="color:#e67e22">${defender.cnName} å—åˆ°äº†ç”»çš®ç ´æŸçš„ä¼¤å®³! (-${defender.disguiseBustDamage})</span>`);
        defender.disguiseBustDamage = 0;
        updateAllVisuals();
        return result;
    }
    // === ã€ä¿®å¤ã€‘Ice Face ç­‰ç‰¹æ€§æŠŠæ”»å‡»æŠ€ä¼¤å®³å½’é›¶çš„å¤„ç† ===
    // å½“æ”»å‡»æŠ€ (power > 0) ä¼¤å®³è¢«ç‰¹æ€§å½’é›¶æ—¶ï¼Œè¾“å‡ºç‰¹æ€§æ—¥å¿—
    if (result.damage === 0 && move.power > 0 && result.defenderAbilityLog) {
        log(result.defenderAbilityLog);
        updateAllVisuals();
        return result;
    }
    // III. å¦‚æœæœ‰ä¼¤å®³ -> æ‰£è¡€
    const dmgCategory = (move.cat || result.category || 'physical').toLowerCase();
    if (result.damage > 0) {
        // æ£€æŸ¥æ›¿èº«æ˜¯å¦å¸æ”¶ä¼¤å®³
        // ã€Infiltratorã€‘ä¼ å…¥ attacker ä»¥æ£€æŸ¥ ignoreSubstitute
        if (typeof MoveEffects !== 'undefined' && MoveEffects.checkSubstitute) {
            const subResult = MoveEffects.checkSubstitute(defender, result.damage, move, attacker);
            if (subResult.absorbed) {
                subResult.logs.forEach(txt => log(txt));
                result.damage = 0;
                updateAllVisuals();
                return result;
            }
        }
        // ã€ä¿®å¤ã€‘è®°å½•å®é™…é€ æˆçš„ä¼¤å®³ï¼ˆä¸è¶…è¿‡ç›®æ ‡å½“å‰HPï¼‰ç”¨äºæ—¥å¿—æ˜¾ç¤º
        const actualDamage = Math.min(result.damage, defender.currHp);
        defender.takeDamage(result.damage, dmgCategory);
        result.displayDamage = actualDamage; // ç”¨äºæ—¥å¿—æ˜¾ç¤ºçš„å®é™…ä¼¤å®³
        // ã€Gen 9 Rage Fistã€‘è®°å½•è¢«æ”»å‡»æ¬¡æ•°ï¼ˆç”¨äºæ„¤æ€’ä¹‹æ‹³å¨åŠ›è®¡ç®—ï¼‰
        // åªæœ‰å®é™…é€ æˆä¼¤å®³æ‰è®¡æ•°ï¼Œå¤šæ®µæ”»å‡»æ¯æ®µéƒ½ç®—ä¸€æ¬¡
        if (actualDamage > 0) {
            const hitCount = result.hitCount || 1;
            defender.timesAttacked = (defender.timesAttacked || 0) + hitCount;
            console.log(`[Rage Fist Counter] ${defender.cnName} è¢«æ”»å‡»æ¬¡æ•°: ${defender.timesAttacked}`);
        }
        // ã€ç‰¹æ€§é’©å­ã€‘å—åˆ°ä¼¤å®³åè§¦å‘ onDamageTaken (Stamina, Justified, Steam Engine, etc.)
        if (typeof AbilityHandlers !== 'undefined' && defender.ability) {
            const abilityHandler = AbilityHandlers[defender.ability];
            if (abilityHandler && abilityHandler.onDamageTaken) {
                let damageLogs = [];
                abilityHandler.onDamageTaken(defender, actualDamage, attacker, damageLogs, move);
                damageLogs.forEach(txt => log(txt));
            }
        }
        // ã€Focus Punch ä¸­æ–­æ£€æŸ¥ã€‘å—åˆ°ä¼¤å®³æ—¶ï¼Œå¦‚æœæ­£åœ¨è“„åŠ›çœŸæ°”æ‹³åˆ™ä¸­æ–­
        if (actualDamage > 0 && typeof window.checkFocusPunchInterrupt === 'function') {
            if (window.checkFocusPunchInterrupt(defender, actualDamage)) {
                log(`<b style="color:#e74c3c">${defender.cnName} å¤±å»äº†é›†ä¸­ï¼ŒçœŸæ°”æ‹³è¢«ä¸­æ–­äº†ï¼</b>`);
                // æ¸…é™¤è“„åŠ›çŠ¶æ€
                if (typeof window.clearChargingState === 'function') {
                    window.clearChargingState(defender);
                }
            }
        }
        // ã€Beak Blast çƒ§ä¼¤æ£€æŸ¥ã€‘è“„åŠ›æœŸé—´è¢«æ¥è§¦æ”»å‡»ä¼šçƒ§ä¼¤å¯¹æ‰‹
        if (actualDamage > 0 && typeof window.checkBeakBlastBurn === 'function') {
            let burnLogs = [];
            if (window.checkBeakBlastBurn(defender, attacker, move, burnLogs)) {
                burnLogs.forEach(txt => log(txt));
            }
        }
        // ã€å—å‡»è§£å†»ã€‘ç«ç³»æ‹›å¼æˆ– thawsTarget æ‹›å¼ä¼šè§£é™¤ç›®æ ‡çš„å†°å†»çŠ¶æ€
        if (defender.status === 'frz' && defender.currHp > 0) {
            const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
            const moveType = fullMoveData.type || move.type || 'Normal';
            const thawsTarget = fullMoveData.thawsTarget || false;
            if (moveType === 'Fire' || thawsTarget) {
                defender.status = null;
                log(`<b style="color:#f97316">ğŸ”¥ ${defender.cnName} è¢«${thawsTarget ? 'çƒ­æ°”' : 'ç«ç„°'}èåŒ–äº†å†°å†»çŠ¶æ€!</b>`);
            }
        }
        // === æ’­æ”¾æ‰“å‡»éŸ³æ•ˆ ===
        if (typeof window.playHitSFX === 'function') {
            window.playHitSFX(result.effectiveness, result.isCrit);
        }
        // Focus Sash è§¦å‘æ—¥å¿—
        if (defender.focusSashTriggered) {
            log(`<b style="color:#f1c40f">ğŸ›¡ï¸ ${defender.cnName} çš„æ°”åŠ¿æŠ«å¸¦å‘åŠ¨äº†ï¼å‹‰å¼ºæ’‘ä½äº†æ”»å‡»ï¼</b>`);
            defender.focusSashTriggered = false;
        }
        // AVs: Trust (ä¿¡èµ–) é”è¡€è§¦å‘æ—¥å¿—
        if (defender.trustEndureTriggered) {
            log(`<b style="color:#e91e63">ğŸ’– ${defender.cnName} å‡­å€Ÿä¸è®­ç»ƒå®¶çš„ç¾ç»Šï¼Œç”¨è„¸æ¥ä¸‹äº†è‡´å‘½ä¸€å‡»! (Trust)</b>`);
            defender.trustEndureTriggered = false;
        }
        // Second Wind (ç¬¬äºŒæ°”æ¯) è§¦å‘æ—¥å¿—
        if (defender.secondWindActivated) {
            log(`<b style="color:#ff6b35">ğŸ”¥ ${defender.cnName} çš„ç¬¬äºŒæ°”æ¯è§‰é†’äº†!</b>`);
            log(`<b style="color:#ff6b35">ğŸ’ª å…¨å±æ€§æå‡! æ”»å‡»+1 é˜²å¾¡+1 ç‰¹æ”»+1 ç‰¹é˜²+1 é€Ÿåº¦+1!</b>`);
            defender.secondWindActivated = false;
        }
        // ã€æˆ˜æœ¯æŒ‡æŒ¥ã€‘HOLD ON! æŒ‡ä»¤è§¦å‘æ—¥å¿—
        if (defender.commandEndureTriggered) {
            log(`<b style="color:#a55eea; text-shadow:0 0 8px #a55eea;">ğŸ›¡ï¸ ${defender.cnName} åœ¨è®­ç»ƒå®¶çš„å‘¼å–Šä¸‹æ’‘ä½äº†ï¼</b>`);
            defender.commandEndureTriggered = false;
        }
        // Bond Endure (ç¾ç»ŠæŒºä½) è§¦å‘æ—¥å¿— - è¿›åŒ–æ‹¦æˆªå™¨
        // ã€ä»…é™ç©å®¶ã€‘æ•Œäººä¸è§¦å‘æ­¤æ—¥å¿—
        const isPlayerPokemon = window.battle && window.battle.playerParty && window.battle.playerParty.includes(defender);
        if (defender.bondEndureActivated && isPlayerPokemon) {
            log(`<b style="color:#d4ac0d; text-shadow:0 0 8px gold;">âœ¨ ${defender.cnName} å› ä¸ºæƒ³å›åº”è®­ç»ƒå®¶çš„æœŸå¾…ï¼Œæ’‘ä½äº†ï¼</b>`);
            log(`<span style="color:#fbbf24;">ğŸ’« è¿›åŒ–çš„å…‰èŠ’æ­£åœ¨æ¶ŒåŠ¨...æŒ‰ä¸‹ [EVO] æŒ‰é’®æ¥å›åº”å®ƒçš„æ„å¿—ï¼</span>`);
            defender.bondEndureActivated = false;
            // ç«‹å³æ›´æ–° EVO æŒ‰é’®å¯è§æ€§
            if (typeof updateEvolutionButtonVisuals === 'function') {
                updateEvolutionButtonVisuals();
            }
        } else if (defender.bondEndureActivated) {
            // æ•Œäººçš„æ ‡è®°ç›´æ¥æ¸…é™¤ï¼Œä¸æ˜¾ç¤ºæ—¥å¿—
            defender.bondEndureActivated = false;
        }
        // === ã€Ambrosia æ±¡æŸ“å›ç«ã€‘é«˜å¨åŠ›æ¯’/æ¶æ‹›å¼åå™¬ ===
        if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.checkContaminationRecoil) {
            const currentWeather = window.battle?.weather || '';
            const recoilResult = window.WeatherEffects.checkContaminationRecoil(currentWeather, move, attacker);
            if (recoilResult.triggered) {
                log(recoilResult.message);
                // åº”ç”¨æš´å‡»ç‡é™ä½
                if (recoilResult.effects.critDrop < 0) {
                    attacker.boosts = attacker.boosts || {};
                    attacker.boosts.critStage = (attacker.boosts.critStage || 0) + recoilResult.effects.critDrop;
                }
                // åº”ç”¨æ··ä¹±
                if (recoilResult.effects.confusion) {
                    attacker.volatile = attacker.volatile || {};
                    attacker.volatile.confusion = Math.floor(Math.random() * 4) + 2;
                }
            }
        }
        // === HP é˜ˆå€¼æ ‘æœæ£€æŸ¥ï¼ˆæ–‡æŸšæœã€æ··ä¹±æœç­‰ï¼‰===
        // ã€ä¿®å¤ã€‘å…ˆæ£€æŸ¥æ ‘æœè§¦å‘ï¼Œä½†å»¶è¿Ÿè¾“å‡ºæ—¥å¿—ï¼Œç¡®ä¿åœ¨ä¼¤å®³æ—¥å¿—ä¹‹åæ˜¾ç¤º
        // ã€å…³é”®ã€‘ä¼ é€’ attacker ä½œä¸º opponentï¼Œç”¨äº Unnerve æ£€æŸ¥
        let berryLogs = [];
        let berryTriggered = false;
        let cheekPouchHeal = 0;
        if (defender.currHp > 0 && typeof ItemEffects !== 'undefined' && ItemEffects.checkHPBerry) {
            berryTriggered = ItemEffects.checkHPBerry(defender, berryLogs, attacker);
            if (berryTriggered) {
                // é¢Šå›Šç‰¹æ€§å·²åœ¨ _triggerBerryAbilityHooks ä¸­å¤„ç†
                // è¿™é‡Œä¿ç•™å…¼å®¹æ€§æ£€æŸ¥
                const abilityId = (defender.ability || '').toLowerCase().replace(/[^a-z]/g, '');
                if (abilityId === 'cheekpouch' && !berryLogs.some(l => l.includes('é¢Šå›Š'))) {
                    const baseHeal = Math.floor(defender.maxHp * 0.33);
                    // ã€Smog åŒ–å­¦å±éšœã€‘ä½¿ç”¨ heal() æ–¹æ³•åº”ç”¨å‡åŠ
                    if (typeof defender.heal === 'function') {
                        cheekPouchHeal = defender.heal(baseHeal);
                    } else {
                        cheekPouchHeal = Math.min(baseHeal, defender.maxHp - defender.currHp);
                        defender.currHp = Math.min(defender.maxHp, defender.currHp + cheekPouchHeal);
                    }
                    berryLogs.push(`<b style="color:#f39c12">ğŸ¹ ${defender.cnName} çš„é¢Šå›Šå‘åŠ¨ï¼é¢å¤–å›å¤äº† ${cheekPouchHeal} HPï¼</b>`);
                }
            }
        }
        // æ’­æ”¾å—å‡»åŠ¨ç”»
        const targetEl = document.getElementById(spriteIdRef);
        if (targetEl) {
            targetEl.classList.remove('shake-hit-anim');
            targetEl.classList.remove('fainting');
            void targetEl.offsetWidth;
            targetEl.classList.add('shake-hit-anim');
            if (defender.currHp <= 0) {
                targetEl.classList.add('fainting');
                setTimeout(() => {
                    targetEl.classList.remove('fainting');
                    targetEl.classList.add('fainted-hidden');
                }, 750);
            }
        }
        // æ„å»ºä¼¤å®³æ–‡æœ¬
        let infoParts = [];
        if (result.hitCount > 1) {
            infoParts.push(`<span style="color:#9b59b6">(å‘½ä¸­ ${result.hitCount} æ¬¡)</span>`);
        }
        if (result.effectiveness >= 2) infoParts.push('<b style="color:#e74c3c">(æ•ˆæœæ‹”ç¾¤!)</b>');
        else if (result.effectiveness <= 0.5 && result.effectiveness > 0) infoParts.push('(æ•ˆæœä¸å¥½...)');
        // æŠ—æ€§æ ‘æœè§¦å‘æ¶ˆæ¯
        if (result.resistBerryTriggered && result.resistBerryMessage) {
            log(`<span style="color:#27ae60">ğŸ‡ ${result.resistBerryMessage}</span>`);
        }
        // ã€é˜²å¾¡æ–¹ç‰¹æ€§å¢ä¼¤æ—¥å¿—ã€‘å¹²ç‡¥çš®è‚¤ç­‰ç‰¹æ€§çš„ç«ç³»å¢ä¼¤åé¦ˆ
        if (result.defenderAbilityLog) {
            log(`<span style="color:#e67e22">${result.defenderAbilityLog}</span>`);
        }
        // ã€å¤©æ°”å¨åŠ›ä¿®æ­£æ—¥å¿—ã€‘ç«ç³»/æ°´ç³»æŠ€èƒ½ + Solar Beam/Solar Blade
        if (move._weatherPowerLog) {
            log(`<span style="color:#5dade2">${move._weatherPowerLog}</span>`);
            delete move._weatherPowerLog; // æ¸…é™¤æ ‡è®°
        }
        // ã€Chronal Rift æŠ€èƒ½é»‘ç®±ã€‘æš´èµ°æ—¥å¿—ï¼ˆå¨åŠ›ç¿»å€ï¼‰
        if (result.moveGlitchLog) {
            log(result.moveGlitchLog);
        }
        if (result.isCrit) {
            infoParts.push('<b class="hl-crit">å‡»ä¸­è¦å®³!</b>');
            // ã€æˆ˜æœ¯æŒ‡æŒ¥ã€‘FOCUS! æŒ‡ä»¤è§¦å‘çš„æš´å‡»
            if (result.commandCritTriggered) {
                infoParts.push(`<b style="color:#ff6b6b; text-shadow:0 0 5px #ff6b6b;">ğŸ”¥ [FOCUS!]</b>`);
            } else if (attacker.avs && attacker.getEffectiveAVs && attacker.getEffectiveAVs('passion') >= 100) {
                // ã€å…¨å±€å¼€å…³ã€‘ä½¿ç”¨ getEffectiveAVs æ£€æŸ¥æœ‰æ•ˆå€¼ï¼ˆAVS å…³é—­æ—¶è¿”å› 0ï¼‰
                infoParts.push(`<b style="color:#f59e0b">ğŸ”¥ (Passion${attacker.avsEvolutionBoost ? ' x2' : ''})</b>`);
            }
        }
        const infoStr = infoParts.join(' ');
        // ã€ä¿®å¤ã€‘ä½¿ç”¨ displayDamage æ˜¾ç¤ºå®é™…é€ æˆçš„ä¼¤å®³ï¼Œé¿å…æ˜¾ç¤ºè¶…è¿‡ç›®æ ‡HPçš„æ•°å€¼
        const shownDamage = result.displayDamage !== undefined ? result.displayDamage : result.damage;
        // ã€ä¿®å¤ã€‘å¦‚æœæ˜¯è‡´å‘½ä¸€å‡»ï¼ˆå‡»æ€ç›®æ ‡ï¼‰ï¼Œä¸æ˜¾ç¤ºå˜²è®½æ–‡æœ¬
        const isKillingBlow = defender.currHp <= 0;
        if (shownDamage <= 2 && result.effectiveness > 0 && !isKillingBlow) {
            log(`é€ æˆäº† <span style="color:#95a5a6">${shownDamage}</span> ä¼¤å®³... (ä»¿ä½›æ˜¯åœ¨ç»™å¯¹æ‰‹æŒ ç—’ç—’) ${infoStr}`);
        } else {
            log(`é€ æˆäº† ${shownDamage} ä¼¤å®³ ${infoStr}`);
        }
        // ã€è´å£³ä¹‹é“ƒ Shell Bellã€‘é€ æˆä¼¤å®³åå›å¤ 1/8 HP
        if (actualDamage > 0 && attacker.isAlive() && typeof ItemEffects !== 'undefined' && ItemEffects.checkShellBell) {
            let shellBellLogs = [];
            ItemEffects.checkShellBell(attacker, actualDamage, shellBellLogs);
            shellBellLogs.forEach(txt => log(txt));
        }
        // === ã€Smog ä¸“ç”¨ã€‘æ˜“çˆ†æ°”ä½“ - ç«ç³»æ‹›å¼åå†² ===
        if (result.smogFireRecoil && result.smogFireRecoil > 0 && attacker.isAlive()) {
            attacker.takeDamage(result.smogFireRecoil);
            log(`<span style="color:#f97316">ğŸ”¥ çƒŸéœ¾ä¸­çš„å¯ç‡ƒé¢—ç²’è¢«ç‚¹ç‡ƒï¼${attacker.cnName} è¢«çˆ†ç‡ƒæ³¢åŠï¼(-${result.smogFireRecoil})</span>`);
            updateAllVisuals();
        }
        // ã€ä¿®å¤ã€‘åœ¨ä¼¤å®³æ—¥å¿—ä¹‹åè¾“å‡ºæ ‘æœè§¦å‘æ—¥å¿—
        if (berryTriggered && berryLogs.length > 0) {
            berryLogs.forEach(txt => log(txt));
            if (cheekPouchHeal > 0) {
                log(`<span style="color:#27ae60">ğŸ¿ï¸ ${defender.cnName} çš„é¢Šå›Šå‘åŠ¨äº†ï¼é¢å¤–å›å¤äº† ${cheekPouchHeal} ç‚¹ä½“åŠ›ï¼</span>`);
            }
            updateAllVisuals();
        }
        // ã€å¼±ç‚¹ä¿é™© (Weakness Policy)ã€‘è¢«æ•ˆæœæ‹”ç¾¤æ”»å‡»åï¼Œæ”»å‡»å’Œç‰¹æ”»å„+2
        const defenderItem = (defender.item || '').toLowerCase().replace(/[^a-z]/g, '');
        if (result.effectiveness >= 2 && defenderItem === 'weaknesspolicy' && defender.currHp > 0) {
            log(`<b style="color:#e67e22">ğŸ“„ ${defender.cnName} çš„å¼±ç‚¹ä¿é™©ç”Ÿæ•ˆäº†ï¼</b>`);
            if (!defender.boosts) defender.boosts = {};
            defender.boosts.atk = Math.min(6, (defender.boosts.atk || 0) + 2);
            defender.boosts.spa = Math.min(6, (defender.boosts.spa || 0) + 2);
            log(`<span style="color:#ef4444">ğŸ’ª ${defender.cnName} çš„æ”»å‡»å¤§å¹…æå‡ï¼</span>`);
            log(`<span style="color:#a855f7">âœ¨ ${defender.cnName} çš„ç‰¹æ”»å¤§å¹…æå‡ï¼</span>`);
            // ã€å…³é”®ã€‘æ¶ˆè€—é“å…·å¹¶è§¦å‘ Unburden ç­‰ç‰¹æ€§
            const lostItem = defender.item;
            defender.item = null;
            defender.usedItem = lostItem; // è®°å½•ä½¿ç”¨è¿‡çš„é“å…·ï¼ˆç”¨äº Harvest ç­‰ï¼‰
            // è§¦å‘ onItemLost é’©å­ï¼ˆUnburden ç­‰ï¼‰
            if (typeof AbilityHandlers !== 'undefined' && defender.ability) {
                const abilityHandler = AbilityHandlers[defender.ability];
                if (abilityHandler && abilityHandler.onItemLost) {
                    let itemLogs = [];
                    abilityHandler.onItemLost(defender, lostItem, itemLogs);
                    itemLogs.forEach(txt => log(txt));
                }
            }
            if (typeof window !== 'undefined' && typeof window.playSFX === 'function') {
                window.playSFX('STAT_UP');
            }
            updateAllVisuals();
        }
    } else if (result.effectiveness === 0) {
        log(`<b>å¯¹å…¶æ²¡æœ‰æ•ˆæœ!</b>`);
        // High Jump Kick / Jump Kick æ‰“åˆ°å…ç–«å±æ€§æ—¶çš„åä¼¤
        if (move.name === 'High Jump Kick' || move.name === 'Jump Kick') {
            const crashDmg = Math.floor(attacker.maxHp / 2);
            attacker.takeDamage(crashDmg);
            log(`<b style='color:#e74c3c'>${attacker.cnName} å¤±å»äº†å¹³è¡¡ï¼Œæ‘”å€’å—åˆ°äº† ${crashDmg} ç‚¹ä¼¤å®³!</b>`);
        }
        result.pivot = false;
        return result;
    }
    // IV. è§¦å‘å‰¯ä½œç”¨
    // ã€ä¿®å¤ã€‘ä½¿ç”¨ actualDamageï¼ˆå®é™…é€ æˆçš„ä¼¤å®³ï¼‰è€Œä¸æ˜¯ result.damageï¼ˆç†è®ºä¼¤å®³ï¼‰
    // è¿™æ ·åä½œç”¨åŠ›è®¡ç®—æ‰ä¼šåŸºäºå®é™…ä¼¤å®³ï¼Œé¿å…é”è¡€ååä¼¤è¿‡é«˜çš„BUG
    const actualDamageForRecoil = result.displayDamage !== undefined ? result.displayDamage : result.damage;
    let pivotTriggered = false;
    if (defender.currHp > 0) {
        const fxResult = applyMoveSecondaryEffects(attacker, defender, move, actualDamageForRecoil, battle, spriteIdRef !== 'player-sprite');
        const fxLogs = Array.isArray(fxResult) ? fxResult : (fxResult.logs || []);
        pivotTriggered = fxResult.pivot || false;
        fxLogs.forEach(txt => log(`<span style="font-size:0.95em;color:#e67e22">${txt}</span>`));
        // === ã€æ‹è½ Knock Offã€‘å¤„ç† ===
        if (typeof MoveEffects !== 'undefined' && MoveEffects.applyKnockOff) {
            const knockOffResult = MoveEffects.applyKnockOff(attacker, defender, move);
            knockOffResult.logs.forEach(txt => log(`<span style="color:#8b5cf6">${txt}</span>`));
        }
        // === ã€æŸç¼šæ‹›å¼ã€‘å¤„ç† (Fire Spin, Magma Storm ç­‰) ===
        if (typeof MoveEffects !== 'undefined' && MoveEffects.applyTrappingMove) {
            const trapResult = MoveEffects.applyTrappingMove(attacker, defender, move);
            trapResult.logs.forEach(txt => log(`<span style="color:#dc2626">${txt}</span>`));
        }
        // === ã€é»‘è‰²ç›®å…‰/ç¼å½±ã€‘å¤„ç† ===
        if (typeof MoveEffects !== 'undefined' && MoveEffects.applyMeanLook) {
            const meanLookResult = MoveEffects.applyMeanLook(attacker, defender, move);
            meanLookResult.logs.forEach(txt => log(`<span style="color:#7c3aed">${txt}</span>`));
        }
    } else {
        // é˜²å¾¡æ–¹è¢«å‡»å€’
        const fxResult = applyMoveSecondaryEffects(attacker, defender, move, actualDamageForRecoil, battle, spriteIdRef !== 'player-sprite');
        const fxLogs = Array.isArray(fxResult) ? fxResult : (fxResult.logs || []);
        pivotTriggered = fxResult.pivot || false;
        const attackerOnlyLogs = fxLogs.filter(txt => 
            txt.includes(attacker.cnName) || 
            txt.includes('åä½œç”¨åŠ›') || 
            txt.includes('å¸å–')
        );
        attackerOnlyLogs.forEach(txt => log(`<span style="font-size:0.95em;color:#e67e22">${txt}</span>`));
        // === ã€åŒå‘½ Destiny Bondã€‘åˆ¤å®š ===
        // å¦‚æœè¢«å‡»å€’çš„å®å¯æ¢¦å¤„äºåŒå‘½çŠ¶æ€ï¼Œæ”»å‡»è€…ä¹Ÿä¼šè¢«å‡»å€’
        console.log(`[DESTINY BOND CHECK] defender: ${defender.cnName}, hasVolatile: ${!!defender.volatile}, destinyBond: ${defender.volatile?.destinyBond}, attackerAlive: ${attacker.isAlive()}`);
        if (defender.volatile && defender.volatile.destinyBond && attacker.isAlive()) {
            log(`<b style="color:#9b59b6">ğŸ’€ ${defender.cnName} æ‹‰ç€ ${attacker.cnName} åŒå½’äºå°½äº†ï¼</b>`);
            console.log(`[DESTINY BOND] è§¦å‘! ${attacker.cnName} å°†è¢«å‡»å€’`);
            attacker.takeDamage(attacker.currHp);
            updateAllVisuals();
            result.destinyBondTriggered = true;
            // ã€å®˜æ–¹è§„åˆ™ã€‘è®°å½•åŒå‘½ä½¿ç”¨è€…ï¼Œç”¨äºåŒæ€åˆ¤å®š
            // åŒå‘½å¯¼è‡´çš„åŒæ€ï¼Œä½¿ç”¨åŒå‘½è€…è¾“
            if (window.battle) {
                // defender æ˜¯ä½¿ç”¨åŒå‘½çš„ä¸€æ–¹
                const isDefenderPlayer = window.battle.playerParty.includes(defender);
                window.battle.destinyBondCauser = isDefenderPlayer ? 'player' : 'enemy';
                console.log(`[DESTINY BOND] è®°å½•åŒå‘½ä½¿ç”¨è€…: ${window.battle.destinyBondCauser}`);
            }
        }
        // === ã€æ€¨æ¨ Grudgeã€‘åˆ¤å®š ===
        // å¦‚æœè¢«å‡»å€’çš„å®å¯æ¢¦å¤„äºæ€¨æ¨çŠ¶æ€ï¼Œæ”»å‡»è€…ä½¿ç”¨çš„æ‹›å¼è¢«å°å°ï¼ˆæ— æ³•å†ä½¿ç”¨ï¼‰
        // ã€é€‚é…æ— PPç³»ç»Ÿã€‘æ”¹ä¸ºå°å°æ‹›å¼è€Œéæ¸…ç©ºPP
        if (defender.volatile && defender.volatile.grudge && move) {
            log(`<b style="color:#9b59b6">ğŸ‘» ${defender.cnName} çš„æ€¨æ¨å‘åŠ¨äº†ï¼${attacker.cnName} çš„ ${move.cn || move.name} è¢«æ€¨å¿µå°å°äº†ï¼</b>`);
            // å°å°æ”»å‡»è€…çš„å¯¹åº”æ‹›å¼
            if (!attacker.volatile) attacker.volatile = {};
            if (!attacker.volatile.grudgeSealed) attacker.volatile.grudgeSealed = [];
            attacker.volatile.grudgeSealed.push(move.name);
            console.log(`[GRUDGE] ${attacker.cnName} çš„ ${move.name} è¢«å°å°`);
            result.grudgeTriggered = true;
        }
    }
    // V. æ›´æ–°æ”»å‡»æ–¹è¡€æ¡
    updateAllVisuals();
    // VI. è¿”å›ç»“æœ
    result.pivot = pivotTriggered;
    return result;
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šæ—¥å¿—è¾“å‡º
 */
function log(msg) {
    if (typeof window !== 'undefined' && typeof window.log === 'function') {
        window.log(msg);
    } else {
        console.log(msg);
    }
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è§†è§‰
 */
function updateAllVisuals(forceSpriteAnim) {
    if (typeof window !== 'undefined' && typeof window.updateAllVisuals === 'function') {
        window.updateAllVisuals(forceSpriteAnim);
    }
}
// ============================================
// å¯¼å‡º
// ============================================
if (typeof window !== 'undefined') {
    window.applyDamage = applyDamage;
}
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { applyDamage };
}
]]></file>
        <file name="battle-effects.js"><![CDATA[/**
 * ===========================================
 * BATTLE-EFFECTS.JS - æ‹›å¼å‰¯ä½œç”¨å¤„ç†
 * ===========================================
 * 
 * ä» engine/battle-engine.js è¿ç§»
 * 
 * èŒè´£:
 * - èƒ½åŠ›å˜åŒ– (Boosts)
 * - åä¼¤ (Recoil)
 * - å¸è¡€ (Drain)
 * - çŠ¶æ€å¼‚å¸¸
 * - æ¥è§¦ç±»æ‹›å¼åé¦ˆ
 * - ç‰¹æ®ŠæŠ€èƒ½æ•ˆæœ
 * 
 * ä¾èµ–: moves-data.js, move-handlers.js, move-effects.js, ability-handlers.js
 */
/**
 * å¤„ç†æŠ€èƒ½å¸¦æ¥çš„å‰¯ä½œç”¨ï¼ˆèƒ½åŠ›å‡é™ã€åä¼¤ã€å¸è¡€ï¼‰
 * @param {Pokemon} user æ”»å‡»æ–¹
 * @param {Pokemon} target å—å‡»æ–¹
 * @param {object} move æŠ€èƒ½æ•°æ®
 * @param {number} damageDealt å®é™…é€ æˆçš„ä¼¤å®³ï¼ˆç”¨äºè®¡ç®—åä¼¤/å¸è¡€ï¼‰
 * @param {object} battle æˆ˜æ–—çŠ¶æ€
 * @param {boolean} isPlayer æ˜¯å¦ä¸ºç©å®¶
 * @returns {object} { logs: Array, pivot: boolean }
 */
export function applyMoveSecondaryEffects(user, target, move, damageDealt = 0, battle = null, isPlayer = false) {
    let logs = [];
    // è·å–å®Œæ•´æŠ€èƒ½æ•°æ®
    const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    // === ç­–ç•¥æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç‰¹æ®Šå¤„ç†å™¨ ===
    const handler = (typeof getMoveHandler === 'function') ? getMoveHandler(move.name) : null;
    console.log(`[MOVE HANDLER] Looking for handler: "${move.name}", found:`, handler ? 'YES' : 'NO', handler?.onUse ? '(has onUse)' : '');
    // === onUse é’©å­ (å˜åŒ–æŠ€/å¤©æ°”/åœºåœ°ç­‰ï¼Œä»¥åŠæŠ€èƒ½å‰ç½®æ£€æŸ¥å¦‚ Fake Out) ===
    // ã€é‡è¦ã€‘è“„åŠ›æŠ€èƒ½çš„ onUse å·²åœ¨ applyDamage ä¸­å¤„ç†ï¼Œæ­¤å¤„è·³è¿‡
    // æ£€æŸ¥ï¼šå¦‚æœ damageDealt > 0ï¼Œè¯´æ˜å·²ç»é€ æˆä¼¤å®³ï¼ŒonUse å·²ç»æ‰§è¡Œè¿‡
    const isChargeMove = handler && handler.isChargeMove;
    const shouldSkipOnUse = isChargeMove && damageDealt > 0;
    if (handler && handler.onUse && !shouldSkipOnUse) {
        console.log(`[MOVE HANDLER] Calling onUse for "${move.name}", battle:`, battle, 'isPlayer:', isPlayer);
        const result = handler.onUse(user, target, logs, battle, isPlayer);
        console.log(`[MOVE HANDLER] onUse returned, logs now:`, logs);
        if (result) {
            if (result.failed) {
                return { logs, pivot: false };
            }
            // ã€è“„åŠ›æŠ€èƒ½ã€‘æ­£åœ¨è“„åŠ›ä¸­ï¼Œè·³è¿‡ä¼¤å®³è®¡ç®—
            if (result.charging && result.skipDamage) {
                console.log(`[CHARGE MOVE] ${move.name} is charging, skipping damage`);
                return { logs, pivot: false, charging: true };
            }
            if (result.selfDestruct) {
                // è‡ªçˆ†ç±»æŠ€èƒ½å·²åœ¨ handler ä¸­å¤„ç† HP
            }
            // ã€æ¢¦è¯/æ¨¡ä»¿ç­‰ã€‘callMove: é€’å½’æ‰§è¡Œå¦ä¸€ä¸ªæ‹›å¼
            if (result.callMove) {
                const calledMove = result.callMove;
                const calledMoveName = calledMove.name || calledMove;
                const calledMoveId = calledMoveName.toLowerCase().replace(/[^a-z0-9]/g, '');
                const calledMoveData = (typeof MOVES !== 'undefined' && MOVES[calledMoveId]) ? MOVES[calledMoveId] : {};
                // æ„å»ºæ‹›å¼å¯¹è±¡
                const moveToExecute = {
                    name: calledMoveName,
                    cn: calledMove.cn || calledMoveData.cnName || calledMoveName,
                    type: calledMoveData.type || 'Normal',
                    power: calledMoveData.basePower || 0,
                    cat: calledMoveData.category === 'Physical' ? 'phys' : 
                         calledMoveData.category === 'Special' ? 'spec' : 'status',
                    accuracy: calledMoveData.accuracy || 100
                };
                logs.push(`<span style="color:#a78bfa">â†’ ä½¿ç”¨äº† ${moveToExecute.cn}!</span>`);
                // é€’å½’è°ƒç”¨ä¼¤å®³è®¡ç®—å’Œå‰¯ä½œç”¨
                if (typeof applyDamage === 'function' && moveToExecute.power > 0) {
                    const spriteId = isPlayer ? 'enemy-sprite' : 'player-sprite';
                    const dmgResult = applyDamage(user, target, moveToExecute, spriteId);
                    if (dmgResult && dmgResult.damage > 0) {
                        damageDealt = dmgResult.damage;
                    }
                } else {
                    // çŠ¶æ€æ‹›å¼ï¼šç›´æ¥è°ƒç”¨å‰¯ä½œç”¨å¤„ç†
                    const subResult = applyMoveSecondaryEffects(user, target, moveToExecute, 0, battle, isPlayer);
                    logs.push(...subResult.logs);
                    if (subResult.pivot) {
                        return { logs, pivot: true };
                    }
                }
                // è·³è¿‡åŸæ‹›å¼çš„åç»­å¤„ç†
                if (result.skipDamage) {
                    return { logs, pivot: false };
                }
            }
        }
    }
    // === onHit é’©å­ (å‘½ä¸­åæ•ˆæœ) ===
    let pivotTriggered = false;
    if (handler && handler.onHit) {
        const hitResult = handler.onHit(user, target, damageDealt, logs, battle);
        if (hitResult && hitResult.pivot) {
            pivotTriggered = true;
        }
    }
    // === åœºåœ°çŠ¶æ€æŠ€èƒ½å¤„ç† (sideCondition) ===
    if (fullMoveData.sideCondition && battle) {
        if (typeof MoveEffects !== 'undefined' && MoveEffects.applySideCondition) {
            const sideLogs = MoveEffects.applySideCondition(user, move, battle);
            logs.push(...sideLogs);
        }
    }
    // èƒ½åŠ›åç§°æ˜ å°„
    const statMap = {
        atk: "æ”»å‡»", def: "é˜²å¾¡", spa: "ç‰¹æ”»", spd: "ç‰¹é˜²", spe: "é€Ÿåº¦",
        accuracy: "å‘½ä¸­ç‡", evasion: "é—ªé¿ç‡"
    };
    // å˜åŒ–å¹…åº¦æ–‡æ¡ˆ
    const getChangeText = (val) => {
        if (Math.abs(val) >= 3) return "æå¤§å¹…";
        if (Math.abs(val) === 2) return "å¤§å¹…";
        return "";
    };
    // helperï¼šä¿®æ”¹æŒ‡å®šå¯¹è±¡çš„èƒ½åŠ›
    const changeStats = (subject, boostsObj) => {
        if (!boostsObj) return;
        for (const [stat, val] of Object.entries(boostsObj)) {
            if (typeof val !== 'number') continue;
            const diff = subject.applyBoost(stat, val);
            if (diff === 0) {
                const currentBoost = subject.boosts[stat] || 0;
                if (currentBoost >= 6) {
                    logs.push(`${subject.cnName} çš„${statMap[stat] || stat}å·²ç»æ— æ³•å†æå‡äº†!`);
                } else if (currentBoost <= -6) {
                    logs.push(`${subject.cnName} çš„${statMap[stat] || stat}å·²ç»æ— æ³•å†é™ä½äº†!`);
                } else {
                    logs.push(`${subject.cnName} çš„${statMap[stat] || stat}æ— æ³•æ”¹å˜!`);
                }
            } else {
                const changeText = getChangeText(diff);
                if (diff > 0) {
                    logs.push(`${subject.cnName} çš„${statMap[stat] || stat}${changeText}æå‡äº†!`);
                    if (typeof window !== 'undefined' && typeof window.playSFX === 'function') window.playSFX('STAT_UP');
                } else {
                    logs.push(`${subject.cnName} çš„${statMap[stat] || stat}${changeText}ä¸‹é™äº†!`);
                    if (typeof window !== 'undefined' && typeof window.playSFX === 'function') window.playSFX('STAT_DOWN');
                }
            }
        }
        // === ã€ç™½è‰²é¦™è‰ White Herbã€‘èƒ½åŠ›ä¸‹é™åç«‹å³æ£€æŸ¥ ===
        checkWhiteHerb(subject, logs);
    };
    // helperï¼šæ£€æŸ¥å¹¶è§¦å‘ç™½è‰²é¦™è‰
    const checkWhiteHerb = (pokemon, logs) => {
        if (!pokemon.item) return;
        const itemId = pokemon.item.toLowerCase().replace(/[^a-z]/g, '');
        if (itemId !== 'whiteherb' && pokemon.item !== 'ç™½è‰²é¦™è‰') return;
        let restored = false;
        const statNames = ['atk', 'def', 'spa', 'spd', 'spe', 'accuracy', 'evasion'];
        for (const stat of statNames) {
            if (pokemon.boosts[stat] < 0) {
                pokemon.boosts[stat] = 0;
                restored = true;
            }
        }
        if (restored) {
            // æ¶ˆè€—é“å…·
            const oldItem = pokemon.item;
            pokemon.item = null;
            logs.push(`<b style="color:#22c55e">ğŸƒ ${pokemon.cnName} çš„ç™½è‰²é¦™è‰å‘åŠ¨äº†ï¼èƒ½åŠ›ä¸‹é™è¢«è¿˜åŸäº†ï¼</b>`);
            console.log(`[WHITE HERB] ${pokemon.cnName} æ¶ˆè€—äº† ${oldItem}ï¼Œèƒ½åŠ›ä¸‹é™è¢«è¿˜åŸ`);
            if (typeof window !== 'undefined' && typeof window.playSFX === 'function') window.playSFX('ITEM_USE');
        }
    };
    // ========== 1. èƒ½åŠ›å˜åŒ– (Boosts) ==========
    const selfTargets = ['self', 'allySide', 'adjacentAlly', 'adjacentAllyOrSelf', 'allies'];
    const isTargetSelf = selfTargets.includes(fullMoveData.target);
    // 1.1 Status æ‹›å¼çš„ boosts
    if (fullMoveData.category === 'Status' && fullMoveData.boosts) {
        if (isTargetSelf) {
            changeStats(user, fullMoveData.boosts);
        } else {
            changeStats(target, fullMoveData.boosts);
        }
    }
    // 1.2 self.boostsï¼ˆå¯¹è‡ªå·±ç”Ÿæ•ˆçš„å‰¯ä½œç”¨ï¼‰
    if (fullMoveData.self && fullMoveData.self.boosts) {
        changeStats(user, fullMoveData.self.boosts);
    }
    // =========================================================
    // ã€Sheer Force å¼ºè¡Œã€‘ç‰¹æ€§æ£€æŸ¥
    // å¦‚æœæ‹›å¼æœ‰ secondary å‰¯ä½œç”¨ä¸”æ”»å‡»æ–¹æœ‰ Sheer Forceï¼Œè·³è¿‡å‰¯ä½œç”¨
    // å¨åŠ›æå‡å·²åœ¨ ability-handlers.js çš„ onBasePower ä¸­å¤„ç†
    // =========================================================
    const userAbilityId = (user.ability || '').toLowerCase().replace(/[^a-z]/g, '');
    const hasSheerForce = userAbilityId === 'sheerforce';
    const moveHasSecondary = fullMoveData.secondary || fullMoveData.secondaries;
    // Sheer Force æ¿€æ´»æ ‡è®°ï¼ˆç”¨äºç”Ÿå‘½å®ç åä¼¤å…ç–«ï¼‰
    const sheerForceActive = hasSheerForce && moveHasSecondary;
    // =========================================================
    // ã€Covert Cloakã€‘éšå¯†æ–—ç¯·æ£€æŸ¥ - å…ç–«æ‰€æœ‰æ‹›å¼è¿½åŠ æ•ˆæœ
    // =========================================================
    const targetItemId = (target.item || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const hasCovertCloak = targetItemId === 'covertcloak';
    // 1.3 Secondary Effectsï¼ˆå‡ ç‡è§¦å‘ï¼Œé€šå¸¸å¯¹æ•Œäººï¼‰
    // ã€Sheer Forceã€‘å¦‚æœç‰¹æ€§æ¿€æ´»ï¼Œè·³è¿‡æ‰€æœ‰ secondary å‰¯ä½œç”¨
    if (fullMoveData.secondary && !sheerForceActive) {
        const chance = fullMoveData.secondary.chance || 100;
        if (Math.random() * 100 < chance) {
            // ã€Covert Cloakã€‘å¯¹ç›®æ ‡çš„èƒ½åŠ›ä¸‹é™è¢«é˜»æ­¢
            if (fullMoveData.secondary.boosts) {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹ç›®æ ‡çš„è´Ÿé¢æ•ˆæœ
                const hasNegativeBoosts = Object.values(fullMoveData.secondary.boosts).some(v => v < 0);
                if (hasNegativeBoosts && hasCovertCloak) {
                    logs.push(`${target.cnName} çš„éšå¯†æ–—ç¯·é˜»æ­¢äº†èƒ½åŠ›ä¸‹é™!`);
                } else {
                    changeStats(target, fullMoveData.secondary.boosts);
                }
            }
            if (fullMoveData.secondary.self && fullMoveData.secondary.self.boosts) {
                changeStats(user, fullMoveData.secondary.self.boosts);
            }
            // çŠ¶æ€å¼‚å¸¸
            // ã€Covert Cloakã€‘éšå¯†æ–—ç¯·å…ç–«è¿½åŠ çŠ¶æ€å¼‚å¸¸
            if (fullMoveData.secondary.status) {
                if (hasCovertCloak) {
                    logs.push(`${target.cnName} çš„éšå¯†æ–—ç¯·é˜»æ­¢äº†çŠ¶æ€å¼‚å¸¸!`);
                } else {
                    const s = fullMoveData.secondary.status;
                    // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘æ£€æŸ¥çŠ¶æ€é˜»æ­¢
                    let statusPrevented = false;
                    if (typeof window !== 'undefined' && window.envOverlay && typeof window.envOverlay.isStatusPrevented === 'function') {
                        statusPrevented = window.envOverlay.isStatusPrevented(target, s);
                        if (statusPrevented) {
                            const statusName = (typeof window.envOverlay._getStatusName === 'function') ? window.envOverlay._getStatusName(s) : s;
                            logs.push(`<span style="color:#3b82f6">ç¯å¢ƒæ•ˆæœé˜»æ­¢äº†${statusName}çŠ¶æ€ï¼</span>`);
                            console.log(`[ENV OVERLAY] çŠ¶æ€é˜»æ­¢: ${s} (${statusName})`);
                        }
                    }
                    if (!statusPrevented && !target.status) {
                        if (typeof MoveEffects !== 'undefined' && MoveEffects.tryInflictStatus) {
                            const result = MoveEffects.tryInflictStatus(target, s, user, battle);
                            if (result.success) {
                                if (s === 'slp') {
                                    target.sleepTurns = Math.floor(Math.random() * 3) + 2;
                                }
                                logs.push(result.message);
                            }
                        } else {
                            target.status = s;
                            if (s === 'slp') {
                                target.sleepTurns = Math.floor(Math.random() * 3) + 2;
                            }
                            const statusMap = {
                                brn: "è¢«ç¼ä¼¤äº†!", psn: "ä¸­æ¯’äº†!", par: "éº»ç—¹äº†!",
                                tox: "ä¸­äº†å‰§æ¯’!", slp: "ç¡ç€äº†!", frz: "è¢«å†»ç»“äº†!"
                            };
                            const statusText = statusMap[s];
                            if (statusText) {
                                logs.push(`${target.cnName} ${statusText}`);
                            }
                        }
                    }
                }
            }
            // ç•ç¼©æ•ˆæœ
            // ã€Covert Cloakã€‘éšå¯†æ–—ç¯·å…ç–«ç•ç¼©ç­‰è¿½åŠ æ•ˆæœ
            if (fullMoveData.secondary.volatileStatus === 'flinch') {
                if (hasCovertCloak) {
                    logs.push(`${target.cnName} çš„éšå¯†æ–—ç¯·é˜»æ­¢äº†ç•ç¼©æ•ˆæœ!`);
                } else {
                    target.volatile = target.volatile || {};
                    target.volatile.flinch = true;
                    logs.push(`${target.cnName} ç•ç¼©äº†!`);
                }
            }
        }
    }
    // 1.3b Secondaries æ•°ç»„å¤„ç†ï¼ˆIce Fang, Fire Fang, Thunder Fang ç­‰å¤šå‰¯ä½œç”¨æ‹›å¼ï¼‰
    // ã€Sheer Forceã€‘å¦‚æœç‰¹æ€§æ¿€æ´»ï¼Œè·³è¿‡æ‰€æœ‰ secondaries å‰¯ä½œç”¨
    if (fullMoveData.secondaries && Array.isArray(fullMoveData.secondaries) && !sheerForceActive) {
        for (const sec of fullMoveData.secondaries) {
            const chance = sec.chance || 100;
            if (Math.random() * 100 < chance) {
                // çŠ¶æ€å¼‚å¸¸
                // ã€Covert Cloakã€‘éšå¯†æ–—ç¯·å…ç–«è¿½åŠ çŠ¶æ€å¼‚å¸¸
                if (sec.status && !target.status) {
                    if (hasCovertCloak) {
                        logs.push(`${target.cnName} çš„éšå¯†æ–—ç¯·é˜»æ­¢äº†çŠ¶æ€å¼‚å¸¸!`);
                    } else {
                        if (typeof MoveEffects !== 'undefined' && MoveEffects.tryInflictStatus) {
                            const result = MoveEffects.tryInflictStatus(target, sec.status, user, battle);
                            if (result.success) {
                                if (sec.status === 'slp') {
                                    target.sleepTurns = Math.floor(Math.random() * 3) + 2;
                                }
                                logs.push(result.message);
                            }
                        } else {
                            target.status = sec.status;
                            if (sec.status === 'slp') {
                                target.sleepTurns = Math.floor(Math.random() * 3) + 2;
                            }
                            const statusMap = {
                                brn: "è¢«ç¼ä¼¤äº†!", psn: "ä¸­æ¯’äº†!", par: "éº»ç—¹äº†!",
                                tox: "ä¸­äº†å‰§æ¯’!", slp: "ç¡ç€äº†!", frz: "è¢«å†»ç»“äº†!"
                            };
                            const statusText = statusMap[sec.status];
                            if (statusText) {
                                logs.push(`${target.cnName} ${statusText}`);
                            }
                        }
                    }
                }
                // ç•ç¼©æ•ˆæœ
                // ã€Covert Cloakã€‘éšå¯†æ–—ç¯·å…ç–«ç•ç¼©ç­‰è¿½åŠ æ•ˆæœ
                if (sec.volatileStatus === 'flinch') {
                    if (hasCovertCloak) {
                        logs.push(`${target.cnName} çš„éšå¯†æ–—ç¯·é˜»æ­¢äº†ç•ç¼©æ•ˆæœ!`);
                    } else {
                        target.volatile = target.volatile || {};
                        target.volatile.flinch = true;
                        logs.push(`${target.cnName} ç•ç¼©äº†!`);
                    }
                }
                // èƒ½åŠ›å˜åŒ–
                // ã€Covert Cloakã€‘éšå¯†æ–—ç¯·å…ç–«è¿½åŠ èƒ½åŠ›ä¸‹é™
                if (sec.boosts) {
                    const hasNegativeBoosts = Object.values(sec.boosts).some(v => v < 0);
                    if (hasNegativeBoosts && hasCovertCloak) {
                        logs.push(`${target.cnName} çš„éšå¯†æ–—ç¯·é˜»æ­¢äº†èƒ½åŠ›ä¸‹é™!`);
                    } else {
                        changeStats(target, sec.boosts);
                    }
                }
            }
        }
    }
    // =========================================================
    // ã€Stench æ¶è‡­ã€‘ç‰¹æ€§ - æ”»å‡»æ‹›å¼ 10% ç•ç¼©
    // =========================================================
    if (damageDealt > 0 && userAbilityId === 'stench' && !hasCovertCloak) {
        const targetAbilityId = (target.ability || '').toLowerCase().replace(/[^a-z]/g, '');
        const immuneToFlinch = ['innerfocus', 'shielddust'].includes(targetAbilityId);
        if (!immuneToFlinch) {
            const flinchChance = 0.10;
            if (Math.random() < flinchChance) {
                target.volatile = target.volatile || {};
                target.volatile.flinch = true;
                logs.push(`${user.cnName} çš„æ¶è‡­è®© ${target.cnName} ç•ç¼©äº†ï¼`);
            }
        }
    }
    // 1.4 Status æ‹›å¼ç›´æ¥æ–½åŠ çŠ¶æ€
    if (fullMoveData.status) {
        const s = fullMoveData.status;
        // ã€BUGä¿®å¤ã€‘ç²‰æœ«ç±»æ‹›å¼å…ç–«æ£€æŸ¥ï¼ˆè‰ç³»/é˜²å°˜æŠ¤ç›®é•œ/é˜²å°˜ç‰¹æ€§ï¼‰
        const powderMoves = ['spore', 'sleeppowder', 'poisonpowder', 'stunspore', 'ragepowder', 'cottonspore', 'powder'];
        if (powderMoves.includes(moveId)) {
            // è‰ç³»å…ç–«
            if (target.types && target.types.includes('Grass')) {
                logs.push(`${target.cnName} çš„è‰å±æ€§å…ç–«äº†ç²‰æœ«ç±»æ‹›å¼!`);
                return { logs, pivot: pivotTriggered };
            }
            // é˜²å°˜æŠ¤ç›®é•œå…ç–«
            const targetItemId = (target.item || '').toLowerCase().replace(/[^a-z]/g, '');
            if (targetItemId === 'safetygoggles') {
                logs.push(`${target.cnName} çš„é˜²å°˜æŠ¤ç›®é•œå…ç–«äº†ç²‰æœ«ç±»æ‹›å¼!`);
                return { logs, pivot: pivotTriggered };
            }
            // é˜²å°˜ç‰¹æ€§å…ç–«
            const targetAbilityId = (target.ability || '').toLowerCase().replace(/[^a-z]/g, '');
            if (targetAbilityId === 'overcoat') {
                logs.push(`${target.cnName} çš„é˜²å°˜ç‰¹æ€§å…ç–«äº†ç²‰æœ«ç±»æ‹›å¼!`);
                return { logs, pivot: pivotTriggered };
            }
        }
        if (!target.status) {
            if (typeof MoveEffects !== 'undefined' && MoveEffects.tryInflictStatus) {
                const result = MoveEffects.tryInflictStatus(target, s, user, battle);
                if (result.success) {
                    if (s === 'slp') {
                        target.sleepTurns = Math.floor(Math.random() * 3) + 2;
                    }
                    logs.push(result.message);
                } else {
                    logs.push(result.message);
                }
            } else {
                target.status = s;
                if (s === 'slp') {
                    target.sleepTurns = Math.floor(Math.random() * 3) + 2;
                }
                const statusMap = {
                    brn: "è¢«ç¼ä¼¤äº†!", psn: "ä¸­æ¯’äº†!", par: "éº»ç—¹äº†!",
                    tox: "ä¸­äº†å‰§æ¯’!", slp: "ç¡ç€äº†!", frz: "è¢«å†»ç»“äº†!"
                };
                const statusText = statusMap[s];
                if (statusText) {
                    logs.push(`${target.cnName} ${statusText}`);
                }
            }
        }
    }
    // === 1.5 Protect/Detect å®ˆä½ç±»æŠ€èƒ½ ===
    const isProtectMove = fullMoveData.stallingMove || 
        (fullMoveData.volatileStatus && ['protect', 'banefulbunker', 'spikyshield', 'kingsshield', 'obstruct', 'silktrap', 'burningbulwark'].includes(fullMoveData.volatileStatus));
    if (isProtectMove) {
        user.volatile = user.volatile || {};
        user.volatile.protect = true;
        logs.push(`${user.cnName} å®ˆä½äº†è‡ªå·±!`);
    }
    // ========== 2. å¸è¡€ (Drain) - å…ˆäºåä¼¤ç»“ç®— ==========
    // ã€Gen 9 æ­£ç¡®é¡ºåºã€‘å¸è¡€å›å¤åº”åœ¨ç”Ÿå‘½å®ç åä¼¤ä¹‹å‰ç»“ç®—
    if (fullMoveData.drain && damageDealt > 0) {
        const [num, den] = fullMoveData.drain;
        let baseHeal = Math.max(1, Math.floor(damageDealt * num / den));
        // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘å¸è¡€æ•ˆç‡ä¿®æ­£
        if (typeof window !== 'undefined' && window.envOverlay && typeof window.envOverlay.getDrainMod === 'function') {
            const drainMod = window.envOverlay.getDrainMod(user, move);
            if (drainMod !== 1) {
                baseHeal = Math.floor(baseHeal * drainMod);
                console.log(`[ENV OVERLAY] å¸è¡€æ•ˆç‡ä¿®æ­£: x${drainMod}`);
            }
        }
        const maxHeal = user.maxHp - user.currHp;
        if (maxHeal > 0) {
            const actualHeal = (typeof user.heal === 'function') ? user.heal(baseHeal) : Math.min(baseHeal, maxHeal);
            if (actualHeal > 0) {
                logs.push(`${user.cnName} å¸å–äº†å¯¹æ‰‹çš„ä½“åŠ›!`);
            }
        }
    } else if (damageDealt > 0) {
        const drainPatches = (typeof DRAIN_MOVES !== 'undefined') ? DRAIN_MOVES : {};
        if (drainPatches[move.name]) {
            const [num, den] = drainPatches[move.name];
            let baseHeal = Math.max(1, Math.floor(damageDealt * num / den));
            // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘å¸è¡€æ•ˆç‡ä¿®æ­£
            if (typeof window !== 'undefined' && window.envOverlay && typeof window.envOverlay.getDrainMod === 'function') {
                const drainMod = window.envOverlay.getDrainMod(user, move);
                if (drainMod !== 1) {
                    baseHeal = Math.floor(baseHeal * drainMod);
                }
            }
            const maxHeal = user.maxHp - user.currHp;
            if (maxHeal > 0) {
                const actualHeal = (typeof user.heal === 'function') ? user.heal(baseHeal) : Math.min(baseHeal, maxHeal);
                if (actualHeal > 0) {
                    logs.push(`${user.cnName} å¸å–äº†å¯¹æ‰‹çš„ä½“åŠ›!`);
                }
            }
        }
    }
    // ========== 3. åä¼¤ (Recoil) - åœ¨å¸è¡€ä¹‹åç»“ç®— ==========
    // ã€Rock Headã€‘åªå…ç–«æ‹›å¼åä¼¤ï¼Œä¸å…ç–« Life Orb
    const noRecoilAbility = (typeof AbilityHandlers !== 'undefined' && user.ability && AbilityHandlers[user.ability]) 
        ? AbilityHandlers[user.ability].noRecoil
        : false;
    // ã€Magic Guardã€‘å…ç–«æ‰€æœ‰é—´æ¥ä¼¤å®³ï¼ˆåŒ…æ‹¬ Life Orbï¼‰
    const noIndirectDamage = (typeof AbilityHandlers !== 'undefined' && user.ability && AbilityHandlers[user.ability]) 
        ? AbilityHandlers[user.ability].noIndirectDamage
        : false;
    // æ‹›å¼åä¼¤ï¼šRock Head å’Œ Magic Guard éƒ½èƒ½å…ç–«
    if (!noRecoilAbility && !noIndirectDamage) {
        if (fullMoveData.recoil && damageDealt > 0) {
            const [num, den] = fullMoveData.recoil;
            let recoilDmg = Math.max(1, Math.floor(damageDealt * num / den));
            // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘åä¼¤ä¿®æ­£
            if (typeof window !== 'undefined' && window.envOverlay && typeof window.envOverlay.getRecoilMod === 'function') {
                const recoilMod = window.envOverlay.getRecoilMod(user, move);
                if (recoilMod !== 1) {
                    recoilDmg = Math.max(1, Math.floor(recoilDmg * recoilMod));
                    console.log(`[ENV OVERLAY] åä¼¤ä¿®æ­£: x${recoilMod}`);
                }
            }
            user.takeDamage(recoilDmg);
            logs.push(`${user.cnName} å—åˆ°äº† ${recoilDmg} ç‚¹åä½œç”¨åŠ›ä¼¤å®³!`);
        } else if (damageDealt > 0) {
            const recoilPatches = (typeof RECOIL_MOVES !== 'undefined') ? RECOIL_MOVES : {};
            if (recoilPatches[move.name]) {
                const [num, den] = recoilPatches[move.name];
                const recoilDmg = Math.max(1, Math.floor(damageDealt * num / den));
                user.takeDamage(recoilDmg);
                logs.push(`${user.cnName} å—åˆ°äº† ${recoilDmg} ç‚¹åä½œç”¨åŠ›ä¼¤å®³!`);
            }
        }
    }
    // ç”Ÿå‘½å®ç åä¼¤ - ç‹¬ç«‹äºæ‹›å¼åä¼¤ç»“ç®—
    // ã€Magic Guardã€‘å…ç–«ç”Ÿå‘½å®ç åä¼¤
    // ã€Sheer Forceã€‘æ¿€æ´»æ—¶å…ç–«ç”Ÿå‘½å®ç åä¼¤
    // ã€Rock Headã€‘ä¸èƒ½å…ç–«ç”Ÿå‘½å®ç åä¼¤ï¼
    if (!noIndirectDamage) {
        const userItem = (user.item || '').toLowerCase().replace(/[^a-z]/g, '');
        if (userItem === 'lifeorb' && damageDealt > 0) {
            if (!sheerForceActive) {
                const lifeOrbRecoil = Math.max(1, Math.floor(user.maxHp * 0.1));
                user.takeDamage(lifeOrbRecoil);
                logs.push(`${user.cnName} å—åˆ°äº†ç”Ÿå‘½å®ç çš„åå™¬!`);
            }
        }
    }
    // ========== 4. ç‰¹æ®ŠæŠ€èƒ½æ•ˆæœ ==========
    // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘æ£€æŸ¥ç¯å¢ƒçŠ¶æ€æ–½åŠ  (åŸºäºæŠ€èƒ½ç±»å‹)
    // æ³¨æ„ï¼šéœ€è¦ä¼ å…¥å®Œæ•´çš„æŠ€èƒ½æ•°æ®ï¼ˆåŒ…å« typeï¼‰ï¼Œç”¨äº MoveType:X è§„åˆ™åŒ¹é…
    if (damageDealt > 0 && !target.status && typeof window !== 'undefined' && window.envOverlay && typeof window.envOverlay.tryInflictStatus === 'function') {
        const moveWithType = { ...move, type: move.type || fullMoveData.type || 'Normal' };
        const statusResult = window.envOverlay.tryInflictStatus(target, moveWithType);
        if (statusResult && statusResult.applied) {
            target.status = statusResult.status;
            target.statusTurns = 0;
            logs.push(`<span style="color:#e74c3c">${statusResult.log}</span>`);
            console.log(`[ENV OVERLAY] ç¯å¢ƒçŠ¶æ€æ–½åŠ : ${statusResult.status} (æŠ€èƒ½ç±»å‹: ${moveWithType.type})`);
        }
    }
    // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘æ£€æŸ¥ç¯å¢ƒåä¼¤ (å¯¹æ”»å‡»æ–¹é€ æˆæ¦‚ç‡åä¼¤)
    if (damageDealt > 0 && user.isAlive() && typeof window !== 'undefined' && window.envOverlay && typeof window.envOverlay.tryApplyEnvRecoil === 'function') {
        const moveWithData = { ...move, type: move.type || fullMoveData.type || 'Normal', flags: move.flags || fullMoveData.flags || {} };
        const recoilResult = window.envOverlay.tryApplyEnvRecoil(user, moveWithData);
        if (recoilResult && recoilResult.applied) {
            user.takeDamage(recoilResult.damage);
            logs.push(`<span style="color:#a855f7">ğŸŒ ${recoilResult.log}</span>`);
        }
    }
    // å¯„ç”Ÿç§å­
    if (move.name === 'Leech Seed') {
        if (!target.types.includes('Grass')) {
            target.volatile = target.volatile || {};
            target.volatile['leechseed'] = true;
            logs.push(`å¯„ç”Ÿç§å­ç§åœ¨äº† ${target.cnName} èº«ä¸Š!`);
        } else {
            logs.push(`å¯¹è‰ç³»å®å¯æ¢¦æ²¡æœ‰æ•ˆæœ!`);
        }
    }
    // å“ˆæ¬ 
    if (move.name === 'Yawn') {
        if (!target.status && !(target.volatile && target.volatile['yawn'])) {
            target.volatile = target.volatile || {};
            target.volatile['yawn'] = 2;
            logs.push(`${target.cnName} æ‰“äº†ä¸ªå¤§å¤§çš„å“ˆæ¬ ...`);
        }
    }
    // è¯…å’’ (é¬¼ç³») - ã€å·²ç§»è‡³ move-handlers.js ç»Ÿä¸€å¤„ç†ï¼Œæ­¤å¤„åˆ é™¤é¿å…é‡å¤æ‰£è¡€ã€‘
    // if (move.name === 'Curse' && user.types.includes('Ghost')) { ... }
    // æŸç¼šç±»æŠ€èƒ½
    if (fullMoveData.volatileStatus === 'partiallytrapped') {
        target.volatile = target.volatile || {};
        target.volatile['partiallytrapped'] = true;
        logs.push(`${target.cnName} è¢«å›°ä½äº†!`);
    }
    // ========== 5. è‡ªæˆ‘ç‰ºç‰²æŠ€èƒ½ ==========
    if (fullMoveData.selfdestruct) {
        const shouldFaint = fullMoveData.selfdestruct === 'always' || 
                           (fullMoveData.selfdestruct === 'ifHit' && damageDealt >= 0);
        if (shouldFaint) {
            user.currHp = 0;
            logs.push(`${user.cnName} å€’ä¸‹äº†!`);
            console.log(`[SELFDESTRUCT] ${user.cnName} used ${move.name} with selfdestruct: ${fullMoveData.selfdestruct}`);
        }
    }
    // ========== 6. æ¥è§¦ç±»æ‹›å¼åé¦ˆæ•ˆæœ ==========
    const isContact = fullMoveData.flags && fullMoveData.flags.contact;
    // userAbilityId å·²åœ¨ä¸Šæ–¹å®šä¹‰ï¼ˆSheer Force æ£€æŸ¥å¤„ï¼‰
    let hitCount = 1;
    if (fullMoveData.multihit) {
        if (Array.isArray(fullMoveData.multihit)) {
            const [min, max] = fullMoveData.multihit;
            if (userAbilityId === 'skilllink') {
                hitCount = max;
            } else {
                hitCount = Math.floor(Math.random() * (max - min + 1)) + min;
            }
        } else {
            hitCount = fullMoveData.multihit;
        }
    }
    if (isContact && damageDealt > 0 && target.isAlive() && typeof AbilityHandlers !== 'undefined') {
        const defenderAbility = target.ability;
        const ah = defenderAbility ? AbilityHandlers[defenderAbility] : null;
        for (let hit = 0; hit < hitCount; hit++) {
            if (!user.isAlive() || !target.isAlive()) break;
            // æ¥è§¦åä¼¤ç‰¹æ€§
            if (ah && ah.onContactDamage && user.isAlive()) {
                const result = ah.onContactDamage(user, target);
                if (result && result.damage > 0) {
                    user.takeDamage(result.damage);
                    if (hit === 0) logs.push(result.message);
                }
            }
            // æ¥è§¦çŠ¶æ€ç‰¹æ€§
            if (ah && ah.onContactStatus && user.isAlive() && !user.status) {
                const result = ah.onContactStatus(user, target);
                if (result && result.status) {
                    const statusResult = (typeof MoveEffects !== 'undefined' && MoveEffects.tryInflictStatus) 
                        ? MoveEffects.tryInflictStatus(user, result.status)
                        : { success: true };
                    if (statusResult.success) {
                        user.status = result.status;
                        logs.push(result.message);
                    }
                }
            }
            // å‡¸å‡¸å¤´ç›”
            // ã€é“å…·ç»Ÿä¸€ã€‘ä½¿ç”¨è§„èŒƒåŒ– ID æ¯”è¾ƒ
            const targetItemId = (target.item || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            if (targetItemId === 'rockyhelmet' && user.isAlive()) {
                const helmetDmg = Math.floor(user.maxHp / 6);
                user.takeDamage(helmetDmg);
                if (hit === 0) logs.push(`${user.cnName} è¢«å‡¸å‡¸å¤´ç›”ä¼¤å®³äº†ï¼`);
            }
        }
        if (!user.isAlive()) {
            logs.push(`${user.cnName} è¢«åä¼¤å‡»å€’äº†ï¼`);
        }
    }
    // ========== 7. ç¢è£‚é“ ç”²ç­‰è¢«æ”»å‡»è§¦å‘ç‰¹æ€§ ==========
    if (damageDealt > 0 && target.isAlive() && typeof AbilityHandlers !== 'undefined') {
        const ah = target.ability ? AbilityHandlers[target.ability] : null;
        const moveCategory = fullMoveData.category || (move.cat === 'phys' ? 'Physical' : (move.cat === 'spec' ? 'Special' : 'Status'));
        const isPhysical = move.cat === 'phys' || moveCategory === 'Physical';
        if (ah && ah.onPhysicalHit && isPhysical) {
            ah.onPhysicalHit(user, target, logs);
        }
    }
    // ========== 8. onAfterMove é’©å­ (æ‹›å¼æ‰§è¡Œåæ•ˆæœ) ==========
    // ã€Gigaton Hammer / Glaive Rush ç­‰ã€‘æ‹›å¼æ‰§è¡Œåçš„å‰¯ä½œç”¨
    if (handler && handler.onAfterMove) {
        handler.onAfterMove(user, target, move, logs, battle);
    }
    // ã€Gigaton Hammerã€‘æ›´æ–° lastMoveUsedï¼ˆç”¨äºä¸èƒ½è¿å‘çš„åˆ¤å®šï¼‰
    // å¦‚æœä½¿ç”¨çš„ä¸æ˜¯å·¨åŠ›é”¤ï¼Œæ¸…é™¤ä¹‹å‰çš„è®°å½•
    if (move.name !== 'Gigaton Hammer' && user.lastMoveUsed === 'Gigaton Hammer') {
        user.lastMoveUsed = null;
    }
    // è¿”å›æ—¥å¿—å’Œ pivot çŠ¶æ€
    return { logs, pivot: pivotTriggered };
}
// ============================================
// å¯¼å‡ºåˆ°å…¨å±€
// ============================================
if (typeof window !== 'undefined') {
    window.applyMoveSecondaryEffects = applyMoveSecondaryEffects;
}
]]></file>
        <file name="battle-switch.js"><![CDATA[/**
 * ===========================================
 * BATTLE-SWITCH.JS - æ¢äººç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - Pivot æ¢äºº (U-turn/Volt Switch)
 * - å¼ºåˆ¶æ¢äºº
 * - å€’ä¸‹å¤„ç†
 * - å…¥åœºç‰¹æ€§è§¦å‘
 */
// ============================================
// è¾…åŠ©å‡½æ•°
// ============================================
/**
 * æ£€æŸ¥æ˜¯å¦æœ‰å¯æ¢å…¥çš„å­˜æ´»å®å¯æ¢¦
 */
export function hasAliveSwitch(party, currentIndex) {
    return party.some((pm, idx) => 
        idx !== currentIndex && pm && pm.isAlive && pm.isAlive() && pm.currHp > 0
    );
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šç­‰å¾…
 */
function wait(ms) { 
    return new Promise(r => setTimeout(r, ms)); 
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šæ—¥å¿—è¾“å‡º
 */
function log(msg) {
    if (typeof window !== 'undefined' && typeof window.log === 'function') {
        window.log(msg);
    } else {
        console.log(msg);
    }
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è§†è§‰
 */
function updateAllVisuals(forceSpriteAnim) {
    if (typeof window !== 'undefined' && typeof window.updateAllVisuals === 'function') {
        window.updateAllVisuals(forceSpriteAnim);
    }
}
// ============================================
// Pivot æ¢äºº
// ============================================
/**
 * å¤„ç†ç©å®¶ Pivot æ¢äººï¼ˆU-turn/Volt Switch ç­‰ï¼‰
 * ä½¿ç”¨ Promise ç­‰å¾…ç©å®¶é€‰æ‹©
 */
export function handlePlayerPivot() {
    const battle = window.battle;
    console.log('[handlePlayerPivot] Starting pivot switch');
    log(`<span style="color:#3498db">é€‰æ‹©è¦æ¢å…¥çš„å®å¯æ¢¦!</span>`);
    battle.phase = 'pivot_switch';
    battle.pivotSide = 'player';
    // æ˜¾ç¤ºæ¢äººèœå•ï¼ˆä¸å¯å–æ¶ˆï¼‰
    if (typeof window.renderSwitchMenu === 'function') {
        window.renderSwitchMenu(false);
    }
    console.log('[handlePlayerPivot] Waiting for player selection...');
    return new Promise((resolve) => {
        battle.pivotResolve = resolve;
    });
}
/**
 * å¤„ç†æ•Œæ–¹ Pivot æ¢äººï¼ˆAI è‡ªåŠ¨é€‰æ‹©ï¼‰
 */
export async function handleEnemyPivot(passBoosts = false) {
    const battle = window.battle;
    const currentE = battle.getEnemy();
    const p = battle.getPlayer();
    // ã€Baton Passã€‘ä¿å­˜å½“å‰èƒ½åŠ›å˜åŒ–ï¼Œç”¨äºä¼ é€’ç»™æ¢å…¥çš„å®å¯æ¢¦
    const savedBoosts = passBoosts && currentE.boosts ? { ...currentE.boosts } : null;
    if (savedBoosts) {
        console.log(`[BATON PASS] ${currentE.cnName} å‡†å¤‡ä¼ é€’èƒ½åŠ›å˜åŒ–:`, savedBoosts);
    }
    // AI é€‰æ‹©æœ€ä½³æ¢å…¥ç›®æ ‡
    let bestIndex = -1;
    let bestScore = -Infinity;
    for (let i = 0; i < battle.enemyParty.length; i++) {
        const ally = battle.enemyParty[i];
        if (!ally || i === battle.enemyActive) continue;
        if (!ally.isAlive || !ally.isAlive() || ally.currHp <= 0) continue;
        let score = 0;
        // æ£€æŸ¥ç©å®¶æœ€å¼ºæŠ€èƒ½å¯¹è¯¥å®å¯æ¢¦çš„æ•ˆæœ
        for (const pMove of p.moves) {
            const moveType = pMove.type || 'Normal';
            const eff = window.getTypeEffectiveness ? 
                window.getTypeEffectiveness(moveType, ally.types || ['Normal']) : 1;
            if (eff === 0) score += 500;
            else if (eff <= 0.5) score += 200;
            else if (eff >= 2) score -= 100;
        }
        // æ£€æŸ¥è¯¥å®å¯æ¢¦å¯¹ç©å®¶çš„å…‹åˆ¶
        for (const aMove of ally.moves || []) {
            const moveType = aMove.type || 'Normal';
            const eff = window.getTypeEffectiveness ? 
                window.getTypeEffectiveness(moveType, p.types || ['Normal']) : 1;
            if (eff >= 2) score += 150;
        }
        if (score > bestScore) {
            bestScore = score;
            bestIndex = i;
        }
    }
    // å¦‚æœæ‰¾åˆ°åˆé€‚ç›®æ ‡ï¼Œæ‰§è¡Œæ¢äºº
    if (bestIndex !== -1) {
        log(`<span style="color:#ef4444">æ•Œæ–¹æ”¶å›äº† ${currentE.cnName}ï¼</span>`);
        // æ¸…é™¤ Choice é”æ‹›çŠ¶æ€
        if (currentE.choiceLockedMove) {
            console.log(`[CHOICE] ${currentE.name} æ¢ä¸‹ï¼Œè§£é™¤ ${currentE.choiceLockedMove} é”å®š`);
            delete currentE.choiceLockedMove;
        }
        // ã€å“ˆæ¬ ä¿®å¤ã€‘æ¢äººæ—¶æ¸…é™¤å“ˆæ¬ çŠ¶æ€ï¼ˆå®˜æ–¹æœºåˆ¶ï¼šæ¢äººå¯ä»¥èº²é¿å“ˆæ¬ ï¼‰
        if (currentE.volatile && currentE.volatile.yawn) {
            console.log(`[YAWN] ${currentE.cnName} æ¢ä¸‹ï¼Œæ¸…é™¤å“ˆæ¬ çŠ¶æ€`);
            delete currentE.volatile.yawn;
        }
        // å¦‚æœæ¢ä¸‹çš„å®å¯æ¢¦å¤„äºæå·¨åŒ–çŠ¶æ€ï¼Œæ¢å¤æ‹›å¼
        if (currentE.isDynamaxed && typeof window.applyDynamaxState === 'function') {
            console.log(`[SWITCH] Enemy ${currentE.name} was Dynamaxed, restoring moves`);
            window.applyDynamaxState(currentE, false);
        }
        // é‡ç½®æ¢å‡ºå®å¯æ¢¦çš„èƒ½åŠ›ç­‰çº§ï¼ˆæ— è®ºæ˜¯å¦æ¥æ£’ï¼Œæ¢å‡ºè€…éƒ½è¦é‡ç½®ï¼‰
        if (typeof currentE.resetBoosts === 'function') {
            currentE.resetBoosts();
        }
        // ã€ç‰¹æ€§é’©å­ã€‘è§¦å‘é€€åœºç‰¹æ€§ (Regenerator, Natural Cure, Zero to Hero ç­‰)
        if (typeof AbilityHandlers !== 'undefined' && currentE.ability) {
            const handler = AbilityHandlers[currentE.ability];
            if (handler && handler.onSwitchOut) {
                handler.onSwitchOut(currentE);
                console.log(`[ABILITY] ${currentE.cnName} è§¦å‘é€€åœºç‰¹æ€§: ${currentE.ability}`);
            }
        }
        battle.enemyActive = bestIndex;
        const newE = battle.getEnemy();
        // ã€Baton Passã€‘å°†ä¿å­˜çš„èƒ½åŠ›å˜åŒ–ä¼ é€’ç»™æ¢å…¥çš„å®å¯æ¢¦
        if (savedBoosts && newE.boosts) {
            Object.keys(savedBoosts).forEach(stat => {
                newE.boosts[stat] = (newE.boosts[stat] || 0) + savedBoosts[stat];
                // é™åˆ¶åœ¨ -6 åˆ° +6 ä¹‹é—´
                newE.boosts[stat] = Math.max(-6, Math.min(6, newE.boosts[stat]));
            });
            console.log(`[BATON PASS] ${newE.cnName} ç»§æ‰¿äº†èƒ½åŠ›å˜åŒ–:`, newE.boosts);
            log(`<span style="color:#9b59b6">${newE.cnName} ç»§æ‰¿äº†èƒ½åŠ›å˜åŒ–!</span>`);
        }
        log(`<span style="color:#ef4444">æ•Œæ–¹æ´¾å‡ºäº† ${newE.cnName}ï¼</span>`);
        // ã€æ ‡è®°æ¢äººã€‘ç”¨äºé‡å¤ç²¾çµå›¾ä¿®å¤
        if (typeof window.markEnemySwitch === 'function') {
            window.markEnemySwitch();
        }
        updateAllVisuals('enemy');
        await wait(500);
        triggerEntryAbilities(newE, p);
        // ç»“ç®—æ•Œæ–¹åœºåœ°é’‰å­ä¼¤å®³
        if (typeof MoveEffects !== 'undefined' && MoveEffects.applyEntryHazards) {
            const hazardLogs = MoveEffects.applyEntryHazards(newE, false, battle);
            hazardLogs.forEach(msg => log(msg));
            if (hazardLogs.length > 0) updateAllVisuals();
        }
    }
}
// ============================================
// å€’ä¸‹å¤„ç†
// ============================================
/**
 * å¤„ç†æ•Œæ–¹å€’ä¸‹
 */
export async function handleEnemyFainted(e) {
    if (typeof window.playSFX === 'function') window.playSFX('FAINT');
    const battle = window.battle;
    // ã€Gen 9 Last Respectsã€‘å¢åŠ æ•Œæ–¹æ¿’æ­»è®¡æ•°ï¼ˆç”¨äºæœ€åç¤¼è°¢å¨åŠ›è®¡ç®—ï¼‰
    battle.enemyFaintCount = (battle.enemyFaintCount || 0) + 1;
    console.log(`[Last Respects Counter] æ•Œæ–¹æ¿’æ­»æ¬¡æ•°: ${battle.enemyFaintCount}`);
    // ã€Gen 9 Rage Fistã€‘æ¿’æ­»æ—¶æ¸…é›¶è¢«æ”»å‡»è®¡æ•°
    e.timesAttacked = 0;
    // å¦‚æœæ•Œæ–¹å¤„äºæå·¨åŒ–çŠ¶æ€ï¼Œå…ˆæ¸…ç†æå·¨åŒ–è§†è§‰æ•ˆæœ
    if (e.isDynamaxed) {
        if (e.originalName) {
            e.name = e.originalName;
            delete e.originalName;
        }
        if (typeof window.endDynamaxAnimation === 'function') {
            await window.endDynamaxAnimation(e, false);
        }
        e.isDynamaxed = false;
        delete e.preDynamaxMaxHp;
        delete e.preDynamaxCurrHp;
        if (typeof window.applyDynamaxState === 'function') {
            window.applyDynamaxState(e, false);
        }
    }
    log(`æ•Œæ–¹çš„ ${e.cnName} å€’ä¸‹äº†!`);
    // === ã€onKill é’©å­ã€‘å‡»æ€åç‰¹æ€§è§¦å‘ (Moxie, Beast Boost ç­‰) ===
    const p = battle.getPlayer();
    if (p && p.isAlive() && p.ability) {
        const abilityId = p.ability;
        if (typeof AbilityHandlers !== 'undefined' && AbilityHandlers[abilityId] && AbilityHandlers[abilityId].onKill) {
            const killLogs = [];
            AbilityHandlers[abilityId].onKill(p, killLogs);
            killLogs.forEach(msg => log(msg));
            if (typeof updateAllVisuals === 'function') {
                updateAllVisuals('player');
            }
        }
    }
    // Battle Bond (ç‰µç»Šå˜èº«) è§¦å‘æ£€æŸ¥
    if (p && p.isAlive() && typeof window.checkBattleBondTransform === 'function') {
        const bondResult = window.checkBattleBondTransform(p);
        if (bondResult && bondResult.success) {
            log(`<span style="color:#3b82f6">ğŸŒŠ ${bondResult.oldName} çš„ç‰µç»Š... å˜èº«ä¸º ${bondResult.newName}ï¼</span>`);
            updateAllVisuals('player');
            await wait(800);
        }
    }
    // ã€é˜²æ­¢é‡å¤åˆ¤å®šã€‘å¦‚æœå·²ç»åˆ¤å®šè¿‡èƒœè´Ÿï¼Œç›´æ¥è¿”å›
    if (battle.battleEndDetermined) {
        console.log('[handleEnemyFainted] èƒœè´Ÿå·²åˆ¤å®šï¼Œè·³è¿‡');
        return;
    }
    const battleEnd = battle.checkBattleEnd();
    if (battleEnd === 'win') {
        battle.battleEndDetermined = true; // æ ‡è®°èƒœè´Ÿå·²åˆ¤å®š
        log("ğŸ† <b style='color:#27ae60'>æ•Œæ–¹å…¨éƒ¨æˆ˜è´¥ï¼ä½ èµ¢äº†ï¼</b>");
        const t = battle.trainer;
        if (t && t.id !== 'wild' && t.lines?.lose) {
            log(`<i>${t.name}: "${t.lines.lose}"</i>`);
        }
        setTimeout(() => {
            if (typeof window.battleEndSequence === 'function') {
                window.battleEndSequence('win');
            }
        }, 2000);
        return;
    } else if (battleEnd === 'loss') {
        // ã€åŒå‘½åŒæ€ã€‘æ•Œæ–¹å€’ä¸‹ä½†ç©å®¶ä¹Ÿå…¨ç­ï¼Œä¸”åŒå‘½è€…æ˜¯æ•Œæ–¹ -> ç©å®¶èµ¢
        // è¿™ç§æƒ…å†µåœ¨ checkBattleEnd ä¸­å·²ç»å¤„ç†ï¼Œä½†å¦‚æœè¿”å› loss è¯´æ˜æ˜¯ç©å®¶ç”¨çš„åŒå‘½
        battle.battleEndDetermined = true;
        log(" <b style='color:#e74c3c'>... ä½ è¾“äº†.</b>");
        const t = battle.trainer;
        if (t && t.id !== 'wild' && t.lines?.win) {
            log(`<i>${t.name}: "${t.lines.win}"</i>`);
        }
        setTimeout(() => {
            if (typeof window.battleEndSequence === 'function') {
                window.battleEndSequence('loss');
            }
        }, 2000);
        return;
    }
    // æ•Œæ–¹æ¢äºº
    await wait(1000);
    if (battle.nextAliveEnemy()) {
        const newE = battle.getEnemy();
        // ã€BUGä¿®å¤ã€‘å…ˆè§¦å‘å…¥åœºç‰¹æ€§ï¼ˆIllusionç­‰ï¼‰ï¼Œå†è¾“å‡ºæ—¥å¿—
        // è¿™æ · Illusion çš„ displayCnName ä¼šåœ¨æ—¥å¿—è¾“å‡ºå‰è®¾ç½®å¥½
        triggerEntryAbilities(newE, battle.getPlayer());
        // ä½¿ç”¨ displayCnNameï¼ˆå¹»è§‰ä¼ªè£…åï¼‰æˆ– cnNameï¼ˆçœŸåï¼‰
        const displayName = newE.displayCnName || newE.cnName;
        log(`æ•Œæ–¹æ´¾å‡º <b>${displayName}</b> (Lv.${newE.level})!`);
        // ã€æ ‡è®°æ¢äººã€‘ç”¨äºé‡å¤ç²¾çµå›¾ä¿®å¤
        if (typeof window.markEnemySwitch === 'function') {
            window.markEnemySwitch();
        }
        // === æ’­æ”¾æ•Œæ–¹æ–°å®å¯æ¢¦å«å£° ===
        if (typeof window.playPokemonCry === 'function') {
            window.playPokemonCry(newE.name);
        }
        // === ã€æ•Œæ–¹ Necrozma åˆä½“ + Ultra Burstã€‘===
        // æ£€æµ‹æ¢å…¥çš„æ˜¯å¦æ˜¯ Necrozmaï¼Œä¸”é˜Ÿä¼ä¸­æœ‰ Solgaleo/Lunala å¯ä»¥åˆä½“
        if (typeof window.autoProcessNecrozmaFusion === 'function') {
            const necrozmaName = (newE.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            if (necrozmaName === 'necrozma') {
                updateAllVisuals('enemy');
                await wait(600);
                const fusionResult = window.autoProcessNecrozmaFusion(battle.enemyParty, (msg) => {
                    log(msg); // æ˜¾ç¤ºåˆä½“/å˜èº«æ—¥å¿—
                });
                if (fusionResult.success) {
                    // æ›´æ–°ç²¾çµå›¾
                    const newSpriteUrl = newE.getSprite ? newE.getSprite(false) : null;
                    if (newSpriteUrl && typeof window.smartLoadSprite === 'function') {
                        window.smartLoadSprite('enemy-sprite', newSpriteUrl, false);
                    }
                    updateAllVisuals('enemy');
                    await wait(800);
                    // æ’­æ”¾å˜èº«åçš„å«å£°
                    if (typeof window.playPokemonCry === 'function') {
                        window.playPokemonCry(newE.name);
                    }
                }
            }
        }
        // æ£€æŸ¥å¹¶æ‰§è¡Œè¿›åœºè‡ªåŠ¨å˜å½¢ (Primal/Crowned)
        if (typeof window.checkInitTransform === 'function' && newE.needsInitTransform) {
            console.log('[FORM] Checking enemy switch-in init transform:', newE.name);
            const result = window.checkInitTransform(newE);
            if (result) {
                log(`<span style="color:#ef4444">âœ¦ æ•Œæ–¹ ${result.oldName} å˜ä¸º ${result.newName}ï¼</span>`);
                const newSpriteUrl = newE.getSprite(false);
                const preloader = new Image();
                preloader.src = newSpriteUrl;
                await wait(100);
            }
        }
        // æ£€æŸ¥æ¢å…¥çš„æ•Œæ–¹æ˜¯å¦éœ€è¦æå·¨åŒ–
        const enemyUnlocks = battle.enemyUnlocks || {};
        // ã€æ•°æ®é©±åŠ¨ã€‘æ£€æŸ¥æ˜¯å¦æœ‰ G-Max å› å­
        const hasGMaxFactor = typeof window.getGMaxFactor === 'function' && window.getGMaxFactor(newE);
        const isNewEnemyDynamax = (newE.mechanic === 'dynamax') || 
                                   (newE.canDynamax && newE.mechanic !== 'mega' && newE.mechanic !== 'tera') ||
                                   (newE.megaTargetId && newE.megaTargetId.includes('gmax')) ||
                                   hasGMaxFactor; // è‡ªåŠ¨æ£€æµ‹ G-Max å› å­
        if (enemyUnlocks.enable_dynamax && isNewEnemyDynamax && !newE.isDynamaxed && !battle.enemyMaxUsed) {
            battle.enemyMaxUsed = true;
            const oldName = newE.cnName;
            const oldMaxHp = newE.maxHp;
            const oldCurrHp = newE.currHp;
            newE.originalName = newE.name;
            updateAllVisuals('enemy');
            await wait(600);
            log(`<b style="color:#e11d48">â–‚â–ƒâ–…â–†â–‡ DYNAMAX !!! â–‡â–†â–…â–ƒâ–‚</b>`);
            log(`æ•Œæ–¹çš„ ${oldName} æå·¨åŒ–äº†ï¼`);
            const spriteEl = document.getElementById('enemy-sprite');
            if (spriteEl) {
                spriteEl.classList.add('dynamax-burst');
                await wait(400);
                // æ£€æŸ¥æ˜¯å¦æœ‰ G-Max å½¢æ€ï¼ˆmegaTargetId åŒ…å« gmaxï¼‰
                // ã€å…³é”®ã€‘é€šç”¨æå·¨åŒ– (isGenericDynamax) ä¸åˆ‡æ¢å›¾ç‰‡ï¼Œåªç”¨ CSS æ”¾å¤§
                const gmaxFormId = newE.megaTargetId;
                if (gmaxFormId && gmaxFormId.includes('gmax') && !newE.isGenericDynamax) {
                    // [BUG FIX] æ ¼å¼è½¬æ¢ï¼šcharizardgmax -> Charizard-Gmax
                    const baseName = gmaxFormId.replace(/gmax$/i, '');
                    const formattedName = baseName.charAt(0).toUpperCase() + baseName.slice(1) + '-Gmax';
                    newE.name = formattedName;
                    // ã€å¼ºåˆ¶ä¿®æ­£ã€‘G-Max å½¢æ€ä¸­æ–‡åï¼šä¼˜å…ˆç¿»è¯‘ï¼Œå›é€€æ—¶å¼ºåˆ¶åŠ "è¶…æå·¨"å‰ç¼€
                    if (window.Locale) {
                        const translatedName = window.Locale.get(formattedName);
                        // æ£€æŸ¥æ˜¯å¦æˆåŠŸç¿»è¯‘ï¼ˆç¿»è¯‘åä¸ç­‰äºåŸåï¼Œä¸”ä¸ç­‰äºåŸºç¡€å½¢æ€åï¼‰
                        const baseTranslated = window.Locale.get(baseName.charAt(0).toUpperCase() + baseName.slice(1));
                        if (translatedName !== formattedName && translatedName !== baseTranslated) {
                            // æˆåŠŸç¿»è¯‘åˆ° G-Max å½¢æ€ï¼ˆå¦‚ "è¶…æå·¨å–·ç«é¾™"ï¼‰
                            newE.cnName = translatedName;
                        } else {
                            // ç¿»è¯‘å¤±è´¥ï¼Œå¼ºåˆ¶æ·»åŠ "è¶…æå·¨"å‰ç¼€
                            newE.cnName = 'è¶…æå·¨' + baseTranslated;
                        }
                    } else {
                        newE.cnName = formattedName;
                    }
                    const gmaxSpriteId = gmaxFormId.replace(/gmax$/i, '-gmax');
                    const gmaxSpriteUrl = `https://play.pokemonshowdown.com/sprites/ani/${gmaxSpriteId}.gif`;
                    if (typeof window.smartLoadSprite === 'function') {
                        window.smartLoadSprite('enemy-sprite', gmaxSpriteUrl, false);
                    }
                    console.log(`[DYNAMAX] æ•Œæ–¹æ¢å…¥æå·¨åŒ–ï¼Œåˆ‡æ¢ç²¾çµå›¾: ${gmaxSpriteUrl}`);
                } else if (newE.isGenericDynamax) {
                    console.log(`[DYNAMAX] æ•Œæ–¹é€šç”¨æå·¨åŒ–ï¼Œä¿æŒåŸå§‹ç²¾çµå›¾: ${newE.name}`);
                }
                await wait(400);
                spriteEl.classList.remove('dynamax-burst');
                spriteEl.classList.add('state-dynamax');
            }
            // ã€ç»Ÿä¸€ã€‘ä½¿ç”¨ dynamax.js çš„ activateDynamax å‡½æ•°
            if (typeof window.activateDynamax === 'function') {
                const result = window.activateDynamax(newE, { justSwitchedIn: true });
                log(`<span style="color:#ff6b8a">[æ•Œæ–¹æå·¨åŒ–å‰©ä½™å›åˆ: ${newE.dynamaxTurns}]</span>`);
            } else {
                // å›é€€é€»è¾‘ï¼ˆå¦‚æœ dynamax.js æœªåŠ è½½ï¼‰
                const hpMultiplier = 1.5;
                newE.maxHp = Math.floor(oldMaxHp * hpMultiplier);
                newE.currHp = Math.floor(oldCurrHp * hpMultiplier);
                newE.isDynamaxed = true;
                newE.dynamaxTurns = 3;
                newE.preDynamaxMaxHp = oldMaxHp;
                newE.preDynamaxCurrHp = oldCurrHp;
                newE.dynamaxJustActivated = true;
                if (typeof window.applyDynamaxState === 'function') {
                    window.applyDynamaxState(newE, true);
                }
                log(`<span style="color:#ff6b8a">[æ•Œæ–¹æå·¨åŒ–å‰©ä½™å›åˆ: ${newE.dynamaxTurns}]</span>`);
            }
            await wait(400);
        }
        updateAllVisuals('enemy');
        // ã€æ³¨æ„ã€‘triggerEntryAbilities å·²åœ¨æ—¥å¿—è¾“å‡ºå‰è°ƒç”¨ï¼Œè¿™é‡Œä¸å†é‡å¤è°ƒç”¨
        // ç»“ç®—æ•Œæ–¹åœºåœ°é’‰å­ä¼¤å®³
        if (typeof MoveEffects !== 'undefined' && MoveEffects.applyEntryHazards) {
            const hazardLogs = MoveEffects.applyEntryHazards(newE, false, battle);
            hazardLogs.forEach(msg => log(msg));
            if (hazardLogs.length > 0) updateAllVisuals();
        }
        // ã€æ³¨æ„ã€‘æ•Œæ–¹å€’ä¸‹æ¢äººåï¼Œä¸åœ¨è¿™é‡Œæ‰§è¡Œ executeEndPhase
        // å› ä¸º handleAttack ä¸­ä¼šåœ¨ return ä¹‹å‰æˆ–ä¹‹åç»Ÿä¸€å¤„ç†å›åˆæœ«ç»“ç®—
        // å¦‚æœåœ¨è¿™é‡Œè°ƒç”¨ executeEndPhaseï¼Œä¼šå¯¼è‡´ G-Max DOT åœ¨æ¢äººæ—¶ç«‹å³è§¦å‘
        // è€Œä¸æ˜¯ç­‰åˆ°æ•´ä¸ªå›åˆç»“æŸåè§¦å‘
        battle.locked = false;
    } else {
        log("ğŸ† <b style='color:#27ae60'>æ•Œæ–¹å…¨éƒ¨æˆ˜è´¥ï¼ä½ èµ¢äº†ï¼</b>");
        setTimeout(() => {
            if (typeof window.battleEndSequence === 'function') {
                window.battleEndSequence('win');
            }
        }, 2000);
    }
}
/**
 * å¤„ç†ç©å®¶å€’ä¸‹
 */
export async function handlePlayerFainted(p) {
    if (typeof window.playSFX === 'function') window.playSFX('FAINT');
    const battle = window.battle;
    // ã€Gen 9 Last Respectsã€‘å¢åŠ ç©å®¶æ–¹æ¿’æ­»è®¡æ•°ï¼ˆç”¨äºæœ€åç¤¼è°¢å¨åŠ›è®¡ç®—ï¼‰
    battle.playerFaintCount = (battle.playerFaintCount || 0) + 1;
    console.log(`[Last Respects Counter] ç©å®¶æ–¹æ¿’æ­»æ¬¡æ•°: ${battle.playerFaintCount}`);
    // ã€Gen 9 Rage Fistã€‘æ¿’æ­»æ—¶æ¸…é›¶è¢«æ”»å‡»è®¡æ•°
    p.timesAttacked = 0;
    // å¦‚æœå¤„äºæå·¨åŒ–çŠ¶æ€ï¼Œå…ˆæ¸…ç†æå·¨åŒ–è§†è§‰æ•ˆæœ
    if (p.isDynamaxed) {
        if (p.originalName) {
            p.name = p.originalName;
            delete p.originalName;
        }
        if (typeof window.endDynamaxAnimation === 'function') {
            await window.endDynamaxAnimation(p, true);
        }
        p.isDynamaxed = false;
        delete p.preDynamaxMaxHp;
        delete p.preDynamaxCurrHp;
        if (typeof window.applyDynamaxState === 'function') {
            window.applyDynamaxState(p, false);
        }
    }
    log(`<b style="color:red">ç³Ÿç³•! ${p.cnName} å¤±å»äº†æˆ˜æ–—èƒ½åŠ›!</b>`);
    // ã€é˜²æ­¢é‡å¤åˆ¤å®šã€‘å¦‚æœå·²ç»åˆ¤å®šè¿‡èƒœè´Ÿï¼Œç›´æ¥è¿”å›
    if (battle.battleEndDetermined) {
        console.log('[handlePlayerFainted] èƒœè´Ÿå·²åˆ¤å®šï¼Œè·³è¿‡');
        return;
    }
    // === ã€ä¿®å¤ã€‘æ£€æŸ¥æ•Œæ–¹æ˜¯å¦ä¹ŸåŒæ—¶å€’ä¸‹ï¼ˆåŒæ€åœºæ™¯ï¼šé—ªç„°å†²é”‹/å¤§çˆ†ç‚¸ç­‰ï¼‰===
    const e = battle.getEnemy();
    if (e && !e.isAlive()) {
        log(`æ•Œæ–¹çš„ ${e.cnName} å€’ä¸‹äº†!`);
        // æ£€æŸ¥æˆ˜æ–—æ˜¯å¦ç»“æŸ
        const battleEnd = battle.checkBattleEnd();
        if (battleEnd === 'win') {
            battle.battleEndDetermined = true;
            log("ğŸ† <b style='color:#27ae60'>æ•Œæ–¹å…¨éƒ¨æˆ˜è´¥ï¼ä½ èµ¢äº†ï¼</b>");
            const t = battle.trainer;
            if (t && t.id !== 'wild' && t.lines?.lose) {
                log(`<i>${t.name}: "${t.lines.lose}"</i>`);
            }
            setTimeout(() => {
                if (typeof window.battleEndSequence === 'function') {
                    window.battleEndSequence('win');
                }
            }, 2000);
            return;
        } else if (battleEnd === 'loss') {
            battle.battleEndDetermined = true;
            log(" <b style='color:#e74c3c'>... ä½ è¾“äº†.</b>");
            const t = battle.trainer;
            if (t && t.id !== 'wild' && t.lines?.win) {
                log(`<i>${t.name}: "${t.lines.win}"</i>`);
            }
            setTimeout(() => {
                if (typeof window.battleEndSequence === 'function') {
                    window.battleEndSequence('loss');
                }
            }, 2000);
            return;
        }
        // æ•Œæ–¹æ¢äºº
        await wait(500);
        if (battle.nextAliveEnemy()) {
            const newE = battle.getEnemy();
            log(`æ•Œæ–¹æ´¾å‡º <b>${newE.cnName}</b> (Lv.${newE.level})!`);
            if (typeof window.markEnemySwitch === 'function') {
                window.markEnemySwitch();
            }
            // åŠ è½½æ–°æ•Œæ–¹ç²¾çµå›¾
            const newSpriteUrl = newE.getSprite(false);
            if (typeof window.smartLoadSprite === 'function') {
                window.smartLoadSprite('enemy-sprite', newSpriteUrl, true);
            }
            // æ’­æ”¾å«å£°
            if (typeof window.playPokemonCry === 'function') {
                window.playPokemonCry(newE.name);
            }
            if (typeof updateAllVisuals === 'function') {
                updateAllVisuals();
            }
            // ã€åŒæ€æ ‡è®°ã€‘æ ‡è®°æ•Œæ–¹åˆšæ¢äººï¼Œç­‰ç©å®¶æ¢äººå®Œæˆåè§¦å‘å…¥åœºç‰¹æ€§
            battle.enemyJustSwitchedInDoubleKO = true;
        }
    } else if (e && e.isAlive() && e.ability) {
        // === ã€onKill é’©å­ã€‘æ•Œæ–¹å‡»æ€åç‰¹æ€§è§¦å‘ (Moxie, Beast Boost ç­‰) ===
        const abilityId = e.ability;
        if (typeof AbilityHandlers !== 'undefined' && AbilityHandlers[abilityId] && AbilityHandlers[abilityId].onKill) {
            const killLogs = [];
            AbilityHandlers[abilityId].onKill(e, killLogs);
            killLogs.forEach(msg => log(msg));
            if (typeof updateAllVisuals === 'function') {
                updateAllVisuals('enemy');
            }
        }
    }
    await wait(500);
    // ã€å…³é”®ä¿®å¤ã€‘ç­‰å¾…å¼ºåˆ¶æ¢äººå®Œæˆï¼Œè€Œä¸æ˜¯ç«‹å³è¿”å›
    if (typeof window.checkPlayerDefeatOrForceSwitch === 'function') {
        const result = await window.checkPlayerDefeatOrForceSwitch();
        console.log('[handlePlayerFainted] Force switch completed with result:', result);
    }
}
// ============================================
// å…¥åœºç‰¹æ€§
// ============================================
/**
 * è§¦å‘å…¥åœºç‰¹æ€§ (å¨å“ã€å¤©æ°”ç­‰)
 */
export function triggerEntryAbilities(pokemon, opponent) {
    const battle = window.battle;
    if (!pokemon || !opponent) return;
    // === ã€æ²»æ„ˆä¹‹æ„¿ / æ–°æœˆç¥ˆç¥·ã€‘å…¥åœºæ²»æ„ˆæ•ˆæœ ===
    // åˆ¤æ–­æ˜¯ç©å®¶æ–¹è¿˜æ˜¯æ•Œæ–¹
    const isPlayerPokemon = battle.playerParty && battle.playerParty.includes(pokemon);
    const side = isPlayerPokemon ? battle.playerSide : battle.enemySide;
    if (side) {
        // Healing Wish: å›æ»¡ HP + æ¸…é™¤çŠ¶æ€
        if (side.healingWish) {
            const healAmount = pokemon.maxHp - pokemon.currHp;
            pokemon.currHp = pokemon.maxHp;
            if (pokemon.status) {
                pokemon.status = null;
                pokemon.statusTurns = 0;
                pokemon.sleepTurns = 0;
            }
            log(`<b style="color:#ff69b4">ğŸ’– æ²»æ„ˆä¹‹æ„¿çš„å…‰èŠ’åŒ…å›´äº† ${pokemon.cnName}ï¼HP å®Œå…¨æ¢å¤ï¼</b>`);
            delete side.healingWish;
            console.log(`[HEALING WISH] ${pokemon.cnName} è¢«æ²»æ„ˆï¼Œå›å¤ ${healAmount} HP`);
            updateAllVisuals();
        }
        // Lunar Dance: å›æ»¡ HP + æ¸…é™¤çŠ¶æ€ + å›æ»¡ PP
        if (side.lunarDance) {
            const healAmount = pokemon.maxHp - pokemon.currHp;
            pokemon.currHp = pokemon.maxHp;
            if (pokemon.status) {
                pokemon.status = null;
                pokemon.statusTurns = 0;
                pokemon.sleepTurns = 0;
            }
            // å›æ»¡æ‰€æœ‰æ‹›å¼çš„ PP
            if (pokemon.moves) {
                pokemon.moves.forEach(move => {
                    if (move.pp !== undefined && move.maxPp !== undefined) {
                        move.pp = move.maxPp;
                    }
                });
            }
            log(`<b style="color:#9b59b6">ğŸŒ™ æ–°æœˆç¥ˆç¥·çš„æœˆå…‰åŒ…å›´äº† ${pokemon.cnName}ï¼HP å’Œ PP å®Œå…¨æ¢å¤ï¼</b>`);
            delete side.lunarDance;
            console.log(`[LUNAR DANCE] ${pokemon.cnName} è¢«æ²»æ„ˆï¼Œå›å¤ ${healAmount} HPï¼ŒPP å…¨æ»¡`);
            updateAllVisuals();
        }
    }
    // === ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘è¿›åœºæ•ˆæœå·²è¿ç§»è‡³ environment overlay API ===
    // === å…¥åœºç‰¹æ€§ ===
    if (typeof AbilityHandlers === 'undefined') return;
    const h = AbilityHandlers[pokemon.ability];
    if (h && h.onStart) {
        let logs = [];
        h.onStart(pokemon, opponent, logs, battle);
        logs.forEach(t => log(t));
        updateAllVisuals();
    }
}
// ============================================
// æ¢äººæ ¡éªŒï¼ˆæŠ“äººæœºåˆ¶ï¼‰
// ============================================
/**
 * æ£€æŸ¥ç©å®¶æ˜¯å¦å¯ä»¥æ¢äººï¼ˆè€ƒè™‘æŠ“äººç‰¹æ€§å’ŒçŠ¶æ€ï¼‰
 * @returns {Object} { canSwitch: boolean, reason?: string }
 */
export function canPlayerSwitch() {
    const battle = window.battle;
    if (!battle) return { canSwitch: true };
    const p = battle.getPlayer();
    const e = battle.getEnemy();
    if (!p || !p.isAlive || !p.isAlive()) return { canSwitch: true };
    // ä½¿ç”¨å…¨å±€çš„ checkCanSwitch å‡½æ•°
    if (typeof window.checkCanSwitch === 'function') {
        return window.checkCanSwitch(p, e, battle);
    }
    return { canSwitch: true };
}
/**
 * æ£€æŸ¥æ•Œæ–¹æ˜¯å¦å¯ä»¥æ¢äººï¼ˆè€ƒè™‘æŠ“äººç‰¹æ€§å’ŒçŠ¶æ€ï¼‰
 * @returns {Object} { canSwitch: boolean, reason?: string }
 */
export function canEnemySwitch() {
    const battle = window.battle;
    if (!battle) return { canSwitch: true };
    const p = battle.getPlayer();
    const e = battle.getEnemy();
    if (!e || !e.isAlive || !e.isAlive()) return { canSwitch: true };
    // ä½¿ç”¨å…¨å±€çš„ checkCanSwitch å‡½æ•°
    if (typeof window.checkCanSwitch === 'function') {
        return window.checkCanSwitch(e, p, battle);
    }
    return { canSwitch: true };
}
// ============================================
// å¯¼å‡º
// ============================================
if (typeof window !== 'undefined') {
    window.hasAliveSwitch = hasAliveSwitch;
    window.handlePlayerPivot = handlePlayerPivot;
    window.handleEnemyPivot = handleEnemyPivot;
    window.handleEnemyFainted = handleEnemyFainted;
    window.handlePlayerFainted = handlePlayerFainted;
    window.triggerEntryAbilities = triggerEntryAbilities;
    window.canPlayerSwitch = canPlayerSwitch;
    window.canEnemySwitch = canEnemySwitch;
}
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        hasAliveSwitch,
        handlePlayerPivot,
        handleEnemyPivot,
        handleEnemyFainted,
        handlePlayerFainted,
        triggerEntryAbilities,
        canPlayerSwitch,
        canEnemySwitch
    };
}
]]></file>
        <file name="battle-turns.js"><![CDATA[/**
 * ===========================================
 * BATTLE-TURNS.JS - å›åˆæ‰§è¡Œ
 * ===========================================
 * 
 * èŒè´£:
 * - æ‰§è¡Œç©å®¶å›åˆ
 * - æ‰§è¡Œæ•Œæ–¹å›åˆ
 * - ç‹¬ç«‹æ•Œæ–¹å›åˆ (æ¢äººå)
 * - Z/Max æ‹›å¼ä½¿ç”¨æ ‡è®°
 */
// ============================================
// è¾…åŠ©å‡½æ•°
// ============================================
/**
 * è¾…åŠ©å‡½æ•°ï¼šç­‰å¾…
 */
function wait(ms) { 
    return new Promise(r => setTimeout(r, ms)); 
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šæ—¥å¿—è¾“å‡º
 */
function log(msg) {
    if (typeof window !== 'undefined' && typeof window.log === 'function') {
        window.log(msg);
    } else {
        console.log(msg);
    }
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è§†è§‰
 */
function updateAllVisuals(forceSpriteAnim) {
    if (typeof window !== 'undefined' && typeof window.updateAllVisuals === 'function') {
        window.updateAllVisuals(forceSpriteAnim);
    }
}
// ============================================
// å›åˆå¼€å§‹å¤„ç†
// ============================================
/**
 * å›åˆå¼€å§‹æ—¶çš„ç»Ÿä¸€å¤„ç†
 * - é€’å‡é£æ ¼å†·å´
 * - å…¶ä»–å›åˆå¼€å§‹é’©å­
 */
export function onTurnStart() {
    const battle = window.battle;
    if (!battle) return;
    const logs = [];
    // ã€Chronal Rift é€Ÿåº¦ç†µå¢ã€‘å›åˆå¼€å§‹æ—¶æ£€æŸ¥æ—¶ç©ºç¿»è½¬
    if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.checkEntropyFlux) {
        const weather = battle?.weather || battle?.environmentWeather || '';
        const entropyResult = window.WeatherEffects.checkEntropyFlux(weather);
        if (entropyResult.shouldTrigger) {
            // ç¿»è½¬æˆæ³•ç©ºé—´çŠ¶æ€
            battle.field = battle.field || {};
            if (battle.field.trickRoom > 0) {
                // å…³é—­æˆæ³•ç©ºé—´
                battle.field.trickRoom = 0;
                logs.push(entropyResult.message);
                logs.push(`<span style="color:#a855f7">ğŸŒ€ æˆæ³•ç©ºé—´å´©å¡Œï¼é€Ÿåº¦æ¢å¤æ­£å¸¸ï¼</span>`);
                console.log(`[CHRONAL RIFT] âš¡ é€Ÿåº¦ç†µå¢ï¼šæˆæ³•ç©ºé—´å…³é—­`);
            } else {
                // å¼€å¯æˆæ³•ç©ºé—´ï¼ˆæ— é™æŒç»­ï¼‰
                battle.field.trickRoom = 999; // æ— é™æŒç»­
                battle.field.chronalTrickRoom = true; // æ ‡è®°ä¸ºæ—¶ç©ºè£‚éš™äº§ç”Ÿçš„
                logs.push(entropyResult.message);
                logs.push(`<span style="color:#a855f7">ğŸŒ€ æˆæ³•ç©ºé—´å±•å¼€ï¼é€Ÿåº¦çš„æ¦‚å¿µè¢«æ‰­æ›²äº†ï¼</span>`);
                console.log(`[CHRONAL RIFT] âš¡ é€Ÿåº¦ç†µå¢ï¼šæˆæ³•ç©ºé—´å¼€å¯ï¼ˆæ— é™ï¼‰`);
            }
            // è¾“å‡ºæ—¥å¿—
            if (typeof window.log === 'function') {
                logs.forEach(l => window.log(l));
            }
        }
    }
    // ã€å¤æ­¦ç³»ç»Ÿã€‘å›åˆå¼€å§‹æ—¶é€’å‡å†·å´
    if (battle.playerStyleCooldown > 0) {
        battle.playerStyleCooldown--;
        console.log(`[STYLES] ç©å®¶é£æ ¼å†·å´é€’å‡: ${battle.playerStyleCooldown + 1} -> ${battle.playerStyleCooldown}`);
        if (typeof window.updateStyleButtonCooldown === 'function') {
            window.updateStyleButtonCooldown();
        }
    }
    if (battle.enemyStyleCooldown > 0) {
        battle.enemyStyleCooldown--;
        console.log(`[STYLES] æ•Œæ–¹é£æ ¼å†·å´é€’å‡: ${battle.enemyStyleCooldown + 1} -> ${battle.enemyStyleCooldown}`);
    }
}
// ============================================
// ç©å®¶å›åˆæ‰§è¡Œ
// ============================================
/**
 * æ‰§è¡Œç©å®¶å›åˆ
 * @param {Object} p ç©å®¶å®å¯æ¢¦
 * @param {Object} e æ•Œæ–¹å®å¯æ¢¦
 * @param {Object} move æ‹›å¼
 * @returns {Object} åŒ…å« pivot æ ‡è®°çš„ç»“æœ
 */
export async function executePlayerTurn(p, e, move) {
    const battle = window.battle;
    // === ã€å®˜æ–¹æœºåˆ¶ã€‘åŒå‘½/æ€¨æ¨çŠ¶æ€æ¸…é™¤é€»è¾‘ ===
    // å…³é”®ï¼šçŠ¶æ€åœ¨ä½¿ç”¨è€…"å°è¯•å‡ºæ‹›"æ—¶æ¸…é™¤ï¼Œä¸ç®¡å‡ºä»€ä¹ˆæ‹›
    // ä¾‹å¤–ï¼šå¦‚æœå› ä¸ºç¡çœ /å†°å†»/ç•ç¼©ç­‰æ— æ³•è¡ŒåŠ¨ï¼ŒçŠ¶æ€ä¿ç•™
    // çŠ¶æ€é˜»æ–­æ£€æµ‹
    if (typeof window.checkCanMove === 'function') {
        const check = window.checkCanMove(p);
        if (check.msg) {
            log(`<span style="color:#e67e22">${check.msg}</span>`);
        }
        if (!check.can) {
            // ã€å…³é”®ã€‘æ— æ³•è¡ŒåŠ¨æ—¶ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™ï¼
            console.log(`[DESTINY BOND] ${p.cnName} æ— æ³•è¡ŒåŠ¨ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™`);
            await wait(500);
            return { pivot: false };
        }
    }
    // === ã€æ··ä¹±è‡ªä¼¤æ£€æŸ¥ã€‘===
    if (typeof window.MoveEffects !== 'undefined' && window.MoveEffects.checkConfusion) {
        const confusionCheck = window.MoveEffects.checkConfusion(p);
        confusionCheck.logs.forEach(txt => log(`<span style="color:#e67e22">${txt}</span>`));
        if (confusionCheck.selfHit) {
            // æ··ä¹±è‡ªä¼¤ï¼Œæ— æ³•è¡ŒåŠ¨
            console.log(`[CONFUSION] ${p.cnName} æ··ä¹±è‡ªä¼¤ï¼Œæ— æ³•è¡ŒåŠ¨`);
            await wait(500);
            return { pivot: false };
        }
    }
    // === ç‰¹æ€§ onBeforeMove é’©å­ (æ‡’æƒ°ã€å˜å¹»è‡ªå¦‚ç­‰) ===
    if (typeof AbilityHandlers !== 'undefined' && p.ability) {
        const abilityHandler = AbilityHandlers[p.ability];
        if (abilityHandler && abilityHandler.onBeforeMove) {
            const beforeMoveLogs = [];
            const canMove = abilityHandler.onBeforeMove(p, move, beforeMoveLogs);
            beforeMoveLogs.forEach(txt => log(txt));
            if (canMove === false) {
                // ã€å…³é”®ã€‘ç‰¹æ€§é˜»æ­¢è¡ŒåŠ¨æ—¶ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™ï¼
                console.log(`[DESTINY BOND] ${p.cnName} è¢«ç‰¹æ€§é˜»æ­¢è¡ŒåŠ¨ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™`);
                await wait(500);
                return { pivot: false };
            }
        }
    }
    // === ç¡¬ç›´æ£€æŸ¥ (ç ´åå…‰çº¿/çˆ†ç‚¸çƒˆç„°ç­‰) ===
    // ã€ä¿®å¤ã€‘åœ¨è¾“å‡º"ä½¿ç”¨äº†xxx"ä¹‹å‰æ£€æŸ¥ï¼Œé¿å…è¯¯å¯¼æ€§æ—¥å¿—
    if (p.mustRecharge) {
        log(`<span style="color:#e74c3c">${p.cnName} å› ä¸ºä¸Šå›åˆçš„åä½œç”¨åŠ›æ— æ³•åŠ¨å¼¹!</span>`);
        p.mustRecharge = false;
        // ã€å…³é”®ã€‘ç¡¬ç›´æ—¶ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™ï¼
        console.log(`[DESTINY BOND] ${p.cnName} ç¡¬ç›´ä¸­ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™`);
        await wait(500);
        return { pivot: false };
    }
    // === ã€ç²¾ç¥åœºåœ°ã€‘é˜»æ­¢å…ˆåˆ¶æŠ€èƒ½å¯¹åœ°é¢ç›®æ ‡ç”Ÿæ•ˆ ===
    // ã€é‡è¦ã€‘åªé˜»æ­¢"ä»¥å¯¹æ‰‹ä¸ºç›®æ ‡"çš„å…ˆåˆ¶æŠ€èƒ½ï¼Œä¸é˜»æ­¢ self/allySide ç­‰
    const getMovePriorityFn = (typeof window.getMovePriority === 'function') ? window.getMovePriority : (m => m?.priority || 0);
    const movePriority = getMovePriorityFn(move, p, e);
    if (movePriority > 0 && battle?.terrain === 'psychicterrain') {
        // æ£€æŸ¥æ‹›å¼ç›®æ ‡ç±»å‹ï¼šåªæœ‰ä»¥å¯¹æ‰‹ä¸ºç›®æ ‡çš„æ‹›å¼æ‰ä¼šè¢«é˜»æ­¢
        const moveTarget = move.target || 'normal';
        const targetsOpponent = !['self', 'allySide', 'allyTeam', 'allies', 'adjacentAlly', 'adjacentAllyOrSelf'].includes(moveTarget);
        if (targetsOpponent) {
            // æ£€æŸ¥ç›®æ ‡æ˜¯å¦æ¥åœ°ï¼ˆFlying ç±»å‹æˆ– Levitate ç‰¹æ€§ä¸å—å½±å“ï¼‰
            const targetAbility = (e.ability || '').toLowerCase().replace(/[^a-z]/g, '');
            const targetIsGrounded = !e.types?.includes('Flying') && targetAbility !== 'levitate';
            if (targetIsGrounded) {
                log(`<span style="color:#9b59b6">ğŸ”® ${e.cnName} è¢«ç²¾ç¥åœºåœ°ä¿æŠ¤äº†ï¼å…ˆåˆ¶æŠ€èƒ½æ— æ•ˆï¼</span>`);
                console.log(`[PSYCHIC TERRAIN] ${p.cnName} çš„å…ˆåˆ¶æŠ€èƒ½ ${move.name} (priority=${movePriority}, target=${moveTarget}) è¢«ç²¾ç¥åœºåœ°é˜»æ­¢`);
                await wait(500);
                return { pivot: false };
            }
        }
    }
    // === ã€å®˜æ–¹æœºåˆ¶ã€‘åœ¨å°è¯•å‡ºæ‹›æ—¶ç«‹å³æ¸…é™¤åŒå‘½/æ€¨æ¨çŠ¶æ€ ===
    // ä¸ç®¡è¿™å›åˆç”¨ä»€ä¹ˆæ‹›ï¼ˆæ”»å‡»/å˜åŒ–/å®ˆä½ï¼‰ï¼Œåªè¦å¼€å§‹è¡ŒåŠ¨å°±æ¸…é™¤
    if (p.volatile && p.volatile.destinyBond) {
        delete p.volatile.destinyBond;
        console.log(`[DESTINY BOND CLEAR] ${p.cnName} å°è¯•å‡ºæ‹›ï¼ŒåŒå‘½çŠ¶æ€æ¸…é™¤`);
    }
    if (p.volatile && p.volatile.grudge) {
        delete p.volatile.grudge;
        console.log(`[GRUDGE CLEAR] ${p.cnName} å°è¯•å‡ºæ‹›ï¼Œæ€¨æ¨çŠ¶æ€æ¸…é™¤`);
    }
    log(`[${p.cnName}] ä½¿ç”¨äº† <b>${move.cn}</b>!`);
    await wait(600);
    const result = applyDamage(p, e, move, 'enemy-sprite');
    // è®°å½•æœ¬å›åˆä½¿ç”¨çš„æŠ€èƒ½
    p.lastMoveUsed = move.name;
    // ã€Gen7åŒå‘½æœºåˆ¶ã€‘ä½¿ç”¨å…¶ä»–æ‹›å¼æ—¶æ¸…é™¤åŒå‘½æˆåŠŸæ ‡è®°ï¼Œé‡ç½®è¿é”
    if (move.name !== 'Destiny Bond') {
        p.lastDestinyBondSuccess = false;
    }
    // ã€æ€¨æ¨åŒç†ã€‘
    if (move.name !== 'Grudge') {
        p.lastGrudgeSuccess = false;
    }
    // ã€çè—(Last Resort)æ”¯æŒã€‘è¿½è¸ªæ‰€æœ‰æˆåŠŸä½¿ç”¨è¿‡çš„æ‹›å¼
    if (!result?.failed) {
        if (!p.usedMoves) p.usedMoves = new Set();
        p.usedMoves.add(move.name);
    }
    // =========================================================
    // Choice é“å…·é”æ‹›ï¼ˆè®²ç©¶å¤´å¸¦/çœ¼é•œ/å›´å·¾ï¼‰- ç©å®¶
    // =========================================================
    const pItem = p.item || '';
    const pIsChoiceItem = pItem.includes('Choice') || pItem.includes('è®²ç©¶');
    if (pIsChoiceItem && !p.choiceLockedMove) {
        p.choiceLockedMove = move.name;
        console.log(`[CHOICE] ${p.name} è¢« ${pItem} é”å®šåœ¨ ${move.name}`);
    }
    // =========================================================
    // Z-Move / Max Move ä½¿ç”¨æ ‡è®° (å…¨åœºåªèƒ½ç”¨ä¸€æ¬¡)
    // =========================================================
    const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const moveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    // æ£€æµ‹å¹¶æ ‡è®° Z æ‹›å¼ä½¿ç”¨
    const isZMove = moveData.isZ || 
        (moveData.pp === 1 && moveData.basePower >= 100 && moveData.isNonstandard === 'Past') ||
        (move.name || '').length > 25;
    if (isZMove && !battle.playerZUsed) {
        battle.playerZUsed = true;
        console.log(`[Z-MOVE] ç©å®¶ä½¿ç”¨äº† Z æ‹›å¼: ${move.name}ï¼Œæœ¬åœºä¸å¯å†ç”¨`);
        log(`<div style="padding:8px; border:2px solid gold; background:linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,255,255,0.9)); text-align:center; border-radius:8px; margin:5px 0;">`);
        log(`<b style="font-size:1.1rem; background: linear-gradient(90deg, #a855f7, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">âœ¨ Z-POWER UNLEASHED âœ¨</b>`);
        log(`<div style="color:#666; font-size:0.85em; margin-top:4px;">å…¨åŠ›çš„å§¿æ€... ZåŠ›é‡å·²é‡Šæ”¾ï¼</div>`);
        log(`</div>`);
        const stage = document.querySelector('.battle-stage');
        if (stage) {
            stage.classList.add('shake-hit-anim');
            setTimeout(() => stage.classList.remove('shake-hit-anim'), 500);
        }
    }
    // æ£€æµ‹å¹¶æ ‡è®°æå·¨æ‹›å¼ä½¿ç”¨
    const isMaxMove = moveData.isMax || 
        (move.name || '').startsWith('Max ') || (move.name || '').startsWith('G-Max ');
    if (isMaxMove && !battle.playerMaxUsed) {
        battle.playerMaxUsed = true;
        console.log(`[MAX MOVE] ç©å®¶ä½¿ç”¨äº†æå·¨æ‹›å¼: ${move.name}ï¼Œæœ¬åœºä¸å¯å†ç”¨`);
        log(`<div style="padding:8px; border:2px solid #e11d48; background:linear-gradient(135deg, rgba(225,29,72,0.1), rgba(255,255,255,0.9)); text-align:center; border-radius:8px; margin:5px 0;">`);
        log(`<b style="font-size:1.1rem; color:#e11d48;">ğŸ’¥ MAX POWER ğŸ’¥</b>`);
        log(`<div style="color:#666; font-size:0.85em; margin-top:4px;">æå·¨ä¹‹åŠ›å€¾æ³»è€Œå‡ºï¼</div>`);
        log(`</div>`);
    }
    updateAllVisuals();
    // === æ£€æŸ¥å±æœº BGM åˆ‡æ¢ (é¦†ä¸»æˆ˜ä¸“ç”¨) ===
    if (typeof checkCrisisBgm === 'function') {
        checkCrisisBgm();
    }
    // ã€å·²ç§»é™¤ã€‘æ—§çš„æ‹›å¼æ‰§è¡Œåæ¸…é™¤é€»è¾‘
    // ç°åœ¨åŒå‘½/æ€¨æ¨çŠ¶æ€åœ¨"å°è¯•å‡ºæ‹›æ—¶"ç«‹å³æ¸…é™¤ï¼ˆè§ä¸Šæ–¹ä»£ç ï¼‰
    return { pivot: result?.pivot || false };
}
// ============================================
// æ•Œæ–¹å›åˆæ‰§è¡Œ
// ============================================
/**
 * æ‰§è¡Œæ•Œæ–¹å›åˆ
 * @param {Object} e æ•Œæ–¹å®å¯æ¢¦
 * @param {Object} p ç©å®¶å®å¯æ¢¦
 * @param {Object} move æ‹›å¼
 * @returns {Object} åŒ…å« pivot æ ‡è®°çš„ç»“æœ
 */
export async function executeEnemyTurn(e, p, move) {
    const battle = window.battle;
    console.log('[executeEnemyTurn] Starting:', { 
        enemy: e?.cnName, 
        player: p?.cnName, 
        move: move?.name || move?.cn 
    });
    if (!e || !e.isAlive()) {
        console.log('[executeEnemyTurn] Enemy invalid or dead');
        return { pivot: false };
    }
    // å¦‚æœæ²¡æœ‰æ‹›å¼ï¼ˆæ•Œæ–¹æ¢äººåœºæ™¯ï¼‰ï¼Œè·³è¿‡æ”»å‡»
    if (!move) {
        console.log('[executeEnemyTurn] No move provided, skipping');
        return { pivot: false };
    }
    // === ã€å®˜æ–¹æœºåˆ¶ã€‘åŒå‘½/æ€¨æ¨çŠ¶æ€æ¸…é™¤é€»è¾‘ ===
    // å…³é”®ï¼šçŠ¶æ€åœ¨ä½¿ç”¨è€…"å°è¯•å‡ºæ‹›"æ—¶æ¸…é™¤ï¼Œä¸ç®¡å‡ºä»€ä¹ˆæ‹›
    // ä¾‹å¤–ï¼šå¦‚æœå› ä¸ºç¡çœ /å†°å†»/ç•ç¼©ç­‰æ— æ³•è¡ŒåŠ¨ï¼ŒçŠ¶æ€ä¿ç•™
    await wait(800);
    // çŠ¶æ€é˜»æ–­æ£€æµ‹
    if (typeof window.checkCanMove === 'function') {
        const check = window.checkCanMove(e);
        if (check.msg) {
            log(`<span style="color:#e67e22">${check.msg}</span>`);
        }
        if (!check.can) {
            // ã€å…³é”®ã€‘æ— æ³•è¡ŒåŠ¨æ—¶ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™ï¼
            console.log(`[DESTINY BOND] ${e.cnName} æ— æ³•è¡ŒåŠ¨ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™`);
            return { pivot: false };
        }
    }
    // === ã€æ··ä¹±è‡ªä¼¤æ£€æŸ¥ã€‘===
    if (typeof window.MoveEffects !== 'undefined' && window.MoveEffects.checkConfusion) {
        const confusionCheck = window.MoveEffects.checkConfusion(e);
        confusionCheck.logs.forEach(txt => log(`<span style="color:#e67e22">${txt}</span>`));
        if (confusionCheck.selfHit) {
            // æ··ä¹±è‡ªä¼¤ï¼Œæ— æ³•è¡ŒåŠ¨
            console.log(`[CONFUSION] ${e.cnName} æ··ä¹±è‡ªä¼¤ï¼Œæ— æ³•è¡ŒåŠ¨`);
            return { pivot: false };
        }
    }
    // === ç‰¹æ€§ onBeforeMove é’©å­ (æ‡’æƒ°ã€å˜å¹»è‡ªå¦‚ç­‰) ===
    if (typeof AbilityHandlers !== 'undefined' && e.ability) {
        const abilityHandler = AbilityHandlers[e.ability];
        if (abilityHandler && abilityHandler.onBeforeMove) {
            const beforeMoveLogs = [];
            const canMove = abilityHandler.onBeforeMove(e, move, beforeMoveLogs);
            beforeMoveLogs.forEach(txt => log(txt));
            if (canMove === false) {
                // ã€å…³é”®ã€‘ç‰¹æ€§é˜»æ­¢è¡ŒåŠ¨æ—¶ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™ï¼
                console.log(`[DESTINY BOND] ${e.cnName} è¢«ç‰¹æ€§é˜»æ­¢è¡ŒåŠ¨ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™`);
                return { pivot: false };
            }
        }
    }
    // === ç¡¬ç›´æ£€æŸ¥ (ç ´åå…‰çº¿/çˆ†ç‚¸çƒˆç„°ç­‰) ===
    // ã€ä¿®å¤ã€‘åœ¨è¾“å‡º"ä½¿å‡ºxxx"ä¹‹å‰æ£€æŸ¥ï¼Œé¿å…è¯¯å¯¼æ€§æ—¥å¿—
    if (e.mustRecharge) {
        log(`<span style="color:#e74c3c">${e.cnName} å› ä¸ºä¸Šå›åˆçš„åä½œç”¨åŠ›æ— æ³•åŠ¨å¼¹!</span>`);
        e.mustRecharge = false;
        // ã€å…³é”®ã€‘ç¡¬ç›´æ—¶ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™ï¼
        console.log(`[DESTINY BOND] ${e.cnName} ç¡¬ç›´ä¸­ï¼ŒåŒå‘½çŠ¶æ€ä¿ç•™`);
        return { pivot: false };
    }
    // === ã€ç²¾ç¥åœºåœ°ã€‘é˜»æ­¢å…ˆåˆ¶æŠ€èƒ½å¯¹åœ°é¢ç›®æ ‡ç”Ÿæ•ˆ ===
    // ã€é‡è¦ã€‘åªé˜»æ­¢"ä»¥å¯¹æ‰‹ä¸ºç›®æ ‡"çš„å…ˆåˆ¶æŠ€èƒ½ï¼Œä¸é˜»æ­¢ self/allySide ç­‰
    const getMovePriorityFnE = (typeof window.getMovePriority === 'function') ? window.getMovePriority : (m => m?.priority || 0);
    const movePriorityE = getMovePriorityFnE(move, e, p);
    if (movePriorityE > 0 && battle?.terrain === 'psychicterrain') {
        // æ£€æŸ¥æ‹›å¼ç›®æ ‡ç±»å‹ï¼šåªæœ‰ä»¥å¯¹æ‰‹ä¸ºç›®æ ‡çš„æ‹›å¼æ‰ä¼šè¢«é˜»æ­¢
        const moveTargetE = move.target || 'normal';
        const targetsOpponentE = !['self', 'allySide', 'allyTeam', 'allies', 'adjacentAlly', 'adjacentAllyOrSelf'].includes(moveTargetE);
        if (targetsOpponentE) {
            // æ£€æŸ¥ç›®æ ‡æ˜¯å¦æ¥åœ°ï¼ˆFlying ç±»å‹æˆ– Levitate ç‰¹æ€§ä¸å—å½±å“ï¼‰
            const targetAbility = (p.ability || '').toLowerCase().replace(/[^a-z]/g, '');
            const targetIsGrounded = !p.types?.includes('Flying') && targetAbility !== 'levitate';
            if (targetIsGrounded) {
                log(`<span style="color:#9b59b6">ğŸ”® ${p.cnName} è¢«ç²¾ç¥åœºåœ°ä¿æŠ¤äº†ï¼å…ˆåˆ¶æŠ€èƒ½æ— æ•ˆï¼</span>`);
                console.log(`[PSYCHIC TERRAIN] ${e.cnName} çš„å…ˆåˆ¶æŠ€èƒ½ ${move.name} (priority=${movePriorityE}, target=${moveTargetE}) è¢«ç²¾ç¥åœºåœ°é˜»æ­¢`);
                return { pivot: false };
            }
        }
    }
    // === ã€å®˜æ–¹æœºåˆ¶ã€‘åœ¨å°è¯•å‡ºæ‹›æ—¶ç«‹å³æ¸…é™¤åŒå‘½/æ€¨æ¨çŠ¶æ€ ===
    // ä¸ç®¡è¿™å›åˆç”¨ä»€ä¹ˆæ‹›ï¼ˆæ”»å‡»/å˜åŒ–/å®ˆä½ï¼‰ï¼Œåªè¦å¼€å§‹è¡ŒåŠ¨å°±æ¸…é™¤
    if (e.volatile && e.volatile.destinyBond) {
        delete e.volatile.destinyBond;
        console.log(`[DESTINY BOND CLEAR] ${e.cnName} å°è¯•å‡ºæ‹›ï¼ŒåŒå‘½çŠ¶æ€æ¸…é™¤`);
    }
    if (e.volatile && e.volatile.grudge) {
        delete e.volatile.grudge;
        console.log(`[GRUDGE CLEAR] ${e.cnName} å°è¯•å‡ºæ‹›ï¼Œæ€¨æ¨çŠ¶æ€æ¸…é™¤`);
    }
    const moveName = move.cn || move.name || 'Unknown';
    log(`[${e.cnName}] ä½¿å‡º <b>${moveName}</b>!`);
    await wait(500);
    const result = applyDamage(e, p, move, 'player-sprite');
    // è®°å½•æœ¬å›åˆä½¿ç”¨çš„æŠ€èƒ½
    e.lastMoveUsed = move.name;
    // ã€Gen7åŒå‘½æœºåˆ¶ã€‘ä½¿ç”¨å…¶ä»–æ‹›å¼æ—¶æ¸…é™¤åŒå‘½æˆåŠŸæ ‡è®°ï¼Œé‡ç½®è¿é”
    if (move.name !== 'Destiny Bond') {
        e.lastDestinyBondSuccess = false;
    }
    // ã€æ€¨æ¨åŒç†ã€‘
    if (move.name !== 'Grudge') {
        e.lastGrudgeSuccess = false;
    }
    // ã€çè—(Last Resort)æ”¯æŒã€‘è¿½è¸ªæ‰€æœ‰æˆåŠŸä½¿ç”¨è¿‡çš„æ‹›å¼
    if (!result?.failed) {
        if (!e.usedMoves) e.usedMoves = new Set();
        e.usedMoves.add(move.name);
    }
    // =========================================================
    // Choice é“å…·é”æ‹›ï¼ˆè®²ç©¶å¤´å¸¦/çœ¼é•œ/å›´å·¾ï¼‰
    // =========================================================
    const eItem = e.item || '';
    const eIsChoiceItem = eItem.includes('Choice') || eItem.includes('è®²ç©¶');
    if (eIsChoiceItem && !e.choiceLockedMove) {
        e.choiceLockedMove = move.name;
        console.log(`[CHOICE] ${e.name} è¢« ${eItem} é”å®šåœ¨ ${move.name}`);
    }
    // =========================================================
    // Z-Move / Max Move ä½¿ç”¨æ ‡è®° (å…¨åœºåªèƒ½ç”¨ä¸€æ¬¡)
    // =========================================================
    const eMoveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const eMoveData = (typeof MOVES !== 'undefined' && MOVES[eMoveId]) ? MOVES[eMoveId] : {};
    // æ£€æµ‹å¹¶æ ‡è®° Z æ‹›å¼ä½¿ç”¨
    const eIsZMove = eMoveData.isZ || move.isZ ||
        (eMoveData.pp === 1 && eMoveData.basePower >= 100 && eMoveData.isNonstandard === 'Past');
    if (eIsZMove && !battle.enemyZUsed) {
        battle.enemyZUsed = true;
        console.log(`[Z-MOVE] æ•Œæ–¹ä½¿ç”¨äº† Z æ‹›å¼: ${move.name}ï¼Œæœ¬åœºä¸å¯å†ç”¨`);
        log(`<b style="color:#fbbf24; text-shadow: 0 0 10px #fbbf24;">âœ¨ Z-POWER UNLEASHED âœ¨</b>`);
        log(`<span style="color:#fbbf24">${e.cnName} é‡Šæ”¾äº†å…¨éƒ¨çš„ Z åŠ›é‡ï¼</span>`);
    }
    // æ£€æµ‹å¹¶æ ‡è®°æå·¨æ‹›å¼ä½¿ç”¨
    const eIsMaxMove = eMoveData.isMax || 
        (move.name || '').startsWith('Max ') || (move.name || '').startsWith('G-Max ');
    if (eIsMaxMove && !battle.enemyMaxUsed) {
        battle.enemyMaxUsed = true;
        console.log(`[MAX MOVE] æ•Œæ–¹ä½¿ç”¨äº†æå·¨æ‹›å¼: ${move.name}ï¼Œæœ¬åœºä¸å¯å†ç”¨`);
    }
    updateAllVisuals();
    // ã€å·²ç§»é™¤ã€‘æ—§çš„æ‹›å¼æ‰§è¡Œåæ¸…é™¤é€»è¾‘
    // ç°åœ¨åŒå‘½/æ€¨æ¨çŠ¶æ€åœ¨"å°è¯•å‡ºæ‹›æ—¶"ç«‹å³æ¸…é™¤ï¼ˆè§ä¸Šæ–¹ä»£ç ï¼‰
    console.log('[executeEnemyTurn] Completed');
    return { 
        pivot: result?.pivot || false,
        passBoosts: result?.passBoosts || false  // ã€Baton Passã€‘ä¼ é€’èƒ½åŠ›å˜åŒ–æ ‡è®°
    };
}
// ============================================
// ç‹¬ç«‹æ•Œæ–¹å›åˆ
// ============================================
/**
 * ç‹¬ç«‹æ•Œæ–¹å›åˆ (ç”¨äºæ¢äººåæ•Œæ–¹æ”»å‡»)
 */
export async function enemyTurn() {
    const battle = window.battle;
    const p = battle.getPlayer();
    const e = battle.getEnemy();
    if (!e || !e.isAlive()) {
        battle.locked = false;
        return;
    }
    // è·å–æ•Œæ–¹ AI å†³ç­–
    let move = null;
    let enemyAction = null;
    if (typeof window.getAiAction === 'function') {
        enemyAction = window.getAiAction(e, p, battle.aiDifficulty || 'normal', battle.enemyParty, {
            turnCount: battle.turnCount || 1
        });
    }
    // å¤„ç† AI æ¢äººå†³ç­–
    if (enemyAction && enemyAction.type === 'switch' && typeof enemyAction.index === 'number') {
        const switchTarget = battle.enemyParty[enemyAction.index];
        if (switchTarget && switchTarget.isAlive() && switchTarget !== e) {
            log(`<span style="color:#ef4444">æ•Œæ–¹æ”¶å›äº† ${e.cnName}ï¼</span>`);
            if (e.choiceLockedMove) {
                console.log(`[CHOICE] ${e.name} æ¢ä¸‹ï¼Œè§£é™¤ ${e.choiceLockedMove} é”å®š`);
                delete e.choiceLockedMove;
            }
            if (e.isDynamaxed && typeof window.applyDynamaxState === 'function') {
                console.log(`[SWITCH] Enemy ${e.name} was Dynamaxed, restoring moves`);
                window.applyDynamaxState(e, false);
            }
            if (typeof e.resetBoosts === 'function') {
                e.resetBoosts();
            }
            battle.enemyActive = enemyAction.index;
            const newE = battle.getEnemy();
            log(`<span style="color:#ef4444">æ•Œæ–¹æ´¾å‡ºäº† ${newE.cnName}ï¼</span>`);
            // ã€æ ‡è®°æ¢äººã€‘ç”¨äºé‡å¤ç²¾çµå›¾ä¿®å¤
            if (typeof window.markEnemySwitch === 'function') {
                window.markEnemySwitch();
            }
            // æ£€æŸ¥è¿›åœºå˜å½¢
            if (typeof window.checkInitTransform === 'function' && newE.needsInitTransform) {
                const result = window.checkInitTransform(newE);
                if (result) {
                    log(`<span style="color:#ef4444">âœ¦ æ•Œæ–¹ ${result.oldName} å˜ä¸º ${result.newName}ï¼</span>`);
                }
            }
            updateAllVisuals('enemy');
            if (typeof window.triggerEntryAbilities === 'function') {
                window.triggerEntryAbilities(newE, p);
            }
            // ç»“ç®—æ•Œæ–¹åœºåœ°é’‰å­ä¼¤å®³
            if (typeof MoveEffects !== 'undefined' && MoveEffects.applyEntryHazards) {
                const hazardLogs = MoveEffects.applyEntryHazards(newE, false, battle);
                hazardLogs.forEach(msg => log(msg));
                if (hazardLogs.length > 0) updateAllVisuals();
            }
            battle.locked = false;
            return;
        }
    }
    // æ™®é€šæ”»å‡»
    if (enemyAction && enemyAction.move) {
        move = enemyAction.move;
    }
    // å›é€€åˆ°æ—§ AI
    if (!move && typeof window.getAiMove === 'function') {
        move = window.getAiMove(e, p, battle.aiDifficulty || 'normal');
    }
    if (!move) {
        move = e.moves[Math.floor(Math.random() * e.moves.length)];
    }
    // æ‰§è¡Œæ•Œæ–¹å›åˆ
    await executeEnemyTurn(e, p, move);
    // æ£€æŸ¥ç©å®¶æ˜¯å¦å€’ä¸‹
    if (!p.isAlive()) {
        if (typeof window.handlePlayerFainted === 'function') {
            await window.handlePlayerFainted(p);
        }
        // ã€ä¿®å¤ã€‘ç©å®¶å€’ä¸‹æ¢äººåï¼Œä»éœ€æ‰§è¡Œå›åˆæœ«ç»“ç®—ï¼ˆæ•Œæ–¹æå·¨åŒ– tick ç­‰ï¼‰
        const newP = battle.getPlayer();
        const currentE = battle.getEnemy();
        if (newP && newP.isAlive() && currentE && currentE.isAlive()) {
            if (typeof window.executeEndPhase === 'function') {
                await window.executeEndPhase(newP, currentE);
            }
        }
        return;
    }
    battle.locked = false;
}
// ============================================
// å›åˆç»“æŸçŠ¶æ€ç»“ç®—
// ============================================
/**
 * å›åˆç»“æŸæ—¶çš„çŠ¶æ€ä¼¤å®³/å›å¤ç»“ç®—
 * @param {Pokemon} poke è¦ç»“ç®—çš„å®å¯æ¢¦
 * @param {Pokemon} opponent å¯¹æ‰‹å®å¯æ¢¦ï¼ˆç”¨äºå¯„ç”Ÿç§å­å¸è¡€ï¼‰
 * @param {boolean} isPlayerPoke æ˜¯å¦ä¸ºç©å®¶æ–¹çš„å®å¯æ¢¦ï¼ˆAVs æ•ˆæœåªå¯¹ç©å®¶æ–¹ç”Ÿæ•ˆï¼‰
 * @returns {Array} logs
 */
export function getEndTurnStatusLogs(poke, opponent, isPlayerPoke = false) {
    let logs = [];
    if (!poke || !poke.isAlive()) return logs;
    // ----------------------------------------
    // 1. ç¼ä¼¤ (Burn): æ‰£ 1/16 HP
    // ----------------------------------------
    if (poke.status === 'brn') {
        const dmg = Math.max(1, Math.floor(poke.maxHp / 16));
        poke.takeDamage(dmg);
        logs.push(`${poke.cnName} å—åˆ°ç¼ä¼¤çš„ä¼¤å®³! (-${dmg})`);
    }
    // ----------------------------------------
    // 2. ä¸­æ¯’ (Poison): æ‰£ 1/8 HP
    // ã€ä¿®å¤ã€‘æ£€æŸ¥ Poison Heal (æ¯’ç–—) ç‰¹æ€§
    // ----------------------------------------
    if (poke.status === 'psn' || poke.status === 'tox') {
        const pokeAbilityId = (poke.ability || '').toLowerCase().replace(/[^a-z]/g, '');
        // æ£€æŸ¥æ¯’ç–—ç‰¹æ€§
        if (pokeAbilityId === 'poisonheal') {
            // æ¯’ç–—ï¼šå›å¤ 1/8 HP
            const baseHeal = Math.max(1, Math.floor(poke.maxHp / 8));
            let actualHeal = baseHeal;
            if (typeof poke.heal === 'function') {
                actualHeal = poke.heal(baseHeal);
            } else {
                poke.currHp = Math.min(poke.maxHp, poke.currHp + baseHeal);
            }
            logs.push(`<span style="color:#4cd137">ğŸ’š ${poke.cnName} çš„æ¯’ç–—ç‰¹æ€§å‘åŠ¨ï¼Œå›å¤äº† ${actualHeal} ç‚¹ä½“åŠ›!</span>`);
        } else {
            // æ­£å¸¸ä¸­æ¯’ä¼¤å®³
            const dmg = Math.max(1, Math.floor(poke.maxHp / 8));
            poke.takeDamage(dmg);
            if (poke.status === 'tox') {
                logs.push(`${poke.cnName} å—åˆ°å‰§æ¯’çš„ä¼¤å®³! (-${dmg})`);
            } else {
                logs.push(`${poke.cnName} å—åˆ°æ¯’ç´ çš„ä¼¤å®³! (-${dmg})`);
            }
        }
    }
    // ----------------------------------------
    // 3. å¯„ç”Ÿç§å­ (Leech Seed): è¢«å¯¹æ–¹å¸è¡€ 1/8
    // ----------------------------------------
    if (poke.volatile && poke.volatile['leechseed'] && opponent && opponent.isAlive()) {
        const baseDrain = Math.max(1, Math.floor(poke.maxHp / 8));
        let actualHeal = baseDrain;
        // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘å¸è¡€æ•ˆç‡ä¿®æ­£
        if (typeof window !== 'undefined' && window.envOverlay) {
            const drainMod = window.envOverlay.getDrainMod(opponent, null);
            if (drainMod !== 1) {
                actualHeal = Math.max(1, Math.floor(baseDrain * drainMod));
                console.log(`[ENV OVERLAY] å¯„ç”Ÿç§å­å¸è¡€æ•ˆç‡ä¿®æ­£: ${baseDrain} Ã— ${drainMod} = ${actualHeal}`);
            }
        }
        poke.takeDamage(baseDrain);
        opponent.heal(actualHeal);
        if (actualHeal !== baseDrain) {
            logs.push(`${poke.cnName} çš„ä½“åŠ›è¢«å¯„ç”Ÿç§å­å¸å–äº†! (-${baseDrain}, å›å¤${actualHeal})`);
        } else {
            logs.push(`${poke.cnName} çš„ä½“åŠ›è¢«å¯„ç”Ÿç§å­å¸å–äº†! (-${baseDrain})`);
        }
    }
    // ----------------------------------------
    // 4. æŸç¼šçŠ¶æ€ (Bind / Whirlpool / Fire Spin) -> æ‰£ 1/8
    // ----------------------------------------
    if (poke.volatile && poke.volatile['partiallytrapped']) {
        const dmg = Math.max(1, Math.floor(poke.maxHp / 8));
        poke.takeDamage(dmg);
        logs.push(`${poke.cnName} å› æŸç¼šè€Œå—åˆ°ä¼¤å®³! (-${dmg})`);
    }
    // ----------------------------------------
    // 5. è¯…å’’ (Curse - Ghostä½¿ç”¨): æ¯å›åˆæ‰£ 1/4
    // ----------------------------------------
    if (poke.volatile && poke.volatile['curse']) {
        const dmg = Math.max(1, Math.floor(poke.maxHp / 4));
        poke.takeDamage(dmg);
        logs.push(`${poke.cnName} å—åˆ°äº†è¯…å’’! (-${dmg})`);
    }
    // ----------------------------------------
    // 5.5 ç›è…Œ (Salt Cure): æ¯å›åˆæ‰£ 1/8 HPï¼Œæ°´/é’¢ç³»æ‰£ 1/4
    // ã€Gen 9ã€‘ç›çŸ³å·¨çµæ ¸å¿ƒæ‹›å¼
    // ----------------------------------------
    if (poke.volatile && poke.volatile['saltcure']) {
        // æ£€æŸ¥æ˜¯å¦ä¸ºæ°´ç³»æˆ–é’¢ç³»
        const isWaterOrSteel = poke.types && (poke.types.includes('Water') || poke.types.includes('Steel'));
        const dmgRatio = isWaterOrSteel ? 4 : 8; // æ°´/é’¢ç³» 1/4ï¼Œå…¶ä»– 1/8
        const dmg = Math.max(1, Math.floor(poke.maxHp / dmgRatio));
        poke.takeDamage(dmg);
        if (isWaterOrSteel) {
            logs.push(`<span style="color:#9b59b6">ğŸ§‚ ${poke.cnName} å› ç›è…Œå—åˆ°äº†ä¸¥é‡ä¼¤å®³! (-${dmg})</span>`);
        } else {
            logs.push(`<span style="color:#9b59b6">ğŸ§‚ ${poke.cnName} å› ç›è…Œå—åˆ°ä¼¤å®³! (-${dmg})</span>`);
        }
    }
    // ----------------------------------------
    // 6. å“ˆæ¬  (Yawn): å€’è®¡æ—¶ï¼Œæ—¶é—´åˆ°ç¡ç€
    // ã€ä¿®å¤ã€‘ä½¿ç”¨ tryInflictStatus è¿›è¡Œç‰¹æ€§/åœºåœ°å…ç–«æ£€æŸ¥
    // ----------------------------------------
    if (poke.volatile && poke.volatile['yawn']) {
        poke.volatile['yawn'] -= 1;
        if (poke.volatile['yawn'] <= 0) {
            delete poke.volatile['yawn'];
            if (!poke.status) {
                // ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥ç”µæ°”åœºåœ°é˜²ç¡
                const battle = window.battle;
                const currentTerrain = battle?.terrain;
                const pokeAbility = (poke.ability || '').toLowerCase().replace(/[^a-z]/g, '');
                const isGrounded = !poke.types?.includes('Flying') && pokeAbility !== 'levitate';
                if (currentTerrain === 'electricterrain' && isGrounded) {
                    logs.push(`ç”µæ°”åœºåœ°ä¿æŠ¤äº† ${poke.cnName}ï¼Œæ— æ³•å…¥ç¡ï¼`);
                } else if (typeof MoveEffects !== 'undefined' && MoveEffects.tryInflictStatus) {
                    // ä½¿ç”¨ tryInflictStatus æ£€æŸ¥ç‰¹æ€§å…ç–«ï¼ˆä¸çœ /å¹²åŠ²/ç»å¯¹ç¡çœ ç­‰ï¼‰
                    const result = MoveEffects.tryInflictStatus(poke, 'slp', null, battle);
                    if (result.success) {
                        poke.sleepTurns = Math.floor(Math.random() * 3) + 2;
                        logs.push(`${poke.cnName} çš„ç¡æ„è¢­æ¥äº†! -> ç¡ç€äº†!`);
                    } else {
                        logs.push(result.message || `${poke.cnName} æ— æ³•å…¥ç¡ï¼`);
                    }
                } else {
                    // å›é€€é€»è¾‘ï¼šç›´æ¥è®¾ç½®ç¡çœ 
                    poke.status = 'slp';
                    poke.sleepTurns = Math.floor(Math.random() * 3) + 2;
                    logs.push(`${poke.cnName} çš„ç¡æ„è¢­æ¥äº†! -> ç¡ç€äº†!`);
                }
            }
        } else {
            logs.push(`${poke.cnName} æ›´åŠ å›°å€¦äº†...`);
        }
    }
    // ----------------------------------------
    // 7. æ°´æµç¯ (Aqua Ring): æ¯å›åˆå›å¤ 1/16 HP
    // ----------------------------------------
    if (poke.volatile && poke.volatile.aquaring) {
        const heal = Math.max(1, Math.floor(poke.maxHp / 16));
        poke.heal(heal);
        logs.push(`${poke.cnName} çš„æ°´æµç¯æ¢å¤äº†ä½“åŠ›! (+${heal})`);
    }
    // ----------------------------------------
    // 8. æ‰æ ¹ (Ingrain): æ¯å›åˆå›å¤ 1/16 HP
    // ----------------------------------------
    if (poke.volatile && poke.volatile.ingrain) {
        const heal = Math.max(1, Math.floor(poke.maxHp / 16));
        poke.heal(heal);
        logs.push(`${poke.cnName} ä»åœ°é¢å¸æ”¶äº†å…»åˆ†! (+${heal})`);
    }
    // ----------------------------------------
    // 8.5 ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘HP è·³åŠ¨ + çŠ¶æ€æ²»æ„ˆ
    // ----------------------------------------
    if (typeof window !== 'undefined' && window.envOverlay) {
        const envResult = window.envOverlay.processTurnEnd(poke);
        // HP å˜åŒ–
        if (envResult.hpChange !== 0) {
            if (envResult.hpChange > 0) {
                poke.heal(envResult.hpChange);
            } else {
                poke.takeDamage(Math.abs(envResult.hpChange));
            }
        }
        // çŠ¶æ€æ²»æ„ˆ
        if (envResult.curedStatus) {
            poke.status = null;
            poke.statusTurns = 0;
        }
        // è¾“å‡ºæ—¥å¿—
        envResult.logs.forEach(log => logs.push(`<span style="color:#a855f7">ğŸŒ ${log}</span>`));
    }
    // ----------------------------------------
    // 9. å¤©æ°”ä¼¤å®³ (Weather Damage)
    // ã€é‡æ„ã€‘ä½¿ç”¨ weather-effects.js æ¨¡å—
    // ----------------------------------------
    const battle = window.battle;
    const currentWeather = battle ? battle.weather : null;
    if (currentWeather && typeof window.WeatherEffects !== 'undefined') {
        // ä½¿ç”¨æ–°æ¨¡å—è®¡ç®—å¤©æ°”ä¼¤å®³
        const weatherDmg = window.WeatherEffects.getWeatherDamage(poke, currentWeather);
        if (weatherDmg > 0) {
            poke.takeDamage(weatherDmg);
            const weatherLog = window.WeatherEffects.getWeatherDamageLog(poke, currentWeather, weatherDmg);
            logs.push(weatherLog);
        }
    } else if (currentWeather) {
        // Fallback: æ—§é€»è¾‘ï¼ˆä»…åœ¨æ¨¡å—æœªåŠ è½½æ—¶ä½¿ç”¨ï¼‰
        const pokeAbility = (poke.ability || '').toLowerCase().replace(/[^a-z]/g, '');
        const hasMagicGuard = pokeAbility === 'magicguard';
        const hasOvercoat = pokeAbility === 'overcoat';
        const pokeItem = (poke.item || '').toLowerCase().replace(/[^a-z]/g, '');
        const hasSafetyGoggles = pokeItem === 'safetygoggles';
        if (!hasMagicGuard && !hasOvercoat && !hasSafetyGoggles) {
            if (currentWeather === 'sandstorm') {
                const immuneToSand = poke.types && (poke.types.includes('Rock') || poke.types.includes('Ground') || poke.types.includes('Steel'));
                const sandAbilityImmune = ['sandveil', 'sandforce', 'sandrush'].includes(pokeAbility);
                if (!immuneToSand && !sandAbilityImmune) {
                    const dmg = Math.max(1, Math.floor(poke.maxHp / 16));
                    poke.takeDamage(dmg);
                    logs.push(`${poke.cnName} å—åˆ°æ²™æš´çš„ä¼¤å®³! (-${dmg})`);
                }
            }
        }
    }
    // ----------------------------------------
    // 10. å¤©æ°”ç›¸å…³ç‰¹æ€§å›åˆæœ«æ•ˆæœ
    // ----------------------------------------
    const pokeAbilityForWeather = (poke.ability || '').toLowerCase().replace(/[^a-z]/g, '');
    const currentWeatherForAbility = battle?.weather;
    // ã€æ¹¿æ¶¦ä¹‹èº¯ Hydrationã€‘é›¨å¤©æ—¶å›åˆæœ«æ²»æ„ˆæ‰€æœ‰å¼‚å¸¸çŠ¶æ€
    // ã€å¤©æ°”ç»Ÿä¸€ã€‘æ ‡å‡†å€¼: rain, æç«¯å€¼: heavyrain
    if (pokeAbilityForWeather === 'hydration' && poke.status) {
        const isRainy = currentWeatherForAbility === 'rain' || currentWeatherForAbility === 'heavyrain';
        if (isRainy) {
            const oldStatus = poke.status;
            const statusNames = { slp: 'ç¡çœ ', psn: 'ä¸­æ¯’', tox: 'å‰§æ¯’', brn: 'ç¼ä¼¤', par: 'éº»ç—¹', frz: 'å†°å†»' };
            poke.status = null;
            poke.statusTurns = 0;
            poke.sleepTurns = 0;
            logs.push(`<span style="color:#3498db">ğŸ’§ ${poke.cnName} çš„æ¹¿æ¶¦ä¹‹èº¯å‘åŠ¨ï¼Œ${statusNames[oldStatus] || 'å¼‚å¸¸çŠ¶æ€'}ç—Šæ„ˆäº†!</span>`);
        }
    }
    // ã€èœ•çš® Shed Skinã€‘æ¯å›åˆ 30% æ¦‚ç‡æ²»æ„ˆå¼‚å¸¸çŠ¶æ€
    if (pokeAbilityForWeather === 'shedskin' && poke.status) {
        if (Math.random() < 0.30) {
            const oldStatus = poke.status;
            const statusNames = { slp: 'ç¡çœ ', psn: 'ä¸­æ¯’', tox: 'å‰§æ¯’', brn: 'ç¼ä¼¤', par: 'éº»ç—¹', frz: 'å†°å†»' };
            poke.status = null;
            poke.statusTurns = 0;
            poke.sleepTurns = 0;
            logs.push(`<span style="color:#9b59b6">âœ¨ ${poke.cnName} çš„èœ•çš®å‘åŠ¨ï¼Œ${statusNames[oldStatus] || 'å¼‚å¸¸çŠ¶æ€'}ç—Šæ„ˆäº†!</span>`);
        }
    }
    // ã€å†°å†»ä¹‹èº¯ Ice Bodyã€‘å†°é›¹/é›ªå¤©æ—¶å›å¤ 1/16 HP
    // ã€å¤©æ°”ç»Ÿä¸€ã€‘å…¼å®¹ hail å’Œ snow
    if (pokeAbilityForWeather === 'icebody' && (currentWeatherForAbility === 'hail' || currentWeatherForAbility === 'snow')) {
        if (poke.currHp < poke.maxHp) {
            const healAmount = Math.max(1, Math.floor(poke.maxHp / 16));
            poke.heal(healAmount);
            logs.push(`<span style="color:#74b9ff">${poke.cnName} çš„å†°å†»ä¹‹èº¯æ¢å¤äº† ${healAmount} ç‚¹ä½“åŠ›!</span>`);
        }
    }
    // ã€å¹²ç‡¥çš®è‚¤ Dry Skinã€‘é›¨å¤©å›å¤ 1/8 HPï¼Œæ™´å¤©æ‰£ 1/8 HP
    // ã€å¤©æ°”ç»Ÿä¸€ã€‘æ ‡å‡†å€¼: rain/sun, æç«¯å€¼: heavyrain/harshsun
    if (pokeAbilityForWeather === 'dryskin') {
        const isRainyDry = currentWeatherForAbility === 'rain' || currentWeatherForAbility === 'heavyrain';
        const isSunnyDry = currentWeatherForAbility === 'sun' || currentWeatherForAbility === 'harshsun';
        if (isRainyDry) {
            if (poke.currHp < poke.maxHp) {
                const healAmount = Math.max(1, Math.floor(poke.maxHp / 8));
                poke.heal(healAmount);
                logs.push(`<span style="color:#3498db">${poke.cnName} çš„å¹²ç‡¥çš®è‚¤åœ¨é›¨ä¸­æ¢å¤äº† ${healAmount} ç‚¹ä½“åŠ›!</span>`);
            }
        } else if (isSunnyDry) {
            const dmg = Math.max(1, Math.floor(poke.maxHp / 8));
            poke.takeDamage(dmg);
            logs.push(`<span style="color:#e74c3c">${poke.cnName} çš„å¹²ç‡¥çš®è‚¤åœ¨é˜³å…‰ä¸‹å—åˆ°äº† ${dmg} ç‚¹ä¼¤å®³!</span>`);
        }
    }
    // ã€é›¨ç›˜ Rain Dishã€‘é›¨å¤©å›å¤ 1/16 HP
    // ã€å¤©æ°”ç»Ÿä¸€ã€‘æ ‡å‡†å€¼: rain, æç«¯å€¼: heavyrain
    if (pokeAbilityForWeather === 'raindish') {
        const isRainyDish = currentWeatherForAbility === 'rain' || currentWeatherForAbility === 'heavyrain';
        if (isRainyDish) {
            if (poke.currHp < poke.maxHp) {
                const healAmount = Math.max(1, Math.floor(poke.maxHp / 16));
                poke.heal(healAmount);
                logs.push(`<span style="color:#3498db">${poke.cnName} çš„é›¨ç›˜æ¢å¤äº† ${healAmount} ç‚¹ä½“åŠ›!</span>`);
            }
        }
    }
    // ã€å¤ªé˜³ä¹‹åŠ› Solar Powerã€‘æ™´å¤©æ—¶å›åˆæœ«æ‰£ 1/8 HPï¼ˆç‰¹æ”»åŠ æˆåœ¨ onModifyStat ä¸­å¤„ç†ï¼‰
    // ã€å¤©æ°”ç»Ÿä¸€ã€‘æ ‡å‡†å€¼: sun, æç«¯å€¼: harshsun
    if (pokeAbilityForWeather === 'solarpower') {
        const isSunnySolar = currentWeatherForAbility === 'sun' || currentWeatherForAbility === 'harshsun';
        if (isSunnySolar) {
            const dmg = Math.max(1, Math.floor(poke.maxHp / 8));
            poke.takeDamage(dmg);
            logs.push(`<span style="color:#f39c12">â˜€ï¸ ${poke.cnName} çš„å¤ªé˜³ä¹‹åŠ›åœ¨é˜³å…‰ä¸‹æ¶ˆè€—äº† ${dmg} ç‚¹ä½“åŠ›!</span>`);
        }
    }
    // ã€æ”¶è· Harvestã€‘å›åˆæœ«å›æ”¶å·²ä½¿ç”¨çš„æ ‘æœï¼ˆæ™´å¤© 100%ï¼Œå…¶ä»– 50%ï¼‰
    if (pokeAbilityForWeather === 'harvest' && poke.usedBerry && !poke.item) {
        const isSunnyHarvest = currentWeatherForAbility === 'sun' || currentWeatherForAbility === 'harshsun';
        const harvestChance = isSunnyHarvest ? 1.0 : 0.5;
        if (Math.random() < harvestChance) {
            poke.item = poke.usedBerry;
            logs.push(`<span style="color:#27ae60">ğŸ‡ ${poke.cnName} çš„æ”¶è·ç‰¹æ€§å›æ”¶äº† ${poke.usedBerry}!</span>`);
            // ã€å…³é”®ã€‘è·å¾—é“å…·åå–æ¶ˆ Unburden æ•ˆæœ
            if (poke.unburdenActive) {
                poke.unburdenActive = false;
                console.log(`[HARVEST -> UNBURDEN] ${poke.cnName} å›æ”¶é“å…·ï¼Œè½»è£…æ•ˆæœè§£é™¤`);
            }
            poke.usedBerry = null;
            // ã€å…³é”®ä¿®å¤ã€‘å›æ”¶åç«‹å³æ£€æŸ¥æ˜¯å¦æ»¡è¶³åƒæœå­æ¡ä»¶
            if (typeof ItemEffects !== 'undefined' && ItemEffects.checkHPBerry) {
                let berryLogs = [];
                const berryTriggered = ItemEffects.checkHPBerry(poke, berryLogs, opponent);
                if (berryTriggered) {
                    berryLogs.forEach(txt => logs.push(txt));
                    console.log(`[HARVEST] ${poke.cnName} å›æ”¶åç«‹å³åƒæ‰äº†æœå­`);
                }
            }
        }
    }
    // ã€ååˆ Cud Chewã€‘å›åˆæœ«å†åƒä¸€æ¬¡ä¸Šå›åˆçš„æ ‘æœ
    if (pokeAbilityForWeather === 'cudchew' && poke.cudChewBerry) {
        if (poke.cudChewReady) {
            // è§¦å‘æ ‘æœæ•ˆæœ
            const berry = poke.cudChewBerry;
            logs.push(`<b style="color:#27ae60">ğŸ„ ${poke.cnName} çš„ååˆç‰¹æ€§å‘åŠ¨ï¼å†æ¬¡äº«ç”¨äº† ${berry} çš„æ•ˆæœï¼</b>`);
            // æ ¹æ®æ ‘æœç±»å‹è§¦å‘æ•ˆæœ
            if (typeof window.triggerBerryEffect === 'function') {
                window.triggerBerryEffect(poke, berry, logs);
            } else {
                // ç®€åŒ–ç‰ˆï¼šç›´æ¥å›å¤ HPï¼ˆå¤§éƒ¨åˆ†æ ‘æœéƒ½æ˜¯å›å¤ç±»ï¼‰
                const itemId = berry.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (itemId === 'sitrusberry') {
                    const baseHeal = Math.floor(poke.maxHp * 0.25);
                    let actualHeal = baseHeal;
                    if (typeof poke.heal === 'function') {
                        actualHeal = poke.heal(baseHeal);
                    } else {
                        poke.currHp = Math.min(poke.maxHp, poke.currHp + baseHeal);
                    }
                    logs.push(`<span style="color:#27ae60">å›å¤äº† ${actualHeal} ç‚¹ä½“åŠ›ï¼</span>`);
                }
            }
            poke.cudChewBerry = null;
            poke.cudChewReady = false;
        } else {
            // æ ‡è®°ä¸‹å›åˆå¯ä»¥è§¦å‘
            poke.cudChewReady = true;
        }
    }
    // =====================================================
    // === AVs: Devotion (çŒ®èº«) - çŠ¶æ€æ²»æ„ˆ + æ®‹è¡€å›å¤ ===
    // =====================================================
    // ã€çº¿æ€§æœºåˆ¶ã€‘æ¦‚ç‡ = (effectiveDevotion / 255) * 0.35
    // æ»¡å€¼ 255 æ—¶çº¦ 35% æ¦‚ç‡ï¼Œ100 æ—¶çº¦ 14% æ¦‚ç‡
    // åªæœ‰ã€ç©å®¶æ–¹ã€‘çš„ isAce=true å®å¯æ¢¦æ‰èƒ½è§¦å‘ AVs è¢«åŠ¨
    // ã€Ambrosiaã€‘ç¥ä¹‹ç¼æµ†å¤©æ°”ä¸‹ AVS è§¦å‘ç‡ x2
    if (isPlayerPoke && poke.isAce && poke.avs) {
        const baseDevotion = poke.getEffectiveAVs ? poke.getEffectiveAVs('devotion') : poke.avs.devotion;
        // ã€å…¨å±€å¼€å…³ã€‘AVS å…³é—­æ—¶ getEffectiveAVs è¿”å› 0ï¼Œè·³è¿‡è®¡ç®—
        if (baseDevotion > 0) {
            const effectiveDevotion = poke.avsEvolutionBoost ? baseDevotion * 2 : baseDevotion;
            const hpRatio = poke.currHp / poke.maxHp;
            const isCritical = hpRatio <= 0.30;
            // çº¿æ€§æ¦‚ç‡è®¡ç®—ï¼šæ»¡å€¼ 35%ï¼Œæ— ä¿åº•ï¼ˆä½ AVS å°±æ˜¯ä½æ¦‚ç‡ï¼‰
            // Devotion 10 â†’ 1.37%, Devotion 100 â†’ 13.7%, Devotion 255 â†’ 35%
            let baseChance = (effectiveDevotion / 255) * 0.35;
            // ã€Ambrosia ç¥ä¹‹ç¼æµ†ã€‘AVS è§¦å‘ç‡ x2
            if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.getAVSMultiplier) {
                const currentWeather = battle?.weather || '';
                const avsMultiplier = window.WeatherEffects.getAVSMultiplier(currentWeather);
                if (avsMultiplier > 1) {
                    baseChance *= avsMultiplier;
                    baseChance = Math.min(baseChance, 1.0); // ä¸Šé™ 100%
                    console.log(`[AMBROSIA] ğŸ’« ç¥ä¹‹ç¼æµ†ï¼šDevotion è§¦å‘ç‡ x${avsMultiplier}`);
                }
            }
            // åˆå§‹åŒ–å…¨å±€è§¦å‘æ ‡è®°
            if (!poke.avsTriggered) poke.avsTriggered = {};
            if (poke.devotionStatusTriggered === undefined) poke.devotionStatusTriggered = -1;
            const currentTurn = battle && battle.turn ? battle.turn : 0;
            // ã€è§¦å‘æ¡ä»¶ 1ã€‘æœ‰å¼‚å¸¸çŠ¶æ€ â†’ æ¸…é™¤å¼‚å¸¸ + å›å¤ 15% HP
            if (poke.status && poke.devotionStatusTriggered !== currentTurn) {
                if (Math.random() < baseChance) {
                    const oldStatus = poke.status;
                    poke.status = null;
                    poke.sleepTurns = 0;
                    const healAmount = Math.floor(poke.maxHp * 0.15);
                    poke.heal(healAmount);
                    logs.push(`<b style="color:#e91e63">ğŸ’• ${poke.cnName} ä¸ºäº†ä¸è®©è®­ç»ƒå®¶æ‹…å¿ƒï¼Œæ²»å¥½äº†è‡ªå·±çš„${oldStatus}ï¼å›å¤äº† ${healAmount} HPï¼(Devotion: ${baseDevotion}${poke.avsEvolutionBoost ? ' x2' : ''})</b>`);
                    poke.devotionStatusTriggered = currentTurn;
                    console.log(`[AVs] Devotion çŠ¶æ€æ²»æ„ˆè§¦å‘ (Chance: ${Math.round(baseChance * 100)}%, Devotion: ${baseDevotion})`);
                }
            }
            // ã€è§¦å‘æ¡ä»¶ 2ã€‘æ®‹è¡€ï¼ˆâ‰¤30%ï¼‰â†’ å›å¤ 35% HPï¼ˆå…¨å±€åªèƒ½è§¦å‘ä¸€æ¬¡ï¼‰
            // å±æœºçˆ†å‘æ¦‚ç‡ = åŸºç¡€æ¦‚ç‡ * 1.5ï¼ˆè€Œä¸æ˜¯å›ºå®š +15%ï¼‰
            // Devotion 10 â†’ 2.06%, Devotion 100 â†’ 20.6%, Devotion 255 â†’ 52.5%
            if (isCritical && !poke.avsTriggered.devotionCritical) {
                const criticalChance = Math.min(0.60, baseChance * 1.5);
                if (Math.random() < criticalChance) {
                    const healAmount = Math.floor(poke.maxHp * 0.35);
                    poke.heal(healAmount);
                    logs.push(`<b style="color:#e91e63">ğŸ’• ${poke.cnName} çš„çŒ®èº«ä¹‹å¿ƒæ¿€å‘äº†ç”Ÿå‘½åŠ›ï¼å›å¤äº† ${healAmount} HPï¼[å±æœºçˆ†å‘] (Devotion: ${baseDevotion}${poke.avsEvolutionBoost ? ' x2' : ''})</b>`);
                    poke.avsTriggered.devotionCritical = true;
                    console.log(`[AVs] Devotion å±æœºçˆ†å‘è§¦å‘ (Chance: ${Math.round(criticalChance * 100)}%, Devotion: ${baseDevotion})`);
                }
            }
        }
    }
    return logs;
}
// ============================================
// å¯¼å‡º
// ============================================
if (typeof window !== 'undefined') {
    window.onTurnStart = onTurnStart;
    window.executePlayerTurn = executePlayerTurn;
    window.executeEnemyTurn = executeEnemyTurn;
    window.enemyTurn = enemyTurn;
    window.getEndTurnStatusLogs = getEndTurnStatusLogs;
}
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        executePlayerTurn,
        executeEnemyTurn,
        enemyTurn
    };
}
]]></file>
        <file name="battle-weather.js"><![CDATA[/**
 * =============================================
 * Canvas ç²’å­å¤©æ°”ç³»ç»Ÿ v2.0
 * =============================================
 * æ”¯æŒï¼šSmog(N), Ashfall(A), Fog(S), Gale(B), Ambrosia(Boss), Distortion(Rift)
 */
let canvas = null;
let ctx = null;
let particles = [];
let weatherType = 'none';
let animationFrameId = null;
let transitionProgress = 1.0; // 1.0 = å®Œå…¨æ˜¾ç¤ºï¼Œ0.0 = å®Œå…¨éšè—
let isTransitioning = false;
// [ç²’å­é…ç½®å‚æ•°]
const CONFIG = {
    // ---------------- åŸç‰ˆ ----------------
    rain:       { count: 180, speed: 12, angle: 0.1,  color: '120, 160, 230' },
    heavyrain:  { count: 400, speed: 22, angle: 0.15, color: '60, 80, 160' },
    snow:       { count: 300, speed: 2.5,  angle: 0.3,  color: '255, 255, 255' },
    hail:       { count: 120, speed: 9,  angle: 0.1,  color: '200, 220, 255' },
    sand:       { count: 600, speed: 28, angle: -0.2, color: '210, 180, 120' },
    harshsun:   { count: 80,  speed: 0.8, angle: 0,   color: '255, 140, 0' },
    deltastream:{ count: 120, speed: 35, angle: -0.8, color: '80, 255, 200' },
    sun:        { count: 80,  speed: 0.6, angle: 0,   color: '255, 225, 150' },
    // ---------------- N/A/S/B ç‰¹è‰² ----------------
    smog:       { count: 200, speed: -0.5, angle: 0.1, color: '160, 80, 200' }, // NåŒº: æ·±ç´«è‰²æ¯’æ°”
    ashfall:    { count: 500, speed: 4,   angle: 0.2, color: '120, 120, 120' },// AåŒº: ç°è‰²é‡ç«å±±ç°
    fog:        { count: 60,  speed: 0.15, angle: 0.8, color: '235, 240, 250' }, // SåŒº: å·¨å¤§æŸ”è¾¹é›¾å›¢
    gale:       { count: 300, speed: 45,  angle: 0,   color: '180, 230, 255' }, // BåŒº: æé€Ÿé’è‰²é£çº¿
    // ---------------- å‰§æƒ…/BOSS ----------------
    ambrosia:   { count: 150, speed: -1.5, angle: 0,   color: '255, 20, 147' },  // ç²‰è‰²èƒ½é‡ä¸Šæµ®
    distortion: { 
        count: 60,   // ä¸éœ€è¦å¤ªå¤šï¼Œé‡ç‚¹æ˜¯å•ä¸ªç²’å­çš„è´¨é‡
        speed: 0, 
        angle: 0, 
        // èµ›åšéœ“è™¹è‰²ï¼šäº®é’è‰²(æœªæ¥)ã€æ´‹çº¢è‰²(è¿‡å»)ã€çº¯ç™½(æ•°æ®)ã€çŸ³ç°ç»¿(çŸ©é˜µ)
        colors: ['0, 255, 255', '255, 0, 255', '255, 255, 255', '50, 205, 50']
    }
};
class Particle {
    constructor(type, w, h) {
        this.w = w;
        this.h = h;
        this.reset(type);
    }
    reset(type) {
        this.type = type;
        this.x = Math.random() * this.w;
        this.y = Math.random() * this.h;
        this.opacity = Math.random() * 0.5 + 0.1;
        this.size = Math.random() * 2 + 1;
        this.alpha = 1;
        // æ ¹æ®é€»è¾‘è®¾ç½®åˆå§‹é€Ÿåº¦
        /* --- å‚ç›´ä¸‹è½ç³» --- */
        if (['rain', 'heavyrain', 'ashfall'].includes(type)) {
            this.y = Math.random() * -this.h; // ä»å¾ˆå¤©èŠ±æ¿ç”Ÿæˆ
            const cfg = CONFIG[type];
            this.vy = cfg.speed + Math.random() * 2;
            this.vx = (type === 'ashfall') ? Math.random() - 0.5 : (cfg.angle * this.vy); 
            // ç°çƒ¬æ˜¯ç°è‰²çš„æ–¹å—æ„Ÿ
            this.length = (type === 'ashfall') ? Math.random() * 4 + 2 : Math.random() * 20 + 10;
        } 
        /* --- é£˜é›ª/å†°é›¹ è½»ç›ˆç³» --- */
        else if (['snow', 'hail'].includes(type)) {
            this.y = Math.random() * -this.h;
            const cfg = CONFIG[type];
            this.vy = cfg.speed + (type === 'hail' ? Math.random() * 5 : Math.random());
            this.vx = Math.sin(Math.random() * Math.PI) * (type === 'snow' ? 1 : 0.5);
            this.size = (type === 'snow') ? Math.random() * 3 + 1.5 : Math.random() * 3 + 2; 
        } 
        /* --- æ¨ªå‘é«˜é€Ÿä½ç§»ç³» --- */
        else if (['sand', 'deltastream', 'gale'].includes(type)) {
            const cfg = CONFIG[type];
            this.x = Math.random() * this.w + (type !== 'sand' ? 200 : 0);
            this.vx = -cfg.speed - Math.random() * 10; // ä»å³å¾€å·¦å¹
            this.vy = (Math.random() - 0.5) * (type === 'gale' ? 1 : 2); // é£æ¯”è¾ƒç›´
            if (type === 'gale') this.length = Math.random() * 200 + 50; // é£ç—•å¾ˆé•¿
        }
        /* --- æ¼‚æµ®/å‘¼å¸ç³» (Smog, Sun, Ambrosia) --- */
        else if (['harshsun', 'sun', 'smog', 'fog', 'ambrosia'].includes(type)) {
            const cfg = CONFIG[type];
            this.vy = cfg.speed + (Math.random() - 0.5) * 0.5; // Smog/Ambrosia å‘ä¸Šé£˜
            this.vx = (Math.random() - 0.5) * (type === 'fog' ? 0.3 : 1); 
            // Smog åœ†å½¢æ¯’æ°” / Fog å·¨å¤§äº‘é›¾
            if (type === 'smog') {
                this.size = Math.random() * 20 + 10;
                this.opacity = Math.random() * 0.15 + 0.05; // æ·¡æ·¡çš„çƒŸåœˆ
            } else if (type === 'fog') {
                // æš—å½±è¿·é›¾ï¼šå·¨å¤§æŸ”è¾¹é›¾å›¢ï¼Œè¶Šå¤§è¶Šæ·¡
                let scale = Math.random();
                this.size = scale * 180 + 100;  // 100-280px çš„è¶…å¤§ç²’å­
                this.opacity = (1 - scale) * 0.5 + 0.4; // æä½é€æ˜åº¦(0.02-0.08)ï¼Œé å åŠ äº§ç”Ÿæµ“åº¦
                this.vx = (Math.random() - 0.5) * 0.5; // æç¼“æ…¢è •åŠ¨
                this.vy = (Math.random() - 0.5) * 0.15;
                this.isRadialFog = true; // æ ‡è®°ä½¿ç”¨å¾„å‘æ¸å˜æ¸²æŸ“
            } else if (type === 'ambrosia') {
                this.sideOscillation = Math.random() * 100; // å‰åæ‘†åŠ¨ç›¸ä½
            } else if (type === 'sun') {
                this.size = Math.random() * 6 + 2; // æ™®é€šæ—¥ç…§æ›´å¤§çš„å…‰æ–‘
                this.opacity = Math.random() * 0.4 + 0.2;
            } else if (type === 'harshsun') {
                this.size = Math.random() * 7 + 3; // å¤§æ—¥ç…§æ›´å¤¸å¼ 
                this.opacity = Math.random() * 0.5 + 0.3;
            }
        }
        /* --- æ•…éšœç³» (Distortion / Chronal Rift) --- */
        else if (type === 'distortion') {
            this.x = Math.random() * this.w;
            this.y = Math.random() * this.h;
            this.size = Math.random() * 30 + 10;
            // ä¸‰ç§å½¢æ€ï¼š0=ä¹±ç æ–‡å­—, 1=ç©ºå¿ƒç¢ç‰‡, 2=é—ªçƒæ¨ªæ¡
            this.subType = Math.floor(Math.random() * 3);
            // èµ›åšéœ“è™¹è‰²
            const colorArray = CONFIG.distortion.colors;
            this.colorStr = colorArray[Math.floor(Math.random() * colorArray.length)];
            // ä¹±ç å­—ç¬¦åº“ï¼ˆç‰‡å‡åã€å¢æ©å­—æ¯ã€è¥¿é‡Œå°”å­—æ¯ï¼‰
            const charSets = [0x30A0, 0x16A0, 0x0400];
            const set = charSets[Math.floor(Math.random() * charSets.length)];
            this.glitchChar = String.fromCharCode(set + Math.floor(Math.random() * 50));
            // æ§åˆ¶"è·³å˜"é¢‘ç‡ï¼Œæ¨¡æ‹Ÿç”µå­æ¥è§¦ä¸è‰¯
            this.refreshRate = Math.floor(Math.random() * 20) + 5;
            this.tick = 0;
            this.opacity = Math.random() * 0.8 + 0.2;
        }
    }
    update() {
        // [é›¨/ç°çƒ¬] æ‰è½é‡ç½®
        if (['rain', 'heavyrain', 'ashfall'].includes(this.type)) {
            this.x += this.vx;
            this.y += this.vy;
            if (this.y > this.h) { this.y = -50; this.x = Math.random() * this.w; }
            if (this.x > this.w) this.x = 0;
            if (this.x < 0) this.x = this.w;
        } 
        // [é›ª] æ‘†åŠ¨æ‰è½
        else if (['snow', 'hail'].includes(this.type)) {
            this.x += Math.sin(this.y * 0.01) * 0.5;
            this.y += this.vy;
            if (this.y > this.h) this.y = -10;
        } 
        // [æ²™/é£/ä¹±æ°”æµ] æ¨ªå‘
        else if (['sand', 'deltastream', 'gale'].includes(this.type)) {
            this.x += this.vx;
            this.y += this.vy;
            if (this.x < -200) { this.x = this.w + Math.random() * 100; this.y = Math.random() * this.h; }
        }
        // [é›¾/å…‰/æ¯’æ°”/ç¥é¦”] ä¸Šæµ®å‘¼å¸
        else if (['harshsun', 'sun', 'smog', 'fog', 'ambrosia'].includes(this.type)) {
            this.y -= this.vy; // è´Ÿæ•°å‘ä¸‹ï¼Œæ­£æ•°å‘ä¸Š? æ­¤æ—¶æˆ‘ä»¬é…ç½®çš„speedæ˜¯æ­£/è´Ÿå·²åœ¨constructorå¤„ç†
            this.x += this.vx;
            // è¿è´¯å‘¼å¸é—ªçƒ
            this.alpha = Math.sin(Date.now() * 0.002 + this.x * 0.01) * 0.4 + 0.6;
            if (this.type === 'ambrosia') {
               // Ambrosia ç‰¹æœ‰ï¼šä¼šæœ‰å·¦å³è›‡å½¢æ‘†åŠ¨
               this.x += Math.sin(Date.now() / 500 + this.sideOscillation) * 0.5;
            }
            // è¶Šä¹Ÿæ˜¯å¾ªç¯å¤„ç†ï¼Œå¦‚æœé£˜å‡ºå¤´äº†å°±åˆ°åº•ä¸‹ï¼ˆç”¨äºé›¾/å…‰ï¼‰
            if (this.y < -100) this.y = this.h + 100;
            else if (this.y > this.h + 100) this.y = -100;
            if (this.x < -100) this.x = this.w + 100;
            else if (this.x > this.w + 100) this.x = -100;
        }
        // [æ•…éšœ] ç¬ç§»ä¸çªå˜ (Chronal Rift)
        else if (this.type === 'distortion') {
            this.tick++;
            // æ ¸å¿ƒæ€è·¯ï¼šå¹¶ä¸æ˜¯å¹³æ»‘ç§»åŠ¨ï¼Œè€Œæ˜¯"ç¬ç§»"å’Œ"çªå˜"
            if (this.tick % this.refreshRate === 0) {
                // 1. ä½ç½®çªå˜ (Teleport)
                if (Math.random() > 0.5) {
                    this.x = Math.random() * this.w;
                } else {
                    // å¶å°”æ¨ªå‘æ‹‰ä¼¸çªå˜ï¼Œæ¨¡æ‹Ÿåç‚¹å…‰æ …
                    this.x += (Math.random() - 0.5) * 50;
                }
                // 2. åªæœ‰æ¨ªæ¡ä¼šä¸Šä¸‹æ‰«æ
                if (this.subType === 2) {
                    this.y = Math.random() * this.h;
                }
                // 3. ä¹±ç å­—ç¬¦å˜åŒ–
                if (this.subType === 0) {
                    const charSets = [0x30A0, 0x16A0, 0x0400];
                    const set = charSets[Math.floor(Math.random() * charSets.length)];
                    this.glitchChar = String.fromCharCode(set + Math.floor(Math.random() * 50));
                }
                // 4. é‡éšæœºè®¡æ—¶å™¨ï¼Œè®©èŠ‚å¥ä¸è§„å¾‹
                this.refreshRate = Math.floor(Math.random() * 10) + 2;
                // 5. éšæœºæ˜¾éš (Strobe effect)
                this.opacity = Math.random() > 0.3 ? Math.random() : 0;
            }
        }
    }
    draw(ctx) {
        // ============ æ—¶ç©ºè£‚éš™ä¸“å±æ¸²æŸ“ ============
        if (this.type === 'distortion') {
            const visualAlpha = this.opacity * transitionProgress;
            if (visualAlpha < 0.05) return;
            ctx.save();
            ctx.shadowBlur = 0;
            // æ¨¡æ‹Ÿ RGB è‰²æ•£ï¼šå¦‚æœæ˜¯ç¢ç‰‡ï¼ŒåŠ ä¸€ç‚¹çº¢/è“é˜´å½±
            if (Math.random() > 0.8) {
                ctx.shadowColor = 'rgba(255, 0, 0, 0.8)';
                ctx.shadowOffsetX = 2;
            } else if (Math.random() > 0.8) {
                ctx.shadowColor = 'rgba(0, 0, 255, 0.8)';
                ctx.shadowOffsetX = -2;
            }
            ctx.fillStyle = `rgba(${this.colorStr}, ${visualAlpha})`;
            ctx.strokeStyle = `rgba(${this.colorStr}, ${visualAlpha})`;
            /* === å­ç±»å‹A: ä¹±ç å­—ç¬¦ (The Code) === */
            if (this.subType === 0) {
                ctx.font = `${this.size}px "Courier New", monospace`;
                ctx.shadowBlur = 5;
                ctx.shadowColor = ctx.fillStyle;
                ctx.fillText(this.glitchChar, this.x, this.y);
            }
            /* === å­ç±»å‹B: ç©ºå¿ƒç¢ç‰‡ (The Shard) === */
            else if (this.subType === 1) {
                ctx.lineWidth = 1.5;
                const s = this.size;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(this.x + s, this.y);
                ctx.lineTo(this.x + s, this.y + s);
                if (Math.random() > 0.5) {
                    ctx.stroke();
                } else {
                    ctx.strokeRect(this.x, this.y, this.size, this.size);
                }
                // æœ‰æ¦‚ç‡åŠ ä¸€æ¡è´¯ç©¿å±å¹•çš„æç»†çº¿æ¥æ¨¡æ‹Ÿè£‚ç—•
                if (Math.random() > 0.98) {
                    ctx.beginPath();
                    ctx.moveTo(0, this.y + s/2);
                    ctx.lineTo(this.w, this.y + s/2);
                    ctx.strokeStyle = `rgba(${this.colorStr}, ${visualAlpha * 0.3})`;
                    ctx.stroke();
                }
            }
            /* === å­ç±»å‹C: æ•°æ®åå— (The Glitch Block) === */
            else if (this.subType === 2) {
                ctx.fillRect(this.x, this.y, this.size * (Math.random() * 5 + 1), 2);
            }
            ctx.restore();
            return;
        }
        // ============ å…¶ä»–å¤©æ°”ç±»å‹çš„åŸæœ‰æ¸²æŸ“é€»è¾‘ ============
        ctx.beginPath();
        let cfg = CONFIG[this.type] || CONFIG.rain;
        let colorStr = cfg.color;
        let visualAlpha = (['sun','harshsun','ambrosia'].includes(this.type)) ? this.alpha * 0.5 : this.opacity;
        visualAlpha *= transitionProgress;
        ctx.fillStyle = `rgba(${colorStr}, ${visualAlpha})`;
        ctx.strokeStyle = `rgba(${colorStr}, ${visualAlpha})`;
        switch(this.type) {
            case 'rain': 
            case 'heavyrain':
            case 'gale':
                ctx.moveTo(this.x, this.y);
                if (this.type === 'gale') { ctx.lineTo(this.x + this.length, this.y); } 
                else { ctx.lineTo(this.x + this.vx, this.y + this.length); }
                ctx.lineWidth = (this.type === 'gale') ? 2 : 1.5; 
                ctx.stroke();
                break;
            case 'ashfall':
                ctx.fillRect(this.x, this.y, this.size, this.size);
                break;
            case 'snow':
            case 'hail':
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                if(this.type === 'hail'){
                   ctx.strokeStyle = `rgba(255,255,255,${visualAlpha*0.8})`;
                   ctx.stroke();
                }
                break;
            case 'sand':
            case 'deltastream':
                ctx.fillRect(this.x, this.y, this.size * 5, 2);
                break;
            case 'smog':
            case 'ambrosia': 
            case 'harshsun': 
            case 'sun':
                ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
                ctx.fill();
                break;
            case 'fog':
                let fogGradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size);
                fogGradient.addColorStop(0, `rgba(${colorStr}, ${visualAlpha})`);
                fogGradient.addColorStop(0.3, `rgba(${colorStr}, ${visualAlpha * 0.7})`);
                fogGradient.addColorStop(0.6, `rgba(${colorStr}, ${visualAlpha * 0.3})`);
                fogGradient.addColorStop(1, `rgba(${colorStr}, 0)`);
                ctx.fillStyle = fogGradient;
                ctx.fillRect(this.x - this.size, this.y - this.size, this.size * 2, this.size * 2);
                break;
        }
    }
}
function animate() {
    if (!ctx || !canvas) {
        animationFrameId = requestAnimationFrame(animate);
        return;
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // å¤„ç†æ¸å˜è¿‡æ¸¡
    if (isTransitioning) {
        transitionProgress += 0.03; // æ¯å¸§å¢åŠ 3%
        if (transitionProgress >= 1.0) {
            transitionProgress = 1.0;
            isTransitioning = false;
        }
    }
    if (weatherType === 'none' || weatherType === 'clear') {
        // ä¾ç„¶å¾ªç¯ä»¥ç›‘å¬å˜æ›´ï¼Œä½†ç©ºç»˜å›¾çœèµ„æº
        animationFrameId = requestAnimationFrame(animate); 
        return;
    }
    for (let p of particles) {
        p.update();
        p.draw(ctx);
    }
    // ============ Chronal Rift ä¸“å±ï¼šå±å¹•æ’•è£‚ä¸ RGB é”™ä½ ============
    if (weatherType === 'distortion' && !isTransitioning) {
        // æ¯éš”éšæœºæ—¶é—´è§¦å‘ä¸€æ¬¡çŒ›çƒˆçš„å¹²æ‰°
        if (Math.random() > 0.96) { // 4% çš„å¸§ä¼šæœ‰ä¸¥é‡æ•…éšœ
            const sliceH = Math.random() * 50 + 10;
            const sliceY = Math.random() * canvas.height;
            const displaceX = (Math.random() - 0.5) * 20; // å·¦å³é”™ä½ 20px
            try {
                // è·å–è¿™ä¸€æ¡çš„åƒç´ æ•°æ®
                const imageData = ctx.getImageData(0, sliceY, canvas.width, sliceH);
                // é”™ä½æ”¾å›å»
                ctx.putImageData(imageData, displaceX, sliceY);
                // å¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸€ä¸ªçº¯è‰²å—è¦†ç›–ï¼Œæ¨¡æ‹Ÿä¿¡å·ä¸¢å¤±
                if (Math.random() > 0.5) {
                    ctx.fillStyle = "rgba(0, 0, 0, 0.2)";
                    ctx.fillRect(0, sliceY, canvas.width, 2);
                }
            } catch (e) {
                // é˜²æ­¢ getImageData è¶Šç•Œé”™è¯¯
            }
        }
        // é¢å¤–çš„å…¨å±æ‰«æçº¿å¹²æ‰°ï¼ˆæ›´é¢‘ç¹ä½†æ›´è½»å¾®ï¼‰
        if (Math.random() > 0.92) {
            const scanY = Math.random() * canvas.height;
            const colors = CONFIG.distortion.colors;
            const scanColor = colors[Math.floor(Math.random() * colors.length)];
            ctx.fillStyle = `rgba(${scanColor}, 0.15)`;
            ctx.fillRect(0, scanY, canvas.width, 1);
        }
    }
    animationFrameId = requestAnimationFrame(animate);
}
/**
 * åˆå§‹åŒ–å¤©æ°”ç³»ç»Ÿ
 */
function initWeatherSystem() {
    // ä¼˜å…ˆå°è¯•è·å–å·²å­˜åœ¨çš„æˆ–è€…é‡æ–°åˆ›å»º
    canvas = document.getElementById('weather-canvas');
    if (!canvas) {
        // [é€‚é…] è¿™é‡Œå‡è®¾ä½ çš„æˆ˜æ–—ç”»é¢å®¹å™¨ class="battle-stage"
        const stage = document.querySelector('.battle-stage') || document.body; 
        if (stage) {
            canvas = document.createElement('canvas');
            canvas.id = 'weather-canvas';
            // å…¨å±é®ç½©æ¨¡å¼
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.pointerEvents = 'none'; // ç‚¹å‡»ç©¿é€æ ¸å¿ƒ
            canvas.style.zIndex = '50'; // æ”¾åœ¨UIå±‚ä¸‹ï¼Œç«‹ç»˜å±‚ä¸Š
            // å®é™…åƒç´ è®¾ç½®ï¼Œæˆ–åŠ¨æ€è·å–
            canvas.width = stage.offsetWidth || 1100;
            canvas.height = stage.offsetHeight || 720;
            stage.appendChild(canvas);
        }
    }
    // å¦‚æœè¿˜æ²¡è·å–åˆ° (å¯èƒ½DOMæ²¡åŠ è½½å®Œ)
    if(canvas) ctx = canvas.getContext('2d');
    if (!animationFrameId) animate();
}
/**
 * è®¾ç½®å¤©æ°”è§†è§‰æ•ˆæœ (å¤–éƒ¨è°ƒç”¨å…¥å£)
 * @param {string} type - ä¼ å…¥å¼•æ“å¤©æ°”ä»£ç 
 */
function setWeatherVisuals(type) {
    if(!type) return;
    const lowerType = type.toLowerCase();
    // æ˜ å°„è¡¨ï¼šå°† å¼•æ“å¤©æ°”ID -> CONFIGé…ç½®KEY
    const typeMap = {
        'rain': 'rain', 'drizzle': 'rain',
        'heavyrain': 'heavyrain', 'primordialsea': 'heavyrain',
        'sun': 'sun', 'sunnyday': 'sun', 'clear_sun': 'sun',
        'harshsun': 'harshsun', 'desolateland': 'harshsun',
        'sand': 'sand', 'sandstorm': 'sand',
        'snow': 'snow', 'hail': 'hail',
        'deltastream': 'deltastream', 'strongwinds': 'gale', // å¼ºé£ä¹Ÿç”¨Galeæ•ˆæœ
        // æ–°å¢çš„
        'smog': 'smog',
        'ashfall': 'ashfall',
        'fog': 'fog',
        'gale': 'gale',
        'ambrosia': 'ambrosia', 'ambrosia_overdrive': 'ambrosia',
        'distortion': 'distortion', 'chronalrift': 'distortion',
        // ç©º
        'none': 'none', 'clear': 'none'
    };
    const targetKey = typeMap[lowerType] || 'none';
    if (weatherType === targetKey) return; // æ²¡å˜åŒ–åˆ™ä¸é‡ç½®
    // è‹¥ç³»ç»ŸæŒ‚äº†åˆ™å°è¯•é‡å¯
    if (!canvas || !ctx) initWeatherSystem();
    // å¯åŠ¨æ¸å˜è¿‡æ¸¡
    transitionProgress = 0.0;
    isTransitioning = true;
    weatherType = targetKey;
    console.log(`[WEATHER VISUAL] Switch to: ${weatherType}`);
    // é‡ç½®ç²’å­æ± 
    particles = [];
    if (weatherType !== 'none' && CONFIG[weatherType]) {
        const count = CONFIG[weatherType].count;
        for (let i = 0; i < count; i++) {
            particles.push(new Particle(weatherType, canvas.width || 1100, canvas.height || 720));
        }
    }
    // CSS èƒŒæ™¯æ»¤é•œè”åŠ¨
    const bgLayer = document.querySelector('.bg-gradient');
    if (bgLayer) {
        // æ¸…ç†æ—§ Class
        const allClasses = [
            'bg-rain', 'bg-heavyrain', 'bg-sand', 'bg-snow', 'bg-hail', 
            'bg-harshsun', 'bg-sun', 'bg-deltastream',
            // æ–°å¢çš„
            'bg-smog', 'bg-ashfall', 'bg-fog', 'bg-gale', 'bg-ambrosia', 'bg-distortion', 'bg-chronalrift'
        ];
        bgLayer.classList.remove(...allClasses);
        // æ·»åŠ æ–° Class
        if (weatherType !== 'none') {
            // chronalrift ä½¿ç”¨ distortion çš„è§†è§‰æ•ˆæœ
            const cssClass = `bg-${weatherType}`;
            bgLayer.classList.add(cssClass);
        }
    }
    // Canvas å¯è§æ€§
    if (canvas) canvas.style.opacity = (weatherType === 'none') ? '0' : '1';
}
function clearWeatherVisuals() {
    setWeatherVisuals('none');
}
// å¯¼å‡ºä¸è‡ªå¯åŠ¨
window.initWeatherSystem = initWeatherSystem;
window.setWeatherVisuals = setWeatherVisuals;
window.clearWeatherVisuals = clearWeatherVisuals;
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => setTimeout(initWeatherSystem, 500));
} else {
    setTimeout(initWeatherSystem, 500);
}
]]></file>
    </directory>
    <directory name="cmd">
        <file name="index.html"><![CDATA[<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commander System V2 - Layered</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,700;0,800;0,900;1,900&family=M+PLUS+Rounded+1c:wght@500;800;900&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="theme-update.css">
</head>
<body>
    <!-- Hidden defs for global gradients -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" aria-hidden="true">
        <defs>
            <linearGradient id="mega-rainbow" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#ff9cd6" />
                <stop offset="25%" style="stop-color:#ffeb3b" />
                <stop offset="50%" style="stop-color:#5affda" />
                <stop offset="75%" style="stop-color:#4bcffa" />
                <stop offset="100%" style="stop-color:#d49bfd" />
            </linearGradient>
        </defs>
    </svg>
    <div class="commander-stage">
        <div class="stage-backdrop"></div>
        <!-- SMART INTEL BUBBLE -->
        <div id="smart-bubble" class="smart-bubble-wrapper" onclick="toggleCommanderRoot()">
            <div class="bubble-glow-ring"></div>
            <div class="bubble-core">
                <div class="bubble-icon-stage" id="bubble-icon-stage"></div>
            </div>
            <div class="bubble-label-pill" id="bubble-text">LINK</div>
            <svg class="bubble-progress" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="46" stroke-width="4" stroke="rgba(255,255,255,0.1)" fill="none"></circle>
                <circle id="bubble-timer-circle" cx="50" cy="50" r="46" stroke-width="4" stroke="currentColor" fill="none" stroke-dasharray="289" stroke-dashoffset="0"></circle>
            </svg>
        </div>
        <div id="commander-overlay" class="cmd-layer hidden">
            <div class="commander-container">
                <div class="commander-wheel" id="cmd-wheel">
                    <button class="cmd-btn pos-top" id="slot-top" onclick="handleQuadrant('top')">
                        <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                        <div class="cmd-content">
                            <span class="cmd-label">---</span>
                            <span class="cmd-sub">---</span>
                        </div>
                    </button>
                    <button class="cmd-btn pos-right" id="slot-right" onclick="handleQuadrant('right')">
                        <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                        <div class="cmd-content">
                            <span class="cmd-label">---</span>
                            <span class="cmd-sub">---</span>
                        </div>
                    </button>
                    <button class="cmd-btn pos-bottom" id="slot-bottom" onclick="handleQuadrant('bottom')">
                        <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                        <div class="cmd-content">
                            <span class="cmd-label">---</span>
                            <span class="cmd-sub">---</span>
                        </div>
                    </button>
                    <button class="cmd-btn pos-left" id="slot-left" onclick="handleQuadrant('left')">
                        <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                        <div class="cmd-content">
                            <span class="cmd-label">---</span>
                            <span class="cmd-sub">---</span>
                        </div>
                    </button>
                    <div class="cmd-hub">
                        <div class="pulse-ring"></div>
                    </div>
                </div>
                <div class="cmd-cancel-hint" onclick="handleCloseOrBack()">
                    <span class="key" id="cancel-key-text">X</span>
                    <span id="cancel-text">å…³é—­æŒ‡ä»¤</span>
                </div>
            </div>
        </div>
    </div>
    <script src="mechanics.js"></script>
</body>
</html>]]></file>
        <file name="mechanics.js"><![CDATA[/**
 * ===========================================
 * COMMANDER SYSTEM V2 - è½®æ’­æ‚¬æµ®çª— + å››è±¡é™èœå•
 * ===========================================
 * 
 * èŒè´£:
 * - æ™ºèƒ½è½®æ’­æ°”æ³¡ (Smart Bubble)
 * - å››è±¡é™è½®ç›˜èœå• (Commander Wheel)
 * - ä¸ä¸»æˆ˜æ–—ç³»ç»Ÿé›†æˆ
 */
const QUADRANTS = ['top', 'right', 'bottom', 'left'];
// æˆ˜æ–—çŠ¶æ€ä»£ç†ï¼šä»å…¨å±€ battle å¯¹è±¡è¯»å–çœŸå®çŠ¶æ€
// ã€å«æ¥ã€‘é€»è¾‘å‚è€ƒ ui-menus.js ä¸­çš„ toggleMega å’Œ updateMegaButtonVisibility
const battleState = {
    get gimmickType() {
        // ä»å½“å‰å®å¯æ¢¦æ£€æŸ¥å¯ç”¨çš„ gimmick ç±»å‹
        // é€»è¾‘ä¸ ui-menus.js ä¸­çš„ updateMegaButtonVisibility ä¿æŒä¸€è‡´
        if (typeof window.battle === 'undefined') return 'none';
        const b = window.battle;
        const p = b.getPlayer?.();
        const unlocks = b.playerUnlocks || {};
        if (!p) return 'none';
        // ã€äºŒå±‚é”æœºåˆ¶ã€‘æ£€æŸ¥å½“å‰å®å¯æ¢¦çš„ mechanic å­—æ®µ
        const lockedMechanic = p.mechanic;
        // å¤ªæ™¶åŒ– (tera)
        if (lockedMechanic === 'tera' && unlocks.enable_tera === true && p.canTera) {
            return 'tera';
        }
        // æå·¨åŒ– (dynamax)
        if (lockedMechanic === 'dynamax' && unlocks.enable_dynamax === true) {
            if (p.canDynamax || (p.megaTargetId && p.megaTargetId.toLowerCase().includes('gmax'))) {
                return 'dyna';
            }
        }
        // Zæ‹›å¼ (zmove)
        if (lockedMechanic === 'zmove' && unlocks.enable_z_move === true) {
            return 'zmove';
        }
        // Megaè¿›åŒ– (mega)
        if (lockedMechanic === 'mega' && unlocks.enable_mega === true) {
            const canMegaEvolveFunc = window.canMegaEvolve;
            if (typeof canMegaEvolveFunc === 'function' && canMegaEvolveFunc(p)) {
                return 'mega';
            }
        }
        // å½“å‰å®å¯æ¢¦æ²¡æœ‰ä»»ä½•æœºåˆ¶
        return 'none';
    },
    get canGimmick() {
        if (typeof window.battle === 'undefined') return false;
        const b = window.battle;
        const p = b.getPlayer?.();
        if (!p) return false;
        const gType = this.gimmickType;
        if (gType === 'none') return false;
        // æ£€æŸ¥æ˜¯å¦å·²ç»ä½¿ç”¨è¿‡æˆ–å·²ç»å˜èº«
        if (gType === 'mega') {
            return !b.playerMegaUsed && !p.isMega;
        }
        if (gType === 'dyna') {
            return !b.playerMaxUsed && !p.isDynamaxed;
        }
        if (gType === 'tera') {
            return !b.playerTeraUsed && !p.isTerastallized;
        }
        if (gType === 'zmove') {
            return !b.playerZUsed;
        }
        return false;
    },
    get canEvo() {
        if (typeof window.battle === 'undefined') return false;
        const p = window.battle.getPlayer?.();
        if (!p) return false;
        // ä½¿ç”¨ EvolutionSystem.checkEligibility æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›åŒ–
        if (typeof window.EvolutionSystem?.checkEligibility === 'function') {
            const evoInfo = window.EvolutionSystem.checkEligibility(p);
            return evoInfo !== null;
        }
        return false;
    },
    get evoType() {
        // è¿”å›è¿›åŒ–ç±»å‹: 'bio' | 'bond' | 'none'
        if (typeof window.battle === 'undefined') return 'none';
        const p = window.battle.getPlayer?.();
        if (!p) return 'none';
        // ä½¿ç”¨ EvolutionSystem.checkEligibility è·å–è¿›åŒ–ç±»å‹
        if (typeof window.EvolutionSystem?.checkEligibility === 'function') {
            const evoInfo = window.EvolutionSystem.checkEligibility(p);
            if (evoInfo) return evoInfo.type; // 'bio' æˆ– 'bond'
        }
        return 'none';
    },
    get canStyle() {
        if (typeof window.battle === 'undefined') return false;
        const unlocks = window.battle.playerUnlocks || {};
        // ã€è§£é”æ£€æŸ¥ã€‘enable_styles å¿…é¡»ä¸º true
        if (!unlocks.enable_styles) return false;
        // ã€å†·å´æ£€æŸ¥ã€‘å†·å´ä¸­ä¸å¯ç”¨ï¼Œä¸æ˜¾ç¤ºåœ¨è½®æ’­ä¸­
        if (window.battle.playerStyleCooldown > 0) return false;
        return true;
    },
    get styleCooldown() {
        // è¿”å›å½“å‰å†·å´å›åˆæ•°
        if (typeof window.battle === 'undefined') return 0;
        return window.battle.playerStyleCooldown || 0;
    },
    get canCommand() {
        if (typeof window.battle === 'undefined') return false;
        // ã€è®¾ç½®æ£€æŸ¥ã€‘enableAVS æˆ– enableCommander ä»»æ„ä¸€ä¸ªå…³é—­åˆ™ä¸å¯ç”¨
        if (window.GAME_SETTINGS) {
            if (window.GAME_SETTINGS.enableAVS === false) return false;
            if (window.GAME_SETTINGS.enableCommander === false) return false;
        }
        const p = window.battle.getPlayer?.();
        if (!p) return false;
        // æ£€æŸ¥å½“å‰å®å¯æ¢¦æ˜¯å¦æ˜¯ç‹ç‰Œï¼ˆisAceï¼‰
        const isAce = p.isAce === true || p.data?.isAce === true;
        if (!isAce) return false;
        // ã€å†·å´æ£€æŸ¥ã€‘å†·å´ä¸­ä¸å¯ç”¨ï¼Œä¸æ˜¾ç¤ºåœ¨è½®æ’­ä¸­
        if (window.battle.commandCooldown > 0) return false;
        return true;
    },
    get commandCooldown() {
        // è¿”å›å½“å‰æŒ‡ä»¤å†·å´å›åˆæ•°
        if (typeof window.battle === 'undefined') return 0;
        return window.battle.commandCooldown || 0;
    },
};
// Icon assets isolation
const ICON_SVGS = {
    MEGA: `
<svg viewBox="0 0 14 17.5" xmlns="http://www.w3.org/2000/svg">
  <g>
    <path d="M3.88792,10.9 C5.96264,10.9,8.03736,10.9,10.1121,10.9 C11.0183,10.9426,11.0183,9.45744,10.1121,9.5 C8.03736,9.5,5.96264,9.5,3.88792,9.5 C2.98166,9.45744,2.98166,10.9426,3.88792,10.9 z"/>
    <path d="M2.75289,2 C2.75289,2.10488,2.75289,2.20976,2.75289,2.31464 C2.75355,4.80881,4.40963,6.99632,6.81004,7.67374 C8.60567,8.17928,9.84777,9.81993,9.84711,11.6854 C9.84711,11.7903,9.84711,11.8951,9.84711,12 C9.80455,12.9063,11.2897,12.9063,11.2471,12 C11.2471,11.8951,11.2471,11.7903,11.2471,11.6854 C11.2464,9.19119,9.59033,7.00368,7.18992,6.32626 C5.39429,5.82072,4.15223,4.18007,4.15289,2.31464 C4.15289,2.20976,4.15289,2.10488,4.15289,2 C4.19545,1.09374,2.71033,1.09374,2.75289,2 z"/>
    <g>
       <path d="M6.99988,6.26793 C6.93733,6.28879,6.87403,6.30825,6.81004,6.32626 C4.40962,7.00368,2.75355,9.1912,2.75289,11.6854 C2.75289,11.6854,2.75289,12,2.75289,12 C2.71033,12.9063,4.19545,12.9063,4.15289,12 C4.15289,12,4.15289,11.6854,4.15289,11.6854 C4.15223,9.81992,5.3943,8.17928,7.18992,7.67374 C7.73053,7.52117,8.23338,7.29202,8.68807,7.00001 C8.23346,6.70808,7.73068,6.47894,7.19012,6.32632 C7.12599,6.30829,7.06257,6.28881,6.99988,6.26793 z"/>
       <path d="M8.21185,5.62527 C9.21994,4.85339,9.84758,3.64081,9.84711,2.31464 C9.84711,2.31464,9.84711,2,9.84711,2 C9.80455,1.09375,11.2897,1.09374,11.2471,2 C11.2471,2,11.2471,2.31464,11.2471,2.31464 C11.2467,3.88075,10.5936,5.32595,9.51336,6.35232 C9.1132,6.06454,8.67745,5.81966,8.21185,5.62527 z"/>
    </g>
    <path d="M6.02737,4.5 C6.02737,4.5,10.1121,4.5,10.1121,4.5 C11.0183,4.54256,11.0183,3.05744,10.1121,3.1 C10.1121,3.1,5.2513,3.1,5.2513,3.1 C5.38672,3.62909,5.65656,4.11049,6.02737,4.5 z"/>
  </g>
</svg>
`,
    ZMOVE: `
<svg class="z-svg" viewBox="0 0 64 80" xmlns="http://www.w3.org/2000/svg" overflow="visible">
  <defs>
    <linearGradient id="z-prism-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#ff0000" />
      <stop offset="16%" stop-color="#ff9900" />
      <stop offset="33%" stop-color="#cccc00" />
      <stop offset="50%" stop-color="#33cc33" />
      <stop offset="66%" stop-color="#3399ff" />
      <stop offset="83%" stop-color="#6633cc" />
      <stop offset="100%" stop-color="#ff0044" />
    </linearGradient>
    <filter id="z-glitch">
      <feTurbulence type="fractalNoise" baseFrequency="0.1" numOctaves="1" result="noise" />
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" />
    </filter>
  </defs>
  <g class="z-shape-group">
    <polygon points="52.4375,28 33.5764,28 44.5625,0 11.5625,36 30.4236,36 19.4375,64"
      fill="url(#z-prism-gradient)" stroke="none" />
    <polygon points="52.4375,28 33.5764,28 44.5625,0 11.5625,36 30.4236,36 19.4375,64"
      fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="1.5" class="z-stroke" />
  </g>
</svg>
`,
    DYNA: `
<svg class="dyna-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" overflow="visible">
  <defs>
    <filter id="dyna-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="4" result="coloredBlur" />
      <feMerge>
        <feMergeNode in="coloredBlur" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
  </defs>
  <g class="dyna-clouds">
    <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="10 5" opacity="0.3" class="dyna-ring-1" />
    <path d="M50 0 C22 0 0 22 0 50 C0 78 22 100 50 100 C78 100 100 78 100 50" fill="none" stroke="currentColor" stroke-width="8" opacity="0.1" transform="rotate(20 50 50)" />
  </g>
  <g class="dyna-cross-group" filter="url(#dyna-glow)">
    <path class="dyna-cross-path" d="M30 30 L70 70 L85 70 L45 30 Z" />
    <path class="dyna-cross-path" d="M70 30 L30 70 L15 70 L55 30 Z" />
  </g>
</svg>
`,
    TERA: `
<svg class="tera-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" overflow="visible">
  <defs>
    <linearGradient id="tera-sheen" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#ffffff" stop-opacity="0.9" />
      <stop offset="50%" stop-color="#ffffff" stop-opacity="0.1" />
      <stop offset="100%" stop-color="#a5f3fc" stop-opacity="0.6" />
    </linearGradient>
  </defs>
  <g class="tera-bg-ring" opacity="0.3" fill="none" stroke="currentColor">
    <path d="M50 5 L88 27 v45 L50 95 L12 72 v-45 Z" stroke-width="1" stroke-dasharray="4 4" />
    <path d="M50 15 L80 32 v35 L50 85 L20 67 v-35 Z" stroke-width="2" />
  </g>
  <g class="tera-gem-group">
    <path d="M50 10 L85 30 V70 L50 90 L15 70 V30 Z" fill="rgba(8, 145, 178, 0.2)" stroke="currentColor" stroke-width="3" stroke-linejoin="round" />
    <path d="M50 50 L15 30 L50 10 L85 30 Z" fill="url(#tera-sheen)" opacity="0.8" />
    <path d="M15 30 L15 70 L50 90 L50 50 Z" fill="black" opacity="0.2" />
    <path d="M85 30 L85 70 L50 90 L50 50 Z" fill="currentColor" opacity="0.1" />
    <path d="M50 35 L62 42 V58 L50 65 L38 58 V42 Z" fill="#fff" class="tera-core-pulse" />
  </g>
  <g fill="#fff">
    <circle cx="85" cy="15" r="3" class="tera-sparkle s1" />
    <circle cx="15" cy="85" r="2" class="tera-sparkle s2" />
    <path d="M20 20 L22 15 L24 20 L29 22 L24 24 L22 29 L20 24 L15 22 Z" class="tera-sparkle s3" transform="scale(0.8)" />
  </g>
</svg>
`,
    STYLE_TAIJI: `
<svg viewBox="0 0 75 93.75" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path transform="translate(0, 10) scale(0.9)" d="m50 5.8594c-11.79 0-22.876 4.5903-31.213 12.928-8.3374 8.3366-12.928 19.422-12.928 31.213s4.5903 22.874 12.928 31.211c2.8053 2.8061 5.9253 5.1857 9.2754 7.1113-2.8564-4.2252-4.5273-9.3145-4.5273-14.787 0-14.593 11.872-26.465 26.465-26.465 11.362 0 20.605-9.2438 20.605-20.605s-9.2438-20.605-20.605-20.605zm21.939 5.8184c2.8572 4.2252 4.5254 9.3146 4.5254 14.787 0 14.593-11.872 26.465-26.465 26.465-11.362 0-20.605 9.2438-20.605 20.605s9.2438 20.605 20.605 20.605c11.79 0 22.876-4.5923 31.213-12.93 8.3374-8.3367 12.928-19.42 12.928-31.211s-4.5903-22.876-12.928-31.213c-2.8053-2.8061-5.9234-5.1837-9.2734-7.1094zm-21.939 3.0625c6.4652 0 11.725 5.2602 11.725 11.725 0 6.4644-5.2595 11.723-11.725 11.723-6.4652 0-11.725-5.2575-11.725-11.723-2e-6 -6.4651 5.2595-11.725 11.725-11.725zm0 5.8594c-3.2341 0-5.8652 2.6311-5.8652 5.8652-2e-6 3.2341 2.6311 5.8633 5.8652 5.8633 3.2341 0 5.8652-2.6292 5.8652-5.8633 0-3.2341-2.6311-5.8652-5.8652-5.8652zm0 41.211c6.4652 0 11.725 5.2594 11.725 11.725s-5.2595 11.723-11.725 11.723c-6.4652 0-11.725-5.2575-11.725-11.723-2e-6 -6.4652 5.2595-11.725 11.725-11.725zm0 5.8594c-3.2341 0-5.8652 2.6311-5.8652 5.8652s2.6311 5.8633 5.8652 5.8633c3.2341-1e-6 5.8652-2.6292 5.8652-5.8633s-2.6311-5.8652-5.8652-5.8652z" stroke-width="0.2"/>
</svg>
`,
    BIO: `
    <svg class="bio-svg" version="1.1" viewBox="-5 -10 110 130" xmlns="http://www.w3.org/2000/svg">
       <g fill="currentColor">
         <path d="m70.656 40.012c-2.5195-0.078125-4.2305-0.28906-4.6172-0.32812-0.42187-0.058594-1.3828-0.15234-2.75-0.21094 0.042969 3.2031-0.097656 6.2578-0.64062 9.0859l-11.078-11.078c2.9961-0.64062 6.1016-0.90625 8.793-0.92969 5.7266-0.16406 21.125 3.1758 32.98-4.1328 2.0977-1.2695 2.4805-4.1328 0.75-5.8672v-0.019531c-1.2109-1.1914-3.0977-1.4609-4.5586-0.55859-0.92969 0.58594-1.9492 1.0781-3.0234 1.5l-14.027-14.027c0.42578-1.0312 0.91016-2.0352 1.5156-2.9922 0.94141-1.4609 0.65234-3.3477-0.55859-4.5586-1.7305-1.7305-4.5781-1.3477-5.8672 0.73047-3.7305 6.0586-4.5586 12.828-4.6133 19.559 1.6133 0.058594 3.1914 0.17188 4.75 0.34766 0.42187 0.058594 1.3477 0.15234 2.6328 0.21094 0.023438-3.582 0.28516-7.0391 1.1172-10.242l11.965 11.965c-6.082 1.5586-12.961 1.3242-16.059 0.92969-9.9023-1.1914-23.652 0.28906-30.672 7.3086-6.25 6.25-7.5586 16.559-7.6328 23.48 1.5586 0 3.1172 0.058594 4.6523 0.11719 0.94141 0.039063 1.8828 0.078125 2.8281 0.097657 0.035156-2.707 0.30078-5.8125 0.94141-8.8125l11.094 11.098c-12.418 2.4258-28.906-3.1055-41.941 4.8906-2.0781 1.2891-2.4609 4.1328-0.73047 5.8828 1.1914 1.1914 3.0977 1.4805 4.5391 0.55859 0.99219-0.625 2.043-1.125 3.125-1.5586 0.070313 0.19922 0.17188 0.38672 0.54688 0.54688l13.559 13.562c-0.42188 1.0586-0.89453 2.0742-1.4766 2.9883-0.36719 0.57812-0.55859 1.25-0.55859 1.9023 0 0.96094 0.38281 1.9219 1.1172 2.6523 1.7305 1.7305 4.5977 1.3281 5.8828-0.75 3.7695-6.1172 4.6523-14.059 4.7109-19.73-1.3086-0.019531-2.6328-0.078125-3.9414-0.11719-1.1719-0.039063-2.3672-0.078125-3.5195-0.11719-0.023437 3.0898-0.33984 6.7109-1.2109 10.094l-11.977-11.977c14.375-3.6055 34.195 4.3906 46.801-8.2109 6.4453-6.4414 7.4453-14.77 7.3711-23.289zm-8.8477 11.789c-0.64844 1.8555-1.5977 3.5586-2.875 5.1016l-15.82-15.82c1.4922-1.168 3.2773-2.0742 5.2422-2.7383zm-23.469-3.4336c0.66016-1.9609 1.5664-3.7461 2.7344-5.2461l15.82 15.82c-1.543 1.2773-3.2383 2.2344-5.0898 2.8906z"/>
         <circle cx="88" cy="51" r="5" class="bio-bubble b1"/>
         <circle cx="51" cy="9" r="4" class="bio-bubble b2"/>
         <circle cx="49" cy="88" r="4" class="bio-bubble b3"/>
         <circle cx="28" cy="30" r="3" class="bio-bubble b4"/>
       </g>
    </svg>` ,
    BOND: `
    <svg class="bond-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <defs>
          <radialGradient id="heart-glow">
            <stop offset="20%" stop-color="#fff"/>
            <stop offset="95%" stop-color="transparent"/>
          </radialGradient>
      </defs>
      <g>
         <path class="bond-heart" 
               d="M50 90 L15 55 A15 15 0 0 1 50 25 A15 15 0 0 1 85 55 Z" 
               fill="#F472B6" opacity="0.4" transform="scale(1.2)" transform-origin="center" />
         <path class="bond-heart-core"
               d="M50 85 L18 50 A18 18 0 0 1 50 18 A18 18 0 0 1 82 50 Z" 
               fill="currentColor"/>
         <path class="bond-pulse-line" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" 
               d="M10 50h20l5 -15l10 30l10 -20l5 5h20" 
               opacity="0" pointer-events="none" />
         <path class="bond-mini-heart h1" d="M10 10l-2 2a2 2 0 0 1 5 0a2 2 0 0 1 2 2z" fill="#fff" />
         <path class="bond-mini-heart h2" d="M50 10l-2 2a2 2 0 0 1 5 0a2 2 0 0 1 2 2z" fill="#fff" />    
      </g>
    </svg>`
    ,
    TACTIC: `
    <svg class="tactic-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" overflow="visible">
       <g fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="50" cy="50" r="42" stroke-dasharray="2 6" opacity="0.6" class="hud-ring-outer" />
          <path d="M50 15 A35 35 0 0 1 85 50" class="hud-arc" stroke-width="2" />
          <path d="M50 85 A35 35 0 0 1 15 50" class="hud-arc" stroke-width="2" />
          <line x1="50" y1="10" x2="50" y2="35" class="hud-line op" />
          <line x1="50" y1="65" x2="50" y2="90" class="hud-line op" />
          <line x1="10" y1="50" x2="35" y2="50" class="hud-line op" />
          <line x1="65" y1="50" x2="90" y2="50" class="hud-line op" />
          <circle cx="50" cy="50" r="4" fill="currentColor" stroke="none" class="hud-core">
             <animate attributeName="opacity" values="1;0.5;1" dur="1s" repeatCount="indefinite" />
          </circle>
          <circle cx="50" cy="50" r="15" stroke-width="1" opacity="0.8" />
       </g>
       <g fill="currentColor" stroke="none" class="hud-chevrons">
          <path d="M48 5 L50 2 L52 5 L50 8 Z" />
          <path d="M48 95 L50 92 L52 95 L50 98 Z" />
          <path d="M95 48 L98 50 L95 52 L92 50 Z" />
          <path d="M5 48 L8 50 L5 52 L2 50 Z" />
       </g>
    </svg>`
};
Object.assign(ICON_SVGS, {
    DODGE: `
    <svg class="cmd-svg" viewBox="0 0 244 274" xmlns="http://www.w3.org/2000/svg">
        <g fill="currentColor">
            <path d="M232 39c0 77-129 3-170 114 16-129 163-72 170-114z"/>
            <path d="M244 0c1 80-133 4-176 117-10 34-31 108-68 101 66-19 11-196 161-200-25 5-43 16-56 29 51-38 134-15 139-47z"/>
            <path d="M211 81c-10 80-115 0-151 95 18-110 137-53 151-95z"/>
        </g>
    </svg>`,
    FOCUS: `
    <svg class="cmd-svg" viewBox="0 0 48 60" xmlns="http://www.w3.org/2000/svg">
        <g fill="currentColor">
            <path d="M39 13l-1.6 1.6c2.3 3.1 3.6 6.9 3.6 11 0 10.3-8.3 18.6-18.6 18.6S3.7 35.9 3.7 25.6C3.7 15.4 12.1 7 22.3 7c4.1 0 8 1.4 11.1 3.7l1.6-1.6.1-1.7c-3.6-2.5-8-4-12.8-4C10 3.3 0 13.3 0 25.6S10 48 22.3 48c12.3 0 22.3-10 22.3-22.3 0-4.7-1.5-9.1-4-12.7L39 13z"/>
            <path d="M30.4 13.7c-2.3-1.6-5.1-2.5-8.1-2.5-8 0-14.4 6.5-14.4 14.4 0 8 6.5 14.4 14.4 14.4 8 0 14.4-6.5 14.4-14.4 0-2.9-.9-5.7-2.4-8l-2.7 2.7c.9 1.6 1.4 3.3 1.4 5.3 0 5.9-4.8 10.7-10.7 10.7-5.9 0-10.7-4.8-10.7-10.7 0-5.9 4.8-10.7 10.7-10.7 2 0 3.8.5 5.4 1.5l2.7-2.7z"/>
            <path d="M23.8 20.3c-.5-.1-1-.2-1.5-.2-3.1 0-5.6 2.5-5.6 5.6 0 3.1 2.5 5.6 5.6 5.6 3.1 0 5.6-2.5 5.6-5.6 0-.5-.1-.9-.2-1.4l-3.3 3.3c-.5.5-1.2.8-2 .8-.8 0-1.5-.3-2-.8-1.1-1.1-1.1-2.9 0-3.9l3.4-3.4z"/>
            <path d="M47 5.7l-3.5.2 1.4-1.4c.4-.4.4-1 0-1.3-.4-.4-1-.4-1.3 0l-1.4 1.4L42.4 1c0-.5-.4-1-1-.9-.5 0-1 .4-1 .9l-.3 5.6-1.4 1.4-.3-2.5c0-.5-.4-1-.9-1-.5 0-1 .4-1 .9l-.3 5.6L21.8 25c-.4.4-.4 1 0 1.3.2.2.7.5 1.3 0l15.1-15.1 5.6-.3c.5 0 .9-.5.9-1 0-.5-.5-.9-1-.9l-3.5.2 1.4-1.4 5.6-.3c.5 0 .9-.5.9-1 .1-.6-.4-1-1-.9z"/>
        </g>
    </svg>`,
    ENDURE: `
    <svg class="cmd-svg" viewBox="0 0 100 125" xmlns="http://www.w3.org/2000/svg">
        <g transform="translate(0, -952.36218)" fill="currentColor">
            <path d="m51.1339 955.36611a2.9995345 3.0001855 0 0 1 1.43713.4375c4.4064 2.6807 9.61209 6.1381 14.83996 8.3747 5.22788 2.2365 10.22474 3.1499 14.4963 1.4686a2.9995345 3.0001855 0 0 1 12.09271 2.7812c0 31.60899-7.04861 50.60179-16.68324 62.30999-9.63463 11.7083-21.67399 15.8706-30.42974 18.4993a2.9995345 3.0001855 0 0 1-2.87426-.6562c-7.30294-6.5034-14.4164-11.4997-18.4328-22.2491-4.01639-10.7495-4.88977-26.60879-1.40589-55.37279a2.9995345 3.0001855 0 0 1 3.74904-2.5312c4.32204 1.1795 9.44291-.3576 14.68376-3.1562 5.24084-2.7983 10.3515-6.7103 14.80872-9.4683a2.9995345 3.0001855 0 0 1 1.71831-.4375zm-.0625 6.5622c-3.82197 2.4944-8.4668 5.8556-13.65276 8.6247-4.80862 2.5676-10.15153 4.4718-15.58977 4.0936-2.96179 26.25779-1.91794 40.77949 1.37465 49.59179 3.20751 8.5845 8.64616 12.702 15.52728 18.718 8.24206-2.5511 17.93077-6.2707 25.96213-16.0306 8.15816-9.9141 14.6568-26.4095 15.21486-54.68539-5.07588.7184-10.17975-.5375-14.83996-2.5311-5.26895-2.2541-10.01929-5.3101-13.99643-7.781zm-1.43713 12.9682 5.62357 15.4995 15.74598 3.8124-12.71551 10.24949 1.31217 16.4368-13.49656-9.1247-14.93369 6.3124 4.37389-15.8743-10.52857-12.56209 16.18337-.6562 8.43535-14.0933z"/>
        </g>
    </svg>`,
    LISTEN: `
    <svg class="cmd-svg" viewBox="0 0 100 125" xmlns="http://www.w3.org/2000/svg">
        <g fill="currentColor">
            <path d="M87.395 12.618c9.161 9.177 9.183 24.065-.012 33.252L70.758 62.493c-1.427 1.427-3.004 2.609-4.666 3.593-5.491 3.258-12.014 4.088-18.035 2.482-3.864-1.028-7.523-3.036-10.549-6.067-2.061-2.056-3.604-4.415-4.742-6.913l7.276-7.274c.681-.675 1.518-1.168 2.426-1.565.184 2.709 1.276 5.361 3.354 7.434 3.083 3.083 7.427 4.046 11.344 2.99 1.933-.516 3.766-1.484 5.277-2.997l6.129-6.122 10.493-10.499c4.587-4.594 4.591-12.013.004-16.62-4.598-4.58-12.038-4.595-16.626 0l-7.717 7.719c-.622-.213-1.232-.457-1.868-.629-4.692-1.253-9.637-1.167-14.262.122l15.531-15.528c9.192-9.199 24.075-9.187 33.275.99zM61.339 71.878c-5.271 1.459-10.889 1.277-16.078-.511l-7.699 7.703c-4.596 4.578-12.035 4.578-16.629-.006-4.587-4.601-4.58-12.024-.005-16.627l16.634-16.626c1.516-1.506 3.34-2.469 5.266-2.984 3.919-1.05 8.261-.087 11.355 2.991 2.079 2.093 3.171 4.761 3.348 7.485.87-.395 1.695-.924 2.41-1.637l7.283-7.278c-1.13-2.493-2.671-4.843-4.718-6.895-3.037-3.026-6.692-5.036-10.552-6.065-6.029-1.607-12.546-.775-18.044 2.48-1.659.979-3.235 2.159-4.666 3.585l-16.63 16.628c-9.182 9.189-9.188 24.08-.004 33.262 9.187 9.185 24.07 9.185 33.263 0l16.215-16.212z"/>
        </g>
    </svg>`
});
function getBottomSlotConfig() {
    const evoType = battleState.evoType || 'bond';
    if (evoType === 'bio') {
        return {
            label: 'EVO',
            sub: 'BIO-FORCE',
            theme: 'theme-evo-bio',
            icon: ICON_SVGS.BIO,
            action: () => activateEvolution('Bio Evolution'),
            check: () => battleState.canEvo,
        };
    }
    if (evoType === 'bond') {
        return {
            label: 'LINK',
            sub: 'SYNCHRONIZE',
            theme: 'theme-evo-bond',
            icon: ICON_SVGS.BOND,
            action: () => activateEvolution('Bond Evolution'),
            check: () => battleState.canEvo,
        };
    }
    return {
        label: '---',
        sub: '',
        icon: null,
        theme: '',
        action: () => {},
        check: () => false,
    };
}
function getTopSlotConfig() {
    if (battleState.gimmickType === 'none' || !battleState.gimmickType) {
        return {
            label: '---',
            sub: 'æ— å¯é€‰ç”¨æœºåˆ¶',
            theme: '',
            icon: null,
            action: () => {},
            check: () => false,
        };
    }
    if (battleState.gimmickType === 'mega') {
        return {
            label: 'MEGA',
            sub: 'BEYOND LIMIT',
            theme: 'theme-mega',
            icon: ICON_SVGS.MEGA,
            action: () => activateGimmick('Mega Evolution'),
            check: () => battleState.canGimmick,
        };
    }
    if (battleState.gimmickType === 'zmove') {
        return {
            label: 'Z-PWR',
            sub: 'FULL FORCE',
            theme: 'theme-zmove',
            icon: ICON_SVGS.ZMOVE,
            action: () => activateGimmick('Z-Power'),
            check: () => battleState.canGimmick,
        };
    }
    if (battleState.gimmickType === 'dyna') {
        return {
            label: 'Dynamax',
            sub: 'CLASHING SCALE',
            theme: 'theme-dyna',
            icon: ICON_SVGS.DYNA,
            action: () => activateGimmick('Dynamax'),
            check: () => battleState.canGimmick,
        };
    }
    if (battleState.gimmickType === 'tera') {
        return {
            label: 'TERA',
            sub: 'PHENOMENON',
            theme: 'theme-tera',
            icon: ICON_SVGS.TERA,
            action: () => activateGimmick('Terastallize'),
            check: () => battleState.canGimmick,
        };
    }
    return {
        label: '---',
        sub: 'æ— å¯é€‰ç”¨æœºåˆ¶',
        theme: '',
        icon: null,
        action: () => {},
        check: () => false,
    };
}
let overlayEl;
let cancelTextEl;
let cancelKeyEl;
let menuLevel = 'hidden';
const MENU_LAYERS = {
    root: {
        top: 'dynamic-top',
        right: {
            label: 'TACTIC',
            get sub() {
                // ã€è§£é”æ£€æŸ¥ã€‘enableAVS æˆ– enableCommander å…³é—­æ—¶æ˜¾ç¤º"ä¸å¯ç”¨"
                if (window.GAME_SETTINGS) {
                    if (window.GAME_SETTINGS.enableAVS === false) return 'ä¸å¯ç”¨';
                    if (window.GAME_SETTINGS.enableCommander === false) return 'ä¸å¯ç”¨';
                }
                // ã€Aceæ£€æŸ¥ã€‘éç‹ç‰Œå®å¯æ¢¦ä¸å¯ç”¨
                const p = window.battle?.getPlayer?.();
                const isAce = p?.isAce === true || p?.data?.isAce === true;
                if (!isAce) return 'ä¸å¯ç”¨';
                // å†·å´ä¸­æ˜¾ç¤ºå†·å´æ—¶é—´
                const cd = battleState.commandCooldown;
                if (cd > 0) return `å†·å´ä¸­: ${cd}å›åˆ`;
                return 'COMMAND PANEL';
            },
            theme: 'theme-tactics-entry',
            icon: ICON_SVGS.TACTIC,
            action: () => setMenuLevel('tactics'),
            check: () => battleState.canCommand,
        },
        bottom: {
            label: 'EVO',
            sub: 'çªç ´æé™',
            theme: 'theme-evo-bond',
            action: () => activateEvolution(),
            check: () => battleState.canEvo,
        },
        left: {
            label: 'STYLE',
            get sub() {
                // ã€è§£é”æ£€æŸ¥ã€‘enable_styles å…³é—­æ—¶æ˜¾ç¤º"ä¸å¯ç”¨"
                const unlocks = window.battle?.playerUnlocks || {};
                if (!unlocks.enable_styles) return 'ä¸å¯ç”¨';
                // å†·å´ä¸­æ˜¾ç¤ºå†·å´æ—¶é—´
                const cd = battleState.styleCooldown;
                if (cd > 0) return `ä¼‘æ†©ä¸­: ${cd}å›åˆ`;
                return 'Ancient Arts';
            },
            theme: 'theme-style-entry',
            icon: ICON_SVGS.STYLE_TAIJI,
            action: () => setMenuLevel('style'),
            check: () => battleState.canStyle,
        },
    },
    tactics: {
        top: {
            class: 'fix-scale',
            label: 'DODGE!',
            sub: 'å›é¿è¡ŒåŠ¨',
            theme: 'theme-insight',
            icon: ICON_SVGS.DODGE,
            action: () => sendCommand('dodge'),
        },
        right: {
            class: 'fix-scale',
            label: 'FOCUS!',
            sub: 'å¿…æ€ä¸€å‡»',
            theme: 'theme-passion',
            icon: ICON_SVGS.FOCUS,
            action: () => sendCommand('crit'),
        },
        bottom: {
            class: 'fix-scale',
            label: 'ENDURE!',
            sub: 'ç»å¢ƒåšå®ˆ',
            theme: 'theme-devotion',
            icon: ICON_SVGS.ENDURE,
            action: () => sendCommand('endure'),
        },
        left: {
            class: 'fix-scale',
            label: 'LISTEN!',
            sub: 'æ¸…é†’æ„å¿—',
            theme: 'theme-trust',
            icon: ICON_SVGS.LISTEN,
            action: () => sendCommand('cure'),
        },
    },
    style: {
        top: { label: '<span class="c1">è¿…</span><span class="c2">ç–¾</span>', sub: '', theme: 'theme-style-pure-agile', icon: null, action: () => selectStyle('agile') },
        bottom: { label: '<span class="c1">åˆš</span><span class="c2">çŒ›</span>', sub: '', theme: 'theme-style-pure-strong', icon: null, action: () => selectStyle('strong') },
        left: { label: '<span class="c1">å‡</span><span class="c2">ç¥</span>', sub: '', theme: 'theme-style-pure-focus', icon: null, action: () => selectStyle('focus') },
        right: { label: '<span class="c1">ä¼‘</span><span class="c2">æ†©</span>', sub: '', theme: 'theme-style-pure-back', icon: null, action: () => {} },
    },
};
function setMenuLevel(level) {
    if (level === 'hidden') {
        overlayEl.classList.add('hidden');
        menuLevel = 'hidden';
        updateCancelHint();
        return;
    }
    if (menuLevel === 'hidden') {
        overlayEl.classList.remove('hidden');
    }
    menuLevel = level;
    renderWheel(level);
    updateCancelHint();
}
function updateCancelHint() {
    if (!cancelTextEl || !cancelKeyEl) return;
    if (menuLevel === 'root' || menuLevel === 'hidden') {
        cancelTextEl.innerText = 'å…³é—­æŒ‡ä»¤';
        cancelKeyEl.innerText = 'X';
    } else {
        cancelTextEl.innerText = 'è¿”å›ä¸Šçº§';
        cancelKeyEl.innerText = 'ESC';
    }
}
function renderWheel(type) {
    let layerData;
    if (type === 'root') {
        const rootConfig = { ...MENU_LAYERS.root };
        rootConfig.top = getTopSlotConfig();
        rootConfig.bottom = getBottomSlotConfig();
        layerData = rootConfig;
    } else {
        layerData = MENU_LAYERS[type];
    }
    if (!layerData) return;
    QUADRANTS.forEach((pos) => {
        const btn = document.getElementById(`slot-${pos}`);
        if (!btn) return;
        // é‡ç½®ç±»åï¼Œæ¸…é™¤æ—§ä¸»é¢˜/çŠ¶æ€
        btn.className = `cmd-btn pos-${pos}`;
        const config = layerData[pos];
        const labelEl = btn.querySelector('.cmd-label');
        const subEl = btn.querySelector('.cmd-sub');
        const currentIconSvg = btn.querySelector('.icon-bg');
        if (!config) {
            btn.classList.add('disabled');
            if (labelEl) labelEl.innerText = '';
            if (subEl) subEl.innerText = '';
            if (currentIconSvg) currentIconSvg.remove();
            btn.disabled = true;
            return;
        }
        if (config.icon) {
            const newSvgString = config.icon.replace('<svg', '<svg class="icon-bg"');
            if (currentIconSvg) {
                currentIconSvg.outerHTML = newSvgString;
            } else {
                btn.insertAdjacentHTML('afterbegin', newSvgString);
            }
        } else {
            if (currentIconSvg) currentIconSvg.remove();
        }
        const isLocked = config.check ? !config.check() : false;
        if (labelEl) labelEl.innerHTML = config.label;
        // å¯¹äºæœ‰å†·å´çš„é¡¹ç›®ï¼Œæ˜¾ç¤ºå†·å´æ—¶é—´è€Œä¸æ˜¯"ä¸å¯ç”¨"
        const subText = typeof config.sub === 'string' ? config.sub : (config.sub || '');
        if (subEl) subEl.innerText = isLocked && !subText.includes('å†·å´') && !subText.includes('ä¼‘æ†©') ? 'ä¸å¯ç”¨' : subText;
        if (config.theme) {
            btn.classList.add(config.theme);
        }
        // æ·»åŠ é¢å¤–çš„ classï¼ˆå¦‚ fix-scaleï¼‰
        if (config.class) {
            btn.classList.add(config.class);
        }
        if (isLocked) {
            btn.disabled = true;
            btn.classList.add('disabled');
            btn.onclick = null;
        } else {
            btn.disabled = false;
            btn.onclick = () => config.action();
        }
        // å¼ºåˆ¶é‡ç»˜ï¼Œé¿å…æå°‘æ•°æ¸²æŸ“æ®‹ç•™
        btn.style.display = 'none';
        btn.offsetHeight;
        btn.style.display = '';
    });
}
function toggleCommanderRoot() {
    if (menuLevel === 'hidden') {
        setMenuLevel('root');
    } else {
        setMenuLevel('hidden');
    }
}
function handleCloseOrBack() {
    if (menuLevel === 'hidden') {
        setMenuLevel('hidden');
        return;
    }
    if (menuLevel === 'root') {
        setMenuLevel('hidden');
    } else {
        setMenuLevel('root');
    }
}
function sendCommand(cmd) {
    console.log(`[CMD] Command Sent: ${cmd}`);
    setMenuLevel('hidden');
    // è°ƒç”¨ä¸»é¡¹ç›®çš„ armCommand å‡½æ•°ï¼ˆè£…å¡«æ¨¡å¼ï¼‰
    let armed = false;
    if (typeof window.armCommand === 'function') {
        armed = window.armCommand(cmd);
    }
    // æ ¹æ®è£…å¡«ç»“æœå†³å®šæ‚¬æµ®çª—æ˜¾ç¤º
    if (armed) {
        // è£…å¡«æˆåŠŸï¼Œé”å®šæ‚¬æµ®çª—æ˜¾ç¤ºå½“å‰æŒ‡ä»¤
        SmartBubbleManager.lockToCommand(cmd);
    } else {
        // å–æ¶ˆæˆ–å¤±è´¥ï¼Œæ¢å¤è½®æ’­
        SmartBubbleManager.refresh();
    }
}
function activateGimmick(type) {
    console.log(`[CMD] Gimmick Triggered: ${type}`);
    setMenuLevel('hidden');
    // ã€å«æ¥ã€‘æ‰€æœ‰æœºåˆ¶ç»Ÿä¸€é€šè¿‡ toggleMega å‡½æ•°å¤„ç†
    // toggleMega å†…éƒ¨ä¼šæ ¹æ®å½“å‰å®å¯æ¢¦çš„ mechanic å­—æ®µåˆ¤æ–­æ˜¯ Mega/Dynamax/Tera
    if (typeof window.toggleMega === 'function') {
        window.toggleMega();
    }
    // æ ¹æ®å½“å‰æœºåˆ¶ç±»å‹ç¡®å®šæ‚¬æµ®çª—æ˜¾ç¤º
    const gimmickKey = battleState.gimmickType || 'mega';
    // æ£€æŸ¥æ˜¯å¦å·²è£…å¡«ï¼ˆarmedï¼‰- toggleMega ç»Ÿä¸€ä½¿ç”¨ playerMegaArmed
    const isArmed = window.battle?.playerMegaArmed;
    if (isArmed) {
        SmartBubbleManager.lockToGimmick(gimmickKey);
    } else {
        SmartBubbleManager.refresh();
    }
}
function activateEvolution(type) {
    console.log(`[CMD] Evolution Triggered: ${type}`);
    setMenuLevel('hidden');
    // å°†ä¼ å…¥çš„ç±»å‹æ˜ å°„ä¸ºå†…éƒ¨é”®
    const typeMap = {
        'Bio Evolution': 'bio',
        'Bond Evolution': 'bond',
        'bio': 'bio',
        'bond': 'bond'
    };
    const evoKey = typeMap[type] || 'bio';
    const evoInfo = {
        bio: { label: 'ç”Ÿå‘½è¿›åŒ–', color: '#2ecc71', cn: 'è¿›åŒ–' },
        bond: { label: 'ç¾ç»Šå…±é¸£', color: '#ff9f43', cn: 'å…±é¸£' }
    };
    const info = evoInfo[evoKey];
    const b = window.battle;
    // å¦‚æœå·²ç»è£…å¡«äº†åŒä¸€ä¸ªè¿›åŒ–ï¼Œåˆ™å–æ¶ˆï¼ˆä½¿ç”¨æ˜ å°„åçš„evoKeyæ¯”è¾ƒï¼‰
    if (b?.evoArmed === evoKey) {
        b.evoArmed = null;
        if (typeof window.log === 'function') {
            window.log(`<span style="color:#94a3b8">å–æ¶ˆ${info.label}é¢„å¤‡ã€‚</span>`);
        }
        console.log(`[CMD] Evolution disarmed: ${evoKey}`);
        SmartBubbleManager.refresh();
        return;
    }
    // ã€äº’æ–¥ã€‘é€‰æ‹©è¿›åŒ–æ—¶ï¼Œè‡ªåŠ¨å–æ¶ˆæŒ‡ä»¤å’Œé£æ ¼é¢„å¤‡
    if (b?.commandArmed) {
        window.log(`<span style="color:#94a3b8">å–æ¶ˆæŒ‡ä»¤é¢„å¤‡ï¼Œåˆ‡æ¢ä¸ºè¿›åŒ–æ¨¡å¼ã€‚</span>`);
        b.commandArmed = null;
    }
    if (window.currentMoveStyle && window.currentMoveStyle !== 'normal') {
        window.log(`<span style="color:#94a3b8">å–æ¶ˆé£æ ¼é¢„å¤‡ï¼Œåˆ‡æ¢ä¸ºè¿›åŒ–æ¨¡å¼ã€‚</span>`);
        window.currentMoveStyle = 'normal';
        if (typeof window.setMoveStyle === 'function') {
            window.setMoveStyle('normal');
        }
    }
    // è£…å¡«è¿›åŒ–ï¼ˆä½¿ç”¨æ˜ å°„åçš„evoKeyï¼‰
    if (b) b.evoArmed = evoKey;
    if (typeof window.log === 'function') {
        window.log(`<span style="color:${info.color}">âœ¨ ${info.label}å°±ç»ªï¼é€‰æ‹©æ‹›å¼åå°†è§¦å‘${info.cn}ï¼</span>`);
    }
    console.log(`[CMD] Evolution armed: ${evoKey}`);
    // é”å®šæ‚¬æµ®çª—æ˜¾ç¤ºè¿›åŒ–ï¼ˆä½¿ç”¨æ˜ å°„åçš„evoKeyï¼‰
    SmartBubbleManager.lockToEvo(evoKey);
}
function selectStyle(style) {
    console.log(`[CMD] selectStyle called with: ${style}`);
    setMenuLevel('hidden');
    const styleInfo = {
        agile: { label: 'è¿…ç–¾', color: '#00d2d3', cn: 'è¿…ç–¾é£æ ¼' },
        strong: { label: 'åˆšçŒ›', color: '#ff4757', cn: 'åˆšçŒ›é£æ ¼' },
        focus: { label: 'å‡ç¥', color: '#2f9e44', cn: 'å‡ç¥é£æ ¼' },
        normal: { label: 'æ™®é€š', color: '#dcdde1', cn: 'æ™®é€šé£æ ¼' }
    };
    const info = styleInfo[style] || styleInfo.normal;
    // ã€äº’æ–¥ã€‘é€‰æ‹©é£æ ¼æ—¶ï¼Œè‡ªåŠ¨å–æ¶ˆæŒ‡ä»¤é¢„å¤‡
    if (style && style !== 'normal' && window.battle?.commandArmed) {
        window.log(`<span style="color:#94a3b8">å–æ¶ˆæŒ‡ä»¤é¢„å¤‡ï¼Œåˆ‡æ¢ä¸ºé£æ ¼æ¨¡å¼ã€‚</span>`);
        window.battle.commandArmed = null;
    }
    // ã€äº’æ–¥ã€‘é€‰æ‹©é£æ ¼æ—¶ï¼Œè‡ªåŠ¨å–æ¶ˆè¿›åŒ–é¢„å¤‡
    if (style && style !== 'normal' && window.battle?.evoArmed) {
        window.log(`<span style="color:#94a3b8">å–æ¶ˆè¿›åŒ–é¢„å¤‡ï¼Œåˆ‡æ¢ä¸ºé£æ ¼æ¨¡å¼ã€‚</span>`);
        window.battle.evoArmed = null;
    }
    // ç›´æ¥è®¾ç½®å…¨å±€å˜é‡ï¼Œç¡®ä¿æˆ˜æ–—é€»è¾‘èƒ½è¯»å–
    window.currentMoveStyle = style || 'normal';
    console.log(`[CMD] window.currentMoveStyle set to: ${window.currentMoveStyle}`);
    // åŒæ—¶è°ƒç”¨ setMoveStyle æ›´æ–° UI
    if (typeof window.setMoveStyle === 'function') {
        window.setMoveStyle(style || 'normal');
    }
    // è¾“å‡ºæˆ˜æ–—æ—¥å¿—
    if (typeof window.log === 'function') {
        if (style && style !== 'normal') {
            window.log(`<span style="color:${info.color}">âš”ï¸ ${info.cn}å°±ç»ªï¼é€‰æ‹©æ‹›å¼åå°†ä»¥${info.label}é£æ ¼å‡ºæ‹›ï¼</span>`);
        } else {
            window.log(`<span style="color:#94a3b8">å–æ¶ˆé£æ ¼é¢„å¤‡ï¼Œå›å½’æ™®é€šé£æ ¼ã€‚</span>`);
        }
    }
    // é”å®šæ‚¬æµ®çª—æ˜¾ç¤ºå½“å‰é£æ ¼
    if (style && style !== 'normal') {
        SmartBubbleManager.lockToStyle(style);
    } else {
        SmartBubbleManager.refresh();
    }
}
function handleQuadrant() {
    return false;
}
function initializeCommanderSystem() {
    overlayEl = document.getElementById('commander-overlay');
    cancelTextEl = document.getElementById('cancel-text');
    cancelKeyEl = document.getElementById('cancel-key-text');
    const prevLevel = menuLevel;
    menuLevel = 'root';
    renderWheel('root');
    menuLevel = prevLevel;
    overlayEl?.classList.add('hidden');
    updateCancelHint();
    window.battleState = battleState;
    window.toggleCommanderRoot = toggleCommanderRoot;
    window.handleQuadrant = handleQuadrant;
    window.handleCloseOrBack = handleCloseOrBack;
}
const SmartBubbleManager = {
    intervalId: null,
    queue: [],
    currentIndex: 0,
    lockedState: null,
    ready: false,
    transitionTimeout: null,
    dom: {
        root: null,
        stage: null,
        label: null,
        timer: null,
    },
    init() {
        this.dom.root = document.getElementById('smart-bubble');
        this.dom.stage = document.getElementById('bubble-icon-stage');
        this.dom.label = document.getElementById('bubble-text');
        this.dom.timer = document.getElementById('bubble-timer-circle');
        if (!this.dom.root || !this.dom.stage || !this.dom.label) return;
        this.ready = true;
        this.scanBattleState();
        this.startLoop();
    },
    refresh() {
        if (!this.ready) return;
        this.scanBattleState();
        this.startLoop();
    },
    scanBattleState() {
        if (!this.ready) return;
        // ä¸å†æ£€æŸ¥ currentStyle æ¥é”å®šçŠ¶æ€ï¼Œå§‹ç»ˆä¿æŒè½®æ’­
        this.lockedState = null;
        this.dom.root.classList.remove('locked');
        this.queue = [];
        this.currentIndex = 0;
        if (battleState.canGimmick && battleState.gimmickType && battleState.gimmickType !== 'none') {
            const config = getTopSlotConfig();
            this.queue.push({
                type: 'gimmick',
                subtype: battleState.gimmickType,
                icon: config.icon,
                label: config.label,
                themeColor: this.getColorForGimmick(battleState.gimmickType),
            });
        }
        if (battleState.canEvo && battleState.evoType && battleState.evoType !== 'none') {
            const config = getBottomSlotConfig();
            this.queue.push({
                type: 'evo',
                subtype: battleState.evoType,
                icon: config.icon,
                label: 'EVOLUTION',
                themeColor: battleState.evoType === 'bio' ? '#2ecc71' : '#ff9f43',
            });
        }
        if (battleState.canStyle) {
            this.queue.push({
                type: 'style',
                subtype: 'available',
                icon: ICON_SVGS.STYLE_TAIJI,
                label: 'ARTS',
                themeColor: '#dcdde1',
            });
        }
        if (battleState.canCommand) {
            this.queue.push({
                type: 'tactic',
                subtype: 'available',
                icon: ICON_SVGS.TACTIC,
                label: 'TACTIC',
                themeColor: '#ff9f43',
            });
        }
        if (!this.queue.length) {
            this.queue.push({
                type: 'empty',
                icon: null,
                label: 'READY',
                themeColor: '#666',
            });
        }
        this.render(this.queue[0]);
        this.currentIndex = this.queue.length > 1 ? 1 : 0;
    },
    lockToStyle(style) {
        this.stopLoop();
        const styleConfig = {
            agile: { text: 'è¿…', label: 'AGILE', themeColor: '#00d2d3' },
            strong: { text: 'åˆš', label: 'STRONG', themeColor: '#ff4757' },
            focus: { text: 'å‡', label: 'FOCUS', themeColor: '#2f9e44' },
        };
        const config = styleConfig[style] || { text: 'é“', label: 'NORMAL', themeColor: '#dcdde1' };
        this.lockedState = { icon: null, text: config.text, label: config.label, themeColor: config.themeColor };
        this.dom.root.classList.add('locked');
        this.render(this.lockedState);
    },
    lockToCommand(cmd) {
        this.stopLoop();
        const cmdConfig = {
            dodge: { text: 'é—ª', label: 'DODGE', themeColor: '#48CAE4' },
            crit: { text: 'å‡»', label: 'FOCUS', themeColor: '#ff9f43' },
            endure: { text: 'å¿', label: 'ENDURE', themeColor: '#2f9e44' },
            cure: { text: 'é†’', label: 'LISTEN', themeColor: '#a855f7' },
        };
        const config = cmdConfig[cmd] || { text: 'ä»¤', label: 'COMMAND', themeColor: '#ff9f43' };
        this.lockedState = { icon: null, text: config.text, label: config.label, themeColor: config.themeColor };
        this.dom.root.classList.add('locked');
        this.render(this.lockedState);
    },
    lockToGimmick(gimmickType) {
        this.stopLoop();
        const gimmickConfig = {
            mega: { icon: ICON_SVGS.MEGA, label: 'MEGA', themeColor: '#ec4899' },
            zmove: { icon: ICON_SVGS.Z_CRYSTAL, label: 'Z-POWER', themeColor: '#f59e0b' },
            dyna: { icon: ICON_SVGS.DYNA, label: 'DYNAMAX', themeColor: '#e11d48' },
            tera: { icon: ICON_SVGS.TERA, label: 'TERA', themeColor: '#06b6d4' },
        };
        const config = gimmickConfig[gimmickType] || gimmickConfig.mega;
        this.lockedState = { icon: config.icon, text: null, label: config.label, themeColor: config.themeColor };
        this.dom.root.classList.add('locked');
        this.render(this.lockedState);
    },
    lockToEvo(evoType) {
        this.stopLoop();
        const evoConfig = {
            bio: { icon: ICON_SVGS.BIO, text: 'åŒ–', label: 'EVOLVE', themeColor: '#2ecc71' },
            bond: { icon: ICON_SVGS.BOND, text: 'ç»Š', label: 'BOND', themeColor: '#ff9f43' },
        };
        const config = evoConfig[evoType] || evoConfig.bio;
        this.lockedState = { icon: config.icon, text: config.text, label: config.label, themeColor: config.themeColor };
        this.dom.root.classList.add('locked');
        this.render(this.lockedState);
    },
    startLoop() {
        this.stopLoop();
        if (this.lockedState || !this.queue.length) return;
        this.intervalId = setInterval(() => this.cycle(), 3000);
    },
    stopLoop() {
        if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
        }
    },
    cycle() {
        if (this.lockedState || !this.queue.length) return;
        const item = this.queue[this.currentIndex];
        this.render(item);
        this.currentIndex = (this.currentIndex + 1) % this.queue.length;
    },
    render(item) {
        if (!this.ready || !item) return;
        this.dom.root.style.setProperty('--bubble-color', item.themeColor || '#00d2d3');
        this.dom.root.classList.toggle('locked', !!this.lockedState);
        const stage = this.dom.stage;
        const alignLeft = item.type === 'style' && item.subtype === 'available';
        stage.classList.toggle('align-left', alignLeft);
        if (this.transitionTimeout) {
            clearTimeout(this.transitionTimeout);
            this.transitionTimeout = null;
        }
        stage.classList.add('switching-out');
        this.transitionTimeout = setTimeout(() => {
            stage.innerHTML = '';
            if (item.icon) {
                const svgHTML = item.icon.replace('<svg', '<svg style="width:100%;height:100%;fill:currentColor;"');
                stage.insertAdjacentHTML('afterbegin', svgHTML);
            } else if (item.text) {
                stage.innerHTML = `<span class="bubble-big-text">${item.text}</span>`;
            } else {
                stage.innerHTML = '<span class="bubble-big-text">--</span>';
            }
            this.dom.label.innerText = item.label || '';
            stage.classList.remove('switching-out');
        }, 200);
        this.resetTimer();
    },
    resetTimer() {
        if (!this.dom.timer) return;
        this.dom.timer.style.animation = 'none';
        // force reflow
        // eslint-disable-next-line no-unused-expressions
        this.dom.timer.offsetHeight;
        if (this.lockedState) {
            this.dom.timer.style.animation = 'none';
        } else {
            this.dom.timer.style.animation = 'bubble-time 3s linear infinite';
        }
    },
    getColorForGimmick(type) {
        switch (type) {
            case 'mega':
                return '#d946ef';
            case 'zmove':
                return '#ffd700';
            case 'dyna':
                return '#ff0055';
            case 'tera':
                return '#22d3ee';
            default:
                return '#ffffff';
        }
    },
};
// å¯¼å‡ºåˆ°å…¨å±€ï¼Œä¾›ä¸»é¡¹ç›®è°ƒç”¨
window.initCommanderSystemV2 = function() {
    initializeCommanderSystem();
    SmartBubbleManager.init();
    console.log('[CMD V2] Commander System V2 initialized');
};
window.refreshCommanderBubble = function() {
    SmartBubbleManager.refresh();
};
// éšè— Smart Bubble ç›´åˆ°æˆ˜æ–—å¼€å§‹
window.showCommanderBubble = function() {
    const bubble = document.getElementById('smart-bubble');
    if (bubble) {
        bubble.style.display = '';
        SmartBubbleManager.refresh();
    }
};
window.hideCommanderBubble = function() {
    const bubble = document.getElementById('smart-bubble');
    if (bubble) {
        bubble.style.display = 'none';
    }
};
// DOM åŠ è½½ååˆå§‹åŒ– UI ç»“æ„
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            if (document.getElementById('smart-bubble')) {
                initializeCommanderSystem();
                console.log('[CMD V2] Commander System V2 UI initialized');
            }
        }, 100);
    });
} else {
    setTimeout(() => {
        if (document.getElementById('smart-bubble')) {
            initializeCommanderSystem();
            console.log('[CMD V2] Commander System V2 UI initialized');
        }
    }, 100);
}
]]></file>
        <file name="styles.css"><![CDATA[/* CMD ç»„ä»¶ä¸“ç”¨å­—ä½“å˜é‡ - ä¸å½±å“ä¸»é¡¹ç›® */
#commander-overlay,
#smart-bubble,
.commander-container,
.cmd-btn {
    --cmd-font-main: 'Exo 2', sans-serif;
}
body {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    background-color: #0c0f13;
    background-image:
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
    background-size: 50px 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--cmd-font-main, 'Exo 2', sans-serif);
    color: #f5f6fa;
}
/* å¤–éƒ¨å®¹å™¨ï¼šæä¾›ä¸€ä¸ªå±•ç¤ºèˆå° */
.commander-stage {
    position: relative;
    width: min(90vw, 720px);
    aspect-ratio: 1;
    border-radius: 48px;
    border: 1px solid rgba(255,255,255,0.08);
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.15), transparent 45%),
                radial-gradient(circle at 70% 70%, rgba(0,210,255,0.08), transparent 55%),
                #050608;
    box-shadow: 0 35px 80px rgba(0,0,0,0.65);
    overflow: hidden;
}
.stage-backdrop,
.stage-backdrop::after {
    position: absolute;
    inset: 0;
}
.stage-backdrop::after {
    content: '';
    background-image:
        linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.4;
}
/* =========================================
   COMMANDER SYSTEM STYLES (æœºæ¢°å¿«é—¨é£æ ¼)
   ========================================= */
/* 1. Commander Layer (å®¹å™¨) */
#commander-overlay {
    position: absolute;
    inset: 0;
    z-index: 9000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.4);
    opacity: 1;
    pointer-events: auto;
    backdrop-filter: blur(4px);
    transition: opacity 0.25s ease, backdrop-filter 0.25s ease;
}
#commander-overlay:not(.hidden) {
    animation: overlay-fade-in 0.3s ease-out;
    visibility: visible;
}
#commander-overlay.hidden {
    opacity: 0 !important;
    pointer-events: none !important;
    backdrop-filter: blur(0px) !important;
    visibility: hidden;
    transition: opacity 0.25s ease, backdrop-filter 0.25s ease, visibility 0s linear 0.25s;
}
@keyframes overlay-fade-in {
    0% {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    100% {
        opacity: 1;
        backdrop-filter: blur(4px);
    }
}
/* 2. Center Core (æœºæ¢°å¿«é—¨æ ¸å¿ƒ) */
.cmd-hub {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    z-index: 20;
    pointer-events: none;
    border-radius: 50%;
    background: #1e1e1e;
    box-shadow:
        0 0 0 3px #2d3436,
        0 0 0 5px #121417;
    display: flex;
    align-items: center;
    justify-content: center;
}
.pulse-ring {
    width: 10px;
    height: 10px;
    background: #333;
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 50%;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
    transition: background 0.3s;
}
#commander-overlay:hover .pulse-ring {
    background: #747d8c;
}
/* 3. The Radial System (æ—‹è½¬åå­—å¸ƒå±€) */
.commander-container {
    position: relative;
    width: 360px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 40px;
}
.commander-title {
    display: none;
}
.commander-wheel {
    position: relative;
    width: 360px;
    height: 360px;
    transform: rotate(-45deg);
}
.cmd-btn {
    position: absolute;
    width: calc(50% - 8px);
    height: calc(50% - 8px);
    background: #fff;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    overflow: visible;
    outline: none;
    transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), background-color 0.2s;
    -webkit-mask: radial-gradient(circle at var(--org-x) var(--org-y), transparent 45px, black 46px);
    mask: radial-gradient(circle at var(--org-x) var(--org-y), transparent 45px, black 46px);
    opacity: 0;
    animation: btn-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}
@keyframes btn-slide-in {
    0% {
        opacity: 0;
        transform: scale(0.8);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}
.cmd-content {
    width: 100%;
    height: 100%;
    transform: rotate(45deg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    position: relative;
}
.pos-top {
    top: 0;
    right: 0;
    border-radius: 0 100px 0 0;
    --org-x: 0%;
    --org-y: 100%;
    transform-origin: -20% 120%;
    animation-delay: 0.1s;
}
.pos-right {
    bottom: 0;
    right: 0;
    border-radius: 0 0 100px 0;
    --org-x: 0%;
    --org-y: 0%;
    transform-origin: -20% -20%;
    animation-delay: 0.15s;
}
.pos-bottom {
    bottom: 0;
    left: 0;
    border-radius: 0 0 0 100px;
    --org-x: 100%;
    --org-y: 0%;
    transform-origin: 120% -20%;
    animation-delay: 0.2s;
}
.pos-left {
    top: 0;
    left: 0;
    border-radius: 100px 0 0 0;
    --org-x: 100%;
    --org-y: 100%;
    transform-origin: 120% 120%;
    animation-delay: 0.25s;
}
.cmd-label {
    font-family: var(--cmd-font-main, 'Exo 2', sans-serif);
    font-size: 1.8rem;
    font-weight: 900;
    color: var(--active-c);
    margin: 0;
    padding: 0;
    line-height: 0.9;
    letter-spacing: -1px;
    font-style: italic;
    text-transform: uppercase;
    transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: inline-block;
    transform-origin: center;
}
.cmd-sub {
    font-family: var(--cmd-font-main, 'Exo 2', sans-serif);
    font-size: 0.8rem;
    font-weight: 800;
    color: var(--active-c);
    opacity: 0.8;
    margin-top: 6px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    transition: color 0.2s;
}
.icon-bg {
    position: absolute;
    top: 65%;
    left: 65%;
    transform: translate(-50%, -50%) rotate(45deg);
    width: 200px;
    height: 200px;
    opacity: 0.15;
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 0;
}
.theme-insight .icon-bg,
.theme-insight .icon-bg path,
.theme-insight .icon-bg g { fill: #00d2d3; }
.theme-trust .icon-bg,
.theme-trust .icon-bg path,
.theme-trust .icon-bg g { fill: #ff9f43; }
.theme-passion .icon-bg,
.theme-passion .icon-bg path,
.theme-passion .icon-bg g { fill: #ff6b6b; }
.theme-devotion .icon-bg,
.theme-devotion .icon-bg path,
.theme-devotion .icon-bg g { fill: #a55eea; }
.cmd-emoji {
    display: none;
}
.theme-insight  { --active-c: #00d2d3; }
.theme-trust    { --active-c: #ff9f43; }
.theme-passion  { --active-c: #ff6b6b; }
.theme-devotion { --active-c: #a55eea; }
.cmd-btn:hover {
    z-index: 50;
    background: var(--active-c);
    box-shadow: 0 0 0 6px rgba(255,255,255,0.1);
}
@keyframes text-shout {
    0% {
        transform: scale(1) rotate(0deg);
        text-shadow: 0 0 0 transparent;
    }
    20% {
        transform: scale(1.5) rotate(-3deg);
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.9);
    }
    40% {
        transform: scale(1.2) rotate(2deg);
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
    }
    60% {
        transform: scale(1.35) rotate(-1deg);
        text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
    }
    80% {
        transform: scale(1.25) rotate(0deg);
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }
    100% {
        transform: scale(1.3);
        text-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
    }
}
.cmd-btn:hover .cmd-label {
    color: #121417;
    animation: text-shout 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
.cmd-btn:hover .cmd-sub {
    color: #121417;
    opacity: 0.9;
}
.cmd-btn:hover .icon-bg,
.cmd-btn:hover .icon-bg path,
.cmd-btn:hover .icon-bg g {
    fill: #000 !important;
}
.cmd-btn:hover .icon-bg {
    opacity: 0.2;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(30deg) scale(1.1);
}
.cmd-btn:active {
    transform: scale(0.98);
    background: #f1f2f6;
    transition: 0.05s;
}
.cmd-btn:disabled {
    opacity: 0.4;
    pointer-events: none;
    filter: grayscale(1);
}
.cmd-cancel-hint {
    position: relative;
    background: #2d3436;
    border: 2px solid #57606f;
    border-radius: 99px;
    padding: 12px 40px;
    color: #fff;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-weight: 900;
    font-size: 1rem;
    letter-spacing: 2px;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: 0.2s;
    animation: cancel-fade-in 0.4s ease-out 0.3s both;
}
@keyframes cancel-fade-in {
    0% {
        opacity: 0;
        transform: translateY(20px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}
.cmd-cancel-hint:hover {
    background: #fff;
    border-color: #fff;
    color: #2d3436;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255,255,255,0.3);
}
.cmd-cancel-hint .key {
    display: inline-block;
    padding: 3px 10px;
    background: #333;
    border: 1px solid #666;
    border-radius: 4px;
    margin-right: 8px;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-weight: 900;
    font-size: 0.85rem;
    transition: 0.2s;
}
.cmd-cancel-hint:hover .key {
    background: #e0e0e0;
    border-color: #ccc;
    color: #2d3436;
}
]]></file>
        <file name="theme-update.css"><![CDATA[/* ==============================================
   SMART BUBBLE COMPONENT (æ™ºèƒ½æˆ˜æœ¯æ‚¬æµ®çª—)
   ============================================== */
.smart-bubble-wrapper {
    position: absolute;
    left: 40px;
    top: 50%;
    transform: translateY(-50%);
    width: 64px;
    height: 64px;
    z-index: 900;  /* ä½äºç»“ç®—ç”»é¢(999)ï¼Œç¡®ä¿åœ¨æ»¤ç½©ä¹‹ä¸‹ */
    cursor: pointer;
    --bubble-color: #00d2d3;
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.smart-bubble-wrapper:hover {
    transform: translateY(-50%) scale(1.1);
}
.bubble-core {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: rgba(10, 12, 18, 0.9);
    border: 2px solid var(--bubble-color);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5), 0 0 15px var(--bubble-color);
    transition: border-color 0.5s, box-shadow 0.5s;
}
.bubble-icon-stage {
    width: 65%;
    height: 65%;
    color: var(--bubble-color);
    display: flex;
    align-items: center;
    justify-content: center;
    transition:
        opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        filter 0.3s ease;
    filter: drop-shadow(0 0 5px var(--bubble-color));
}
.bubble-icon-stage.align-left {
    justify-content: flex-start;
    padding-right: 5px;
    padding-bottom: 5px;
}
.bubble-icon-stage.switching-out {
    opacity: 0;
    transform: scale(0.92);
    filter: drop-shadow(0 0 0 transparent) blur(4px);
}
.bubble-glow-ring {
    position: absolute;
    inset: -10px;
    border-radius: 50%;
    border: 2px solid var(--bubble-color);
    opacity: 0;
    pointer-events: none;
    animation: bubble-ping 3s cubic-bezier(0, 0, 0.2, 1) infinite;
}
@keyframes bubble-ping {
    0% { transform: scale(0.8); opacity: 0.8; }
    75%, 100% { transform: scale(1.6); opacity: 0; }
}
.bubble-label-pill {
    position: absolute;
    bottom: -22px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.85);
    color: var(--bubble-color);
    border: 1px solid var(--bubble-color);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.65rem;
    font-weight: 900;
    font-family: 'Exo 2', sans-serif;
    letter-spacing: 1px;
    white-space: nowrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    transition: color 0.3s, border-color 0.3s;
}
.bubble-progress {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-90deg);
    width: 76px;
    height: 76px;
    pointer-events: none;
}
#bubble-timer-circle {
    stroke: var(--bubble-color);
    stroke-opacity: 0.6;
    stroke-dasharray: 289;
    animation: bubble-time 3s linear infinite;
    transition: stroke 0.5s;
}
@keyframes bubble-time {
    from { stroke-dashoffset: 0; }
    to { stroke-dashoffset: 289; }
}
.smart-bubble-wrapper.locked #bubble-timer-circle {
    animation: none;
    stroke-dashoffset: 0;
    stroke-opacity: 0.3;
}
.bubble-big-text {
    font-family: 'Zhi Mang Xing', cursive;
    font-size: 2.5rem;
    line-height: 1;
    color: currentColor;
}
/* =========================================
   LEVEL 1 SLOT: TACTIC (Holographic HUD)
   ä¸€çº§å…¥å£ï¼šæŒ‡æŒ¥å®˜æˆ˜æœ¯é¢æ¿
   ========================================= */
.cmd-btn.theme-tactics-entry {
    background-color: #171b21;
    background-image: 
        linear-gradient(rgba(255, 159, 67, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 159, 67, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    background-position: center;
    box-shadow: 
        inset 0 0 0 1px rgba(255, 159, 67, 0.3),
        inset 0 0 20px rgba(0, 0, 0, 0.8);
    color: #ff9f43;
    overflow: hidden;
    transition: all 0.2s ease-out;
}
.cmd-btn.theme-tactics-entry::after {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 300%;
    background: linear-gradient(to bottom, transparent 40%, rgba(255, 159, 67, 0.1) 50%, transparent 60%);
    animation: holo-scan 4s linear infinite;
    pointer-events: none;
    z-index: 1;
}
.cmd-btn.theme-tactics-entry .cmd-label {
    font-family: 'Exo 2', 'Rubik', sans-serif !important;
    font-weight: 800;
    font-style: italic;
    font-size: 1.6rem;
    color: #ff9f43;
    text-shadow: 
        0 0 5px rgba(255, 159, 67, 0.4),
        2px 2px 0px rgba(0,0,0,0.5);
    letter-spacing: -0.5px;
    z-index: 10;
    transition: transform 0.2s;
}
.cmd-btn.theme-tactics-entry .cmd-sub {
    font-family: 'Noto Sans SC', 'Exo 2', sans-serif;
    color: #ffcba4;
    font-size: 0.75rem;
    letter-spacing: 1.5px;
    z-index: 10;
    background: rgba(255, 159, 67, 0.15);
    padding: 2px 8px;
    border-radius: 2px;
}
.cmd-btn.theme-tactics-entry svg.icon-bg {
    width: 260px !important;
    height: 260px !important;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: #ff9f43;
    opacity: 0.2 !important;
    z-index: 0;
    mix-blend-mode: screen;
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.cmd-btn.theme-tactics-entry .hud-ring-outer {
    transform-origin: 50px 50px;
    animation: spin-slow 20s linear infinite;
}
.cmd-btn.theme-tactics-entry:hover {
    z-index: 50; 
    background-color: #2f271d;
    background-size: 22px 22px;
    box-shadow: 
        inset 0 0 0 2px #ff9f43,
        0 0 20px rgba(255, 159, 67, 0.3);
}
.cmd-btn.theme-tactics-entry:hover .cmd-label {
    transform: scale(1.1) skewX(-10deg);
    color: #fff;
    text-shadow: 0 0 10px #ff9f43;
}
.cmd-btn.theme-tactics-entry:hover .cmd-sub {
    background: #ff9f43;
    color: #000;
}
.cmd-btn.theme-tactics-entry:hover svg.icon-bg {
    opacity: 0.8 !important;
    color: #ffaf40;
    filter: drop-shadow(0 0 5px #ff9f43);
    transform: translate(-50%, -50%) scale(0.9);
}
.cmd-btn.theme-tactics-entry:hover .hud-arc {
    animation: hud-lock-in 0.4s ease-out forwards;
}
.cmd-btn.theme-tactics-entry:hover .hud-chevrons path {
    animation: hud-bg-pulse 1s infinite alternate;
}
.cmd-btn.theme-tactics-entry:hover::before {
    content: '';
    position: absolute;
    right: 0; top: 0; bottom: 0;
    width: 60px;
    background: repeating-linear-gradient(
        0deg,
        transparent, transparent 4px,
        rgba(255, 159, 67, 0.4) 4px, rgba(255, 159, 67, 0.4) 5px
    );
    opacity: 0.3;
    pointer-events: none;
    z-index: 1;
}
@keyframes holo-scan {
    0% { transform: translateY(-50px); opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { transform: translateY(150px); opacity: 0; }
}
@keyframes spin-slow {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
@keyframes hud-lock-in {
    0% { transform: rotate(-45deg) scale(1.1); transform-origin: 50% 50%; opacity: 0.5; }
    100% { transform: rotate(0deg) scale(1); transform-origin: 50% 50%; opacity: 1; }
}
@keyframes hud-bg-pulse {
    from { opacity: 0.5; transform: scale(1); }
    to { opacity: 1; transform: scale(1.1); translate: 1px 1px; }
}
.icon-mega { color: #cc74e4; text-shadow: 0 0 5px #cc74e4; }
.icon-evo  { color: #ffd700; text-shadow: 0 0 5px #ffd700; }
.icon-style-agile { color: #00d2d3; }
.icon-style-strong { color: #ff6b6b; }
.icon-tactics { color: #a4b0be; }
@keyframes trigger-cycle {
    90% { transform: translateY(0); opacity: 1; }
    95% { transform: translateY(-30px); opacity: 0; }
    100% { transform: translateY(30px); opacity: 0; }
}
/* =================================
   Level 1 Themes (é¡¶çº§èœå•ä¸»é¢˜è‰²)
   ================================= */
.theme-gimmick { --active-c: #e056fd; }
.theme-gimmick.type-z { --active-c: #ffffff; }
.theme-gimmick.type-dyna { --active-c: #ff0055; }
.theme-evo-bond { --active-c: #ffd700; }
.theme-evo-bio  { --active-c: #4cd137; }
.theme-style-entry { --active-c: #576574; }
.theme-tactics-entry { --active-c: #ff9f43; }
/* =================================
   äºŒçº§ï¼šæ´—ç¿ æµæ´¾ä¸“ç”¨è‰²
   ================================= */
.theme-style-blue { --active-c: #00d2d3; }
.theme-style-red  { --active-c: #ff4757; }
.theme-style-base { --active-c: #dfe4ea; }
.theme-nav-back   { --active-c: #57606f; }
/* Active selection highlight */
.cmd-btn.active-selection {
    box-shadow: 0 0 0 4px rgba(255,255,255,0.25);
}
.cmd-btn.disabled,
.cmd-btn:disabled {
    opacity: 0.4;
    pointer-events: none;
    filter: grayscale(1) brightness(0.7) !important;
}
/* =========================================
   STYLE: MEGA EVOLUTION (Mystic DNA)
   ========================================= */
/* Use rainbow gradient defined in index.html defs */
.theme-mega .icon-bg {
    fill: url(#mega-rainbow) !important;
    stroke: none;
}
/* Normal state: deep purple core + neon border */
.cmd-btn.theme-mega {
    background: radial-gradient(circle at center, #3b0a70 0%, #17032e 120%);
    box-shadow:
        /* å†…è¾¹æ¡†ï¼šæ·±ç´«å†…å‘å…‰ */
        inset 0 0 15px rgba(139, 92, 246, 0.12),
        inset 0 0 2px 1px rgba(168, 85, 247, 0.9),
        /* å¤–è¾¹æ¡†ï¼šç´«è‰²éœ“è™¹è¾‰å…‰ */
        0 0 0 2px rgba(168, 85, 247, 0.8),
        0 0 8px 2px rgba(192, 38, 211, 0.5),
        0 0 20px 4px rgba(139, 92, 246, 0.3);
    overflow: hidden;
}
.cmd-btn.theme-mega .cmd-label {
    color: #fce7f3;
    font-size: 34px;
    text-shadow:
        0 0 5px #d946ef,
        0 0 10px #c026d3,
        0 0 20px #86198f;
    z-index: 10;
}
.cmd-btn.theme-mega .cmd-sub {
    color: #ffd900;
    opacity: 0.8;
    z-index: 10;
}
.cmd-btn.theme-mega .icon-bg {
    opacity: 0.15;
    transform: translate(-50%, -50%) rotate(45deg) scale(1);
    transition: all 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    mix-blend-mode: screen;
    top: 72%;
    left: 65%;
    z-index: 0;
    pointer-events: none;
}
/* Hover burst state */
@keyframes rainbow-flow {
    0% { filter: blur(0.8px) hue-rotate(0deg) drop-shadow(0 0 5px rgba(255, 100, 200, 0.5)); }
    50% { filter: blur(1.2px) hue-rotate(180deg) drop-shadow(0 0 10px rgba(100, 255, 255, 0.6)); }
    100% { filter: blur(0.8px) hue-rotate(360deg) drop-shadow(0 0 5px rgba(255, 100, 200, 0.5)); }
}
.cmd-btn.theme-mega:hover {
    z-index: 50;
    background: linear-gradient(135deg, #ffffff 20%, #eff6ff 100%);
    box-shadow:
        /* å†…è¾¹æ¡†ï¼šå¤šå±‚å½©è™¹å†…è¾‰å…‰ */
        inset 0 0 0 2px rgba(255, 235, 59, 0.95),
        inset 0 0 6px 3px rgba(255, 156, 214, 0.95),
        inset 0 0 10px 4px rgba(90, 255, 218, 0.9),
        inset 0 0 14px 6px rgba(75, 207, 250, 0.9),
        inset 0 0 18px 8px rgba(212, 155, 253, 0.85),
}
.cmd-btn.theme-mega:hover .cmd-label {
    color: transparent !important;
    background: linear-gradient(135deg, #ff3f8e 0%, #f9a602 25%, #00c896 50%, #0090ff 75%, #9b5cf4 100%);
    -webkit-background-clip: text;
    background-clip: text;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.35);
    animation: text-shout 0.4s ease forwards;
    z-index: 20;
}
.cmd-btn.theme-mega:hover .cmd-sub {
    color: transparent !important;
    background: linear-gradient(135deg, #ff3f8e 0%, #f9a602 25%, #00c896 50%, #0090ff 75%, #9b5cf4 100%);
    -webkit-background-clip: text;
    background-clip: text;
    font-weight: 800;
    text-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
    z-index: 20;
}
.cmd-btn.theme-mega:hover .icon-bg,
.cmd-btn.theme-mega:hover .icon-bg path,
.cmd-btn.theme-mega:hover .icon-bg g {
    fill: url(#mega-rainbow) !important;
    stroke: none !important;
}
.cmd-btn.theme-mega:hover .icon-bg {
    opacity: 0.9;
    top: 68%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(0deg) scale(1.1);
    mix-blend-mode: normal;
    animation: rainbow-flow 3s linear infinite;
    z-index: 0;
}
/* ----------------Z-MOVE THEME---------------- */
.cmd-btn.theme-zmove {
    background: linear-gradient(135deg, #013A63 0%, #001219 90%);
    box-shadow:
        inset 0 0 0 2px rgba(72, 202, 228, 0.7),
        inset 0 0 20px rgba(0, 0, 0, 0.6),
        0 4px 10px rgba(0, 119, 182, 0.2);
    overflow: hidden;
    transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.cmd-btn.theme-zmove::after {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0.1;
    background-image:
        linear-gradient(45deg, #48CAE4 25%, transparent 25%, transparent 75%, #48CAE4 75%, #48CAE4),
        linear-gradient(45deg, #48CAE4 25%, transparent 25%, transparent 75%, #48CAE4 75%, #48CAE4);
    background-position: 0 0, 10px 10px;
    background-size: 20px 20px;
    pointer-events: none;
    z-index: 1;
}
.cmd-btn.theme-zmove .cmd-label {
    z-index: 10;
    color: #ADE8F4;
    text-shadow: 0 0 5px rgba(72, 202, 228, 0.6);
    transform: scale(1);
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.cmd-btn.theme-zmove .cmd-sub {
    color: #48CAE4;
    z-index: 10;
    font-weight: 700;
}
.cmd-btn.theme-zmove svg.icon-bg {
    opacity: 0.25 !important;
    width: 200px !important;
    height: 200px !important;
    top: 70%;
    mix-blend-mode: screen;
    filter: drop-shadow(0 0 2px rgba(255,255,255,0.3));
    z-index: 0;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.cmd-btn.theme-zmove .z-shape-group {
    transform: rotate(-10deg);
    transition: transform 0.5s;
}
.cmd-btn.theme-zmove:hover {
    z-index: 100;
    transform: scale(1.05);
    background: radial-gradient(circle at 30% 70%, #FFB703 0%, #FB8500 50%, #FF006E 100%);
    box-shadow:
        inset 0 0 0 3px #FFFFFF,
        inset 0 0 30px rgba(255, 255, 255, 0.5),
        0 0 25px rgba(255, 183, 3, 0.8),
        0 0 60px rgba(251, 133, 0, 0.6);
}
.cmd-btn.theme-zmove:hover .cmd-label {
    color: #FFF !important;
    text-shadow: 2px 2px 0px #cf1557;
    transform: scale(1.2) skewX(-5deg);
}
.cmd-btn.theme-zmove:hover .cmd-sub {
    color: #FFE5B4 !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
.cmd-btn.theme-zmove:hover svg.icon-bg {
    opacity: 1 !important;
    mix-blend-mode: normal;
    top: 70%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1.2);
    filter: drop-shadow(0 0 15px rgba(255,255,255,0.8)) drop-shadow(0 0 30px #FF9F1C);
}
.cmd-btn.theme-zmove:hover .z-stroke {
    stroke: rgba(255, 255, 255, 0.9);
    stroke-width: 1px;
}
.cmd-btn.theme-zmove:hover::before {
    content: '';
    position: absolute;
    inset: -50px;
    background: radial-gradient(circle, rgba(255,255,255,0.8) 10%, transparent 10%);
    background-size: 20px 20px;
    opacity: 0.3;
    animation: z-sparkles 1s linear infinite;
    pointer-events: none;
    z-index: 5;
    mix-blend-mode: overlay;
}
@keyframes z-wiggle {
    0% { transform: scale(1) rotate(-10deg); }
    50% { transform: scale(1.1) rotate(10deg); }
    100% { transform: scale(1) rotate(-10deg); }
}
@keyframes z-sparkles {
    from { transform: translateY(0); }
    to { transform: translateY(-20px); }
}
/* ----------------DYNAMAX THEME---------------- */
.cmd-btn.theme-dyna {
    background: radial-gradient(circle at 60% 40%, #D4145A 0%, #880E4F 40%, #4a0429 100%);
    box-shadow:
        inset 0 0 30px #000000,
        inset 0 0 0 2px rgba(255, 30, 86, 0.9),
        inset 0 0 10px rgba(255, 64, 129, 0.6),
        inset 0 0 18px rgba(255, 150, 200, 0.4),
        0 0 10px rgba(233, 30, 99, 0.3);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.cmd-btn.theme-dyna::after {
    content: '';
    position: absolute;
    inset: 0px;
    border-radius: inherit;
    background-image:
        repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px),
        radial-gradient(circle at 0% 0%, rgba(255,255,255,0.1) 0%, transparent 40%);
    opacity: 0.4;
    z-index: 1;
    pointer-events: none;
}
.cmd-btn.theme-dyna .cmd-label {
    z-index: 10;
    color: #fff;
    font-size: 24px;
    text-shadow:
        2px 2px 0px #880E4F,
        4px 4px 0px #220211;
    transform: scale(1.05);
}
.cmd-btn.theme-dyna .cmd-sub {
    color: #FF80AB;
    z-index: 10;
    letter-spacing: 2px;
}
.cmd-btn.theme-dyna svg.icon-bg {
    opacity: 1 !important;
    width: 280px !important;
    height: 280px !important;
    top: 55%;
    left: 45%;
    mix-blend-mode: overlay;
    pointer-events: none;
    z-index: 0;
}
.cmd-btn.theme-dyna .dyna-cross-path {
    fill: #E91E63;
    opacity: 0.8;
}
.cmd-btn.theme-dyna .dyna-clouds {
    color: #560027;
    animation: dyna-orbit-spin 20s linear infinite;
}
.cmd-btn.theme-dyna .dyna-ring-1 {
    color: #F8BBD0;
    stroke-width: 1px;
}
.cmd-btn.theme-dyna:hover {
    transform: scale(1.05);
    z-index: 50;
    background: radial-gradient(circle at 50% 50%, #FF206E 0%, #AD1457 70%, #68052e 100%);
    box-shadow:
        inset 0 0 0 2px #fff,
        inset 0 0 20px #FF4081,
        0 0 40px rgba(233, 30, 99, 0.8),
        0 0 100px rgba(136, 14, 79, 1);
}
.cmd-btn.theme-dyna:hover .cmd-label {
    color: #FFD180;
    text-shadow: 0 0 15px #FF4081;
}
.cmd-btn.theme-dyna:hover svg.icon-bg {
    mix-blend-mode: normal;
    opacity: 0.8 !important;
    filter: drop-shadow(0 0 20px #D81B60);
    top: 50%;
    left: 50%;
}
.cmd-btn.theme-dyna:hover .dyna-cross-path {
    fill: #FFFFFF;
}
@keyframes dyna-orbit-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
@keyframes dyna-earthquake {
    0% { transform: scale(1.1) translate(0, 0); }
    25% { transform: scale(1.1) translate(1px, 1px); }
    50% { transform: scale(1.1) translate(-1px, 2px); }
    75% { transform: scale(1.1) translate(0px, -1px); }
    100% { transform: scale(1.1) translate(0, 0); }
}
/* ----------------HISUI STYLE THEME---------------- */
.cmd-btn.theme-style-entry .cmd-label {
    color: #000;
}
.cmd-btn.theme-style-entry .cmd-sub { color: #000; }
.cmd-btn.theme-style-entry svg.icon-bg { top: 50%; }
/* =========================================
   LEVEL 2 STYLE: ARCEUS CALLIGRAPHY (Fixed)
   ========================================= */
.cmd-btn.theme-style-pure-agile,
.cmd-btn.theme-style-pure-strong,
.cmd-btn.theme-style-pure-base,
.cmd-btn.theme-style-pure-focus,
.cmd-btn.theme-style-pure-back {
    background: #ffffff;
    background-image: radial-gradient(#aaa 0.5px, transparent 0.5px);
    background-size: 20px 20px;
    box-shadow: inset 0 0 0 1px #e5e5e5;
    border: none;
    transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.cmd-btn[class*="theme-style-pure-"] .cmd-content {
    display: block;
    position: relative;
    width: 100%;
    height: 100%;
}
.cmd-btn[class*="theme-style-pure-"] .cmd-label {
    font-family: 'Zhi Mang Xing', cursive !important;
    position: absolute;
    inset: 40px;
    color: #1a1a1d;
    display: flex;
    justify-content: center;
    align-items: center;
    font-style: normal;
}
.cmd-btn[class*="theme-style-pure-"] .cmd-label span {
    position: absolute;
    font-size: 4.5rem;
    line-height: 1;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), color 0.2s, text-shadow 0.2s;
}
.cmd-btn[class*="theme-style-pure-"] .cmd-sub { display: none; }
/* =========================================
/* =========================================
   ä¿®æ­£ç‰ˆå¸ƒå±€ - æ”¶æ•›é˜²æº¢å‡º
   Design Note: å°†æ–‡å­—å‘è±¡é™çš„å‡ ä½•ä¸­å¿ƒï¼ˆæœ€å®½é˜”å¤„ï¼‰é æ‹¢
   ========================================= */
/* --- é¡¶éƒ¨ï¼šè¿…ç–¾ --- 
   ä¿®æ­£ï¼šYè½´å¤§å¹…ä¸‹æ‹‰ï¼ŒXè½´å¾®ç¼©
*/
.theme-style-pure-agile .c1 { 
    /* è¿…ï¼šå¾€å›æ‹‰ï¼Œä¸è¦ç¢°åˆ°å·¦ä¸Šé¡¶è§’ */
    transform: translate(-45%, -15%) rotate(-8deg); 
}
.theme-style-pure-agile .c2 { 
    /* ç–¾ï¼šå¾€å·¦ç§»ï¼Œç¨å¾®å¾€ä¸‹æ”¾ä¸€ç‚¹ï¼Œåˆ©ç”¨å³ä¸‹è§’çš„ç©ºé—´ */
    transform: translate(40%, 15%) rotate(-2deg); 
}
/* Hoverï¼šç¨å¾®å¾€å¤–åŠ¨ä¸€ç‚¹ç‚¹å³å¯ */
.theme-style-pure-agile:hover .c1 { transform: translate(-50%, -15%) rotate(-10deg) scale(1.05); color: #008fa3; }
.theme-style-pure-agile:hover .c2 { transform: translate(40%, 15%) rotate(0deg) scale(1.05); color: #008fa3; }
/* --- åº•éƒ¨ï¼šåˆšçŒ› --- 
   ä¿®æ­£ï¼šYè½´å¤§å¹…ä¸Šæ‹‰
*/
.theme-style-pure-strong .c1 { 
    /* åˆšï¼šæ”¾ä½å§¿æ€ï¼Œå¾€é‡Œæ”¶ */
    transform: translate(-47%, -15%); 
}
.theme-style-pure-strong .c2 { 
    transform: translate(42%, 15%); 
}
/* Hover */
.theme-style-pure-strong:hover .c1 { transform: translate(-52%, -15%) scale(1.05); color: #c92a2a; }
.theme-style-pure-strong:hover .c2 { transform: translate(47%, 15%) scale(1.05); color: #c92a2a; }
.theme-style-pure-base .c1,
.theme-style-pure-focus .c1 { 
    /* å¹³ï¼šå¾€å³å›æ”¶åˆ° -55%ï¼Œè¶³å¤Ÿé å·¦ä½†ä¸å‡ºç•Œ */
    transform: translate(-45%, -15%) rotate(-5deg); 
}
.theme-style-pure-base .c2,
.theme-style-pure-focus .c2 { 
    /* è¡¡ï¼šå› ä¸ºâ€œè¡¡â€å­—ç»“æ„æ¯”è¾ƒå¯†ï¼Œç¦»åœ†å¿ƒè¿œä¸€ç‚¹ç‚¹ */
    transform: translate(45%, 20%); 
}
/* Hover */
.theme-style-pure-base:hover .c1,
.theme-style-pure-focus:hover .c1 { transform: translate(-52%, -15%) scale(1.05); }
.theme-style-pure-base:hover .c2,
.theme-style-pure-focus:hover .c2 { transform: translate(47%, 15%) scale(1.05); }
/* --- å³ä¾§ï¼šè¿”å› --- 
   ä¿®æ­£ï¼šå³è¾¹çš„å­—ä» 115% æ‹‰å›åœ°çƒè¡¨é¢
   ç‰¹åˆ«è§£é‡Šï¼šå­—ä½“å¾ˆå¤§(4.8rem)ï¼Œå¦‚æœæ”¾å¤ªå¤–å±‚ç»å¯¹ä¼šåˆ‡è§’
*/
.theme-style-pure-back .c1 { 
    font-size: 4.8rem; 
    transform: translate(-45%, -15%) rotate(-5deg); /* å‘å·¦æŒªåŠ¨è‡³åœ†å¿ƒå·¦ä¾§ä¸€ç‚¹ç‚¹ */ 
    color: #1a1a1d; 
}
.theme-style-pure-back .c2 { 
    font-size: 4.8rem; 
    /* å›ï¼šåŸæ¥æ˜¯115%ï¼Œç›´æ¥ç åŠæ‹‰å› */
    transform: translate(42%, 25%); 
    color: #1a1a1d; 
} 
/* Hover */
.theme-style-pure-back:hover .c1 { transform: translate(-52%, -15%) rotate(-8deg) scale(1.05); }
.theme-style-pure-back:hover .c2 { transform: translate(40%, 25%) scale(1.05); }
/* Hover backgrounds */
.cmd-btn.theme-style-pure-agile:hover { 
    background: #09636e; 
    box-shadow: 0 0 0 1px #0e8491, 0 0 12px rgba(9, 99, 110, 0.6);
}
.cmd-btn.theme-style-pure-agile:hover .cmd-label,
.cmd-btn.theme-style-pure-agile:hover .cmd-label span {
    color: #e0f2fe;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}
.cmd-btn.theme-style-pure-strong:hover { 
    background: #8a1c1c; 
    box-shadow: 0 0 0 1px #c92a2a, 0 0 12px rgba(138, 28, 28, 0.6);
}
.cmd-btn.theme-style-pure-strong:hover .cmd-label,
.cmd-btn.theme-style-pure-strong:hover .cmd-label span {
    color: #ffe3e3;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}
.cmd-btn.theme-style-pure-base:hover { 
    background: #111111; 
    box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 4px 12px rgba(0,0,0,0.8);
}
.cmd-btn.theme-style-pure-base:hover .cmd-label,
.cmd-btn.theme-style-pure-base:hover .cmd-label span {
    color: #dedede;
    text-shadow: none;
}
.cmd-btn.theme-style-pure-back:hover { 
    background: #111111; 
    box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 4px 12px rgba(0,0,0,0.8);
}
.cmd-btn.theme-style-pure-back:hover .cmd-label,
.cmd-btn.theme-style-pure-back:hover .cmd-label span {
    color: #dedede;
    text-shadow: none;
}
.cmd-btn.theme-style-pure-focus:hover { 
    background: #195e2d; 
    box-shadow: 0 0 0 1px #2f9e44, 0 0 12px rgba(25, 94, 45, 0.6);
}
.cmd-btn.theme-style-pure-focus:hover .cmd-label,
.cmd-btn.theme-style-pure-focus:hover .cmd-label span {
    color: #e6fcf5;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}
/* Hover backgrounds */
.cmd-btn.theme-style-pure-agile:hover { background: #09636e; }
.cmd-btn.theme-style-pure-strong:hover { background: #8a1c1c; }
.cmd-btn.theme-style-pure-back:hover { background: #111111; }
.cmd-btn.theme-style-pure-base:hover { background: #111111; }
.cmd-btn.theme-style-pure-focus:hover { background: #195e2d; }
/* =========================================
   LEVEL 1 SLOT: STYLE (The Ancient Scroll)
   ä¸€çº§å…¥å£ï¼šæ°´å¢¨å¤é£æµ
   ========================================= */
.cmd-btn.theme-style-entry {
    background-color: #f7f5f0;
    background-image: 
        radial-gradient(#dcdcdc 0.5px, transparent 0.5px),
        radial-gradient(#e6e6e6 0.5px, transparent 0.5px);
    background-size: 20px 20px;
    background-position: 0 0, 10px 10px;
    box-shadow: 
        inset 0 0 0 3px #2d3436,
        inset 0 0 8px 1px rgba(0,0,0,0.4),
        0 0 10px rgba(0,0,0,0.1);
    filter: sepia(0.2) contrast(0.95);
    border: none;
    overflow: hidden;
    transition: all 0.35s cubic-bezier(0.25, 1, 0.5, 1);
}
.cmd-btn.theme-style-entry::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 100% 100%, transparent 40%, rgba(139, 137, 137, 0.15) 100%);
    pointer-events: none;
    z-index: 2;
    mix-blend-mode: multiply;
}
.cmd-btn.theme-style-entry .cmd-label {
    font-family: 'Exo 2', 'Rubik', sans-serif;
    color: #1a1a1a;
    font-weight: 800;
    letter-spacing: 2px;
    z-index: 10;
    text-shadow: 0 0 0.5px rgba(0,0,0,0.6);
}
.cmd-btn.theme-style-entry .cmd-sub {
    font-family: 'Exo 2', 'Rubik', sans-serif;
    color: #596275;
    font-weight: 600;
    z-index: 10;
}
.cmd-btn.theme-style-entry svg.icon-bg {
    width: 220px !important;
    height: 220px !important;
    opacity: 0.1 !important;
    color: #000;
    top: 60%; left: 60%;
    mix-blend-mode: multiply;
    transition: all 0.5s ease-out;
}
.cmd-btn.theme-style-entry:hover {
    z-index: 50;
    transform: scale(1.02);
    background-color: #1e272e;
    box-shadow: 
        inset 0 0 0 3px #d2dae2,
        inset 0 0 15px rgba(255,255,255,0.1),
        0 4px 20px rgba(0,0,0,0.4);
    filter: sepia(0) contrast(1.1);
}
.cmd-btn.theme-style-entry:hover .cmd-label {
    color: #fff;
    text-shadow: 0 0 10px rgba(255,255,255,0.6);
    transform: scale(1.05);
}
.cmd-btn.theme-style-entry:hover .cmd-sub {
    color: #d2dae2;
}
.cmd-btn.theme-style-entry:hover svg.icon-bg {
    opacity: 0.2 !important;
    color: #fff;
    mix-blend-mode: normal;
    transform: translate(-50%, -50%) rotate(180deg) scale(0.9);
    top: 50%; left: 50%;
    filter: blur(2px) drop-shadow(0 0 10px rgba(255,255,255,0.5));
}
.cmd-btn.theme-style-entry:hover::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle, transparent 30%, rgba(200, 200, 200, 0.05) 50%, transparent 70%);
    animation: ripple-spread 3s linear infinite;
    pointer-events: none;
    z-index: 1;
}
@keyframes ripple-spread {
    from { transform: scale(0.8); opacity: 1; }
    to { transform: scale(1.2); opacity: 0; }
}
/* =========================================
   LEVEL 2 TACTICS THEMES (Architected Border)
   ========================================= */
.cmd-btn.theme-insight,
.cmd-btn.theme-passion,
.cmd-btn.theme-devotion,
.cmd-btn.theme-trust {
    background: #000000 !important;
    border: none;
    box-shadow: none;
    text-shadow: none;
    overflow: hidden;
    --base-opacity: 0.1;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
/* 2. å®šä¹‰å››ä¸ªè±¡é™çš„ä¸»é¢˜è‰²å˜é‡ (CSS Variables Scope) */
.cmd-btn.theme-insight  { --btn-color: #00efd1; } /* é’è‰²/Dodge */
.cmd-btn.theme-passion  { --btn-color: #ff3f3f; } /* çº¢è‰²/Crit */
.cmd-btn.theme-devotion { --btn-color: #a55eea; } /* ç´«è‰²/Endure */
.cmd-btn.theme-trust    { --btn-color: #ff9800; } /* æ©™è‰²/Listen */
.theme-insight::after,
.theme-passion::after,
.theme-devotion::after,
.theme-trust::after {
    content: '';
    position: absolute;
    inset: 0;
    border: 3px solid var(--btn-color);
    border-radius: inherit;
    z-index: 100;
    pointer-events: none;
    opacity: 0.6;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
    transition: all 0.3s ease;
}
.theme-insight svg.icon-bg,
.theme-passion svg.icon-bg,
.theme-devotion svg.icon-bg,
.theme-trust svg.icon-bg {
    width: 200px !important;
    height: 200px !important;
    top: 50%;
    left: 50%;
    opacity: var(--base-opacity) !important;
    fill: var(--btn-color) !important;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                opacity 0.4s ease;
    z-index: 1;
    pointer-events: none;
    transform: translate(-50%, -50%) scale(0.8) rotate(0deg);
}
.theme-insight .cmd-content,
.theme-passion .cmd-content,
.theme-devotion .cmd-content,
.theme-trust .cmd-content {
    position: relative;
    z-index: 50;
}
.theme-insight .cmd-sub,
.theme-passion .cmd-sub,
.theme-devotion .cmd-sub,
.theme-trust .cmd-sub {
    font-family: 'M PLUS Rounded 1c', 'Exo 2', sans-serif;
    color: var(--btn-color);
    opacity: 0.7;
    transition: color 0.2s ease;
}
.theme-insight .cmd-label,
.theme-passion .cmd-label,
.theme-devotion .cmd-label,
.theme-trust .cmd-label {
    font-family: 'Exo 2', sans-serif !important;
    font-weight: 800;
    font-style: italic;
    font-size: 1.6rem;
    color: var(--btn-color);
    opacity: 0.8;
    transition: all 0.2s ease;
}
.cmd-btn.theme-insight:hover::after,
.cmd-btn.theme-passion:hover::after,
.cmd-btn.theme-devotion:hover::after,
.cmd-btn.theme-trust:hover::after {
    opacity: 1;
    box-shadow:
        0 0 15px var(--btn-color),
        inset 0 0 10px var(--btn-color);
    border-color: #fff;
}
.cmd-btn.theme-insight:hover .cmd-label,
.cmd-btn.theme-passion:hover .cmd-label,
.cmd-btn.theme-devotion:hover .cmd-label,
.cmd-btn.theme-trust:hover .cmd-label {
    opacity: 1;
    color: #fff;
    text-shadow:
        0 0 5px #fff,
        0 0 10px var(--btn-color),
        2px 2px 0px rgba(0,0,0,0.5);
    transform: scale(1.1) skewX(-5deg);
}
.cmd-btn.theme-insight:hover,
.cmd-btn.theme-passion:hover,
.cmd-btn.theme-devotion:hover,
.cmd-btn.theme-trust:hover {
    background: #080808 !important;
}
.theme-insight:hover svg.icon-bg,
.theme-passion:hover svg.icon-bg,
.theme-devotion:hover svg.icon-bg,
.theme-trust:hover svg.icon-bg {
    opacity: 0.35 !important;
    transform: translate(-50%, -50%) scale(1.2) rotate(-8deg);
    filter: drop-shadow(0 0 8px var(--btn-color));
}
.theme-insight:hover .cmd-sub,
.theme-passion:hover .cmd-sub,
.theme-devotion:hover .cmd-sub,
.theme-trust:hover .cmd-sub {
    color: #fff;
    opacity: 1;
}
/* =========================================
   EVO THEME A: BIO EVOLUTION (Genetics)
   ç”Ÿå‘½/åŸºå› è¿›åŒ–: ç»¿è‰²ç”ŸåŒ–é£
   ========================================= */
.cmd-btn.theme-evo-bio {
    background: radial-gradient(circle at 50% 120%, #054f28 0%, #002b15 80%);
    box-shadow: 
        inset 0 0 10px rgba(46, 204, 113, 0.3),
        0 0 0 2px rgba(46, 204, 113, 0.5);
    overflow: hidden;
}
.cmd-btn.theme-evo-bio::after {
    content: '';
    position: absolute;
    inset: 0;
    background-image: radial-gradient(rgba(46, 204, 113, 0.15) 20%, transparent 20%);
    background-size: 8px 8px;
    opacity: 0.5;
    pointer-events: none;
}
.cmd-btn.theme-evo-bio .cmd-label {
    color: #a3ffc3;
    text-shadow: 0 0 5px rgba(46, 204, 113, 0.8);
    z-index: 10;
}
.cmd-btn.theme-evo-bio .cmd-sub {
    color: #2ecc71;
    font-weight: 700;
    z-index: 10;
}
.cmd-btn.theme-evo-bio svg.icon-bg {
    color: #1a7442;
    opacity: 0.25 !important;
    width: 250px !important; 
    height: 250px !important;
    top: 60%;
    left: 40%;
    transform: translate(-50%, -50%) rotate(15deg);
}
.cmd-btn.theme-evo-bio .bio-bubble {
    opacity: 0;
    transition: opacity 0.5s;
}
.cmd-btn.theme-evo-bio:hover {
    background: radial-gradient(circle at 50% 100%, #1a9e55 0%, #075f32 100%);
    box-shadow: 
        inset 0 0 20px #2ecc71,
        0 0 25px rgba(46, 204, 113, 0.7);
    z-index: 50;
    transform: scale(1.05);
}
.cmd-btn.theme-evo-bio:hover svg.icon-bg {
    opacity: 0.6 !important;
    color: #5af59d;
    filter: drop-shadow(0 0 8px #2ecc71);
    top: 55%; 
}
.cmd-btn.theme-evo-bio:hover .bio-bubble {
    animation: bio-float 3s infinite linear;
    opacity: 0.6;
    fill: #dafce7;
}
.cmd-btn.theme-evo-bio:hover .b1 { animation-duration: 2s; animation-delay: 0s; }
.cmd-btn.theme-evo-bio:hover .b2 { animation-duration: 3.5s; animation-delay: 0.5s; }
.cmd-btn.theme-evo-bio:hover .b3 { animation-duration: 2.5s; animation-delay: 1s; }
@keyframes bio-float {
    0% { transform: translateY(0) scale(1); opacity: 0; }
    20% { opacity: 0.8; }
    80% { opacity: 0.8; }
    100% { transform: translateY(-50px) scale(0.5); opacity: 0; }
}
/* =========================================
   EVO THEME B: BOND EVOLUTION (Love/Link)
   ç¾ç»Šè¿›åŒ–: ç²‰è‰²/çŠç‘šé‡‘ æ¸©æš–é£
   ========================================= */
.cmd-btn.theme-evo-bond {
    background: linear-gradient(-45deg, #FF9A9E 0%, #FECFEF 100%);
    box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.5);
    border: none;
}
.cmd-btn.theme-evo-bond::before {
    content: 'â™¥';
    position: absolute;
    top: -20px; left: -20px;
    font-size: 80px;
    color: #fff;
    opacity: 0.1;
    transform: rotate(-15deg);
}
.cmd-btn.theme-evo-bond .cmd-label {
    color: #fff;
    text-shadow: 0 2px 2px rgba(235, 77, 75, 0.4);
    z-index: 10;
}
.cmd-btn.theme-evo-bond .cmd-sub {
    color: #d6336c;
    z-index: 10;
    font-weight: 700;
}
.cmd-btn.theme-evo-bond svg.icon-bg {
    color: #fff;
    opacity: 0.5 !important;
    mix-blend-mode: overlay;
    width: 220px !important;
    height: 220px !important;
    top: 55%; left: 50%;
    transform: translate(-50%, -50%);
}
.bond-pulse-line, .bond-mini-heart { opacity: 0; }
.cmd-btn.theme-evo-bond:hover {
    z-index: 80;
    transform: scale(1.05);
    background: radial-gradient(circle at center, #ff80ab 0%, #c92a2a 120%);
    box-shadow: 0 0 30px #ff4081;
}
.cmd-btn.theme-evo-bond:hover svg.icon-bg {
    opacity: 1 !important;
    mix-blend-mode: normal;
    animation: bond-heartbeat 0.8s infinite ease-in-out;
    filter: drop-shadow(0 0 10px rgba(255,255,255,0.6));
    top: 50%;
}
.cmd-btn.theme-evo-bond:hover .bond-heart-core {
    fill: #f06595;
}
.cmd-btn.theme-evo-bond:hover .bond-pulse-line {
    opacity: 1;
    stroke-dasharray: 200;
    animation: bond-pulse-draw 1.5s linear infinite;
}
.cmd-btn.theme-evo-bond:hover .bond-mini-heart {
    animation: bond-fly 1.5s infinite ease-in;
    fill: #fff;
}
.cmd-btn.theme-evo-bond:hover .h1 { animation-delay: 0.2s; }
.cmd-btn.theme-evo-bond:hover .h2 { animation-delay: 0.7s; }
@keyframes bond-heartbeat {
    0% { transform: translate(-50%, -50%) scale(1); }
    15% { transform: translate(-50%, -50%) scale(1.15); }
    30% { transform: translate(-50%, -50%) scale(1); }
    45% { transform: translate(-50%, -50%) scale(1.15); }
    60% { transform: translate(-50%, -50%) scale(1); }
    100% { transform: translate(-50%, -50%) scale(1); }
}
@keyframes bond-pulse-draw {
    0% { stroke-dashoffset: 200; opacity: 1; }
    50% { stroke-dashoffset: 0; opacity: 1; }
    80% { stroke-dashoffset: -200; opacity: 0; }
    100% { stroke-dashoffset: -200; opacity: 0; }
}
@keyframes bond-fly {
    0% { transform: translateY(0) scale(0.5); opacity: 0; }
    20% { opacity: 1; }
    100% { transform: translateY(-40px) scale(0); opacity: 0; }
}
/* ----------------TERASTAL THEME---------------- */
.cmd-btn.theme-tera {
    background: linear-gradient(160deg, #0d3b4a 0%, #175464 60%, #0e7490 100%);
    box-shadow:
        inset 0 0 0 1px rgba(103, 232, 249, 0.4),
        inset 0 0 30px rgba(8, 145, 178, 0.6),
        0 4px 6px rgba(0,0,0,0.3);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
}
.cmd-btn.theme-tera::before {
    content: '';
    position: absolute;
    inset: -10px;
    background-image: radial-gradient(rgba(255,255,255,0.2) 2px, transparent 2px);
    background-size: 20px 20px;
    background-position: 0 0;
    opacity: 0.2;
    transform: rotate(30deg);
    z-index: 1;
    transition: all 0.5s;
}
.cmd-btn.theme-tera::after {
    content: '';
    position: absolute;
    top: 0; left: -150%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transform: skewX(-20deg);
    pointer-events: none;
    z-index: 2;
}
.cmd-btn.theme-tera .cmd-label {
    z-index: 10;
    font-family: 'Exo 2', sans-serif;
    color: #CFFAFE;
    text-shadow:
        0 0 10px rgba(6, 182, 212, 0.6),
        0 2px 0 rgba(21, 94, 117, 1);
    letter-spacing: 2px;
}
.cmd-btn.theme-tera .cmd-sub {
    color: #67E8F9;
    z-index: 10;
    font-weight: 600;
}
.cmd-btn.theme-tera svg.icon-bg {
    color: #22d3ee;
    width: 220px !important;
    height: 220px !important;
    top: 55%;
    opacity: 0.3 !important;
    filter: drop-shadow(0 0 2px rgba(34, 211, 238, 0.5));
    transition: all 0.5s ease-out;
    mix-blend-mode: plus-lighter;
}
.cmd-btn.theme-tera:hover {
    z-index: 60;
    transform: scale(1.03);
    background: linear-gradient(135deg, #155e75 0%, #0891b2 40%, #cffafe 100%);
    box-shadow:
        inset 0 0 0 2px rgba(255,255,255,0.9),
        0 0 20px rgba(34,211,238, 0.6),
        0 0 50px rgba(103,232,249, 0.4);
}
.cmd-btn.theme-tera:hover::before {
    opacity: 0.3;
    background-size: 24px 24px;
}
.cmd-btn.theme-tera:hover::after {
    animation: tera-sheen 1.5s cubic-bezier(0.19, 1, 0.22, 1) infinite;
}
.cmd-btn.theme-tera:hover svg.icon-bg {
    opacity: 0.9 !important;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) rotate(-5deg);
    color: #fff;
    filter:
        drop-shadow(0 0 5px rgba(255,255,255,0.8))
        drop-shadow(0 0 15px rgba(6, 182, 212, 1));
}
.cmd-btn.theme-tera:hover .tera-bg-ring {
    animation: tera-slow-spin 10s linear infinite;
    stroke: #ECFEFF;
}
.cmd-btn.theme-tera:hover .tera-core-pulse {
    animation: tera-pulse 2s infinite;
}
.cmd-btn.theme-tera:hover .cmd-label {
    text-shadow:
        0 0 15px #FFFFFF,
        0 0 30px #22D3EE;
    color: white;
}
@keyframes tera-sheen {
    0% { left: -150%; opacity: 0; }
    50% { left: 150%; opacity: 0.8; }
    100% { left: 150%; opacity: 0; }
}
@keyframes tera-slow-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
@keyframes tera-pulse {
    0%, 100% { opacity: 0.6; transform: scale(0.9); transform-origin: center; }
    50% { opacity: 1; transform: scale(1.1); transform-origin: center; fill: #E0F2FE; }
}
@keyframes tera-twinkle {
    from { opacity: 0.3; transform: scale(0.5); transform-origin: center; }
    to { opacity: 1; transform: scale(1.2); transform-origin: center; }
}
]]></file>
    </directory>
    <directory name="data">
        <directory name="svg"/>
        <file name="mapdata.json"><![CDATA[{
    "__header__": {
        "fileType": "LDtk Project JSON",
        "app": "LDtk",
        "doc": "https://ldtk.io/json",
        "schema": "https://ldtk.io/files/JSON_SCHEMA.json",
        "appAuthor": "Sebastien 'deepnight' Benard",
        "appVersion": "1.5.3",
        "url": "https://ldtk.io"
    },
    "iid": "df3c0520-d380-11f0-8216-2fe3f79e70f9",
    "jsonVersion": "1.5.3",
    "appBuildId": 473703,
    "nextUid": 83,
    "identifierStyle": "Capitalize",
    "toc": [],
    "worldLayout": "Free",
    "worldGridWidth": 256,
    "worldGridHeight": 256,
    "defaultLevelWidth": 256,
    "defaultLevelHeight": 256,
    "defaultPivotX": 0,
    "defaultPivotY": 0,
    "defaultGridSize": 16,
    "defaultEntityWidth": 16,
    "defaultEntityHeight": 16,
    "bgColor": "#40465B",
    "defaultLevelBgColor": "#696A79",
    "minifyJson": true,
    "externalLevels": false,
    "exportTiled": false,
    "simplifiedExport": false,
    "imageExportMode": "None",
    "exportLevelBg": true,
    "pngFilePattern": null,
    "backupOnSave": false,
    "backupLimit": 10,
    "backupRelPath": null,
    "levelNamePattern": "Level_%idx",
    "tutorialDesc": null,
    "customCommands": [],
    "flags": [],
    "defs": {
        "layers": [{
            "__type": "Entities",
            "identifier": "Place_Anchor",
            "type": "Entities",
            "uid": 79,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 1,
            "inactiveOpacity": 0.6,
            "hideInList": false,
            "hideFieldsWhenInactive": true,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "Entities",
            "identifier": "NPC_Actor",
            "type": "Entities",
            "uid": 75,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 1,
            "inactiveOpacity": 0.6,
            "hideInList": false,
            "hideFieldsWhenInactive": true,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "Entities",
            "identifier": "Service",
            "type": "Entities",
            "uid": 59,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 1,
            "inactiveOpacity": 0.6,
            "hideInList": false,
            "hideFieldsWhenInactive": true,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "Entities",
            "identifier": "Biome_Zone",
            "type": "Entities",
            "uid": 52,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 1,
            "inactiveOpacity": 0.6,
            "hideInList": false,
            "hideFieldsWhenInactive": true,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "Entities",
            "identifier": "Region_Zone",
            "type": "Entities",
            "uid": 35,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 1,
            "inactiveOpacity": 0.6,
            "hideInList": false,
            "hideFieldsWhenInactive": true,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "Entities",
            "identifier": "Core_Logic",
            "type": "Entities",
            "uid": 12,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 1,
            "inactiveOpacity": 0.6,
            "hideInList": false,
            "hideFieldsWhenInactive": true,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "IntGrid",
            "identifier": "Infrastructure",
            "type": "IntGrid",
            "uid": 17,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 1,
            "inactiveOpacity": 1,
            "hideInList": false,
            "hideFieldsWhenInactive": false,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [{
                "value": 2,
                "identifier": "The_Hyper_Loop",
                "color": "#EB4D4B",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 4,
                "identifier": "Bridge",
                "color": "#E67E22",
                "tile": null,
                "groupUid": 0
            }],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "IntGrid",
            "identifier": "Underground_Access",
            "type": "IntGrid",
            "uid": 7,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 1,
            "inactiveOpacity": 1,
            "hideInList": false,
            "hideFieldsWhenInactive": false,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [{
                "value": 4,
                "identifier": "Sludge_Channel",
                "color": "#A29BFE",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 5,
                "identifier": "Deep_Tunnel",
                "color": "#636E72",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 6,
                "identifier": "Rusted_Tracks",
                "color": "#C0392B",
                "tile": null,
                "groupUid": 0
            }],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "IntGrid",
            "identifier": "Obstacles",
            "type": "IntGrid",
            "uid": 3,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 0.2,
            "inactiveOpacity": 1,
            "hideInList": false,
            "hideFieldsWhenInactive": false,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [{
                "value": 1,
                "identifier": "BLOCK",
                "color": "#000000",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 2,
                "identifier": "PASSABLE",
                "color": "#FFFFFF",
                "tile": null,
                "groupUid": 0
            }],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "IntGrid",
            "identifier": "Traversability",
            "type": "IntGrid",
            "uid": 5,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 0.8,
            "inactiveOpacity": 1,
            "hideInList": false,
            "hideFieldsWhenInactive": false,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [{
                "value": 3,
                "identifier": "Simple_Path",
                "color": "#DFE6E9",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 5,
                "identifier": "Shortcut",
                "color": "#D35400",
                "tile": null,
                "groupUid": 0
            }],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "IntGrid",
            "identifier": "Threat",
            "type": "IntGrid",
            "uid": 4,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 0.8,
            "inactiveOpacity": 1,
            "hideInList": false,
            "hideFieldsWhenInactive": false,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [{
                "value": 6,
                "identifier": "Peace",
                "color": "#FFFFFF",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 1,
                "identifier": "Safe",
                "color": "#2ECC71",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 2,
                "identifier": "Low_Threat",
                "color": "#F1C40F",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 3,
                "identifier": "Mid_Threat",
                "color": "#E67E22",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 4,
                "identifier": "High_Threat",
                "color": "#E74C3C",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 5,
                "identifier": "Apex",
                "color": "#8E44AD",
                "tile": null,
                "groupUid": 0
            }],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "IntGrid",
            "identifier": "Regions",
            "type": "IntGrid",
            "uid": 1,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 0.3,
            "inactiveOpacity": 1,
            "hideInList": false,
            "hideFieldsWhenInactive": false,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [{
                "value": 1,
                "identifier": "The_Void",
                "color": "#0F1E3D",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 2,
                "identifier": "Zenith",
                "color": "#FDCB6E",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 3,
                "identifier": "Neon",
                "color": "#00CEC9",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 4,
                "identifier": "Bloom",
                "color": "#55EFC4",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 5,
                "identifier": "Shadow",
                "color": "#6C5CE7",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 6,
                "identifier": "Apex",
                "color": "#FF7675",
                "tile": null,
                "groupUid": 0
            }],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }, {
            "__type": "IntGrid",
            "identifier": "Surface",
            "type": "IntGrid",
            "uid": 2,
            "doc": null,
            "uiColor": null,
            "gridSize": 16,
            "guideGridWid": 0,
            "guideGridHei": 0,
            "displayOpacity": 1,
            "inactiveOpacity": 1,
            "hideInList": false,
            "hideFieldsWhenInactive": false,
            "canSelectWhenInactive": true,
            "renderInWorldView": true,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "parallaxFactorX": 0,
            "parallaxFactorY": 0,
            "parallaxScaling": true,
            "requiredTags": [],
            "excludedTags": [],
            "autoTilesKilledByOtherLayerUid": null,
            "uiFilterTags": [],
            "useAsyncRender": false,
            "intGridValues": [{
                "value": 1,
                "identifier": "Deep_Sea",
                "color": "#0C2461",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 6,
                "identifier": "Shallow_Sea",
                "color": "#4BCFFA",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 7,
                "identifier": "Fresh_Water",
                "color": "#3498DB",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 9,
                "identifier": "Sewage",
                "color": "#8854D0",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 2,
                "identifier": "High_Grass",
                "color": "#2ECC71",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 3,
                "identifier": "Waste",
                "color": "#E67E22",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 4,
                "identifier": "Pavement",
                "color": "#ECF0F1",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 10,
                "identifier": "Standard_Grass",
                "color": "#BADB57",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 11,
                "identifier": "High_Grass",
                "color": "#2ECC71",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 12,
                "identifier": "Flower_Field",
                "color": "#F6757A",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 13,
                "identifier": "Deep_Jungle",
                "color": "#05582C",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 14,
                "identifier": "Wet_Soil",
                "color": "#8D6E63",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 15,
                "identifier": "Coastal_Sand",
                "color": "#FFEAA7",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 16,
                "identifier": "Light_Forest",
                "color": "#009432",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 17,
                "identifier": "Industrial",
                "color": "#41474F",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 18,
                "identifier": "High_Voltage",
                "color": "#F0932B",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 19,
                "identifier": "Synthetic_Turf",
                "color": "#ACD732",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 20,
                "identifier": "Swamp",
                "color": "#218C74",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 21,
                "identifier": "Slum_Pavement",
                "color": "#57606F",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 22,
                "identifier": "Withered_Grass",
                "color": "#A4B0BE",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 23,
                "identifier": "Snowfield",
                "color": "#C7ECEE",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 24,
                "identifier": "Glacial_Water",
                "color": "#22A6B3",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 25,
                "identifier": "Desert_Sand",
                "color": "#F2CA7E",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 26,
                "identifier": "Rocky_Mountain",
                "color": "#95A5A6",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 27,
                "identifier": "Scorched_Earth",
                "color": "#2C3E50",
                "tile": null,
                "groupUid": 0
            }, {
                "value": 28,
                "identifier": "Magma",
                "color": "#E74C3C",
                "tile": null,
                "groupUid": 0
            }],
            "intGridValuesGroups": [],
            "autoRuleGroups": [],
            "autoSourceLayerDefUid": null,
            "tilesetDefUid": null,
            "tilePivotX": 0,
            "tilePivotY": 0,
            "biomeFieldUid": null
        }],
        "entities": [{
            "identifier": "PlayerStart",
            "uid": 8,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#0000FF",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": {
                "tilesetUid": 10,
                "x": 0,
                "y": 0,
                "w": 0,
                "h": 0
            },
            "nineSliceBorders": [],
            "maxCount": 1,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0.5,
            "pivotY": 0.5,
            "fieldDefs": []
        }, {
            "identifier": "Warp",
            "uid": 13,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#FF9F43",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Enum",
                "doc": null,
                "__type": "LocalEnum.DestType",
                "uid": 20,
                "type": "F_Enum(18)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "Hidden",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": false,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Transit_Station",
            "uid": 21,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#0ABDE3",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Transit_Station",
                "doc": null,
                "__type": "LocalEnum.Transit_Station",
                "uid": 34,
                "type": "F_Enum(22)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "Hidden",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": false,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Sea_Route",
            "uid": 26,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#0099DB",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Sea_Route",
                "doc": null,
                "__type": "LocalEnum.Sea_Route",
                "uid": 27,
                "type": "F_Enum(24)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "Hidden",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": false,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Sky_Net",
            "uid": 29,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#2FBEA2",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Sky_Net",
                "doc": null,
                "__type": "LocalEnum.Sky_Net",
                "uid": 30,
                "type": "F_Enum(28)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "Hidden",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": false,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Lava_Line",
            "uid": 31,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#BE4A2F",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Lava_Line",
                "doc": null,
                "__type": "LocalEnum.Lava_Line",
                "uid": 33,
                "type": "F_Enum(32)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "Hidden",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": false,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Biome",
            "uid": 49,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": true,
            "resizableY": true,
            "minWidth": 16,
            "maxWidth": null,
            "minHeight": 16,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#265C42",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Sapphire_Strand",
                "doc": null,
                "__type": "LocalEnum.Biome",
                "uid": 51,
                "type": "F_Enum(50)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "ValueOnly",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Region_Zenith",
            "uid": 36,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": true,
            "resizableY": true,
            "minWidth": 16,
            "maxWidth": null,
            "minHeight": 16,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#FEE761",
            "renderMode": "Cross",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Locs_Zenith",
                "doc": null,
                "__type": "LocalEnum.Locs_Zenith",
                "uid": 42,
                "type": "F_Enum(41)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "ValueOnly",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Region_Neon",
            "uid": 43,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": true,
            "resizableY": true,
            "minWidth": 16,
            "maxWidth": null,
            "minHeight": 16,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#2CE8F5",
            "renderMode": "Cross",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Locs_Neon",
                "doc": null,
                "__type": "LocalEnum.Locs_Neon",
                "uid": 45,
                "type": "F_Enum(44)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "ValueOnly",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Region_Bloom",
            "uid": 46,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": true,
            "resizableY": true,
            "minWidth": 16,
            "maxWidth": null,
            "minHeight": 16,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#3E8948",
            "renderMode": "Cross",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Locs_Bloom",
                "doc": null,
                "__type": "LocalEnum.Locs_Bloom",
                "uid": 48,
                "type": "F_Enum(47)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "ValueOnly",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Region_Shadow",
            "uid": 53,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": true,
            "resizableY": true,
            "minWidth": 16,
            "maxWidth": null,
            "minHeight": 16,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#A043D7",
            "renderMode": "Cross",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Locs_Shadow",
                "doc": null,
                "__type": "LocalEnum.Locs_Shadow",
                "uid": 55,
                "type": "F_Enum(54)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "ValueOnly",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Region_Apex",
            "uid": 56,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": true,
            "resizableY": true,
            "minWidth": 16,
            "maxWidth": null,
            "minHeight": 16,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#E43B44",
            "renderMode": "Cross",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Locs_Apex",
                "doc": null,
                "__type": "LocalEnum.Locs_Apex",
                "uid": 58,
                "type": "F_Enum(57)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "ValueOnly",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Pokemon_Centers",
            "uid": 60,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#EAD4AA",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Pokemon_Centers",
                "doc": null,
                "__type": "LocalEnum.Pokemon_Centers",
                "uid": 62,
                "type": "F_Enum(61)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "Hidden",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "PC_Terminal",
            "uid": 64,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#72CCE4",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": []
        }, {
            "identifier": "Shop_Kiosk",
            "uid": 65,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#FEE761",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Shop_Kiosk",
                "doc": null,
                "__type": "LocalEnum.Shop_Kiosk",
                "uid": 68,
                "type": "F_Enum(63)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "ValueOnly",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Bed_Rest",
            "uid": 69,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#E4A672",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Bed_Rest",
                "doc": null,
                "__type": "LocalEnum.Bed_Rest",
                "uid": 71,
                "type": "F_Enum(66)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "ValueOnly",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Police_Box",
            "uid": 72,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#733E39",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Service_Type",
                "doc": null,
                "__type": "LocalEnum.Police_Box",
                "uid": 74,
                "type": "F_Enum(73)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "Hidden",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "NPC_Actor",
            "uid": 76,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#FEE761",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "NPC_Actor",
                "doc": null,
                "__type": "LocalEnum.NPC_Actor",
                "uid": 78,
                "type": "F_Enum(77)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "ValueOnly",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }, {
            "identifier": "Place_Anchor",
            "uid": 80,
            "tags": [],
            "exportToToc": false,
            "allowOutOfBounds": false,
            "doc": null,
            "width": 16,
            "height": 16,
            "resizableX": false,
            "resizableY": false,
            "minWidth": null,
            "maxWidth": null,
            "minHeight": null,
            "maxHeight": null,
            "keepAspectRatio": false,
            "tileOpacity": 1,
            "fillOpacity": 1,
            "lineOpacity": 1,
            "hollow": false,
            "color": "#3E2731",
            "renderMode": "Rectangle",
            "showName": true,
            "tilesetId": null,
            "tileRenderMode": "FitInside",
            "tileRect": null,
            "uiTileRect": null,
            "nineSliceBorders": [],
            "maxCount": 0,
            "limitScope": "PerLevel",
            "limitBehavior": "MoveLastOne",
            "pivotX": 0,
            "pivotY": 0,
            "fieldDefs": [{
                "identifier": "Place_Anchor",
                "doc": null,
                "__type": "LocalEnum.Place_Anchor",
                "uid": 82,
                "type": "F_Enum(81)",
                "isArray": false,
                "canBeNull": false,
                "arrayMinLength": null,
                "arrayMaxLength": null,
                "editorDisplayMode": "ValueOnly",
                "editorDisplayScale": 1,
                "editorDisplayPos": "Above",
                "editorLinkStyle": "StraightArrow",
                "editorDisplayColor": null,
                "editorAlwaysShow": false,
                "editorShowInWorld": true,
                "editorCutLongValues": true,
                "editorTextSuffix": null,
                "editorTextPrefix": null,
                "useForSmartColor": true,
                "exportToToc": false,
                "searchable": false,
                "min": null,
                "max": null,
                "regex": null,
                "acceptFileTypes": null,
                "defaultOverride": null,
                "textLanguageMode": null,
                "symmetricalRef": false,
                "autoChainRef": true,
                "allowOutOfLevelRef": true,
                "allowedRefs": "OnlySame",
                "allowedRefsEntityUid": null,
                "allowedRefTags": [],
                "tilesetUid": null
            }]
        }],
        "tilesets": [{
            "__cWid": 32,
            "__cHei": 64,
            "identifier": "Internal_Icons",
            "uid": 10,
            "relPath": null,
            "embedAtlas": "LdtkIcons",
            "pxWid": 512,
            "pxHei": 1024,
            "tileGridSize": 16,
            "spacing": 0,
            "padding": 0,
            "tags": [],
            "tagsSourceEnumUid": null,
            "enumTags": [],
            "customData": [],
            "savedSelections": [],
            "cachedPixelData": {
                "opaqueTiles": "00000000000000000000000000000000000000000000000000000000000000000000000000000000111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                "averageColors": "00004b344233459b423349a959a9379c688769758ca4bc9489aab9aa58cc58bc42d74d2244ce428f4c7e4ff74abb45564ffe7dda7888a899889900000000000069a969a97a99999999989a85998699767a7579667ccc7ccc7bcb7caa7ccc7ccc22d72d2224ce228f2c7e2ff72abb25562ffeba444955ab55974300000000000059764b97599868ac679a69ab4a84477756787688475347532a932a934a837a83f2b6fb22f3acf15afa6cfdc6f899f334fccca778a7440000000000000000000059aa49aa59996999699969aa489949995999799a499949992999299948997889a385a823a379a248a749aa85a667a223a8880000000000000000000000000000189919991999199939994778166727772889289948993aaa389949a959a959a932b63b2233ad315a395c3ec6389933343ccc00000000000000000000000000008aaa8aaa8aaa8aaa8aaa7bbb8aaa7bbb8bcb7aaa8bcb7bcb69aa8aaa8aaa69aa6abb6abb6abb6abb6a226a226a226a2261a661a661a661a600000000000000006c526c426c926c91659b649c66a566a46a7b6a7b667766776aba6abb676367636da46da46da46da4616c616c616c616c8abb8abb8abb8abb00000000000000006ba5579a6689598658875cb66abb9aa989aa98ac7abc6678968a88877c87cba952755823536952475648598454455223599900000000000000000000000000003ec63da76db79dc7554885498969b4377fa29e8289cdb9ce5ade5ade49ce49ce82a68a22839b8259885b8cb5855683238aab00000000000000000000000000005d745d867da87e75448c458b86ad76ae68ac679c779b78ce3c9378867ca6adb784858933847a844788498b94854584348989000000000000000000000000000057a668b899b8449396534493858364836853697769436667755667776c73498862b66b22639c615a695c6dc5655663346bbc00000000000000000000000000006bba79b87d9679ad776a7b988abc8abc4aceaace4bba4bba6b8c4c9c4cac5b7c62a66a22639c6159695b6db5655663236abb000000000000000000000000000059aaada7a9bdcdbd59aaada7a9bdcdbd8cb8a9b98ac889b8aabaacc79ea498bd82b68b2283ad815a8a5c8ec5856783348ccc000000000000000000000000000057ac596b55946abb5abb8ca65d8677ac437b5a3368886934547a595897a57b2372957923738a7258784a7c9474557323799a0000000000000000000000000000799a5c817b9b3a886abb8464676a7a967a857a857977898889882a954a956b9562d76d2264ce628f6c7e6ff76abb65566ffe0000000000000000000000000000499977997868799579875a6465995a8957a66a735ba53a935969479a576a467732d73d2234ce328f3c7e3ff73abb35563ffe00000000000000000000000000005744985596659b747a659a76768a7a567675477738873566597698779445946572d77d2274ce728f7c7e7ff77abb75567ffe000000000000000000000000000088668a66868a9b8577666a4467846987778a7789797a87888b8676667a767ca562d76d2264ce628f6c7e6ff76abb65566ffe0000000000000000000000000000449374934c957c9574847a438475a3958695768565956853b9447a777493a493000000000000000000000000000000000000000000000000000000000000000079547a838394689a49547a6357636975786383848997b384655873748974588400000000000000000000000000000000000000000000000000000000000000007da48ca769768b554b976cba3a824a82696259526a758c986963694268478b850000000000000000000000000000000000000000000000000000000000000000696559555579557458598674573353635677575579667a8758538b848a44838b0000000000000000000000000000000000000000000000000000000000000000385437883b95534549555a855877997598772b953b9529a939a95aa84b949a840000000000000000000000000000000000000000000000000000000000000000897687898776878578998485878b789a847b8b6579998a55886998788a879b9700000000000000000000000000000000000000000000000000000000000000006ba97988897469646b987a876a997a987b987955766777765c958a858777867700000000000000000000000000000000000000000000000000000000000000005a747b947b967866a855788928884566578879a98864a579233433343334633400000000000000000000000000000000000000000000000000000000000000006a747b846a844997598669987bb8b8aabaa96ba67cba9854687669864a864b86000000000000000000000000000000000000000000000000000000000000000038ab389b48ab47ac49ab48ac579b48ac49ab38ab58bc4b8659aa5c8457ac586a0000000000000000000000000000000000000000000000000000000000000000299b2999389a379b38893955589a79bc8c9588bc7a8c599a689a5b8558ac597a00000000000000000000000000000000000000000000000000000000000000002888378936773975579b389a579b488938884b74469a465747785b75568b586a000000000000000000000000000000000000000000000000000000000000000038553865285428444755566455763a64356746743779397445674c63469b585a0000000000000000000000000000000000000000000000000000000000000000284437643a7629641555297938874879385438664665355536775a85569a785a00000000000000000000000000000000000000000000000000000000000000005789789b779b6a75668a897b64558555876576798855845694749b74a68a986a000000000000000000000000000000000000000000000000000000000000000047776766678867667799798698768866976685673755387638763b74358b387a00000000000000000000000000000000000000000000000000000000000000005777686569874944498846774677685568646987677778775a456a65ab66ca550000000000000000000000000000000000000000000000000000000000000000355656666656455546455345634558655854aa749854775577737b64777a7a7900000000000000000000000000000000000000000000000000000000000000005955895598546c758c75ba76b88797749b75a98967888789978857888788a78800000000000000000000000000000000000000000000000000000000000000006977897799776a748a749a747987ba97aa998ba8a78bab75a87ab89cbb74b97b000000000000000000000000000000000000000000000000000000000000000059645788598858546a7569996a767a766887649c767476797a54766977667976000000000000000000000000000000000000000000000000000000000000000078887a75796577777a869976987799865777667787668a53857a885a98659546000000000000000000000000000000000000000000000000000000000000000087559877a96586779788b9769866888899877576777879647759a8659888a7440000000000000000000000000000000000000000000000000000000000000000785477887a55747b7585795b7999a9667456878889aa58997888797b56776855000000000000000000000000000000000000000000000000000000000000000048545854617b644557448744537b85565899899a39994a7a58998999a5558988000000000000000000000000000000000000000000000000000000000000000089659744a6559555a55698889486a57aab43a96b9556a665a854a579a744a5550000000000000000000000000000000000000000000000000000000000000000596587556677777777778578876687778974867787668876988897779876a744000000000000000000000000000000000000000000000000000000000000000067536556875448225922415851595456654587459456947b48997a86764585560000000000000000000000000000000000000000000000000000000000000000a854a89989998556a7559766a7779976a975997596749a64968a9779a55595450000000000000000000000000000000000000000000000000000000000000000674487549854885594558445a777a7778373579b5a32675584456975958b9944000000000000000000000000000000000000000000000000000000000000000077449754b674b469b964b658a766a864a777a975a566a754a677a875b777b9650000000000000000000000000000000000000000000000000000000000000000775577547445755676558744697377637766785334556566577859755877887600000000000000000000000000000000000000000000000000000000000000002789287328772a7436793a9457795a84368a3334323364555a757b856aaa9a5500000000000000000000000000000000000000000000000000000000000000005888516b5a3349a95964797778987a5375696a536668796577887a847a74797500000000000000000000000000000000000000000000000000000000000000007b537a53767b6769748775767a9a7988759c768a7b957a847775776478647854000000000000000000000000000000000000000000000000000000000000000098999788988998889b879a869a869a86696565676965667767446854677877880000000000000000000000000000000000000000000000000000000000000000678a77997ba647887a7589999ca59ba889aa9999655667bd6ba979a967bc6c7300000000000000000000000000000000000000000000000000000000000000006aaa6556518566775965485438985888576546854ca547775999699989997a9900000000000000000000000000000000000000000000000000000000000000006678526466335644769c5a7888547a785c4454a658885c946285627b6c54674a000000000000000000000000000000000000000000000000000000000000000033843b33359c337c395c3b853899355653745a33558b536b585b5a7557885445000000000000000000000000000000000000000000000000000000000000000026551566274525664a85486546564656377756664655465545454656516a656700000000000000000000000000000000000000000000000000000000000000004964696468553a86485437443645896588548856895477446a7569547a757954000000000000000000000000000000000000000000000000000000000000000036678566399988993b968b955ba658995566588859645a986ca7796477887ca6000000000000000000000000000000000000000000000000000000000000000019562a554c665c55156a256a468c557b1a8429744a845a83196b285a496b595b00000000000000000000000000000000000000000000000000000000000000001486248645a7549615782578469a5689187629764a875a861a692a694b7a5b79000000000000000000000000000000000000000000000000000000000000000017772777489858881555255546665556199528854884588411122112411251120000000000000000000000000000000000000000000000000000000000000000"
            }
        }],
        "enums": [{
            "identifier": "DestType",
            "uid": 18,
            "values": [{
                "id": "Sewer_0",
                "tileRect": null,
                "color": 7552569
            }, {
                "id": "Sewer_1",
                "tileRect": null,
                "color": 14120515
            }, {
                "id": "Sewer_2",
                "tileRect": null,
                "color": 14984818
            }, {
                "id": "Cave_0",
                "tileRect": null,
                "color": 12470831
            }, {
                "id": "Cave_1",
                "tileRect": null,
                "color": 4073265
            }, {
                "id": "Cave_2",
                "tileRect": null,
                "color": 16690740
            }, {
                "id": "Gate_0",
                "tileRect": null,
                "color": 15389866
            }, {
                "id": "Gate_1",
                "tileRect": null,
                "color": 16705377
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Transit_Station",
            "uid": 22,
            "values": [{
                "id": "Central_Hub",
                "tileRect": null,
                "color": 16705377
            }, {
                "id": "Electro_Avenue",
                "tileRect": null,
                "color": 2943221
            }, {
                "id": "Seaside_Terminal",
                "tileRect": null,
                "color": 6539085
            }, {
                "id": "District_S",
                "tileRect": null,
                "color": 6830188
            }, {
                "id": "Frontier_Outpost",
                "tileRect": null,
                "color": 16711748
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Sea_Route",
            "uid": 24,
            "values": [{
                "id": "Neon_Cargo_Terminal",
                "tileRect": null,
                "color": 2943221
            }, {
                "id": "Sapphire_Marina",
                "tileRect": null,
                "color": 4098376
            }, {
                "id": "Restricted_Dock",
                "tileRect": null,
                "color": 16705377
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Sky_Net",
            "uid": 28,
            "values": [{
                "id": "Northern_Cemetery",
                "tileRect": null,
                "color": 11882632
            }, {
                "id": "Summit_Dojo_POINT",
                "tileRect": null,
                "color": 12470831
            }, {
                "id": "Zenith_HQ",
                "tileRect": null,
                "color": 16705377
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Biome",
            "uid": 50,
            "values": [{
                "id": "Sapphire_Strand",
                "tileRect": null,
                "color": 16765738
            }, {
                "id": "Jade_Canopy",
                "tileRect": null,
                "color": 3066993
            }, {
                "id": "Deep_Root_Hollow",
                "tileRect": null,
                "color": 25190
            }, {
                "id": "Silt_Delta",
                "tileRect": null,
                "color": 7649791
            }, {
                "id": "Aroma_Meadow",
                "tileRect": null,
                "color": 16752627
            }, {
                "id": "Cerulean_Reef",
                "tileRect": null,
                "color": 1030577
            }, {
                "id": "Crystal_Lagoon",
                "tileRect": null,
                "color": 4565746
            }, {
                "id": "Hermit_Sands",
                "tileRect": null,
                "color": 13749440
            }, {
                "id": "Golden_Horizon",
                "tileRect": null,
                "color": 16234289
            }, {
                "id": "Breeze_Woodlands",
                "tileRect": null,
                "color": 8121759
            }, {
                "id": "Radiant_Plains",
                "tileRect": null,
                "color": 14345564
            }, {
                "id": "Prism_Bay",
                "tileRect": null,
                "color": 1629439
            }, {
                "id": "Ferro_Straits",
                "tileRect": null,
                "color": 4941188
            }, {
                "id": "Arcadia_Lawns",
                "tileRect": null,
                "color": 14673130
            }, {
                "id": "Frigid_Floe",
                "tileRect": null,
                "color": 6540278
            }, {
                "id": "Mist_Veil_Sound",
                "tileRect": null,
                "color": 13555424
            }, {
                "id": "Cinder_Moor",
                "tileRect": null,
                "color": 11745593
            }, {
                "id": "Twilight_Copse",
                "tileRect": null,
                "color": 2898503
            }, {
                "id": "Silent_Tundra",
                "tileRect": null,
                "color": 16316922
            }, {
                "id": "Basalt_Shoals",
                "tileRect": null,
                "color": 2898503
            }, {
                "id": "Obsidian_Beach",
                "tileRect": null,
                "color": 2962486
            }, {
                "id": "Savanna_Outlands",
                "tileRect": null,
                "color": 14790956
            }, {
                "id": "Scorched_Dunes",
                "tileRect": null,
                "color": 16500017
            }, {
                "id": "Inferno_Crater",
                "tileRect": null,
                "color": 12727830
            }, {
                "id": "Crimson_Badlands",
                "tileRect": null,
                "color": 15221016
            }, {
                "id": "Frostbite_Slope",
                "tileRect": null,
                "color": 13752544
            }, {
                "id": "Boreal_Trench",
                "tileRect": null,
                "color": 414429
            }, {
                "id": "Equatorial_Dark_Zone",
                "tileRect": null,
                "color": 1649238
            }, {
                "id": "Titan_Trough",
                "tileRect": null,
                "color": 3094080
            }, {
                "id": "Chrome_Abyss",
                "tileRect": null,
                "color": 4732116
            }, {
                "id": "Emerald_Vein_River",
                "tileRect": null,
                "color": 2870202
            }, {
                "id": "Mirror_Lotis_Lake",
                "tileRect": null,
                "color": 4968442
            }, {
                "id": "Zero_Halo_Moat",
                "tileRect": null,
                "color": 1030577
            }, {
                "id": "Twin_Destiny_Basin",
                "tileRect": null,
                "color": 4565746
            }, {
                "id": "Mercury_Stream",
                "tileRect": null,
                "color": 6333372
            }, {
                "id": "Chrome_Canal",
                "tileRect": null,
                "color": 8323061
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Lava_Line",
            "uid": 32,
            "values": [{
                "id": "Lift_Station_Lower",
                "tileRect": null,
                "color": 12470831
            }, {
                "id": "Lift_Station_Upper",
                "tileRect": null,
                "color": 14120515
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Locs_Zenith",
            "uid": 41,
            "values": [{
                "id": "Aether_Admin_Zone",
                "tileRect": null,
                "color": 16777215
            }, {
                "id": "Royal_Academy",
                "tileRect": null,
                "color": 7649791
            }, {
                "id": "Living_Quarter",
                "tileRect": null,
                "color": 14673641
            }, {
                "id": "Lusamine_Gardens",
                "tileRect": null,
                "color": 16742005
            }, {
                "id": "Eco_Subject_Delta",
                "tileRect": null,
                "color": 5631940
            }, {
                "id": "Academic_Plaza",
                "tileRect": null,
                "color": 10656766
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Locs_Neon",
            "uid": 44,
            "values": [{
                "id": "Iono_Stream_Tower",
                "tileRect": null,
                "color": 16752451
            }, {
                "id": "Toxic_Industrial_Park",
                "tileRect": null,
                "color": 5727604
            }, {
                "id": "Cyber_Shopping_District",
                "tileRect": null,
                "color": 16739201
            }, {
                "id": "Port_Logistics_Area",
                "tileRect": null,
                "color": 5546239
            }, {
                "id": "Glitch_Arcade_Lane",
                "tileRect": null,
                "color": 53971
            }, {
                "id": "Skyline_Residences",
                "tileRect": null,
                "color": 11714243
            }, {
                "id": "Synth_Promenade",
                "tileRect": null,
                "color": 5631940
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Locs_Bloom",
            "uid": 47,
            "values": [{
                "id": "Pearl_Resort",
                "tileRect": null,
                "color": 16623583
            }, {
                "id": "Sunflora_Farmsteads",
                "tileRect": null,
                "color": 14774357
            }, {
                "id": "Marina_Port_Town",
                "tileRect": null,
                "color": 7649791
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Locs_Shadow",
            "uid": 54,
            "values": [{
                "id": "Grim_Borough",
                "tileRect": null,
                "color": 2962486
            }, {
                "id": "Venom_Refinery",
                "tileRect": null,
                "color": 10656766
            }, {
                "id": "Requiem_Grounds",
                "tileRect": null,
                "color": 14673641
            }, {
                "id": "Canal_Ruins_Post",
                "tileRect": null,
                "color": 11577529
            }, {
                "id": "Frost_Smoke_City",
                "tileRect": null,
                "color": 11714243
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Locs_Apex",
            "uid": 57,
            "values": [{
                "id": "Frontier_Base_Camp",
                "tileRect": null,
                "color": 12470831
            }, {
                "id": "Titan_Mining_site",
                "tileRect": null,
                "color": 14120515
            }, {
                "id": "Ruins_of_Giants",
                "tileRect": null,
                "color": 15389866
            }, {
                "id": "Crimson_Forge_City",
                "tileRect": null,
                "color": 13849600
            }, {
                "id": "Dune_Watcher_Post",
                "tileRect": null,
                "color": 49865
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Pokemon_Centers",
            "uid": 61,
            "values": [{
                "id": "CP_Zenith_Main",
                "tileRect": null,
                "color": 16705377
            }, {
                "id": "CP_Neon_Central",
                "tileRect": null,
                "color": 2943221
            }, {
                "id": "CP_Bloom_Port",
                "tileRect": null,
                "color": 6539085
            }, {
                "id": "CP_Shadow_Slum",
                "tileRect": null,
                "color": 6830188
            }, {
                "id": "CP_Apex_Base",
                "tileRect": null,
                "color": 14957380
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Shop_Kiosk",
            "uid": 63,
            "values": [{
                "id": "Wares_General",
                "tileRect": null,
                "color": 15389866
            }, {
                "id": "Shop_Special_Z",
                "tileRect": null,
                "color": 16705377
            }, {
                "id": "Shop_Special_N",
                "tileRect": null,
                "color": 2943221
            }, {
                "id": "Shop_Special_B",
                "tileRect": null,
                "color": 6539085
            }, {
                "id": "Shop_Special_S",
                "tileRect": null,
                "color": 11882632
            }, {
                "id": "Shop_Special_A",
                "tileRect": null,
                "color": 12470831
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Bed_Rest",
            "uid": 66,
            "values": [{
                "id": "Player_s_Room",
                "tileRect": null,
                "color": 39387
            }, {
                "id": "Bed_Rest",
                "tileRect": null,
                "color": 16705377
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Police_Box",
            "uid": 73,
            "values": [{
                "id": "Police_Box_Z",
                "tileRect": null,
                "color": 16705377
            }, {
                "id": "Police_Box_N",
                "tileRect": null,
                "color": 2943221
            }, {
                "id": "Police_Box_B",
                "tileRect": null,
                "color": 6539085
            }, {
                "id": "Police_Box_S",
                "tileRect": null,
                "color": 6830188
            }, {
                "id": "Police_Box_A",
                "tileRect": null,
                "color": 16711748
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "NPC_Actor",
            "uid": 77,
            "values": [{
                "id": "Gloria_Camp_Curry",
                "tileRect": null,
                "color": 10626611
            }, {
                "id": "Rosa_PokeStar_Studios",
                "tileRect": null,
                "color": 2943221
            }, {
                "id": "Dawn_VIP_Beach_Villa_01",
                "tileRect": null,
                "color": 14120515
            }, {
                "id": "Akari_Utility_Shack",
                "tileRect": null,
                "color": 15389866
            }, {
                "id": "Serena_Boutique_Serena_Style",
                "tileRect": null,
                "color": 14984818
            }, {
                "id": "Selene_Jungle_Treehouse",
                "tileRect": null,
                "color": 7552569
            }, {
                "id": "Juliana_Int_l_Dorm_Rm_303",
                "tileRect": null,
                "color": 4073265
            }, {
                "id": "Lusamine_Exec_Private_Penthouse",
                "tileRect": null,
                "color": 16690740
            }, {
                "id": "Lillie_Staff_Dormitory_Room_201",
                "tileRect": null,
                "color": 16705377
            }, {
                "id": "Mallow_Lana_Alola_Breeze_Diner_Room",
                "tileRect": null,
                "color": 6539085
            }, {
                "id": "Irida_Cryo_Stasis_Lab",
                "tileRect": null,
                "color": 4098376
            }, {
                "id": "Roxie_Venom_Core_Live_House",
                "tileRect": null,
                "color": 1199753
            }, {
                "id": "Iono_Levincia_Guild_Tower",
                "tileRect": null,
                "color": 39387
            }, {
                "id": "Marnie_Spikemuth_Relief_Center",
                "tileRect": null,
                "color": 16777215
            }, {
                "id": "Hex_Spirit_Tower_Basement",
                "tileRect": null,
                "color": 12635100
            }, {
                "id": "Bea_Iron_Will_Dojo",
                "tileRect": null,
                "color": 9149364
            }, {
                "id": "Cynthia_Champion_s_Outlook_Suite",
                "tileRect": null,
                "color": 5925256
            }, {
                "id": "Erika_Celadon_Spa",
                "tileRect": null,
                "color": 3818598
            }, {
                "id": "Nessa_The_Infinity_Poolside_Lounge",
                "tileRect": null,
                "color": 16711748
            }, {
                "id": "Sonia_Rhodia_Central_Lab",
                "tileRect": null,
                "color": 11882632
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }, {
            "identifier": "Place_Anchor",
            "uid": 81,
            "values": [{
                "id": "Cafe",
                "tileRect": null,
                "color": 12470831
            }, {
                "id": "Bar",
                "tileRect": null,
                "color": 14120515
            }, {
                "id": "Diner",
                "tileRect": null,
                "color": 15389866
            }, {
                "id": "Shop_Browsk",
                "tileRect": null,
                "color": 14984818
            }, {
                "id": "Arcade",
                "tileRect": null,
                "color": 7552569
            }, {
                "id": "Relax",
                "tileRect": null,
                "color": 4073265
            }, {
                "id": "Viewpoint",
                "tileRect": null,
                "color": 16690740
            }, {
                "id": "Plaza",
                "tileRect": null,
                "color": 16705377
            }, {
                "id": "Nature_Spot",
                "tileRect": null,
                "color": 6539085
            }, {
                "id": "Study",
                "tileRect": null,
                "color": 4098376
            }],
            "iconTilesetUid": null,
            "externalRelPath": null,
            "externalFileChecksum": null,
            "tags": []
        }],
        "externalEnums": [],
        "levelFields": []
    },
    "levels": [{
        "identifier": "RhodiaWorld",
        "iid": "df3c7a50-d380-11f0-8216-4510b8519d3a",
        "uid": 0,
        "worldX": 0,
        "worldY": 0,
        "worldDepth": 0,
        "pxWid": 832,
        "pxHei": 832,
        "__bgColor": "#2C3397",
        "bgColor": "#2C3397",
        "useAutoIdentifier": false,
        "bgRelPath": null,
        "bgPos": null,
        "bgPivotX": 0.5,
        "bgPivotY": 0.5,
        "__smartColor": "#8B8FC6",
        "__bgPos": null,
        "externalRelPath": null,
        "fieldInstances": [],
        "layerInstances": [{
            "__identifier": "Place_Anchor",
            "__type": "Entities",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 1,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "defd0fc0-d380-11f0-a722-d5936f5b7585",
            "levelId": 0,
            "layerDefUid": 79,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [],
            "autoLayerTiles": [],
            "seed": 1414230,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": [{
                "__identifier": "Place_Anchor",
                "__grid": [42, 30],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#D77643",
                "iid": "13ae8520-d380-11f0-a722-e39200471298",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [672, 480],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Bar",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bar"]
                    }]
                }],
                "__worldX": 672,
                "__worldY": 480
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [33, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "17c34a10-d380-11f0-a722-d9907f2e99d4",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [528, 592],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 592
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [35, 34],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "19eda420-d380-11f0-a722-3513101bd60c",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [560, 544],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Plaza",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Plaza"]
                    }]
                }],
                "__worldX": 560,
                "__worldY": 544
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [30, 42],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "20399460-d380-11f0-a722-8fc8f28afef9",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [480, 672],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Diner",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Diner"]
                    }]
                }],
                "__worldX": 480,
                "__worldY": 672
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [40, 38],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "27991780-d380-11f0-a722-99b16424b78a",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [640, 608],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 608
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [39, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#733E39",
                "iid": "4f3ec7d0-d380-11f0-a722-53cbb50b61b1",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [624, 576],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Arcade",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcade"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 576
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [10, 30],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "5d069cd0-d380-11f0-a722-a5fd15c23ff9",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [160, 480],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 160,
                "__worldY": 480
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [7, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "61723450-d380-11f0-a722-e5b931ac4638",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [112, 320],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 112,
                "__worldY": 320
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [28, 38],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "652948e0-d380-11f0-a722-8f27b03f09ec",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [448, 608],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 448,
                "__worldY": 608
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [38, 47],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "686b7b90-d380-11f0-a722-69b8bbebf071",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [608, 752],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 752
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [47, 34],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "6e77f1d0-d380-11f0-a722-1d8f529823e2",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [752, 544],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 752,
                "__worldY": 544
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [28, 42],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E4A672",
                "iid": "8ac9da60-d380-11f0-a722-cdf9843ccc21",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [448, 672],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Shop_Browsk",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Browsk"]
                    }]
                }],
                "__worldX": 448,
                "__worldY": 672
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [38, 28],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E4A672",
                "iid": "8ecac930-d380-11f0-a722-97d4236b88e1",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [608, 448],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Shop_Browsk",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Browsk"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 448
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [37, 28],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#BE4A2F",
                "iid": "913c3e60-d380-11f0-a722-35cc8ea61af2",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [592, 448],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Cafe",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cafe"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 448
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [37, 43],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "9f6f3140-d380-11f0-a722-996b26363c58",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [592, 688],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Plaza",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Plaza"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 688
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [44, 33],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "a506ecb0-d380-11f0-a722-d9c788062d08",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [704, 528],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Plaza",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Plaza"]
                    }]
                }],
                "__worldX": 704,
                "__worldY": 528
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [29, 43],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "a9c908a0-d380-11f0-a722-d9834976a66f",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [464, 688],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Plaza",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Plaza"]
                    }]
                }],
                "__worldX": 464,
                "__worldY": 688
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [22, 46],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "acbc5800-d380-11f0-a722-1b545f21a5fd",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [352, 736],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 352,
                "__worldY": 736
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [7, 47],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "b1d01660-d380-11f0-a722-25bde374b186",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [112, 752],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 112,
                "__worldY": 752
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [4, 41],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "b471c350-d380-11f0-a722-5788f437ac21",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [64, 656],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 64,
                "__worldY": 656
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [12, 44],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E4A672",
                "iid": "c361c4a0-d380-11f0-a722-b36b77dfff27",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [192, 704],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Shop_Browsk",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Browsk"]
                    }]
                }],
                "__worldX": 192,
                "__worldY": 704
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [4, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "ceb03530-d380-11f0-a722-4965604ec7f5",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [64, 496],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 64,
                "__worldY": 496
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [23, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E4A672",
                "iid": "d4b33590-d380-11f0-a722-099f1f60aa88",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [368, 592],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Shop_Browsk",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Browsk"]
                    }]
                }],
                "__worldX": 368,
                "__worldY": 592
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [20, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "d71b8300-d380-11f0-a722-e7e5875dabc0",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [320, 592],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Diner",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Diner"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 592
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [13, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "e2219ff0-d380-11f0-a722-dd9110896cbc",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [208, 320],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Diner",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Diner"]
                    }]
                }],
                "__worldX": 208,
                "__worldY": 320
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [10, 40],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "efc15380-d380-11f0-a722-d3b65dd7ae6d",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [160, 640],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 160,
                "__worldY": 640
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [8, 43],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "06abdf70-d380-11f0-a722-99140c4df74d",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [128, 688],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Diner",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Diner"]
                    }]
                }],
                "__worldX": 128,
                "__worldY": 688
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [5, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#3E2731",
                "iid": "1b889a00-d380-11f0-a722-ffcd7743230c",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [80, 576],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Relax",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Relax"]
                    }]
                }],
                "__worldX": 80,
                "__worldY": 576
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [13, 44],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#BE4A2F",
                "iid": "23a3a4f0-d380-11f0-a722-058b083eedba",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [208, 704],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Cafe",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cafe"]
                    }]
                }],
                "__worldX": 208,
                "__worldY": 704
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [16, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E4A672",
                "iid": "2d6b9c90-d380-11f0-a722-17c035f4d03b",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [256, 208],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Shop_Browsk",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Browsk"]
                    }]
                }],
                "__worldX": 256,
                "__worldY": 208
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [6, 45],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "38bc08f0-d380-11f0-a722-3fa5529aff48",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [96, 720],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Plaza",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Plaza"]
                    }]
                }],
                "__worldX": 96,
                "__worldY": 720
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [20, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "4503f4b0-d380-11f0-a722-a17bae7ef219",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [320, 208],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Plaza",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Plaza"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 208
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [24, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "4770fd10-d380-11f0-a722-0b680c23e017",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [384, 208],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 384,
                "__worldY": 208
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [7, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "4ac09d40-d380-11f0-a722-0780424e295c",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [112, 208],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 112,
                "__worldY": 208
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [16, 11],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "4d4684d0-d380-11f0-a722-b32827dc70a8",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [256, 176],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 256,
                "__worldY": 176
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [13, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "519126d0-d380-11f0-a722-19867a1cbd07",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [208, 208],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 208,
                "__worldY": 208
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [21, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "5444fc30-d380-11f0-a722-9fbe93801187",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [336, 288],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 336,
                "__worldY": 288
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [15, 24],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "5a13f440-d380-11f0-a722-bb746850c2ee",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [240, 384],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 240,
                "__worldY": 384
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [28, 15],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "6509e490-d380-11f0-a722-9beb5f62baca",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [448, 240],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 448,
                "__worldY": 240
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [41, 41],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#D77643",
                "iid": "6f361c40-d380-11f0-a722-2b882670b6e7",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [656, 656],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Bar",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bar"]
                    }]
                }],
                "__worldX": 656,
                "__worldY": 656
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [43, 30],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#733E39",
                "iid": "786185c0-d380-11f0-a722-d765d55aafac",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [688, 480],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Arcade",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcade"]
                    }]
                }],
                "__worldX": 688,
                "__worldY": 480
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [38, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#D77643",
                "iid": "81f96cb0-d380-11f0-a722-af361fb8bd36",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [608, 288],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Bar",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bar"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 288
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [44, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#733E39",
                "iid": "84c9cac0-d380-11f0-a722-65fd719561ae",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [704, 352],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Arcade",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcade"]
                    }]
                }],
                "__worldX": 704,
                "__worldY": 352
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [38, 10],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "91615d20-d380-11f0-a722-234a861c82f9",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [608, 160],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 160
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [41, 19],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "93c98380-d380-11f0-a722-7fbe34cb78c1",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [656, 304],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Plaza",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Plaza"]
                    }]
                }],
                "__worldX": 656,
                "__worldY": 304
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [40, 23],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "9aa2bfa0-d380-11f0-a722-a9271159e235",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [640, 368],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 368
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [39, 15],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E4A672",
                "iid": "a45b9c10-d380-11f0-a722-abbcaa2c83e3",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [624, 240],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Shop_Browsk",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Browsk"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 240
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [39, 28],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "ad1a12f0-d380-11f0-a722-4ff90ef89f10",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [624, 448],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Diner",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Diner"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 448
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [20, 11],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "b3f1ef80-d380-11f0-a722-8dbe8335500f",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [320, 176],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Diner",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Diner"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 176
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [44, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#D77643",
                "iid": "c56937f0-d380-11f0-a722-c9d0f9963d07",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [704, 288],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Bar",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bar"]
                    }]
                }],
                "__worldX": 704,
                "__worldY": 288
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [39, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E4A672",
                "iid": "d8868f40-d380-11f0-a722-abcafbaf3c54",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [624, 320],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Shop_Browsk",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Browsk"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 320
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [37, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "e0d99a20-d380-11f0-a722-b914db9f8ff6",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [592, 144],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Diner",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Diner"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 144
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [41, 10],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#733E39",
                "iid": "e7c35100-d380-11f0-a722-bf0227556055",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [656, 160],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Arcade",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcade"]
                    }]
                }],
                "__worldX": 656,
                "__worldY": 160
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [45, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "ec01e510-d380-11f0-a722-d194923fb0be",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [720, 208],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Nature_Spot",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nature_Spot"]
                    }]
                }],
                "__worldX": 720,
                "__worldY": 208
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [30, 8],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "f0961330-d380-11f0-a722-4d449b856b96",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [480, 128],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 480,
                "__worldY": 128
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [10, 12],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "f41771c0-d380-11f0-a722-6f03b7df60e1",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [160, 192],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 160,
                "__worldY": 192
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [23, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#3E8948",
                "iid": "00de5180-d380-11f0-a722-8fc9ebd85b6a",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [368, 336],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Study",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Study"]
                    }]
                }],
                "__worldX": 368,
                "__worldY": 336
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [20, 28],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#3E8948",
                "iid": "05c0edc0-d380-11f0-a722-fbbcd23b74bc",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [320, 448],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Study",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Study"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 448
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [30, 28],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "0849bb80-d380-11f0-a722-3fb1796bdf07",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [480, 448],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 480,
                "__worldY": 448
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [27, 25],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "0c3dd910-d380-11f0-a722-017c3b09cfc4",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [432, 400],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Plaza",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Plaza"]
                    }]
                }],
                "__worldX": 432,
                "__worldY": 400
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [27, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E4A672",
                "iid": "14a0c270-d380-11f0-a722-f3695ea25689",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [432, 432],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Shop_Browsk",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Browsk"]
                    }]
                }],
                "__worldX": 432,
                "__worldY": 432
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [28, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#BE4A2F",
                "iid": "18b0f380-d380-11f0-a722-0b55b3a00f2f",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [448, 432],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Cafe",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cafe"]
                    }]
                }],
                "__worldX": 448,
                "__worldY": 432
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [29, 26],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "209229c0-d380-11f0-a722-99e2a04fa1f9",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [464, 416],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Diner",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Diner"]
                    }]
                }],
                "__worldX": 464,
                "__worldY": 416
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [23, 24],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#3E8948",
                "iid": "295f6db0-d380-11f0-a722-4396b4df986b",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [368, 384],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Study",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Study"]
                    }]
                }],
                "__worldX": 368,
                "__worldY": 384
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [23, 28],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "2fed21e0-d380-11f0-a722-2355d4cee4b1",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [368, 448],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 368,
                "__worldY": 448
            }, {
                "__identifier": "Place_Anchor",
                "__grid": [26, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "355cbbe0-d380-11f0-a722-cfcd541ae571",
                "width": 16,
                "height": 16,
                "defUid": 80,
                "px": [416, 336],
                "fieldInstances": [{
                    "__identifier": "Place_Anchor",
                    "__type": "LocalEnum.Place_Anchor",
                    "__value": "Viewpoint",
                    "__tile": null,
                    "defUid": 82,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Viewpoint"]
                    }]
                }],
                "__worldX": 416,
                "__worldY": 336
            }]
        }, {
            "__identifier": "NPC_Actor",
            "__type": "Entities",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 1,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "6f9b7890-d380-11f0-8099-7d81d258abc9",
            "levelId": 0,
            "layerDefUid": 75,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [],
            "autoLayerTiles": [],
            "seed": 8840904,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": [{
                "__identifier": "NPC_Actor",
                "__grid": [12, 25],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#A22633",
                "iid": "c50bc400-d380-11f0-8099-5b8aa1ac699e",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [192, 400],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Gloria_Camp_Curry",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Gloria_Camp_Curry"]
                    }]
                }],
                "__worldX": 192,
                "__worldY": 400
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [38, 32],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2CE8F5",
                "iid": "cd1df550-d380-11f0-8099-592eae9766b8",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [608, 512],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Rosa_PokeStar_Studios",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Rosa_PokeStar_Studios"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 512
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [22, 24],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#3E8948",
                "iid": "1f303e20-d380-11f0-8099-4964a6b82c6a",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [352, 384],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Irida_Cryo_Stasis_Lab",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Irida_Cryo_Stasis_Lab"]
                    }]
                }],
                "__worldX": 352,
                "__worldY": 384
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [26, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEAE34",
                "iid": "2c969230-d380-11f0-8099-a9e115c9522f",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [416, 496],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Lusamine_Exec_Private_Penthouse",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Lusamine_Exec_Private_Penthouse"]
                    }]
                }],
                "__worldX": 416,
                "__worldY": 496
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [29, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "31208720-d380-11f0-8099-d5f307a4cd54",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [464, 336],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Lillie_Staff_Dormitory_Room_201",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Lillie_Staff_Dormitory_Room_201"]
                    }]
                }],
                "__worldX": 464,
                "__worldY": 336
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [8, 43],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "3f9e8cc0-d380-11f0-8099-695204ad3537",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [128, 688],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Mallow_Lana_Alola_Breeze_Diner_Room",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mallow_Lana_Alola_Breeze_Diner_Room"]
                    }]
                }],
                "__worldX": 128,
                "__worldY": 688
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [7, 38],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#733E39",
                "iid": "48faa330-d380-11f0-8099-6fba99c530fc",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [112, 608],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Selene_Jungle_Treehouse",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Selene_Jungle_Treehouse"]
                    }]
                }],
                "__worldX": 112,
                "__worldY": 608
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [33, 40],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E4A672",
                "iid": "54408840-d380-11f0-8099-3720b8bd491d",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [528, 640],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Serena_Boutique_Serena_Style",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Serena_Boutique_Serena_Style"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 640
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [27, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#3E2731",
                "iid": "5c4f3720-d380-11f0-8099-571d911b9a81",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [432, 336],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Juliana_Int_l_Dorm_Rm_303",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Juliana_Int_l_Dorm_Rm_303"]
                    }]
                }],
                "__worldX": 432,
                "__worldY": 336
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [38, 38],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0099DB",
                "iid": "a2b11940-d380-11f0-8099-afe040fb2e01",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [608, 608],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Iono_Levincia_Guild_Tower",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Iono_Levincia_Guild_Tower"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 608
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [43, 28],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#124E89",
                "iid": "a7bc7330-d380-11f0-8099-a38408fa444a",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [688, 448],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Roxie_Venom_Core_Live_House",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Roxie_Venom_Core_Live_House"]
                    }]
                }],
                "__worldX": 688,
                "__worldY": 448
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [41, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FFFFFF",
                "iid": "b306c510-d380-11f0-8099-3135f2503a9b",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [656, 320],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Marnie_Spikemuth_Relief_Center",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Marnie_Spikemuth_Relief_Center"]
                    }]
                }],
                "__worldX": 656,
                "__worldY": 320
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [33, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#C0CBDC",
                "iid": "b9c1cad0-d380-11f0-8099-5724d335a4b6",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [528, 144],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Hex_Spirit_Tower_Basement",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Hex_Spirit_Tower_Basement"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 144
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [29, 46],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#D77643",
                "iid": "c8502420-d380-11f0-8099-b5c318e13317",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [464, 736],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Dawn_VIP_Beach_Villa_01",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Dawn_VIP_Beach_Villa_01"]
                    }]
                }],
                "__worldX": 464,
                "__worldY": 736
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [40, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "d40d0df0-d380-11f0-8099-ed25362e8c2a",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [640, 352],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Akari_Utility_Shack",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Akari_Utility_Shack"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 352
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [5, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#3A4466",
                "iid": "2ae0d670-d380-11f0-8099-43a9d2afef39",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [80, 576],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Erika_Celadon_Spa",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Erika_Celadon_Spa"]
                    }]
                }],
                "__worldX": 80,
                "__worldY": 576
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [5, 46],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF0044",
                "iid": "2ef99300-d380-11f0-8099-ebf50fabe0ce",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [80, 736],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Nessa_The_Infinity_Poolside_Lounge",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Nessa_The_Infinity_Poolside_Lounge"]
                    }]
                }],
                "__worldX": 80,
                "__worldY": 736
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [20, 25],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B55088",
                "iid": "37781ab0-d380-11f0-8099-73671e0506af",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [320, 400],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Sonia_Rhodia_Central_Lab",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Sonia_Rhodia_Central_Lab"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 400
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [16, 10],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#8B9BB4",
                "iid": "3f16a2a0-d380-11f0-8099-8b3f353f2bad",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [256, 160],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Bea_Iron_Will_Dojo",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bea_Iron_Will_Dojo"]
                    }]
                }],
                "__worldX": 256,
                "__worldY": 160
            }, {
                "__identifier": "NPC_Actor",
                "__grid": [18, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#5A6988",
                "iid": "44c01150-d380-11f0-8099-3fb60f790bbc",
                "width": 16,
                "height": 16,
                "defUid": 76,
                "px": [288, 208],
                "fieldInstances": [{
                    "__identifier": "NPC_Actor",
                    "__type": "LocalEnum.NPC_Actor",
                    "__value": "Cynthia_Champion_s_Outlook_Suite",
                    "__tile": null,
                    "defUid": 78,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cynthia_Champion_s_Outlook_Suite"]
                    }]
                }],
                "__worldX": 288,
                "__worldY": 208
            }, {
                "__identifier": "PlayerStart",
                "__grid": [26, 28],
                "__pivot": [0.5, 0.5],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0000FF",
                "iid": "c8ee2060-d380-11f0-aa69-7309752589f3",
                "width": 16,
                "height": 16,
                "defUid": 8,
                "px": [424, 456],
                "fieldInstances": [],
                "__worldX": 424,
                "__worldY": 456
            }]
        }, {
            "__identifier": "Service",
            "__type": "Entities",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 1,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "ab42aa30-d380-11f0-86dc-c5028b291c09",
            "levelId": 0,
            "layerDefUid": 59,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [],
            "autoLayerTiles": [],
            "seed": 406179,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": [{
                "__identifier": "Pokemon_Centers",
                "__grid": [11, 44],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "57e2b640-d380-11f0-86dc-471f739ddc67",
                "width": 16,
                "height": 16,
                "defUid": 60,
                "px": [176, 704],
                "fieldInstances": [{
                    "__identifier": "Pokemon_Centers",
                    "__type": "LocalEnum.Pokemon_Centers",
                    "__value": "CP_Bloom_Port",
                    "__tile": null,
                    "defUid": 62,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["CP_Bloom_Port"]
                    }]
                }],
                "__worldX": 176,
                "__worldY": 704
            }, {
                "__identifier": "Pokemon_Centers",
                "__grid": [36, 42],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2CE8F5",
                "iid": "6da34120-d380-11f0-86dc-95fb72994a45",
                "width": 16,
                "height": 16,
                "defUid": 60,
                "px": [576, 672],
                "fieldInstances": [{
                    "__identifier": "Pokemon_Centers",
                    "__type": "LocalEnum.Pokemon_Centers",
                    "__value": "CP_Neon_Central",
                    "__tile": null,
                    "defUid": 62,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["CP_Neon_Central"]
                    }]
                }],
                "__worldX": 576,
                "__worldY": 672
            }, {
                "__identifier": "Pokemon_Centers",
                "__grid": [40, 15],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#68386C",
                "iid": "75428c60-d380-11f0-86dc-bf03067a9dcf",
                "width": 16,
                "height": 16,
                "defUid": 60,
                "px": [640, 240],
                "fieldInstances": [{
                    "__identifier": "Pokemon_Centers",
                    "__type": "LocalEnum.Pokemon_Centers",
                    "__value": "CP_Shadow_Slum",
                    "__tile": null,
                    "defUid": 62,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["CP_Shadow_Slum"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 240
            }, {
                "__identifier": "Pokemon_Centers",
                "__grid": [26, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "809a4bc0-d380-11f0-86dc-abf16da6df1f",
                "width": 16,
                "height": 16,
                "defUid": 60,
                "px": [416, 432],
                "fieldInstances": [{
                    "__identifier": "Pokemon_Centers",
                    "__type": "LocalEnum.Pokemon_Centers",
                    "__value": "CP_Zenith_Main",
                    "__tile": null,
                    "defUid": 62,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["CP_Zenith_Main"]
                    }]
                }],
                "__worldX": 416,
                "__worldY": 432
            }, {
                "__identifier": "Pokemon_Centers",
                "__grid": [15, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E43B44",
                "iid": "860a33e0-d380-11f0-86dc-4bd787a7706b",
                "width": 16,
                "height": 16,
                "defUid": 60,
                "px": [240, 208],
                "fieldInstances": [{
                    "__identifier": "Pokemon_Centers",
                    "__type": "LocalEnum.Pokemon_Centers",
                    "__value": "CP_Apex_Base",
                    "__tile": null,
                    "defUid": 62,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["CP_Apex_Base"]
                    }]
                }],
                "__worldX": 240,
                "__worldY": 208
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [21, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "01033880-d380-11f0-86dc-3f293b4b2139",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [336, 592],
                "fieldInstances": [],
                "__worldX": 336,
                "__worldY": 592
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [6, 40],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "05b7bfe0-d380-11f0-86dc-e12a4054d9a1",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [96, 640],
                "fieldInstances": [],
                "__worldX": 96,
                "__worldY": 640
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [5, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "0f677490-d380-11f0-86dc-d534bce97f25",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [80, 432],
                "fieldInstances": [],
                "__worldX": 80,
                "__worldY": 432
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [22, 10],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "12e94850-d380-11f0-86dc-9363aef0cbd8",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [352, 160],
                "fieldInstances": [],
                "__worldX": 352,
                "__worldY": 160
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [14, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "152a85c0-d380-11f0-86dc-4b59cf44fd19",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [224, 320],
                "fieldInstances": [],
                "__worldX": 224,
                "__worldY": 320
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [16, 29],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "1a6728e0-d380-11f0-86dc-49ca5f41c573",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [256, 464],
                "fieldInstances": [],
                "__worldX": 256,
                "__worldY": 464
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [21, 46],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "1ee277d0-d380-11f0-86dc-196ee8879e75",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [336, 736],
                "fieldInstances": [],
                "__worldX": 336,
                "__worldY": 736
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [29, 42],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "20f5ee80-d380-11f0-86dc-41dd75bdddea",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [464, 672],
                "fieldInstances": [],
                "__worldX": 464,
                "__worldY": 672
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [34, 35],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "23837730-d380-11f0-86dc-ede7796fdefb",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [544, 560],
                "fieldInstances": [],
                "__worldX": 544,
                "__worldY": 560
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [45, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "24dfabd0-d380-11f0-86dc-9989b8694e7e",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [720, 496],
                "fieldInstances": [],
                "__worldX": 720,
                "__worldY": 496
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [38, 29],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "264b49c0-d380-11f0-86dc-4b67ed045cab",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [608, 464],
                "fieldInstances": [],
                "__worldX": 608,
                "__worldY": 464
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [41, 38],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "274c3f00-d380-11f0-86dc-41c6a88c93a0",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [656, 608],
                "fieldInstances": [],
                "__worldX": 656,
                "__worldY": 608
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [42, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "2edb5da0-d380-11f0-86dc-1b29d4113dd6",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [672, 352],
                "fieldInstances": [],
                "__worldX": 672,
                "__worldY": 352
            }, {
                "__identifier": "PC_Terminal",
                "__grid": [38, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#72CCE4",
                "iid": "30ac7420-d380-11f0-86dc-db897df1b632",
                "width": 16,
                "height": 16,
                "defUid": 64,
                "px": [608, 144],
                "fieldInstances": [],
                "__worldX": 608,
                "__worldY": 144
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [12, 44],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "df816190-d380-11f0-86dc-d5817b15a758",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [192, 704],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 192,
                "__worldY": 704
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [36, 43],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "e710ce50-d380-11f0-86dc-f31a65e78e0f",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [576, 688],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 576,
                "__worldY": 688
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [39, 15],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "eb6f6d80-d380-11f0-86dc-e1e90580cef5",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [624, 240],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 240
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [16, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "06e61140-d380-11f0-86dc-6539660e58e1",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [256, 208],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 256,
                "__worldY": 208
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [27, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "0b18be70-d380-11f0-86dc-e7756a513236",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [432, 432],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 432,
                "__worldY": 432
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [22, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "119868e0-d380-11f0-86dc-73b3f9a7dd7e",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [352, 336],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Shop_Special_Z",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Special_Z"]
                    }]
                }],
                "__worldX": 352,
                "__worldY": 336
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [22, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "17b3d340-d380-11f0-86dc-3fe04d573de3",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [352, 592],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 352,
                "__worldY": 592
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [28, 42],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "1a8ff120-d380-11f0-86dc-c792d5acd982",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [448, 672],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 448,
                "__worldY": 672
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [38, 28],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "1e3a8290-d380-11f0-86dc-89a9c905980b",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [608, 448],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 448
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [46, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "20d4b570-d380-11f0-86dc-2538b13c1611",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [736, 496],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 736,
                "__worldY": 496
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [39, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2CE8F5",
                "iid": "286e3450-d380-11f0-86dc-8dcc0a68a065",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [624, 576],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Shop_Special_N",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Special_N"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 576
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [8, 38],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "2faa29e0-d380-11f0-86dc-495db7c9e9de",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [128, 608],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Shop_Special_B",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Special_B"]
                    }]
                }],
                "__worldX": 128,
                "__worldY": 608
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [39, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B55088",
                "iid": "3944cff0-d380-11f0-86dc-03b290a26640",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [624, 320],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Shop_Special_S",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Special_S"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 320
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [16, 8],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#BE4A2F",
                "iid": "420087b0-d380-11f0-86dc-65e4eb1c86ef",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [256, 128],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Shop_Special_A",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Shop_Special_A"]
                    }]
                }],
                "__worldX": 256,
                "__worldY": 128
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [15, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "4a166280-d380-11f0-86dc-0b0c1f48a166",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [240, 320],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 240,
                "__worldY": 320
            }, {
                "__identifier": "Shop_Kiosk",
                "__grid": [37, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "4d115300-d380-11f0-86dc-974dd770b206",
                "width": 16,
                "height": 16,
                "defUid": 65,
                "px": [592, 144],
                "fieldInstances": [{
                    "__identifier": "Shop_Kiosk",
                    "__type": "LocalEnum.Shop_Kiosk",
                    "__value": "Wares_General",
                    "__tile": null,
                    "defUid": 68,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Wares_General"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 144
            }, {
                "__identifier": "Bed_Rest",
                "__grid": [30, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0099DB",
                "iid": "cc67be50-d380-11f0-86dc-7ba058f7a530",
                "width": 16,
                "height": 16,
                "defUid": 69,
                "px": [480, 352],
                "fieldInstances": [{
                    "__identifier": "Bed_Rest",
                    "__type": "LocalEnum.Bed_Rest",
                    "__value": "Player_s_Room",
                    "__tile": null,
                    "defUid": 71,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Player_s_Room"]
                    }]
                }],
                "__worldX": 480,
                "__worldY": 352
            }, {
                "__identifier": "Bed_Rest",
                "__grid": [9, 44],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "d8a9b6a0-d380-11f0-86dc-b5f2f74039ad",
                "width": 16,
                "height": 16,
                "defUid": 69,
                "px": [144, 704],
                "fieldInstances": [{
                    "__identifier": "Bed_Rest",
                    "__type": "LocalEnum.Bed_Rest",
                    "__value": "Bed_Rest",
                    "__tile": null,
                    "defUid": 71,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bed_Rest"]
                    }]
                }],
                "__worldX": 144,
                "__worldY": 704
            }, {
                "__identifier": "Bed_Rest",
                "__grid": [13, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "dc1c4820-d380-11f0-86dc-71d80ba7948b",
                "width": 16,
                "height": 16,
                "defUid": 69,
                "px": [208, 320],
                "fieldInstances": [{
                    "__identifier": "Bed_Rest",
                    "__type": "LocalEnum.Bed_Rest",
                    "__value": "Bed_Rest",
                    "__tile": null,
                    "defUid": 71,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bed_Rest"]
                    }]
                }],
                "__worldX": 208,
                "__worldY": 320
            }, {
                "__identifier": "Bed_Rest",
                "__grid": [17, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "de0ea240-d380-11f0-86dc-cf2cc2a4ce6f",
                "width": 16,
                "height": 16,
                "defUid": 69,
                "px": [272, 208],
                "fieldInstances": [{
                    "__identifier": "Bed_Rest",
                    "__type": "LocalEnum.Bed_Rest",
                    "__value": "Bed_Rest",
                    "__tile": null,
                    "defUid": 71,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bed_Rest"]
                    }]
                }],
                "__worldX": 272,
                "__worldY": 208
            }, {
                "__identifier": "Bed_Rest",
                "__grid": [36, 41],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "e0c759a0-d380-11f0-86dc-0df696b719a8",
                "width": 16,
                "height": 16,
                "defUid": 69,
                "px": [576, 656],
                "fieldInstances": [{
                    "__identifier": "Bed_Rest",
                    "__type": "LocalEnum.Bed_Rest",
                    "__value": "Bed_Rest",
                    "__tile": null,
                    "defUid": 71,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bed_Rest"]
                    }]
                }],
                "__worldX": 576,
                "__worldY": 656
            }, {
                "__identifier": "Bed_Rest",
                "__grid": [38, 15],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "e3bad010-d380-11f0-86dc-23ff6834a776",
                "width": 16,
                "height": 16,
                "defUid": 69,
                "px": [608, 240],
                "fieldInstances": [{
                    "__identifier": "Bed_Rest",
                    "__type": "LocalEnum.Bed_Rest",
                    "__value": "Bed_Rest",
                    "__tile": null,
                    "defUid": 71,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bed_Rest"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 240
            }, {
                "__identifier": "Bed_Rest",
                "__grid": [28, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "ef0b6380-d380-11f0-86dc-49a7d7d6d95b",
                "width": 16,
                "height": 16,
                "defUid": 69,
                "px": [448, 432],
                "fieldInstances": [{
                    "__identifier": "Bed_Rest",
                    "__type": "LocalEnum.Bed_Rest",
                    "__value": "Bed_Rest",
                    "__tile": null,
                    "defUid": 71,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bed_Rest"]
                    }]
                }],
                "__worldX": 448,
                "__worldY": 432
            }, {
                "__identifier": "Bed_Rest",
                "__grid": [23, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "f4170b90-d380-11f0-86dc-41a6befac4c2",
                "width": 16,
                "height": 16,
                "defUid": 69,
                "px": [368, 592],
                "fieldInstances": [{
                    "__identifier": "Bed_Rest",
                    "__type": "LocalEnum.Bed_Rest",
                    "__value": "Bed_Rest",
                    "__tile": null,
                    "defUid": 71,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bed_Rest"]
                    }]
                }],
                "__worldX": 368,
                "__worldY": 592
            }, {
                "__identifier": "Bed_Rest",
                "__grid": [45, 33],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "fc1df240-d380-11f0-86dc-69259ef6f8b8",
                "width": 16,
                "height": 16,
                "defUid": 69,
                "px": [720, 528],
                "fieldInstances": [{
                    "__identifier": "Bed_Rest",
                    "__type": "LocalEnum.Bed_Rest",
                    "__value": "Bed_Rest",
                    "__tile": null,
                    "defUid": 71,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bed_Rest"]
                    }]
                }],
                "__worldX": 720,
                "__worldY": 528
            }, {
                "__identifier": "Bed_Rest",
                "__grid": [35, 32],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "fe833270-d380-11f0-86dc-35d2ef2d3dc4",
                "width": 16,
                "height": 16,
                "defUid": 69,
                "px": [560, 512],
                "fieldInstances": [{
                    "__identifier": "Bed_Rest",
                    "__type": "LocalEnum.Bed_Rest",
                    "__value": "Bed_Rest",
                    "__tile": null,
                    "defUid": 71,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Bed_Rest"]
                    }]
                }],
                "__worldX": 560,
                "__worldY": 512
            }, {
                "__identifier": "Police_Box",
                "__grid": [10, 44],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63C74D",
                "iid": "d5a628b0-d380-11f0-8099-67e4d9107f21",
                "width": 16,
                "height": 16,
                "defUid": 72,
                "px": [160, 704],
                "fieldInstances": [{
                    "__identifier": "Service_Type",
                    "__type": "LocalEnum.Police_Box",
                    "__value": "Police_Box_B",
                    "__tile": null,
                    "defUid": 74,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Police_Box_B"]
                    }]
                }],
                "__worldX": 160,
                "__worldY": 704
            }, {
                "__identifier": "Police_Box",
                "__grid": [33, 38],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2CE8F5",
                "iid": "ee8f6ad0-d380-11f0-8099-ed61533027fe",
                "width": 16,
                "height": 16,
                "defUid": 72,
                "px": [528, 608],
                "fieldInstances": [{
                    "__identifier": "Service_Type",
                    "__type": "LocalEnum.Police_Box",
                    "__value": "Police_Box_N",
                    "__tile": null,
                    "defUid": 74,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Police_Box_N"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 608
            }, {
                "__identifier": "Police_Box",
                "__grid": [41, 15],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#68386C",
                "iid": "03bd79b0-d380-11f0-8099-5b1eae39b36f",
                "width": 16,
                "height": 16,
                "defUid": 72,
                "px": [656, 240],
                "fieldInstances": [{
                    "__identifier": "Service_Type",
                    "__type": "LocalEnum.Police_Box",
                    "__value": "Police_Box_S",
                    "__tile": null,
                    "defUid": 74,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Police_Box_S"]
                    }]
                }],
                "__worldX": 656,
                "__worldY": 240
            }, {
                "__identifier": "Police_Box",
                "__grid": [19, 11],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF0044",
                "iid": "0d034900-d380-11f0-8099-a37439fa8a51",
                "width": 16,
                "height": 16,
                "defUid": 72,
                "px": [304, 176],
                "fieldInstances": [{
                    "__identifier": "Service_Type",
                    "__type": "LocalEnum.Police_Box",
                    "__value": "Police_Box_A",
                    "__tile": null,
                    "defUid": 74,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Police_Box_A"]
                    }]
                }],
                "__worldX": 304,
                "__worldY": 176
            }, {
                "__identifier": "Police_Box",
                "__grid": [25, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FEE761",
                "iid": "14808d50-d380-11f0-8099-13601302c00b",
                "width": 16,
                "height": 16,
                "defUid": 72,
                "px": [400, 432],
                "fieldInstances": [{
                    "__identifier": "Service_Type",
                    "__type": "LocalEnum.Police_Box",
                    "__value": "Police_Box_Z",
                    "__tile": null,
                    "defUid": 74,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Police_Box_Z"]
                    }]
                }],
                "__worldX": 400,
                "__worldY": 432
            }]
        }, {
            "__identifier": "Biome_Zone",
            "__type": "Entities",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 1,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "6cdee4e0-d380-11f0-aa69-db2e56a2a75b",
            "levelId": 0,
            "layerDefUid": 52,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [],
            "autoLayerTiles": [],
            "seed": 4969718,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": [{
                "__identifier": "Biome",
                "__grid": [4, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FFD32A",
                "iid": "8127c3e0-d380-11f0-aa69-dd366185e896",
                "width": 48,
                "height": 192,
                "defUid": 49,
                "px": [64, 576],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Sapphire_Strand",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Sapphire_Strand"]
                    }]
                }],
                "__worldX": 64,
                "__worldY": 576
            }, {
                "__identifier": "Biome",
                "__grid": [7, 44],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FFD32A",
                "iid": "8558c360-d380-11f0-aa69-7b17dd79bf48",
                "width": 112,
                "height": 64,
                "defUid": 49,
                "px": [112, 704],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Sapphire_Strand",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Sapphire_Strand"]
                    }]
                }],
                "__worldX": 112,
                "__worldY": 704
            }, {
                "__identifier": "Biome",
                "__grid": [15, 40],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#74B9FF",
                "iid": "8a91bd00-d380-11f0-aa69-8b848ec6db23",
                "width": 32,
                "height": 128,
                "defUid": 49,
                "px": [240, 640],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Silt_Delta",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Silt_Delta"]
                    }]
                }],
                "__worldX": 240,
                "__worldY": 640
            }, {
                "__identifier": "Biome",
                "__grid": [11, 32],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#006266",
                "iid": "91b6a820-d380-11f0-aa69-439d2022609c",
                "width": 80,
                "height": 64,
                "defUid": 49,
                "px": [176, 512],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Deep_Root_Hollow",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Deep_Root_Hollow"]
                    }]
                }],
                "__worldX": 176,
                "__worldY": 512
            }, {
                "__identifier": "Biome",
                "__grid": [6, 26],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2ECC71",
                "iid": "9952bf10-d380-11f0-aa69-8dfab69dc18c",
                "width": 192,
                "height": 96,
                "defUid": 49,
                "px": [96, 416],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Jade_Canopy",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Jade_Canopy"]
                    }]
                }],
                "__worldX": 96,
                "__worldY": 416
            }, {
                "__identifier": "Biome",
                "__grid": [6, 32],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2ECC71",
                "iid": "9d3a5980-d380-11f0-aa69-f36192c48b2e",
                "width": 80,
                "height": 80,
                "defUid": 49,
                "px": [96, 512],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Jade_Canopy",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Jade_Canopy"]
                    }]
                }],
                "__worldX": 96,
                "__worldY": 512
            }, {
                "__identifier": "Biome",
                "__grid": [7, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF9FF3",
                "iid": "a3d26df0-d380-11f0-aa69-a391aa64997d",
                "width": 112,
                "height": 112,
                "defUid": 49,
                "px": [112, 592],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Aroma_Meadow",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Aroma_Meadow"]
                    }]
                }],
                "__worldX": 112,
                "__worldY": 592
            }, {
                "__identifier": "Biome",
                "__grid": [4, 23],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#D1CCC0",
                "iid": "53419f90-d380-11f0-aa69-05eaebf8fc5c",
                "width": 32,
                "height": 208,
                "defUid": 49,
                "px": [64, 368],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Hermit_Sands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Hermit_Sands"]
                    }]
                }],
                "__worldX": 64,
                "__worldY": 368
            }, {
                "__identifier": "Biome",
                "__grid": [2, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "58fe4820-d380-11f0-aa69-b95b0f1d5943",
                "width": 32,
                "height": 288,
                "defUid": 49,
                "px": [32, 352],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cerulean_Reef",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cerulean_Reef"]
                    }]
                }],
                "__worldX": 32,
                "__worldY": 352
            }, {
                "__identifier": "Biome",
                "__grid": [2, 40],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#45AAF2",
                "iid": "644c6a90-d380-11f0-aa69-ada9cba2938a",
                "width": 32,
                "height": 160,
                "defUid": 49,
                "px": [32, 640],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Crystal_Lagoon",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Crystal_Lagoon"]
                    }]
                }],
                "__worldX": 32,
                "__worldY": 640
            }, {
                "__identifier": "Biome",
                "__grid": [4, 48],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#45AAF2",
                "iid": "6a11c5b0-d380-11f0-aa69-63724e4c7530",
                "width": 368,
                "height": 32,
                "defUid": 49,
                "px": [64, 768],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Crystal_Lagoon",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Crystal_Lagoon"]
                    }]
                }],
                "__worldX": 64,
                "__worldY": 768
            }, {
                "__identifier": "Biome",
                "__grid": [17, 45],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#F7B731",
                "iid": "87ec2300-d380-11f0-aa69-215f1e00996b",
                "width": 144,
                "height": 48,
                "defUid": 49,
                "px": [272, 720],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Golden_Horizon",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Golden_Horizon"]
                    }]
                }],
                "__worldX": 272,
                "__worldY": 720
            }, {
                "__identifier": "Biome",
                "__grid": [17, 39],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#7BED9F",
                "iid": "8be067a0-d380-11f0-aa69-67de43edc82d",
                "width": 144,
                "height": 96,
                "defUid": 49,
                "px": [272, 624],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Breeze_Woodlands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Breeze_Woodlands"]
                    }]
                }],
                "__worldX": 272,
                "__worldY": 624
            }, {
                "__identifier": "Biome",
                "__grid": [20, 34],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#7BED9F",
                "iid": "915e5980-d380-11f0-aa69-e743b6db3d1e",
                "width": 128,
                "height": 48,
                "defUid": 49,
                "px": [320, 544],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Breeze_Woodlands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Breeze_Woodlands"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 544
            }, {
                "__identifier": "Biome",
                "__grid": [26, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DAE55C",
                "iid": "fc4e24a0-d380-11f0-aa69-6fa5400d7406",
                "width": 352,
                "height": 144,
                "defUid": 49,
                "px": [416, 592],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Radiant_Plains",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Radiant_Plains"]
                    }]
                }],
                "__worldX": 416,
                "__worldY": 592
            }, {
                "__identifier": "Biome",
                "__grid": [26, 46],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#F7B731",
                "iid": "0e027610-d380-11f0-aa69-b97bab8844f9",
                "width": 352,
                "height": 32,
                "defUid": 49,
                "px": [416, 736],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Golden_Horizon",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Golden_Horizon"]
                    }]
                }],
                "__worldX": 416,
                "__worldY": 736
            }, {
                "__identifier": "Biome",
                "__grid": [34, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DAE55C",
                "iid": "16f431f0-d380-11f0-aa69-c5902d273eb8",
                "width": 224,
                "height": 160,
                "defUid": 49,
                "px": [544, 432],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Radiant_Plains",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Radiant_Plains"]
                    }]
                }],
                "__worldX": 544,
                "__worldY": 432
            }, {
                "__identifier": "Biome",
                "__grid": [28, 34],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DAE55C",
                "iid": "92be9050-d380-11f0-aa69-ad7644a964ff",
                "width": 96,
                "height": 48,
                "defUid": 49,
                "px": [448, 544],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Radiant_Plains",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Radiant_Plains"]
                    }]
                }],
                "__worldX": 448,
                "__worldY": 544
            }, {
                "__identifier": "Biome",
                "__grid": [31, 32],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DAE55C",
                "iid": "9ab60db0-d380-11f0-aa69-7bb87fc4b777",
                "width": 48,
                "height": 32,
                "defUid": 49,
                "px": [496, 512],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Radiant_Plains",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Radiant_Plains"]
                    }]
                }],
                "__worldX": 496,
                "__worldY": 512
            }, {
                "__identifier": "Biome",
                "__grid": [27, 48],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#18DCFF",
                "iid": "2e0cc0d0-d380-11f0-aa69-19778bada06e",
                "width": 368,
                "height": 32,
                "defUid": 49,
                "px": [432, 768],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Prism_Bay",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Prism_Bay"]
                    }]
                }],
                "__worldX": 432,
                "__worldY": 768
            }, {
                "__identifier": "Biome",
                "__grid": [48, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#4B6584",
                "iid": "33bd8280-d380-11f0-aa69-39644cbfbef6",
                "width": 32,
                "height": 272,
                "defUid": 49,
                "px": [768, 352],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Ferro_Straits",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Ferro_Straits"]
                    }]
                }],
                "__worldX": 768,
                "__worldY": 352
            }, {
                "__identifier": "Biome",
                "__grid": [48, 39],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#18DCFF",
                "iid": "39edfb80-d380-11f0-aa69-c181c6c3eb4e",
                "width": 32,
                "height": 144,
                "defUid": 49,
                "px": [768, 624],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Prism_Bay",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Prism_Bay"]
                    }]
                }],
                "__worldX": 768,
                "__worldY": 624
            }, {
                "__identifier": "Biome",
                "__grid": [21, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "bcbf0ea0-d380-11f0-aa69-bd8481fe8dff",
                "width": 160,
                "height": 160,
                "defUid": 49,
                "px": [336, 336],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 336,
                "__worldY": 336
            }, {
                "__identifier": "Biome",
                "__grid": [23, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "bfac6a90-d380-11f0-aa69-7d914129e534",
                "width": 96,
                "height": 32,
                "defUid": 49,
                "px": [368, 496],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 368,
                "__worldY": 496
            }, {
                "__identifier": "Biome",
                "__grid": [19, 23],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "c75f64e0-d380-11f0-aa69-1d766cfcf626",
                "width": 32,
                "height": 96,
                "defUid": 49,
                "px": [304, 368],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 304,
                "__worldY": 368
            }, {
                "__identifier": "Biome",
                "__grid": [23, 19],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "ca0b9920-d380-11f0-aa69-d323c6d34d9e",
                "width": 96,
                "height": 32,
                "defUid": 49,
                "px": [368, 304],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 368,
                "__worldY": 304
            }, {
                "__identifier": "Biome",
                "__grid": [31, 23],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "cd715960-d380-11f0-aa69-eb4e948a30d4",
                "width": 32,
                "height": 96,
                "defUid": 49,
                "px": [496, 368],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 496,
                "__worldY": 368
            }, {
                "__identifier": "Biome",
                "__grid": [48, 4],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#CED6E0",
                "iid": "84063970-d380-11f0-aa69-c3274f2ca6a4",
                "width": 32,
                "height": 288,
                "defUid": 49,
                "px": [768, 64],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mist_Veil_Sound",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mist_Veil_Sound"]
                    }]
                }],
                "__worldX": 768,
                "__worldY": 64
            }, {
                "__identifier": "Biome",
                "__grid": [2, 2],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#63CBF6",
                "iid": "8a21a3d0-d380-11f0-aa69-a7e9b3ca4489",
                "width": 768,
                "height": 32,
                "defUid": 49,
                "px": [32, 32],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Frigid_Floe",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Frigid_Floe"]
                    }]
                }],
                "__worldX": 32,
                "__worldY": 32
            }, {
                "__identifier": "Biome",
                "__grid": [34, 17],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "97da5da0-d380-11f0-aa69-273fe7cd03bd",
                "width": 224,
                "height": 64,
                "defUid": 49,
                "px": [544, 272],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 544,
                "__worldY": 272
            }, {
                "__identifier": "Biome",
                "__grid": [37, 14],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "9dd4d280-d380-11f0-aa69-59587bd4b47f",
                "width": 176,
                "height": 48,
                "defUid": 49,
                "px": [592, 224],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 224
            }, {
                "__identifier": "Biome",
                "__grid": [26, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2C3A47",
                "iid": "a58f6df0-d380-11f0-aa69-f144ef264702",
                "width": 112,
                "height": 128,
                "defUid": 49,
                "px": [416, 144],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Twilight_Copse",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Twilight_Copse"]
                    }]
                }],
                "__worldX": 416,
                "__worldY": 144
            }, {
                "__identifier": "Biome",
                "__grid": [24, 4],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#F8F9FA",
                "iid": "b0a08760-d380-11f0-aa69-b737f0ae7b70",
                "width": 240,
                "height": 80,
                "defUid": 49,
                "px": [384, 64],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Silent_Tundra",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Silent_Tundra"]
                    }]
                }],
                "__worldX": 384,
                "__worldY": 64
            }, {
                "__identifier": "Biome",
                "__grid": [41, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "ccff4130-d380-11f0-aa69-956564f97df6",
                "width": 112,
                "height": 80,
                "defUid": 49,
                "px": [656, 144],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 656,
                "__worldY": 144
            }, {
                "__identifier": "Biome",
                "__grid": [19, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2ECC71",
                "iid": "8b448380-d380-11f0-aa69-c3099f1e4c51",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [304, 496],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Jade_Canopy",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Jade_Canopy"]
                    }]
                }],
                "__worldX": 304,
                "__worldY": 496
            }, {
                "__identifier": "Biome",
                "__grid": [6, 23],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E1B12C",
                "iid": "57c87880-d380-11f0-aa69-396a5a315ca9",
                "width": 192,
                "height": 48,
                "defUid": 49,
                "px": [96, 368],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Savanna_Outlands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Savanna_Outlands"]
                    }]
                }],
                "__worldX": 96,
                "__worldY": 368
            }, {
                "__identifier": "Biome",
                "__grid": [2, 4],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2C3A47",
                "iid": "6580e430-d380-11f0-aa69-8d79c011b779",
                "width": 32,
                "height": 288,
                "defUid": 49,
                "px": [32, 64],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Basalt_Shoals",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Basalt_Shoals"]
                    }]
                }],
                "__worldX": 32,
                "__worldY": 64
            }, {
                "__identifier": "Biome",
                "__grid": [4, 6],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2D3436",
                "iid": "6df46f60-d380-11f0-aa69-c153e1c78c72",
                "width": 32,
                "height": 192,
                "defUid": 49,
                "px": [64, 96],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Obsidian_Beach",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Obsidian_Beach"]
                    }]
                }],
                "__worldX": 64,
                "__worldY": 96
            }, {
                "__identifier": "Biome",
                "__grid": [6, 10],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FBC531",
                "iid": "7c5269e0-d380-11f0-aa69-c5c941cf6bb1",
                "width": 32,
                "height": 128,
                "defUid": 49,
                "px": [96, 160],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Scorched_Dunes",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Scorched_Dunes"]
                    }]
                }],
                "__worldX": 96,
                "__worldY": 160
            }, {
                "__identifier": "Biome",
                "__grid": [4, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FBC531",
                "iid": "80b3ef40-d380-11f0-aa69-cf35fb70bfbc",
                "width": 224,
                "height": 80,
                "defUid": 49,
                "px": [64, 288],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Scorched_Dunes",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Scorched_Dunes"]
                    }]
                }],
                "__worldX": 64,
                "__worldY": 288
            }, {
                "__identifier": "Biome",
                "__grid": [8, 16],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FBC531",
                "iid": "86467a90-d380-11f0-aa69-91cf7162d202",
                "width": 112,
                "height": 32,
                "defUid": 49,
                "px": [128, 256],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Scorched_Dunes",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Scorched_Dunes"]
                    }]
                }],
                "__worldX": 128,
                "__worldY": 256
            }, {
                "__identifier": "Biome",
                "__grid": [16, 6],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E84118",
                "iid": "927eaee0-d380-11f0-aa69-b51ef6237a1e",
                "width": 128,
                "height": 192,
                "defUid": 49,
                "px": [256, 96],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Crimson_Badlands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Crimson_Badlands"]
                    }]
                }],
                "__worldX": 256,
                "__worldY": 96
            }, {
                "__identifier": "Biome",
                "__grid": [24, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E84118",
                "iid": "9d94aa50-d380-11f0-aa69-dfbf8e087272",
                "width": 32,
                "height": 144,
                "defUid": 49,
                "px": [384, 144],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Crimson_Badlands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Crimson_Badlands"]
                    }]
                }],
                "__worldX": 384,
                "__worldY": 144
            }, {
                "__identifier": "Biome",
                "__grid": [19, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E84118",
                "iid": "a0521ca0-d380-11f0-aa69-2d10fbe2693b",
                "width": 16,
                "height": 48,
                "defUid": 49,
                "px": [304, 288],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Crimson_Badlands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Crimson_Badlands"]
                    }]
                }],
                "__worldX": 304,
                "__worldY": 288
            }, {
                "__identifier": "Biome",
                "__grid": [4, 4],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#D1D8E0",
                "iid": "a63e60b0-d380-11f0-aa69-d71eb0e22205",
                "width": 320,
                "height": 32,
                "defUid": 49,
                "px": [64, 64],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Frostbite_Slope",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Frostbite_Slope"]
                    }]
                }],
                "__worldX": 64,
                "__worldY": 64
            }, {
                "__identifier": "Biome",
                "__grid": [8, 7],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#C23616",
                "iid": "ab7d26b0-d380-11f0-aa69-9b068a866716",
                "width": 128,
                "height": 144,
                "defUid": 49,
                "px": [128, 112],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Inferno_Crater",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Inferno_Crater"]
                    }]
                }],
                "__worldX": 128,
                "__worldY": 112
            }, {
                "__identifier": "Biome",
                "__grid": [15, 16],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FBC531",
                "iid": "b50c3400-d380-11f0-aa69-5d3d36036020",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [240, 256],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Scorched_Dunes",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Scorched_Dunes"]
                    }]
                }],
                "__worldX": 240,
                "__worldY": 256
            }, {
                "__identifier": "Biome",
                "__grid": [6, 6],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#C23616",
                "iid": "d84a6b80-d380-11f0-aa69-b505181da216",
                "width": 160,
                "height": 16,
                "defUid": 49,
                "px": [96, 96],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Inferno_Crater",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Inferno_Crater"]
                    }]
                }],
                "__worldX": 96,
                "__worldY": 96
            }, {
                "__identifier": "Biome",
                "__grid": [6, 7],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#C23616",
                "iid": "dbceb040-d380-11f0-aa69-479cc7f6eb6f",
                "width": 32,
                "height": 48,
                "defUid": 49,
                "px": [96, 112],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Inferno_Crater",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Inferno_Crater"]
                    }]
                }],
                "__worldX": 96,
                "__worldY": 112
            }, {
                "__identifier": "Biome",
                "__grid": [0, 2],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2F3640",
                "iid": "3ae9eae0-d380-11f0-aa69-eb7fd9b9189d",
                "width": 32,
                "height": 768,
                "defUid": 49,
                "px": [0, 32],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Titan_Trough",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Titan_Trough"]
                    }]
                }],
                "__worldX": 0,
                "__worldY": 32
            }, {
                "__identifier": "Biome",
                "__grid": [0, 50],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#192A56",
                "iid": "4184e580-d380-11f0-aa69-5f423dd3b2dc",
                "width": 832,
                "height": 32,
                "defUid": 49,
                "px": [0, 800],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Equatorial_Dark_Zone",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Equatorial_Dark_Zone"]
                    }]
                }],
                "__worldX": 0,
                "__worldY": 800
            }, {
                "__identifier": "Biome",
                "__grid": [50, 2],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#4834D4",
                "iid": "4df36c10-d380-11f0-aa69-057f3f13b43d",
                "width": 32,
                "height": 768,
                "defUid": 49,
                "px": [800, 32],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Chrome_Abyss",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Chrome_Abyss"]
                    }]
                }],
                "__worldX": 800,
                "__worldY": 32
            }, {
                "__identifier": "Biome",
                "__grid": [0, 0],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0652DD",
                "iid": "51d90ab0-d380-11f0-aa69-81c44f31c6c3",
                "width": 832,
                "height": 32,
                "defUid": 49,
                "px": [0, 0],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Boreal_Trench",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Boreal_Trench"]
                    }]
                }],
                "__worldX": 0,
                "__worldY": 0
            }, {
                "__identifier": "Biome",
                "__grid": [20, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E84118",
                "iid": "822738e0-d380-11f0-86dc-85770bf686b5",
                "width": 32,
                "height": 16,
                "defUid": 49,
                "px": [320, 288],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Crimson_Badlands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Crimson_Badlands"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 288
            }, {
                "__identifier": "Biome",
                "__grid": [33, 30],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DAE55C",
                "iid": "8d162450-d380-11f0-86dc-2fb0929d0c12",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [528, 480],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Radiant_Plains",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Radiant_Plains"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 480
            }, {
                "__identifier": "Biome",
                "__grid": [16, 39],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#74B9FF",
                "iid": "cc7bb420-d380-11f0-8099-cbd81347dbc6",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [256, 624],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Silt_Delta",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Silt_Delta"]
                    }]
                }],
                "__worldX": 256,
                "__worldY": 624
            }, {
                "__identifier": "Biome",
                "__grid": [11, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#006266",
                "iid": "e3f560b0-d380-11f0-8099-771e20f1e1e4",
                "width": 64,
                "height": 16,
                "defUid": 49,
                "px": [176, 576],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Deep_Root_Hollow",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Deep_Root_Hollow"]
                    }]
                }],
                "__worldX": 176,
                "__worldY": 576
            }, {
                "__identifier": "Biome",
                "__grid": [14, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#006266",
                "iid": "eaee0bb0-d380-11f0-8099-877a0552b66e",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [224, 592],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Deep_Root_Hollow",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Deep_Root_Hollow"]
                    }]
                }],
                "__worldX": 224,
                "__worldY": 592
            }, {
                "__identifier": "Biome",
                "__grid": [16, 35],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#006266",
                "iid": "ed73f340-d380-11f0-8099-6fe5c2cbd1a2",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [256, 560],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Deep_Root_Hollow",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Deep_Root_Hollow"]
                    }]
                }],
                "__worldX": 256,
                "__worldY": 560
            }, {
                "__identifier": "Biome",
                "__grid": [16, 32],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#006266",
                "iid": "f61f5750-d380-11f0-8099-efa4894ab040",
                "width": 48,
                "height": 32,
                "defUid": 49,
                "px": [256, 512],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Deep_Root_Hollow",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Deep_Root_Hollow"]
                    }]
                }],
                "__worldX": 256,
                "__worldY": 512
            }, {
                "__identifier": "Biome",
                "__grid": [18, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#006266",
                "iid": "070eab10-d380-11f0-8099-d7c2e4754011",
                "width": 32,
                "height": 16,
                "defUid": 49,
                "px": [288, 576],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Deep_Root_Hollow",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Deep_Root_Hollow"]
                    }]
                }],
                "__worldX": 288,
                "__worldY": 576
            }, {
                "__identifier": "Biome",
                "__grid": [19, 35],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#006266",
                "iid": "0c2883f0-d380-11f0-8099-77ad47851c09",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [304, 560],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Deep_Root_Hollow",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Deep_Root_Hollow"]
                    }]
                }],
                "__worldX": 304,
                "__worldY": 560
            }, {
                "__identifier": "Biome",
                "__grid": [21, 33],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#7BED9F",
                "iid": "14953150-d380-11f0-8099-4fc7751b8721",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [336, 528],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Breeze_Woodlands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Breeze_Woodlands"]
                    }]
                }],
                "__worldX": 336,
                "__worldY": 528
            }, {
                "__identifier": "Biome",
                "__grid": [22, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "225fc570-d380-11f0-8099-c76dc1116b16",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [352, 496],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 352,
                "__worldY": 496
            }, {
                "__identifier": "Biome",
                "__grid": [29, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "257d8030-d380-11f0-8099-95461714f718",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [464, 496],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 464,
                "__worldY": 496
            }, {
                "__identifier": "Biome",
                "__grid": [18, 30],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2ECC71",
                "iid": "2f3ac970-d380-11f0-8099-79c22a3ba0ef",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [288, 480],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Jade_Canopy",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Jade_Canopy"]
                    }]
                }],
                "__worldX": 288,
                "__worldY": 480
            }, {
                "__identifier": "Biome",
                "__grid": [18, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FBC531",
                "iid": "3a825c30-d380-11f0-8099-4bce7e4e290c",
                "width": 16,
                "height": 64,
                "defUid": 49,
                "px": [288, 288],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Scorched_Dunes",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Scorched_Dunes"]
                    }]
                }],
                "__worldX": 288,
                "__worldY": 288
            }, {
                "__identifier": "Biome",
                "__grid": [20, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "3f3e84b0-d380-11f0-8099-59edeea084a0",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [320, 352],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 352
            }, {
                "__identifier": "Biome",
                "__grid": [22, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "4f8feac0-d380-11f0-8099-61df2b74c408",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [352, 320],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 352,
                "__worldY": 320
            }, {
                "__identifier": "Biome",
                "__grid": [29, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "573131d0-d380-11f0-8099-87758be52642",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [464, 320],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 464,
                "__worldY": 320
            }, {
                "__identifier": "Biome",
                "__grid": [26, 17],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2C3A47",
                "iid": "6a389020-d380-11f0-8099-f74cee7307e0",
                "width": 96,
                "height": 16,
                "defUid": 49,
                "px": [416, 272],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Twilight_Copse",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Twilight_Copse"]
                    }]
                }],
                "__worldX": 416,
                "__worldY": 272
            }, {
                "__identifier": "Biome",
                "__grid": [31, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "7a54b560-d380-11f0-8099-25592b4e7381",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [496, 352],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 496,
                "__worldY": 352
            }, {
                "__identifier": "Biome",
                "__grid": [31, 29],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "7da31d10-d380-11f0-8099-fff3acdb59f8",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [496, 464],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 496,
                "__worldY": 464
            }, {
                "__identifier": "Biome",
                "__grid": [33, 14],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2C3A47",
                "iid": "8dbe09d0-d380-11f0-8099-cdb6b63d7a0e",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [528, 224],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Twilight_Copse",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Twilight_Copse"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 224
            }, {
                "__identifier": "Biome",
                "__grid": [34, 14],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "939cb950-d380-11f0-8099-5df67904c7fe",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [544, 224],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 544,
                "__worldY": 224
            }, {
                "__identifier": "Biome",
                "__grid": [36, 15],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "9ada83a0-d380-11f0-8099-6b55bd10dda6",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [576, 240],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 576,
                "__worldY": 240
            }, {
                "__identifier": "Biome",
                "__grid": [35, 16],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "9ceb8950-d380-11f0-8099-7ff4b4bedf01",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [560, 256],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 560,
                "__worldY": 256
            }, {
                "__identifier": "Biome",
                "__grid": [33, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "9eff0000-d380-11f0-8099-8309058027ef",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [528, 288],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 288
            }, {
                "__identifier": "Biome",
                "__grid": [33, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#F8F9FA",
                "iid": "afd30390-d380-11f0-8099-e378efae2b60",
                "width": 96,
                "height": 32,
                "defUid": 49,
                "px": [528, 144],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Silent_Tundra",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Silent_Tundra"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 144
            }, {
                "__identifier": "Biome",
                "__grid": [33, 11],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "c318a360-d380-11f0-8099-bdbdff6a4047",
                "width": 48,
                "height": 48,
                "defUid": 49,
                "px": [528, 176],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 176
            }, {
                "__identifier": "Biome",
                "__grid": [36, 11],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "c9a19ca0-d380-11f0-8099-813ecfbf7fa5",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [576, 176],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 576,
                "__worldY": 176
            }, {
                "__identifier": "Biome",
                "__grid": [37, 11],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "cbfccab0-d380-11f0-8099-01bb7296ef98",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [592, 176],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 176
            }, {
                "__identifier": "Biome",
                "__grid": [39, 12],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "d8d7ceb0-d380-11f0-8099-8321d7d9096e",
                "width": 32,
                "height": 32,
                "defUid": 49,
                "px": [624, 192],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 192
            }, {
                "__identifier": "Biome",
                "__grid": [38, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "dbcaf700-d380-11f0-8099-0f34e1f522b1",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [608, 208],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 208
            }, {
                "__identifier": "Biome",
                "__grid": [40, 10],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "dd972b80-d380-11f0-8099-49198d9dc498",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [640, 160],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 160
            }, {
                "__identifier": "Biome",
                "__grid": [41, 4],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#F8F9FA",
                "iid": "e4353360-d380-11f0-8099-59994df55d20",
                "width": 112,
                "height": 80,
                "defUid": 49,
                "px": [656, 64],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Silent_Tundra",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Silent_Tundra"]
                    }]
                }],
                "__worldX": 656,
                "__worldY": 64
            }, {
                "__identifier": "Biome",
                "__grid": [40, 5],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#F8F9FA",
                "iid": "e77bf9f0-d380-11f0-8099-997ede323466",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [640, 80],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Silent_Tundra",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Silent_Tundra"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 80
            }, {
                "__identifier": "Biome",
                "__grid": [39, 8],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#F8F9FA",
                "iid": "eadcd830-d380-11f0-8099-3bf9dd7ff597",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [624, 128],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Silent_Tundra",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Silent_Tundra"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 128
            }, {
                "__identifier": "Biome",
                "__grid": [19, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#7BED9F",
                "iid": "0103c600-d380-11f0-8099-972535e95533",
                "width": 112,
                "height": 32,
                "defUid": 49,
                "px": [304, 592],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Breeze_Woodlands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Breeze_Woodlands"]
                    }]
                }],
                "__worldX": 304,
                "__worldY": 592
            }, {
                "__identifier": "Biome",
                "__grid": [18, 38],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#006266",
                "iid": "0550b1f0-d380-11f0-8099-3d89f50512a1",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [288, 608],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Deep_Root_Hollow",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Deep_Root_Hollow"]
                    }]
                }],
                "__worldX": 288,
                "__worldY": 608
            }, {
                "__identifier": "Biome",
                "__grid": [35, 26],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DAE55C",
                "iid": "13275400-d380-11f0-8099-83f078ec076c",
                "width": 208,
                "height": 16,
                "defUid": 49,
                "px": [560, 416],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Radiant_Plains",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Radiant_Plains"]
                    }]
                }],
                "__worldX": 560,
                "__worldY": 416
            }, {
                "__identifier": "Biome",
                "__grid": [34, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DAE55C",
                "iid": "1b599070-d380-11f0-8099-37ed5c5124d6",
                "width": 48,
                "height": 64,
                "defUid": 49,
                "px": [544, 352],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Radiant_Plains",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Radiant_Plains"]
                    }]
                }],
                "__worldX": 544,
                "__worldY": 352
            }, {
                "__identifier": "Biome",
                "__grid": [37, 23],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DAE55C",
                "iid": "1e735390-d380-11f0-8099-1578a54f6065",
                "width": 32,
                "height": 48,
                "defUid": 49,
                "px": [592, 368],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Radiant_Plains",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Radiant_Plains"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 368
            }, {
                "__identifier": "Biome",
                "__grid": [39, 25],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DAE55C",
                "iid": "21623620-d380-11f0-8099-d9c4e4747d39",
                "width": 80,
                "height": 16,
                "defUid": 49,
                "px": [624, 400],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Radiant_Plains",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Radiant_Plains"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 400
            }, {
                "__identifier": "Biome",
                "__grid": [38, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "2700a850-d380-11f0-8099-11d5facfd1df",
                "width": 32,
                "height": 16,
                "defUid": 49,
                "px": [608, 336],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 336
            }, {
                "__identifier": "Biome",
                "__grid": [40, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "2f17e2b0-d380-11f0-8099-03f4875cb464",
                "width": 128,
                "height": 48,
                "defUid": 49,
                "px": [640, 336],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 336
            }, {
                "__identifier": "Biome",
                "__grid": [45, 24],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B33939",
                "iid": "33759780-d380-11f0-8099-cdb6db4d8abc",
                "width": 48,
                "height": 16,
                "defUid": 49,
                "px": [720, 384],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Cinder_Moor",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cinder_Moor"]
                    }]
                }],
                "__worldX": 720,
                "__worldY": 384
            }, {
                "__identifier": "Biome",
                "__grid": [17, 34],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#4BCFFA",
                "iid": "c4f24ff0-d380-11f0-8099-ff954f27e2c1",
                "width": 16,
                "height": 80,
                "defUid": 49,
                "px": [272, 544],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mirror_Lotis_Lake",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mirror_Lotis_Lake"]
                    }]
                }],
                "__worldX": 272,
                "__worldY": 544
            }, {
                "__identifier": "Biome",
                "__grid": [16, 34],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#4BCFFA",
                "iid": "c94f1a60-d380-11f0-8099-67961f35e06b",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [256, 544],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mirror_Lotis_Lake",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mirror_Lotis_Lake"]
                    }]
                }],
                "__worldX": 256,
                "__worldY": 544
            }, {
                "__identifier": "Biome",
                "__grid": [15, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#4BCFFA",
                "iid": "ccf40680-d380-11f0-8099-f3cc600a71de",
                "width": 32,
                "height": 48,
                "defUid": 49,
                "px": [240, 576],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mirror_Lotis_Lake",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mirror_Lotis_Lake"]
                    }]
                }],
                "__worldX": 240,
                "__worldY": 576
            }, {
                "__identifier": "Biome",
                "__grid": [18, 37],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#4BCFFA",
                "iid": "d3822fe0-d380-11f0-8099-651daa4c5903",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [288, 592],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mirror_Lotis_Lake",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mirror_Lotis_Lake"]
                    }]
                }],
                "__worldX": 288,
                "__worldY": 592
            }, {
                "__identifier": "Biome",
                "__grid": [18, 34],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#4BCFFA",
                "iid": "d612c5d0-d380-11f0-8099-65f62a4002be",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [288, 544],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mirror_Lotis_Lake",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mirror_Lotis_Lake"]
                    }]
                }],
                "__worldX": 288,
                "__worldY": 544
            }, {
                "__identifier": "Biome",
                "__grid": [19, 33],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#4BCFFA",
                "iid": "dcba6aa0-d380-11f0-8099-7f4b505e9d59",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [304, 528],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mirror_Lotis_Lake",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mirror_Lotis_Lake"]
                    }]
                }],
                "__worldX": 304,
                "__worldY": 528
            }, {
                "__identifier": "Biome",
                "__grid": [20, 33],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#4BCFFA",
                "iid": "e03ed670-d380-11f0-8099-c54a7dbffd6a",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [320, 528],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mirror_Lotis_Lake",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mirror_Lotis_Lake"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 528
            }, {
                "__identifier": "Biome",
                "__grid": [14, 38],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2BCBBA",
                "iid": "e62b68a0-d380-11f0-8099-f3b7d066b690",
                "width": 16,
                "height": 160,
                "defUid": 49,
                "px": [224, 608],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Emerald_Vein_River",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Emerald_Vein_River"]
                    }]
                }],
                "__worldX": 224,
                "__worldY": 608
            }, {
                "__identifier": "Biome",
                "__grid": [15, 39],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2BCBBA",
                "iid": "ea4a66c0-d380-11f0-8099-61854b3dd0d6",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [240, 624],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Emerald_Vein_River",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Emerald_Vein_River"]
                    }]
                }],
                "__worldX": 240,
                "__worldY": 624
            }, {
                "__identifier": "Biome",
                "__grid": [20, 29],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE4EA",
                "iid": "f31b5430-d380-11f0-8099-0d18c2063680",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [320, 464],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Arcadia_Lawns",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Arcadia_Lawns"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 464
            }, {
                "__identifier": "Biome",
                "__grid": [22, 33],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "f86a94f0-d380-11f0-8099-8ffdb9eee66d",
                "width": 144,
                "height": 16,
                "defUid": 49,
                "px": [352, 528],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 352,
                "__worldY": 528
            }, {
                "__identifier": "Biome",
                "__grid": [20, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "ff73e1c0-d380-11f0-8099-5f4d3cc95936",
                "width": 32,
                "height": 32,
                "defUid": 49,
                "px": [320, 496],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 496
            }, {
                "__identifier": "Biome",
                "__grid": [22, 32],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "03b84230-d380-11f0-8099-d91cae1a596d",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [352, 512],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 352,
                "__worldY": 512
            }, {
                "__identifier": "Biome",
                "__grid": [19, 29],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "09c75080-d380-11f0-8099-bffc5a9ec269",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [304, 464],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 304,
                "__worldY": 464
            }, {
                "__identifier": "Biome",
                "__grid": [20, 30],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "0e25a190-d380-11f0-8099-af377935ce67",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [320, 480],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 480
            }, {
                "__identifier": "Biome",
                "__grid": [18, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "10fa1e50-d380-11f0-8099-0d427ecb160f",
                "width": 16,
                "height": 128,
                "defUid": 49,
                "px": [288, 352],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 288,
                "__worldY": 352
            }, {
                "__identifier": "Biome",
                "__grid": [19, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "19c0ab80-d380-11f0-8099-9999f32e898d",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [304, 336],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 304,
                "__worldY": 336
            }, {
                "__identifier": "Biome",
                "__grid": [20, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "1db5da80-d380-11f0-8099-c55eea72de36",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [320, 320],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 320
            }, {
                "__identifier": "Biome",
                "__grid": [22, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "22f47970-d380-11f0-8099-b5b2d99c4833",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [352, 288],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 352,
                "__worldY": 288
            }, {
                "__identifier": "Biome",
                "__grid": [21, 19],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "2afd8300-d380-11f0-8099-1d929a26fb8d",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [336, 304],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 336,
                "__worldY": 304
            }, {
                "__identifier": "Biome",
                "__grid": [23, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "2e58bbf0-d380-11f0-8099-e9ee093fb243",
                "width": 96,
                "height": 16,
                "defUid": 49,
                "px": [368, 288],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 368,
                "__worldY": 288
            }, {
                "__identifier": "Biome",
                "__grid": [32, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DAE55C",
                "iid": "36f46890-d380-11f0-8099-f7bce8e1c887",
                "width": 32,
                "height": 16,
                "defUid": 49,
                "px": [512, 496],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Radiant_Plains",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Radiant_Plains"]
                    }]
                }],
                "__worldX": 512,
                "__worldY": 496
            }, {
                "__identifier": "Biome",
                "__grid": [29, 32],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "3e189060-d380-11f0-8099-c709d79eca76",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [464, 512],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 464,
                "__worldY": 512
            }, {
                "__identifier": "Biome",
                "__grid": [30, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "40b70900-d380-11f0-8099-01612faa2d6d",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [480, 496],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 480,
                "__worldY": 496
            }, {
                "__identifier": "Biome",
                "__grid": [31, 30],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "43410f40-d380-11f0-8099-fb0568950227",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [496, 480],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 496,
                "__worldY": 480
            }, {
                "__identifier": "Biome",
                "__grid": [32, 29],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "48676b40-d380-11f0-8099-39e6eca098f8",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [512, 464],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 512,
                "__worldY": 464
            }, {
                "__identifier": "Biome",
                "__grid": [33, 23],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "4c484ef0-d380-11f0-8099-4f9dd3ebf128",
                "width": 16,
                "height": 112,
                "defUid": 49,
                "px": [528, 368],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 368
            }, {
                "__identifier": "Biome",
                "__grid": [34, 26],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0FB9B1",
                "iid": "529e7860-d380-11f0-8099-f15874e17b89",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [544, 416],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Zero_Halo_Moat",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zero_Halo_Moat"]
                    }]
                }],
                "__worldX": 544,
                "__worldY": 416
            }, {
                "__identifier": "Biome",
                "__grid": [30, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#45AAF2",
                "iid": "58e02f70-d380-11f0-8099-47119c3ef6cf",
                "width": 48,
                "height": 48,
                "defUid": 49,
                "px": [480, 288],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Twin_Destiny_Basin",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Twin_Destiny_Basin"]
                    }]
                }],
                "__worldX": 480,
                "__worldY": 288
            }, {
                "__identifier": "Biome",
                "__grid": [31, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#45AAF2",
                "iid": "640ee300-d380-11f0-8099-d554c206c969",
                "width": 48,
                "height": 16,
                "defUid": 49,
                "px": [496, 336],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Twin_Destiny_Basin",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Twin_Destiny_Basin"]
                    }]
                }],
                "__worldX": 496,
                "__worldY": 336
            }, {
                "__identifier": "Biome",
                "__grid": [32, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#45AAF2",
                "iid": "6909e940-d380-11f0-8099-bf9a4dad1620",
                "width": 32,
                "height": 16,
                "defUid": 49,
                "px": [512, 352],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Twin_Destiny_Basin",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Twin_Destiny_Basin"]
                    }]
                }],
                "__worldX": 512,
                "__worldY": 352
            }, {
                "__identifier": "Biome",
                "__grid": [29, 18],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#45AAF2",
                "iid": "6d03fa40-d380-11f0-8099-cf4b8093f11c",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [464, 288],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Twin_Destiny_Basin",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Twin_Destiny_Basin"]
                    }]
                }],
                "__worldX": 464,
                "__worldY": 288
            }, {
                "__identifier": "Biome",
                "__grid": [33, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#45AAF2",
                "iid": "70fc0f70-d380-11f0-8099-ad93dc97e96b",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [528, 320],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Twin_Destiny_Basin",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Twin_Destiny_Basin"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 320
            }, {
                "__identifier": "Biome",
                "__grid": [32, 17],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#45AAF2",
                "iid": "7c8258e0-d380-11f0-8099-eb7e647debc3",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [512, 272],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Twin_Destiny_Basin",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Twin_Destiny_Basin"]
                    }]
                }],
                "__worldX": 512,
                "__worldY": 272
            }, {
                "__identifier": "Biome",
                "__grid": [33, 16],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#60A3BC",
                "iid": "817aa000-d380-11f0-8099-d70161320558",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [528, 256],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mercury_Stream",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mercury_Stream"]
                    }]
                }],
                "__worldX": 528,
                "__worldY": 256
            }, {
                "__identifier": "Biome",
                "__grid": [34, 15],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#60A3BC",
                "iid": "84538990-d380-11f0-8099-9348844b58cd",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [544, 240],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mercury_Stream",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mercury_Stream"]
                    }]
                }],
                "__worldX": 544,
                "__worldY": 240
            }, {
                "__identifier": "Biome",
                "__grid": [35, 14],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#60A3BC",
                "iid": "86bd5da0-d380-11f0-8099-9da005250878",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [560, 224],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mercury_Stream",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mercury_Stream"]
                    }]
                }],
                "__worldX": 560,
                "__worldY": 224
            }, {
                "__identifier": "Biome",
                "__grid": [36, 13],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#60A3BC",
                "iid": "89482730-d380-11f0-8099-a735300117b0",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [576, 208],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mercury_Stream",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mercury_Stream"]
                    }]
                }],
                "__worldX": 576,
                "__worldY": 208
            }, {
                "__identifier": "Biome",
                "__grid": [37, 12],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#60A3BC",
                "iid": "8bddc630-d380-11f0-8099-01875c4e08ae",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [592, 192],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mercury_Stream",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mercury_Stream"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 192
            }, {
                "__identifier": "Biome",
                "__grid": [38, 11],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#60A3BC",
                "iid": "8ececba0-d380-11f0-8099-bbe6127fade7",
                "width": 16,
                "height": 32,
                "defUid": 49,
                "px": [608, 176],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mercury_Stream",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mercury_Stream"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 176
            }, {
                "__identifier": "Biome",
                "__grid": [39, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#60A3BC",
                "iid": "91993640-d380-11f0-8099-999404170e6b",
                "width": 16,
                "height": 48,
                "defUid": 49,
                "px": [624, 144],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mercury_Stream",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mercury_Stream"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 144
            }, {
                "__identifier": "Biome",
                "__grid": [40, 7],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#60A3BC",
                "iid": "94d96d20-d380-11f0-8099-77747861069d",
                "width": 16,
                "height": 48,
                "defUid": 49,
                "px": [640, 112],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mercury_Stream",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mercury_Stream"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 112
            }, {
                "__identifier": "Biome",
                "__grid": [39, 4],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#60A3BC",
                "iid": "98a9af00-d380-11f0-8099-5b12cc27258e",
                "width": 16,
                "height": 64,
                "defUid": 49,
                "px": [624, 64],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mercury_Stream",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mercury_Stream"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 64
            }, {
                "__identifier": "Biome",
                "__grid": [40, 4],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#60A3BC",
                "iid": "9b9e5df0-d380-11f0-8099-e58004481000",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [640, 64],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Mercury_Stream",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Mercury_Stream"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 64
            }, {
                "__identifier": "Biome",
                "__grid": [34, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#7EFFF5",
                "iid": "dedd0710-d380-11f0-8099-ad24f4c1fcfe",
                "width": 64,
                "height": 16,
                "defUid": 49,
                "px": [544, 336],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Chrome_Canal",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Chrome_Canal"]
                    }]
                }],
                "__worldX": 544,
                "__worldY": 336
            }, {
                "__identifier": "Biome",
                "__grid": [37, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#7EFFF5",
                "iid": "e162c790-d380-11f0-8099-05d7bbe82619",
                "width": 32,
                "height": 16,
                "defUid": 49,
                "px": [592, 352],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Chrome_Canal",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Chrome_Canal"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 352
            }, {
                "__identifier": "Biome",
                "__grid": [39, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#7EFFF5",
                "iid": "e542c0e0-d380-11f0-8099-3949755e7215",
                "width": 16,
                "height": 48,
                "defUid": 49,
                "px": [624, 352],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Chrome_Canal",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Chrome_Canal"]
                    }]
                }],
                "__worldX": 624,
                "__worldY": 352
            }, {
                "__identifier": "Biome",
                "__grid": [40, 24],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#7EFFF5",
                "iid": "00630740-d380-11f0-8099-7d9e66f0dc66",
                "width": 80,
                "height": 16,
                "defUid": 49,
                "px": [640, 384],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Chrome_Canal",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Chrome_Canal"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 384
            }, {
                "__identifier": "Biome",
                "__grid": [44, 25],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#7EFFF5",
                "iid": "03bb32f0-d380-11f0-8099-7d880911475f",
                "width": 64,
                "height": 16,
                "defUid": 49,
                "px": [704, 400],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Chrome_Canal",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Chrome_Canal"]
                    }]
                }],
                "__worldX": 704,
                "__worldY": 400
            }, {
                "__identifier": "Biome",
                "__grid": [20, 19],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E84118",
                "iid": "8d4c78f0-d380-11f0-8ea7-ff5b8ec482b7",
                "width": 16,
                "height": 16,
                "defUid": 49,
                "px": [320, 304],
                "fieldInstances": [{
                    "__identifier": "Sapphire_Strand",
                    "__type": "LocalEnum.Biome",
                    "__value": "Crimson_Badlands",
                    "__tile": null,
                    "defUid": 51,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Crimson_Badlands"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 304
            }]
        }, {
            "__identifier": "Region_Zone",
            "__type": "Entities",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 1,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "04887860-d380-11f0-aa69-1fb94c3ff71e",
            "levelId": 0,
            "layerDefUid": 35,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [],
            "autoLayerTiles": [],
            "seed": 1158073,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": [{
                "__identifier": "Region_Zenith",
                "__grid": [24, 28],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FFFFFF",
                "iid": "74d49c40-d380-11f0-aa69-a33755175f85",
                "width": 80,
                "height": 80,
                "defUid": 36,
                "px": [384, 448],
                "fieldInstances": [{
                    "__identifier": "Locs_Zenith",
                    "__type": "LocalEnum.Locs_Zenith",
                    "__value": "Aether_Admin_Zone",
                    "__tile": null,
                    "defUid": 42,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Aether_Admin_Zone"]
                    }]
                }],
                "__worldX": 384,
                "__worldY": 448
            }, {
                "__identifier": "Region_Zenith",
                "__grid": [19, 24],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#55EFC4",
                "iid": "78e71740-d380-11f0-aa69-7d4383d69a82",
                "width": 96,
                "height": 64,
                "defUid": 36,
                "px": [304, 384],
                "fieldInstances": [{
                    "__identifier": "Locs_Zenith",
                    "__type": "LocalEnum.Locs_Zenith",
                    "__value": "Eco_Subject_Delta",
                    "__tile": null,
                    "defUid": 42,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Eco_Subject_Delta"]
                    }]
                }],
                "__worldX": 304,
                "__worldY": 384
            }, {
                "__identifier": "Region_Zenith",
                "__grid": [29, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF7675",
                "iid": "812b2e00-d380-11f0-aa69-23cac57206dd",
                "width": 48,
                "height": 48,
                "defUid": 36,
                "px": [464, 432],
                "fieldInstances": [{
                    "__identifier": "Locs_Zenith",
                    "__type": "LocalEnum.Locs_Zenith",
                    "__value": "Lusamine_Gardens",
                    "__tile": null,
                    "defUid": 42,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Lusamine_Gardens"]
                    }]
                }],
                "__worldX": 464,
                "__worldY": 432
            }, {
                "__identifier": "Region_Zenith",
                "__grid": [22, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#74B9FF",
                "iid": "91eabf30-d380-11f0-aa69-bf609df6987b",
                "width": 80,
                "height": 64,
                "defUid": 36,
                "px": [352, 320],
                "fieldInstances": [{
                    "__identifier": "Locs_Zenith",
                    "__type": "LocalEnum.Locs_Zenith",
                    "__value": "Royal_Academy",
                    "__tile": null,
                    "defUid": 42,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Royal_Academy"]
                    }]
                }],
                "__worldX": 352,
                "__worldY": 320
            }, {
                "__identifier": "Region_Zenith",
                "__grid": [25, 24],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#A29BFE",
                "iid": "0b9a53e0-d380-11f0-aa69-85cc8b03ea50",
                "width": 64,
                "height": 64,
                "defUid": 36,
                "px": [400, 384],
                "fieldInstances": [{
                    "__identifier": "Locs_Zenith",
                    "__type": "LocalEnum.Locs_Zenith",
                    "__value": "Academic_Plaza",
                    "__tile": null,
                    "defUid": 42,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Academic_Plaza"]
                    }]
                }],
                "__worldX": 400,
                "__worldY": 384
            }, {
                "__identifier": "Region_Neon",
                "__grid": [37, 35],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF9F43",
                "iid": "d62c3ce0-d380-11f0-aa69-d3cce5446169",
                "width": 64,
                "height": 80,
                "defUid": 43,
                "px": [592, 560],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Iono_Stream_Tower",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Iono_Stream_Tower"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 560
            }, {
                "__identifier": "Region_Neon",
                "__grid": [40, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#576574",
                "iid": "f0ace7e0-d380-11f0-aa69-e780db42d1e7",
                "width": 128,
                "height": 64,
                "defUid": 43,
                "px": [640, 432],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Toxic_Industrial_Park",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Toxic_Industrial_Park"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 432
            }, {
                "__identifier": "Region_Zenith",
                "__grid": [27, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE6E9",
                "iid": "fd2ecf60-d380-11f0-aa69-092031cf41ea",
                "width": 64,
                "height": 48,
                "defUid": 36,
                "px": [432, 336],
                "fieldInstances": [{
                    "__identifier": "Locs_Zenith",
                    "__type": "LocalEnum.Locs_Zenith",
                    "__value": "Living_Quarter",
                    "__tile": null,
                    "defUid": 42,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Living_Quarter"]
                    }]
                }],
                "__worldX": 432,
                "__worldY": 336
            }, {
                "__identifier": "Region_Zenith",
                "__grid": [29, 24],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE6E9",
                "iid": "07c588b0-d380-11f0-aa69-cfa79f9dc9f4",
                "width": 64,
                "height": 48,
                "defUid": 36,
                "px": [464, 384],
                "fieldInstances": [{
                    "__identifier": "Locs_Zenith",
                    "__type": "LocalEnum.Locs_Zenith",
                    "__value": "Living_Quarter",
                    "__tile": null,
                    "defUid": 42,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Living_Quarter"]
                    }]
                }],
                "__worldX": 464,
                "__worldY": 384
            }, {
                "__identifier": "Region_Neon",
                "__grid": [31, 35],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF6B81",
                "iid": "156c1a10-d380-11f0-aa69-05b8a9108994",
                "width": 96,
                "height": 80,
                "defUid": 43,
                "px": [496, 560],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Cyber_Shopping_District",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cyber_Shopping_District"]
                    }]
                }],
                "__worldX": 496,
                "__worldY": 560
            }, {
                "__identifier": "Region_Neon",
                "__grid": [36, 27],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#00D2D3",
                "iid": "1d9c81c0-d380-11f0-aa69-31aa0b404700",
                "width": 64,
                "height": 128,
                "defUid": 43,
                "px": [576, 432],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Glitch_Arcade_Lane",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Glitch_Arcade_Lane"]
                    }]
                }],
                "__worldX": 576,
                "__worldY": 432
            }, {
                "__identifier": "Region_Neon",
                "__grid": [44, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#54A0FF",
                "iid": "30646610-d380-11f0-aa69-b37992389c6b",
                "width": 64,
                "height": 80,
                "defUid": 43,
                "px": [704, 496],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Port_Logistics_Area",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Port_Logistics_Area"]
                    }]
                }],
                "__worldX": 704,
                "__worldY": 496
            }, {
                "__identifier": "Region_Neon",
                "__grid": [40, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF6B81",
                "iid": "d6c07120-d380-11f0-aa69-b50c9e7d61f5",
                "width": 64,
                "height": 64,
                "defUid": 43,
                "px": [640, 496],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Cyber_Shopping_District",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cyber_Shopping_District"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 496
            }, {
                "__identifier": "Region_Neon",
                "__grid": [25, 40],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B2BEC3",
                "iid": "326d8710-d380-11f0-aa69-135ff88ac2cf",
                "width": 208,
                "height": 112,
                "defUid": 43,
                "px": [400, 640],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Skyline_Residences",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Skyline_Residences"]
                    }]
                }],
                "__worldX": 400,
                "__worldY": 640
            }, {
                "__identifier": "Region_Neon",
                "__grid": [41, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#576574",
                "iid": "4cff9730-d380-11f0-aa69-9d3f960aabae",
                "width": 48,
                "height": 96,
                "defUid": 43,
                "px": [656, 576],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Toxic_Industrial_Park",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Toxic_Industrial_Park"]
                    }]
                }],
                "__worldX": 656,
                "__worldY": 576
            }, {
                "__identifier": "Region_Neon",
                "__grid": [38, 45],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#55EFC4",
                "iid": "568de130-d380-11f0-aa69-2dd605d47518",
                "width": 160,
                "height": 48,
                "defUid": 43,
                "px": [608, 720],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Synth_Promenade",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Synth_Promenade"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 720
            }, {
                "__identifier": "Region_Neon",
                "__grid": [44, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#55EFC4",
                "iid": "68141dc0-d380-11f0-aa69-8d8b925bac5b",
                "width": 64,
                "height": 144,
                "defUid": 43,
                "px": [704, 576],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Synth_Promenade",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Synth_Promenade"]
                    }]
                }],
                "__worldX": 704,
                "__worldY": 576
            }, {
                "__identifier": "Region_Neon",
                "__grid": [38, 42],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B2BEC3",
                "iid": "73d6fb00-d380-11f0-aa69-abd71e6e50f5",
                "width": 96,
                "height": 48,
                "defUid": 43,
                "px": [608, 672],
                "fieldInstances": [{
                    "__identifier": "Locs_Neon",
                    "__type": "LocalEnum.Locs_Neon",
                    "__value": "Skyline_Residences",
                    "__tile": null,
                    "defUid": 45,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Skyline_Residences"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 672
            }, {
                "__identifier": "Region_Bloom",
                "__grid": [5, 36],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FDA7DF",
                "iid": "e61da140-d380-11f0-aa69-03fee1f0c530",
                "width": 48,
                "height": 176,
                "defUid": 46,
                "px": [80, 576],
                "fieldInstances": [{
                    "__identifier": "Locs_Bloom",
                    "__type": "LocalEnum.Locs_Bloom",
                    "__value": "Pearl_Resort",
                    "__tile": null,
                    "defUid": 48,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Pearl_Resort"]
                    }]
                }],
                "__worldX": 80,
                "__worldY": 576
            }, {
                "__identifier": "Region_Bloom",
                "__grid": [8, 44],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FDA7DF",
                "iid": "eedbf110-d380-11f0-aa69-111a7bc2ebfb",
                "width": 96,
                "height": 48,
                "defUid": 46,
                "px": [128, 704],
                "fieldInstances": [{
                    "__identifier": "Locs_Bloom",
                    "__type": "LocalEnum.Locs_Bloom",
                    "__value": "Pearl_Resort",
                    "__tile": null,
                    "defUid": 48,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Pearl_Resort"]
                    }]
                }],
                "__worldX": 128,
                "__worldY": 704
            }, {
                "__identifier": "Region_Bloom",
                "__grid": [20, 34],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#74B9FF",
                "iid": "fe2c15f0-d380-11f0-86dc-2f92d8f4d385",
                "width": 64,
                "height": 96,
                "defUid": 46,
                "px": [320, 544],
                "fieldInstances": [{
                    "__identifier": "Locs_Bloom",
                    "__type": "LocalEnum.Locs_Bloom",
                    "__value": "Marina_Port_Town",
                    "__tile": null,
                    "defUid": 48,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Marina_Port_Town"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 544
            }, {
                "__identifier": "Region_Bloom",
                "__grid": [8, 38],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#E17055",
                "iid": "0bd9fa50-d380-11f0-86dc-31654e330a82",
                "width": 80,
                "height": 96,
                "defUid": 46,
                "px": [128, 608],
                "fieldInstances": [{
                    "__identifier": "Locs_Bloom",
                    "__type": "LocalEnum.Locs_Bloom",
                    "__value": "Sunflora_Farmsteads",
                    "__tile": null,
                    "defUid": 48,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Sunflora_Farmsteads"]
                    }]
                }],
                "__worldX": 128,
                "__worldY": 608
            }, {
                "__identifier": "Region_Shadow",
                "__grid": [37, 22],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#A29BFE",
                "iid": "12e1f220-d380-11f0-86dc-c16f7bc6b3dd",
                "width": 176,
                "height": 64,
                "defUid": 53,
                "px": [592, 352],
                "fieldInstances": [{
                    "__identifier": "Locs_Shadow",
                    "__type": "LocalEnum.Locs_Shadow",
                    "__value": "Venom_Refinery",
                    "__tile": null,
                    "defUid": 55,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Venom_Refinery"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 352
            }, {
                "__identifier": "Region_Shadow",
                "__grid": [36, 16],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2D3436",
                "iid": "18f916c0-d380-11f0-86dc-a9a83d5f4b33",
                "width": 192,
                "height": 96,
                "defUid": 53,
                "px": [576, 256],
                "fieldInstances": [{
                    "__identifier": "Locs_Shadow",
                    "__type": "LocalEnum.Locs_Shadow",
                    "__value": "Grim_Borough",
                    "__tile": null,
                    "defUid": 55,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Grim_Borough"]
                    }]
                }],
                "__worldX": 576,
                "__worldY": 256
            }, {
                "__identifier": "Region_Shadow",
                "__grid": [38, 4],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B0A8B9",
                "iid": "2141e870-d380-11f0-86dc-1731ed73729c",
                "width": 48,
                "height": 112,
                "defUid": 53,
                "px": [608, 64],
                "fieldInstances": [{
                    "__identifier": "Locs_Shadow",
                    "__type": "LocalEnum.Locs_Shadow",
                    "__value": "Canal_Ruins_Post",
                    "__tile": null,
                    "defUid": 55,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Canal_Ruins_Post"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 64
            }, {
                "__identifier": "Region_Shadow",
                "__grid": [31, 4],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#DFE6E9",
                "iid": "26c335b0-d380-11f0-86dc-c15fdfed7492",
                "width": 112,
                "height": 80,
                "defUid": 53,
                "px": [496, 64],
                "fieldInstances": [{
                    "__identifier": "Locs_Shadow",
                    "__type": "LocalEnum.Locs_Shadow",
                    "__value": "Requiem_Grounds",
                    "__tile": null,
                    "defUid": 55,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Requiem_Grounds"]
                    }]
                }],
                "__worldX": 496,
                "__worldY": 64
            }, {
                "__identifier": "Region_Shadow",
                "__grid": [31, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B2BEC3",
                "iid": "89fef510-d380-11f0-86dc-898fbcba5fbb",
                "width": 112,
                "height": 64,
                "defUid": 53,
                "px": [496, 144],
                "fieldInstances": [{
                    "__identifier": "Locs_Shadow",
                    "__type": "LocalEnum.Locs_Shadow",
                    "__value": "Frost_Smoke_City",
                    "__tile": null,
                    "defUid": 55,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Frost_Smoke_City"]
                    }]
                }],
                "__worldX": 496,
                "__worldY": 144
            }, {
                "__identifier": "Region_Shadow",
                "__grid": [41, 4],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B2BEC3",
                "iid": "90c6f320-d380-11f0-86dc-1f023d48ed8a",
                "width": 112,
                "height": 112,
                "defUid": 53,
                "px": [656, 64],
                "fieldInstances": [{
                    "__identifier": "Locs_Shadow",
                    "__type": "LocalEnum.Locs_Shadow",
                    "__value": "Frost_Smoke_City",
                    "__tile": null,
                    "defUid": 55,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Frost_Smoke_City"]
                    }]
                }],
                "__worldX": 656,
                "__worldY": 64
            }, {
                "__identifier": "Region_Shadow",
                "__grid": [38, 11],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#B2BEC3",
                "iid": "96b5a830-d380-11f0-86dc-7df1630826f2",
                "width": 80,
                "height": 48,
                "defUid": 53,
                "px": [608, 176],
                "fieldInstances": [{
                    "__identifier": "Locs_Shadow",
                    "__type": "LocalEnum.Locs_Shadow",
                    "__value": "Frost_Smoke_City",
                    "__tile": null,
                    "defUid": 55,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Frost_Smoke_City"]
                    }]
                }],
                "__worldX": 608,
                "__worldY": 176
            }, {
                "__identifier": "Region_Zenith",
                "__grid": [20, 28],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#55EFC4",
                "iid": "a91b4840-d380-11f0-86dc-dbd46bb05ff4",
                "width": 64,
                "height": 64,
                "defUid": 36,
                "px": [320, 448],
                "fieldInstances": [{
                    "__identifier": "Locs_Zenith",
                    "__type": "LocalEnum.Locs_Zenith",
                    "__value": "Eco_Subject_Delta",
                    "__tile": null,
                    "defUid": 42,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Eco_Subject_Delta"]
                    }]
                }],
                "__worldX": 320,
                "__worldY": 448
            }, {
                "__identifier": "Region_Apex",
                "__grid": [13, 20],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#00C2C9",
                "iid": "878d1540-d380-11f0-86dc-4f57576d3775",
                "width": 48,
                "height": 32,
                "defUid": 56,
                "px": [208, 320],
                "fieldInstances": [{
                    "__identifier": "Locs_Apex",
                    "__type": "LocalEnum.Locs_Apex",
                    "__value": "Dune_Watcher_Post",
                    "__tile": null,
                    "defUid": 58,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Dune_Watcher_Post"]
                    }]
                }],
                "__worldX": 208,
                "__worldY": 320
            }, {
                "__identifier": "Region_Apex",
                "__grid": [17, 7],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#D35400",
                "iid": "9c581c90-d380-11f0-86dc-6108ce93011a",
                "width": 128,
                "height": 80,
                "defUid": 56,
                "px": [272, 112],
                "fieldInstances": [{
                    "__identifier": "Locs_Apex",
                    "__type": "LocalEnum.Locs_Apex",
                    "__value": "Crimson_Forge_City",
                    "__tile": null,
                    "defUid": 58,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Crimson_Forge_City"]
                    }]
                }],
                "__worldX": 272,
                "__worldY": 112
            }, {
                "__identifier": "Region_Apex",
                "__grid": [13, 12],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#D35400",
                "iid": "a1969470-d380-11f0-86dc-35d0027acb47",
                "width": 144,
                "height": 80,
                "defUid": 56,
                "px": [208, 192],
                "fieldInstances": [{
                    "__identifier": "Locs_Apex",
                    "__type": "LocalEnum.Locs_Apex",
                    "__value": "Crimson_Forge_City",
                    "__tile": null,
                    "defUid": 58,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Crimson_Forge_City"]
                    }]
                }],
                "__worldX": 208,
                "__worldY": 192
            }, {
                "__identifier": "Region_Apex",
                "__grid": [5, 11],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#EAD4AA",
                "iid": "ac902e40-d380-11f0-86dc-534c21b37175",
                "width": 64,
                "height": 80,
                "defUid": 56,
                "px": [80, 176],
                "fieldInstances": [{
                    "__identifier": "Locs_Apex",
                    "__type": "LocalEnum.Locs_Apex",
                    "__value": "Ruins_of_Giants",
                    "__tile": null,
                    "defUid": 58,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Ruins_of_Giants"]
                    }]
                }],
                "__worldX": 80,
                "__worldY": 176
            }, {
                "__identifier": "Region_Apex",
                "__grid": [12, 7],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#D77643",
                "iid": "b2104300-d380-11f0-86dc-53ebaf1e0ce9",
                "width": 80,
                "height": 80,
                "defUid": 56,
                "px": [192, 112],
                "fieldInstances": [{
                    "__identifier": "Locs_Apex",
                    "__type": "LocalEnum.Locs_Apex",
                    "__value": "Titan_Mining_site",
                    "__tile": null,
                    "defUid": 58,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Titan_Mining_site"]
                    }]
                }],
                "__worldX": 192,
                "__worldY": 112
            }]
        }, {
            "__identifier": "Core_Logic",
            "__type": "Entities",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 1,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "1a443d30-d380-11f0-aa69-6d0b68f55d7d",
            "levelId": 0,
            "layerDefUid": 12,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [],
            "autoLayerTiles": [],
            "seed": 7776827,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": [{
                "__identifier": "Warp",
                "__grid": [40, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF9F43",
                "iid": "7ace3ce0-d380-11f0-aa69-632c9c841708",
                "width": 16,
                "height": 16,
                "defUid": 13,
                "px": [640, 336],
                "fieldInstances": [{
                    "__identifier": "Enum",
                    "__type": "LocalEnum.DestType",
                    "__value": "Sewer_0",
                    "__tile": null,
                    "defUid": 20,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Sewer_0"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 336
            }, {
                "__identifier": "Warp",
                "__grid": [44, 17],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF9F43",
                "iid": "7ef29230-d380-11f0-aa69-d183ca52f549",
                "width": 16,
                "height": 16,
                "defUid": 13,
                "px": [704, 272],
                "fieldInstances": [{
                    "__identifier": "Enum",
                    "__type": "LocalEnum.DestType",
                    "__value": "Sewer_1",
                    "__tile": null,
                    "defUid": 20,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Sewer_1"]
                    }]
                }],
                "__worldX": 704,
                "__worldY": 272
            }, {
                "__identifier": "Warp",
                "__grid": [41, 31],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF9F43",
                "iid": "86122620-d380-11f0-aa69-3f5ef52f2d19",
                "width": 16,
                "height": 16,
                "defUid": 13,
                "px": [656, 496],
                "fieldInstances": [{
                    "__identifier": "Enum",
                    "__type": "LocalEnum.DestType",
                    "__value": "Sewer_2",
                    "__tile": null,
                    "defUid": 20,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Sewer_2"]
                    }]
                }],
                "__worldX": 656,
                "__worldY": 496
            }, {
                "__identifier": "Warp",
                "__grid": [7, 10],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF9F43",
                "iid": "12083a20-d380-11f0-aa69-511a6c014693",
                "width": 16,
                "height": 16,
                "defUid": 13,
                "px": [112, 160],
                "fieldInstances": [{
                    "__identifier": "Enum",
                    "__type": "LocalEnum.DestType",
                    "__value": "Cave_0",
                    "__tile": null,
                    "defUid": 20,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cave_0"]
                    }]
                }],
                "__worldX": 112,
                "__worldY": 160
            }, {
                "__identifier": "Warp",
                "__grid": [10, 14],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF9F43",
                "iid": "195323d0-d380-11f0-aa69-8bc70c2e6af0",
                "width": 16,
                "height": 16,
                "defUid": 13,
                "px": [160, 224],
                "fieldInstances": [{
                    "__identifier": "Enum",
                    "__type": "LocalEnum.DestType",
                    "__value": "Cave_1",
                    "__tile": null,
                    "defUid": 20,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cave_1"]
                    }]
                }],
                "__worldX": 160,
                "__worldY": 224
            }, {
                "__identifier": "Warp",
                "__grid": [12, 10],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF9F43",
                "iid": "20a31690-d380-11f0-aa69-a7b4a96def7f",
                "width": 16,
                "height": 16,
                "defUid": 13,
                "px": [192, 160],
                "fieldInstances": [{
                    "__identifier": "Enum",
                    "__type": "LocalEnum.DestType",
                    "__value": "Cave_2",
                    "__tile": null,
                    "defUid": 20,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Cave_2"]
                    }]
                }],
                "__worldX": 192,
                "__worldY": 160
            }, {
                "__identifier": "Warp",
                "__grid": [42, 14],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF9F43",
                "iid": "52b45180-d380-11f0-aa69-21074a763ddf",
                "width": 16,
                "height": 16,
                "defUid": 13,
                "px": [672, 224],
                "fieldInstances": [{
                    "__identifier": "Enum",
                    "__type": "LocalEnum.DestType",
                    "__value": "Gate_0",
                    "__tile": null,
                    "defUid": 20,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Gate_0"]
                    }]
                }],
                "__worldX": 672,
                "__worldY": 224
            }, {
                "__identifier": "Warp",
                "__grid": [37, 8],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#FF9F43",
                "iid": "551dfe80-d380-11f0-aa69-398d053a4ff6",
                "width": 16,
                "height": 16,
                "defUid": 13,
                "px": [592, 128],
                "fieldInstances": [{
                    "__identifier": "Enum",
                    "__type": "LocalEnum.DestType",
                    "__value": "Gate_1",
                    "__tile": null,
                    "defUid": 20,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Gate_1"]
                    }]
                }],
                "__worldX": 592,
                "__worldY": 128
            }, {
                "__identifier": "PlayerStart",
                "__grid": [22, 29],
                "__pivot": [0.5, 0.5],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0000FF",
                "iid": "c8ee2060-d380-11f0-aa69-7309752589f3",
                "width": 16,
                "height": 16,
                "defUid": 8,
                "px": [360, 472],
                "fieldInstances": [],
                "__worldX": 360,
                "__worldY": 472
            }, {
                "__identifier": "Transit_Station",
                "__grid": [26, 29],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0ABDE3",
                "iid": "a811b130-d380-11f0-aa69-8dfe35e006e9",
                "width": 16,
                "height": 16,
                "defUid": 21,
                "px": [416, 464],
                "fieldInstances": [{
                    "__identifier": "Transit_Station",
                    "__type": "LocalEnum.Transit_Station",
                    "__value": "Central_Hub",
                    "__tile": null,
                    "defUid": 34,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Central_Hub"]
                    }]
                }],
                "__worldX": 416,
                "__worldY": 464
            }, {
                "__identifier": "Transit_Station",
                "__grid": [10, 44],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0ABDE3",
                "iid": "b1b271c0-d380-11f0-aa69-a7b6233d3f5c",
                "width": 16,
                "height": 16,
                "defUid": 21,
                "px": [160, 704],
                "fieldInstances": [{
                    "__identifier": "Transit_Station",
                    "__type": "LocalEnum.Transit_Station",
                    "__value": "Seaside_Terminal",
                    "__tile": null,
                    "defUid": 34,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Seaside_Terminal"]
                    }]
                }],
                "__worldX": 160,
                "__worldY": 704
            }, {
                "__identifier": "Transit_Station",
                "__grid": [40, 44],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0ABDE3",
                "iid": "cc3d07d0-d380-11f0-aa69-5d85a2139348",
                "width": 16,
                "height": 16,
                "defUid": 21,
                "px": [640, 704],
                "fieldInstances": [{
                    "__identifier": "Transit_Station",
                    "__type": "LocalEnum.Transit_Station",
                    "__value": "Electro_Avenue",
                    "__tile": null,
                    "defUid": 34,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Electro_Avenue"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 704
            }, {
                "__identifier": "Transit_Station",
                "__grid": [40, 14],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0ABDE3",
                "iid": "d80cb650-d380-11f0-aa69-4336dfcd223e",
                "width": 16,
                "height": 16,
                "defUid": 21,
                "px": [640, 224],
                "fieldInstances": [{
                    "__identifier": "Transit_Station",
                    "__type": "LocalEnum.Transit_Station",
                    "__value": "District_S",
                    "__tile": null,
                    "defUid": 34,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["District_S"]
                    }]
                }],
                "__worldX": 640,
                "__worldY": 224
            }, {
                "__identifier": "Transit_Station",
                "__grid": [15, 14],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0ABDE3",
                "iid": "db4720d0-d380-11f0-aa69-1108be27df34",
                "width": 16,
                "height": 16,
                "defUid": 21,
                "px": [240, 224],
                "fieldInstances": [{
                    "__identifier": "Transit_Station",
                    "__type": "LocalEnum.Transit_Station",
                    "__value": "Frontier_Outpost",
                    "__tile": null,
                    "defUid": 34,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Frontier_Outpost"]
                    }]
                }],
                "__worldX": 240,
                "__worldY": 224
            }, {
                "__identifier": "Sea_Route",
                "__grid": [47, 32],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0099DB",
                "iid": "e4ba4c40-d380-11f0-aa69-9d2955e326a9",
                "width": 16,
                "height": 16,
                "defUid": 26,
                "px": [752, 512],
                "fieldInstances": [{
                    "__identifier": "Sea_Route",
                    "__type": "LocalEnum.Sea_Route",
                    "__value": "Neon_Cargo_Terminal",
                    "__tile": null,
                    "defUid": 27,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Neon_Cargo_Terminal"]
                    }]
                }],
                "__worldX": 752,
                "__worldY": 512
            }, {
                "__identifier": "Sea_Route",
                "__grid": [10, 47],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0099DB",
                "iid": "eadfa1b0-d380-11f0-aa69-41db24cea445",
                "width": 16,
                "height": 16,
                "defUid": 26,
                "px": [160, 752],
                "fieldInstances": [{
                    "__identifier": "Sea_Route",
                    "__type": "LocalEnum.Sea_Route",
                    "__value": "Sapphire_Marina",
                    "__tile": null,
                    "defUid": 27,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Sapphire_Marina"]
                    }]
                }],
                "__worldX": 160,
                "__worldY": 752
            }, {
                "__identifier": "Sea_Route",
                "__grid": [21, 30],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#0099DB",
                "iid": "fab59630-d380-11f0-aa69-e350f34bfc76",
                "width": 16,
                "height": 16,
                "defUid": 26,
                "px": [336, 480],
                "fieldInstances": [{
                    "__identifier": "Sea_Route",
                    "__type": "LocalEnum.Sea_Route",
                    "__value": "Restricted_Dock",
                    "__tile": null,
                    "defUid": 27,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Restricted_Dock"]
                    }]
                }],
                "__worldX": 336,
                "__worldY": 480
            }, {
                "__identifier": "Sky_Net",
                "__grid": [9, 8],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2FBEA2",
                "iid": "47d76010-d380-11f0-aa69-0fefc114ab4c",
                "width": 16,
                "height": 16,
                "defUid": 29,
                "px": [144, 128],
                "fieldInstances": [{
                    "__identifier": "Sky_Net",
                    "__type": "LocalEnum.Sky_Net",
                    "__value": "Summit_Dojo_POINT",
                    "__tile": null,
                    "defUid": 30,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Summit_Dojo_POINT"]
                    }]
                }],
                "__worldX": 144,
                "__worldY": 128
            }, {
                "__identifier": "Sky_Net",
                "__grid": [36, 7],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2FBEA2",
                "iid": "504b6070-d380-11f0-aa69-03838859bdba",
                "width": 16,
                "height": 16,
                "defUid": 29,
                "px": [576, 112],
                "fieldInstances": [{
                    "__identifier": "Sky_Net",
                    "__type": "LocalEnum.Sky_Net",
                    "__value": "Northern_Cemetery",
                    "__tile": null,
                    "defUid": 30,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Northern_Cemetery"]
                    }]
                }],
                "__worldX": 576,
                "__worldY": 112
            }, {
                "__identifier": "Lava_Line",
                "__grid": [14, 14],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#BE4A2F",
                "iid": "a8285b90-d380-11f0-aa69-855c5e48a02f",
                "width": 16,
                "height": 16,
                "defUid": 31,
                "px": [224, 224],
                "fieldInstances": [{
                    "__identifier": "Lava_Line",
                    "__type": "LocalEnum.Lava_Line",
                    "__value": "Lift_Station_Lower",
                    "__tile": null,
                    "defUid": 33,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Lift_Station_Lower"]
                    }]
                }],
                "__worldX": 224,
                "__worldY": 224
            }, {
                "__identifier": "Lava_Line",
                "__grid": [8, 9],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#BE4A2F",
                "iid": "b955c9c0-d380-11f0-aa69-29245375fdcf",
                "width": 16,
                "height": 16,
                "defUid": 31,
                "px": [128, 144],
                "fieldInstances": [{
                    "__identifier": "Lava_Line",
                    "__type": "LocalEnum.Lava_Line",
                    "__value": "Lift_Station_Upper",
                    "__tile": null,
                    "defUid": 33,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Lift_Station_Upper"]
                    }]
                }],
                "__worldX": 128,
                "__worldY": 144
            }, {
                "__identifier": "Sky_Net",
                "__grid": [24, 21],
                "__pivot": [0, 0],
                "__tags": [],
                "__tile": null,
                "__smartColor": "#2FBEA2",
                "iid": "19a824d0-d380-11f0-aa69-3fc9fe9cae67",
                "width": 16,
                "height": 16,
                "defUid": 29,
                "px": [384, 336],
                "fieldInstances": [{
                    "__identifier": "Sky_Net",
                    "__type": "LocalEnum.Sky_Net",
                    "__value": "Zenith_HQ",
                    "__tile": null,
                    "defUid": 30,
                    "realEditorValues": [{
                        "id": "V_String",
                        "params": ["Zenith_HQ"]
                    }]
                }],
                "__worldX": 384,
                "__worldY": 336
            }]
        }, {
            "__identifier": "Infrastructure",
            "__type": "IntGrid",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 1,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "04a6ba50-d380-11f0-aa69-674f4ca5b761",
            "levelId": 0,
            "layerDefUid": 17,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            "autoLayerTiles": [],
            "seed": 2746226,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": []
        }, {
            "__identifier": "Underground_Access",
            "__type": "IntGrid",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 1,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "95a38510-d380-11f0-aa69-ebfb1c021054",
            "levelId": 0,
            "layerDefUid": 7,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 6, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 6, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 0, 6, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 6, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            "autoLayerTiles": [],
            "seed": 4360011,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": []
        }, {
            "__identifier": "Obstacles",
            "__type": "IntGrid",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 0.2,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "8b4e7430-d380-11f0-aa69-d37b3c6aca7d",
            "levelId": 0,
            "layerDefUid": 3,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            "autoLayerTiles": [],
            "seed": 981471,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": []
        }, {
            "__identifier": "Traversability",
            "__type": "IntGrid",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 0.8,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "48700f50-d380-11f0-aa69-555b100d60dd",
            "levelId": 0,
            "layerDefUid": 5,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 5, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 5, 5, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            "autoLayerTiles": [],
            "seed": 2337735,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": []
        }, {
            "__identifier": "Threat",
            "__type": "IntGrid",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 0.8,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "cea56ad0-d380-11f0-aa69-d32525d17e57",
            "levelId": 0,
            "layerDefUid": 4,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 5, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 3, 3, 3, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 1, 1, 3, 4, 4, 4, 5, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 3, 3, 3, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 3, 3, 3, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 3, 3, 3, 4, 3, 3, 3, 3, 3, 2, 3, 2, 3, 3, 3, 3, 4, 4, 3, 3, 3, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 1, 1, 2, 2, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 3, 3, 3, 3, 4, 4, 3, 3, 2, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 2, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 2, 2, 3, 1, 1, 1, 1, 2, 2, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 4, 4, 3, 3, 2, 3, 3, 3, 3, 4, 5, 5, 4, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 2, 2, 2, 1, 1, 1, 1, 2, 2, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 3, 3, 3, 4, 4, 3, 3, 2, 2, 3, 3, 3, 3, 4, 5, 4, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 3, 3, 3, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 4, 3, 3, 2, 3, 3, 3, 3, 3, 3, 4, 3, 3, 2, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 4, 3, 3, 2, 3, 3, 3, 3, 3, 4, 4, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 4, 3, 3, 2, 3, 3, 3, 3, 4, 4, 4, 4, 3, 3, 2, 2, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 4, 3, 3, 2, 3, 3, 3, 3, 4, 4, 4, 4, 3, 3, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3, 4, 4, 5, 5, 4, 4, 4, 3, 3, 3, 3, 2, 2, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 2, 2, 3, 3, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 4, 3, 3, 3, 2, 2, 3, 3, 3, 3, 3, 3, 3, 4, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 4, 3, 3, 3, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 6, 6, 6, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 4, 3, 3, 3, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 2, 2, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 2, 2, 2, 3, 2, 2, 2, 2, 2, 3, 4, 3, 3, 3, 2, 2, 3, 3, 3, 2, 3, 3, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 2, 2, 3, 3, 3, 2, 2, 2, 2, 3, 4, 3, 3, 3, 2, 2, 3, 3, 2, 2, 2, 3, 3, 3, 3, 3, 2, 2, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 2, 2, 2, 3, 2, 3, 3, 3, 3, 2, 2, 2, 2, 3, 4, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 1, 2, 3, 3, 4, 4, 3, 3, 2, 2, 2, 2, 3, 4, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 6, 6, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 1, 2, 3, 3, 3, 4, 3, 3, 3, 2, 2, 2, 3, 4, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 6, 6, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 1, 2, 2, 3, 3, 3, 3, 3, 3, 2, 2, 2, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 6, 6, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 1, 2, 2, 3, 3, 3, 3, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 6, 6, 1, 1, 1, 1, 6, 6, 6, 6, 6, 1, 6, 6, 1, 1, 1, 1, 1, 1, 2, 2, 3, 3, 3, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 2, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 3, 2, 2, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 6, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 3, 2, 2, 2, 1, 2, 2, 3, 4, 3, 3, 3, 2, 1, 1, 1, 1, 2, 2, 3, 3, 3, 3, 3, 2, 2, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 1, 6, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 3, 2, 2, 2, 1, 1, 1, 2, 2, 4, 3, 3, 3, 2, 1, 1, 1, 1, 2, 2, 3, 3, 3, 3, 3, 2, 2, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 3, 4, 3, 3, 3, 2, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 2, 3, 4, 3, 3, 3, 2, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 2, 2, 1, 1, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, 3, 4, 4, 3, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 4, 2, 2, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 2, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, 4, 5, 4, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 4, 2, 2, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 4, 4, 4, 3, 2, 1, 1, 1, 1, 1, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 3, 3, 3, 2, 2, 1, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 2, 3, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 4, 4, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 4, 4, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 4, 4, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4],
            "autoLayerTiles": [],
            "seed": 5320815,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": []
        }, {
            "__identifier": "Regions",
            "__type": "IntGrid",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 0.3,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "51f7a9c0-d380-11f0-8216-1f18ae51919c",
            "levelId": 0,
            "layerDefUid": 1,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": false,
            "optionalRules": [],
            "intGridCsv": [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 2, 2, 2, 2, 2, 2, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            "autoLayerTiles": [],
            "seed": 376807,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": []
        }, {
            "__identifier": "Surface",
            "__type": "IntGrid",
            "__cWid": 52,
            "__cHei": 52,
            "__gridSize": 16,
            "__opacity": 1,
            "__pxTotalOffsetX": 0,
            "__pxTotalOffsetY": 0,
            "__tilesetDefUid": null,
            "__tilesetRelPath": null,
            "iid": "b4b45040-d380-11f0-8216-e1b03cccdc0e",
            "levelId": 0,
            "layerDefUid": 2,
            "pxOffsetX": 0,
            "pxOffsetY": 0,
            "visible": true,
            "optionalRules": [],
            "intGridCsv": [24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 6, 6, 6, 6, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 6, 6, 6, 1, 1, 1, 1, 6, 6, 3, 3, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 4, 4, 4, 4, 4, 4, 4, 4, 23, 23, 23, 24, 24, 23, 23, 23, 23, 23, 23, 23, 6, 6, 1, 1, 1, 1, 6, 6, 3, 3, 3, 3, 23, 23, 3, 23, 23, 23, 23, 23, 3, 3, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 4, 4, 4, 4, 4, 4, 23, 22, 23, 22, 24, 22, 23, 22, 22, 23, 23, 23, 23, 6, 6, 1, 1, 1, 1, 6, 6, 3, 26, 26, 26, 26, 27, 23, 26, 23, 3, 23, 23, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 22, 22, 22, 4, 4, 4, 4, 4, 22, 22, 22, 22, 22, 7, 22, 22, 23, 22, 22, 23, 22, 23, 6, 6, 1, 1, 1, 1, 6, 6, 26, 3, 26, 27, 27, 27, 27, 26, 26, 3, 26, 26, 26, 17, 4, 3, 4, 4, 4, 4, 3, 3, 3, 3, 3, 22, 22, 4, 4, 4, 21, 21, 22, 22, 22, 7, 7, 22, 21, 21, 22, 22, 22, 10, 6, 6, 1, 1, 1, 1, 6, 6, 26, 27, 27, 27, 23, 23, 23, 23, 26, 26, 27, 27, 26, 17, 17, 4, 17, 17, 17, 4, 3, 3, 11, 3, 10, 10, 22, 4, 4, 4, 4, 21, 21, 21, 22, 22, 9, 22, 22, 21, 21, 21, 22, 22, 6, 6, 1, 1, 1, 1, 6, 6, 26, 27, 26, 26, 27, 27, 27, 27, 23, 27, 27, 27, 26, 4, 17, 17, 17, 17, 17, 4, 4, 3, 11, 11, 11, 10, 22, 22, 4, 4, 4, 4, 21, 22, 22, 9, 9, 21, 22, 21, 21, 10, 10, 10, 6, 6, 1, 1, 1, 1, 6, 6, 27, 27, 26, 26, 27, 28, 28, 28, 27, 23, 27, 26, 4, 4, 17, 4, 17, 17, 4, 4, 4, 3, 3, 11, 11, 10, 22, 22, 4, 4, 4, 4, 21, 21, 22, 9, 22, 21, 21, 21, 10, 10, 11, 10, 6, 6, 1, 1, 1, 1, 6, 6, 27, 26, 3, 26, 26, 27, 28, 28, 27, 26, 26, 17, 4, 17, 4, 4, 4, 4, 4, 4, 4, 3, 3, 11, 11, 10, 10, 22, 22, 4, 4, 4, 4, 22, 9, 9, 21, 21, 21, 10, 11, 11, 11, 15, 6, 6, 1, 1, 1, 1, 6, 6, 27, 26, 25, 26, 26, 26, 27, 28, 27, 26, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 11, 22, 22, 22, 22, 22, 22, 22, 22, 7, 9, 22, 22, 21, 10, 10, 11, 11, 11, 15, 6, 6, 1, 1, 1, 1, 6, 6, 27, 26, 25, 3, 26, 26, 27, 27, 26, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 25, 25, 3, 3, 3, 11, 11, 10, 22, 22, 22, 10, 10, 7, 7, 22, 22, 10, 10, 11, 11, 11, 11, 11, 10, 6, 6, 1, 1, 1, 1, 6, 6, 26, 26, 25, 25, 3, 26, 27, 26, 26, 17, 4, 4, 4, 4, 4, 4, 4, 4, 3, 25, 25, 25, 11, 11, 11, 16, 11, 10, 10, 11, 11, 7, 7, 10, 10, 4, 4, 11, 11, 11, 11, 11, 11, 10, 6, 6, 1, 1, 1, 1, 6, 6, 26, 26, 25, 3, 25, 3, 26, 26, 3, 26, 17, 17, 4, 17, 17, 4, 4, 4, 3, 3, 25, 25, 3, 11, 11, 16, 11, 10, 10, 10, 7, 7, 10, 10, 4, 4, 4, 4, 10, 10, 10, 10, 10, 21, 9, 6, 1, 1, 1, 1, 6, 6, 26, 25, 25, 3, 3, 25, 3, 3, 3, 3, 3, 17, 17, 17, 17, 17, 17, 4, 3, 3, 3, 3, 11, 11, 16, 16, 16, 11, 11, 7, 7, 10, 10, 10, 4, 4, 4, 21, 21, 10, 21, 21, 21, 21, 9, 9, 1, 1, 1, 1, 6, 6, 26, 25, 25, 25, 25, 25, 25, 3, 25, 3, 25, 25, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 11, 16, 16, 16, 16, 10, 7, 7, 10, 10, 21, 21, 21, 21, 17, 17, 17, 17, 17, 17, 17, 17, 9, 9, 1, 1, 1, 1, 6, 6, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 25, 25, 3, 25, 25, 3, 3, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 16, 10, 10, 21, 21, 21, 21, 21, 17, 17, 17, 21, 21, 21, 21, 9, 6, 1, 1, 1, 1, 6, 6, 25, 25, 25, 25, 10, 10, 10, 25, 25, 25, 25, 25, 25, 25, 25, 3, 3, 7, 7, 10, 10, 10, 10, 10, 10, 7, 7, 7, 7, 16, 16, 10, 21, 21, 17, 21, 21, 21, 17, 21, 21, 21, 10, 10, 6, 6, 1, 1, 1, 1, 6, 6, 25, 25, 25, 10, 7, 7, 7, 10, 25, 4, 4, 4, 25, 25, 25, 25, 7, 7, 10, 4, 4, 4, 4, 4, 4, 10, 7, 7, 7, 7, 16, 10, 21, 21, 17, 17, 17, 21, 21, 17, 17, 10, 10, 10, 6, 6, 1, 1, 1, 1, 6, 6, 15, 25, 25, 25, 10, 7, 10, 10, 25, 4, 25, 25, 25, 25, 25, 7, 7, 10, 4, 4, 4, 4, 4, 4, 4, 4, 10, 7, 7, 7, 7, 7, 7, 9, 17, 17, 17, 21, 21, 21, 21, 10, 10, 10, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 25, 25, 25, 10, 25, 25, 25, 25, 25, 25, 25, 25, 7, 7, 10, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 10, 7, 7, 16, 2, 10, 9, 9, 9, 17, 21, 17, 17, 21, 21, 10, 10, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 10, 25, 25, 25, 25, 25, 25, 25, 25, 25, 10, 10, 7, 10, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 7, 16, 2, 10, 10, 21, 9, 17, 17, 17, 17, 21, 17, 21, 21, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 10, 10, 10, 10, 25, 25, 25, 10, 10, 10, 10, 10, 7, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 10, 4, 7, 16, 2, 10, 10, 21, 9, 9, 9, 9, 9, 9, 21, 21, 21, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 7, 4, 4, 4, 10, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 7, 2, 2, 2, 10, 21, 17, 17, 21, 21, 21, 9, 9, 9, 9, 9, 6, 1, 1, 1, 1, 6, 6, 15, 10, 10, 10, 10, 11, 11, 11, 11, 11, 11, 11, 10, 10, 7, 10, 4, 10, 4, 10, 4, 4, 4, 4, 4, 4, 10, 4, 4, 7, 7, 2, 2, 10, 4, 10, 10, 10, 21, 21, 21, 21, 21, 21, 9, 6, 1, 1, 1, 1, 6, 6, 15, 4, 10, 10, 11, 11, 16, 16, 16, 16, 16, 11, 10, 10, 7, 10, 4, 4, 4, 4, 4, 4, 4, 4, 4, 10, 12, 10, 10, 7, 10, 2, 10, 4, 4, 4, 4, 4, 4, 17, 17, 21, 21, 15, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 11, 11, 11, 16, 16, 16, 16, 16, 16, 11, 10, 10, 7, 10, 4, 4, 4, 4, 10, 4, 4, 4, 4, 12, 12, 12, 10, 7, 10, 10, 10, 4, 4, 4, 10, 17, 17, 17, 17, 17, 4, 15, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 11, 16, 16, 16, 16, 16, 16, 16, 16, 11, 4, 10, 7, 7, 10, 10, 4, 10, 4, 4, 4, 4, 4, 10, 12, 10, 7, 7, 10, 10, 4, 4, 4, 4, 10, 17, 17, 17, 17, 10, 4, 4, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 11, 16, 16, 16, 16, 16, 16, 16, 16, 11, 11, 10, 10, 7, 7, 10, 4, 4, 4, 4, 4, 4, 4, 4, 10, 7, 7, 10, 10, 10, 4, 4, 4, 10, 17, 17, 17, 17, 10, 4, 4, 4, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 11, 16, 16, 16, 16, 16, 16, 16, 16, 16, 11, 11, 10, 10, 7, 7, 10, 4, 4, 4, 4, 4, 10, 10, 7, 7, 10, 10, 10, 4, 19, 4, 10, 4, 18, 17, 17, 17, 4, 4, 4, 4, 6, 6, 1, 1, 1, 1, 6, 6, 15, 11, 11, 11, 16, 16, 16, 16, 16, 13, 13, 13, 13, 11, 11, 10, 7, 7, 7, 10, 10, 10, 10, 10, 10, 7, 7, 10, 10, 10, 4, 4, 19, 4, 4, 4, 18, 18, 17, 17, 17, 4, 4, 4, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 11, 11, 11, 16, 16, 16, 13, 13, 13, 13, 13, 13, 13, 7, 7, 10, 7, 7, 7, 7, 7, 7, 7, 7, 7, 10, 10, 4, 4, 4, 4, 4, 4, 4, 18, 10, 18, 17, 4, 4, 4, 4, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 10, 10, 11, 16, 16, 13, 13, 13, 13, 13, 7, 7, 7, 7, 10, 10, 4, 10, 10, 10, 10, 10, 10, 10, 10, 10, 4, 4, 4, 4, 4, 4, 19, 4, 18, 4, 10, 17, 4, 4, 4, 4, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 10, 10, 11, 11, 16, 13, 13, 13, 13, 13, 13, 7, 7, 13, 16, 16, 4, 16, 16, 16, 16, 16, 10, 10, 10, 4, 4, 7, 4, 18, 18, 19, 18, 17, 18, 17, 4, 17, 4, 10, 4, 4, 6, 6, 1, 1, 1, 1, 6, 6, 15, 4, 10, 10, 10, 11, 16, 16, 13, 13, 13, 7, 7, 7, 13, 13, 16, 4, 4, 4, 16, 16, 11, 10, 10, 19, 19, 4, 4, 7, 7, 19, 18, 18, 18, 18, 17, 17, 17, 4, 4, 10, 10, 4, 6, 6, 1, 1, 1, 1, 6, 6, 15, 4, 10, 10, 10, 11, 11, 11, 16, 16, 13, 7, 7, 7, 7, 13, 4, 4, 4, 4, 16, 2, 11, 11, 10, 10, 19, 4, 10, 4, 7, 4, 19, 18, 18, 18, 18, 17, 17, 4, 19, 10, 10, 15, 6, 6, 1, 1, 1, 1, 6, 6, 15, 4, 14, 4, 4, 12, 12, 11, 11, 11, 7, 7, 7, 7, 13, 13, 4, 4, 4, 4, 16, 2, 11, 11, 10, 10, 19, 4, 4, 4, 19, 19, 4, 18, 18, 18, 18, 17, 17, 4, 19, 10, 10, 15, 6, 6, 1, 1, 1, 1, 6, 6, 15, 4, 14, 4, 4, 4, 12, 12, 12, 11, 7, 7, 20, 20, 16, 16, 16, 4, 16, 16, 16, 2, 11, 11, 10, 19, 19, 4, 4, 4, 10, 4, 4, 18, 18, 18, 18, 17, 17, 4, 19, 11, 16, 10, 6, 6, 1, 1, 1, 1, 6, 6, 15, 4, 4, 4, 14, 4, 12, 12, 12, 11, 7, 20, 20, 16, 16, 16, 16, 16, 16, 16, 2, 11, 4, 4, 4, 19, 19, 19, 11, 4, 4, 4, 4, 4, 18, 18, 17, 17, 17, 4, 4, 16, 16, 16, 6, 6, 1, 1, 1, 1, 6, 6, 15, 4, 4, 4, 14, 14, 14, 12, 12, 10, 7, 20, 20, 16, 16, 16, 16, 16, 16, 11, 11, 4, 4, 4, 4, 4, 10, 19, 10, 10, 4, 4, 4, 4, 4, 17, 17, 17, 17, 17, 4, 11, 16, 10, 6, 6, 1, 1, 1, 1, 6, 6, 15, 4, 4, 4, 14, 14, 14, 10, 10, 10, 7, 20, 20, 16, 16, 16, 11, 11, 11, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 10, 11, 4, 4, 17, 19, 4, 17, 4, 4, 17, 11, 10, 15, 6, 6, 1, 1, 1, 1, 6, 6, 15, 4, 4, 4, 4, 14, 14, 10, 10, 11, 7, 20, 20, 16, 16, 11, 11, 11, 11, 10, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 10, 4, 4, 10, 4, 4, 19, 4, 19, 4, 11, 10, 15, 6, 6, 1, 1, 1, 1, 6, 6, 15, 4, 4, 4, 4, 4, 4, 4, 4, 4, 7, 20, 20, 11, 11, 11, 10, 10, 10, 10, 10, 4, 4, 4, 4, 4, 4, 4, 4, 4, 10, 4, 4, 10, 4, 4, 4, 4, 4, 4, 4, 10, 10, 15, 6, 6, 1, 1, 1, 1, 6, 6, 15, 10, 4, 4, 10, 4, 4, 4, 4, 11, 7, 20, 20, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 4, 4, 4, 4, 10, 10, 10, 10, 4, 4, 4, 4, 19, 19, 19, 4, 4, 10, 10, 10, 10, 6, 6, 1, 1, 1, 1, 6, 6, 15, 15, 4, 4, 4, 4, 4, 4, 4, 15, 7, 20, 20, 10, 15, 15, 15, 10, 10, 10, 10, 10, 10, 10, 4, 4, 4, 4, 10, 10, 10, 10, 4, 4, 10, 10, 10, 10, 10, 10, 10, 10, 15, 15, 6, 6, 1, 1, 1, 1, 6, 6, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 7, 20, 10, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 10, 10, 15, 15, 15, 15, 15, 15, 15, 10, 10, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 6, 6, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            "autoLayerTiles": [],
            "seed": 649137,
            "overrideTilesetUid": null,
            "gridTiles": [],
            "entityInstances": []
        }],
        "__neighbours": []
    }],
    "worlds": [],
    "dummyWorldIid": "df3c2c30-d380-11f0-8216-6948511eea50"
}]]></file>
        <file name="move-constants.js"><![CDATA[/**
 * =============================================
 * MOVE CONSTANTS - æ‹›å¼ç¡¬ç¼–ç æ•°æ® (ç²¾ç®€ç‰ˆ)
 * =============================================
 * 
 * æœ¬æ–‡ä»¶ä»…ä¿ç•™ PS moves-data.js ä¸­æ²¡æœ‰çš„æ•°æ®ã€‚
 * 
 * å·²è¿ç§»åˆ° moves-data.js çš„å±æ€§ï¼š
 * - priority â†’ move.priority
 * - recoil â†’ move.recoil
 * - drain â†’ move.drain
 * - willCrit â†’ move.willCrit
 * - boosts â†’ move.boosts
 * - status â†’ move.status
 * - heal flag â†’ move.flags.heal
 */
// ============================================
// 1. æŸç¼šç±»æŠ€èƒ½ (Trapping Moves)
// ============================================
// PS æ²¡æœ‰ç›´æ¥çš„ flagï¼Œéœ€è¦ä¿ç•™
export const TRAPPING_MOVES = [
    'Fire Spin',
    'Whirlpool',
    'Bind',
    'Wrap',
    'Sand Tomb',
    'Magma Storm',
    'Infestation',
    'Clamp',
    'Snap Trap',
    'Thunder Cage'
];
// ============================================
// 2. AI è¯„åˆ†ç”¨ - å®ˆä½æŠ€èƒ½åˆ—è¡¨ (Protect Moves)
// ============================================
// PS æ²¡æœ‰ç›´æ¥çš„ flagï¼Œéœ€è¦ä¿ç•™
export const AI_PROTECT_MOVES = [
    'Protect',
    'Detect',
    'King\'s Shield',
    'Spiky Shield',
    'Baneful Bunker',
    'Obstruct',
    'Silk Trap',
    'Max Guard'
];
// ============================================
// 3. å®å¯æ¢¦å½¢æ€åç¼€ (Form Suffixes)
// ============================================
// ç”¨äº extractBaseFormId() å‡½æ•°
export const FORM_SUFFIXES = [
    'starter',      // æ­æ¡£å½¢æ€ (Let's Go)
    'gmax',         // æå·¨åŒ–
    'megax', 'megay', 'mega',  // Megaè¿›åŒ–
    'alola', 'galar', 'hisui', 'paldea',  // åœ°åŒºå½¢æ€
    'therian', 'incarnate',  // çµå…½/åŒ–èº«
    'origin', 'altered',     // èµ·æº/å¦ä¸€å½¢æ€
    'crowned', 'hero',       // ç‹å† /è‹±é›„
    'eternamax',    // æ— æå·¨åŒ–
    'primal',       // åŸå§‹å›å½’
    'ultra',        // ç©¶æ
    'ash',          // å°æ™ºç‰ˆ
    'totem',        // éœ¸ä¸»
    'cosplay', 'phd', 'libre', 'popstar', 'rockstar', 'belle', // çš®å¡ä¸˜æ¢è£…
    'original', 'hoenn', 'sinnoh', 'unova', 'kalos', 'partner', 'world'  // å¸½å­çš®å¡ä¸˜
];
// ============================================
// 4. é»˜è®¤åå¤‡æ‹›å¼ (Fallback Moves)
// ============================================
export const FALLBACK_MOVES = [
    'Tackle',
    'Quick Attack',
    'Ember',
    'Water Gun',
    'Vine Whip'
];
// ============================================
// 5. è¶…æå·¨åŒ–å› å­é€ŸæŸ¥è¡¨ (G-Max Species Data)
// ============================================
// Key: å®å¯æ¢¦ Species ID (å°å†™æ— ç¬¦å·)
// Value: { move: ä¸“å±æ‹›å¼å, type: è§¦å‘å±æ€§, cn: ä¸­æ–‡æ‹›å¼å }
export const GMAX_SPECIES_DATA = {
    // ================= å…³éƒ½åœ°åŒº (Gen 1) =================
    'venusaur':         { move: 'G-Max Vine Lash',    type: 'Grass',    cn: 'è¶…æå·¨ç°é£é­ç­' },   // å¦™è›™èŠ±
    'charizard':        { move: 'G-Max Wildfire',     type: 'Fire',     cn: 'è¶…æå·¨æ·±æ¸Šç­ç„°' },   // å–·ç«é¾™
    'blastoise':        { move: 'G-Max Cannonade',    type: 'Water',    cn: 'è¶…æå·¨æ°´ç‚®è½°ç­' },   // æ°´ç®­é¾Ÿ
    'butterfree':       { move: 'G-Max Befuddle',     type: 'Bug',      cn: 'è¶…æå·¨è¶å½±è›Šæƒ‘' },   // å·´å¤§è¶
    'pikachu':          { move: 'G-Max Volt Crash',   type: 'Electric', cn: 'è¶…æå·¨ä¸‡é›·è½°é¡¶' },   // çš®å¡ä¸˜
    'meowth':           { move: 'G-Max Gold Rush',    type: 'Normal',   cn: 'è¶…æå·¨ç‰¹å¤§é‡‘å¸' },   // å–µå–µ
    'machamp':          { move: 'G-Max Chi Strike',   type: 'Fighting', cn: 'è¶…æå·¨ä¼šå¿ƒä¸€å‡»' },   // æ€ªåŠ›
    'gengar':           { move: 'G-Max Terror',       type: 'Ghost',    cn: 'è¶…æå·¨å¹»å½±å¹½é­‚' },   // è€¿é¬¼
    'kingler':          { move: 'G-Max Foam Burst',   type: 'Water',    cn: 'è¶…æå·¨æ¿€æ¼©æ³¡æ¶¡' },   // å·¨é’³èŸ¹
    'lapras':           { move: 'G-Max Resonance',    type: 'Ice',      cn: 'è¶…æå·¨æå…‰æ—‹å¾‹' },   // æ‹‰æ™®æ‹‰æ–¯ (å†°ç³»è§¦å‘)
    'eevee':            { move: 'G-Max Cuddle',       type: 'Normal',   cn: 'è¶…æå·¨çƒ­æƒ…æ‹¥æŠ±' },   // ä¼Šå¸ƒ
    'snorlax':          { move: 'G-Max Replenish',    type: 'Normal',   cn: 'è¶…æå·¨èµ„æºå†ç”Ÿ' },   // å¡æ¯”å…½
    // ================= åˆä¼—åœ°åŒº (Gen 5) =================
    'garbodor':         { move: 'G-Max Malodor',      type: 'Poison',   cn: 'è¶…æå·¨è‡­æ°”å†²å¤©' },   // ç°å°˜å±±
    // ================= é˜¿ç½—æ‹‰åœ°åŒº (Gen 7) =================
    'melmetal':         { move: 'G-Max Meltdown',     type: 'Steel',    cn: 'è¶…æå·¨æ¶²é‡‘ç†”å‡»' },   // ç¾å½•æ¢…å¡”
    // ================= ä¼½å‹’å°”åœ°åŒº (Gen 8) =================
    'rillaboom':        { move: 'G-Max Drum Solo',    type: 'Grass',    cn: 'è¶…æå·¨ç‹‚æ“‚ä¹±æ‰“' },   // è½°æ“‚é‡‘åˆšçŒ©
    'cinderace':        { move: 'G-Max Fireball',     type: 'Fire',     cn: 'è¶…æå·¨ç ´é˜µç«çƒ' },   // é—ªç„°ç‹ç‰Œ
    'inteleon':         { move: 'G-Max Hydrosnipe',   type: 'Water',    cn: 'è¶…æå·¨ç‹™å‡»ç¥å°„' },   // åƒé¢é¿å½¹
    'corviknight':      { move: 'G-Max Wind Rage',    type: 'Flying',   cn: 'è¶…æå·¨æ—‹é£è¢­å·' },   // é’¢é“ é¸¦
    'orbeetle':         { move: 'G-Max Gravitas',     type: 'Psychic',  cn: 'è¶…æå·¨å¤©é“ä¸ƒæ˜Ÿ' },   // ä»¥æ¬§è·¯æ™®
    'drednaw':          { move: 'G-Max Stonesurge',   type: 'Water',    cn: 'è¶…æå·¨å²©é˜µä»¥å¾…' },   // æš´å™¬é¾Ÿ
    'coalossal':        { move: 'G-Max Volcalith',    type: 'Rock',     cn: 'è¶…æå·¨ç‚çŸ³å–·å‘' },   // å·¨ç‚­å±±
    'flapple':          { move: 'G-Max Tartness',     type: 'Grass',    cn: 'è¶…æå·¨é…¸ä¸æºœä¸¢' },   // è‹¹è£¹é¾™
    'appletun':         { move: 'G-Max Sweetness',    type: 'Grass',    cn: 'è¶…æå·¨ç¼æµ†ç‰æ¶²' },   // ä¸°èœœé¾™
    'sandaconda':       { move: 'G-Max Sandblast',    type: 'Ground',   cn: 'è¶…æå·¨æ²™å°˜æ¼«å¤©' },   // æ²™èºèŸ’
    'toxtricity':       { move: 'G-Max Stun Shock',   type: 'Electric', cn: 'è¶…æå·¨å¼‚æ¯’ç”µåœº' },   // é¢¤å¼¦è¾èˆ (é«˜è°ƒ)
    'toxtricitylowkey': { move: 'G-Max Stun Shock',   type: 'Electric', cn: 'è¶…æå·¨å¼‚æ¯’ç”µåœº' },   // é¢¤å¼¦è¾èˆ (ä½è°ƒ)
    'centiskorch':      { move: 'G-Max Centiferno',   type: 'Fire',     cn: 'è¶…æå·¨ç™¾ç«ç„šé‡' },   // ç„šç„°èš£
    'hatterene':        { move: 'G-Max Smite',        type: 'Fairy',    cn: 'è¶…æå·¨å¤©è°´é›·è¯›' },   // å¸ƒè‰å§†æ¸©
    'grimmsnarl':       { move: 'G-Max Snooze',       type: 'Dark',     cn: 'è¶…æå·¨ç¡é­”é™ä¸´' },   // é•¿æ¯›å·¨é­”
    'alcremie':         { move: 'G-Max Finale',       type: 'Fairy',    cn: 'è¶…æå·¨å¹¸ç¦åœ†æ»¡' },   // éœœå¥¶ä»™
    'copperajah':       { move: 'G-Max Steelsurge',   type: 'Steel',    cn: 'è¶…æå·¨é’¢é“é˜µæ³•' },   // å¤§ç‹é“œè±¡
    'duraludon':        { move: 'G-Max Depletion',    type: 'Dragon',   cn: 'è¶…æå·¨åŠ£åŒ–è¡°å˜' },   // é“é’¢é¾™
    // ================= æ­¦é“ç†Šå¸ˆ (Urshifu) =================
    'urshifu':             { move: 'G-Max One Blow',   type: 'Dark',    cn: 'è¶…æå·¨å¤ºå‘½ä¸€å‡»' },   // ä¸€å‡»æµ (é»˜è®¤)
    'urshifusinglestrike': { move: 'G-Max One Blow',   type: 'Dark',    cn: 'è¶…æå·¨å¤ºå‘½ä¸€å‡»' },   // ä¸€å‡»æµ
    'urshifurapidstrike':  { move: 'G-Max Rapid Flow', type: 'Water',   cn: 'è¶…æå·¨æµæ°´è¿å‡»' }    // è¿å‡»æµ
};
// ============================================
// 6. é€šç”¨æå·¨æ‹›å¼æ˜ å°„è¡¨ (Generic Max Moves by Type)
// ============================================
export const GENERIC_MAX_BY_TYPE = {
    'Normal':   'Max Strike',
    'Fire':     'Max Flare',
    'Water':    'Max Geyser',
    'Electric': 'Max Lightning',
    'Grass':    'Max Overgrowth',
    'Ice':      'Max Hailstorm',
    'Fighting': 'Max Knuckle',
    'Poison':   'Max Ooze',
    'Ground':   'Max Quake',
    'Flying':   'Max Airstream',
    'Psychic':  'Max Mindstorm',
    'Bug':      'Max Flutterby',
    'Rock':     'Max Rockfall',
    'Ghost':    'Max Phantasm',
    'Dragon':   'Max Wyrmwind',
    'Dark':     'Max Darkness',
    'Steel':    'Max Steelspike',
    'Fairy':    'Max Starfall'
};
// ============================================
// 7. é€šç”¨æå·¨æ‹›å¼ä¸­æ–‡åæ˜ å°„
// ============================================
export const GENERIC_MAX_CN = {
    'Max Strike':    'æå·¨æ”»å‡»',
    'Max Flare':     'æå·¨ç«çˆ†',
    'Max Geyser':    'æå·¨æ°´æµ',
    'Max Lightning': 'æå·¨é—ªç”µ',
    'Max Overgrowth':'æå·¨è‰åŸ',
    'Max Hailstorm': 'æå·¨å¯’å†°',
    'Max Knuckle':   'æå·¨æ‹³æ–—',
    'Max Ooze':      'æå·¨é…¸æ¯’',
    'Max Quake':     'æå·¨å¤§åœ°',
    'Max Airstream': 'æå·¨é£å†²',
    'Max Mindstorm': 'æå·¨è¶…èƒ½',
    'Max Flutterby': 'æå·¨è™«è›Š',
    'Max Rockfall':  'æå·¨å²©çŸ³',
    'Max Phantasm':  'æå·¨å¹½é­‚',
    'Max Wyrmwind':  'æå·¨é¾™éª‘',
    'Max Darkness':  'æå·¨æ¶éœ¸',
    'Max Steelspike':'æå·¨é’¢é“',
    'Max Starfall':  'æå·¨å¦–ç²¾',
    'Max Guard':     'æå·¨é˜²å£'
};
// ============================================
// å¯¼å‡ºåˆ°å…¨å±€ (Export to Window)
// ============================================
if (typeof window !== 'undefined') {
    window.MOVE_CONSTANTS = {
        TRAPPING_MOVES,
        AI_PROTECT_MOVES,
        FORM_SUFFIXES,
        FALLBACK_MOVES,
        GMAX_SPECIES_DATA,
        GENERIC_MAX_BY_TYPE,
        GENERIC_MAX_CN
    };
    // å•ç‹¬å¯¼å‡ºå¸¸ç”¨çš„
    window.TRAPPING_MOVES = TRAPPING_MOVES;
    window.AI_PROTECT_MOVES = AI_PROTECT_MOVES;
    window.FORM_SUFFIXES = FORM_SUFFIXES;
    window.FALLBACK_MOVES = FALLBACK_MOVES;
    window.GMAX_SPECIES_DATA = GMAX_SPECIES_DATA;
    window.GENERIC_MAX_BY_TYPE = GENERIC_MAX_BY_TYPE;
    window.GENERIC_MAX_CN = GENERIC_MAX_CN;
}
]]></file>
        <file name="moves-data.js"><![CDATA[/**
 * Pokemon Showdown Moves Data
 * è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘
 * æ¥æº: https://github.com/smogon/pokemon-showdown/blob/master/data/moves.ts
 * 
 * æ³¨æ„: å‡½æ•°å›è°ƒã€condition å—å·²è¢«ç§»é™¤ï¼Œä»…ä¿ç•™é™æ€æ•°æ®
 * 
 * ä½¿ç”¨æ–¹æ³•:
 *   ES Module: import { MOVES } from './moves-data.js';
 *   Script:    <script src="moves-data.js"></script>
 */
export const MOVES = {
	"10000000voltthunderbolt": {
		num: 719,
		accuracy: true,
		basePower: 195,
		category: "Special",
		isNonstandard: "Past",
		name: "10,000,000 Volt Thunderbolt",
		pp: 1,
		priority: 0,
		flags: {},
		isZ: "pikashuniumz",
		critRatio: 3,
		secondary: null,
		target: "normal",
		type: "Electric",
		contestType: "Cool",
	},
	absorb: {
		num: 71,
		accuracy: 100,
		basePower: 20,
		category: "Special",
		name: "Absorb",
		pp: 25,
		priority: 0,
		flags: { protect: 1, mirror: 1, heal: 1, metronome: 1 },
		drain: [1, 2],
		secondary: null,
		target: "normal",
		type: "Grass",
		contestType: "Clever",
	},
	accelerock: {
		num: 709,
		accuracy: 100,
		basePower: 40,
		category: "Physical",
		name: "Accelerock",
		pp: 20,
		priority: 1,
		flags: { contact: 1, protect: 1, mirror: 1, metronome: 1 },
		secondary: null,
		target: "normal",
		type: "Rock",
		contestType: "Cool",
	},
	acid: {
		num: 51,
		accuracy: 100,
		basePower: 40,
		category: "Special",
		name: "Acid",
		pp: 30,
		priority: 0,
		flags: { protect: 1, mirror: 1, metronome: 1 },
		secondary: {
			chance: 10,
			boosts: {
				spd: -1,
			},
		},
		target: "allAdjacentFoes",
		type: "Poison",
		contestType: "Clever",
	},
	acidarmor: {
		num: 151,
		accuracy: true,
		basePower: 0,
		category: "Status",
		name: "Acid Armor",
		pp: 20,
		priority: 0,
		flags: { snatch: 1, metronome: 1 },
		boosts: {
			def: 2,
		},
		secondary: null,
		target: "self",
		type: "Poison",
		zMove: { effect: 'clearnegativeboost' },
		contestType: "Tough",
	},
	aciddownpour: {
		num: 628,
		accuracy: true,
		basePower: 1,
[... truncated: only first 100 lines included ...]
]]></file>
        <file name="pokedex-data.js"><![CDATA[/**
 * Pokemon Showdown Pokedex Data
 * è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘
 * æ¥æº: https://github.com/smogon/pokemon-showdown/blob/master/data/pokedex.ts
 * 
 * ä½¿ç”¨æ–¹æ³•:
 *   ES Module: import { POKEDEX } from './pokedex-data.js';
 *   Script:    <script src="pokedex-data.js"></script>
 */
export const POKEDEX = {
	bulbasaur: {
		num: 1,
		name: "Bulbasaur",
		types: ["Grass", "Poison"],
		genderRatio: { M: 0.875, F: 0.125 },
		baseStats: { hp: 45, atk: 49, def: 49, spa: 65, spd: 65, spe: 45 },
		abilities: { 0: "Overgrow", H: "Chlorophyll" },
		heightm: 0.7,
		weightkg: 6.9,
		color: "Green",
		evos: ["Ivysaur"],
		eggGroups: ["Monster", "Grass"],
	},
	ivysaur: {
		num: 2,
		name: "Ivysaur",
		types: ["Grass", "Poison"],
		genderRatio: { M: 0.875, F: 0.125 },
		baseStats: { hp: 60, atk: 62, def: 63, spa: 80, spd: 80, spe: 60 },
		abilities: { 0: "Overgrow", H: "Chlorophyll" },
		heightm: 1,
		weightkg: 13,
		color: "Green",
		prevo: "Bulbasaur",
		evoLevel: 16,
		evos: ["Venusaur"],
		eggGroups: ["Monster", "Grass"],
	},
	venusaur: {
		num: 3,
		name: "Venusaur",
		types: ["Grass", "Poison"],
		genderRatio: { M: 0.875, F: 0.125 },
		baseStats: { hp: 80, atk: 82, def: 83, spa: 100, spd: 100, spe: 80 },
		abilities: { 0: "Overgrow", H: "Chlorophyll" },
		heightm: 2,
		weightkg: 100,
		color: "Green",
		prevo: "Ivysaur",
		evoLevel: 32,
		eggGroups: ["Monster", "Grass"],
		otherFormes: ["Venusaur-Mega"],
		formeOrder: ["Venusaur", "Venusaur-Mega"],
		canGigantamax: "G-Max Vine Lash",
	},
	venusaurmega: {
		num: 3,
		name: "Venusaur-Mega",
		baseSpecies: "Venusaur",
		forme: "Mega",
		types: ["Grass", "Poison"],
		genderRatio: { M: 0.875, F: 0.125 },
		baseStats: { hp: 80, atk: 100, def: 123, spa: 122, spd: 120, spe: 80 },
		abilities: { 0: "Thick Fat" },
		heightm: 2.4,
		weightkg: 155.5,
		color: "Green",
		eggGroups: ["Monster", "Grass"],
		requiredItem: "Venusaurite",
	},
	venusaurgmax: {
		num: 3,
		name: "Venusaur-Gmax",
		baseSpecies: "Venusaur",
		forme: "Gmax",
		types: ["Grass", "Poison"],
		genderRatio: { M: 0.875, F: 0.125 },
		baseStats: { hp: 80, atk: 82, def: 83, spa: 100, spd: 100, spe: 80 },
		abilities: { 0: "Overgrow", H: "Chlorophyll" },
		heightm: 24,
		weightkg: 0,
		color: "Green",
		eggGroups: ["Monster", "Grass"],
		changesFrom: "Venusaur",
	},
	charmander: {
		num: 4,
		name: "Charmander",
		types: ["Fire"],
		genderRatio: { M: 0.875, F: 0.125 },
		baseStats: { hp: 39, atk: 52, def: 43, spa: 60, spd: 50, spe: 65 },
		abilities: { 0: "Blaze", H: "Solar Power" },
		heightm: 0.6,
		weightkg: 8.5,
		color: "Red",
		evos: ["Charmeleon"],
		eggGroups: ["Monster", "Dragon"],
	},
	charmeleon: {
[... truncated: only first 100 lines included ...]
]]></file>
        <file name="trainer-data.js"><![CDATA[/* 
 * è§’è‰²: å°ä¼˜ (Gloria)
 * èº«ä»½: ä¼½å‹’å°”å† å†› / å’–å–±å¤§å¸ˆ
 */
const GLORIA_DATA = {
    // ã€Tier 4 - æå·¨åŒ–å…¨å¼€Â·å† å†›æ¨¡å¼ã€‘
    4: {
        "trainerProficiency": 255,
        "unlocks": {
            "enable_bond": false,
            "enable_styles": false,
            "enable_insight": false,
            "enable_mega": false,
            "enable_z_move": false,
            "enable_dynamax": true, // Galar æ ¸å¿ƒæœºåˆ¶
            "enable_tera": false,
            "enable_proficiency_cap": true  // è®­ç»ƒåº¦çªç ´155ä¸Šé™
        },
        "party": [
            {
                "name": "Zacian-Crowned", 
                "lv": 99, 
                "gender": "N", 
                // è‹å“æœ¬èº«æ— æ³•æå·¨åŒ–ï¼Œæ‰€ä»¥ä¸è®¾ç½® mechanic
                "nature": "Adamant", 
                "ability": "Intrepid Sword", 
                "item": "Rusted Sword", 
                "isAce": true, 
                "stats_meta": {
                    "is_perfect": true, // å‡è®¾å¼•æ“æ”¯æŒæˆ–ä¿ç•™ ivs å†™æ³•
                    "ivs": { "hp": 31, "atk": 31, "def": 31, "spa": 31, "spd": 31, "spe": 31 },
                    "ev_level": 252
                },
                "moves": [
                    "Behemoth Blade", // å·¨å…½æ–©ï¼šé’ˆå¯¹æå·¨åŒ–åŒå€ä¼¤å®³
                    "Play Rough",     // å¬‰é—¹ï¼šä»¥æœ¬ç³»è¾“å‡ºè¦†ç›–é¾™/æ ¼æ–—
                    "Close Combat",   // è¿‘èº«æˆ˜ï¼šé’¢é“/æ™®é€šæ‰“å‡»é¢
                    "Swords Dance"    // å‰‘èˆï¼šä¸€æ—¦è®©å®ƒå¼ºåŒ–ä¸€æ¬¡ï¼Œå°±æ˜¯æ¨é˜ŸèŠ‚å¥
                ],
                // ç‹ç‰Œæ»¡é…æƒ…æ„Ÿå€¼ï¼šä¸ä»…æœ‰è¾“å‡º(Passion)è¿˜æœ‰æ— æ•Œçš„å›é¿(Insight)ä¸è€æ€§(Trust)
                "friendship": { "trust": 255, "passion": 255, "insight": 200, "devotion": 150 }
            },
            {
                "name": "Cinderace", 
                "lv": 97, 
                "gender": "M",
                "nature": "Jolly", 
                "ability": "Libero", // è‡ªç”±è€…ï¼šå˜æ¢å±æ€§ï¼Œæå…¶çµæ´»
                "item": "Life Orb", 
                // æ ¸å¿ƒæå·¨ä½
                "mechanic": "dynamax", 
                "mega_target": "cinderacegmax", // ç¡®ä¿é€šè¿‡ autoDetect æ‹¿åˆ° G-Max å½¢æ€
                "stats_meta": { "ev_level": 252 },
                "moves": [
                    "Pyro Ball",    // æå·¨åå˜æˆ G-Max Fireball (160å¨åŠ›+ç ´æ ¼)
                    "Bounce",       // æå·¨åå˜æˆ Max Airstream (å…¨é˜Ÿæé€Ÿï¼Œæ ¸å¿ƒæ¨é˜ŸæŠ€)
                    "High Jump Kick", // å˜æˆ Max Knuckle (å…¨é˜ŸåŠ æ”»)
                    "Court Change"    // æ¢åœºï¼šè™½ç„¶æ˜¯å˜åŒ–æŠ€ï¼Œä½†åœ¨æ™®é€šçŠ¶æ€ä¸‹å¯åå»ç©å®¶çš„å¢™/é’‰
                ],
                "avs": { "trust": 150, "passion": 230 }
            },
            {
                "name": "Rillaboom", 
                "lv": 95, 
                "gender": "M",
                "nature": "Adamant",
                "ability": "Grassy Surge", 
                "item": "Grassy Seed", // ä¸Šåœºé˜²ç‰©é˜²+1
                "mechanic": "dynamax",
                "mega_target": "rillaboomgmax", // å³ä½¿ä¸æ˜¯ACEï¼Œå¦‚æœä½œä¸ºæœ€åä¸€åªä¸Šåœºä¹Ÿèƒ½G-Max
                "stats_meta": { "ev_level": 252 },
                "moves": [
                    "Grassy Glide", // é’è‰æ»‘æ¢¯ï¼šåœºåœ°ä¸‹å…ˆåˆ¶
                    "Drum Beating", // æ§é€Ÿ
                    "High Horsepower", // è¡¥ç›²æ‰“ç«/ç”µ
                    "U-turn"         // çµæ´»è½®è½¬
                ]
            },
            {
                "name": "Urshifu-Rapid-Strike", 
                "lv": 94, 
                "gender": "M",
                "nature": "Jolly", // åŠ é€Ÿåº¦
                "ability": "Unseen Fist", 
                "item": "Focus Sash", // æ°”è…°é˜²æ­¢è¢«ç©å®¶çš„ Flying æ‹›å¼ç¡®ä¸€ï¼Œä¿è¯è¾“å‡º
                "mechanic": "dynamax",
                "mega_target": "urshifurapidstrikegmax",
                "stats_meta": { "ev_level": 252 },
                "moves": [
                    "Surging Strikes", // å¿…æš´å‡»
                    "Close Combat", 
                    "Ice Punch",      // å†°æ‹³ï¼šé’ˆå¯¹å¤„ç†ä¸äº†çš„é£è¡Œ/è‰/é¾™ç³»
                    "Aqua Jet"        // å…ˆåˆ¶æ”¶å‰²
                ]
            },
            {
                "name": "Corviknight", 
                "lv": 94, 
                "gender": "M",
                "nature": "Impish", // åŠ ç‰©é˜²ï¼Œå‡ç‰¹æ”»
[... truncated: only first 100 lines included ...]
]]></file>
    </directory>
    <directory name="engine">
        <file name="ability-handlers.js"><![CDATA[/**
 * =============================================
 * ABILITY HANDLERS - ç‰¹æ€§å¤„ç†å™¨
 * =============================================
 * 
 * ä»…æ”¶å½• Top 25 + å¸¸è§ RP ç‰¹æ€§ã€‚
 * ä½¿ç”¨ Hook ç³»ç»Ÿæ³¨å…¥åˆ° battle-engine.js çš„å„ä¸ªç¯èŠ‚ã€‚
 */
// ç®€å•çš„è¾…åŠ©å·¥å…·
export function isPinching(poke) {
    return poke.currHp > 0 && poke.currHp <= poke.maxHp / 3;
}
// ============================================
// ã€è½¯ç¼–ç ã€‘æ‹›å¼ Flag æ£€æŸ¥è¾…åŠ©å‡½æ•°
// ä½¿ç”¨ PS moves-data.js çš„ flags æ›¿ä»£ç¡¬ç¼–ç æ‹›å¼åˆ—è¡¨
// ============================================
/**
 * æ£€æŸ¥æ‹›å¼æ˜¯å¦å…·æœ‰æŒ‡å®šçš„ flag
 * @param {Object} move - æ‹›å¼å¯¹è±¡
 * @param {string} flag - flag åç§° (punch, bite, slicing, pulse, sound, powder, bullet, wind ç­‰)
 * @returns {boolean} æ˜¯å¦å…·æœ‰è¯¥ flag
 */
export function moveHasFlag(move, flag) {
    if (!move) return false;
    // ä¼˜å…ˆä½¿ç”¨æ‹›å¼å¯¹è±¡è‡ªå¸¦çš„ flags
    if (move.flags && move.flags[flag]) return true;
    // å°è¯•ä»å…¨å±€ Moves æ•°æ®è·å–
    if (typeof window !== 'undefined' && window.Moves) {
        // ç”Ÿæˆæ‹›å¼ ID (å°å†™ï¼Œå»é™¤éå­—æ¯å­—ç¬¦)
        const moveId = (move.id || move.name || '').toLowerCase().replace(/[^a-z]/g, '');
        const moveData = window.Moves[moveId];
        if (moveData && moveData.flags && moveData.flags[flag]) return true;
    }
    return false;
}
export const AbilityHandlers = {
    // ============================================
    // A. æš´åŠ›æ•°å€¼ä¿®æ­£
    // ============================================
    // ã€å¤§åŠ›å£«/ç‘œä¼½ä¹‹åŠ›ã€‘ç‰©æ”»ç¿»å€
    // ã€é’©å­ç»Ÿä¸€ã€‘onModifyStat: (stats, poke, battle)
    'Huge Power': { onModifyStat: (stats, poke, battle) => { stats.atk *= 2; } },
    'Pure Power': { onModifyStat: (stats, poke, battle) => { stats.atk *= 2; } },
    // ã€æŠ€æœ¯é«˜æ‰‹ã€‘ä½å¨åŠ›(<=60)æ‹›å¼ x1.5
    // ã€é’©å­ç»Ÿä¸€ã€‘onBasePower: (power, attacker, defender, move, battle)
    'Technician': {
        onBasePower: (power, attacker, defender, move, battle) => {
            if (power <= 60) return power * 1.5;
            return power;
        }
    },
    // ã€é€‚åº”åŠ›ã€‘æœ¬ç³»åŠ æˆä» 1.5 -> 2.0
    'Adaptability': {
        // è¿™ä¸€æ¡æ¯”è¾ƒç‰¹æ®Šï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹ stab å€ç‡å®ç°ï¼Œéœ€åœ¨ calcDamage é‡Œç‰¹åˆ«åˆ¤æ–­
        onModifySTAB: (stab) => 2
    },
    // ã€æœ‰è‰²çœ¼é•œã€‘æ•ˆæœä¸å¥½(X0.5)æ—¶å˜ä¸ºæ­£å¸¸(X1)
    'Tinted Lens': {
        onModifyEffectiveness: (eff) => {
            if (eff < 1 && eff > 0) return eff * 2;
            return eff;
        }
    },
    // ============================================
    // B. å¾¡ä¸‰å®¶ä¸“å± - ç»å¢ƒçˆ†å‘ (çº¢è¡€å˜èº«)
    // ============================================
    // ã€é’©å­ç»Ÿä¸€ã€‘onBasePower: (power, attacker, defender, move, battle)
    'Blaze': {
        onBasePower: (power, attacker, defender, move, battle) => {
            if (move.type === 'Fire' && isPinching(attacker)) return power * 1.5;
            return power;
        }
    },
    'Torrent': {
        onBasePower: (power, attacker, defender, move, battle) => {
            if (move.type === 'Water' && isPinching(attacker)) return power * 1.5;
            return power;
        }
    },
    'Overgrow': {
        onBasePower: (power, attacker, defender, move, battle) => {
            if (move.type === 'Grass' && isPinching(attacker)) return power * 1.5;
            return power;
        }
    },
    'Swarm': {
        onBasePower: (power, attacker, defender, move, battle) => {
            if (move.type === 'Bug' && isPinching(attacker)) return power * 1.5;
[... truncated: only first 100 lines included ...]
]]></file>
        <file name="ai-engine.js"><![CDATA[/**
 * =============================================
 * AI ENGINE - å®å¯æ¢¦æˆ˜æ–— AI ç³»ç»Ÿ
 * =============================================
 * 
 * å››ä¸ªéš¾åº¦ç­‰çº§ï¼š
 * - easy: éšæœºé€‰æ‹©ï¼Œå¶å°”é€‰æœ€ä¼˜
 * - normal: 60% æœ€ä¼˜ï¼Œ30% æ¬¡ä¼˜ï¼Œ10% éšæœº
 * - hard: æ€»æ˜¯é€‰æ‹©å½“å‰æœ€ä¼˜æŠ€èƒ½
 * - expert: å¤§å±€è§‚ AIï¼Œä¼šæ¢äººã€é¢„åˆ¤ã€æ–©æ€è®¡ç®—
 * 
 * v2.0 é«˜çº§è½®è½¬ AI ç‰¹æ€§ï¼š
 * - æŠ˜è¿”æŠ€èƒ½æˆ˜æœ¯è¯„åˆ† (U-turn, Volt Switch ç­‰)
 * - æˆ˜ç•¥æ€§æ¢äºº (æ¸…é™¤è´Ÿé¢çŠ¶æ€/èƒ½åŠ›ä¸‹é™)
 * - é£é™©è¯„ä¼° (è„†çš®è¾“å‡ºæ‰‹æ›´æƒœå‘½)
 * - ç®€æ˜“è¯»æ¢ (é¢„æµ‹ç©å®¶å¿…æ­»æ¢äºº)
 */
const AI_DIFFICULTY = {
    EASY: 'easy',
    NORMAL: 'normal', 
    HARD: 'hard',
    EXPERT: 'expert'
};
/**
 * AI å†³ç­–ç»“æœç±»å‹
 */
const AI_ACTION_TYPE = {
    MOVE: 'move',
    SWITCH: 'switch'
};
// =============================================
// AI ç‰¹æ€§è¯„ä¼°é…ç½®ï¼ˆè½¯ç¼–ç ï¼Œæ•°æ®é©±åŠ¨ï¼‰
// =============================================
// type: é˜²å¾¡æœºåˆ¶ç±»å‹
//   - consumable_shield: ä¸€æ¬¡æ€§æŠ¤ç›¾ï¼ˆç”»çš®ã€å†°ç Œé¹…ï¼‰
//   - damage_reduction: æ»¡è¡€å‡ä¼¤ï¼ˆå¤šé‡é³ç‰‡ã€å¹»å½±é˜²å®ˆï¼‰
//   - endure_lethal: æ»¡è¡€ä¿å‘½ï¼ˆç»“å®ï¼‰
//   - immunity_conditional: æ¡ä»¶å…ç–«ï¼ˆè“„æ°´ã€é¿é›·é’ˆç­‰ï¼‰
// breakValue: æ‰“ç ´æŠ¤ç›¾çš„æˆ˜æœ¯ä»·å€¼
// condition: è§¦å‘æ¡ä»¶ï¼ˆphysical/special/full_hpï¼‰
// bustedFlag: æ£€æµ‹æŠ¤ç›¾æ˜¯å¦å·²ç ´æŸçš„å±æ€§å
const AI_ABILITY_TRAITS = {
    // ä¸€æ¬¡æ€§æŠ¤ç›¾
    'Disguise':      { type: 'consumable_shield', breakValue: 350, bustedFlag: 'disguiseBusted' },
    'Ice Face':      { type: 'consumable_shield', breakValue: 300, condition: 'physical', bustedFlag: 'iceFaceBroken' },
    // æ»¡è¡€å‡ä¼¤
    'Multiscale':    { type: 'damage_reduction', breakValue: 150, condition: 'full_hp' },
    'Shadow Shield': { type: 'damage_reduction', breakValue: 150, condition: 'full_hp' },
    // æ»¡è¡€ä¿å‘½
    'Sturdy':        { type: 'endure_lethal', breakValue: 200, condition: 'full_hp' },
    // æ¡ä»¶å…ç–«ï¼ˆè¿™äº›ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œæ­£å¸¸ä¼¤å®³è®¡ç®—ä¼šè¿”å›0ï¼‰
    'Wonder Guard':  { type: 'immunity_conditional', note: 'only_supereffective' },
    'Levitate':      { type: 'immunity_conditional', note: 'ground_immune' },
    'Volt Absorb':   { type: 'immunity_conditional', note: 'electric_immune' },
    'Water Absorb':  { type: 'immunity_conditional', note: 'water_immune' },
    'Flash Fire':    { type: 'immunity_conditional', note: 'fire_immune' },
};
// åå¼ºåŒ–æŠ€èƒ½åˆ—è¡¨ï¼ˆé¢å¯¹é«˜å¨èƒæ—¶ä¼˜å…ˆä½¿ç”¨ï¼‰
const AI_COUNTER_MOVES = ['Haze', 'Clear Smog', 'Roar', 'Whirlwind', 'Dragon Tail', 'Circle Throw', 'Topsy-Turvy', 'Spectral Thief'];
/**
 * è·å– AI å†³ç­–ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
 * @param {Pokemon} aiPoke - AI å½“å‰å®å¯æ¢¦
 * @param {Pokemon} playerPoke - ç©å®¶å½“å‰å®å¯æ¢¦
 * @param {string} difficulty - éš¾åº¦ç­‰çº§
 * @param {Pokemon[]} aiParty - AI é˜Ÿä¼ï¼ˆç”¨äºæ¢äººå†³ç­–ï¼‰
 * @param {object} battleContext - æˆ˜æ–—ä¸Šä¸‹æ–‡ï¼ˆå›åˆæ•°ã€å·²ç”¨ Mega ç­‰ï¼‰
 * @returns {object} { type: 'move'|'switch', move?: Move, index?: number, reasoning?: string }
 */
export function getAiAction(aiPoke, playerPoke, difficulty = 'hard', aiParty = [], battleContext = {}) {
    if (!aiPoke || !playerPoke) return null;
    // ã€è“„åŠ›æŠ€èƒ½é”å®šã€‘æ£€æŸ¥ AI æ˜¯å¦æ­£åœ¨è“„åŠ›
    if (aiPoke.volatile?.chargingMove) {
        const chargingMove = aiPoke.volatile.chargingMove;
        const moveToUse = aiPoke.moves?.find(m => m.name === chargingMove);
        if (moveToUse) {
            console.log(`[AI CHARGE] ${aiPoke.cnName} æ­£åœ¨è“„åŠ› ${chargingMove}ï¼Œå¼ºåˆ¶æ‰§è¡Œ`);
            return { type: AI_ACTION_TYPE.MOVE, move: moveToUse, forced: true };
        }
    }
    const normalizedDiff = (difficulty || 'hard').toLowerCase();
    switch (normalizedDiff) {
        case 'expert':
            return getExpertAiAction(aiPoke, playerPoke, aiParty, battleContext);
        case 'hard': {
            // ã€v2.1ã€‘Hard éš¾åº¦ä¹Ÿæ”¯æŒé£æ ¼é€‰æ‹©
            const hardMove = getHardAiMove(aiPoke, playerPoke, aiParty);
            let chosenStyle = null;
            if (hardMove) {
                const mergedMove = getMergedMoveData(hardMove);
                chosenStyle = tryOptimizeStyle(aiPoke, playerPoke, mergedMove);
            }
            return { type: AI_ACTION_TYPE.MOVE, move: hardMove, style: chosenStyle };
        }
        case 'normal': {
            // ã€v2.1ã€‘Normal éš¾åº¦ä¹Ÿæ”¯æŒé£æ ¼é€‰æ‹©ï¼ˆæ¦‚ç‡è¾ƒä½ï¼‰
            const normalMove = getNormalAiMove(aiPoke, playerPoke, aiParty);
            let chosenStyle = null;
            if (normalMove && Math.random() < 0.5) { // 50% æ¦‚ç‡å°è¯•é£æ ¼
                const mergedMove = getMergedMoveData(normalMove);
                chosenStyle = tryOptimizeStyle(aiPoke, playerPoke, mergedMove);
            }
            return { type: AI_ACTION_TYPE.MOVE, move: normalMove, style: chosenStyle };
        }
        case 'easy':
        default:
            return { type: AI_ACTION_TYPE.MOVE, move: getEasyAiMove(aiPoke, playerPoke, aiParty) };
    }
}
/* =============================================================
 *  åŸºç¡€ AIï¼šEasy éš¾åº¦
 *  80% éšæœºé€‰æ‹©ï¼Œ20% é€‰æœ€ä¼˜
 * ============================================================= */
export function getEasyAiMove(attacker, defender, aiParty = null) {
    if (!attacker?.moves || attacker.moves.length === 0) return null;
    // ã€ä¿®å¤ã€‘è¿‡æ»¤æ‰é¦–å›åˆé™åˆ¶æ‹›å¼ï¼ˆéé¦–å›åˆæ—¶ï¼‰
    const firstTurnOnlyMoves = ['Fake Out', 'First Impression', 'Mat Block'];
    const isFirstTurn = (attacker.turnsOnField || 0) === 0;
    const availableMoves = isFirstTurn 
        ? attacker.moves 
        : attacker.moves.filter(m => !firstTurnOnlyMoves.includes(m.name));
    // å¦‚æœè¿‡æ»¤åæ²¡æœ‰æ‹›å¼äº†ï¼Œå›é€€åˆ°åŸå§‹æ‹›å¼åˆ—è¡¨
    const movesToUse = availableMoves.length > 0 ? availableMoves : attacker.moves;
    // 80% æ¦‚ç‡éšæœºé€‰
    if (Math.random() < 0.8) {
        return movesToUse[Math.floor(Math.random() * movesToUse.length)];
    }
    // 20% æ¦‚ç‡é€‰æœ€ä¼˜
    const rankedMoves = rankMovesByScore(attacker, defender, aiParty);
    if (rankedMoves.length === 0) return movesToUse[0];
    // è¿‡æ»¤æ‰å¿…å®šå¤±è´¥çš„æ‹›å¼
    const viableMoves = rankedMoves.filter(m => m.score > -9000);
    if (viableMoves.length === 0) return movesToUse[0];
    // ä½†å³ä½¿é€‰æœ€ä¼˜ï¼Œä¹Ÿå¯èƒ½é€‰æ¬¡ä¼˜
    if (viableMoves.length > 1 && Math.random() < 0.5) {
        return viableMoves[1].move;
    }
    return viableMoves[0].move;
}
/* =============================================================
 *  æ™®é€š AIï¼šNormal éš¾åº¦
 *  60% æœ€ä¼˜ï¼Œ30% æ¬¡ä¼˜ï¼Œ10% ç¬¬ä¸‰ä¼˜æˆ–éšæœº
 * ============================================================= */
export function getNormalAiMove(attacker, defender, aiParty = null) {
    if (!attacker?.moves || attacker.moves.length === 0) return null;
    const rankedMoves = rankMovesByScore(attacker, defender, aiParty);
    if (rankedMoves.length === 0) return attacker.moves[0];
    // ã€ä¿®å¤ã€‘è¿‡æ»¤æ‰å¿…å®šå¤±è´¥çš„æ‹›å¼ï¼ˆå¾—åˆ† <= -9000ï¼‰
    const viableMoves = rankedMoves.filter(m => m.score > -9000);
    // å¦‚æœæ‰€æœ‰æ‹›å¼éƒ½è¢«ç¦ç”¨ï¼Œé€‰æ‹©å¾—åˆ†æœ€é«˜çš„é‚£ä¸ªï¼ˆæœ€ä¸åçš„ï¼‰
    if (viableMoves.length === 0) {
        // ã€å…³é”®ä¿®å¤ã€‘ä¸è¦éšæœºé€‰ï¼Œé€‰å¾—åˆ†æœ€é«˜çš„ï¼ˆå³ä½¿æ˜¯è´Ÿåˆ†ï¼‰
        console.log(`[AI FALLBACK] æ‰€æœ‰æ‹›å¼éƒ½è¢«ç¦ç”¨ï¼Œé€‰æ‹©å¾—åˆ†æœ€é«˜çš„: ${rankedMoves[0]?.move?.name} (${rankedMoves[0]?.score})`);
        return rankedMoves[0].move;
    }
    const roll = Math.random();
    if (roll < 0.6 || viableMoves.length === 1) {
        return viableMoves[0].move;
    }
    if (roll < 0.9 && viableMoves.length > 1) {
        return viableMoves[1].move;
    }
    return viableMoves[Math.min(2, viableMoves.length - 1)].move;
}
/* =============================================================
 *  å›°éš¾ AIï¼šHard éš¾åº¦
 *  æ€»æ˜¯é€‰æ‹©å½“å‰è¯„åˆ†æœ€é«˜çš„æŠ€èƒ½
 * ============================================================= */
export function getHardAiMove(attacker, defender, aiParty = null) {
    if (!attacker?.moves || attacker.moves.length === 0) return null;
    const rankedMoves = rankMovesByScore(attacker, defender, aiParty);
    if (rankedMoves.length === 0) return attacker.moves[0];
    // ã€ä¿®å¤ã€‘è¿‡æ»¤æ‰å¿…å®šå¤±è´¥çš„æ‹›å¼ï¼ˆå¾—åˆ† <= -9000ï¼‰
    const viableMoves = rankedMoves.filter(m => m.score > -9000);
    // å¦‚æœæ‰€æœ‰æ‹›å¼éƒ½è¢«ç¦ç”¨ï¼Œé€‰æ‹©å¾—åˆ†æœ€é«˜çš„é‚£ä¸ªï¼ˆæœ€ä¸åçš„ï¼‰
    if (viableMoves.length === 0) {
        // ã€å…³é”®ä¿®å¤ã€‘ä¸è¦éšæœºé€‰ï¼Œé€‰å¾—åˆ†æœ€é«˜çš„ï¼ˆå³ä½¿æ˜¯è´Ÿåˆ†ï¼‰
        console.log(`[AI FALLBACK] æ‰€æœ‰æ‹›å¼éƒ½è¢«ç¦ç”¨ï¼Œé€‰æ‹©å¾—åˆ†æœ€é«˜çš„: ${rankedMoves[0]?.move?.name} (${rankedMoves[0]?.score})`);
        return rankedMoves[0].move;
    }
    // ã€ä¿®å¤ã€‘æå·¨åŒ–æ—¶ï¼Œå¦‚æœæœ€é«˜åˆ†æ‹›å¼æ˜¯å…ç–«çš„æ”»å‡»æ‹›å¼ï¼ˆ-9999ï¼‰ï¼Œä¼˜å…ˆé€‰æ‹© Max Guard
    // Max Guard æ˜¯å˜åŒ–æŠ€è½¬æ¢çš„æå·¨æ‹›å¼ï¼Œè‡³å°‘èƒ½ä¿æŠ¤è‡ªå·±
    if (attacker.isDynamaxed && rankedMoves[0].score <= -9000) {
        // æ‰¾åˆ° Max Guardï¼ˆå˜åŒ–æŠ€è½¬æ¢çš„æå·¨æ‹›å¼ï¼‰
        const maxGuard = rankedMoves.find(r => r.move.name === 'Max Guard');
        if (maxGuard) {
            console.log(`[AI FIX] æå·¨åŒ–çŠ¶æ€ä¸‹æ‰€æœ‰æ”»å‡»æ‹›å¼å¯¹ç›®æ ‡å…ç–«ï¼Œé€‰æ‹© Max Guard`);
            return maxGuard.move;
        }
        // å¦‚æœæ²¡æœ‰ Max Guardï¼Œé€‰æ‹©è¯„åˆ†æœ€é«˜çš„éæ”»å‡»æ‹›å¼
        const nonAttack = rankedMoves.find(r => r.score > -9000);
        if (nonAttack) {
            console.log(`[AI FIX] æå·¨åŒ–çŠ¶æ€ä¸‹æ”»å‡»æ‹›å¼å…ç–«ï¼Œé€‰æ‹©: ${nonAttack.move.name}`);
            return nonAttack.move;
        }
    }
    return rankedMoves[0].move;
}
// æ¢äººå†·å´è¿½è¸ªï¼ˆé˜²æ­¢è¿ç»­æ¢äººï¼‰
let lastSwitchTurn = -999;
// æŠ˜è¿”æŠ€èƒ½åˆ—è¡¨ (åå¤‡ï¼Œä¼˜å…ˆä½¿ç”¨ moves-data.js çš„ selfSwitch å­—æ®µ)
const PIVOT_MOVES_FALLBACK = ['U-turn', 'Volt Switch', 'Flip Turn', 'Parting Shot', 'Teleport', 'Baton Pass'];
/**
 * æ£€æµ‹æ‹›å¼æ˜¯å¦ä¸ºæŠ˜è¿”æŠ€èƒ½ï¼ˆä½¿ç”¨åè‡ªåŠ¨æ¢äººï¼‰
 * ä¼˜å…ˆä½¿ç”¨ PS moves-data.js çš„ selfSwitch å­—æ®µ
 */
function isPivotMove(move) {
    const moveName = move.name || '';
    const moveId = moveName.toLowerCase().replace(/[^a-z0-9]/g, '');
    // ä¼˜å…ˆä» PS æ•°æ®åº“æ£€æŸ¥
    if (typeof MOVES !== 'undefined' && MOVES[moveId]) {
        const moveData = MOVES[moveId];
        // selfSwitch å¯ä»¥æ˜¯ true æˆ–å­—ç¬¦ä¸²ï¼ˆå¦‚ 'copyvolatile', 'shedtail'ï¼‰
        if (moveData.selfSwitch) return true;
    }
    // åå¤‡ç¡¬ç¼–ç 
    return PIVOT_MOVES_FALLBACK.includes(moveName);
}
/**
 * =======================================================
 * [AI è¡¥ä¸] å¤æ­¦æµæ´¾è¯„ä¼°å™¨ (Style Evaluator)
 * æå‡ AI ä½¿ç”¨ è¿…ç–¾ (Agile) / åˆšçŒ› (Strong) çš„é¢‘ç‡
 * =======================================================
 * @param {Pokemon} aiPoke - AI å½“å‰å®å¯æ¢¦
 * @param {Pokemon} playerPoke - ç©å®¶å½“å‰å®å¯æ¢¦
 * @param {object} baseMove - åŸºç¡€æ‹›å¼
 * @returns {string|null} 'agile' | 'strong' | null
 */
/**
 * AI é£æ ¼ä¼˜åŒ– v3.1 - å¹³è¡¡åšå¼ˆæ¨¡å‹
 * 
 * âš¡ è¿…ç–¾ (Agile): ä¼˜å…ˆåº¦ +1ï¼Œé™ä½å¨åŠ›å’Œå‘½ä¸­
 *   - åœºæ™¯Aï¼ˆé€Ÿåº¦å¿«ï¼‰: å¨åŠ› 0.75x, å‘½ä¸­ 0.9x
 *   - åœºæ™¯Bï¼ˆé€Ÿåº¦æ…¢ï¼‰: å¨åŠ› 0.50x, å‘½ä¸­ 0.85x
 * 
 * ğŸ’ª åˆšçŒ› (Strong): ä¼˜å…ˆåº¦ -1ï¼Œæé«˜å¨åŠ›
 *   - åœºæ™¯Aï¼ˆé€Ÿåº¦æ…¢ï¼‰: å¨åŠ› 1.3x, å‘½ä¸­ 0.8x
 *   - åœºæ™¯Bï¼ˆé€Ÿåº¦å¿«ï¼‰: å¨åŠ› 1.3x, å‘½ä¸­ä¸å˜ï¼ˆå–å…ˆæ‰‹ï¼‰
 */
function tryOptimizeStyle(aiPoke, playerPoke, baseMove) {
    // === åŸºç¡€æ£€æŸ¥ ===
    const unlocks = (typeof battle !== 'undefined') ? battle.enemyUnlocks : {};
    if (unlocks && unlocks.enable_styles === false) return null;
    if (typeof battle !== 'undefined' && battle.enemyStyleCooldown > 0) {
        console.log(`[AI STYLE] å†·å´ä¸­ (${battle.enemyStyleCooldown})`);
        return null;
    }
    // å˜åŒ–æŠ€ä¸ä½¿ç”¨é£æ ¼
    const category = (baseMove.cat || baseMove.category || '').toLowerCase();
    if (category === 'status' || baseMove.power === 0) return null;
    // å…ˆåˆ¶æŠ€ä¸éœ€è¦è¿…ç–¾
    const basePriority = baseMove.priority || 0;
    // === è·å–æˆ˜æ–—æ•°æ® ===
    const normalDmgResult = simulateDamage(aiPoke, playerPoke, baseMove);
    const normalDmg = normalDmgResult.damage;
    const targetHp = playerPoke.currHp;
    const targetMaxHp = playerPoke.maxHp;
    const myHp = aiPoke.currHp;
    const myMaxHp = aiPoke.maxHp;
    const mySpeed = getEffectiveSpeed(aiPoke);
    const targetSpeed = getEffectiveSpeed(playerPoke);
    const isTrickRoom = (typeof battle !== 'undefined') && battle.field && battle.field.trickRoom > 0;
    const isFaster = isTrickRoom ? (mySpeed < targetSpeed) : (mySpeed > targetSpeed);
    const isSlower = !isFaster;
    // ä¼¤å®³è®¡ç®—
    const strongDmg = Math.floor(normalDmg * 1.30);
    const agileDmgFast = Math.floor(normalDmg * 0.75);
    const agileDmgSlow = Math.floor(normalDmg * 0.50);
    // è¡€é‡ç™¾åˆ†æ¯”
    const targetHpPct = targetHp / targetMaxHp;
    const myHpPct = myHp / myMaxHp;
    console.log(`[AI STYLE] è¯„ä¼°: ${baseMove.name}, é€Ÿåº¦${isFaster ? 'å¿«' : 'æ…¢'} (${mySpeed} vs ${targetSpeed}), å¯¹æ–¹${Math.floor(targetHpPct*100)}%è¡€, æˆ‘${Math.floor(myHpPct*100)}%è¡€`);
    // =========================================================
    // ğŸ’ª åˆšçŒ›å†³ç­–
    // =========================================================
    // ã€åœºæ™¯1ã€‘æ–©æ€çº¿ï¼šæ™®é€šæ‰“ä¸æ­»ï¼ŒåˆšçŒ›èƒ½æ‰“æ­»ï¼ˆ100%è§¦å‘ï¼‰
    if (normalDmg < targetHp && strongDmg >= targetHp) {
        if (isFaster) {
            console.log(`[AI STYLE] åˆšçŒ›æ–©æ€: ${baseMove.name} (${normalDmg} -> ${strongDmg})`);
            return 'strong';
        } else {
            // é€Ÿåº¦æ…¢æ—¶å‘½ä¸­0.8xï¼Œä½†æ–©æ€çº¿å€¼å¾—èµŒ
            console.log(`[AI STYLE] åˆšçŒ›å†’é™©æ–©æ€: ${baseMove.name} (${normalDmg} -> ${strongDmg}, å‘½ä¸­0.8x)`);
            return 'strong';
        }
    }
    // ã€v3.3 ç§»é™¤åœºæ™¯2ã€‘é€Ÿåº¦å¿«æ—¶å–å…ˆæ‰‹å¤ªå±é™©ï¼Œå¦‚æœå¯¹æ–¹èƒ½æ–©æ€è‡ªå·±å°±æ˜¯è‡ªæ€
    // åªä¿ç•™æ–©æ€çº¿åœºæ™¯
    // =========================================================
    // âš¡ è¿…ç–¾å†³ç­–ï¼ˆå…ˆåˆ¶æŠ€è·³è¿‡ï¼‰
    // ã€v3.3ã€‘åªåœ¨æ–©æ€çº¿æ—¶ä½¿ç”¨è¿…ç–¾ï¼Œä¸å†æœ‰å…¶ä»–åœºæ™¯
    // =========================================================
    if (basePriority <= 0) {
        // ã€å”¯ä¸€åœºæ™¯ã€‘é€Ÿåº¦æ…¢ + è¿…ç–¾èƒ½æ–©æ€ = æŠ¢å…ˆæ”¶å‰²
        if (isSlower && agileDmgSlow >= targetHp) {
            console.log(`[AI STYLE] è¿…ç–¾æ–©æ€: ${baseMove.name} (${agileDmgSlow} >= ${targetHp})`);
            return 'agile';
        }
    }
    // =========================================================
    // ğŸ¯ å‡ç¥å†³ç­– (Focus) - å¿…ä¸­é£æ ¼
    // ã€åœºæ™¯ã€‘ä½å‘½ä¸­é«˜å¨åŠ›æŠ€èƒ½ + èƒ½æ–©æ€ = å‡ç¥ç¡®ä¿å‘½ä¸­
    // =========================================================
    const baseAcc = baseMove.accuracy;
    if (typeof baseAcc === 'number' && baseAcc < 85 && normalDmg >= targetHp) {
        // ä½å‘½ä¸­æŠ€èƒ½èƒ½æ–©æ€æ—¶ï¼Œä½¿ç”¨å‡ç¥ç¡®ä¿å‘½ä¸­
        console.log(`[AI STYLE] å‡ç¥æ–©æ€: ${baseMove.name} (å‘½ä¸­${baseAcc}% -> å¿…ä¸­)`);
        return 'focus';
    }
    // é»˜è®¤ä¸ä½¿ç”¨é£æ ¼
    return null;
}
/* =============================================================
 *  ä¸“å®¶ AIï¼šExpert éš¾åº¦
 *  å¤§å±€è§‚å†³ç­–ï¼šæ–©æ€è®¡ç®— + æ¢äººåˆ¤æ–­ + çŠ¶æ€åšå¼ˆ + é«˜çº§è½®è½¬
 * ============================================================= */
export function getExpertAiAction(aiPoke, playerPoke, aiParty = [], battleContext = {}) {
    if (!aiPoke || !playerPoke) return null;
    if (!aiPoke.moves || aiPoke.moves.length === 0) return null;
    const turnCount = battleContext.turnCount || 1;
    // ========================================
    // é˜¶æ®µ 0ï¼šç‰¹æ®Šé¦–å›åˆæŠ€èƒ½æ£€æŸ¥
    // ========================================
    const firstTurnMove = checkFirstTurnMoves(aiPoke, playerPoke, turnCount);
    if (firstTurnMove) {
        return { type: AI_ACTION_TYPE.MOVE, move: firstTurnMove, reasoning: 'First turn priority move (Fake Out)' };
    }
    // ========================================
    // é˜¶æ®µ 1ï¼šæ–©æ€çº¿è®¡ç®— (Lethal Check)
    // ã€v3.2ã€‘æ”¯æŒè¿…ç–¾/åˆšçŒ›æ–©æ€
    // ========================================
    const killMove = findKillMove(aiPoke, playerPoke);
    if (killMove) {
        return { 
            type: AI_ACTION_TYPE.MOVE, 
            move: killMove.move, 
            style: killMove.style || null,
            reasoning: killMove.reasoning 
        };
    }
    // ========================================
    // é˜¶æ®µ 1.3ï¼šå±æœºé—ªé¿ (Crisis Evasion) [v3.5]
    // å¦‚æœæˆ‘å¤„äºæ–©æ€çº¿ä¸”é€Ÿåº¦æ›´å¿«ï¼Œä¼˜å…ˆä½¿ç”¨åŠæ— æ•ŒæŠ€èƒ½èº²é¿
    // ========================================
    const evasionMove = findEvasionMove(aiPoke, playerPoke);
    if (evasionMove) {
        return { 
            type: AI_ACTION_TYPE.MOVE, 
            move: evasionMove.move, 
            reasoning: evasionMove.reasoning 
        };
    }
    // ========================================
    // é˜¶æ®µ 1.5ï¼šè¯»æ¢é¢„åˆ¤ (Prediction) [v2.0]
    // å¦‚æœç©å®¶å¿…æ­»ä¸”æ¯”æˆ‘æ…¢ï¼Œé¢„æµ‹ç©å®¶ä¼šæ¢äºº
    // ========================================
    const predictionMove = evaluatePrediction(aiPoke, playerPoke, aiParty);
    if (predictionMove) {
        return { type: AI_ACTION_TYPE.MOVE, move: predictionMove.move, reasoning: predictionMove.reasoning };
    }
    // ========================================
    // é˜¶æ®µ 2ï¼šå¨èƒè¯„ä¼° - æˆ‘ä¼šæ­»å—ï¼Ÿ
    // ========================================
    const threatAssessment = assessThreat(aiPoke, playerPoke);
    // ========================================
    // é˜¶æ®µ 2.5ï¼šæˆ˜ç•¥æ€§æ¢äººæ£€æŸ¥ (Reset Pivoting) [v2.0]
    // æ£€æŸ¥æ˜¯å¦å› ä¸ºè´Ÿé¢çŠ¶æ€/èƒ½åŠ›ä¸‹é™éœ€è¦æ¢äºº
    // ========================================
    const needsStrategicSwitch = shouldStrategicSwitch(aiPoke);
    // ========================================
    // é˜¶æ®µ 3ï¼šæ¢äººå†³ç­– (Pivot Logic)
    // æ·»åŠ å†·å´ï¼šè‡³å°‘é—´éš” 2 å›åˆæ‰èƒ½å†æ¬¡æ¢äºº
    // ========================================
    const switchCooldown = 2;
    const canSwitch = (turnCount - lastSwitchTurn) >= switchCooldown;
    // ã€ä¿®å¤ã€‘æå·¨åŒ–çŠ¶æ€ä¸‹ç»å¯¹ç¦æ­¢æ¢äººï¼
    // æ­£ä½œè§„åˆ™ï¼šæå·¨åŒ–å®å¯æ¢¦æ¢äººä¼šç«‹åˆ»è§£é™¤æå·¨åŒ–ï¼Œè¿™æ˜¯å·¨å¤§çš„èµ„æºæµªè´¹
    if (aiPoke.isDynamaxed || (aiPoke.dynamaxTurns && aiPoke.dynamaxTurns > 0)) {
        console.log(`[AI] ${aiPoke.name} is Dynamaxed - switching FORBIDDEN`);
        // ç›´æ¥è·³è¿‡æ¢äººå†³ç­–ï¼Œè¿›å…¥æ”»å‡»å†³ç­–
        const bestMove = getHardAiMove(aiPoke, playerPoke, aiParty);
        return { type: AI_ACTION_TYPE.MOVE, move: bestMove, reasoning: 'Dynamax active - must attack' };
    }
    // ä¿®å¤ï¼šå¦‚æœæˆ‘æœ‰ä¼˜åŠ¿ï¼ˆèƒ½ç§’æ€å¯¹æ–¹æˆ–ä¼¤å®³è¿œè¶…å¯¹æ–¹ï¼‰ï¼Œä¸è¦æ¢äººï¼
    // v2.0ï¼šå³ä½¿ä¸å±é™©ï¼Œå¦‚æœçŠ¶æ€å¾ˆå·®ä¹Ÿè€ƒè™‘æ¢äºº
    const shouldConsiderSwitch = threatAssessment.amIInDanger || needsStrategicSwitch;
    if (canSwitch && shouldConsiderSwitch && 
        !threatAssessment.haveAdvantage &&  // å…³é”®ä¿®å¤ï¼šæœ‰ä¼˜åŠ¿æ—¶ä¸æ¢äºº
        aiParty && aiParty.length > 1) {
        const pivotDecision = findBestPivot(aiPoke, playerPoke, aiParty, threatAssessment);
        if (pivotDecision) {
            lastSwitchTurn = turnCount; // è®°å½•æ¢äººå›åˆ
            return pivotDecision;
        }
    }
    // ========================================
    // é˜¶æ®µ 4ï¼šçŠ¶æ€åšå¼ˆä¸å¼ºåŒ–åˆ¤æ–­
    // ========================================
    const strategicMove = evaluateStrategicMoves(aiPoke, playerPoke, threatAssessment);
    if (strategicMove) {
        return { type: AI_ACTION_TYPE.MOVE, move: strategicMove.move, reasoning: strategicMove.reasoning };
    }
    // ========================================
    // é˜¶æ®µ 5ï¼šå¸¸è§„è´ªå©ªé€‰æ‹© (Fallback to Hard AI)
    // ========================================
    const bestMove = getHardAiMove(aiPoke, playerPoke, aiParty);
    // ========================================
    // é˜¶æ®µ 6ï¼šé£æ ¼ä¼˜åŒ– (Style Optimization) [v2.1]
    // å°è¯•ä¸ºæœ€ä¼˜æ‹›å¼é™„åŠ "æµæ´¾ (Style)"
    // ========================================
    let chosenStyle = null;
    if (bestMove) {
        const mergedMove = getMergedMoveData(bestMove);
        const styleSuggestion = tryOptimizeStyle(aiPoke, playerPoke, mergedMove);
        if (styleSuggestion) {
            chosenStyle = styleSuggestion;
        }
        // ã€v3.2 ç§»é™¤ã€‘ä¸å†éšæœºä½¿ç”¨é£æ ¼ï¼Œåªåœ¨æœ‰æˆ˜æœ¯ä»·å€¼æ—¶ä½¿ç”¨
    }
    return { 
        type: AI_ACTION_TYPE.MOVE, 
        move: bestMove, 
        style: chosenStyle,
        reasoning: chosenStyle ? `Optimized via ${chosenStyle} style` : 'Standard best move calculation' 
    };
}
/* =============================================================
 *  Expert AI è¾…åŠ©å‡½æ•°
 * ============================================================= */
/**
 * æ£€æŸ¥é¦–å›åˆç‰¹æ®ŠæŠ€èƒ½ï¼ˆå¦‚ Fake Outï¼‰
 */
function checkFirstTurnMoves(aiPoke, playerPoke, turnCount) {
    // å…³é”®ä¿®å¤ï¼šæ£€æŸ¥ turnsOnField è€Œä¸æ˜¯ turnCount
    // Fake Out åªèƒ½åœ¨å®å¯æ¢¦ä¸Šåœºåçš„ç¬¬ä¸€å›åˆä½¿ç”¨
    if ((aiPoke.turnsOnField || 0) > 0) return null;
    const fakeOutMoves = ['Fake Out', 'First Impression'];
    for (const move of aiPoke.moves) {
        if (fakeOutMoves.includes(move.name)) {
            // ç¡®ä¿èƒ½é€ æˆä¼¤å®³ï¼ˆä¸æ˜¯å…ç–«ï¼‰
            const eff = getTypeEffectivenessAI(move.type || 'Normal', playerPoke.types || ['Normal']);
            if (eff > 0) {
                return move;
            }
        }
    }
    return null;
}
/**
 * å¯»æ‰¾æ–©æ€æŠ€èƒ½
 * @returns {object|null} { move, reasoning } æˆ– null
 */
function findKillMove(aiPoke, playerPoke) {
    const targetHp = playerPoke.currHp;
    const targetMaxHp = playerPoke.maxHp;
    const mySpeed = getEffectiveSpeed(aiPoke);
    const targetSpeed = getEffectiveSpeed(playerPoke);
    const isTrickRoom = (typeof battle !== 'undefined') && battle.field && battle.field.trickRoom > 0;
    const aiFaster = isTrickRoom ? (mySpeed < targetSpeed) : (mySpeed > targetSpeed);
    // ã€è°ƒè¯•ã€‘è¾“å‡ºæ–©æ€æ£€æŸ¥ä¿¡æ¯
    console.log(`[AI KILL CHECK] ${aiPoke.name} vs ${playerPoke.name}: targetHp=${targetHp}/${targetMaxHp}, aiFaster=${aiFaster}`);
    let bestKillMove = null;
    let bestKillPriority = -999;
    // ã€ä¿®å¤ã€‘é¦–å›åˆé™åˆ¶æŠ€èƒ½åˆ—è¡¨
    const firstTurnOnlyMoves = ['Fake Out', 'First Impression', 'Mat Block'];
    for (const move of aiPoke.moves) {
        const mergedMove = getMergedMoveData(move);
        const category = (mergedMove.cat || mergedMove.category || '').toLowerCase();
        if (category === 'status' || mergedMove.power === 0) continue;
        // ã€ä¿®å¤ã€‘è·³è¿‡éé¦–å›åˆçš„é¦–å›åˆé™åˆ¶æŠ€èƒ½
        if (firstTurnOnlyMoves.includes(mergedMove.name) && (aiPoke.turnsOnField || 0) > 0) {
            continue;
        }
        const dmgResult = simulateDamage(aiPoke, playerPoke, mergedMove);
        const priority = mergedMove.priority || 0;
        const normalDmg = dmgResult.damage;
        // ã€è°ƒè¯•ã€‘è¾“å‡ºæ¯ä¸ªæŠ€èƒ½çš„ä¼¤å®³
        if (normalDmg >= targetHp * 0.5) {
            console.log(`[AI KILL CHECK] ${mergedMove.name}: dmg=${normalDmg}, targetHp=${targetHp}, canKill=${normalDmg >= targetHp}`);
        }
        // ã€v3.2ã€‘è®¡ç®—è¿…ç–¾ä¼¤å®³ï¼ˆé€Ÿåº¦æ…¢æ—¶ç”¨0.5xï¼‰
        const agileDmg = Math.floor(normalDmg * 0.50);
        // èƒ½æ–©æ€
        if (normalDmg >= targetHp) {
            // é€Ÿåº¦å¿« + èƒ½ç§’ = å®Œç¾æ–©æ€
            if (aiFaster && priority >= bestKillPriority) {
                bestKillMove = { move, reasoning: 'Speed advantage kill', style: null };
                bestKillPriority = priority;
            }
            // é€Ÿåº¦æ…¢ä½†æœ‰å…ˆåˆ¶æŠ€ = å…ˆåˆ¶æ–©æ€
            else if (!aiFaster && priority > 0 && priority > bestKillPriority) {
                bestKillMove = { move, reasoning: 'Priority move kill', style: null };
                bestKillPriority = priority;
            }
            // ã€v3.4 ä¿®å¤ã€‘é€Ÿåº¦æ…¢ + æ™®é€šèƒ½æ–©æ€ + è¿…ç–¾ä¹Ÿèƒ½æ–©æ€ = ç”¨è¿…ç–¾æŠ¢å…ˆæ‰‹
            else if (!aiFaster && priority <= 0 && agileDmg >= targetHp) {
                console.log(`[AI STYLE] è¿…ç–¾æŠ¢å…ˆæ–©æ€: ${mergedMove.name} (${agileDmg} >= ${targetHp})`);
                bestKillMove = { move, reasoning: 'Agile style kill', style: 'agile' };
                bestKillPriority = 999;
            }
            // é€Ÿåº¦æ…¢æ— å…ˆåˆ¶ï¼Œè¿…ç–¾æ€ä¸æ­»ï¼ˆèµŒå¯¹é¢ä¸ç§’æˆ‘ï¼‰
            else if (!bestKillMove && normalDmg >= targetHp * 1.2) {
                bestKillMove = { move, reasoning: 'Overkill gamble', style: null };
            }
        }
        // é€Ÿåº¦æ…¢ + æ™®é€šæ€ä¸æ­» + è¿…ç–¾èƒ½æ–©æ€ = è¿…ç–¾æŠ¢å…ˆæ–©æ€
        else if (!aiFaster && priority <= 0 && agileDmg >= targetHp) {
            console.log(`[AI STYLE] è¿…ç–¾æ–©æ€æ£€æµ‹: ${mergedMove.name} (${normalDmg}*0.5=${agileDmg} >= ${targetHp})`);
            bestKillMove = { move, reasoning: 'Agile style kill', style: 'agile' };
            bestKillPriority = 999;
        }
        // ã€v3.3 ç§»é™¤åˆšçŒ›æ–©æ€ã€‘é€Ÿåº¦å¿«æ—¶ç”¨åˆšçŒ›ä¼šå–å…ˆæ‰‹ï¼Œå¤ªå±é™©
        // åˆšçŒ›åªåœ¨ tryOptimizeStyle ä¸­çš„æ–©æ€çº¿åœºæ™¯ä½¿ç”¨ï¼ˆé€Ÿåº¦æ…¢æ—¶ï¼‰
    }
    return bestKillMove;
}
/**
 * å±æœºé—ªé¿ï¼šåœ¨æ–©æ€çº¿æ—¶å¯»æ‰¾åŠæ— æ•ŒæŠ€èƒ½èº²é¿ [v3.5]
 * 
 * æ ¸å¿ƒé€»è¾‘ï¼š
 * 1. æ£€æµ‹æ˜¯å¦å¤„äºæ–©æ€çº¿ï¼ˆå¯¹æ–¹èƒ½ä¸€å‡»ç§’æ€æˆ‘ï¼‰
 * 2. å¦‚æœæˆ‘é€Ÿåº¦æ›´å¿«ï¼Œä½¿ç”¨åŠæ— æ•ŒæŠ€èƒ½å¯ä»¥èº²é¿æœ¬å›åˆæ”»å‡»
 * 3. åŠæ— æ•ŒæŠ€èƒ½ï¼šDig, Fly, Dive, Bounce, Phantom Force, Shadow Force
 * 
 * @returns {object|null} { move, reasoning } æˆ– null
 */
function findEvasionMove(aiPoke, playerPoke) {
    // åŠæ— æ•ŒæŠ€èƒ½åˆ—è¡¨ï¼ˆä» charge-moves.js çš„ type: 'invuln' é…ç½®ï¼‰
    const INVULN_MOVES = ['Dig', 'Fly', 'Dive', 'Bounce', 'Phantom Force', 'Shadow Force', 'Sky Drop'];
    // è·å–é€Ÿåº¦
    const mySpeed = getEffectiveSpeed(aiPoke);
    const targetSpeed = getEffectiveSpeed(playerPoke);
    const isTrickRoom = (typeof battle !== 'undefined') && battle.field && battle.field.trickRoom > 0;
    const aiFaster = isTrickRoom ? (mySpeed < targetSpeed) : (mySpeed > targetSpeed);
    // å¦‚æœé€Ÿåº¦æ…¢ï¼ŒåŠæ— æ•ŒæŠ€èƒ½æ²¡æœ‰æ„ä¹‰ï¼ˆä¼šå…ˆè¢«æ‰“æ­»ï¼‰
    if (!aiFaster) {
        return null;
    }
    // è®¡ç®—å¯¹æ–¹æœ€å¤§ä¼¤å®³
    let maxIncomingDmg = 0;
    for (const pMove of playerPoke.moves) {
        const mergedMove = getMergedMoveData(pMove);
        const dmgResult = simulateDamage(playerPoke, aiPoke, mergedMove);
        if (dmgResult.damage > maxIncomingDmg) {
            maxIncomingDmg = dmgResult.damage;
        }
    }
    const myHp = aiPoke.currHp;
    const willDieNextTurn = maxIncomingDmg >= myHp;
    // å¦‚æœä¸ä¼šæ­»ï¼Œä¸éœ€è¦é—ªé¿
    if (!willDieNextTurn) {
        return null;
    }
    // æ£€æŸ¥æ˜¯å¦æœ‰å¼ºåŠ›é¦™è‰ï¼ˆæœ‰é¦™è‰çš„è¯ï¼Œè“„åŠ›æŠ€èƒ½å˜æˆå³å‘ï¼Œæ›´æœ‰ä»·å€¼ï¼‰
    const hasHerb = (aiPoke.item || '').toLowerCase().includes('power herb') || 
                    (aiPoke.item || '').includes('å¼ºåŠ›é¦™è‰');
    // å¯»æ‰¾åŠæ— æ•ŒæŠ€èƒ½
    let bestEvasionMove = null;
    let bestDamage = 0;
    for (const move of aiPoke.moves) {
        if (INVULN_MOVES.includes(move.name)) {
            const mergedMove = getMergedMoveData(move);
            const dmgResult = simulateDamage(aiPoke, playerPoke, mergedMove);
            // æ£€æŸ¥æ˜¯å¦å…ç–«ï¼ˆ0 ä¼¤å®³è¯´æ˜å±æ€§å…ç–«ï¼‰
            if (dmgResult.damage <= 0) {
                continue;
            }
            // é€‰æ‹©ä¼¤å®³æœ€é«˜çš„åŠæ— æ•ŒæŠ€èƒ½
            if (dmgResult.damage > bestDamage) {
                bestDamage = dmgResult.damage;
                bestEvasionMove = move;
            }
        }
    }
    if (bestEvasionMove) {
        const reasoning = hasHerb 
            ? `Crisis evasion with Power Herb (instant ${bestEvasionMove.name})`
            : `Crisis evasion: ${bestEvasionMove.name} to dodge lethal attack`;
        console.log(`[AI EVASION] ${aiPoke.name} å¤„äºæ–©æ€çº¿ (${myHp}HP vs ${maxIncomingDmg}ä¼¤å®³)ï¼Œä½¿ç”¨ ${bestEvasionMove.name} é—ªé¿`);
        return { move: bestEvasionMove, reasoning };
    }
    return null;
}
/**
 * å¨èƒè¯„ä¼°ï¼šåˆ¤æ–­ AI æ˜¯å¦å¤„äºå±é™©
 * v2.0ï¼šåŠ å…¥è§’è‰²ç±»å‹åˆ¤æ–­ï¼ˆSweeper æ›´æƒœå‘½ï¼‰
 */
function assessThreat(aiPoke, playerPoke) {
    let maxIncomingDmg = 0;
    let worstPlayerMove = null;
    let worstMoveType = null;
    // æ¨¡æ‹Ÿç©å®¶æ‰€æœ‰æŠ€èƒ½å¯¹ AI çš„ä¼¤å®³
    for (const pMove of playerPoke.moves) {
        const mergedMove = getMergedMoveData(pMove);
        const dmgResult = simulateDamage(playerPoke, aiPoke, mergedMove);
        if (dmgResult.damage > maxIncomingDmg) {
            maxIncomingDmg = dmgResult.damage;
            worstPlayerMove = mergedMove;
            worstMoveType = mergedMove.type;
        }
    }
    const myHp = aiPoke.currHp;
    const myMaxHp = aiPoke.maxHp;
    const hpPercent = myHp / myMaxHp;
    // === æ–°å¢ï¼šè¯„ä¼°æˆ‘çš„åå‡»èƒ½åŠ› ===
    let canKillPlayer = false;
    let myBestDamage = 0;
    let myBestMove = null;
    for (const myMove of aiPoke.moves) {
        const mergedMove = getMergedMoveData(myMove);
        const dmgResult = simulateDamage(aiPoke, playerPoke, mergedMove);
        if (dmgResult.damage > myBestDamage) {
            myBestDamage = dmgResult.damage;
            myBestMove = mergedMove;
        }
        if (dmgResult.damage >= playerPoke.currHp) {
            canKillPlayer = true;
        }
    }
    // åˆ¤æ–­æ˜¯å¦æœ‰ä¼˜åŠ¿ï¼šèƒ½ç§’æ€å¯¹æ–¹ï¼Œæˆ–è€…æˆ‘çš„ä¼¤å®³è¿œè¶…å¯¹æ–¹
    const haveAdvantage = canKillPlayer || (myBestDamage > maxIncomingDmg * 1.3);
    // === v2.0ï¼šè§’è‰²ç±»å‹åˆ¤æ–­ ===
    // é«˜é€Ÿè„†çš® (Sweeper)ï¼šé€Ÿåº¦é«˜ + æ”»å‡»/ç‰¹æ”»é«˜ + é˜²å¾¡ä½
    const baseSpe = aiPoke.baseStats?.spe || aiPoke.spe || 80;
    const baseAtk = aiPoke.baseStats?.atk || aiPoke.atk || 80;
    const baseSpa = aiPoke.baseStats?.spa || aiPoke.spa || 80;
    const baseDef = aiPoke.baseStats?.def || aiPoke.def || 80;
    const baseSpd = aiPoke.baseStats?.spd || aiPoke.spd || 80;
    const isSweeper = baseSpe >= 95 && (baseAtk >= 100 || baseSpa >= 100);
    const isBulky = (baseDef + baseSpd) >= 180;
    // å±é™©é˜ˆå€¼ï¼šè„†çš®è¾“å‡ºæ‰‹æ›´æƒœå‘½
    // Sweeper: å—åˆ° 45% ä»¥ä¸Šä¼¤å®³å°±è§†ä¸ºå±é™©
    // Tank: å—åˆ° 88% ä»¥ä¸Šä¼¤å®³æ‰è§†ä¸ºå±é™©
    const dangerThreshold = isSweeper ? 0.45 : (isBulky ? 0.88 : 0.7);
    const willDieNextTurn = maxIncomingDmg >= myHp;
    const playerFaster = getEffectiveSpeed(playerPoke) > getEffectiveSpeed(aiPoke);
    // v2.0 å±é™©åˆ¤å®šï¼š
    // 1. ä¸‹å›åˆå¿…æ­»ä¸”å¯¹æ–¹é€Ÿåº¦å¿«
    // 2. æˆ–è€…å—åˆ°çš„ä¼¤å®³è¶…è¿‡è§’è‰²ç±»å‹é˜ˆå€¼ä¸”å¯¹æ–¹é€Ÿåº¦å¿«
    const significantDamage = maxIncomingDmg >= myMaxHp * dangerThreshold;
    const amIInDanger = (willDieNextTurn && playerFaster) || 
                        (significantDamage && playerFaster && hpPercent < 0.8);
    return {
        maxIncomingDmg,
        worstPlayerMove,
        worstMoveType,
        willDieNextTurn,
        playerFaster,
        amIInDanger,
        // æ–°å¢è¿”å›å€¼
        haveAdvantage,
        canKillPlayer,
        myBestDamage,
        myBestMove,
        // v2.0 è§’è‰²ç±»å‹
        isSweeper,
        isBulky,
        dangerThreshold
    };
}
/**
 * å¯»æ‰¾æœ€ä½³æ¢äººç›®æ ‡
 */
function findBestPivot(aiPoke, playerPoke, aiParty, threatAssessment) {
    const { worstPlayerMove, worstMoveType, maxIncomingDmg } = threatAssessment;
    if (!worstPlayerMove) return null;
    let bestPivotIndex = -1;
    let bestPivotScore = -Infinity;
    let bestPivotReasoning = '';
    for (let i = 0; i < aiParty.length; i++) {
        const ally = aiParty[i];
        // è·³è¿‡è‡ªå·±å’Œå·²å€’ä¸‹çš„ï¼ˆä¸¥æ ¼æ£€æŸ¥ HP > 0ï¼‰
        if (!ally) continue;
        if (ally === aiPoke) continue;
        if (typeof ally.isAlive !== 'function' || !ally.isAlive()) continue;
        if (!ally.currHp || ally.currHp <= 0) continue;
        // è®¡ç®—é˜Ÿå‹æ‰¿å—ä¼¤å®³
        const simDmg = simulateDamage(playerPoke, ally, worstPlayerMove);
        const allyHpPercent = simDmg.damage / ally.maxHp;
        // è®¡ç®—å±æ€§å…‹åˆ¶
        const eff = getTypeEffectivenessAI(worstMoveType || 'Normal', ally.types || ['Normal']);
        let pivotScore = 0;
        let reasoning = '';
        // [æˆ˜æœ¯ä¿®æ­£] é˜²æ­¢è‡ªæ€å¼æ¢äººï¼šè¢«å…‹åˆ¶ (2x+) ç›´æ¥è´Ÿåˆ†
        if (eff >= 2) {
            pivotScore = -10000; // ç»å¯¹ä¸æ¢ï¼è¿™æ˜¯é€æ­»
            reasoning = `SUICIDE SWITCH BLOCKED: ${ally.cnName || ally.name} is weak to ${worstMoveType}`;
            console.log(`[AI TACTIC] é˜»æ­¢è‡ªæ€æ¢äºº: ${ally.cnName} å¼± ${worstMoveType} (${eff}x)`);
        }
        // å…ç–« = ç»å¯¹æœ€é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»é€‰æ‹©å…ç–«çš„å®å¯æ¢¦ï¼‰
        else if (eff === 0) {
            pivotScore = 99999;
            reasoning = `Perfect Immunity switch to ${ally.cnName || ally.name}`;
        }
        // æŠµæŠ— (0.5x æˆ–æ›´ä½)
        else if (eff <= 0.5) {
            pivotScore = 5000 - allyHpPercent * 1000;
            reasoning = `Resist switch to ${ally.cnName || ally.name}`;
        }
        // æ™®é€šæ•ˆæœä½†ä¼¤å®³å¯æ§ (<40% HP)
        else if (allyHpPercent < 0.4) {
            pivotScore = 2000 - allyHpPercent * 1000;
            reasoning = `Safe switch to ${ally.cnName || ally.name}`;
        }
        // ä¼¤å®³è¾ƒé«˜ä½†æ¯”ç•™åœºå¥½
        else if (allyHpPercent < 0.7 && threatAssessment.willDieNextTurn) {
            pivotScore = 500 - allyHpPercent * 500;
            reasoning = `Sacrifice switch to ${ally.cnName || ally.name}`;
        }
        // [æˆ˜æœ¯ä¿®æ­£] æ™®é€šæ•ˆæœä½†ä¼šè¢«ç§’æ€ï¼Œä¹Ÿä¸æ¢
        else if (allyHpPercent >= 0.9) {
            pivotScore = -5000; // ä¼šè¢«ç§’æ€ï¼Œä¸æ¢
            reasoning = `OHKO SWITCH BLOCKED: ${ally.cnName || ally.name} would be KO'd`;
        }
        // é¢å¤–åŠ åˆ†ï¼šé˜Ÿå‹èƒ½åæ€ç©å®¶
        if (pivotScore > 0) {
            const allyKillMove = findKillMoveForAlly(ally, playerPoke);
            if (allyKillMove) {
                pivotScore += 1000;
                reasoning += ' (can revenge kill)';
            }
        }
        if (pivotScore > bestPivotScore) {
            bestPivotScore = pivotScore;
            bestPivotIndex = i;
            bestPivotReasoning = reasoning;
        }
    }
    // åªæœ‰å½“æ¢äººæ˜æ˜¾æ¯”ç•™åœºå¥½æ—¶æ‰æ¢
    // ç•™åœºç­‰æ­» vs æ¢äººèƒ½æ´»
    if (bestPivotIndex !== -1 && bestPivotScore > 0) {
        return {
            type: AI_ACTION_TYPE.SWITCH,
            index: bestPivotIndex,
            reasoning: bestPivotReasoning
        };
    }
    return null;
}
/**
 * æ£€æŸ¥é˜Ÿå‹æ˜¯å¦èƒ½åæ€
 */
function findKillMoveForAlly(ally, target) {
    if (!ally.moves) return null;
    for (const move of ally.moves) {
        const mergedMove = getMergedMoveData(move);
        const dmgResult = simulateDamage(ally, target, mergedMove);
        if (dmgResult.damage >= target.currHp) {
            return move;
        }
    }
    return null;
}
/**
 * v2.0ï¼šæˆ˜ç•¥æ€§æ¢äººæ£€æŸ¥
 * æ£€æŸ¥æ˜¯å¦å› ä¸ºè´Ÿé¢çŠ¶æ€éœ€è¦æ¢äººï¼ˆè€Œéä»…ä»…æ˜¯ä¿å‘½ï¼‰
 */
function shouldStrategicSwitch(aiPoke) {
    // 1. è¢«å¤§å¹…é™èƒ½åŠ› (æµæ˜Ÿç¾¤/è¿‘èº«æˆ˜åé—ç—‡ æˆ– è¢«å¨å“å¤šæ¬¡)
    const boosts = aiPoke.boosts || {};
    if ((boosts.atk || 0) <= -2 || (boosts.spa || 0) <= -2) {
        return true;
    }
    // 2. é€Ÿåº¦è¢«å¤§å¹…é™ä½ï¼ˆé»é»ç½‘/å²©çŸ³å°é”ï¼‰
    if ((boosts.spe || 0) <= -2) {
        return true;
    }
    // 3. å³å°†ç¡ç€ (å“ˆæ¬ )
    const volatile = aiPoke.volatile || aiPoke.volatileStatus || {};
    if (volatile.yawn || volatile.Yawn) {
        return true;
    }
    // 4. ç­äº¡ä¹‹æ­Œå€’è®¡æ—¶
    if (volatile.perishsong || volatile.PerishSong) {
        return true;
    }
    // 5. è¢«æŒ‘è¡…ä½†ä¸»è¦æ˜¯è¾…åŠ©å‹
    if (volatile.taunt || volatile.Taunt) {
        // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ”»å‡»æŠ€èƒ½
        const attackMoves = (aiPoke.moves || []).filter(m => {
            const cat = (m.cat || m.category || '').toLowerCase();
            return cat !== 'status';
        });
        if (attackMoves.length <= 1) {
            return true;
        }
    }
    return false;
}
/**
 * v2.0ï¼šè¯»æ¢é¢„åˆ¤
 * å¦‚æœç©å®¶å½“å‰å®å¯æ¢¦å¿…æ­»ä¸”æ¯” AI æ…¢ï¼Œé¢„æµ‹ç©å®¶ä¼šæ¢äºº
 */
function evaluatePrediction(aiPoke, playerPoke, aiParty) {
    // æ£€æŸ¥ç©å®¶æ˜¯å¦å¿…æ­»
    const playerHp = playerPoke.currHp;
    const playerMaxHp = playerPoke.maxHp;
    const playerHpPercent = playerHp / playerMaxHp;
    // ç©å®¶è¡€é‡å¤ªä½ (<= 20%) ä¸”æ¯” AI æ…¢
    if (playerHpPercent > 0.2) return null;
    const aiFaster = getEffectiveSpeed(aiPoke) > getEffectiveSpeed(playerPoke);
    if (!aiFaster) return null;
    // æ£€æŸ¥ AI æ˜¯å¦èƒ½ç§’æ€å½“å‰ç©å®¶
    let canKillCurrent = false;
    let bestKillMove = null;
    let bestKillDamage = 0;
    for (const move of aiPoke.moves) {
        const mergedMove = getMergedMoveData(move);
        const dmgResult = simulateDamage(aiPoke, playerPoke, mergedMove);
        if (dmgResult.damage >= playerHp) {
            canKillCurrent = true;
            if (dmgResult.damage > bestKillDamage) {
                bestKillDamage = dmgResult.damage;
                bestKillMove = mergedMove;
            }
        }
    }
    if (!canKillCurrent || !bestKillMove) return null;
    // ç©å®¶å¿…æ­»ï¼Œé¢„æµ‹ç©å®¶ä¼šæ¢äºº
    // é¢„è¯»é€»è¾‘ï¼šå¦‚æœæœ€ä½³æŠ€èƒ½æ˜¯å•å±æ€§å…‹åˆ¶æŠ€èƒ½ï¼Œè€ƒè™‘æ¢ä¸€ä¸ªè¦†ç›–é¢æ›´å¹¿çš„æŠ€èƒ½
    const coveragePairs = {
        'Ground': ['Ice', 'Rock', 'Water'],      // åœ°é¢è¢«é£è¡Œå…ç–«ï¼Œç”¨å†°/å²©çŸ³æ‰“
        'Electric': ['Ice', 'Grass', 'Ground'],  // ç”µè¢«åœ°é¢å…ç–«ï¼Œç”¨å†°/è‰æ‰“
        'Fighting': ['Flying', 'Psychic'],       // æ ¼æ–—è¢«å¹½çµå…ç–«ï¼Œç”¨é£è¡Œ/è¶…èƒ½æ‰“
        'Normal': ['Fighting', 'Ghost'],         // ä¸€èˆ¬è¢«å¹½çµå…ç–«
        'Poison': ['Ground', 'Psychic']          // æ¯’è¢«é’¢å…ç–«
    };
    const bestMoveType = bestKillMove.type;
    const coverageTypes = coveragePairs[bestMoveType];
    if (!coverageTypes) return null;
    // æ‰¾ä¸€ä¸ªè¦†ç›–æŠ€èƒ½
    for (const move of aiPoke.moves) {
        const mergedMove = getMergedMoveData(move);
        if (coverageTypes.includes(mergedMove.type) && (mergedMove.basePower || mergedMove.power || 0) >= 60) {
            // 50% æ¦‚ç‡ä½¿ç”¨é¢„è¯»æŠ€èƒ½ï¼ˆä¸è¦å¤ªæ¿€è¿›ï¼‰
            if (Math.random() < 0.5) {
                return {
                    move: move,
                    reasoning: `Prediction: expecting switch, using ${mergedMove.type} coverage`
                };
            }
        }
    }
    return null;
}
/**
 * è¯„ä¼°æˆ˜ç•¥æ€§æŠ€èƒ½ï¼ˆå¼ºåŒ–ã€çŠ¶æ€ã€å›å¤ï¼‰
 */
function evaluateStrategicMoves(aiPoke, playerPoke, threatAssessment) {
    const myHpPercent = aiPoke.currHp / aiPoke.maxHp;
    const myHp = aiPoke.currHp;
    const myMaxHp = aiPoke.maxHp;
    // å¦‚æœå¤„äºå±é™©ï¼Œä¸è¦å¼ºåŒ–ï¼Œç›´æ¥æ‰“
    if (threatAssessment.amIInDanger) {
        console.log('[AI] amIInDanger=true, skipping strategic moves');
        return null;
    }
    // å…³é”®ä¿®å¤ï¼šå¦‚æœä¸‹å›åˆå¿…æ­»ä¸”å¯¹æ–¹é€Ÿåº¦å¿«ï¼Œç»å¯¹ä¸è¦ç”¨å¼ºåŒ–æŠ€
    // è¿™æ˜¯æœ€åçš„å®‰å…¨ç½‘ï¼Œé˜²æ­¢ AI è‡ªæ€å¼å‰‘èˆ
    if (threatAssessment.willDieNextTurn && threatAssessment.playerFaster) {
        console.log('[AI] Will die next turn to faster opponent, skipping strategic moves');
        return null;
    }
    // ã€æ–°å¢ã€‘2HKO æ£€æŸ¥ï¼šå¦‚æœå¯¹æ–¹èƒ½ä¸¤å›åˆå‡»æ€ä¸”é€Ÿåº¦æ›´å¿«ï¼Œä¸è¦å¼ºåŒ–
    // è¿™é˜²æ­¢äº†"æ»¡è¡€å‰‘èˆè¢«ç§’"çš„è‡ªæ€è¡Œä¸º
    const canBe2HKOd = threatAssessment.maxIncomingDmg * 2 >= myHp;
    if (canBe2HKOd && threatAssessment.playerFaster) {
        console.log(`[AI] Can be 2HKO'd by faster opponent (${threatAssessment.maxIncomingDmg}x2 >= ${myHp}), skipping strategic moves`);
        return null;
    }
    // ã€æ–°å¢ã€‘å±æ€§å…‹åˆ¶æ£€æŸ¥ï¼šå¦‚æœå¯¹æ–¹æœ‰ 2 å€å…‹åˆ¶æŠ€èƒ½ä¸”é€Ÿåº¦æ›´å¿«ï¼Œä¸è¦å¼ºåŒ–
    if (threatAssessment.worstMoveType && threatAssessment.playerFaster) {
        const eff = getTypeEffectivenessAI(threatAssessment.worstMoveType, aiPoke.types || ['Normal']);
        if (eff >= 2) {
            console.log(`[AI] Weak to ${threatAssessment.worstMoveType} (${eff}x) and slower, skipping strategic moves`);
            return null;
        }
    }
    let bestStrategicMove = null;
    let bestStrategicScore = 0;
    for (const move of aiPoke.moves) {
        const moveName = move.name || '';
        let score = 0;
        let reasoning = '';
        // === å¼ºåŒ–æŠ€èƒ½ ===
        // ã€ä¿®å¤ã€‘ä½¿ç”¨ moves-data.js çš„ boosts å­—æ®µæ£€æµ‹å¼ºåŒ–æŠ€ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç åˆ—è¡¨
        const moveId = moveName.toLowerCase().replace(/[^a-z0-9]/g, '');
        const moveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
        const boosts = moveData.boosts || null;
        const target = moveData.target || 'normal';
        // æ£€æµ‹æ˜¯å¦æ˜¯è‡ªèº«å¼ºåŒ–æŠ€èƒ½
        const isSelfBoost = boosts && ['self', 'allySide', 'adjacentAllyOrSelf'].includes(target);
        if (isSelfBoost) {
            // ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥æ‰€æœ‰æ­£é¢å¼ºåŒ–æ˜¯å¦å·²æ»¡çº§ (+6)
            const currentBoosts = aiPoke.boosts || {};
            let anyBoostMaxed = false;
            for (const stat of Object.keys(boosts)) {
                if (boosts[stat] > 0 && (currentBoosts[stat] || 0) >= 6) {
                    console.log(`[AI STRATEGIC] ${aiPoke.cnName} çš„ ${stat} å·²æ»¡çº§ (+6)ï¼Œç¦æ­¢ä½¿ç”¨ ${moveName}`);
                    anyBoostMaxed = true;
                    break;
                }
            }
            if (!anyBoostMaxed) {
                // æ£€æŸ¥ç›¸å…³èƒ½åŠ›æ˜¯å¦å·²ç»å¼ºåŒ–è¶³å¤Ÿ
                const relevantBoost = aiPoke.spa > aiPoke.atk ? (currentBoosts.spa || 0) : (currentBoosts.atk || 0);
                const defBoost = currentBoosts.def || 0;
                const spdBoost = currentBoosts.spd || 0;
                // æ”»å‡»/ç‰¹æ”»å¼ºåŒ–
                if (boosts.atk > 0 || boosts.spa > 0) {
                    if (myHpPercent > 0.6 && relevantBoost < 2) {
                        score = 150;
                        reasoning = 'Setup opportunity';
                    } else if (myHpPercent > 0.4 && relevantBoost === 0) {
                        score = 80;
                        reasoning = 'Risky setup';
                    }
                }
                // é˜²å¾¡å¼ºåŒ–ï¼ˆå¦‚ Iron Defenseï¼‰
                else if (boosts.def > 0 && defBoost < 2) {
                    if (myHpPercent > 0.7) {
                        score = 80;
                        reasoning = 'Defensive setup';
                    }
                }
                // ç‰¹é˜²å¼ºåŒ–ï¼ˆå¦‚ Amnesiaï¼‰
                else if (boosts.spd > 0 && spdBoost < 2) {
                    if (myHpPercent > 0.7) {
                        score = 80;
                        reasoning = 'Special defense setup';
                    }
                }
            }
        }
        // === å›å¤æŠ€èƒ½ === ã€è½¯ç¼–ç ã€‘ä½¿ç”¨ PS çš„ heal å­—æ®µ
        const moveHealData = moveData.heal || (moveData.flags && moveData.flags.heal);
        const isSelfHeal = moveHealData && (target === 'self' || target === 'adjacentAllyOrSelf');
        if (isSelfHeal) {
            if (myHpPercent < 0.4) {
                score = 200;
                reasoning = 'Critical heal';
            } else if (myHpPercent < 0.6) {
                score = 100;
                reasoning = 'Preventive heal';
            }
        }
        // === çŠ¶æ€æŠ€èƒ½ === ã€è½¯ç¼–ç ã€‘ä½¿ç”¨ PS çš„ status å­—æ®µ
        const moveStatusEffect = moveData.status; // 'slp', 'par', 'brn', 'psn', 'tox'
        if (moveStatusEffect && !playerPoke.status) {
            // å¯¹æ‰‹æ²¡æœ‰çŠ¶æ€æ‰ç”¨
            // ç¡çœ æ‹›å¼
            if (moveStatusEffect === 'slp') {
                // ã€ä¿®å¤ã€‘æ£€æŸ¥ç›®æ ‡æ˜¯å¦å…ç–«ç¡çœ 
                // ã€è½¯ç¼–ç ã€‘ä» AbilityHandlers è¯»å–ç¡çœ å…ç–«ç‰¹æ€§åˆ—è¡¨
                const targetAbility = (playerPoke.ability || '').toLowerCase().replace(/[^a-z]/g, '');
                const sleepImmuneAbilities = (typeof AbilityHandlers !== 'undefined' && AbilityHandlers._sleepImmuneAbilities) 
                    ? AbilityHandlers._sleepImmuneAbilities 
                    : ['insomnia', 'vitalspirit', 'comatose', 'purifyingsalt', 'sweetveil'];
                const isImmune = sleepImmuneAbilities.includes(targetAbility);
                if (!isImmune) {
                    score = 180;
                    reasoning = 'Sleep opportunity';
                }
                // å¦‚æœå…ç–«åˆ™ä¸ç»™åˆ†ï¼Œè·³è¿‡æ­¤æ‹›å¼
            // éº»ç—¹æ‹›å¼
            } else if (moveStatusEffect === 'par' && getEffectiveSpeed(playerPoke) > getEffectiveSpeed(aiPoke)) {
                score = 120;
                reasoning = 'Speed control';
            // çƒ§ä¼¤æ‹›å¼
            } else if (moveStatusEffect === 'brn' && playerPoke.atk > playerPoke.spa) {
                score = 110;
                reasoning = 'Physical attacker burn';
            // ä¸­æ¯’æ‹›å¼
            } else if (moveStatusEffect === 'psn' || moveStatusEffect === 'tox') {
                score = 90;
                reasoning = 'Chip damage';
            }
        }
        if (score > bestStrategicScore) {
            bestStrategicScore = score;
            bestStrategicMove = { move, reasoning };
        }
    }
    // åªæœ‰å½“æˆ˜ç•¥åˆ†æ•°è¶³å¤Ÿé«˜æ—¶æ‰é€‰æ‹©æˆ˜ç•¥æŠ€èƒ½
    // å¦åˆ™è®©å¸¸è§„ä¼¤å®³è®¡ç®—æ¥å†³å®š
    if (bestStrategicScore >= 100) {
        return bestStrategicMove;
    }
    return null;
}
/* =============================================================
 *  é€šç”¨è¾…åŠ©å‡½æ•°
 * ============================================================= */
/**
 * å¯¹æŠ€èƒ½æŒ‰è¯„åˆ†æ’åº
 */
function rankMovesByScore(attacker, defender, aiParty = null) {
    if (!attacker?.moves) return [];
    // ã€ä¿®å¤ã€‘Choice é“å…·é”æ‹›æ£€æŸ¥
    // å¦‚æœæŒæœ‰ Choice é“å…·ä¸”å·²ç»é”å®šäº†æŠ€èƒ½ï¼Œåªèƒ½ä½¿ç”¨é‚£ä¸ªæŠ€èƒ½
    // ä½¿ç”¨ items-data.js çš„ isChoiceItem å‡½æ•°
    const item = attacker.item || '';
    const checkIsChoice = typeof window !== 'undefined' && typeof window.isChoiceItem === 'function' 
        ? window.isChoiceItem 
        : (i) => i && (i.includes('Choice') || i.includes('è®²ç©¶'));
    const hasChoiceItem = checkIsChoice(item);
    const lockedMove = attacker.choiceLockedMove;
    if (hasChoiceItem && lockedMove) {
        // æ‰¾åˆ°è¢«é”å®šçš„æŠ€èƒ½
        const locked = attacker.moves.find(m => m.name === lockedMove);
        if (locked) {
            console.log(`[AI CHOICE] ${attacker.name} è¢« ${item} é”å®šåœ¨ ${lockedMove}`);
            const mergedMove = getMergedMoveData(locked);
            return [{
                move: locked,
                score: calcMoveScore(attacker, defender, mergedMove, aiParty)
            }];
        }
    }
    return attacker.moves.map(move => {
        const mergedMove = getMergedMoveData(move);
        // === ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘æ£€æŸ¥æŠ€èƒ½æ˜¯å¦è¢«ç¯å¢ƒç¦ç”¨ ===
        if (typeof window !== 'undefined' && window.envOverlay && window.envOverlay.isMoveBanned) {
            if (window.envOverlay.isMoveBanned(attacker, mergedMove)) {
                console.log(`[AI ENV BAN] ${move.name} è¢«ç¯å¢ƒç¦ç”¨`);
                return { move, score: -10000 }; // æä½åˆ†æ•°ï¼ŒAI ä¸ä¼šé€‰æ‹©
            }
        }
        return {
            move,
            score: calcMoveScore(attacker, defender, mergedMove, aiParty)
        };
    }).sort((a, b) => b.score - a.score);
}
/**
 * è·å–åˆå¹¶åçš„æŠ€èƒ½æ•°æ®ï¼ˆæœ¬åœ° + MOVES æ•°æ®åº“ï¼‰
 */
function getMergedMoveData(move) {
    const id = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    let merged = {
        ...move,
        type: move.type || 'Normal',
        cat: move.cat || move.category || 'phys'
    };
    if (typeof MOVES !== 'undefined' && MOVES[id]) {
        const staticData = MOVES[id];
        merged = {
            ...staticData,
            ...move,
            type: move.type || staticData.type || 'Normal',
            basePower: move.power ?? staticData.basePower ?? 0,
            power: move.power ?? staticData.basePower ?? 0,
            priority: staticData.priority ?? move.priority ?? 0,
            cat: (move.cat || (staticData.category ? staticData.category.toLowerCase() : 'phys')),
            // ã€ä¿®å¤ã€‘ç¡®ä¿ boosts å’Œ target ä» staticData è·å–ï¼ˆç”¨äºå¼ºåŒ–æŠ€æ£€æµ‹ï¼‰
            boosts: move.boosts || staticData.boosts || null,
            target: move.target || staticData.target || 'normal'
        };
    }
    return merged;
}
/**
 * æ¨¡æ‹Ÿä¼¤å®³è®¡ç®—ï¼ˆç®€åŒ–ç‰ˆï¼Œç”¨äº AI å†³ç­–ï¼‰
 * ä¿æŒçº¯å‡€ï¼šè¯¥æ˜¯0å°±æ˜¯0ï¼Œä¸åœ¨è¿™é‡Œåšç‰¹æ€§é­”æ”¹
 */
function simulateDamage(attacker, defender, move) {
    // ã€å…³é”®ä¿®å¤ã€‘å‰ç½®å…ç–«æ£€æŸ¥ï¼šç¡®ä¿ AI ä¸ä¼šé€‰æ‹©å¯¹ç›®æ ‡æ— æ•ˆçš„æ‹›å¼
    // è¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„æ£€æŸ¥ï¼Œå¿…é¡»åœ¨ä»»ä½•ä¼¤å®³è®¡ç®—ä¹‹å‰æ‰§è¡Œ
    // ã€é‡è¦ã€‘è€ƒè™‘çš®è‚¤ç³»ç‰¹æ€§çš„å±æ€§è½¬æ¢ (Galvanize, Pixilate, Aerilate, Refrigerate)
    let moveType = move.type || 'Normal';
    if (typeof AbilityHandlers !== 'undefined' && attacker.ability && AbilityHandlers[attacker.ability]) {
        const ah = AbilityHandlers[attacker.ability];
        if (ah.onModifyType) {
            const typeResult = ah.onModifyType(move, attacker, window.battle);
            if (typeResult && typeResult.newType) {
                moveType = typeResult.newType;
                console.log(`[AI SIMULATE] ${attacker.ability} å°† ${move.name} å±æ€§å˜ä¸º ${moveType}`);
            }
        }
    }
    const defenderTypes = defender.types || ['Normal'];
    const preCheckEff = getTypeEffectivenessAI(moveType, defenderTypes, move.name || '');
    if (preCheckEff === 0) {
        console.log(`[AI SIMULATE] ${move.name} (${moveType}) å¯¹ ${defenderTypes.join('/')} æ— æ•ˆï¼Œè·³è¿‡`);
        return { damage: 0, effectiveness: 0 };
    }
    // å¦‚æœæœ‰å…¨å±€ calcDamage å‡½æ•°ï¼Œä½¿ç”¨å®ƒ
    // ä¼ å…¥ isSimulation: true é˜²æ­¢æ¶ˆè€—æŒ‡ä»¤çŠ¶æ€
    if (typeof window.calcDamage === 'function') {
        try {
            const result = window.calcDamage(attacker, defender, move, { isSimulation: true });
            return {
                damage: result.damage || result.singleHitDamage || 0,
                effectiveness: (result.effectiveness !== undefined) ? result.effectiveness : 1
            };
        } catch (e) {
            // å›é€€åˆ°ç®€åŒ–è®¡ç®—
        }
    }
    // ç®€åŒ–ä¼¤å®³è®¡ç®—
    const moveName = move.name || '';
    const category = (move.cat || move.category || '').toLowerCase();
    const isStatus = category === 'status' || move.power === 0 || move.basePower === 0;
    if (isStatus) {
        return { damage: 0, effectiveness: 1 };
    }
    const usesSpecial = category === 'spec' || category === 'special';
    let atkStat = usesSpecial ? (attacker.getStat?.('spa') || attacker.spa) : (attacker.getStat?.('atk') || attacker.atk);
    const defStat = usesSpecial ? (defender.getStat?.('spd') || defender.spd) : (defender.getStat?.('def') || defender.def);
    // çƒ§ä¼¤å‡åŠç‰©æ”»
    if (!usesSpecial && attacker.status === 'brn') {
        atkStat = Math.floor(atkStat * 0.5);
    }
    const eff = getTypeEffectivenessAI(move.type || 'Normal', defender.types || ['Normal'], moveName);
    if (eff === 0) return { damage: 0, effectiveness: 0 };
    const stab = (attacker.types || []).includes(move.type) ? 1.5 : 1.0;
    const power = move.basePower ?? move.power ?? 0;
    const level = attacker.level || 50;
    const baseDamage = ((2 * level / 5 + 2) * power * (atkStat / Math.max(1, defStat)) / 50 + 2) * stab * eff;
    return {
        damage: Math.floor(baseDamage * 0.925),
        effectiveness: eff
    };
}
/**
 * è¯„ä¼°æŠ€èƒ½çš„æˆ˜æœ¯å½±å“åŠ›ï¼ˆè½¯ç¼–ç ï¼Œæ•°æ®é©±åŠ¨ï¼‰
 * ç»¼åˆè€ƒè™‘ï¼šæŠ¤ç›¾ç ´é™¤ã€æ»¡è¡€ä¿å‘½ã€å¨èƒç­‰çº§ç­‰å› ç´ 
 * @returns {object} { totalScore, rawDamage, effectiveness, shieldBreak, threatBonus }
 */
function evaluateMoveImpact(attacker, defender, move) {
    // 1. è·å–åŸºç¡€ä¼¤å®³æ¨¡æ‹Ÿ
    const dmgResult = simulateDamage(attacker, defender, move);
    let baseScore = dmgResult.damage;
    const eff = dmgResult.effectiveness;
    // å…ç–«ç›´æ¥è¿”å›
    if (eff === 0) {
        return { totalScore: -9999, rawDamage: 0, effectiveness: 0 };
    }
    // è·å–æŠ€èƒ½åˆ†ç±»
    const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    const category = (fullMoveData.category || move.cat || '').toLowerCase();
    const isAttackMove = category !== 'status' && (move.power > 0 || move.basePower > 0);
    // 2. ç‰¹æ€§è¯„ä¼°ï¼ˆè½¯ç¼–ç ï¼Œä»é…ç½®è¯»å–ï¼‰
    const defAbility = defender.ability || '';
    const trait = AI_ABILITY_TRAITS[defAbility];
    let shieldBreak = false;
    if (trait && isAttackMove) {
        // === Case A: æ¶ˆè€—å‹æŠ¤ç›¾ï¼ˆç”»çš®ã€å†°ç Œé¹…ï¼‰===
        if (trait.type === 'consumable_shield') {
            const bustedFlag = trait.bustedFlag || 'shieldBusted';
            const isShieldActive = !defender[bustedFlag];
            // æ£€æŸ¥æ¡ä»¶ï¼ˆå¦‚å†°ç Œé¹…åªé˜²ç‰©ç†ï¼‰
            let conditionMet = true;
            if (trait.condition === 'physical') {
                conditionMet = category === 'physical';
            } else if (trait.condition === 'special') {
                conditionMet = category === 'special';
            }
            if (isShieldActive && conditionMet && dmgResult.damage === 0) {
                // æŠ¤ç›¾æŒ¡ä½äº†æ”»å‡»ï¼Œä½†ç ´ç›¾æœ‰æˆ˜æœ¯ä»·å€¼
                let breakValue = trait.breakValue;
                // ã€ä¿®å¤ã€‘Ice Face åœ¨é›ªå¤©ä¸‹ä¼šæ¢å¤ï¼Œç ´ç›¾ä»·å€¼å¤§å¹…é™ä½
                if (defAbility === 'Ice Face') {
                    const battle = typeof window !== 'undefined' ? window.battle : null;
                    const weather = battle?.weather;
                    if (weather === 'snow' || weather === 'hail') {
                        // é›ªå¤©ä¸‹ç ´ç›¾å‡ ä¹æ— æ„ä¹‰ï¼Œå› ä¸ºå›åˆç»“æŸä¼šæ¢å¤
                        breakValue = 50; // å¤§å¹…é™ä½ç ´ç›¾ä»·å€¼
                        console.log(`[AI] Ice Face åœ¨é›ªå¤©ä¸‹ï¼Œç ´ç›¾ä»·å€¼é™ä½: ${trait.breakValue} -> ${breakValue}`);
                    }
                }
                baseScore += breakValue;
                shieldBreak = true;
            }
        }
        // === Case B: æ»¡è¡€å‡ä¼¤ï¼ˆå¤šé‡é³ç‰‡ï¼‰===
        else if (trait.type === 'damage_reduction' && trait.condition === 'full_hp') {
            if (defender.currHp === defender.maxHp && dmgResult.damage > 0) {
                // æ‰“ç ´æ»¡è¡€çŠ¶æ€æœ‰ä»·å€¼
                baseScore += trait.breakValue;
            }
        }
        // === Case C: æ»¡è¡€ä¿å‘½ï¼ˆç»“å®ï¼‰===
        else if (trait.type === 'endure_lethal' && trait.condition === 'full_hp') {
            if (defender.currHp === defender.maxHp && dmgResult.damage > 0) {
                baseScore += trait.breakValue;
            }
        }
    }
    // 3. é“å…·è¯„ä¼°ï¼ˆæ°”åŠ¿æŠ«å¸¦ï¼‰
    const defItem = (defender.item || '').toLowerCase().replace(/[^a-z]/g, '');
    if (defItem === 'focussash' && defender.currHp === defender.maxHp && dmgResult.damage > 0) {
        baseScore += 150; // æ‰“ç ´æ°”è…°çš„æ»¡è¡€çŠ¶æ€
    }
    // 4. å¨èƒç­‰çº§è¯„ä¼°ï¼ˆå¯¹æ‰‹å¼ºåŒ–ç¨‹åº¦ï¼‰
    let threatLevel = 0;
    const defBoosts = defender.boosts || {};
    threatLevel += Math.max(0, (defBoosts.atk || 0) - 1) * 100;
    threatLevel += Math.max(0, (defBoosts.spa || 0) - 1) * 100;
    if ((defBoosts.spe || 0) > 0) threatLevel *= 1.5;
    let threatBonus = 0;
    if (threatLevel > 100) {
        if (isAttackMove) {
            // æ”»å‡»æŠ€èƒ½åŠ åˆ†
            threatBonus = threatLevel;
            // å…‹åˆ¶æŠ€èƒ½é¢å¤–åŠ åˆ†
            if (eff >= 2) threatBonus += threatLevel;
        } else {
            // è¾…åŠ©æŠ€èƒ½ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºåå¼ºåŒ–æŠ€èƒ½
            const isCounterMove = AI_COUNTER_MOVES.includes(move.name);
            if (isCounterMove) {
                threatBonus = threatLevel * 2; // æ•‘å‘½ç¨»è‰
            } else {
                threatBonus = -Math.min(1000, threatLevel * 2); // å¤§å¹…æƒ©ç½š
            }
        }
        baseScore += threatBonus;
    }
    return {
        totalScore: baseScore,
        rawDamage: dmgResult.damage,
        effectiveness: eff,
        shieldBreak,
        threatBonus
    };
}
/**
 * è·å–æœ‰æ•ˆé€Ÿåº¦ï¼ˆè€ƒè™‘éº»ç—¹ã€é¡ºé£ã€å¤©æ°”ç­‰ï¼‰
 */
function getEffectiveSpeed(pokemon) {
    let spe = pokemon.getStat?.('spe') || pokemon.spe || 100;
    // éº»ç—¹å‡é€Ÿ
    if (pokemon.status === 'par') {
        spe = Math.floor(spe * 0.5);
    }
    // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘é€Ÿåº¦ä¿®æ­£
    if (typeof window !== 'undefined' && window.envOverlay) {
        const envSpeMult = window.envOverlay.getStatMod(pokemon, 'spe');
        if (envSpeMult !== 1) {
            spe = Math.floor(spe * envSpeMult);
        }
    }
    return spe;
}
/**
 * è·å–å±æ€§å…‹åˆ¶ï¼ˆä½¿ç”¨å†…ç½®è¡¨ï¼Œé¿å…å¾ªç¯è°ƒç”¨ï¼‰
 */
function getTypeEffectivenessAI(atkType, defTypes, moveName = '') {
    // ç›´æ¥ä½¿ç”¨å†…ç½®è¡¨ï¼Œä¸è°ƒç”¨ window.getTypeEffectiveness é¿å…å¾ªç¯
    const TYPE_CHART = {
        'Normal':   { weak: [],                          resist: ['Rock', 'Steel'],      immune: ['Ghost'] },
        'Fire':     { weak: ['Grass', 'Ice', 'Bug', 'Steel'], resist: ['Fire', 'Water', 'Rock', 'Dragon'], immune: [] },
        'Water':    { weak: ['Fire', 'Ground', 'Rock'],  resist: ['Water', 'Grass', 'Dragon'], immune: [] },
        'Electric': { weak: ['Water', 'Flying'],         resist: ['Electric', 'Grass', 'Dragon'], immune: ['Ground'] },
        'Grass':    { weak: ['Water', 'Ground', 'Rock'], resist: ['Fire', 'Grass', 'Poison', 'Flying', 'Bug', 'Dragon', 'Steel'], immune: [] },
        'Ice':      { weak: ['Grass', 'Ground', 'Flying', 'Dragon'], resist: ['Fire', 'Water', 'Ice', 'Steel'], immune: [] },
        'Fighting': { weak: ['Normal', 'Ice', 'Rock', 'Dark', 'Steel'], resist: ['Poison', 'Flying', 'Psychic', 'Bug', 'Fairy'], immune: ['Ghost'] },
        'Poison':   { weak: ['Grass', 'Fairy'],          resist: ['Poison', 'Ground', 'Rock', 'Ghost'], immune: ['Steel'] },
        'Ground':   { weak: ['Fire', 'Electric', 'Poison', 'Rock', 'Steel'], resist: ['Grass', 'Bug'], immune: ['Flying'] },
        'Flying':   { weak: ['Grass', 'Fighting', 'Bug'], resist: ['Electric', 'Rock', 'Steel'], immune: [] },
        'Psychic':  { weak: ['Fighting', 'Poison'],      resist: ['Psychic', 'Steel'],   immune: ['Dark'] },
        'Bug':      { weak: ['Grass', 'Psychic', 'Dark'], resist: ['Fire', 'Fighting', 'Poison', 'Flying', 'Ghost', 'Steel', 'Fairy'], immune: [] },
        'Rock':     { weak: ['Fire', 'Ice', 'Flying', 'Bug'], resist: ['Fighting', 'Ground', 'Steel'], immune: [] },
        'Ghost':    { weak: ['Psychic', 'Ghost'],        resist: ['Dark'],               immune: ['Normal'] },
        'Dragon':   { weak: ['Dragon'],                  resist: ['Steel'],              immune: ['Fairy'] },
        'Dark':     { weak: ['Psychic', 'Ghost'],        resist: ['Fighting', 'Dark', 'Fairy'], immune: [] },
        'Steel':    { weak: ['Ice', 'Rock', 'Fairy'],    resist: ['Fire', 'Water', 'Electric', 'Steel'], immune: [] },
        'Fairy':    { weak: ['Fighting', 'Dark', 'Dragon'], resist: ['Fire', 'Poison', 'Steel'], immune: [] },
    };
    const chart = TYPE_CHART[atkType];
    if (!chart) return 1;
    let multiplier = 1;
    for (const defType of defTypes) {
        if (chart.immune.includes(defType)) return 0;
        if (chart.weak.includes(defType)) multiplier *= 2;
        if (chart.resist.includes(defType)) multiplier *= 0.5;
    }
    return multiplier;
}
/**
 * æŠ€èƒ½è¯„åˆ†ï¼ˆç”¨äºæ’åºï¼‰
 * @param {Pokemon} attacker - æ”»å‡»æ–¹
 * @param {Pokemon} defender - é˜²å¾¡æ–¹
 * @param {Object} move - æŠ€èƒ½æ•°æ®
 * @param {Pokemon[]} aiParty - AI é˜Ÿä¼ï¼ˆç”¨äºæŠ˜è¿”æŠ€èƒ½æ£€æŸ¥ï¼‰
 */
function calcMoveScore(attacker, defender, move, aiParty = null) {
    if (!move) return -9999;
    const moveName = move.name || '';
    // =========================================================
    // -1. å®šèº«æ³•/è¯…å’’ä¹‹èº¯/æ€¨æ¨å°å°æ£€æŸ¥ (Disable/Cursed Body/Grudge)
    // è¢«å°å°çš„æ‹›å¼å®Œå…¨ç¦æ­¢ä½¿ç”¨
    // =========================================================
    if (attacker.volatile) {
        // å®šèº«æ³•/è¯…å’’ä¹‹èº¯å°å°
        if (attacker.volatile.disable > 0 && attacker.volatile.disabledMove === moveName) {
            console.log(`[AI BAN] ${moveName} è¢«å®šèº«æ³•/è¯…å’’ä¹‹èº¯å°å°`);
            return -99999;
        }
        // æ€¨æ¨å°å°
        if (attacker.volatile.grudgeSealed && attacker.volatile.grudgeSealed.includes(moveName)) {
            console.log(`[AI BAN] ${moveName} è¢«æ€¨æ¨å°å°`);
            return -99999;
        }
    }
    // =========================================================
    // 0. Z-Move / Max Move å…¨åœºå”¯ä¸€é™åˆ¶ (Once Per Battle)
    // è¿™äº›è¶…å¼ºæŠ€èƒ½åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œç”¨è¿‡å°±æ°¸ä¹…å°å°
    // =========================================================
    // è·å–æŠ€èƒ½æ•°æ®åˆ¤æ–­æ˜¯å¦ä¸º Z/Max æ‹›å¼
    const moveId = (moveName || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const moveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    // æ£€æµ‹ Z æ‹›å¼ï¼šisZ å­—æ®µ æˆ– isNonstandard === 'Past' ä¸” PP === 1
    const isZMove = moveData.isZ || 
        (moveData.pp === 1 && moveData.basePower >= 100 && moveData.isNonstandard === 'Past');
    // æ£€æµ‹æå·¨æ‹›å¼ï¼šisMax å­—æ®µ æˆ– åç§°åŒ…å« Max/G-Max
    const isMaxMove = moveData.isMax || 
        moveName.startsWith('Max ') || moveName.startsWith('G-Max ');
    // å¦‚æœæ˜¯ Z æ‹›å¼ä¸” AI å·²ç»ç”¨è¿‡ï¼Œæ°¸ä¹…å°å°
    if (isZMove && typeof battle !== 'undefined' && battle.enemyZUsed) {
        console.log(`[AI BAN] Z-Move "${moveName}" å·²ä½¿ç”¨è¿‡ï¼Œç¦æ­¢å†æ¬¡ä½¿ç”¨`);
        return -99999;
    }
    // ã€ä¿®å¤ã€‘æå·¨æ‹›å¼çš„ç¦ç”¨é€»è¾‘ï¼š
    // - å¦‚æœå½“å‰å®å¯æ¢¦å¤„äºæå·¨åŒ–çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨æå·¨æ‹›å¼
    // - å¦‚æœå½“å‰å®å¯æ¢¦ä¸åœ¨æå·¨åŒ–çŠ¶æ€ï¼Œä¸” AI å·²ç»ç”¨è¿‡æå·¨åŒ–ï¼Œç¦æ­¢ä½¿ç”¨æå·¨æ‹›å¼
    // ï¼ˆå› ä¸ºæå·¨åŒ–ç»“æŸåæ‹›å¼ä¼šæ¢å¤ä¸ºæ™®é€šæ‹›å¼ï¼Œä¸åº”è¯¥å‡ºç°æå·¨æ‹›å¼ï¼‰
    if (isMaxMove && typeof battle !== 'undefined') {
        // å¦‚æœå½“å‰å®å¯æ¢¦ä¸åœ¨æå·¨åŒ–çŠ¶æ€ï¼Œæå·¨æ‹›å¼ä¸åº”è¯¥å‡ºç°åœ¨æ‹›å¼åˆ—è¡¨ä¸­
        if (!attacker.isDynamaxed) {
            console.log(`[AI BAN] Max Move "${moveName}" å½“å‰æœªæå·¨åŒ–ï¼Œç¦æ­¢ä½¿ç”¨`);
            return -99999;
        }
        // æå·¨åŒ–çŠ¶æ€ä¸‹å¯ä»¥æ­£å¸¸ä½¿ç”¨æå·¨æ‹›å¼ï¼Œä¸ç¦æ­¢
    }
    // =========================================================
    // 1. å¤æ‚æŠ€èƒ½é»‘åå• (Complex Move Blacklist)
    // å¼•æ“æœªå®ç°çš„å¤æ‚æœºåˆ¶æŠ€èƒ½ï¼Œç¦æ­¢ AI ä½¿ç”¨
    // =========================================================
    const ENGINE_BANS = [
        // å»¶è¿Ÿä¼¤å®³æŠ€èƒ½ï¼ˆéœ€è¦å…¨å±€é˜Ÿåˆ—ï¼‰
        'Future Sight', 'Doom Desire',
        // åŒæ‰“ä¸“ç”¨æŠ€èƒ½
        'Ally Switch', 'Helping Hand', 'Follow Me', 'Rage Powder',
        'Wide Guard', 'Quick Guard', 'After You', 'Instruct', 'Quash',
        // é“å…·äº¤æ¢/ç§»é™¤ç±»ï¼ˆé“å…·ç³»ç»Ÿæœªå®Œå–„ï¼‰
        'Switcheroo', 'Trick', 'Bestow', 'Fling', 'Thief', 'Covet',
        // ç‰¹æ€§äº¤æ¢ç±»ï¼ˆè¿‡äºå¤æ‚ï¼‰
        'Skill Swap', 'Entrainment', 'Role Play', 'Doodle'
    ];
    if (ENGINE_BANS.includes(moveName)) {
        return -99999; // æ°¸è¿œä¸é€‰
    }
    // =========================================================
    // 2. æ¡ä»¶å‹é™åˆ¶æŠ€èƒ½æ£€æŸ¥ (Context-based Restrictions)
    // ä½¿ç”¨ moves-data.js çš„æ•°æ®é©±åŠ¨åˆ¤æ–­
    // =========================================================
    // ã€ä¿®å¤ã€‘ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ move å‚æ•°ï¼ˆå·²ç»æ˜¯ getMergedMoveData å¤„ç†è¿‡çš„ï¼‰
    // åªæœ‰å½“ move æ²¡æœ‰ boosts/target æ—¶æ‰å›é€€åˆ° moveData
    const fullMoveData = {
        ...moveData,
        ...move,
        boosts: move.boosts || moveData.boosts || null,
        target: move.target || moveData.target || 'normal'
    };
    const moveFlags = fullMoveData.flags || {};
    // =========================================================
    // ConditionChecker: æ¡ä»¶é™åˆ¶æ£€æŸ¥å™¨
    // æ£€æŸ¥æ‹›å¼åœ¨å½“å‰ç¯å¢ƒä¸‹æ˜¯å¦åˆæ³•/ç†æ™º
    // =========================================================
    // [ç±»å‹0: å·²æœ‰è‡ªæˆ‘çŠ¶æ€æ£€æŸ¥] - å·²æœ‰ volatile çŠ¶æ€æ—¶ç¦æ­¢é‡å¤ä½¿ç”¨
    // è¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„æ£€æŸ¥ï¼Œé¿å… AI æµªè´¹å›åˆ
    if (fullMoveData.volatileStatus && fullMoveData.target === 'self') {
        const volatileKey = fullMoveData.volatileStatus;
        // å¯å åŠ çŠ¶æ€é™¤å¤–ï¼ˆstockpile ç”±åç»­é€»è¾‘å¤„ç†ï¼‰
        const stackableVolatiles = ['stockpile'];
        // åˆ·æ–°å‹çŠ¶æ€å¯ä»¥é‡å¤ä½¿ç”¨
        const refreshableVolatiles = ['charge', 'laserfocus', 'defensecurl'];
        if (!stackableVolatiles.includes(volatileKey) && 
            !refreshableVolatiles.includes(volatileKey) &&
            attacker.volatile && attacker.volatile[volatileKey]) {
            console.log(`[AI BAN] ${moveName}ï¼šå·²æœ‰ ${volatileKey} çŠ¶æ€ï¼Œç¦æ­¢é‡å¤ä½¿ç”¨`);
            return -99999;
        }
    }
    // [ç±»å‹1: é¦–å›åˆé™å®šç»„] - Fake Out, First Impression, Mat Block
    const firstTurnOnlyMoves = ['Fake Out', 'First Impression', 'Mat Block'];
    if (firstTurnOnlyMoves.includes(moveName) && (attacker.turnsOnField || 0) > 0) {
        console.log(`[AI BAN] ${moveName} åªèƒ½åœ¨é¦–å›åˆä½¿ç”¨ï¼Œå½“å‰ turnsOnField=${attacker.turnsOnField}`);
        return -9999; // éé¦–å›åˆï¼Œå¿…å®šå¤±è´¥
    }
    // [ç±»å‹2: è¿å‘æƒ©ç½šç»„] - Protect, Detect, King's Shield ç­‰
    // è¿ç»­ä½¿ç”¨å®ˆä½ç±»æŠ€èƒ½æˆåŠŸç‡å¤§å¹…ä¸‹é™
    const protectMoves = ['Protect', 'Detect', 'Spiky Shield', "King's Shield", 'Baneful Bunker', 
                          'Obstruct', 'Silk Trap', 'Burning Bulwark', 'Endure', 'Wide Guard', 'Quick Guard'];
    if (protectMoves.includes(moveName)) {
        const lastMove = attacker.lastMoveUsed || '';
        if (protectMoves.includes(lastMove)) {
            console.log(`[AI BAN] ${moveName} è¿ç»­ä½¿ç”¨ï¼ŒæˆåŠŸç‡æä½ï¼Œç¦æ­¢é€‰æ‹©`);
            return -8000; // è¿ç»­ä½¿ç”¨å®ˆä½ç±»æŠ€èƒ½ï¼Œæå¤§é™ä½æƒé‡
        }
    }
    // [ç±»å‹3: å…ˆåˆ¶åšå¼ˆç»„] - Sucker Punch
    // å¦‚æœå¯¹æ‰‹ä¸Šå›åˆä½¿ç”¨å˜åŒ–æŠ€ï¼Œçªè¢­å¤§æ¦‚ç‡ä¼šå¤±è´¥
    if (moveName === 'Sucker Punch') {
        const defenderLastMove = defender.lastMoveUsed || '';
        const defenderLastMoveId = defenderLastMove.toLowerCase().replace(/[^a-z0-9]/g, '');
        const defenderLastMoveData = (typeof MOVES !== 'undefined' && MOVES[defenderLastMoveId]) ? MOVES[defenderLastMoveId] : {};
        const lastMoveCategory = (defenderLastMoveData.category || '').toLowerCase();
        // å¦‚æœå¯¹æ‰‹ä¸Šå›åˆç”¨çš„æ˜¯å˜åŒ–æŠ€ï¼Œé™ä½çªè¢­ä¼˜å…ˆçº§
        if (lastMoveCategory === 'status') {
            console.log(`[AI WARN] å¯¹æ‰‹ä¸Šå›åˆä½¿ç”¨å˜åŒ–æŠ€ ${defenderLastMove}ï¼Œçªè¢­å¯èƒ½å¤±è´¥`);
            return -500; // é™ä½ä¼˜å…ˆçº§ä½†ä¸å®Œå…¨ç¦æ­¢
        }
    }
    // [ç±»å‹4: çŠ¶æ€å†—ä½™ç»„] - çŠ¶æ€æŠ€å¯¹å·²æœ‰çŠ¶æ€/å…ç–«å±æ€§æ— æ•ˆ
    // ã€ä¼˜åŒ–ã€‘ä» moves-data.js åŠ¨æ€è¯»å–çŠ¶æ€æ‹›å¼ä¿¡æ¯
    const moveStatus = fullMoveData.status; // ç›´æ¥ä»æ‹›å¼æ•°æ®è·å–çŠ¶æ€ç±»å‹
    const defenderTypes = defender.types || [];
    const defenderAbility = (defender.ability || '').toLowerCase().replace(/[^a-z]/g, '');
    if (moveStatus) {
        // æ£€æŸ¥å·²æœ‰çŠ¶æ€
        if (defender.status) {
            console.log(`[AI BAN] ${moveName} å¯¹å·²æœ‰çŠ¶æ€ ${defender.status} çš„ç›®æ ‡æ— æ•ˆ`);
            return -9999;
        }
        // ç²‰æœ«ç±»æ‹›å¼å¯¹è‰ç³»å…ç–«
        if (moveFlags.powder && defenderTypes.includes('Grass')) {
            console.log(`[AI BAN] ${moveName} ç²‰æœ«æ‹›å¼å¯¹è‰ç³»æ— æ•ˆ`);
            return -9999;
        }
        // ç”µç³»æ‹›å¼å¯¹åœ°é¢ç³»å…ç–«ï¼ˆç”µç£æ³¢ï¼‰
        if (fullMoveData.type === 'Electric' && defenderTypes.includes('Ground')) {
            console.log(`[AI BAN] ${moveName} ç”µç³»æ‹›å¼å¯¹åœ°é¢ç³»æ— æ•ˆ`);
            return -9999;
        }
        // ç«ç³»å…ç–«çƒ§ä¼¤
        if (moveStatus === 'brn' && defenderTypes.includes('Fire')) {
            console.log(`[AI BAN] ${moveName} å¯¹ç«ç³»æ— æ•ˆ`);
            return -9999;
        }
        // æ¯’/é’¢ç³»å…ç–«ä¸­æ¯’
        if ((moveStatus === 'psn' || moveStatus === 'tox') && 
            (defenderTypes.includes('Poison') || defenderTypes.includes('Steel'))) {
            console.log(`[AI BAN] ${moveName} å¯¹æ¯’/é’¢ç³»æ— æ•ˆ`);
            return -9999;
        }
        // ç”µç³»å…ç–«éº»ç—¹
        if (moveStatus === 'par' && defenderTypes.includes('Electric')) {
            console.log(`[AI BAN] ${moveName} å¯¹ç”µç³»æ— æ•ˆ`);
            return -9999;
        }
        // ç¡çœ çŠ¶æ€ç‰¹æ®Šæ£€æŸ¥
        if (moveStatus === 'slp') {
            // ã€è½¯ç¼–ç ã€‘ä» AbilityHandlers è¯»å–ç¡çœ å…ç–«ç‰¹æ€§åˆ—è¡¨
            const sleepImmuneAbilities = (typeof AbilityHandlers !== 'undefined' && AbilityHandlers._sleepImmuneAbilities) 
                ? AbilityHandlers._sleepImmuneAbilities 
                : ['insomnia', 'vitalspirit', 'comatose', 'purifyingsalt', 'sweetveil'];
            if (sleepImmuneAbilities.includes(defenderAbility)) {
                console.log(`[AI BAN] ${moveName} å¯¹ ${defender.ability} ç‰¹æ€§æ— æ•ˆï¼ˆç¡çœ å…ç–«ï¼‰`);
                return -9999;
            }
            // ç”µæ°”åœºåœ°å…ç–«ç¡çœ 
            const battle = window.battle;
            if (battle?.terrain === 'electricterrain') {
                const isGrounded = !defenderTypes.includes('Flying') && defenderAbility !== 'levitate';
                if (isGrounded) {
                    console.log(`[AI BAN] ${moveName} åœ¨ç”µæ°”åœºåœ°ä¸­å¯¹åœ°é¢å•ä½æ— æ•ˆ`);
                    return -9999;
                }
            }
        }
    }
    // 4b. å¤©æ°”æŠ€å¯¹å·²å­˜åœ¨çš„ç›¸åŒå¤©æ°”æ— æ•ˆ
    // ã€ä¿®å¤ã€‘ä½¿ç”¨å®é™…çš„å¤©æ°”å€¼ï¼ˆå°å†™ï¼‰è¿›è¡ŒåŒ¹é…
    const weatherMoves = {
        'Rain Dance': 'rain',
        'Sunny Day': 'sun', 
        'Sandstorm': 'sandstorm',
        'Hail': 'hail',
        'Snowscape': 'snow'
    };
    if (weatherMoves[moveName]) {
        // æ£€æŸ¥ battle.weatherï¼ˆç›´æ¥å±æ€§ï¼‰æˆ– battle.field.weather
        const currentWeather = (typeof battle !== 'undefined' && battle.weather) || 
                               (typeof battle !== 'undefined' && battle.field && battle.field.weather) || '';
        if (currentWeather === weatherMoves[moveName]) {
            console.log(`[AI BAN] ${moveName} å¤©æ°”å·²å­˜åœ¨ (${currentWeather})ï¼Œç¦æ­¢ä½¿ç”¨`);
            return -9999;
        }
    }
    // [ç±»å‹5: HPä¾èµ–ç»„] - Explosion, Self-Destruct, Final Gambit, Destiny Bond
    const selfKOMoves = ['Explosion', 'Self-Destruct', 'Final Gambit', 'Memento', 'Healing Wish', 'Lunar Dance'];
    const hpPercentCheck = attacker.currHp / attacker.maxHp;
    if (selfKOMoves.includes(moveName)) {
        // Final Gambit ä¼¤å®³ç­‰äºè‡ªèº«å½“å‰HPï¼Œä½HPæ—¶æ¯«æ— æ„ä¹‰
        if (moveName === 'Final Gambit' && attacker.currHp < defender.currHp * 0.3) {
            console.log(`[AI BAN] Final Gambit HPè¿‡ä½ (${attacker.currHp})ï¼Œä¼¤å®³ä¸è¶³`);
            return -9000;
        }
        // å¤§çˆ†ç‚¸/è‡ªçˆ†ï¼šæ»¡è¡€ä¸”é˜Ÿä¼è¿˜æœ‰å…¶ä»–æˆå‘˜æ—¶ä¸è¦é€
        if ((moveName === 'Explosion' || moveName === 'Self-Destruct') && hpPercentCheck > 0.7) {
            const aliveCount = (aiParty || []).filter(p => p && p.currHp > 0).length;
            if (aliveCount > 1) {
                console.log(`[AI WARN] ${moveName} æ»¡è¡€ä¸”é˜Ÿä¼è¿˜æœ‰ ${aliveCount} åªï¼Œé™ä½ä¼˜å…ˆçº§`);
                return -2000; // å¤§å¹…é™ä½ä½†ä¸å®Œå…¨ç¦æ­¢
            }
        }
        // æ£€æŸ¥å¯¹æ‰‹æ˜¯å¦æœ‰æ¹¿æ°”ç‰¹æ€§ï¼ˆå…ç–«çˆ†ç‚¸ï¼‰
        const defenderAbility = (defender.ability || '').toLowerCase();
        if ((moveName === 'Explosion' || moveName === 'Self-Destruct') && defenderAbility === 'damp') {
            console.log(`[AI BAN] å¯¹æ‰‹æœ‰æ¹¿æ°”ç‰¹æ€§ï¼Œ${moveName} æ— æ•ˆ`);
            return -9999;
        }
    }
    // Destiny Bond è¿ç»­ä½¿ç”¨ä¼šå¤±è´¥ï¼ˆä½†å¤±è´¥åè¿é”é‡ç½®ï¼Œä¸‹å›åˆå¯ä»¥å†æˆåŠŸï¼‰
    // ã€ä¿®å¤ã€‘æ£€æŸ¥çš„æ˜¯ lastDestinyBondSuccessï¼Œè€Œä¸æ˜¯ lastMoveUsed
    if (moveName === 'Destiny Bond' && attacker.lastDestinyBondSuccess) {
        console.log(`[AI BAN] Destiny Bond è¿ç»­ä½¿ç”¨å¿…å®šå¤±è´¥`);
        return -9999;
    }
    // Grudge åŒç†
    if (moveName === 'Grudge' && attacker.lastGrudgeSuccess) {
        console.log(`[AI BAN] Grudge è¿ç»­ä½¿ç”¨å¿…å®šå¤±è´¥`);
        return -9999;
    }
    // ç¡çœ çŠ¶æ€æ‰èƒ½ç”¨çš„æŠ€èƒ½
    if (moveFlags.nosleeptalk === undefined && (moveName === 'Sleep Talk' || moveName === 'Snore')) {
        if (attacker.status !== 'slp') {
            return -5000;
        }
    }
    // éœ€è¦å¯¹æ‰‹ç¡çœ çš„æŠ€èƒ½
    if (fullMoveData.sleepUsable || moveName === 'Dream Eater') {
        if (defender.status !== 'slp') {
            return -5000;
        }
    }
    // =========================================================
    // 3. æ ¸å¿ƒæˆ˜æœ¯å¼ºåˆ¶æ‰§è¡Œ (Force Setup Logic)
    // ä½¿ç”¨ moves-data.js æ•°æ®é©±åŠ¨åˆ¤æ–­æŠ€èƒ½ç±»å‹
    // =========================================================
    const itemName = (attacker.item || '').toLowerCase().replace(/[^a-z]/g, '');
    const hasFocusSash = itemName === 'focussash';
    const hpPercent = attacker.currHp / attacker.maxHp;
    // [A] åœºåœ°æŠ€èƒ½æ£€æµ‹ (pseudoWeather ç±»)
    // Trick Room, Magic Room, Wonder Room, Gravity ç­‰
    if (fullMoveData.pseudoWeather) {
        const fieldType = fullMoveData.pseudoWeather;
        // ã€ä¿®å¤ã€‘å­—æ®µåæ˜ å°„ï¼špseudoWeather ç”¨å°å†™ï¼Œä½† battle.field ç”¨é©¼å³°
        // å®Œæ•´æ˜ å°„æ‰€æœ‰ pseudoWeather ç±»å‹
        const fieldKeyMap = {
            'trickroom': 'trickRoom',
            'magicroom': 'magicRoom',
            'wonderroom': 'wonderRoom',
            'gravity': 'gravity',
            'fairylock': 'fairyLock',
            'iondeluge': 'ionDeluge',
            'mudsport': 'mudSport',
            'watersport': 'waterSport'
        };
        const fieldKey = fieldKeyMap[fieldType] || fieldType;
        // æ£€æŸ¥åœºåœ°æ˜¯å¦å·²å¼€å¯
        if (typeof battle !== 'undefined' && battle.field && battle.field[fieldKey] > 0) {
            console.log(`[AI TACTIC] ${fieldType} å·²å¼€å¯ (${battle.field[fieldKey]} å›åˆ)ï¼Œä¸å†ä½¿ç”¨`);
            return -9999;
        }
        // Trick Room ç‰¹æ®Šå¤„ç†ï¼šç©ºé—´é˜Ÿæ ¸å¿ƒ
        if (fieldType === 'trickroom' && (hpPercent >= 0.4 || hasFocusSash)) {
            console.log(`[AI TACTIC] ${attacker.cnName} å¿…é¡»å¼€ Trick Roomï¼`);
            return 50000;
        }
        // å…¶ä»–åœºåœ°æŠ€èƒ½
        if (hpPercent >= 0.5) {
            return 25000;
        }
    }
    // [B] åœºåœ°æŠ€èƒ½ (sideCondition ç±»)
    // åˆ†ä¸¤ç±»ï¼šå·±æ–¹åœºåœ°ï¼ˆTailwind, Reflect, Light Screen, Aurora Veilï¼‰å’Œæ•Œæ–¹åœºåœ°ï¼ˆé’‰å­ç±»ï¼‰
    if (fullMoveData.sideCondition) {
        const sideType = fullMoveData.sideCondition;
        const target = fullMoveData.target || 'foeSide';
        const isAiAttacker = typeof battle !== 'undefined' && attacker !== battle.getPlayer?.();
        // æ ¹æ® target å­—æ®µåˆ¤æ–­ä½œç”¨äºå“ªä¸€æ–¹åœºåœ°
        let targetSide = null;
        if (target === 'foeSide') {
            // é’‰å­ç±»ï¼šAI æ’’é’‰å­ä½œç”¨äºç©å®¶åœºåœ°
            targetSide = isAiAttacker ? battle.playerSide : battle.enemySide;
        } else if (target === 'allySide' || target === 'self') {
            // å·±æ–¹å¢ç›Šï¼šAI ä½¿ç”¨ä½œç”¨äºå·±æ–¹åœºåœ°
            targetSide = isAiAttacker ? battle.enemySide : battle.playerSide;
        }
        // === é’‰å­ç±»æŠ€èƒ½ï¼šæ£€æŸ¥æ˜¯å¦å·²æ»¡å±‚ ===
        if (['stealthrock', 'spikes', 'toxicspikes', 'stickyweb'].includes(sideType) && targetSide) {
            // æ£€æŸ¥å„ç±»é’‰å­çš„ä¸Šé™
            if (sideType === 'spikes' && (targetSide.spikes || 0) >= 3) {
                console.log(`[AI BAN] Spikes å·²æ»¡3å±‚ï¼Œç¦æ­¢ä½¿ç”¨`);
                return -9999;
            }
            if (sideType === 'toxicspikes' && (targetSide.toxicSpikes || targetSide.toxicspikes || 0) >= 2) {
                console.log(`[AI BAN] Toxic Spikes å·²æ»¡2å±‚ï¼Œç¦æ­¢ä½¿ç”¨`);
                return -9999;
            }
            if (sideType === 'stealthrock' && targetSide.stealthRock) {
                console.log(`[AI BAN] Stealth Rock å·²å­˜åœ¨ï¼Œç¦æ­¢ä½¿ç”¨`);
                return -9999;
            }
            if (sideType === 'stickyweb' && targetSide.stickyWeb) {
                console.log(`[AI BAN] Sticky Web å·²å­˜åœ¨ï¼Œç¦æ­¢ä½¿ç”¨`);
                return -9999;
            }
            // === å…³é”®ä¿®å¤ï¼šå¯¹æ‰‹æ­£åœ¨å¼ºåŒ–æ—¶ï¼Œé™ä½æ’’é’‰å­çš„ä¼˜å…ˆçº§ ===
            // å¦‚æœå¯¹æ‰‹æ”»å‡»ç­‰çº§ >= 2ï¼Œæ’’é’‰å­å°±æ˜¯é€æ­»è¡Œä¸º
            const defenderBoosts = defender.boosts || {};
            const defenderAtkBoost = defenderBoosts.atk || 0;
            const defenderSpaBoost = defenderBoosts.spa || 0;
            if (defenderAtkBoost >= 2 || defenderSpaBoost >= 2) {
                console.log(`[AI TACTIC] å¯¹æ‰‹å·²å¼ºåŒ– (atk:${defenderAtkBoost}, spa:${defenderSpaBoost})ï¼Œæ”¾å¼ƒæ’’é’‰å­`);
                return -500; // å¤§å¹…é™ä½ä¼˜å…ˆçº§ï¼Œè½¬è€Œæ”»å‡»
            }
            // é¦–å‘æ’’é’‰ï¼šåªæœ‰è¡€é‡å¥åº·ä¸”å¯¹æ‰‹æ²¡å¼ºåŒ–æ—¶æ‰æ’’
            if (hpPercent >= 0.9) {
                console.log(`[AI TACTIC] ${attacker.cnName} é¦–å‘æ’’é’‰: ${moveName}`);
                return 2500 + Math.random() * 500;
            }
            // éé¦–å‘ä¸æ’’é’‰å­
            return -100;
        }
        // === å·±æ–¹å¢ç›Šç±»æŠ€èƒ½ ===
        if (targetSide) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆå·±æ–¹å¢ç›Šç±»ï¼‰
            const keyMap = {
                'tailwind': 'tailwind',
                'reflect': 'reflect', 
                'lightscreen': 'lightScreen',
                'auroraveil': 'auroraVeil'
            };
            const key = keyMap[sideType] || sideType;
            if (targetSide[key] > 0) {
                return -500; // å·²å­˜åœ¨ï¼Œä¸é‡å¤ä½¿ç”¨
            }
        }
        // é¡ºé£ï¼šé«˜ä¼˜å…ˆçº§
        if (sideType === 'tailwind' && hpPercent >= 0.5) {
            return 40000;
        }
        // åŒå¢™/æå…‰å¹•ï¼šé«˜ä¼˜å…ˆçº§
        if (['reflect', 'lightscreen', 'auroraveil'].includes(sideType) && hpPercent >= 0.6) {
            console.log(`[AI TACTIC] ${attacker.cnName} å¼€å¯é˜²æŠ¤å¢™: ${moveName}`);
            return 15000;
        }
    }
    // [C] å¤©æ°”æŠ€èƒ½æ£€æµ‹ (weather ç±»)
    if (fullMoveData.weather) {
        if (hpPercent >= 0.5) {
            return 30000;
        }
    }
    // [D] å‚¬çœ æŠ€èƒ½æ£€æµ‹ (status: 'slp')
    if (fullMoveData.status === 'slp') {
        if (!defender.status && (!defender.volatile || !defender.volatile.yawn)) {
            // æ ¹æ®å‘½ä¸­ç‡ç»™åˆ†ï¼š100% å‘½ä¸­çš„æ›´é«˜åˆ†
            const accuracy = fullMoveData.accuracy === true ? 100 : (fullMoveData.accuracy || 75);
            const sleepBonus = accuracy >= 100 ? 8000 : (accuracy >= 75 ? 6000 : 4000);
            console.log(`[AI TACTIC] ${attacker.cnName} å°è¯•å‚¬çœ : ${moveName} (å‘½ä¸­ç‡: ${accuracy})`);
            return sleepBonus;
        } else {
            return -500;
        }
    }
    // [E] å¼ºåŒ–æŠ€èƒ½æ£€æµ‹ (boosts ä¸” target: 'self')
    const isSelfBoost = fullMoveData.boosts && 
        ['self', 'allySide', 'adjacentAllyOrSelf'].includes(fullMoveData.target);
    // ã€è°ƒè¯•ã€‘è¾“å‡ºå¼ºåŒ–æŠ€æ£€æµ‹ä¿¡æ¯
    if (moveName === 'Iron Defense' || moveName === 'Swords Dance' || moveName === 'Calm Mind') {
        console.log(`[AI BOOST DEBUG] ${moveName}: boosts=`, fullMoveData.boosts, 'target=', fullMoveData.target, 'isSelfBoost=', isSelfBoost);
        console.log(`[AI BOOST DEBUG] attacker.boosts=`, attacker.boosts);
    }
    if (isSelfBoost) {
        const boosts = fullMoveData.boosts;
        // æ£€æŸ¥ä¸»è¦å¼ºåŒ–çš„èƒ½åŠ›
        const atkBoost = boosts.atk || 0;
        const spaBoost = boosts.spa || 0;
        const speBoost = boosts.spe || 0;
        const defBoost = boosts.def || 0;
        const spdBoost = boosts.spd || 0;
        // ã€ä¿®å¤ã€‘æ£€æŸ¥æ‰€æœ‰æ­£é¢å¼ºåŒ–æ˜¯å¦å·²æ»¡çº§ (+6)
        // å¦‚æœè¯¥æŠ€èƒ½å¼ºåŒ–çš„èƒ½åŠ›å·²ç»æ»¡çº§ï¼Œç›´æ¥è¿”å›è´Ÿåˆ†
        const currentBoosts = attacker.boosts || {};
        for (const stat of Object.keys(boosts)) {
            const boostValue = boosts[stat];
            if (boostValue > 0) { // åªæ£€æŸ¥æ­£é¢å¼ºåŒ–
                const currentValue = currentBoosts[stat] || 0;
                console.log(`[AI BOOST CHECK] ${moveName}: ${stat} boost=${boostValue}, current=${currentValue}`);
                if (currentValue >= 6) {
                    console.log(`[AI TACTIC] ${attacker.cnName} çš„ ${stat} å·²æ»¡çº§ (+6)ï¼Œç¦æ­¢ä½¿ç”¨ ${moveName}`);
                    return -9999; // æ»¡çº§åç»å¯¹ä¸èƒ½å†ç”¨
                }
            }
        }
        // ã€å…³é”®ä¿®å¤ã€‘å¨èƒæ£€æŸ¥ï¼šå¦‚æœå¯¹æ–¹é€Ÿåº¦æ›´å¿«ä¸”æœ‰å…‹åˆ¶æŠ€èƒ½ï¼Œä¸è¦å¼ºåŒ–
        const mySpeed = getEffectiveSpeed(attacker);
        const oppSpeed = getEffectiveSpeed(defender);
        const playerFaster = oppSpeed > mySpeed;
        if (playerFaster) {
            // æ£€æŸ¥å¯¹æ–¹æ˜¯å¦æœ‰å…‹åˆ¶æŠ€èƒ½
            let hasSuper = false;
            for (const pMove of (defender.moves || [])) {
                const pMoveType = pMove.type || 'Normal';
                const eff = getTypeEffectivenessAI(pMoveType, attacker.types || ['Normal']);
                if (eff >= 2) {
                    hasSuper = true;
                    break;
                }
            }
            // å¦‚æœå¯¹æ–¹é€Ÿåº¦å¿«ä¸”æœ‰å…‹åˆ¶æŠ€èƒ½ï¼Œå¼ºåŒ–æ˜¯è‡ªæ€è¡Œä¸º
            if (hasSuper) {
                console.log(`[AI TACTIC] ${attacker.cnName} æ”¾å¼ƒå¼ºåŒ–ï¼šå¯¹æ–¹é€Ÿåº¦å¿«ä¸”æœ‰å…‹åˆ¶æŠ€èƒ½`);
                return -500;
            }
            // å³ä½¿æ²¡æœ‰å…‹åˆ¶ï¼Œæ£€æŸ¥æ˜¯å¦ä¼šè¢« 2HKO
            let maxIncoming = 0;
            for (const pMove of (defender.moves || [])) {
                const mergedMove = getMergedMoveData(pMove);
                const dmgResult = simulateDamage(defender, attacker, mergedMove);
                if (dmgResult.damage > maxIncoming) maxIncoming = dmgResult.damage;
            }
            if (maxIncoming * 2 >= attacker.currHp) {
                console.log(`[AI TACTIC] ${attacker.cnName} æ”¾å¼ƒå¼ºåŒ–ï¼šä¼šè¢« 2HKO (${maxIncoming}x2 >= ${attacker.currHp})`);
                return -500;
            }
        }
        // æ”»å‡»/ç‰¹æ”»å¼ºåŒ–
        if (atkBoost > 0 || spaBoost > 0) {
            const relevantStat = atkBoost > 0 ? 'atk' : 'spa';
            const currentBoost = (attacker.boosts && attacker.boosts[relevantStat]) || 0;
            // å·²ç» +2 æˆ–æ›´é«˜ï¼Œåœæ­¢å¼ºåŒ–
            if (currentBoost >= 2) {
                console.log(`[AI TACTIC] ${attacker.cnName} å·²å¼ºåŒ– ${currentBoost} çº§ï¼Œåœæ­¢å¼ºåŒ–`);
                return -100;
            }
            // è¡€é‡å¥åº·æ—¶å¼ºåŒ–
            if (hpPercent >= 0.8) {
                console.log(`[AI TACTIC] ${attacker.cnName} å®‰å…¨å¼ºåŒ–: ${moveName}`);
                return 3500;
            } else if (hpPercent >= 0.5) {
                return 1500;
            }
        }
        // é€Ÿåº¦å¼ºåŒ–ï¼ˆé¾™èˆã€è¶èˆç­‰ï¼‰
        if (speBoost > 0 && (atkBoost > 0 || spaBoost > 0)) {
            if (hpPercent >= 0.7) {
                return 4000; // é¾™èˆç±»æ›´æœ‰ä»·å€¼
            }
        }
    }
    const category = (move.cat || move.category || '').toLowerCase();
    const isStatus = category === 'status' || move.power === 0 || move.basePower === 0;
    // =========================================================
    // ã€Anti-Spam ä¿®æ­£ã€‘æ›¿èº« (Substitute) ç‰¹æ®Šå¤„ç†
    // é˜²æ­¢ AI æ— é™å¾ªç¯ä½¿ç”¨æ›¿èº«
    // =========================================================
    if (moveName === 'Substitute') {
        // 1. è¡€é‡è¿‡ä½ç»å¯¹ä¸ç”¨ï¼ˆ< 30%ï¼‰
        if (hpPercent < 0.30) {
            console.log(`[AI BAN] ${attacker.cnName} è¡€é‡è¿‡ä½ (${Math.round(hpPercent * 100)}%)ï¼Œç¦æ­¢ä½¿ç”¨æ›¿èº«`);
            return -9999;
        }
        // 2. å·²æœ‰æ›¿èº«ç»å¯¹ä¸ç”¨
        if (attacker.volatile && attacker.volatile.substitute && attacker.volatile.substitute > 0) {
            console.log(`[AI BAN] ${attacker.cnName} å·²æœ‰æ›¿èº«ï¼Œç¦æ­¢é‡å¤ä½¿ç”¨`);
            return -9999;
        }
        // 3. è¿ç»­ä½¿ç”¨æƒ©ç½šï¼šå¦‚æœä¸Šå›åˆç”¨äº†æ›¿èº«ï¼Œå¤§å¹…é™åˆ†
        if (attacker.lastMoveUsed === 'Substitute') {
            console.log(`[AI PENALTY] ${attacker.cnName} ä¸Šå›åˆå·²ç”¨æ›¿èº«ï¼Œé™ä½ä¼˜å…ˆçº§`);
            return -500;
        }
        // 4. è¡€é‡ä¸­ç­‰æ—¶ï¼ˆ30%-50%ï¼‰ï¼Œæ›¿èº«ä»·å€¼é™ä½
        if (hpPercent < 0.50) {
            return 20; // ä½ä¼˜å…ˆçº§
        }
        // 5. å¯¹æ‰‹æ®‹è¡€æ—¶ï¼Œä¸è¦ç”¨æ›¿èº«ï¼Œåº”è¯¥è¿›æ”»
        const defenderHpPercent = defender.currHp / defender.maxHp;
        if (defenderHpPercent < 0.30) {
            console.log(`[AI TACTIC] å¯¹æ‰‹æ®‹è¡€ï¼Œ${attacker.cnName} åº”è¯¥è¿›æ”»è€Œéæ›¿èº«`);
            return -200;
        }
        // 6. æ­£å¸¸æƒ…å†µä¸‹æ›¿èº«æ˜¯ä¸­ç­‰ä¼˜å…ˆçº§
        return 50;
    }
    // =========================================================
    // ã€é«˜é£é™©æ‹›å¼è¯„ä¼°ã€‘è…¹é¼“/ç”©è‚‰/é­‚èˆçƒˆéŸ³çˆ†ç­‰æ‰£è¡€å¼ºåŒ–æŠ€
    // =========================================================
    // ã€è…¹é¼“ã€‘æ¶ˆè€—50%HPï¼Œæ”»å‡»ç›´æ¥+6
    if (moveName === 'Belly Drum') {
        const cost = Math.floor(attacker.maxHp / 2);
        // è¡€é‡ä¸è¶³50%ï¼Œå¿…å®šå¤±è´¥
        if (attacker.currHp <= cost) {
            console.log(`[AI BAN] Belly Drumï¼šè¡€é‡ä¸è¶³ 50%ï¼Œä¼šå¤±è´¥`);
            return -99999;
        }
        // æ”»å‡»å·²æ»¡çº§
        if (attacker.boosts && attacker.boosts.atk >= 6) {
            console.log(`[AI BAN] Belly Drumï¼šæ”»å‡»å·²æ»¡çº§`);
            return -99999;
        }
        // å¯¹æ‰‹æ®‹è¡€æ—¶ï¼Œç›´æ¥è¿›æ”»æ›´å¥½
        const defHpPercent = defender.currHp / defender.maxHp;
        if (defHpPercent < 0.30) {
            console.log(`[AI TACTIC] å¯¹æ‰‹æ®‹è¡€ï¼Œç›´æ¥è¿›æ”»è€Œéè…¹é¼“`);
            return -500;
        }
        // æ£€æŸ¥æ˜¯å¦ä¼šè¢«ç§’æ€ï¼ˆè…¹é¼“åå‰©ä½™50%è¡€ï¼‰
        let maxIncoming = 0;
        for (const pMove of (defender.moves || [])) {
            const mergedMove = getMergedMoveData(pMove);
            const dmgResult = simulateDamage(defender, attacker, mergedMove);
            if (dmgResult.damage > maxIncoming) maxIncoming = dmgResult.damage;
        }
        const hpAfterDrum = attacker.currHp - cost;
        if (maxIncoming >= hpAfterDrum) {
            console.log(`[AI BAN] Belly Drumï¼šè…¹é¼“åä¼šè¢«ç§’æ€ (${maxIncoming} >= ${hpAfterDrum})`);
            return -9999;
        }
        // è¡€é‡å¥åº·ä¸”å®‰å…¨æ—¶ï¼Œè…¹é¼“æ˜¯æé«˜ä»·å€¼
        if (hpPercent >= 0.80) {
            console.log(`[AI TACTIC] ${attacker.cnName} å®‰å…¨ä½¿ç”¨è…¹é¼“ï¼`);
            return 8000; // æé«˜ä¼˜å…ˆçº§
        } else if (hpPercent >= 0.55) {
            return 5000;
        }
        return 100; // é£é™©è¾ƒé«˜æ—¶é™ä½ä¼˜å…ˆçº§
    }
    // ã€ç”©è‚‰ã€‘æ¶ˆè€—50%HPï¼Œæ”»/ç‰¹æ”»/é€Ÿåº¦+2
    if (moveName === 'Fillet Away') {
        const cost = Math.floor(attacker.maxHp / 2);
        if (attacker.currHp <= cost) {
            console.log(`[AI BAN] Fillet Awayï¼šè¡€é‡ä¸è¶³ 50%ï¼Œä¼šå¤±è´¥`);
            return -99999;
        }
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰èƒ½åŠ›éƒ½å·²æ»¡çº§
        const boosts = attacker.boosts || {};
        if ((boosts.atk || 0) >= 6 && (boosts.spa || 0) >= 6 && (boosts.spe || 0) >= 6) {
            console.log(`[AI BAN] Fillet Awayï¼šèƒ½åŠ›å·²æ»¡çº§`);
            return -99999;
        }
        // å¯¹æ‰‹æ®‹è¡€æ—¶ç›´æ¥è¿›æ”»
        const defHpPercent = defender.currHp / defender.maxHp;
        if (defHpPercent < 0.30) {
            return -500;
        }
        // æ£€æŸ¥æ˜¯å¦ä¼šè¢«ç§’æ€
        let maxIncoming = 0;
        for (const pMove of (defender.moves || [])) {
            const mergedMove = getMergedMoveData(pMove);
            const dmgResult = simulateDamage(defender, attacker, mergedMove);
            if (dmgResult.damage > maxIncoming) maxIncoming = dmgResult.damage;
        }
        const hpAfter = attacker.currHp - cost;
        if (maxIncoming >= hpAfter) {
            console.log(`[AI BAN] Fillet Awayï¼šä½¿ç”¨åä¼šè¢«ç§’æ€`);
            return -9999;
        }
        if (hpPercent >= 0.80) {
            return 6000;
        } else if (hpPercent >= 0.55) {
            return 4000;
        }
        return 100;
    }
    // ã€é­‚èˆçƒˆéŸ³çˆ†ã€‘æ¶ˆè€—33%HPï¼Œå…¨å±æ€§+1
    if (moveName === 'Clangorous Soul') {
        const cost = Math.floor(attacker.maxHp / 3);
        if (attacker.currHp <= cost) {
            console.log(`[AI BAN] Clangorous Soulï¼šè¡€é‡ä¸è¶³ 33%ï¼Œä¼šå¤±è´¥`);
            return -99999;
        }
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰èƒ½åŠ›éƒ½å·²æ»¡çº§
        const boosts = attacker.boosts || {};
        const allMaxed = ['atk', 'def', 'spa', 'spd', 'spe'].every(s => (boosts[s] || 0) >= 6);
        if (allMaxed) {
            console.log(`[AI BAN] Clangorous Soulï¼šèƒ½åŠ›å·²æ»¡çº§`);
            return -99999;
        }
        const defHpPercent = defender.currHp / defender.maxHp;
        if (defHpPercent < 0.30) {
            return -500;
        }
        // æ£€æŸ¥æ˜¯å¦ä¼šè¢«ç§’æ€
        let maxIncoming = 0;
        for (const pMove of (defender.moves || [])) {
            const mergedMove = getMergedMoveData(pMove);
            const dmgResult = simulateDamage(defender, attacker, mergedMove);
            if (dmgResult.damage > maxIncoming) maxIncoming = dmgResult.damage;
        }
        const hpAfter = attacker.currHp - cost;
        if (maxIncoming >= hpAfter) {
            console.log(`[AI BAN] Clangorous Soulï¼šä½¿ç”¨åä¼šè¢«ç§’æ€`);
            return -9999;
        }
        if (hpPercent >= 0.70) {
            return 5000;
        } else if (hpPercent >= 0.40) {
            return 3000;
        }
        return 100;
    }
    // ã€æå‘½ã€‘é€ æˆç­‰äºè‡ªèº«å½“å‰HPçš„ä¼¤å®³ï¼Œè‡ªå·±æ¿’æ­»
    if (moveName === 'Final Gambit') {
        // åªæœ‰åœ¨èƒ½å‡»æ€å¯¹æ‰‹æ—¶æ‰ä½¿ç”¨
        if (attacker.currHp >= defender.currHp) {
            // è‡ªå·±æ®‹è¡€æ—¶æ›´æ„¿æ„æå‘½
            if (hpPercent < 0.30) {
                console.log(`[AI TACTIC] ${attacker.cnName} æ®‹è¡€æå‘½ï¼`);
                return 7000;
            }
            // èƒ½å‡»æ€ä¸”è‡ªå·±è¡€é‡ä¸é«˜
            if (hpPercent < 0.50) {
                return 4000;
            }
        }
        // ä¸èƒ½å‡»æ€æˆ–è‡ªå·±è¡€é‡å¥åº·ï¼Œä¸å€¼å¾—
        return -500;
    }
    // ã€åŒå‘½ã€‘å¦‚æœè¿™å›åˆè¢«å‡»å€’ï¼Œå‡»å€’è‡ªå·±çš„å¯¹æ‰‹ä¹Ÿä¼šå€’ä¸‹
    if (moveName === 'Destiny Bond') {
        // è¿ç»­ä½¿ç”¨ä¼šå¤±è´¥
        if (attacker.lastMoveUsed === 'Destiny Bond') {
            return -99999;
        }
        // æ®‹è¡€æ—¶åŒå‘½ä»·å€¼æé«˜
        if (hpPercent < 0.25) {
            console.log(`[AI TACTIC] ${attacker.cnName} æ®‹è¡€ä½¿ç”¨åŒå‘½ï¼`);
            return 6000;
        }
        if (hpPercent < 0.40) {
            return 3000;
        }
        // è¡€é‡å¥åº·æ—¶ä¸å€¼å¾—
        return -100;
    }
    // ã€æ²»æ„ˆä¹‹æ„¿/æ–°æœˆç¥ˆç¥·ã€‘è‡ªå·±æ¿’æ­»æ²»æ„ˆé˜Ÿå‹
    if (moveName === 'Healing Wish' || moveName === 'Lunar Dance') {
        // åªæœ‰åœ¨æ®‹è¡€ä¸”é˜Ÿä¼æœ‰å…¶ä»–å—ä¼¤æˆå‘˜æ—¶æ‰ä½¿ç”¨
        if (hpPercent < 0.25) {
            // ç®€åŒ–ï¼šæ®‹è¡€æ—¶ç»™äºˆä¸­ç­‰åˆ†æ•°
            return 2000;
        }
        // è¡€é‡å¥åº·æ—¶ä¸å€¼å¾—ç‰ºç‰²
        return -9999;
    }
    // === å˜åŒ–æŠ€è¯„åˆ† ===
    if (isStatus) {
        let statusScore = 10;
        // =========================================================
        // ã€Soft-Codedã€‘ä½¿ç”¨ MOVES æ•°æ®ä¸­çš„ volatileStatus å­—æ®µåˆ¤æ–­
        // è‡ªæˆ‘æ–½åŠ  volatile çŠ¶æ€çš„æŠ€èƒ½ï¼šå·²æœ‰çŠ¶æ€æ—¶ç¦æ­¢é‡å¤ä½¿ç”¨
        // =========================================================
        if (fullMoveData.volatileStatus && fullMoveData.target === 'self') {
            const volatileKey = fullMoveData.volatileStatus;
            // ã€ç‰¹æ®Šå¤„ç†ã€‘Stockpile æ˜¯å¯å åŠ çš„ï¼ˆæœ€å¤š3å±‚ï¼‰ï¼Œéœ€è¦ç‰¹æ®Šé€»è¾‘
            if (volatileKey === 'stockpile') {
                const currentStacks = (attacker.volatile && attacker.volatile.stockpile) || 0;
                // å·²æ»¡3å±‚ï¼Œç¦æ­¢ç»§ç»­ä½¿ç”¨
                if (currentStacks >= 3) {
                    console.log(`[AI BAN] Stockpileï¼šå·²æ»¡ ${currentStacks}/3 å±‚ï¼Œç¦æ­¢ç»§ç»­ä½¿ç”¨`);
                    return -99999;
                }
                // æ®‹è¡€æ—¶ä¸è¦è“„åŠ›ï¼ˆæµªè´¹å›åˆï¼‰
                if (hpPercent < 0.35) {
                    console.log(`[AI BAN] Stockpileï¼šæ®‹è¡€ (${Math.round(hpPercent * 100)}%) ä¸åº”ç»§ç»­è“„åŠ›`);
                    return -99999;
                }
                // å·²æœ‰2å±‚ä¸”è¡€é‡ä¸é«˜ï¼Œä¸è¦ç»§ç»­è“„åŠ›
                if (currentStacks >= 2 && hpPercent < 0.60) {
                    console.log(`[AI PENALTY] Stockpileï¼šå·²æœ‰ ${currentStacks} å±‚ä¸”è¡€é‡ä¸è¶³ï¼Œé™ä½ä¼˜å…ˆçº§`);
                    return 5;
                }
                // æ­£å¸¸æƒ…å†µä¸‹ç»™äºˆè¾ƒä½ä¼˜å…ˆçº§ï¼ˆä¸åº”è¯¥æ— è„‘è“„åŠ›ï¼‰
                return 25;
            }
            // 1. å·²æœ‰çŠ¶æ€ï¼Œç¦æ­¢é‡å¤ä½¿ç”¨
            if (attacker.volatile && attacker.volatile[volatileKey]) {
                console.log(`[AI BAN] ${moveName}ï¼šå·²æœ‰ ${volatileKey} çŠ¶æ€ï¼Œç¦æ­¢é‡å¤ä½¿ç”¨`);
                return -99999;
            }
            // 2. æŒç»­å›å¤ç±» volatile (aquaring, ingrain) åœ¨æ®‹è¡€æ—¶æ— æ„ä¹‰
            const hotVolatiles = ['aquaring', 'ingrain'];
            if (hotVolatiles.includes(volatileKey)) {
                if (hpPercent < 0.30) {
                    console.log(`[AI BAN] ${moveName}ï¼šæ®‹è¡€ (${Math.round(hpPercent * 100)}%) ä½¿ç”¨æŒç»­å›å¤æ— æ„ä¹‰`);
                    return -99999;
                }
                if (hpPercent < 0.50) {
                    console.log(`[AI PENALTY] ${moveName}ï¼šè¡€é‡ä¸è¶³ (${Math.round(hpPercent * 100)}%)ï¼Œé™ä½ä¼˜å…ˆçº§`);
                    return 5;
                }
                if (hpPercent >= 0.70) {
                    return 40;
                }
                return 15;
            }
            // 3. focusenergy: å·²æœ‰çŠ¶æ€ç¦æ­¢é‡å¤ï¼Œæ®‹è¡€æ—¶ä¸è¦èšæ°”
            if (volatileKey === 'focusenergy') {
                // ã€ä¿®å¤ã€‘å·²æœ‰èšæ°”çŠ¶æ€ï¼Œç¦æ­¢é‡å¤ä½¿ç”¨
                if (attacker.volatile && attacker.volatile.focusenergy) {
                    console.log(`[AI BAN] Focus Energyï¼šå·²å¤„äºèšæ°”çŠ¶æ€ï¼Œç¦æ­¢é‡å¤ä½¿ç”¨`);
                    return -99999;
                }
                if (hpPercent < 0.30) {
                    return -100;
                }
                return 30;
            }
        }
        // =========================================================
        // ã€ç‰¹æ®Šå¤„ç†ã€‘Spit Up / Swallow éœ€è¦æ£€æŸ¥è“„åŠ›å±‚æ•°
        // =========================================================
        const moveId = moveName.toLowerCase().replace(/[^a-z0-9]/g, '');
        if (moveId === 'spitup' || moveId === 'swallow') {
            const stacks = (attacker.volatile && attacker.volatile.stockpile) || 0;
            if (stacks === 0) {
                console.log(`[AI BAN] ${moveName}ï¼šæ²¡æœ‰è“„åŠ›å±‚æ•°ï¼Œæ— æ³•ä½¿ç”¨`);
                return -99999;
            }
            // æœ‰è“„åŠ›æ—¶ï¼Œæ ¹æ®å±‚æ•°ç»™äºˆè¯„åˆ†
            if (moveId === 'spitup') {
                // å–·å‡ºï¼šå±‚æ•°è¶Šå¤šå¨åŠ›è¶Šé«˜
                return 50 + stacks * 30;
            } else {
                // åä¸‹ï¼šè¡€é‡ä½æ—¶ä¼˜å…ˆä½¿ç”¨
                if (hpPercent < 0.40) return 150;
                if (hpPercent < 0.60) return 80;
                return 30;
            }
        }
        // =========================================================
        // ã€ç‰¹æ®Šå¤„ç†ã€‘Stuff Cheeks éœ€è¦æ£€æŸ¥æ˜¯å¦æŒæœ‰æ ‘æœ
        // =========================================================
        if (moveId === 'stuffcheeks') {
            const item = attacker.item || '';
            const isBerry = item.toLowerCase().includes('berry') || item.includes('æœ');
            if (!item || !isBerry) {
                console.log(`[AI BAN] Stuff Cheeksï¼šæ²¡æœ‰æŒæœ‰æ ‘æœï¼Œæ— æ³•ä½¿ç”¨`);
                return -99999;
            }
            // æœ‰æ ‘æœæ—¶ï¼Œè¡€é‡å¥åº·æ—¶ä½¿ç”¨ä»·å€¼æ›´é«˜
            if (hpPercent > 0.70) return 80;
            if (hpPercent > 0.50) return 50;
            return 20; // æ®‹è¡€æ—¶ä¸å¤ªå€¼å¾—ç”¨
        }
        // =========================================================
        // ã€Soft-Codedã€‘å¯¹ç›®æ ‡æ–½åŠ  volatile çŠ¶æ€çš„æŠ€èƒ½
        // æ£€æŸ¥ç›®æ ‡æ˜¯å¦å·²æœ‰è¯¥çŠ¶æ€
        // =========================================================
        if (fullMoveData.volatileStatus && fullMoveData.target !== 'self') {
            const volatileKey = fullMoveData.volatileStatus;
            // ç›®æ ‡å·²æœ‰è¯¥ volatile çŠ¶æ€ï¼Œç¦æ­¢ä½¿ç”¨
            if (defender.volatile && defender.volatile[volatileKey]) {
                console.log(`[AI BAN] ${moveName}ï¼šç›®æ ‡å·²æœ‰ ${volatileKey} çŠ¶æ€`);
                return -99999;
            }
            // yawn: å¯¹æ‰‹å·²æœ‰å¼‚å¸¸çŠ¶æ€æ—¶æ— æ•ˆ
            if (volatileKey === 'yawn' && defender.status) {
                console.log(`[AI BAN] ${moveName}ï¼šå¯¹æ‰‹å·²æœ‰å¼‚å¸¸çŠ¶æ€ (${defender.status})`);
                return -99999;
            }
            // curse (å¹½çµç³»): å¯¹æ‰‹å·²è¢«è¯…å’’
            if (volatileKey === 'curse') {
                // å¹½çµç³»è¯…å’’ï¼šéœ€è¦æ‰£50%è¡€ï¼Œå¯èƒ½å¯¼è‡´è‡ªæ€
                if (attacker.types && attacker.types.includes('Ghost')) {
                    // ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€åªå®å¯æ¢¦
                    const aliveCount = (aiParty || []).filter(p => p && p.currHp > 0).length;
                    const isLastPokemon = aliveCount <= 1;
                    if (isLastPokemon) {
                        // æœ€åä¸€åªå®å¯æ¢¦ï¼Œç»å¯¹ä¸èƒ½è‡ªæ€è¯…å’’
                        console.log(`[AI BAN] Curseï¼šæœ€åä¸€åªå®å¯æ¢¦ï¼Œç¦æ­¢è‡ªæ€è¯…å’’`);
                        return -99999;
                    }
                    // ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæœ‰åŒå‘½çŠ¶æ€ï¼Œä¸è¦ç”¨è¯…å’’æ‰“æ–­å®ƒï¼ˆç»™æœ€ä½åˆ†ï¼‰
                    if (attacker.volatile && attacker.volatile.destinyBond) {
                        console.log(`[AI BAN] Curseï¼šæœ‰åŒå‘½çŠ¶æ€ï¼Œä¸è¦è‡ªæ€æ‰“æ–­`);
                        return -999999; // æ¯”å…¶ä»–ç¦æ­¢æ‹›å¼æ›´ä½ï¼Œç¡®ä¿ä¸ä¼šè¢« fallback é€‰ä¸­
                    }
                    if (hpPercent <= 0.50) {
                        // æ®‹è¡€æ—¶ä½¿ç”¨è¯…å’’æ˜¯æœ‰æ•ˆçš„çŒ®ç¥­æˆ˜æœ¯ï¼ˆä½†ä¸æ˜¯æœ€åä¸€åªï¼‰
                        console.log(`[AI TACTIC] Curseï¼šæ®‹è¡€çŒ®ç¥­è¯…å’’ï¼`);
                        return 3000; // é«˜ä¼˜å…ˆçº§
                    }
                    // è¡€é‡é«˜äº50%æ—¶ï¼Œè¯…å’’çš„ä»·å€¼è¾ƒä½ï¼ˆä¼šæŸå¤±å¤§é‡HPï¼‰
                    console.log(`[AI WARN] Curseï¼šè¡€é‡ ${Math.floor(hpPercent*100)}% è¾ƒé«˜ï¼Œé™ä½ä¼˜å…ˆçº§`);
                    return -500; // é™ä½ä¼˜å…ˆçº§ä½†ä¸å®Œå…¨ç¦æ­¢
                }
            }
            // leechseed: å¯¹è‰ç³»æ— æ•ˆ
            if (volatileKey === 'leechseed') {
                if (defender.types && defender.types.includes('Grass')) {
                    console.log(`[AI BAN] Leech Seedï¼šå¯¹æ‰‹æ˜¯è‰ç³»ï¼Œæ— æ•ˆ`);
                    return -99999;
                }
                const defHpPercent = defender.currHp / defender.maxHp;
                if (defHpPercent < 0.20) {
                    return 5;
                }
                return 50;
            }
        }
        // =========================================================
        // ã€æ§åˆ¶æ‹›å¼ã€‘Mean Look / Block / Spider Web ç­‰
        // å¯¹æ‰‹å·²è¢«å›°ä½æ—¶ç¦æ­¢é‡å¤ä½¿ç”¨
        // =========================================================
        const trappingMoves = ['Mean Look', 'Block', 'Spider Web', 'Anchor Shot', 'Spirit Shackle', 'Jaw Lock'];
        if (trappingMoves.includes(moveName)) {
            // å¯¹æ‰‹å·²è¢«å›°ä½
            if (defender.volatile && defender.volatile.cantEscape) {
                console.log(`[AI BAN] ${moveName}ï¼šå¯¹æ‰‹å·²è¢«å›°ä½ï¼Œæ— æ•ˆ`);
                return -99999;
            }
            // å¯¹æ‰‹æ˜¯å¹½çµç³»ï¼Œå…ç–«
            if (defender.types && defender.types.includes('Ghost')) {
                console.log(`[AI BAN] ${moveName}ï¼šå¯¹æ‰‹æ˜¯å¹½çµç³»ï¼Œå…ç–«`);
                return -99999;
            }
            // æ§åˆ¶æ‹›å¼æœ‰ä¸€å®šä»·å€¼
            return 80;
        }
        // =========================================================
        // ã€ç­äº¡ä¹‹æ­Œã€‘Perish Song - åŒæ–¹éƒ½å·²æœ‰çŠ¶æ€æ—¶ç¦æ­¢ä½¿ç”¨
        // =========================================================
        if (moveName === 'Perish Song') {
            // ä»»æ„ä¸€æ–¹å·²æœ‰ç­äº¡ä¹‹æ­ŒçŠ¶æ€ï¼Œç¦æ­¢ä½¿ç”¨
            const attackerHasPerish = attacker.volatile && attacker.volatile.perishsong;
            const defenderHasPerish = defender.volatile && defender.volatile.perishsong;
            if (attackerHasPerish || defenderHasPerish) {
                console.log(`[AI BAN] Perish Songï¼šå·²æœ‰ç­äº¡ä¹‹æ­ŒçŠ¶æ€ï¼Œæ— æ•ˆ`);
                return -99999;
            }
            // æœ€åä¸€åªå®å¯æ¢¦ä¸åº”è¯¥ä½¿ç”¨ç­äº¡ä¹‹æ­Œï¼ˆä¼šåŒå½’äºå°½ï¼‰
            const aliveCount = (aiParty || []).filter(p => p && p.currHp > 0).length;
            if (aliveCount <= 1) {
                console.log(`[AI BAN] Perish Songï¼šæœ€åä¸€åªå®å¯æ¢¦ï¼Œç¦æ­¢ä½¿ç”¨`);
                return -99999;
            }
            return 100; // ç­äº¡ä¹‹æ­Œæœ‰æˆ˜æœ¯ä»·å€¼
        }
        // =========================================================
        // ã€å±æ€§å˜åŒ–æŠ€èƒ½ã€‘å®Œæ•´çš„ç±»å‹å˜åŒ–æŠ€èƒ½æ‹¦æˆªç³»ç»Ÿ
        // é˜²æ­¢ AI å¯¹å·²ç»è¾¾æˆçš„çŠ¶æ€é‡å¤ä½¿ç”¨æ— æ•ˆæŠ€èƒ½
        // =========================================================
        // 1. Transform (å˜èº«) - å¤åˆ¶å¯¹æ‰‹çš„ä¸€åˆ‡
        if (moveName === 'Transform') {
            // å¦‚æœç›®æ ‡å·²ç»å˜èº«è¿‡ï¼Œå¤±è´¥
            if (defender.isTransformed || (defender.volatile && defender.volatile.transformed)) {
                console.log(`[AI BAN] Transform: ç›®æ ‡å·²ç»å˜èº«è¿‡`);
                return -99999;
            }
            // å¦‚æœç›®æ ‡æœ‰æ›¿èº«ï¼Œå¤±è´¥
            if (defender.volatile && defender.volatile.substitute) {
                console.log(`[AI BAN] Transform: ç›®æ ‡æœ‰æ›¿èº«`);
                return -99999;
            }
            // ç™¾å˜æ€ªäº’ç›¸å¯¹è§†æ—¶é¿å…æ­»å¾ªç¯
            const attackerSpecies = (attacker.species || attacker.name || '').toLowerCase();
            const defenderSpecies = (defender.species || defender.name || '').toLowerCase();
            if (attackerSpecies.includes('ditto') && defenderSpecies.includes('ditto')) {
                console.log(`[AI BAN] Transform: ç™¾å˜æ€ªäº’ç›¸å˜èº«æ— æ„ä¹‰`);
                return -99999;
            }
            return 100; // å˜èº«æ˜¯å¼ºåŠ›æŠ€èƒ½
        }
        // 2. Conversion (çº¹ç†) - å˜æˆè‡ªå·±ç¬¬ä¸€æ‹›çš„å±æ€§
        if (moveName === 'Conversion') {
            const firstMove = attacker.moves[0];
            if (firstMove && firstMove.type) {
                const targetType = firstMove.type;
                // å¦‚æœå·²ç»æ˜¯è¯¥å±æ€§ï¼ˆå•å±æ€§ä¸”ç›¸åŒï¼‰ï¼Œç¦æ­¢ä½¿ç”¨
                if (attacker.types && attacker.types.length === 1 && attacker.types[0] === targetType) {
                    console.log(`[AI BAN] Conversion: å·²ç»æ˜¯ ${targetType} å±æ€§`);
                    return -99999;
                }
            }
            return 30;
        }
        // 3. Reflect Type (é•œé¢å±æ€§) - å¤åˆ¶å¯¹æ‰‹çš„å±æ€§
        if (moveName === 'Reflect Type') {
            const myTypes = (attacker.types || ['Normal']).slice().sort().join(',');
            const targetTypes = (defender.types || ['Normal']).slice().sort().join(',');
            // å¦‚æœå±æ€§ç»„åˆå®Œå…¨ä¸€è‡´ï¼Œå¤±è´¥
            if (myTypes === targetTypes) {
                console.log(`[AI BAN] Reflect Type: å±æ€§å·²ç›¸åŒ (${myTypes})`);
                return -99999;
            }
            return 25;
        }
        // 4. Burn Up (ç‡ƒå°½) - å¤±å»ç«å±æ€§çš„å¼ºåŠ›ç«ç³»æ”»å‡»
        if (moveName === 'Burn Up') {
            const types = attacker.types || [];
            if (!types.includes('Fire')) {
                console.log(`[AI BAN] Burn Up: ä¸å†æ˜¯ç«ç³»ï¼Œæ— æ³•ä½¿ç”¨`);
                return -99999;
            }
            // è¿™æ˜¯æ”»å‡»æŠ€èƒ½ï¼Œç”±ä¼¤å®³è®¡ç®—å¤„ç†ï¼Œè¿™é‡Œåªåšå±æ€§æ£€æŸ¥
        }
        // 5. Double Shock (ç”µå…‰åŒå‡») - å¤±å»ç”µå±æ€§çš„å¼ºåŠ›ç”µç³»æ”»å‡»
        if (moveName === 'Double Shock') {
            const types = attacker.types || [];
            if (!types.includes('Electric')) {
                console.log(`[AI BAN] Double Shock: ä¸å†æ˜¯ç”µç³»ï¼Œæ— æ³•ä½¿ç”¨`);
                return -99999;
            }
            // è¿™æ˜¯æ”»å‡»æŠ€èƒ½ï¼Œç”±ä¼¤å®³è®¡ç®—å¤„ç†
        }
        // 6. Soak (æµ¸æ°´) - æŠŠå¯¹æ‰‹å˜æˆçº¯æ°´ç³»
        if (moveName === 'Soak') {
            const types = defender.types || [];
            if (types.length === 1 && types[0] === 'Water') {
                console.log(`[AI BAN] Soak: å¯¹æ‰‹å·²ç»æ˜¯çº¯æ°´ç³»`);
                return -99999;
            }
            // å¯¹æ°´ç³»å®å¯æ¢¦ä½¿ç”¨æ„ä¹‰ä¸å¤§ï¼ˆè™½ç„¶ä¸ä¼šå¤±è´¥ï¼Œä½†æˆ˜æœ¯ä»·å€¼ä½ï¼‰
            if (types.includes('Water') && types.length === 1) {
                return 5;
            }
            return 40; // æ”¹å˜å¯¹æ‰‹å±æ€§æœ‰æˆ˜æœ¯ä»·å€¼
        }
        // 7. Magic Powder (é­”æ³•ç²‰) - æŠŠå¯¹æ‰‹å˜æˆçº¯è¶…èƒ½åŠ›ç³»
        if (moveName === 'Magic Powder') {
            const types = defender.types || [];
            if (types.length === 1 && types[0] === 'Psychic') {
                console.log(`[AI BAN] Magic Powder: å¯¹æ‰‹å·²ç»æ˜¯çº¯è¶…èƒ½åŠ›ç³»`);
                return -99999;
            }
            return 35;
        }
        // 8. Trick-or-Treat (ä¸‡åœ£å¤œ) - ç»™å¯¹æ‰‹è¿½åŠ å¹½çµå±æ€§
        if (moveName === 'Trick-or-Treat') {
            if ((defender.types || []).includes('Ghost')) {
                console.log(`[AI BAN] Trick-or-Treat: å¯¹æ‰‹å·²ç»æœ‰å¹½çµå±æ€§`);
                return -99999;
            }
            return 30;
        }
        // 9. Forest's Curse (æ£®æ—è¯…å’’) - ç»™å¯¹æ‰‹è¿½åŠ è‰å±æ€§
        if (moveName === "Forest's Curse") {
            if ((defender.types || []).includes('Grass')) {
                console.log(`[AI BAN] Forest's Curse: å¯¹æ‰‹å·²ç»æœ‰è‰å±æ€§`);
                return -99999;
            }
            return 30;
        }
        // =========================================================
        // ã€Soft-Codedã€‘å»¶è¿Ÿç”Ÿæ•ˆæŠ€èƒ½ (slotCondition æˆ–ç‰¹å®š volatileStatus)
        // æ®‹è¡€æ—¶ä½¿ç”¨æ— æ„ä¹‰
        // =========================================================
        const isDelayedEffect = fullMoveData.slotCondition || 
            (fullMoveData.volatileStatus === 'yawn') ||
            (fullMoveData.isFutureMove);
        if (isDelayedEffect && hpPercent < 0.25) {
            console.log(`[AI BAN] ${moveName}ï¼šæ®‹è¡€ä½¿ç”¨å»¶è¿ŸæŠ€èƒ½æ— æ„ä¹‰`);
            return -99999;
        }
        // Wish: è¡€é‡å¥åº·æ—¶ä¸éœ€è¦ï¼ˆä½¿ç”¨ slotCondition æ£€æµ‹ï¼‰
        if (fullMoveData.slotCondition === 'wish') {
            if (hpPercent > 0.70) {
                return 5; // è¡€é‡å¥åº·ï¼Œä¸éœ€è¦è®¸æ„¿
            }
            if (hpPercent < 0.50) {
                return 60; // è¡€é‡ä¸­ç­‰ï¼Œå¯ä»¥è®¸æ„¿
            }
        }
        // =========================================================
        // ã€Critical Fixã€‘è‡ªæˆ‘ç‰ºç‰²æŠ€èƒ½ (Memento, Healing Wish, Lunar Dance)
        // æ£€æŸ¥ selfdestruct å­—æ®µï¼Œé˜²æ­¢æ— æ•ˆä½¿ç”¨å¯¼è‡´æ­»å¾ªç¯
        // =========================================================
        if (fullMoveData.selfdestruct) {
            // Memento: é™ä½å¯¹æ‰‹æ”»å‡»å’Œç‰¹æ”»å„2çº§
            if (fullMoveData.boosts) {
                const targetBoosts = defender.boosts || {};
                let canLowerStats = false;
                // æ£€æŸ¥æ˜¯å¦è¿˜èƒ½é™ä½ä»»ä½•å±æ€§
                for (const [stat, value] of Object.entries(fullMoveData.boosts)) {
                    const currentBoost = targetBoosts[stat] || 0;
                    // å¦‚æœå½“å‰ç­‰çº§ > -6ï¼Œè¯´æ˜è¿˜èƒ½é™ä½
                    if (value < 0 && currentBoost > -6) {
                        canLowerStats = true;
                        break;
                    }
                }
                // å¦‚æœæ‰€æœ‰ç›¸å…³å±æ€§éƒ½å·²ç»æ˜¯ -6ï¼Œç¦æ­¢ä½¿ç”¨
                if (!canLowerStats) {
                    console.log(`[AI BAN] ${moveName} æ— æ•ˆï¼šå¯¹æ‰‹å±æ€§å·²é™è‡³æœ€ä½ (atk:${targetBoosts.atk || 0}, spa:${targetBoosts.spa || 0})`);
                    return -99999;
                }
                // åªæœ‰åœ¨å¯¹æ‰‹å¨èƒå¾ˆå¤§ä¸”æˆ‘æ–¹å³å°†å€’ä¸‹æ—¶æ‰ä½¿ç”¨
                const defenderHpPercent = defender.currHp / defender.maxHp;
                const attackerHpPercent = attacker.currHp / attacker.maxHp;
                // å¯¹æ‰‹æ®‹è¡€æ—¶ä¸è¦ç”¨ï¼ˆæµªè´¹ï¼‰
                if (defenderHpPercent < 0.3) {
                    console.log(`[AI BAN] ${moveName}ï¼šå¯¹æ‰‹æ®‹è¡€ï¼Œä¸å€¼å¾—ç‰ºç‰²`);
                    return -9999;
                }
                // è‡ªå·±è¿˜å¥åº·æ—¶ä¸è¦ç”¨
                if (attackerHpPercent > 0.5) {
                    console.log(`[AI BAN] ${moveName}ï¼šè‡ªå·±è¿˜å¥åº·ï¼Œä¸åº”ç‰ºç‰²`);
                    return -9999;
                }
                // åªæœ‰åœ¨è‡ªå·±æ®‹è¡€ä¸”å¯¹æ‰‹å¼ºå¤§æ—¶æ‰è€ƒè™‘
                if (attackerHpPercent <= 0.3 && defenderHpPercent > 0.6) {
                    // æ£€æŸ¥å¯¹æ‰‹æ˜¯å¦å·²ç»è¢«å‰Šå¼±
                    const atkDebuff = targetBoosts.atk || 0;
                    const spaDebuff = targetBoosts.spa || 0;
                    if (atkDebuff <= -4 && spaDebuff <= -4) {
                        // å·²ç»å‰Šå¼±å¾—å¤Ÿå¤šäº†
                        console.log(`[AI BAN] ${moveName}ï¼šå¯¹æ‰‹å·²è¢«å……åˆ†å‰Šå¼± (atk:${atkDebuff}, spa:${spaDebuff})`);
                        return -9999;
                    }
                    // å¯ä»¥ä½¿ç”¨ï¼Œä½†ä¼˜å…ˆçº§ä¸é«˜
                    return 30;
                }
                // å…¶ä»–æƒ…å†µä¸ä½¿ç”¨
                return -9999;
            }
            // Healing Wish / Lunar Dance: åªåœ¨æœ‰åå¤‡ä¸”è‡ªå·±æ®‹è¡€æ—¶ä½¿ç”¨
            if (moveName === 'Healing Wish' || moveName === 'Lunar Dance') {
                if (hpPercent > 0.2) {
                    return -9999; // è¡€é‡è¿˜è¡Œï¼Œä¸ç‰ºç‰²
                }
                // éœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰åå¤‡å®å¯æ¢¦ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
                return 20;
            }
        }
        // å¼ºåŒ–æŠ€èƒ½ - ã€è½¯ç¼–ç ã€‘ä½¿ç”¨ PS çš„ boosts å­—æ®µ
        const moveBoosts = fullMoveData.boosts;
        const isSelfBoostMove = moveBoosts && ['self', 'allySide', 'adjacentAllyOrSelf'].includes(fullMoveData.target);
        if (isSelfBoostMove) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ”»å‡»/ç‰¹æ”»å¼ºåŒ–
            const hasOffensiveBoost = (moveBoosts.atk && moveBoosts.atk > 0) || (moveBoosts.spa && moveBoosts.spa > 0);
            if (hasOffensiveBoost) {
                const relevantBoost = attacker.spa > attacker.atk ? (attacker.boosts?.spa || 0) : (attacker.boosts?.atk || 0);
                if (relevantBoost < 2) statusScore = 80 + Math.random() * 20;
                else if (relevantBoost < 4) statusScore = 40 + Math.random() * 20;
                else statusScore = 5;
            }
        }
        // çŠ¶æ€æŠ€èƒ½ - ã€è½¯ç¼–ç ã€‘ä½¿ç”¨ PS çš„ status å­—æ®µ
        const inflictedStatus = fullMoveData.status; // 'slp', 'par', 'brn', 'psn', 'tox', 'frz'
        if (inflictedStatus) {
            if (!defender.status) {
                // ç¡çœ æ‹›å¼
                if (inflictedStatus === 'slp') {
                    // ã€ä¿®å¤ã€‘æ£€æŸ¥ç›®æ ‡æ˜¯å¦å…ç–«ç¡çœ 
                    // ã€è½¯ç¼–ç ã€‘ä» AbilityHandlers è¯»å–ç¡çœ å…ç–«ç‰¹æ€§åˆ—è¡¨
                    const defenderAbility = (defender.ability || '').toLowerCase().replace(/[^a-z]/g, '');
                    const sleepImmuneAbilities = (typeof AbilityHandlers !== 'undefined' && AbilityHandlers._sleepImmuneAbilities) 
                        ? AbilityHandlers._sleepImmuneAbilities 
                        : ['insomnia', 'vitalspirit', 'comatose', 'purifyingsalt', 'sweetveil'];
                    if (sleepImmuneAbilities.includes(defenderAbility)) {
                        statusScore = -100; // å…ç–«ç¡çœ ï¼Œä¸ä½¿ç”¨
                    } else {
                        statusScore = 70 + Math.random() * 30;
                    }
                // éº»ç—¹æ‹›å¼
                } else if (inflictedStatus === 'par') {
                    statusScore = defender.spe > attacker.spe ? 60 + Math.random() * 20 : 30 + Math.random() * 20;
                // çƒ§ä¼¤æ‹›å¼
                } else if (inflictedStatus === 'brn') {
                    statusScore = defender.atk > defender.spa ? 65 + Math.random() * 20 : 25 + Math.random() * 15;
                // ä¸­æ¯’æ‹›å¼
                } else if (inflictedStatus === 'psn' || inflictedStatus === 'tox') {
                    statusScore = 50 + Math.random() * 20;
                }
            } else {
                statusScore = -100;
            }
        }
        // å›å¤æŠ€èƒ½ - ã€è½¯ç¼–ç ã€‘ä¼˜å…ˆä½¿ç”¨ PS çš„ heal å­—æ®µæˆ– flags.heal
        const isHealMove = (fullMoveData.heal || (fullMoveData.flags && fullMoveData.flags.heal)) && 
                           fullMoveData.target === 'self';
        if (isHealMove) {
            const hpPercent = attacker.currHp / attacker.maxHp;
            const defenderHpPercent = defender.currHp / defender.maxHp;
            // ã€å…³é”®ä¿®å¤ã€‘æ»¡è¡€æ—¶ç»å¯¹ä¸ä½¿ç”¨å›å¤æŠ€èƒ½
            if (hpPercent >= 0.95) {
                console.log(`[AI BAN] ${moveName}ï¼šæ»¡è¡€ (${Math.round(hpPercent * 100)}%) ç¦æ­¢ä½¿ç”¨å›å¤æŠ€èƒ½`);
                return -9999; // æ»¡è¡€æ—¶ç»å¯¹ä¸å›è¡€
            }
            // ã€ä¿®æ­£ã€‘å¯¹æ‰‹æ®‹è¡€æ—¶ï¼Œå¤§å¹…é™ä½å›è¡€æŠ€èƒ½ä¼˜å…ˆçº§
            if (defenderHpPercent < 0.25 && hpPercent > 0.4) {
                // å¯¹æ‰‹å¿«æ­»äº†ï¼Œæˆ‘è¿˜å¥åº·ï¼Œä¸è¦å›è¡€ï¼å»è¾“å‡ºï¼
                statusScore = -500;
            } else if (hpPercent < 0.3) {
                statusScore = 90 + Math.random() * 10;
            } else if (hpPercent < 0.5) {
                statusScore = 60 + Math.random() * 20;
            } else if (hpPercent < 0.7) {
                statusScore = 30 + Math.random() * 15;
            } else {
                statusScore = -100; // è¡€é‡å¥åº·æ—¶ä¸åº”è¯¥å›è¡€
            }
        }
        // ã€æ–°å¢ã€‘åä¼¤æŠ€èƒ½é¢„æµ‹è¯„åˆ† (Mirror Coat / Counter / Metal Burst)
        const counterMoves = ['Mirror Coat', 'Counter', 'Metal Burst'];
        if (counterMoves.includes(moveName)) {
            const defenderHpPercent = defender.currHp / defender.maxHp;
            // å¯¹æ‰‹æ®‹è¡€æ—¶ï¼Œåä¼¤æŠ€èƒ½æ¯«æ— æ„ä¹‰ï¼ˆå¯¹é¢å¯èƒ½ç›´æ¥æ¢äººæˆ–ç”¨å˜åŒ–æŠ€ï¼‰
            if (defenderHpPercent < 0.25) {
                return -9999;
            }
            // é¢„æµ‹å¯¹æ‰‹çš„æ”»å‡»ç±»å‹
            const defenderIsSpecialAttacker = (defender.baseStats?.spa || defender.spa || 0) > (defender.baseStats?.atk || defender.atk || 0);
            const defenderIsPhysicalAttacker = (defender.baseStats?.atk || defender.atk || 0) > (defender.baseStats?.spa || defender.spa || 0);
            // Mirror Coatï¼šåªå¯¹ç‰¹æ”»æ‰‹æœ‰æ•ˆ
            if (moveName === 'Mirror Coat') {
                if (defenderIsSpecialAttacker) {
                    // é¢„æµ‹å¯¹æ‰‹ä¼šç”¨ç‰¹æ®Šæ”»å‡»ï¼ŒMirror Coat æœ‰ä»·å€¼
                    const predictedDamage = attacker.maxHp * 0.35; // å‡è®¾å—åˆ° 35% HP ä¼¤å®³
                    const estimatedReturn = predictedDamage * 2;
                    statusScore = 40 + (estimatedReturn / defender.maxHp) * 100;
                } else if (defenderIsPhysicalAttacker) {
                    // å¯¹é¢æ˜¯ç‰©ç†æ‰‹ï¼ŒMirror Coat æ— ç”¨
                    return -9999;
                } else {
                    // ä¸ç¡®å®šï¼Œç»™ä¸ªä¸­ç­‰åˆ†æ•°
                    statusScore = 20;
                }
            }
            // Counterï¼šåªå¯¹ç‰©ç†æ‰‹æœ‰æ•ˆ
            if (moveName === 'Counter') {
                if (defenderIsPhysicalAttacker) {
                    const predictedDamage = attacker.maxHp * 0.35;
                    const estimatedReturn = predictedDamage * 2;
                    statusScore = 40 + (estimatedReturn / defender.maxHp) * 100;
                } else if (defenderIsSpecialAttacker) {
                    return -9999;
                } else {
                    statusScore = 20;
                }
            }
            // Metal Burstï¼šé€šç”¨åä¼¤ï¼Œä½†éœ€è¦åæ‰‹
            if (moveName === 'Metal Burst') {
                const attackerSpeed = attacker.spe || attacker.baseStats?.spe || 100;
                const defenderSpeed = defender.spe || defender.baseStats?.spe || 100;
                if (attackerSpeed < defenderSpeed) {
                    // æˆ‘æ¯”å¯¹æ‰‹æ…¢ï¼ŒMetal Burst æœ‰æ•ˆ
                    statusScore = 50;
                } else {
                    // æˆ‘æ¯”å¯¹æ‰‹å¿«ï¼ŒMetal Burst æ— æ•ˆ
                    return -5000;
                }
            }
        }
        // å®ˆä½ç±» - è€ƒè™‘è¿ç»­ä½¿ç”¨æƒ©ç½š
        // ã€è½¯ç¼–ç ã€‘ä½¿ç”¨ PS çš„ stallingMove å­—æ®µ
        const isProtectMove = fullMoveData.stallingMove === true;
        if (isProtectMove) {
            // æ£€æŸ¥è¿ç»­ä½¿ç”¨æƒ©ç½š
            const protectCounter = attacker.protectCounter || 0;
            if (protectCounter > 0) {
                // è¿ç»­ä½¿ç”¨æˆåŠŸç‡å¾ˆä½ï¼ŒAI åº”è¯¥é¿å…
                const successChance = Math.pow(1/3, protectCounter);
                if (successChance < 0.34) {
                    // æˆåŠŸç‡ä½äº 34%ï¼Œä¸å€¼å¾—å†’é™©
                    return -100;
                }
            }
            if (defender.status === 'psn' || defender.status === 'tox' || defender.status === 'brn') {
                statusScore = 40 + Math.random() * 30;
            } else {
                statusScore = 15 + Math.random() * 15;
            }
        }
        // é¦–å›åˆé™åˆ¶æŠ€èƒ½æ£€æŸ¥
        const firstTurnMoves = ['Fake Out', 'First Impression', 'Mat Block'];
        if (firstTurnMoves.includes(moveName)) {
            if ((attacker.turnsOnField || 0) > 0) {
                return -9999; // éé¦–å›åˆï¼Œå¿…å®šå¤±è´¥
            }
        }
        // åŒå‘½è¿ç»­ä½¿ç”¨é™åˆ¶
        if (moveName === 'Destiny Bond' && attacker.lastMoveUsed === 'Destiny Bond') {
            return -9999; // è¿ç»­ä½¿ç”¨å¿…å¤±è´¥
        }
        // åƒµç›´çŠ¶æ€æ£€æŸ¥
        if (attacker.mustRecharge) {
            return -9999; // éœ€è¦ä¼‘æ¯ï¼Œæ— æ³•è¡ŒåŠ¨
        }
        return statusScore;
    }
    // === æ”»å‡»æŠ€èƒ½è¯„åˆ†ï¼ˆä½¿ç”¨è½¯ç¼–ç çš„ evaluateMoveImpactï¼‰===
    const impact = evaluateMoveImpact(attacker, defender, move);
    const eff = impact.effectiveness;
    // å…ç–«æ—¶ç›´æ¥è¿”å›æä½åˆ†
    if (eff === 0) return -9999;
    let score = impact.totalScore;
    // =========================================================
    // ã€AI æ™ºå•†è¡¥æ­£ã€‘Contrary (å”±åè°ƒ) ç‰¹æ€§ä¸“é—¨å¢å¼º
    // è‡ªé™èƒ½åŠ›çš„æŠ€èƒ½åœ¨å”±åè°ƒä¸‹å˜æˆè‡ªæˆ‘å¼ºåŒ–
    // =========================================================
    const attackerAbility = (attacker.ability || '').toLowerCase();
    const isContrary = attackerAbility === 'contrary';
    if (isContrary) {
        // è½¯ç¼–ç ï¼šä» fullMoveData.self.boosts ä¸­æ£€æµ‹è‡ªé™èƒ½åŠ›
        const selfBoosts = fullMoveData.self?.boosts || {};
        let hasSelfDebuff = false;
        let debuffValue = 0;
        // æ£€æŸ¥æ‰€æœ‰è‡ªé™èƒ½åŠ›
        for (const stat of ['atk', 'def', 'spa', 'spd', 'spe']) {
            const boost = selfBoosts[stat] || 0;
            if (boost < 0) {
                hasSelfDebuff = true;
                debuffValue += Math.abs(boost);
            }
        }
        // å¦‚æœæœ‰è‡ªé™èƒ½åŠ›ï¼Œåœ¨å”±åè°ƒä¸‹å˜æˆå¼ºåŒ–
        if (hasSelfDebuff) {
            // æ¯çº§è‡ªé™å˜æˆ +1 å¼ºåŒ–ï¼Œä»·å€¼æé«˜
            const contraryBonus = debuffValue * 800; // æ¯çº§ +800 åˆ†
            score += contraryBonus;
            console.log(`[AI CONTRARY] ${attacker.cnName} çš„ ${moveName} å› å”±åè°ƒè·å¾— +${contraryBonus} åˆ† (è‡ªé™ ${debuffValue} çº§)`);
            // ç‰¹åˆ«åŠ æˆï¼šLeaf Storm / Overheat ç­‰ -2 ç‰¹æ”»çš„æŠ€èƒ½
            if (selfBoosts.spa === -2 || selfBoosts.atk === -2) {
                score += 500; // é¢å¤–åŠ æˆï¼Œå› ä¸ºè¿™ç±»æŠ€èƒ½å¨åŠ›æœ¬èº«å°±é«˜
                console.log(`[AI CONTRARY] ${moveName} æ˜¯é¡¶çº§å¼ºåŒ–æŠ€ï¼Œé¢å¤– +500 åˆ†`);
            }
        }
    }
    // ã€åå‘é€»è¾‘ã€‘éå”±åè°ƒæ—¶ï¼Œè‡ªé™èƒ½åŠ›æŠ€èƒ½åº”è¯¥é€‚å½“å‡åˆ†
    else {
        const selfBoosts = fullMoveData.self?.boosts || {};
        let debuffPenalty = 0;
        for (const stat of ['atk', 'def', 'spa', 'spd', 'spe']) {
            const boost = selfBoosts[stat] || 0;
            if (boost < 0) {
                // é™æ”»å‡»/ç‰¹æ”»æƒ©ç½šæ›´é‡
                if (stat === 'atk' || stat === 'spa') {
                    debuffPenalty += Math.abs(boost) * 100;
                } else {
                    debuffPenalty += Math.abs(boost) * 50;
                }
            }
        }
        if (debuffPenalty > 0) {
            score -= debuffPenalty;
        }
    }
    // =========================================================
    // ã€Extension 1ã€‘æ¡ä»¶å¢ä¼¤æŠ€èƒ½é€»è¾‘ (Variable Power)
    // Hex, Venoshock, Foul Play, Body Press, Gyro Ball ç­‰
    // =========================================================
    let damageMultiplier = 1.0;
    // 1.1 çŠ¶æ€æ–½åŠ å¢ä¼¤ (Facade, Hex, Venoshock, Wake-Up Slap)
    if (moveName === 'Facade' && (attacker.status === 'brn' || attacker.status === 'par' || attacker.status === 'psn' || attacker.status === 'tox')) {
        damageMultiplier = 2.0;
        if (attacker.status === 'brn') score += 1000; // çƒ§ä¼¤æ—¶ç¡¬æ’‘æ— è§†å‡åŠ
    }
    if (moveName === 'Hex' && defender.status) {
        damageMultiplier = 2.0;
        console.log(`[AI VAR] Hex å¯¹å¼‚å¸¸çŠ¶æ€ç›®æ ‡å¨åŠ›ç¿»å€`);
    }
    if (moveName === 'Venoshock' && (defender.status === 'psn' || defender.status === 'tox')) {
        damageMultiplier = 2.0;
    }
    if (moveName === 'Wake-Up Slap' && defender.status === 'slp') {
        damageMultiplier = 2.0;
    }
    if (moveName === 'Brine' && defender.currHp <= defender.maxHp / 2) {
        damageMultiplier = 2.0;
    }
    // 1.2 åˆ©ç”¨å¯¹æ‰‹å±æ€§è®¡ç®— (Foul Play / Body Press / Power Trip / Stored Power)
    if (moveName === 'Foul Play') {
        const enemyAtk = defender.atk || defender.baseStats?.atk || 50;
        const myAtk = attacker.atk || 50;
        if (enemyAtk > myAtk) {
            damageMultiplier = enemyAtk / myAtk;
            console.log(`[AI VAR] Foul Play ä½¿ç”¨å¯¹æ‰‹æ”»å‡»åŠ›: x${damageMultiplier.toFixed(1)}`);
        }
    }
    if (moveName === 'Body Press') {
        const myDef = attacker.def || 50;
        const myAtk = attacker.atk || 50;
        if (myDef > myAtk) {
            damageMultiplier = myDef / myAtk;
            console.log(`[AI VAR] Body Press ä½¿ç”¨è‡ªèº«é˜²å¾¡: x${damageMultiplier.toFixed(1)}`);
        }
    }
    if (moveName === 'Power Trip' || moveName === 'Stored Power') {
        const boosts = attacker.boosts || {};
        let totalBoosts = 0;
        for (const stat of ['atk', 'def', 'spa', 'spd', 'spe']) {
            totalBoosts += Math.max(0, boosts[stat] || 0);
        }
        if (totalBoosts > 0) {
            // æ¯çº§ +20 å¨åŠ›ï¼ŒåŸºç¡€ 20
            const power = 20 + totalBoosts * 20;
            damageMultiplier = power / 20;
            console.log(`[AI VAR] ${moveName} å¼ºåŒ–åŠ æˆ: ${totalBoosts}çº§ -> å¨åŠ›${power}`);
        }
    }
    // 1.3 é€Ÿåº¦ç±»æŠ€èƒ½ (Gyro Ball / Electro Ball)
    if (moveName === 'Gyro Ball') {
        const oppSpeed = getEffectiveSpeed(defender) || 1;
        const mySpeed = getEffectiveSpeed(attacker) || 1;
        const power = Math.min(150, Math.floor(25 * (oppSpeed / mySpeed)));
        if (power > (move.basePower || 80)) {
            damageMultiplier = power / (move.basePower || 80);
            console.log(`[AI VAR] Gyro Ball é€Ÿåº¦å·®è®¡ç®—: å¨åŠ›${power}`);
        }
    }
    if (moveName === 'Electro Ball') {
        const oppSpeed = getEffectiveSpeed(defender) || 1;
        const mySpeed = getEffectiveSpeed(attacker) || 1;
        const diff = mySpeed / oppSpeed;
        let power = 60;
        if (diff >= 4) power = 150;
        else if (diff >= 3) power = 120;
        else if (diff >= 2) power = 80;
        damageMultiplier = power / 60;
    }
    // 1.4 ä½“é‡ç±»æŠ€èƒ½ (Grass Knot / Low Kick / Heavy Slam / Heat Crash)
    if (moveName === 'Grass Knot' || moveName === 'Low Kick') {
        // ç®€åŒ–ï¼šå‡è®¾é‡å‹å®å¯æ¢¦å¨åŠ›æ›´é«˜
        const defenderWeight = defender.baseStats?.hp || 80; // ç”¨ HP è¿‘ä¼¼ä½“é‡
        if (defenderWeight > 100) damageMultiplier = 1.5;
        if (defenderWeight > 150) damageMultiplier = 2.0;
    }
    // 1.5 åº”ç”¨æ¡ä»¶å¢ä¼¤ä¿®æ­£
    if (damageMultiplier > 1.0) {
        const bonusDmg = impact.rawDamage * (damageMultiplier - 1);
        if ((impact.rawDamage + bonusDmg) >= defender.currHp) {
            score += 3000;
            console.log(`[AI CRITICAL] ${moveName} ç»è¿‡æ¡ä»¶ä¿®æ­£åå¯æ–©æ€!`);
        } else {
            score += Math.min(2000, bonusDmg / attacker.maxHp * 1000);
        }
    }
    // =========================================================
    // ã€Extension 2ã€‘å¤§çˆ†ç‚¸æˆ˜æœ¯é€»è¾‘ (Explosion / Self-Destruct)
    // =========================================================
    if (moveName === 'Explosion' || moveName === 'Self-Destruct' || moveName === 'Misty Explosion') {
        let enemyCount = 1;
        if (typeof battle !== 'undefined' && battle.playerParty) {
            enemyCount = battle.playerParty.filter(p => p && p.currHp > 0).length;
        }
        const canKill = impact.rawDamage >= defender.currHp;
        const myHpPct = attacker.currHp / attacker.maxHp;
        // Case A: è‡ªå·±æ®‹è¡€ï¼ˆ<15%ï¼‰ï¼ŒåºŸç‰©åˆ©ç”¨
        if (myHpPct < 0.15) {
            score += 5000;
            console.log(`[AI EXPLOSION] æ®‹è¡€è‡ªçˆ†: ${moveName} (+5000)`);
        }
        // Case B: èƒ½ç¡®æ€ä¸”å¯¹æ‰‹æ˜¯æœ€åä¸€åª -> ç»ˆç»“æ¯”èµ›
        else if (canKill && enemyCount === 1) {
            score += 10000;
            console.log(`[AI EXPLOSION] ç»ˆç»“æ¯”èµ›: ${moveName} (+10000)`);
        }
        // Case C: èƒ½æ€ä¸”å¯¹æ‰‹å¨èƒå¤§
        else if (canKill && myHpPct < 0.5) {
            score += 2000;
            console.log(`[AI EXPLOSION] ä¸€æ¢ä¸€: ${moveName} (+2000)`);
        }
        // Case D: æ»¡è¡€ä¸”æ€ä¸æ­»å¯¹æ‰‹ -> ä¸¥ç¦ä½¿ç”¨
        else {
            console.log(`[AI BAN] ${moveName} æ€ä¸æ­»äººäºèŠ‚å¥ï¼Œç¦ç”¨`);
            return -9999;
        }
    }
    // =========================================================
    // ã€Extension 3ã€‘çªè¢­é¢„åˆ¤é€»è¾‘ (Sucker Punch / Thunderclap)
    // =========================================================
    if (moveName === 'Sucker Punch' || moveName === 'Thunderclap') {
        // è¿ç»­ä½¿ç”¨æƒ©ç½š
        if (attacker.lastMoveUsed === moveName) {
            console.log(`[AI SMART] è¿ç»­çªè¢­æƒ©ç½š: ${moveName}`);
            score -= 500;
        }
        // é¢„æµ‹å¯¹æ‰‹è¡Œä¸ºï¼šå¦‚æœå¯¹æ‰‹å¨èƒå°ï¼Œå¯èƒ½ç”¨å˜åŒ–æŠ€ï¼Œçªè¢­ä¼šå¤±è´¥
        // ç®€åŒ–åˆ¤æ–­ï¼šå¯¹æ‰‹æ®‹è¡€æ—¶çªè¢­æœ‰æ•ˆï¼ˆæ”¶å‰²ï¼‰ï¼Œå¯¹æ‰‹å¥åº·ä¸”å¨èƒå°æ—¶é£é™©é«˜
        const defHpPct = defender.currHp / defender.maxHp;
        if (defHpPct < 0.2) {
            // å¯¹æ‰‹æ®‹è¡€ï¼Œçªè¢­æ”¶å‰²
            score += 1000;
            console.log(`[AI SMART] çªè¢­æ”¶å‰²æ®‹è¡€: ${moveName} (+1000)`);
        } else if (defHpPct > 0.7) {
            // å¯¹æ‰‹å¥åº·ï¼Œå¯èƒ½ä¼šç”¨å˜åŒ–æŠ€
            // æ£€æŸ¥å¯¹æ‰‹æ˜¯å¦æœ‰å¼ºåŒ–/å›å¤æŠ€èƒ½å€¾å‘
            const defenderIsSetupType = (defender.spa || 0) > (defender.atk || 0) * 1.2 || 
                                        (defender.def || 0) > 100 || (defender.spd || 0) > 100;
            if (defenderIsSetupType) {
                score -= 800;
                console.log(`[AI SMART] å¯¹æ‰‹å¯èƒ½å¼ºåŒ–ï¼Œçªè¢­é£é™©é«˜: ${moveName} (-800)`);
            }
        }
    }
    // =========================================================
    // ã€Extension 4ã€‘ç¡¬ç›´/è“„åŠ›æŠ€èƒ½é£é™©è¯„ä¼° [v3.5 å¢å¼º]
    // =========================================================
    const rechargeMoves = ['Hyper Beam', 'Giga Impact', 'Hydro Cannon', 'Blast Burn', 'Frenzy Plant', 'Roar of Time', 'Eternabeam', 'Prismatic Laser', 'Meteor Assault'];
    const chargeMoves = ['Solar Beam', 'Solar Blade', 'Meteor Beam', 'Sky Attack', 'Skull Bash'];
    const invulnMoves = ['Dig', 'Fly', 'Dive', 'Bounce', 'Phantom Force', 'Shadow Force', 'Sky Drop'];
    const weather = (typeof battle !== 'undefined' && battle.field) ? battle.field.weather : '';
    // æ£€æŸ¥å¼ºåŠ›é¦™è‰
    const hasHerb = (attacker.item || '').toLowerCase().includes('power herb') || 
                    (attacker.item || '').includes('å¼ºåŠ›é¦™è‰');
    // 4.1 ç¡¬ç›´æŠ€èƒ½ (éœ€è¦ä¸‹å›åˆä¸èƒ½åŠ¨)
    if (rechargeMoves.includes(moveName)) {
        if (impact.rawDamage < defender.currHp) {
            // æ‰“ä¸æ­»äººï¼Œä¸‹å›åˆæ˜¯æ´»é¶å­
            score -= 8000;
            console.log(`[AI SMART] ${moveName} æ— æ³•æ–©æ€ï¼Œç¡¬ç›´é£é™©ï¼Œç¦ç”¨`);
        } else {
            // èƒ½æ‰“æ­»ï¼Œä½†ä»æœ‰é£é™©
            score -= 500;
            // ç”¨ç ´åæ­»å…‰æ€æ®‹è¡€æ˜¯æµªè´¹
            if (defender.currHp < 50) {
                score -= 5000;
                console.log(`[AI SMART] æ²¡å¿…è¦ç”¨ ${moveName} æ€æ®‹è¡€`);
            }
        }
    }
    // 4.2 è“„åŠ›æŠ€èƒ½ (Solar Beam ç­‰)
    if (chargeMoves.includes(moveName)) {
        const isSolar = moveName.includes('Solar');
        // ã€å¤©æ°”ç»Ÿä¸€ã€‘å…¼å®¹ sun å’Œ harshsun
        const hasSun = (weather === 'sun' || weather === 'harshsun');
        if (isSolar && !hasSun && !hasHerb) {
            // æ²¡æœ‰æ™´å¤©ä¹Ÿæ²¡æœ‰å¼ºåŠ›é¦™è‰ï¼Œè“„åŠ›å›åˆæ˜¯é€
            score -= 5000;
            console.log(`[AI SMART] æ™´å¤©/é¦™è‰ç¼ºå¤±ï¼Œç¦æ­¢è£¸æ‰“ ${moveName}`);
        } else if (hasSun || hasHerb) {
            // å³å‘çŠ¶æ€ï¼Œè¿™æ˜¯å¥½æŠ€èƒ½
            score += 500;
            console.log(`[AI SMART] ${moveName} æœ‰å¤©æ°”/é¦™è‰åŠ æŒï¼ŒåŠ åˆ† (+500)`);
        }
        // Meteor Beam ç‰¹æ®Šå¤„ç†ï¼šè“„åŠ›æ—¶ +1 ç‰¹æ”»
        if (moveName === 'Meteor Beam' && !hasHerb) {
            // æ²¡æœ‰é¦™è‰ä½†èƒ½å¼ºåŒ–ï¼Œé£é™©é™ä½
            score -= 2000; // ä»æœ‰é£é™©ä½†ä¸æ˜¯å®Œå…¨ç¦ç”¨
        }
    }
    // 4.3 ã€v3.5 æ–°å¢ã€‘åŠæ— æ•ŒæŠ€èƒ½è¯„ä¼° (Dig, Fly, Dive ç­‰)
    if (invulnMoves.includes(moveName)) {
        // è®¡ç®—æ˜¯å¦å¤„äºå±æœºï¼ˆå¯¹æ–¹èƒ½ç§’æ€æˆ‘ï¼‰
        let maxIncomingDmg = 0;
        for (const pMove of defender.moves || []) {
            const pMerged = getMergedMoveData(pMove);
            const pDmg = simulateDamage(defender, attacker, pMerged);
            if (pDmg.damage > maxIncomingDmg) {
                maxIncomingDmg = pDmg.damage;
            }
        }
        const myHp = attacker.currHp;
        const willDieNextTurn = maxIncomingDmg >= myHp;
        const mySpeed = getEffectiveSpeed(attacker);
        const targetSpeed = getEffectiveSpeed(defender);
        const isTrickRoom = (typeof battle !== 'undefined') && battle.field && battle.field.trickRoom > 0;
        const aiFaster = isTrickRoom ? (mySpeed < targetSpeed) : (mySpeed > targetSpeed);
        if (hasHerb) {
            // æœ‰å¼ºåŠ›é¦™è‰ï¼šåŠæ— æ•ŒæŠ€èƒ½å˜æˆå³å‘é«˜å¨åŠ›æŠ€èƒ½ï¼Œå¤§å¹…åŠ åˆ†
            score += 800;
            console.log(`[AI SMART] ${moveName} æœ‰å¼ºåŠ›é¦™è‰ï¼Œå³å‘åŠæ— æ•ŒæŠ€èƒ½ (+800)`);
        } else if (willDieNextTurn && aiFaster) {
            // å¤„äºæ–©æ€çº¿ä¸”é€Ÿåº¦å¿«ï¼šåŠæ— æ•ŒæŠ€èƒ½å¯ä»¥èº²é¿è‡´å‘½æ”»å‡»
            score += 2000;
            console.log(`[AI EVASION] ${moveName} å±æœºé—ªé¿åŠ åˆ† (+2000)ï¼š${myHp}HP vs ${maxIncomingDmg}ä¼¤å®³`);
        } else if (!aiFaster) {
            // é€Ÿåº¦æ…¢ï¼šåŠæ— æ•ŒæŠ€èƒ½é£é™©é«˜ï¼ˆä¼šå…ˆè¢«æ‰“ï¼‰
            score -= 1000;
            console.log(`[AI SMART] ${moveName} é€Ÿåº¦æ…¢ï¼ŒåŠæ— æ•ŒæŠ€èƒ½é£é™©é«˜ (-1000)`);
        } else {
            // æ­£å¸¸æƒ…å†µï¼šè½»å¾®æƒ©ç½šï¼ˆä¸¤å›åˆæŠ€èƒ½æ•ˆç‡ä½ï¼‰
            score -= 300;
        }
    }
    // =========================================================
    // ã€Extension 5ã€‘è®¾ç½®å‹æŠ€èƒ½è¯„ä¼° (Charge/Defense Curl/Laser Focus)
    // è¿™äº›æŠ€èƒ½éœ€è¦ä¸‹å›åˆæ‰èƒ½å‘æŒ¥æ•ˆæœï¼Œéœ€è¦è¯„ä¼°ä½¿ç”¨æ—¶æœº
    // =========================================================
    const setupVolatileMoves = {
        'Charge': { volatile: 'charge', benefit: 'Electric moves x2' },
        'Defense Curl': { volatile: 'defensecurl', benefit: 'Rollout/Ice Ball x2' },
        'Laser Focus': { volatile: 'laserfocus', benefit: 'Next attack crits' }
    };
    if (setupVolatileMoves[moveName]) {
        const setupInfo = setupVolatileMoves[moveName];
        const hpPercent = attacker.currHp / attacker.maxHp;
        // å·²æœ‰è¯¥çŠ¶æ€ï¼Œä¸éœ€è¦é‡å¤ä½¿ç”¨
        if (attacker.volatile && attacker.volatile[setupInfo.volatile]) {
            score -= 5000;
            console.log(`[AI SETUP] ${moveName}ï¼šå·²æœ‰ ${setupInfo.volatile} çŠ¶æ€ï¼Œç¦æ­¢é‡å¤ä½¿ç”¨`);
        }
        // æ®‹è¡€æ—¶ä¸è¦ç”¨è®¾ç½®æŠ€èƒ½
        else if (hpPercent < 0.35) {
            score -= 3000;
            console.log(`[AI SETUP] ${moveName}ï¼šæ®‹è¡€ (${Math.round(hpPercent * 100)}%) ä¸åº”ä½¿ç”¨è®¾ç½®æŠ€èƒ½`);
        }
        // Chargeï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç”µç³»æŠ€èƒ½å¯ä»¥å—ç›Š
        else if (moveName === 'Charge') {
            const hasElectricMove = attacker.moves && attacker.moves.some(m => {
                const merged = getMergedMoveData(m);
                return merged.type === 'Electric' && (merged.basePower || merged.power || 0) >= 60;
            });
            if (!hasElectricMove) {
                score -= 5000;
                console.log(`[AI SETUP] Chargeï¼šæ²¡æœ‰é«˜å¨åŠ›ç”µç³»æŠ€èƒ½ï¼Œæ— æ„ä¹‰`);
            } else if (hpPercent > 0.6) {
                score += 50; // è¡€é‡å¥åº·æ—¶å¯ä»¥è€ƒè™‘
            }
        }
        // Defense Curlï¼šæ£€æŸ¥æ˜¯å¦æœ‰ Rollout/Ice Ball
        else if (moveName === 'Defense Curl') {
            const hasRollout = attacker.moves && attacker.moves.some(m => 
                m.name === 'Rollout' || m.name === 'Ice Ball'
            );
            if (!hasRollout) {
                // æ²¡æœ‰æ»šåŠ¨/å†°çƒï¼Œå˜åœ†åªæ˜¯æ™®é€šçš„é˜²å¾¡+1
                score -= 100; // è½»å¾®æƒ©ç½šï¼Œå› ä¸ºè¿˜æœ‰é˜²å¾¡æå‡æ•ˆæœ
            } else if (hpPercent > 0.6) {
                score += 100; // æœ‰é…åˆæŠ€èƒ½æ—¶åŠ åˆ†
            }
        }
        // Laser Focusï¼šä¸‹å›åˆå¿…å®šæš´å‡»
        else if (moveName === 'Laser Focus') {
            if (hpPercent > 0.5) {
                score += 30; // è¡€é‡å¥åº·æ—¶å¯ä»¥è€ƒè™‘
            }
        }
    }
    // æ–©æ€åŠ åˆ†
    if (impact.rawDamage >= defender.currHp) score += 5000;
    // å…ˆåˆ¶æŠ€æ–©æ€åŠ åˆ†
    const priority = move.priority || 0;
    if (priority > 0 && impact.rawDamage >= defender.currHp) score += 2000;
    // ä½è¡€é‡æ—¶ä¼˜å…ˆå…ˆåˆ¶æŠ€
    const myHpPercent = attacker.currHp / attacker.maxHp;
    if (priority > 0 && myHpPercent < 0.3) score += 500;
    // =========================================================
    // ã€æ–°å¢ã€‘æ–©æ€æ¿€åŠ± (Execution Incentive)
    // å¯¹æ‰‹æ®‹è¡€æ—¶ï¼ŒAI åº”è¯¥ä¼˜å…ˆè¾“å‡ºè€Œä¸æ˜¯å›è¡€/è¾…åŠ©
    // =========================================================
    const defenderHpPercent = defender.currHp / defender.maxHp;
    const defenderIsLowHp = defenderHpPercent < 0.25 || (defender.currHp < 100 && myHpPercent > 0.4);
    if (defenderIsLowHp) {
        // å¯¹æ‰‹æ®‹è¡€æ—¶ï¼Œæ”»å‡»æŠ€èƒ½å¤§å¹…åŠ åˆ†
        if (category !== 'status' && move.basePower > 0) {
            score += 300; // æ®‹è¡€å¿…æ€åŠ æˆ
            // å¦‚æœèƒ½æ–©æ€ï¼Œå†åŠ åˆ†
            if (impact.rawDamage >= defender.currHp) {
                score += 200; // ç¡®ä¿æ–©æ€ä¼˜å…ˆçº§æœ€é«˜
            }
        }
    }
    // å…‹åˆ¶åŠ åˆ†
    if (eff >= 2) score += 100;
    if (eff >= 4) score += 200;
    // ã€å¼ºåŒ–ã€‘æ•ˆæœä¸å¥½å‡åˆ† - æ›´ä¸¥å‰çš„æƒ©ç½š
    // AI ä¸åº”è¯¥ç”¨æ•ˆæœä¸å¥½çš„æŠ€èƒ½ï¼Œé™¤éæ²¡æœ‰æ›´å¥½çš„é€‰æ‹©
    if (eff <= 0.5 && eff > 0) score -= 200;  // ä» -50 æ”¹ä¸º -200
    if (eff <= 0.25) score -= 500;            // ä» -100 æ”¹ä¸º -500
    // ã€æ–°å¢ã€‘å¦‚æœæœ‰æ›´å¥½çš„å±æ€§å…‹åˆ¶é€‰æ‹©ï¼Œè¿›ä¸€æ­¥æƒ©ç½šæ•ˆæœä¸å¥½çš„æŠ€èƒ½
    // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æŠ€èƒ½èƒ½æ‰“å‡ºæ›´å¥½çš„æ•ˆæœ
    if (eff <= 0.5 && attacker.moves && attacker.moves.length > 1) {
        for (const otherMove of attacker.moves) {
            if (otherMove === move) continue;
            const otherMerged = getMergedMoveData(otherMove);
            const otherEff = getTypeEffectivenessAI(otherMerged.type || 'Normal', defender.types || ['Normal']);
            // å¦‚æœæœ‰æ›´å¥½çš„å±æ€§å…‹åˆ¶æŠ€èƒ½ï¼Œå¤§å¹…æƒ©ç½šå½“å‰æŠ€èƒ½
            if (otherEff > eff && (otherMerged.basePower || otherMerged.power || 0) >= 60) {
                score -= 300;
                break;
            }
        }
    }
    // ========================================
    // ã€v2.1ã€‘åä¼¤æŠ€èƒ½æ™ºèƒ½è¯„ä¼° - ç¦æ­¢è‡ªæ€å¼è¢­å‡»
    // ã€è½¯ç¼–ç ã€‘ä¼˜å…ˆä½¿ç”¨ PS moves-data.js çš„ recoil å­—æ®µ
    // ========================================
    // ä» PS æ•°æ®è·å–åä¼¤ä¿¡æ¯
    let recoilRatio = 0;
    if (fullMoveData.recoil) {
        // PS æ ¼å¼: recoil: [åˆ†å­, åˆ†æ¯]ï¼Œå¦‚ [1, 3] è¡¨ç¤º 1/3
        const [num, den] = fullMoveData.recoil;
        recoilRatio = num / den;
    } else if (fullMoveData.mindBlownRecoil || fullMoveData.struggleRecoil) {
        // ç‰¹æ®Šåä¼¤ç±»å‹ï¼ˆç²¾ç¥å‡»ç ´ã€æŒ£æ‰ï¼‰
        recoilRatio = 0.50;
    }
    if (recoilRatio > 0) {
        const moveDamage = impact.rawDamage || 0;
        const expectedRecoil = Math.floor(moveDamage * recoilRatio);
        // ã€æ ¸å¿ƒé€»è¾‘ã€‘å¦‚æœåä¼¤ä¼šè‡´æ­»
        if (expectedRecoil >= attacker.currHp) {
            // æ£€æŸ¥æ•Œæ–¹å‰©ä½™å­˜æ´»æ•°é‡
            let enemyAliveCount = 1; // è‡³å°‘æœ‰å½“å‰å¯¹æ‰‹
            if (typeof battle !== 'undefined' && battle.playerParty) {
                enemyAliveCount = battle.playerParty.filter(p => p && p.currHp > 0).length;
            }
            // æ£€æŸ¥è¿™ä¸€å‡»èƒ½å¦å‡»æ€å¯¹æ‰‹
            const canKill = moveDamage >= defender.currHp;
            if (canKill && enemyAliveCount <= 1) {
                // åŒå½’äºå°½ä¸”æ˜¯æœ€åä¸€åª -> å‹‡å¾€ç›´å‰ï¼
                score += 3000;
                console.log(`[AI RECOIL] åŒå½’äºå°½æ–©æ€æœ€åä¸€åª: ${moveName} (+3000)`);
            } else if (canKill && enemyAliveCount <= 2) {
                // èƒ½æ€ä½†å¯¹é¢è¿˜æœ‰2åª -> å‹‰å¼ºå¯ä»¥æ¥å—
                score -= 500;
                console.log(`[AI RECOIL] è‡ªæ€æ¢äººå¤´(å¯¹é¢å‰©${enemyAliveCount}): ${moveName} (-500)`);
            } else {
                // è‡ªæ€ä½†æ€ä¸æ‰ æˆ– å¯¹é¢è¿˜æœ‰å¾ˆå¤š -> æåˆ‘ç¦æ­¢
                score -= 8000;
                console.log(`[AI RECOIL] ç¦æ­¢è‡ªæ€å¼è¢­å‡»: ${moveName} (-8000)`);
            }
        } else if (expectedRecoil >= attacker.currHp * 0.5) {
            // åä¼¤ä¼šæ‰ä¸€åŠè¡€ä»¥ä¸Š -> è°¨æ…ä½¿ç”¨
            if (myHpPercent < 0.5) {
                score -= 400;
            }
        } else if (myHpPercent < 0.4) {
            // åŸæœ‰é€»è¾‘ï¼šä½è¡€é‡æ—¶å‡åˆ†
            score -= 200;
        }
    }
    // ========================================
    // v2.0ï¼šæŠ˜è¿”æŠ€èƒ½æˆ˜æœ¯è¯„åˆ†
    // ========================================
    if (isPivotMove(move)) {
        // ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å­˜æ´»é˜Ÿå‹å¯ä»¥æ¢å…¥
        // å¦‚æœæ²¡æœ‰é˜Ÿå‹äº†ï¼ŒæŠ˜è¿”æ¯«æ— æ„ä¹‰ï¼Œåº”è¯¥é€‰æ‹©é«˜ä¼¤å®³æŠ€èƒ½å¯¹æ”»
        let aliveAllies = 0;
        if (aiParty && aiParty.length > 0) {
            for (const ally of aiParty) {
                if (ally && ally !== attacker && ally.isAlive && ally.isAlive()) {
                    aliveAllies++;
                }
            }
        }
        if (aliveAllies === 0) {
            // æ²¡æœ‰é˜Ÿå‹äº†ï¼ŒæŠ˜è¿”æŠ€èƒ½å¤§å¹…å‡åˆ†ï¼ˆåªä¿ç•™åŸºç¡€ä¼¤å®³ä»·å€¼ï¼‰
            console.log(`[AI PIVOT] ${attacker.name} æ²¡æœ‰å­˜æ´»é˜Ÿå‹ï¼Œ${moveName} æŠ˜è¿”æ— æ„ä¹‰ï¼Œå¤§å¹…å‡åˆ†`);
            score -= 500; // å‡åˆ†ï¼Œè®© AI é€‰æ‹©å…¶ä»–é«˜ä¼¤å®³æŠ€èƒ½
        } else {
            // æœ‰é˜Ÿå‹æ—¶ï¼Œæ­£å¸¸è®¡ç®—æŠ˜è¿”åŠ åˆ†
            // åŸºç¡€å¥–åŠ±ï¼šçµæ´»æ€§æ€»æ˜¯å¥½çš„
            score += 300;
            const attackerSpeed = getEffectiveSpeed(attacker);
            const defenderSpeed = getEffectiveSpeed(defender);
            const isFaster = attackerSpeed > defenderSpeed;
            const isSlower = attackerSpeed < defenderSpeed;
            // å…ˆæ‰‹æŠ˜è¿” (Fast Pivot)ï¼šæ”¶å‰²æ®‹è¡€åå®‰å…¨æ’¤é€€
            if (isFaster && defender.currHp < defender.maxHp * 0.15) {
                score += 1500; // ç™½å«–ä¼¤å®³åè·‘è·¯
            }
            // åæ‰‹æŠ˜è¿” (Slow Pivot)ï¼šè®©é˜Ÿå‹æ— ä¼¤ä¸Šåœºï¼Œè¿™æ˜¯ç¥æŠ€
            // å¦‚æœæˆ‘æ¯”è¾ƒè‚‰ä¸”æ¯”å¯¹æ‰‹æ…¢
            const myBulk = (attacker.def || 80) + (attacker.spd || 80);
            if (isSlower && myBulk >= 160) {
                score += 1200; // åæ‰‹å¸¦äººæ˜¯æˆ˜æœ¯æ ¸å¿ƒ
            }
            // å¦‚æœæˆ‘çŠ¶æ€ä¸å¥½ï¼ˆèƒ½åŠ›ä¸‹é™ï¼‰ï¼ŒæŠ˜è¿”æ¸…é™¤è´Ÿé¢çŠ¶æ€
            const boosts = attacker.boosts || {};
            if ((boosts.atk || 0) <= -1 || (boosts.spa || 0) <= -1 || (boosts.spe || 0) <= -1) {
                score += 800; // ç”¨æŠ˜è¿”é‡ç½®çŠ¶æ€
            }
            // Parting Shot ç‰¹æ®ŠåŠ åˆ†ï¼ˆé™å¯¹æ‰‹èƒ½åŠ›ï¼‰
            if (moveName === 'Parting Shot') {
                score += 500;
            }
        }
    }
    return score;
}
/* =============================================================
 *  Revenge Killer é€‰æ‹© - æ™ºèƒ½æ¢äººé€»è¾‘
 * ============================================================= */
/**
 * å½“ AI çš„å®å¯æ¢¦å€’ä¸‹æ—¶ï¼Œé€‰æ‹©æœ€ä½³çš„å¤ä»‡è€…ä¸Šåœº
 * @param {Pokemon[]} party - AI é˜Ÿä¼
 * @param {Pokemon} opp - ç©å®¶å½“å‰åœºä¸Šçš„å®å¯æ¢¦
 * @param {number} currentActive - å½“å‰ï¼ˆå·²å€’ä¸‹çš„ï¼‰å®å¯æ¢¦ç´¢å¼•
 * @returns {number} - æœ€ä½³é˜Ÿå‘˜çš„ indexï¼Œ-1 è¡¨ç¤ºæ²¡æœ‰å¯ç”¨çš„
 */
export function getBestRevengeKiller(party, opp, currentActive = -1) {
    if (!party || !opp) return -1;
    let bestIdx = -1;
    let bestScore = -Infinity;
    party.forEach((p, i) => {
        // è·³è¿‡æ­»äº¡çš„ã€å½“å‰åœ¨åœºçš„
        if (!p || p.currHp <= 0 || !p.moves || i === currentActive) return;
        let score = 0;
        // 1. é€Ÿåº¦ä¼˜åŠ¿ (æœ€é‡è¦çš„å¤ä»‡å‡»æ€æŒ‡æ ‡)
        const mySpe = getEffectiveSpeed(p);
        const oppSpe = getEffectiveSpeed(opp);
        if (mySpe > oppSpe) score += 300;
        // 2. ä¼¤å®³æ½œåŠ› (èƒ½å¦ç§’æ€å¯¹é¢ï¼Ÿ)
        let maxDmg = 0;
        for (const m of p.moves) {
            const mergedMove = getMergedMoveData(m);
            const result = simulateDamage(p, opp, mergedMove);
            if (result.damage > maxDmg) maxDmg = result.damage;
        }
        const oppHp = opp.currHp || 1;
        const dmgPercent = maxDmg / oppHp;
        if (dmgPercent >= 1) {
            score += 500; // ç¡®ä¸€ï¼ˆç§’æ€ï¼‰ï¼æƒé‡æé«˜
        } else {
            score += dmgPercent * 200; // èƒ½æ‰“ç—›ä¹Ÿå¥½
        }
        // 3. æŠ—æ€§ (ä¼šä¸ä¼šè¢«å¯¹é¢æ‰“æ­»ï¼Ÿ)
        let incomingDmg = 0;
        let worstEff = 1;
        for (const m of opp.moves) {
            const mergedMove = getMergedMoveData(m);
            const result = simulateDamage(opp, p, mergedMove);
            if (result.damage > incomingDmg) {
                incomingDmg = result.damage;
                worstEff = result.effectiveness || 1;
            }
        }
        // ã€æ–°å¢ã€‘å±æ€§å…‹åˆ¶æ£€æŸ¥ï¼šè¢«å…‹åˆ¶çš„å®å¯æ¢¦å¤§å¹…å‡åˆ†
        if (worstEff >= 2) {
            score -= 400; // è¢«å…‹åˆ¶ï¼Œå°½é‡ä¸é€‰
            console.log(`[AI] ${p.cnName || p.name} è¢«å¯¹æ‰‹å…‹åˆ¶ (${worstEff}x)ï¼Œå‡åˆ†`);
        } else if (worstEff === 0) {
            score += 300; // å…ç–«å¯¹æ‰‹æœ€å¼ºæŠ€èƒ½ï¼ŒåŠ åˆ†
        } else if (worstEff <= 0.5) {
            score += 150; // æŠµæŠ—å¯¹æ‰‹æœ€å¼ºæŠ€èƒ½ï¼ŒåŠ åˆ†
        }
        // æˆ‘èƒ½æŒ¨å‡ ä¸‹ï¼Ÿ
        const mySurviveTurns = incomingDmg > 0 ? (p.currHp / incomingDmg) : 999;
        if (mySurviveTurns >= 2) {
            score += 200; // èƒ½åƒä¸¤å‘ï¼Œå¾ˆç¨³
        } else if (mySurviveTurns < 1) {
            score -= 300; // ä¸Šæ¥å°±æ­»ï¼Œå°½é‡ä¸é€‰
        }
        // 4. å…ˆåˆ¶æŠ€èƒ½åŠ åˆ†
        for (const m of p.moves) {
            const mergedMove = getMergedMoveData(m);
            if ((mergedMove.priority || 0) > 0 && (mergedMove.basePower || mergedMove.power || 0) > 0) {
                const result = simulateDamage(p, opp, mergedMove);
                if (result.damage >= oppHp) {
                    score += 400; // å…ˆåˆ¶æŠ€èƒ½èƒ½ç§’æ€ï¼Œæé«˜ä¼˜å…ˆçº§
                } else {
                    score += 100; // æœ‰å…ˆåˆ¶æŠ€èƒ½
                }
            }
        }
        if (score > bestScore) {
            bestScore = score;
            bestIdx = i;
        }
    });
    console.log(`[AI] getBestRevengeKiller: best index = ${bestIdx}, score = ${bestScore}`);
    return bestIdx;
}
/* =============================================================
 *  å¯¼å‡º
 * ============================================================= */
if (typeof window !== 'undefined') {
    window.AI_DIFFICULTY = AI_DIFFICULTY;
    window.AI_ACTION_TYPE = AI_ACTION_TYPE;
    window.getAiAction = getAiAction;
    window.getExpertAiAction = getExpertAiAction;
    window.getHardAiMove = getHardAiMove;
    window.getNormalAiMove = getNormalAiMove;
    window.getEasyAiMove = getEasyAiMove;
    window.getBestRevengeKiller = getBestRevengeKiller;
}
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        AI_DIFFICULTY,
        AI_ACTION_TYPE,
        getAiAction,
        getExpertAiAction,
        getHardAiMove,
        getNormalAiMove,
        getEasyAiMove
    };
}
]]></file>
        <file name="battle-engine.js"><![CDATA[/**
 * =============================================
 * BATTLE ENGINE - æˆ˜æ–—æ ¸å¿ƒå¼•æ“
 * =============================================
 * 
 * è´Ÿè´£ï¼š
 * - å±æ€§å…‹åˆ¶è®¡ç®—
 * - Pokemon å®ä¾‹åˆ›å»º
 * - æˆ˜æ–—çŠ¶æ€ç®¡ç†
 */
// === è½¯ç¼–ç ï¼šæ™ºèƒ½æå–åŸºç¡€å½¢æ€å ===
// ç¡¬ç¼–ç æ•°æ®å·²ç§»è‡³ move-constants.js
/**
 * ä»å®å¯æ¢¦åç§°æå–åŸºç¡€å½¢æ€IDï¼ˆç”¨äºå›¾ç‰‡å›é€€ï¼‰
 * @param {string} name åŸå§‹åç§°
 * @returns {string} åŸºç¡€å½¢æ€ID
 */
export function extractBaseFormId(name = '') {
    let id = name.toLowerCase().replace(/[^a-z0-9-]/g, '');
    // ä» move-constants.js è·å–åç¼€åˆ—è¡¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨å†…ç½®åå¤‡
    const suffixes = (typeof FORM_SUFFIXES !== 'undefined') ? FORM_SUFFIXES : [
        'starter', 'gmax', 'megax', 'megay', 'mega',
        'alola', 'galar', 'hisui', 'paldea',
        'therian', 'incarnate', 'origin', 'altered',
        'crowned', 'hero', 'eternamax', 'primal', 'ultra', 'ash', 'totem'
    ];
    // å°è¯•ç§»é™¤åç¼€
    for (const suffix of suffixes) {
        if (id.endsWith(suffix)) {
            const base = id.slice(0, -suffix.length);
            if (base.length >= 3) {
                return base;
            }
        }
    }
    return id;
}
/**
 * è·å–ç²¾çµå›¾IDï¼ˆä¿ç•™æ¨ªæ ä»¥æ”¯æŒåœ°åŒºå½¢æ€å’Œç‰¹æ®Šåå­—ï¼‰
 * ä¾‹å¦‚: "Vulpix-Alola" -> "vulpix-alola", "Ho-Oh" -> "ho-oh"
 * Mega å½¢æ€ç‰¹æ®Šå¤„ç†: "Charizard-Mega-X" -> "charizardmegax" (ç´§å‡‘æ ¼å¼)
 */
export function resolveSpriteId(name = '') {
    const normalized = name.toLowerCase().replace(/[^a-z0-9-]/g, '');
    // ã€ä¿®å¤ã€‘Mega å½¢æ€ï¼šä¿ç•™æ¨ªæ ï¼ˆShowdown æ ¼å¼ï¼‰
    // Metagross-Mega -> metagross-mega
    // Charizard-Mega-X -> charizard-mega-x
    // ä¸å†ç§»é™¤æ¨ªæ ï¼Œç›´æ¥è¿”å›è§„èŒƒåŒ–åçš„åç§°
    // å…¶ä»–å½¢æ€ï¼šä¿ç•™æ¨ªæ ï¼ˆåœ°åŒºå½¢æ€ã€ç‰¹æ®Šåå­—ç­‰ï¼‰
    return normalized;
}
/**
 * è·å–å›é€€ç²¾çµå›¾IDï¼ˆæå–åŸºç¡€å½¢æ€ï¼‰
 */
export function getFallbackSpriteId(name = '') {
    return extractBaseFormId(name);
}
if (typeof window !== 'undefined') {
    window.resolveSpriteId = resolveSpriteId;
    window.extractBaseFormId = extractBaseFormId;
    window.getFallbackSpriteId = getFallbackSpriteId;
}
// === æ€§æ ¼ä¿®æ­£è¡¨ ===
// æ€§æ ¼ -> { å¢ç›Šå±æ€§: 1.1, å‡ç›Šå±æ€§: 0.9 }
// æ— ä¿®æ­£æ€§æ ¼ï¼ˆè®¤çœŸã€åŠªåŠ›ç­‰ï¼‰ä¸åœ¨æ­¤è¡¨ä¸­
export const NATURE_MODIFIERS = {
    // åŠ æ”»å‡»
    'Lonely':   { atk: 1.1, def: 0.9 },
    'Adamant':  { atk: 1.1, spa: 0.9 },
    'Naughty':  { atk: 1.1, spd: 0.9 },
    'Brave':    { atk: 1.1, spe: 0.9 },
    // åŠ é˜²å¾¡
    'Bold':     { def: 1.1, atk: 0.9 },
    'Impish':   { def: 1.1, spa: 0.9 },
    'Lax':      { def: 1.1, spd: 0.9 },
    'Relaxed':  { def: 1.1, spe: 0.9 },
    // åŠ ç‰¹æ”»
    'Modest':   { spa: 1.1, atk: 0.9 },
    'Mild':     { spa: 1.1, def: 0.9 },
    'Rash':     { spa: 1.1, spd: 0.9 },
    'Quiet':    { spa: 1.1, spe: 0.9 },
    // åŠ ç‰¹é˜²
    'Calm':     { spd: 1.1, atk: 0.9 },
    'Gentle':   { spd: 1.1, def: 0.9 },
    'Careful':  { spd: 1.1, spa: 0.9 },
    'Sassy':    { spd: 1.1, spe: 0.9 },
    // åŠ é€Ÿåº¦
    'Timid':    { spe: 1.1, atk: 0.9 },
    'Hasty':    { spe: 1.1, def: 0.9 },
    'Jolly':    { spe: 1.1, spa: 0.9 },
    'Naive':    { spe: 1.1, spd: 0.9 },
};
// === å±æ€§å…‹åˆ¶è¡¨ ===
// æ”»å‡»æ–¹å±æ€§ -> { è¢«å…‹åˆ¶å±æ€§: 2, æŠµæŠ—å±æ€§: 0.5, å…ç–«å±æ€§: 0 }
export const TYPE_CHART = {
    'Normal':   { weak: [],                          resist: ['Rock', 'Steel'],      immune: ['Ghost'] },
    'Fire':     { weak: ['Grass', 'Ice', 'Bug', 'Steel'], resist: ['Fire', 'Water', 'Rock', 'Dragon'], immune: [] },
    'Water':    { weak: ['Fire', 'Ground', 'Rock'],  resist: ['Water', 'Grass', 'Dragon'], immune: [] },
    'Electric': { weak: ['Water', 'Flying'],         resist: ['Electric', 'Grass', 'Dragon'], immune: ['Ground'] },
    'Grass':    { weak: ['Water', 'Ground', 'Rock'], resist: ['Fire', 'Grass', 'Poison', 'Flying', 'Bug', 'Dragon', 'Steel'], immune: [] },
    'Ice':      { weak: ['Grass', 'Ground', 'Flying', 'Dragon'], resist: ['Fire', 'Water', 'Ice', 'Steel'], immune: [] },
    'Fighting': { weak: ['Normal', 'Ice', 'Rock', 'Dark', 'Steel'], resist: ['Poison', 'Flying', 'Psychic', 'Bug', 'Fairy'], immune: ['Ghost'] },
    'Poison':   { weak: ['Grass', 'Fairy'],          resist: ['Poison', 'Ground', 'Rock', 'Ghost'], immune: ['Steel'] },
    'Ground':   { weak: ['Fire', 'Electric', 'Poison', 'Rock', 'Steel'], resist: ['Grass', 'Bug'], immune: ['Flying'] },
    'Flying':   { weak: ['Grass', 'Fighting', 'Bug'], resist: ['Electric', 'Rock', 'Steel'], immune: [] },
    'Psychic':  { weak: ['Fighting', 'Poison'],      resist: ['Psychic', 'Steel'],   immune: ['Dark'] },
    'Bug':      { weak: ['Grass', 'Psychic', 'Dark'], resist: ['Fire', 'Fighting', 'Poison', 'Flying', 'Ghost', 'Steel', 'Fairy'], immune: [] },
    'Rock':     { weak: ['Fire', 'Ice', 'Flying', 'Bug'], resist: ['Fighting', 'Ground', 'Steel'], immune: [] },
    'Ghost':    { weak: ['Psychic', 'Ghost'],        resist: ['Dark'],               immune: ['Normal'] },
    'Dragon':   { weak: ['Dragon'],                  resist: ['Steel'],              immune: ['Fairy'] },
    'Dark':     { weak: ['Psychic', 'Ghost'],        resist: ['Fighting', 'Dark', 'Fairy'], immune: [] },
    'Steel':    { weak: ['Ice', 'Rock', 'Fairy'],    resist: ['Fire', 'Water', 'Electric', 'Steel'], immune: [] },
    'Fairy':    { weak: ['Fighting', 'Dark', 'Dragon'], resist: ['Fire', 'Poison', 'Steel'], immune: [] },
};
/**
 * è®¡ç®—å±æ€§å…‹åˆ¶å€ç‡
 * @param {string} atkType - æ”»å‡»æŠ€èƒ½å±æ€§
 * @param {string[]} defTypes - é˜²å¾¡æ–¹å±æ€§æ•°ç»„
 * @param {string} moveName - æŠ€èƒ½åç§°ï¼ˆç”¨äºç‰¹æ®Šå…‹åˆ¶è§„åˆ™ï¼‰
 * @returns {number} - å€ç‡ (0, 0.25, 0.5, 1, 2, 4)
 */
export function getTypeEffectiveness(atkType, defTypes, moveName = '') {
    const chart = TYPE_CHART[atkType];
    if (!chart) return 1;
    // é˜²æŠ¤ï¼šç¡®ä¿ defTypes æ˜¯æœ‰æ•ˆæ•°ç»„
    if (!Array.isArray(defTypes) || defTypes.length === 0) {
        console.warn(`[TYPE EFFECTIVENESS] Invalid defTypes:`, defTypes, `for atkType:`, atkType);
        return 1;
    }
    let multiplier = 1;
    const moveId = moveName.toLowerCase().replace(/[^a-z0-9]/g, '');
    for (const defType of defTypes) {
        // === ç‰¹æ®Šå…‹åˆ¶è§„åˆ™ ===
        // Freeze-Dry (å†·å†»å¹²ç‡¥): å¯¹æ°´ç³»æ•ˆæœç»ä½³
        if (moveId === 'freezedry' && defType === 'Water') {
            multiplier *= 2;
            continue;
        }
        // Flying Press (é£èº«é‡å‹): åŒæ—¶å…·æœ‰æ ¼æ–—å’Œé£è¡Œå±æ€§
        // Thousand Arrows (åƒç®­): å¯¹é£è¡Œç³»ä¹Ÿæœ‰æ•ˆ
        if (moveId === 'thousandarrows' && defType === 'Flying') {
            // ä¸å…ç–«ï¼Œæ­£å¸¸è®¡ç®—
            continue;
        }
        if (chart.immune.includes(defType)) return 0;
        if (chart.weak.includes(defType)) multiplier *= 2;
        if (chart.resist.includes(defType)) multiplier *= 0.5;
    }
    return multiplier;
}
/**
 * å®å¯æ¢¦åç§°è§„èŒƒåŒ–å™¨ ("å®½è¿›"ç­–ç•¥)
 * å°† AI ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€å½¢å®¹è¯è½¬æ¢ä¸ºæ ‡å‡†çš„ ID åç¼€
 * ä¾‹å¦‚: "Grimer-Alolan" -> "Grimer-Alola"
 * @param {string} rawName - åŸå§‹åç§°
 * @returns {string} è§„èŒƒåŒ–åçš„åç§°
 */
export function normalizePokemonName(rawName) {
    if (!rawName) return '';
    let name = String(rawName).trim();
    // å¤„ç†å½¢å®¹è¯åç¼€ (Alolan -> Alola, Galarian -> Galar, etc.)
    const adjectiveMap = [
        { pattern: /-Alolan$/i, replacement: '-Alola' },
        { pattern: /\s+Alolan$/i, replacement: '-Alola' },
        { pattern: /-Galarian$/i, replacement: '-Galar' },
        { pattern: /\s+Galarian$/i, replacement: '-Galar' },
        { pattern: /-Hisuian$/i, replacement: '-Hisui' },
        { pattern: /\s+Hisuian$/i, replacement: '-Hisui' },
        { pattern: /-Paldean$/i, replacement: '-Paldea' },
        { pattern: /\s+Paldean$/i, replacement: '-Paldea' }
    ];
    for (const { pattern, replacement } of adjectiveMap) {
        if (pattern.test(name)) {
            const normalized = name.replace(pattern, replacement);
            console.log(`[PKM] [NORMALIZE] "${rawName}" -> "${normalized}"`);
            return normalized;
        }
    }
    return name;
}
/**
 * ä» Pokemon Showdown POKEDEX è·å–å®å¯æ¢¦æ•°æ® (å¸¦æ™ºèƒ½å›é€€æœºåˆ¶)
 * ç­–ç•¥: è§„èŒƒåŒ–åç§° -> ç›´æ¥æŸ¥æ‰¾ -> ä¿®æ­£åç¼€ -> å›é€€åˆ°åŸºç¡€å½¢æ€
 * @param {string} name - è‹±æ–‡å (å¦‚ 'Pikachu')
 * @returns {object|null}
 */
export function getPokemonData(name) {
    if (typeof POKEDEX === 'undefined') return null;
    // === ç¬¬ä¸€æ­¥: è§„èŒƒåŒ–åç§° (å®½è¿›) ===
    const normalizedName = normalizePokemonName(name);
    let id = normalizedName.toLowerCase().replace(/[^a-z0-9]/g, '');
    // === ç¬¬äºŒæ­¥: ç›´æ¥æŸ¥æ‰¾ ===
    if (POKEDEX[id]) {
        const data = POKEDEX[id];
        return {
            name: data.name,
            types: data.types || ['Normal'],
            baseStats: data.baseStats
        };
    }
    // === ç¬¬ä¸‰æ­¥: ä¿®æ­£å¸¸è§çš„å½¢å®¹è¯åç¼€é”™è¯¯ ===
    const suffixFixes = [
        { from: 'alolan', to: 'alola' },
        { from: 'galarian', to: 'galar' },
        { from: 'hisuian', to: 'hisui' },
        { from: 'paldean', to: 'paldea' }
    ];
    for (const fix of suffixFixes) {
        if (id.endsWith(fix.from)) {
            const fixedId = id.slice(0, -fix.from.length) + fix.to;
            if (POKEDEX[fixedId]) {
                console.log(`[PKM] [SUFFIX FIX] "${id}" -> "${fixedId}"`);
                const data = POKEDEX[fixedId];
                return {
                    name: data.name,
                    types: data.types || ['Normal'],
                    baseStats: data.baseStats
                };
            }
        }
    }
    // === ç¬¬å››æ­¥: æ™ºèƒ½å›é€€åˆ°åŸºç¡€å½¢æ€ ===
    const splitChars = ['-', ' '];
    for (const splitChar of splitChars) {
        if (normalizedName.includes(splitChar)) {
            const potentialBaseName = normalizedName.split(splitChar)[0];
            if (potentialBaseName && potentialBaseName !== normalizedName) {
                const baseId = potentialBaseName.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (POKEDEX[baseId]) {
                    console.log(`[PKM] [FALLBACK] Using base species "${potentialBaseName}" instead of "${normalizedName}"`);
                    const data = POKEDEX[baseId];
                    return {
                        name: data.name,
                        types: data.types || ['Normal'],
                        baseStats: data.baseStats
                    };
                }
            }
        }
    }
    // === ç¬¬äº”æ­¥: æ‰¾ä¸åˆ° ===
    console.warn(`[PKM] [NOT FOUND] Pokemon "${name}" not found in POKEDEX`);
    return null;
}
/**
 * ä» Pokemon Showdown MOVES è·å–æŠ€èƒ½æ•°æ®
 * @param {string} name - è‹±æ–‡å (å¦‚ 'Thunderbolt')
 * @returns {object} åŒ…å«æ‰€æœ‰åŸå§‹æ•°æ® + æ ‡å‡†åŒ–å­—æ®µ
 */
export function getMoveData(name) {
    const id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
    const data = typeof MOVES !== 'undefined' ? MOVES[id] : null;
    if (!data) {
        return { name: name, type: 'Normal', power: 40, cat: 'phys', accuracy: 100 };
    }
    // === CRITICAL FIX ===
    // ä½¿ç”¨ spread operator ä¿ç•™æ‰€æœ‰åŸå§‹æ•°æ®ï¼ˆaccuracy, multihit, recoil, drain, secondary ç­‰ï¼‰
    // åŒæ—¶æ·»åŠ æ ‡å‡†åŒ–å­—æ®µä¾› API è°ƒç”¨
    // === åŠ¨æ€å¨åŠ›æŠ€èƒ½è¡¥ä¸ ===
    // è¿™äº›æŠ€èƒ½çš„ basePower åœ¨åŸæ•°æ®ä¸­æ˜¯ 0 æˆ– nullï¼ˆéœ€è¦è¿è¡Œæ—¶è®¡ç®—ï¼‰ï¼Œç»™å®ƒä»¬å›ºå®šå¨åŠ›
    const dynamicPowerPatches = {
        'gyroball': 80,         // é™€èºçƒï¼šé€Ÿåº¦å·®è®¡ç®—ï¼Œå¹³å‡çº¦80
        'electroball': 80,      // ç”µçƒï¼šé€Ÿåº¦å·®è®¡ç®—
        'grassknot': 80,        // æ‰“è‰ç»“ï¼šä½“é‡è®¡ç®—
        'lowkick': 80,          // è¸¢å€’ï¼šä½“é‡è®¡ç®—
        'heatcrash': 80,        // é«˜æ¸©é‡å‹ï¼šä½“é‡è®¡ç®—
        'heavyslam': 80,        // é‡ç£…å†²æ’ï¼šä½“é‡è®¡ç®—
        'fling': 50,            // æŠ•æ·ï¼šé“å…·å¨åŠ›
        'return': 102,          // æŠ¥æ©ï¼šæ»¡äº²å¯†åº¦
        'frustration': 102,     // è¿æ€’ï¼šæ»¡ä¸äº²å¯†
        'punishment': 70,       // æƒ©ç½šï¼šèƒ½åŠ›å˜åŒ–
        'storedpower': 80,      // è¾…åŠ©åŠ›é‡ï¼šèƒ½åŠ›å˜åŒ–
        'reversal': 100,        // ç»å¤„é€¢ç”Ÿï¼šä½è¡€é«˜å¨åŠ›
        'flail': 100,           // æŒ£æ‰ï¼šä½è¡€é«˜å¨åŠ›
        'eruption': 150,        // å–·ç«ï¼šæ»¡è¡€å¨åŠ›
        'waterspout': 150,      // å–·æ°´ï¼šæ»¡è¡€å¨åŠ›
        'crushgrip': 100,       // æ¡ç¢ï¼šå¯¹æ–¹è¡€é‡
        'wringout': 100,        // ç»ç´§ï¼šå¯¹æ–¹è¡€é‡
        'naturalgift': 80,      // è‡ªç„¶ä¹‹æ©ï¼šæ ‘æœ
        'trumpcard': 80,        // ç‹ç‰Œï¼šPP
        'spitup': 100,          // å–·å‡ºï¼šè“„åŠ›æ¬¡æ•°
        'present': 60,          // ç¤¼ç‰©ï¼šéšæœº
        'magnitude': 70,        // éœ‡çº§ï¼šéšæœº
    };
    let finalPower = data.basePower || 0;
    const moveId = id.toLowerCase();
    if (dynamicPowerPatches[moveId]) {
        finalPower = dynamicPowerPatches[moveId];
    }
    return {
        ...data, // ä¿ç•™æ‰€æœ‰é«˜çº§å±æ€§ï¼
        // æ ‡å‡†åŒ–å­—æ®µ
        name: data.name || name,
        type: data.type || 'Normal',
        power: finalPower,
        cat: data.category === 'Special' ? 'spec' : (data.category === 'Physical' ? 'phys' : 'status'),
        accuracy: (data.accuracy === true) ? true : (data.accuracy === undefined ? 100 : data.accuracy)
    };
}
/**
 * è®¡ç®—èƒ½åŠ›å€¼ (æ”¯æŒæ–°ç‰ˆ stats_meta æ ¼å¼)
 * 
 * @param {object} baseStats - { hp, atk, def, spa, spd, spe }
 * @param {number} level - ç­‰çº§
 * @param {object} options - å¯é€‰å‚æ•°
 * @param {object} options.ivs - ä¸ªä½“å€¼å¯¹è±¡ { hp, atk, def, spa, spd, spe }ï¼Œé»˜è®¤å…¨31
 * @param {number} options.ev_level - ç»Ÿä¸€åŠªåŠ›å€¼ç­‰çº§ (0~252)ï¼Œä¼šåŒæ—¶åŠ åˆ°å…­é¡¹
 * @param {string} options.nature - æ€§æ ¼åç§°ï¼Œç”¨äºä¿®æ­£èƒ½åŠ›å€¼
 * @returns {object} è®¡ç®—åçš„èƒ½åŠ›å€¼ { hp, atk, def, spa, spd, spe }
 */
export function calcStats(baseStats, level, options = {}) {
    // å…¼å®¹æ—§ç‰ˆè°ƒç”¨: calcStats(baseStats, level, iv, ev)
    let ivs, evs, nature;
    if (typeof options === 'number') {
        // æ—§ç‰ˆè°ƒç”¨æ–¹å¼
        const oldIv = options;
        const oldEv = arguments[3] || 0;
        ivs = { hp: oldIv, atk: oldIv, def: oldIv, spa: oldIv, spd: oldIv, spe: oldIv };
        evs = { hp: oldEv, atk: oldEv, def: oldEv, spa: oldEv, spd: oldEv, spe: oldEv };
        nature = null;
    } else {
        // æ–°ç‰ˆè°ƒç”¨æ–¹å¼
        ivs = options.ivs || { hp: 31, atk: 31, def: 31, spa: 31, spd: 31, spe: 31 };
        // æ”¯æŒä¸‰ç§ ev_level æ ¼å¼ï¼š
        // 1. æ•°å­— (ç»Ÿä¸€å€¼): 252 -> æ‰€æœ‰é¡¹éƒ½æ˜¯ 252
        // 2. æ•°ç»„ [HP, Atk, Def, SpA, SpD, Spe]: [252, 0, 0, 252, 6, 0]
        // 3. å¯¹è±¡ { hp, atk, def, spa, spd, spe }
        const evInput = options.ev_level;
        if (Array.isArray(evInput)) {
            // æ•°ç»„æ ¼å¼: [HP, Atk, Def, SpA, SpD, Spe]
            evs = {
                hp: evInput[0] || 0,
                atk: evInput[1] || 0,
                def: evInput[2] || 0,
                spa: evInput[3] || 0,
                spd: evInput[4] || 0,
                spe: evInput[5] || 0
            };
        } else if (typeof evInput === 'object' && evInput !== null) {
            // å¯¹è±¡æ ¼å¼
            evs = evInput;
        } else {
            // æ•°å­—æ ¼å¼ (ç»Ÿä¸€å€¼)
            const evLevel = evInput !== undefined ? evInput : 0;
            evs = { hp: evLevel, atk: evLevel, def: evLevel, spa: evLevel, spd: evLevel, spe: evLevel };
        }
        nature = options.nature || null;
    }
    // è·å–æ€§æ ¼ä¿®æ­£
    const natureMod = nature ? (NATURE_MODIFIERS[nature] || {}) : {};
    // HP è®¡ç®—å…¬å¼ï¼ˆHP ä¸å—æ€§æ ¼å½±å“ï¼‰
    const calcHP = (base, iv, ev) => {
        return Math.floor((2 * base + iv + ev / 4) * level / 100) + level + 10;
    };
    // å…¶ä»–èƒ½åŠ›è®¡ç®—å…¬å¼ï¼ˆå—æ€§æ ¼å½±å“ï¼‰
    const calcOther = (base, iv, ev, statName) => {
        let val = Math.floor(((2 * base + iv + ev / 4) * level / 100 + 5));
        // åº”ç”¨æ€§æ ¼ä¿®æ­£
        if (natureMod[statName]) {
            val = Math.floor(val * natureMod[statName]);
        }
        return val;
    };
    return {
        hp: calcHP(baseStats.hp, ivs.hp || 31, evs.hp || 0),
        atk: calcOther(baseStats.atk, ivs.atk || 31, evs.atk || 0, 'atk'),
        def: calcOther(baseStats.def, ivs.def || 31, evs.def || 0, 'def'),
        spa: calcOther(baseStats.spa, ivs.spa || 31, evs.spa || 0, 'spa'),
        spd: calcOther(baseStats.spd, ivs.spd || 31, evs.spd || 0, 'spd'),
        spe: calcOther(baseStats.spe, ivs.spe || 31, evs.spe || 0, 'spe')
    };
}
/**
 * Pokemon æˆ˜æ–—å®ä¾‹
 * ä» Pokemon Showdown POKEDEX æŸ¥è¡¨åˆ›å»ºï¼Œè‡ªåŠ¨è®¡ç®—èƒ½åŠ›å€¼
 * 
 * æ”¯æŒä¸¤ç§æ„é€ æ–¹å¼ï¼š
 * 1. æ—§ç‰ˆï¼šnew Pokemon(name, level, moves)
 * 2. æ–°ç‰ˆï¼šnew Pokemon(config) å…¶ä¸­ config åŒ…å«å®Œæ•´çš„ stats_meta
 */
export class Pokemon {
    constructor(nameOrConfig, level, moveNames = []) {
        // æ£€æµ‹æ˜¯å¦ä¸ºæ–°ç‰ˆé…ç½®å¯¹è±¡æ ¼å¼
        if (typeof nameOrConfig === 'object' && nameOrConfig !== null && nameOrConfig.name) {
            this._initFromConfig(nameOrConfig);
        } else {
            // æ—§ç‰ˆæ„é€ æ–¹å¼
            const name = nameOrConfig;
            const data = getPokemonData(name);
            if (!data) {
                console.warn(`Pokemon "${name}" not found in POKEDEX, using Pikachu`);
                const fallback = getPokemonData('Pikachu') || {
                    name: 'Pikachu', types: ['Electric'],
                    baseStats: { hp: 35, atk: 55, def: 40, spa: 50, spd: 50, spe: 90 }
                };
                this._initLegacy('Pikachu', fallback.types, fallback.baseStats, level, moveNames);
            } else {
                this._initLegacy(name, data.types, data.baseStats, level, moveNames);
            }
        }
    }
    /**
     * æ–°ç‰ˆåˆå§‹åŒ–ï¼šä»å®Œæ•´é…ç½®å¯¹è±¡åˆ›å»º
     * @param {object} config - åŒ…å« name, lv, moves, gender, nature, ability, stats_meta ç­‰
     */
    _initFromConfig(config) {
        const name = config.name;
        const level = config.lv || config.level || 50;
        const moveNames = config.moves || [];
        const data = getPokemonData(name);
        if (!data) {
            console.warn(`Pokemon "${name}" not found in POKEDEX, using Pikachu`);
            const fallback = getPokemonData('Pikachu') || {
                name: 'Pikachu', types: ['Electric'],
                baseStats: { hp: 35, atk: 55, def: 40, spa: 50, spd: 50, spe: 90 }
            };
            this._initCore('Pikachu', fallback.types, fallback.baseStats, level, moveNames, config);
        } else {
            this._initCore(name, data.types, data.baseStats, level, moveNames, config);
        }
    }
    /**
     * æ—§ç‰ˆåˆå§‹åŒ–ï¼šå…¼å®¹æ—§çš„æ„é€ æ–¹å¼
     */
    _initLegacy(name, types, baseStats, level, moveNames) {
        this._initCore(name, types, baseStats, level, moveNames, {});
    }
    /**
     * æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘
     * @param {string} name - å®å¯æ¢¦åç§°
     * @param {string[]} types - å±æ€§æ•°ç»„
     * @param {object} baseStats - ç§æ—å€¼
     * @param {number} level - ç­‰çº§
     * @param {string[]} moveNames - æŠ€èƒ½åç§°æ•°ç»„
     * @param {object} config - é¢å¤–é…ç½® (gender, nature, ability, stats_meta, shiny ç­‰)
     */
    _initCore(name, types, baseStats, level, moveNames, config = {}) {
        this.name = name;
        // ä½¿ç”¨å¢å¼ºç‰ˆ Locale å·¥å…·è·å–ä¸­æ–‡åï¼ˆæ”¯æŒæ™ºèƒ½åç¼€è§£æï¼‰
        if (typeof window !== 'undefined' && window.Locale) {
            // Locale.get ç°åœ¨ä¼šè‡ªåŠ¨å¤„ç† "Zoroark-Hisui" -> "ç´¢ç½—äºšå…‹-æ´—ç¿ " è¿™ç±»è½¬æ¢
            this.cnName = window.Locale.get(name);
        } else {
            this.cnName = name;
        }
        this.types = types;
        this.baseStats = baseStats;
        this.level = level;
        // === æ–°å¢å±æ€§ï¼šæ€§åˆ«ã€æ€§æ ¼ã€ç‰¹æ€§ã€é—ªå…‰ ===
        this.gender = config.gender || null; // 'M', 'F', or null
        this.nature = config.nature || null; // æ€§æ ¼åç§°
        this.shiny = config.shiny || false;  // æ˜¯å¦é—ªå…‰
        // ç‰¹æ€§å¤„ç†ï¼šä¼˜å…ˆä½¿ç”¨é…ç½®ä¸­çš„ç‰¹æ€§ï¼Œå¦åˆ™ä» POKEDEX è·å–é»˜è®¤ç‰¹æ€§
        if (config.ability) {
            this.ability = config.ability;
        } else {
            // ä» POKEDEX è·å–é»˜è®¤ç‰¹æ€§ (ä½¿ç”¨è§„èŒƒåŒ–åç§°)
            const normalizedId = normalizePokemonName(name).toLowerCase().replace(/[^a-z0-9]/g, '');
            const pokeData = typeof POKEDEX !== 'undefined' ? POKEDEX[normalizedId] : null;
            if (pokeData && pokeData.abilities) {
                this.ability = pokeData.abilities['0'] || null;
            } else {
                this.ability = null;
            }
        }
        // === èƒ½åŠ›å€¼è®¡ç®— ===
        // ä¼˜å…ˆä½¿ç”¨ stats_meta ä¸­çš„å®Œæ•´æ•°æ®
        const statsMeta = config.stats_meta || {};
        let ivs, evLevel;
        if (statsMeta.ivs || statsMeta.ev_level !== undefined) {
            // æ–°ç‰ˆæ ¼å¼ï¼šä½¿ç”¨ stats_meta
            ivs = statsMeta.ivs || { hp: 31, atk: 31, def: 31, spa: 31, spd: 31, spe: 31 };
            evLevel = statsMeta.ev_level !== undefined ? statsMeta.ev_level : 0;
        } else {
            // æ—§ç‰ˆå…¼å®¹ï¼šåŠ¨æ€ EV è®¡ç®—é€»è¾‘
            // ç­‰çº§è¶Šé«˜ï¼Œç»å†çš„æˆ˜æ–—è¶Šå¤šï¼Œç§¯ç´¯çš„åŠªåŠ›å€¼å°±è¶Šé«˜
            // å…¬å¼ï¼šæ¯çº§ç»™ 1.5 çš„å•é¡¹ EVï¼Œä¸Šé™ 85 (6é¡¹ x 85 = 510 æ€»é‡)
            ivs = { hp: 31, atk: 31, def: 31, spa: 31, spd: 31, spe: 31 };
            evLevel = Math.min(85, Math.floor(level * 1.5));
        }
        // ä¿å­˜åŸå§‹æ•°æ®ä»¥ä¾¿åç»­æŸ¥çœ‹/å¯¼å‡º
        this.statsMeta = {
            ivs: ivs,
            ev_level: evLevel
        };
        // è®¡ç®—èƒ½åŠ›å€¼
        const stats = calcStats(baseStats, level, {
            ivs: ivs,
            ev_level: evLevel,
            nature: this.nature
        });
        // === ã€è„±å£³å¿è€… Shedinja ç‰¹åˆ¤ã€‘HP å¼ºåˆ¶ä¸º 1 ===
        const speciesId = (this.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        if (speciesId === 'shedinja') {
            this.maxHp = 1;
            this.currHp = 1;
            console.log(`[SHEDINJA] ${this.cnName} çš„ HP å¼ºåˆ¶è®¾ä¸º 1`);
        } else {
            this.maxHp = stats.hp;
            this.currHp = stats.hp;
        }
        this.atk = stats.atk;
        this.def = stats.def;
        this.spa = stats.spa;
        this.spd = stats.spd;
        this.spe = stats.spe;
        // === æˆ˜åœºèƒ½åŠ›å¢ç›Šç­‰çº§ (Stages) ===
        // èŒƒå›´ -6 åˆ° +6, é»˜è®¤ 0
        this.boosts = {
            atk: 0, def: 0, spa: 0, spd: 0, spe: 0,
            accuracy: 0, evasion: 0
        };
        // === ä¸Šåœºå›åˆæ•° (ç”¨äº Fake Out ç­‰é¦–å›åˆé™åˆ¶æŠ€èƒ½) ===
        this.turnsOnField = 0;
        // === æŠ€èƒ½ä½¿ç”¨è¿½è¸ª (ç”¨äºè¿ç»­ä½¿ç”¨é™åˆ¶) ===
        this.lastMoveUsed = null;       // ä¸Šå›åˆä½¿ç”¨çš„æŠ€èƒ½åç§°
        this.protectCounter = 0;        // è¿ç»­ä½¿ç”¨å®ˆä½ç±»æŠ€èƒ½çš„æ¬¡æ•°
        this.mustRecharge = false;      // æ˜¯å¦éœ€è¦è“„åŠ›/åƒµç›´ï¼ˆç ´åå…‰çº¿ç­‰ï¼‰
        // === çŠ¶æ€å¼‚å¸¸ç³»ç»Ÿ ===
        this.status = null;      // ä¸»è¦çŠ¶æ€: 'slp', 'par', 'brn', 'psn', 'tox', 'frz'
        this.volatile = {};      // ä¸´æ—¶çŠ¶æ€: { flinch: true, confusion: true }
        this.sleepTurns = 0;     // ç¡çœ å‰©ä½™å›åˆæ•°
        // =====================================================
        // === æƒ…æ„ŸåŠªåŠ›å€¼ (Affective Values - AVs) ===
        // === æ´›è¿ªäºšç‰¹åŒº (Rhodia Region) ä¸“å±ç³»ç»Ÿ ===
        // =====================================================
        // å—ç¥é¦”ç²‰é›¾ (Ambrosia) å½±å“ï¼Œå®å¯æ¢¦ä¸è®­ç»ƒå®¶çš„çµé­‚é“¾æ¥äº§ç”Ÿçš„åŠ ç‚¹
        // æ¯ä¸ªç»´åº¦ 0~255ï¼Œç±»ä¼¼ä¼ ç»Ÿ EVs ä½†å½±å“æˆ˜æ–—æœºåˆ¶è€Œéæ•°å€¼
        // æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
        // 1. æ‰å¹³æ ¼å¼: { avs: { trust, passion, insight, devotion } }
        // 2. åµŒå¥—æ ¼å¼: { friendship: { avs: { trust, passion, insight, devotion } } }
        let avsConfig = config.avs || {};
        if (config.friendship) {
            // åµŒå¥—æ ¼å¼: friendship.avs
            if (config.friendship.avs) {
                avsConfig = config.friendship.avs;
            } else {
                // æ—§æ‰å¹³æ ¼å¼: friendship ç›´æ¥åŒ…å« trust/passion ç­‰
                avsConfig = config.friendship;
            }
        }
        // ã€è§£é”ç³»ç»Ÿã€‘enable_insight æ§åˆ¶ AVs ä¸Šé™
        // æœªè§£é”ï¼šä¸Šé™ 155
        // å·²è§£é”ï¼šä¸Šé™ 255
        // æ³¨æ„ï¼šè¿™é‡Œåªå­˜å‚¨åŸå§‹å€¼ï¼Œå®é™…æ•ˆæœè®¡ç®—æ—¶ä¼šæ ¹æ® enable_insight åŠ¨æ€è°ƒæ•´
        this.avs = {
            trust: avsConfig.trust || 0,       // ä¿¡èµ–ï¼šé˜²å®ˆå‘ï¼Œè‡´å‘½ä¼¤å®³æ—¶é”è¡€
            passion: avsConfig.passion || 0,   // æ¿€æƒ…ï¼šè¿›æ”»å‘ï¼Œæš´å‡»ç‡æå‡
            insight: avsConfig.insight || 0,   // çµçŠ€ï¼šå›é¿å‘ï¼Œé—ªé¿ç‡æå‡
            devotion: avsConfig.devotion || 0  // çŒ®èº«ï¼šå›å¤å‘ï¼Œå›åˆæœ«æ²»æ„ˆå¼‚å¸¸
        };
        console.log(`[AVS] ${this.name} loaded AVs (raw):`, this.avs);
        // çµé­‚ä¼™ä¼´æ ‡è®° (isAce) å’Œ Second Wind æœºåˆ¶
        this.isAce = config.isAce || false;
        this.hasSecondWind = config.hasSecondWind || false;
        // é¦–å‘æ ‡è®° (isLead) - æ ‡è®°è¯¥å®å¯æ¢¦æ˜¯å¦ä¸ºé¦–å‘å‡ºæˆ˜
        this.isLead = config.isLead || false;
        // === äº’æ–¥æœºåˆ¶ç³»ç»Ÿ (Mechanic Lock) ===
        // mechanic: 'mega' | 'dynamax' | 'zmove' | 'tera' | undefined
        this.mechanic = config.mechanic || null;
        // === æå·¨åŒ– (Dynamax) ç³»ç»Ÿ ===
        // canDynamax: æ˜¯å¦å¯ä»¥æå·¨åŒ–
        // å¦‚æœ mechanic === 'dynamax'ï¼Œè‡ªåŠ¨å¯ç”¨æå·¨åŒ–èƒ½åŠ›
        this.canDynamax = config.canDynamax || (this.mechanic === 'dynamax');
        this.isDynamaxed = false;      // å½“å‰æ˜¯å¦å¤„äºæå·¨åŒ–çŠ¶æ€
        this.dynamaxTurns = 0;         // æå·¨åŒ–å‰©ä½™å›åˆæ•°
        this.dynamax_moves = config.dynamax_moves || null; // æå·¨åŒ–æ—¶çš„æ‹›å¼åˆ—è¡¨
        // === Mega è¿›åŒ–ç›®æ ‡ ===
        // æ”¯æŒ mega_target æˆ– mega å­—æ®µï¼ˆç”¨äº G-Max å½¢æ€ç­‰ï¼‰
        // æ³¨æ„ï¼šè¿™é‡Œåªè®¾ç½® megaTargetIdï¼ŒcanMegaEvolve ç”± autoDetectMegaEligibility å¤„ç†
        const megaTarget = config.mega_target || config.mega;
        if (megaTarget) {
            this.megaTargetId = megaTarget;
            // ã€ä¿®å¤ã€‘åªæœ‰å½“ mechanic ä¸æ˜¯ 'mega' æ—¶ï¼Œæ‰æ ¹æ® gmax è®¾ç½® canDynamax
            // mechanic å­—æ®µæ˜¯æœ€é«˜æƒå¨ï¼Œä¸åº”è¢« mega_target åŠ«æŒ
            if (megaTarget.includes('gmax') && this.mechanic !== 'mega') {
                this.canDynamax = true;
            }
        }
        // === Z æ‹›å¼é…ç½® ===
        // z_move_config: { base_move, target_move, is_unique, trigger_text }
        this.z_move_config = config.z_move_config || null;
        // === å¤ªæ™¶åŒ– (Terastallization) ç³»ç»Ÿ ===
        // teraType: å¤ªæ™¶åŒ–åçš„å±æ€§ (é¢„è®¾å‹)
        // å¦‚æœæ²¡é…ç½®ï¼Œé»˜è®¤ fallback åˆ°ç¬¬ä¸€å±æ€§
        this.teraType = config.tera_type || config.teraType || this.types[0] || 'Normal';
        this.isTerastallized = false;       // å½“å‰æ˜¯å¦å¤„äºå¤ªæ™¶åŒ–çŠ¶æ€
        this.originalTypes = [...this.types]; // ä¿å­˜åŸå§‹å±æ€§ (ç”¨äº STAB å›æº¯)
        // canTera: æ˜¯å¦å¯ä»¥å¤ªæ™¶åŒ– (ç”± mechanic å†³å®š)
        this.canTera = (this.mechanic === 'tera');
        // === é“å…· ===
        this.item = config.item || null;
        // è°ƒè¯•æ—¥å¿—ï¼šç¡®è®¤æ–°å­—æ®µæ˜¯å¦æ­£ç¡®è§£æ
        if (this.mechanic || this.z_move_config || this.dynamax_moves || this.canDynamax || this.canTera) {
            console.log(`[MECHANIC] ${this.name} initialized with:`, {
                mechanic: this.mechanic,
                canDynamax: this.canDynamax,
                canTera: this.canTera,
                teraType: this.teraType,
                megaTargetId: this.megaTargetId,
                z_move_config: this.z_move_config,
                dynamax_moves: this.dynamax_moves,
                item: this.item
            });
        }
        // AVs è§¦å‘è®°å½•ï¼ˆæ¯åœºæˆ˜æ–—åªè§¦å‘ä¸€æ¬¡çš„æ•ˆæœï¼‰
        this.avsTriggered = {
            trustEndure: false,  // Trust é”è¡€æ˜¯å¦å·²è§¦å‘
            passionKill: false   // Passion å‡»æ€åŠ æˆæ˜¯å¦å·²è§¦å‘
        };
        const safeMoves = Array.isArray(moveNames) ? moveNames : [];
        this.moves = safeMoves.map(mn => {
            const id = (mn || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const rawData = typeof MOVES !== 'undefined' ? MOVES[id] : null;
            let md = getMoveData(mn);
            if (!rawData) {
                const randomFallback = FALLBACK_MOVES[Math.floor(Math.random() * FALLBACK_MOVES.length)];
                md = getMoveData(randomFallback);
            }
            // ä½¿ç”¨ Locale å·¥å…·è·å–æŠ€èƒ½ä¸­æ–‡å
            const cnName = (typeof window !== 'undefined' && window.Locale) ? window.Locale.get(md.name) : md.name;
            // ã€ä¿®å¤ã€‘ä¿ç•™ target å­—æ®µï¼Œç”¨äºç²¾ç¥åœºåœ°ç­‰æœºåˆ¶åˆ¤æ–­æ‹›å¼ç›®æ ‡ç±»å‹
            return { 
                name: md.name, 
                cn: cnName, 
                type: md.type, 
                power: md.power || 0, 
                cat: md.cat || 'phys',
                target: md.target || 'normal',  // ã€å…³é”®ã€‘ä¿ç•™ç›®æ ‡ç±»å‹
                priority: md.priority || 0      // ã€å…³é”®ã€‘ä¿ç•™ä¼˜å…ˆåº¦
            };
        });
        // å¦‚æœæ²¡ç»™æŠ€èƒ½æˆ–è¿‡æ»¤åä¸ºç©ºï¼Œç»™ä¸ªé»˜è®¤çš„
        if (this.moves.length === 0) {
            const tackleCN = (typeof window !== 'undefined' && window.Locale) ? window.Locale.get('Tackle') : 'Tackle';
            this.moves = [{ name: 'Tackle', cn: tackleCN, type: 'Normal', power: 40, cat: 'phys' }];
        }
    }
    /**
     * è·å–æœ‰æ•ˆ AVs å€¼ï¼ˆè€ƒè™‘ enable_insight / enable_styles è§£é”é™åˆ¶ï¼‰
     * @param {string} stat - AVs å±æ€§å: 'trust', 'passion', 'insight', 'devotion'
     * @returns {number} æœ‰æ•ˆçš„ AVs å€¼
     */
    getEffectiveAVs(stat) {
        // ã€å…¨å±€å¼€å…³ã€‘AVS ç³»ç»Ÿå…³é—­æ—¶è¿”å› 0
        if (typeof window !== 'undefined' && window.GAME_SETTINGS && !window.GAME_SETTINGS.enableAVS) {
            return 0;
        }
        if (!this.avs || !this.avs[stat]) return 0;
        const rawValue = this.avs[stat];
        // è·å–è§£é”çŠ¶æ€ï¼ˆåŒºåˆ†ç©å®¶å’Œæ•Œæ–¹ï¼‰
        // é€šè¿‡æ£€æŸ¥å½“å‰å®å¯æ¢¦æ˜¯å¦åœ¨ç©å®¶é˜Ÿä¼ä¸­æ¥åˆ¤æ–­
        let insightUnlocked = false;
        if (typeof battle !== 'undefined') {
            const isPlayerPokemon = battle.playerParty && battle.playerParty.includes(this);
            if (isPlayerPokemon) {
                // ç©å®¶å®å¯æ¢¦ï¼šæ£€æŸ¥ playerUnlocks
                const unlocks = battle.playerUnlocks || {};
                insightUnlocked = unlocks.enable_insight === true || unlocks.enable_styles === true;
            } else {
                // æ•Œæ–¹å®å¯æ¢¦ï¼šæ£€æŸ¥ enemyUnlocks
                const unlocks = battle.enemyUnlocks || {};
                insightUnlocked = unlocks.enable_insight === true || unlocks.enable_styles === true;
            }
        }
        // æœªè§£é”ï¼šä¸Šé™ 155
        // å·²è§£é”ï¼šä¸Šé™ 255ï¼Œä¸”åœ¨ 255 æ—¶æœ‰é¢å¤–åŠ æˆï¼ˆé€šè¿‡ avsEvolutionBoost æˆ–å…¶ä»–æœºåˆ¶ï¼‰
        const cap = insightUnlocked ? 255 : 155;
        const cappedValue = Math.min(rawValue, cap);
        // å¦‚æœå·²è§£é”ä¸”è¾¾åˆ°æ»¡å€¼ 255ï¼Œç»™äºˆ 1.1x åŠ æˆ
        if (insightUnlocked && rawValue >= 255) {
            return Math.floor(cappedValue * 1.1);
        }
        return cappedValue;
    }
    // è·å–ç²¾çµå›¾ URL
    getSprite(isBack = false) {
        // éå®˜æ–¹ Megaï¼šè¿”å›åŸºç¡€å½¢æ€çš„å›¾ç‰‡ URL
        if (this.isUnofficialMega && this.megaTargetId) {
            const baseSpecies = this.megaTargetId.replace(/mega.*$/i, '');
            const folder = isBack ? 'ani-back' : 'ani';
            return `https://play.pokemonshowdown.com/sprites/${folder}/${baseSpecies}.gif`;
        }
        const id = resolveSpriteId(this.name);
        let folder = isBack ? 'ani-back' : 'ani';
        // Mega å½¢æ€å¼ºåˆ¶ä½¿ç”¨æ™®é€šè‰²ï¼ˆé¿å…å¼‚è‰² Mega èµ„æºç¼ºå¤±ï¼‰
        const isMegaForm = /mega|primal/i.test(this.name);
        if (this.shiny && !isMegaForm) {
            folder += '-shiny';
        }
        return `https://play.pokemonshowdown.com/sprites/${folder}/${id}.gif`;
    }
    // è·å–å›é€€ç²¾çµå›¾ URLï¼ˆåŸºç¡€å½¢æ€ï¼‰
    getFallbackSprite(isBack = false) {
        const id = getFallbackSpriteId(this.name);
        let folder = isBack ? 'ani-back' : 'ani';
        // Mega å½¢æ€å¼ºåˆ¶ä½¿ç”¨æ™®é€šè‰²ï¼ˆé¿å…å¼‚è‰² Mega èµ„æºç¼ºå¤±ï¼‰
        const isMegaForm = /mega|primal/i.test(this.name);
        if (this.shiny && !isMegaForm) {
            folder += '-shiny';
        }
        return `https://play.pokemonshowdown.com/sprites/${folder}/${id}.gif`;
    }
    // æ˜¯å¦å­˜æ´»
    isAlive() {
        return this.currHp > 0;
    }
    // å—ä¼¤
    // @param {number} dmg - ä¼¤å®³å€¼
    // @param {string} category - ä¼¤å®³ç±»å‹ ('physical'/'special'/null)ï¼Œç”¨äº Counter/Mirror Coat
    takeDamage(dmg, category = null) {
        // === è®°å½•æœ¬å›åˆå—åˆ°çš„ä¼¤å®³ï¼ˆç”¨äº Counter/Mirror Coatï¼‰===
        if (!this.turnData) this.turnData = {};
        if (dmg > 0 && category) {
            this.turnData.lastDamageTaken = {
                amount: dmg,
                category: category.toLowerCase()
            };
        }
        // Focus Sash (æ°”åŠ¿æŠ«å¸¦): æ»¡è¡€æ—¶ï¼Œè‡´å‘½ä¼¤å®³åªä¼šè®© HP å‰© 1
        // ä½¿ç”¨ items-data.js çš„ ItemEffects å¤„ç†å™¨
        if (typeof ItemEffects !== 'undefined' && ItemEffects.checkFocusSash) {
            if (ItemEffects.checkFocusSash(this, dmg)) {
                console.log(`[ITEM] ${this.cnName} çš„æ°”åŠ¿æŠ«å¸¦å‘åŠ¨äº†ï¼`);
                return; // ä¸æ‰§è¡Œåç»­æ‰£è¡€
            }
        } else {
            // Fallback: å…¼å®¹æ—§é€»è¾‘
            const itemName = (this.item || '').toLowerCase().replace(/[^a-z]/g, '');
            if (itemName === 'focussash' && this.currHp === this.maxHp && dmg >= this.currHp) {
                this.currHp = 1;
                this.item = null;
                this.focusSashTriggered = true;
                console.log(`[ITEM] ${this.cnName} çš„æ°”åŠ¿æŠ«å¸¦å‘åŠ¨äº†ï¼`);
                return;
            }
        }
        // =====================================================
        // === AVs: Trust (ä¿¡èµ–) - Sync Guard é”è¡€æ•ˆæœ ===
        // =====================================================
        // ã€çº¿æ€§æœºåˆ¶ã€‘æ¦‚ç‡ = (effectiveTrust / 255) * 0.50
        // æ»¡å€¼ 255 æ—¶çº¦ 50% æ¦‚ç‡ï¼Œ100 æ—¶çº¦ 20% æ¦‚ç‡
        // æ¯åªå®å¯æ¢¦æ¯åœºæˆ˜æ–—åªèƒ½è§¦å‘ä¸€æ¬¡
        // åªæœ‰ isAce=true çš„å®å¯æ¢¦æ‰èƒ½è§¦å‘ AVs è¢«åŠ¨
        // ã€Ambrosiaã€‘ç¥ä¹‹ç¼æµ†å¤©æ°”ä¸‹ AVS è§¦å‘ç‡ x2
        if (this.isAce && this.avs && dmg >= this.currHp && !this.avsTriggered?.trustEndure) {
            const baseTrust = this.getEffectiveAVs('trust');
            // ã€å…¨å±€å¼€å…³ã€‘AVS å…³é—­æ—¶ getEffectiveAVs è¿”å› 0ï¼Œè·³è¿‡è®¡ç®—
            if (baseTrust > 0) {
                const effectiveTrust = this.avsEvolutionBoost ? baseTrust * 2 : baseTrust;
                // çº¿æ€§æ¦‚ç‡ï¼šæ»¡å€¼ 50%ï¼Œæ— ä¿åº•ï¼ˆä½ AVS å°±æ˜¯ä½æ¦‚ç‡ï¼‰
                // Trust 60 â†’ 11.76%, Trust 100 â†’ 19.6%, Trust 255 â†’ 50%
                let triggerChance = (effectiveTrust / 255) * 0.50;
                // ã€Ambrosia ç¥ä¹‹ç¼æµ†ã€‘AVS è§¦å‘ç‡ x2
                if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.getAVSMultiplier) {
                    const currentWeather = window.battle?.weather || '';
                    const avsMultiplier = window.WeatherEffects.getAVSMultiplier(currentWeather);
                    if (avsMultiplier > 1) {
                        triggerChance *= avsMultiplier;
                        console.log(`[AMBROSIA] ğŸ’« ç¥ä¹‹ç¼æµ†ï¼šTrust è§¦å‘ç‡ x${avsMultiplier}`);
                    }
                }
                triggerChance = Math.min(triggerChance, 1.0); // ä¸Šé™ 100%
                if (Math.random() < triggerChance) {
                    this.currHp = 1;
                    this.avsTriggered.trustEndure = true; // æ¯åœºæˆ˜æ–—åªèƒ½è§¦å‘ä¸€æ¬¡
                    this.trustEndureTriggered = true; // æ ‡è®°ç”¨äºæ—¥å¿—
                    console.log(`[AVs] ${this.cnName} çš„ Trust å®ˆæŠ¤å‘åŠ¨ï¼(Chance: ${Math.round(triggerChance * 100)}%, Trust: ${baseTrust}${this.avsEvolutionBoost ? ' x2' : ''})`);
                    return; // ä¸æ‰§è¡Œåç»­æ‰£è¡€
                }
            }
        }
        // =====================================================
        // === Second Wind (ç¬¬äºŒæ°”æ¯) - æè¯£åŒº Boss ä¸“å± ===
        // =====================================================
        // ç‹ç‰Œå®å¯æ¢¦é¦–æ¬¡è¡€æ¡å½’é›¶æ—¶ï¼šé” 1 HP + å…¨å±æ€§ +1
        // åªæœ‰æ ‡è®°äº† hasSecondWind çš„å®å¯æ¢¦æ‰èƒ½è§¦å‘
        if (this.hasSecondWind && dmg >= this.currHp && !this.secondWindTriggered) {
            this.currHp = 1;
            this.secondWindTriggered = true;
            this.secondWindActivated = true; // æ ‡è®°ç”¨äºæ—¥å¿—å’ŒåŠ¨ç”»
            // å…¨å±æ€§ +1
            this.applyBoost('atk', 1);
            this.applyBoost('def', 1);
            this.applyBoost('spa', 1);
            this.applyBoost('spd', 1);
            this.applyBoost('spe', 1);
            console.log(`[Second Wind] ${this.cnName} çš„ç¬¬äºŒæ°”æ¯å‘åŠ¨äº†ï¼å…¨å±æ€§ +1ï¼`);
            return; // ä¸æ‰§è¡Œåç»­æ‰£è¡€
        }
        // =====================================================
        // === ã€æˆ˜æœ¯æŒ‡æŒ¥ã€‘ENDURE! æŒ‡ä»¤ - æ¦‚ç‡æŒºä½ ===
        // =====================================================
        // åŸºç¡€ 50% + Trust AVS 50%ï¼ˆæ»¡å€¼æ—¶ 100%ï¼‰
        if (this.commandEndureActive && dmg >= this.currHp) {
            let endureChance = 0.50; // åŸºç¡€ 50%
            // Trust AVS åŠ æˆï¼šæ»¡å€¼ 255 æ—¶ +50%
            // ã€å…¨å±€å¼€å…³ã€‘ä½¿ç”¨ getEffectiveAVs æ£€æŸ¥æœ‰æ•ˆå€¼
            if (this.isAce && this.avs) {
                const baseTrust = this.getEffectiveAVs('trust');
                if (baseTrust > 0) {
                    const effectiveTrust = this.avsEvolutionBoost ? baseTrust * 2 : baseTrust;
                    const trustBonus = (Math.min(effectiveTrust, 255) / 255) * 0.50;
                    endureChance += trustBonus;
                    console.log(`[COMMANDER] ENDURE! Trust åŠ æˆ: +${(trustBonus * 100).toFixed(1)}% (Trust: ${baseTrust})`);
                }
            }
            endureChance = Math.min(endureChance, 1.0); // ä¸Šé™ 100%
            const roll = Math.random();
            console.log(`[COMMANDER] ENDURE! Roll: ${(roll * 100).toFixed(1)}% vs Chance: ${(endureChance * 100).toFixed(1)}%`);
            this.commandEndureActive = false; // ä½¿ç”¨åæ¶ˆè€—
            if (roll < endureChance) {
                this.currHp = 1;
                this.commandEndureTriggered = true; // æ ‡è®°ç”¨äºæ—¥å¿—
                console.log(`[COMMANDER] ENDURE! æŒ‡ä»¤æˆåŠŸï¼${this.cnName} åœ¨è®­ç»ƒå®¶çš„å‘¼å–Šä¸‹æ’‘ä½äº†ï¼`);
                return; // ä¸æ‰§è¡Œåç»­æ‰£è¡€
            } else {
                console.log(`[COMMANDER] ENDURE! æŒ‡ä»¤å¤±è´¥...${this.cnName} æ²¡èƒ½æ’‘ä½...`);
            }
        }
        // =====================================================
        // === Bond Endure (ç¾ç»ŠæŒºä½) - è¿›åŒ–æ‹¦æˆªå™¨ ===
        // =====================================================
        // å½“æ»¡è¶³è¿›åŒ–æ¡ä»¶æ—¶ï¼Œè‡´å‘½ä¼¤å®³ä¼šé”è¡€è‡³ 1 HP
        // æ¡ä»¶ï¼šisAce + æœ‰è¿›åŒ–å‹ + AVs è¾¾æ ‡ + ç­‰çº§åœ¨å®½å®¹èŒƒå›´å†… + æœ¬åœºæœªè¿›åŒ–è¿‡
        // è§¦å‘åç«‹å³æ˜¾ç¤º EVO æŒ‰é’®
        if (this.isAce && dmg >= this.currHp && !this.hasEvolvedThisBattle && !this.bondEndureTriggered) {
            const canBondEndure = this._checkBondEndureEligibility();
            if (canBondEndure) {
                this.currHp = 1;
                this.bondEndureTriggered = true;
                this.bondEndureActivated = true; // æ ‡è®°ç”¨äºæ—¥å¿—å’ŒåŠ¨ç”»
                console.log(`[Bond Endure] ${this.cnName} å› ä¸ºæƒ³å›åº”è®­ç»ƒå®¶çš„æœŸå¾…ï¼Œæ’‘ä½äº†ï¼`);
                return; // ä¸æ‰§è¡Œåç»­æ‰£è¡€
            }
        }
        this.currHp = Math.max(0, this.currHp - dmg);
    }
    /**
     * æ£€æŸ¥æ˜¯å¦æ»¡è¶³ç¾ç»ŠæŒºä½æ¡ä»¶ï¼ˆè¿›åŒ–æ‹¦æˆªï¼‰
     * ã€ä»…é™ç©å®¶ã€‘æ•Œäººä¸è§¦å‘æ­¤æœºåˆ¶
     * @returns {boolean}
     */
    _checkBondEndureEligibility() {
        // ã€å…¨å±€å¼€å…³ã€‘EVO ç³»ç»Ÿå…³é—­æ—¶ä¸è§¦å‘
        if (typeof window !== 'undefined' && window.GAME_SETTINGS && !window.GAME_SETTINGS.enableEVO) {
            return false;
        }
        // ã€ä»…é™ç©å®¶ã€‘æ•Œäººä¸è§¦å‘ Bond Endure
        if (typeof window !== 'undefined' && window.battle && window.battle.playerParty) {
            if (!window.battle.playerParty.includes(this)) return false;
        }
        if (!this.avs) return false;
        // è®¡ç®— AVs æ€»å’Œ
        const totalAVs = (this.getEffectiveAVs('trust') || 0) + 
                         (this.getEffectiveAVs('passion') || 0) + 
                         (this.getEffectiveAVs('insight') || 0) + 
                         (this.getEffectiveAVs('devotion') || 0);
        // è·å–å®å¯æ¢¦æ•°æ®
        const baseId = this.name.toLowerCase().replace(/[^a-z0-9]/g, '');
        const data = typeof POKEDEX !== 'undefined' ? POKEDEX[baseId] : null;
        if (!data) return false;
        // å¿…é¡»æœ‰è¿›åŒ–å‹
        if (!data.evos || data.evos.length === 0) return false;
        // å·² Mega æˆ–å·²å˜èº«çš„ä¸èƒ½è§¦å‘
        if (this.isMega || this.isTransformed) return false;
        // è·å–è¿›åŒ–å‹æ•°æ®
        const nextFormName = data.evos[0];
        const nextId = nextFormName.toLowerCase().replace(/[^a-z0-9]/g, '');
        const nextData = typeof POKEDEX !== 'undefined' ? POKEDEX[nextId] : null;
        if (!nextData) return false;
        // ã€ç‰¹æ®Šè¿›åŒ–æ£€æŸ¥ã€‘åªæœ‰ç­‰çº§è¿›åŒ–æˆ–äº²å¯†åº¦è¿›åŒ–æ‰èƒ½è§¦å‘æˆ˜æ–—EVO
        // é“å…·è¿›åŒ–(useItem)ã€äº¤æ¢è¿›åŒ–(trade)ã€ç‰¹æ®Šæ¡ä»¶è¿›åŒ–ç­‰ä¸è§¦å‘
        // ä¾‹å¦‚ï¼šä¼Šå¸ƒéœ€è¦é“å…·è¿›åŒ–ï¼Œä¸åº”è§¦å‘æˆ˜æ–—EVO
        const allowedEvoTypes = [undefined, 'levelFriendship'];
        if (!allowedEvoTypes.includes(nextData.evoType)) return false;
        // ç­‰çº§æ£€æŸ¥ï¼ˆå…è®¸è¶Šçº§3çº§ï¼‰
        const reqLevel = Math.max(1, (nextData.evoLevel || 1) - 3);
        if (this.level < reqLevel) return false;
        // AVs é˜ˆå€¼æ£€æŸ¥
        // ä¸€é˜¶(æ— prevo): 80
        // äºŒé˜¶(æœ‰prevo): 160
        // åªæœ‰ä¸€æ¬¡è¿›åŒ–(æœ‰prevoä½†è¿›åŒ–å‹æ— evos): 140
        const isFirstStage = !data.prevo;
        const nextHasEvos = nextData.evos && nextData.evos.length > 0;
        let reqAVs;
        if (isFirstStage) {
            reqAVs = 80;  // ä¸€é˜¶æ®µ
        } else if (!nextHasEvos) {
            reqAVs = 140; // åªæœ‰ä¸€æ¬¡å‡çº§ï¼ˆäºŒé˜¶è¿›åŒ–åˆ°æœ€ç»ˆå½¢æ€ï¼‰
        } else {
            reqAVs = 160; // äºŒé˜¶æ®µï¼ˆè¿˜èƒ½ç»§ç»­è¿›åŒ–ï¼‰
        }
        if (totalAVs < reqAVs) return false;
        console.log(`[Bond Endure Check] ${this.cnName}: AVs=${totalAVs}/${reqAVs}, Level=${this.level}/${reqLevel}, Target=${nextFormName}`);
        return true;
    }
    // å›å¤
    // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘åº”ç”¨å›å¤ä¿®æ­£
    heal(amount, options = {}) {
        let finalAmount = amount;
        // åº”ç”¨ç¯å¢ƒå›¾å±‚å›å¤ä¿®æ­£
        if (!options.bypassEnv && typeof window !== 'undefined' && window.envOverlay) {
            const healMult = window.envOverlay.getHealMod(this);
            if (healMult !== 1) {
                finalAmount = Math.floor(amount * healMult);
                console.log(`[ENV OVERLAY] å›å¤ä¿®æ­£ï¼š${amount} -> ${finalAmount} (x${healMult})`);
            }
        }
        this.currHp = Math.min(this.maxHp, this.currHp + finalAmount);
        return finalAmount; // è¿”å›å®é™…å›å¤é‡
    }
    /**
     * æ¶ˆè€—é“å…·ï¼ˆè§¦å‘ Unburden ç­‰ç‰¹æ€§ï¼‰
     * @param {string} reason - æ¶ˆè€—åŸå›  ('use', 'fling', 'knockoff', 'consume')
     * @returns {string|null} - è¢«æ¶ˆè€—çš„é“å…·åç§°
     */
    consumeItem(reason = 'consume') {
        if (!this.item) return null;
        const consumedItem = this.item;
        this.item = null;
        // è§¦å‘ onItemLost é’©å­ï¼ˆUnburden ç­‰ç‰¹æ€§ï¼‰
        if (typeof AbilityHandlers !== 'undefined' && this.ability) {
            const handler = AbilityHandlers[this.ability];
            if (handler && handler.onItemLost) {
                let logs = [];
                handler.onItemLost(this, consumedItem, logs);
                // æ—¥å¿—è¾“å‡ºç”±è°ƒç”¨æ–¹å¤„ç†
                if (logs.length > 0 && typeof log === 'function') {
                    logs.forEach(txt => log(txt));
                }
            }
        }
        console.log(`[ITEM] ${this.cnName} çš„ ${consumedItem} è¢«æ¶ˆè€—äº† (${reason})`);
        return consumedItem;
    }
    // === é‡ç½®èƒ½åŠ›å˜åŒ– (æ¢äººæ—¶è°ƒç”¨) ===
    resetBoosts() {
        this.boosts = { atk: 0, def: 0, spa: 0, spd: 0, spe: 0, accuracy: 0, evasion: 0 };
        this.turnsOnField = 0;      // é‡ç½®ä¸Šåœºå›åˆæ•°
        this.lastMoveUsed = null;   // é‡ç½®ä¸Šå›åˆæŠ€èƒ½
        this.protectCounter = 0;    // é‡ç½®å®ˆä½è®¡æ•°å™¨
        this.mustRecharge = false;  // é‡ç½®åƒµç›´çŠ¶æ€
        // ã€ä¿®å¤ã€‘æ¢äººæ—¶æ¸…é™¤æå·¨åŒ–çŠ¶æ€
        // æ­£ä½œè§„åˆ™ï¼šæå·¨åŒ–å®å¯æ¢¦ä¸€æ—¦é€€åœºï¼Œæå·¨åŒ–ç«‹åˆ»è§£é™¤
        if (this.isDynamaxed) {
            console.log(`[SWITCH] Clearing Dynamax for ${this.name}`);
            this.isDynamaxed = false;
            this.dynamaxTurns = 0;
            // æ¢å¤åŸå§‹åç§°ï¼ˆG-Max å½¢æ€åç§° -> åŸºç¡€åç§°ï¼‰
            if (this.originalName) {
                console.log(`[SWITCH] Restoring name: ${this.name} -> ${this.originalName}`);
                this.name = this.originalName;
                delete this.originalName;
            }
            // æ¢å¤ HPï¼ˆå¦‚æœä¹‹å‰ä¹˜äº† 1.5 å€ï¼‰
            if (this.preDynamaxMaxHp) {
                // æŒ‰æ¯”ä¾‹æ¢å¤ HP
                const hpRatio = this.currHp / this.maxHp;
                this.maxHp = this.preDynamaxMaxHp;
                this.currHp = Math.max(1, Math.floor(this.maxHp * hpRatio));
                this.preDynamaxMaxHp = null;
                this.preDynamaxCurrHp = null;
            }
        }
        // æ¸…é™¤è“„åŠ›çŠ¶æ€ (Solar Beam, Skull Bash, etc.)
        this.isCharging = false;
        this.chargingMove = null;
        // æ¸…é™¤å…¶ä»– volatile çŠ¶æ€
        if (this.volatiles) {
            this.volatiles = {};
        }
    }
    // === åº”ç”¨èƒ½åŠ›ç­‰çº§å˜åŒ– ===
    applyBoost(statName, stage) {
        if (!this.boosts.hasOwnProperty(statName)) return 0;
        // Contrary (å”±åè°ƒ): èƒ½åŠ›å˜åŒ–åè½¬
        if (this.ability && this.ability.toLowerCase().replace(/\s/g, '') === 'contrary') {
            stage = -stage;
        }
        const oldVal = this.boosts[statName];
        this.boosts[statName] = Math.min(6, Math.max(-6, oldVal + stage));
        return this.boosts[statName] - oldVal;
    }
    // === è·å–ç»è¿‡èƒ½åŠ›ä¿®æ­£åçš„å®æˆ˜æ•°å€¼ ===
    getStat(statName) {
        // åŸºç¡€å…­å›´ (é™¤äº† HP, accuracy, evasion)
        if (['atk', 'def', 'spa', 'spd', 'spe'].includes(statName)) {
            const base = this[statName];
            const stage = this.boosts[statName];
            // æ ¸å¿ƒå…¬å¼ï¼š stage >= 0: (2 + stage) / 2; stage < 0: 2 / (2 + |stage|)
            let multiplier = 1.0;
            if (stage >= 0) multiplier = (2 + stage) / 2;
            else multiplier = 2 / (2 + Math.abs(stage));
            let val = Math.floor(base * multiplier);
            // === ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘Environment Overlay æ•°å€¼ä¿®æ­£ ===
            if (typeof window !== 'undefined' && window.envOverlay) {
                const envMod = window.envOverlay.getStatMod(this, statName);
                if (envMod !== 1) {
                    const oldVal = val;
                    val = Math.floor(val * envMod);
                    console.log(`[ENV OVERLAY] ğŸŒ ${this.cnName} ${statName}: ${oldVal} â†’ ${val} (x${envMod})`);
                }
            }
            // === ç‰¹æ€§åŠ æˆ Hook (å¤§åŠ›å£«ã€æ¯›çš®å¤§è¡£ã€å¤©æ°”åŠ é€Ÿç­‰) ===
            if (typeof AbilityHandlers !== 'undefined' && this.ability && AbilityHandlers[this.ability]) {
                const ah = AbilityHandlers[this.ability];
                if (ah.onModifyStat) {
                    const shell = { atk: this.atk, def: this.def, spa: this.spa, spd: this.spd, spe: this.spe };
                    shell[statName] = val;
                    // ä¼ é€’ battle å¯¹è±¡ä»¥æ”¯æŒå¤©æ°”ç‰¹æ€§ (å¶ç»¿ç´ ã€æ‚ æ¸¸è‡ªå¦‚ç­‰)
                    const battleRef = (typeof battle !== 'undefined') ? battle : (typeof window !== 'undefined' ? window.battle : null);
                    ah.onModifyStat(shell, this, battleRef);
                    val = shell[statName];
                }
            }
            // === é“å…·åŠ æˆ (è®²ç©¶ç³»åˆ—ã€ç”µæ°”çƒã€ç²—éª¨å¤´ã€è¿›åŒ–å¥‡çŸ³ç­‰) ===
            if (this.item && typeof window !== 'undefined' && typeof window.getItem === 'function') {
                const itemData = window.getItem(this.item);
                if (itemData && itemData.statBoost && itemData.statBoost[statName]) {
                    const itemBoost = itemData.statBoost[statName];
                    let shouldApply = true;
                    // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹å®šå®å¯æ¢¦ä¸“å±é“å…·
                    if (itemData.itemUser) {
                        // ä¸“å±é“å…·ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºæŒ‡å®šå®å¯æ¢¦
                        const pokeName = this.name.split('-')[0]; // å¤„ç†åœ°åŒºå½¢æ€
                        shouldApply = itemData.itemUser.some(u => this.name.includes(u) || pokeName === u);
                    }
                    // æ£€æŸ¥æ˜¯å¦ä¸ºè¿›åŒ–å¥‡çŸ³ï¼ˆéœ€è¦æœªå®Œå…¨è¿›åŒ–ï¼‰
                    if (itemData.requiresNFE) {
                        // æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦å¯ä»¥è¿›åŒ–ï¼ˆé€šè¿‡ POKEDEX æ•°æ®ï¼‰
                        const normalizedId = this.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                        const pokeData = (typeof POKEDEX !== 'undefined') ? POKEDEX[normalizedId] : null;
                        // å¦‚æœæœ‰ evos å­—æ®µï¼Œè¯´æ˜å¯ä»¥è¿›åŒ–ï¼Œè¿›åŒ–å¥‡çŸ³ç”Ÿæ•ˆ
                        // å¦‚æœæ²¡æœ‰ evos å­—æ®µï¼Œè¯´æ˜å·²ç»æ˜¯æœ€ç»ˆå½¢æ€ï¼Œè¿›åŒ–å¥‡çŸ³ä¸ç”Ÿæ•ˆ
                        shouldApply = pokeData && pokeData.evos && pokeData.evos.length > 0;
                    }
                    if (shouldApply) {
                        val = Math.floor(val * itemBoost);
                        console.log(`[ITEM] ${this.cnName} çš„ ${itemData.cnName || this.item} ä½¿ ${statName} x${itemBoost}`);
                    }
                }
            }
            return Math.max(1, val);
        }
        // å‘½ä¸­/é—ªé¿è¿”å›ç­‰çº§å€¼ï¼Œç”±å¼•æ“è®¡ç®—æœ€ç»ˆå‘½ä¸­ç‡
        if (statName === 'accuracy' || statName === 'evasion') {
            return this.boosts[statName];
        }
        return 0;
    }
}
/**
 * =============================================
 * DAMAGE CALCULATION - å·²è¿ç§»
 * =============================================
 * 
 * calcDamage å‡½æ•°å·²è¿ç§»åˆ° -> battle/battle-calc.js
 */
/**
 * =============================================
 * MOVE SECONDARY EFFECTS - å·²è¿ç§»
 * =============================================
 * 
 * applyMoveSecondaryEffects å‡½æ•°å·²è¿ç§»åˆ° -> battle/battle-effects.js
 */
/**
 * æ ¸å¿ƒï¼šåˆ¤æ–­å½“å‰å®å¯æ¢¦èƒ½å¦è¡ŒåŠ¨
 * @param {Pokemon} pokemon
 * @param {Object} move - å¯é€‰ï¼Œè¦ä½¿ç”¨çš„æ‹›å¼ï¼ˆç”¨äºæŒ‘è¡…/å†æ¥ä¸€æ¬¡/å®šèº«æ³•æ£€æŸ¥ï¼‰
 * @returns {{ can: boolean, msg: string, forcedMove: Object|null }}
 */
export function checkCanMove(pokemon, move = null) {
    // 1. ç•ç¼© (Flinch) - æœ¬å›åˆæ— æ³•è¡ŒåŠ¨ï¼Œç”¨å®Œå³æ¸…
    if (pokemon.volatile && pokemon.volatile.flinch) {
        pokemon.volatile.flinch = false;
        // ã€é‡è¦ã€‘ç•ç¼©ä¼šä¸­æ–­è“„åŠ›æŠ€èƒ½
        if (pokemon.volatile.chargingMove) {
            delete pokemon.volatile.chargingMove;
            // æ¸…é™¤åŠæ— æ•ŒçŠ¶æ€
            delete pokemon.volatile.flying;
            delete pokemon.volatile.underground;
            delete pokemon.volatile.underwater;
            delete pokemon.volatile.shadow;
        }
        return { can: false, msg: `${pokemon.cnName} å› ä¸ºç•ç¼©è€Œæ— æ³•åŠ¨å¼¹!` };
    }
    // 2. ç¡çœ  (Sleep) - æ¯å›åˆå‡å°‘è®¡æ•°ï¼Œåˆ°0é†’æ¥
    if (pokemon.status === 'slp') {
        pokemon.sleepTurns--;
        if (pokemon.sleepTurns <= 0) {
            pokemon.status = null;
            return { can: true, msg: `${pokemon.cnName} é†’è¿‡æ¥äº†!` };
        }
        // ã€é‡è¦ã€‘ç¡çœ ä¼šä¸­æ–­è“„åŠ›æŠ€èƒ½
        if (pokemon.volatile && pokemon.volatile.chargingMove) {
            delete pokemon.volatile.chargingMove;
            delete pokemon.volatile.flying;
            delete pokemon.volatile.underground;
            delete pokemon.volatile.underwater;
            delete pokemon.volatile.shadow;
        }
        return { can: false, msg: `${pokemon.cnName} æ­£åœ¨ç†Ÿç¡ä¸­...` };
    }
    // 3. éº»ç—¹ (Paralysis) - 25% å‡ ç‡æ— æ³•è¡ŒåŠ¨
    if (pokemon.status === 'par') {
        if (Math.random() < 0.25) {
            // ã€é‡è¦ã€‘éº»ç—¹æ— æ³•è¡ŒåŠ¨ä¼šä¸­æ–­è“„åŠ›æŠ€èƒ½
            if (pokemon.volatile && pokemon.volatile.chargingMove) {
                delete pokemon.volatile.chargingMove;
                delete pokemon.volatile.flying;
                delete pokemon.volatile.underground;
                delete pokemon.volatile.underwater;
                delete pokemon.volatile.shadow;
            }
            return { can: false, msg: `${pokemon.cnName} å› èº«ä½“éº»ç—¹è€Œæ— æ³•è¡ŒåŠ¨!` };
        }
    }
    // 3.5 ã€Ambrosia æ—¶ç©ºé†‰ã€‘æ£€æŸ¥å¹¶åº”ç”¨æ··ä¹±ï¼ˆMega/Z/Dynamax/Tera åçš„ä¸‹å›åˆï¼‰
    // æ³¨æ„ï¼šè¿™é‡Œåªè®¾ç½®æ··ä¹±çŠ¶æ€ï¼Œä¸è¿”å›ï¼Œè®©åç»­çš„æ··ä¹±æ£€æŸ¥å¤„ç†è‡ªä¼¤é€»è¾‘
    let neuroBacklashMessage = '';
    if (pokemon.volatile && pokemon.volatile.neuroBacklash) {
        if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.applyNeuroBacklashConfusion) {
            const neuroResult = window.WeatherEffects.applyNeuroBacklashConfusion(pokemon);
            if (neuroResult.applied) {
                console.log(`[AMBROSIA] âš¡ æ—¶ç©ºé†‰å‘ä½œï¼š${pokemon.cnName} é™·å…¥æ··ä¹±`);
                neuroBacklashMessage = neuroResult.message;
                // ä¸è¿”å›ï¼Œç»§ç»­æ‰§è¡Œåç»­æ£€æŸ¥ï¼ˆæ··ä¹±è‡ªä¼¤ä¼šåœ¨ battle-turns.js ä¸­å¤„ç†ï¼‰
            }
        }
    }
    // 4. å†°å†» (Frozen) - 20% å‡ ç‡è§£å†»ï¼Œå¦åˆ™æ— æ³•è¡ŒåŠ¨
    if (pokemon.status === 'frz') {
        // 4a. ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘æ£€æŸ¥ç¯å¢ƒæ˜¯å¦æ²»æ„ˆå†°å†»
        if (typeof window !== 'undefined' && window.envOverlay) {
            const statusEffects = window.envOverlay.getStatusEffects(pokemon);
            if (statusEffects.cureStatus.includes('freeze') || statusEffects.cureStatus.includes('frz')) {
                pokemon.status = null;
                return { can: true, msg: `<span style="color:#22c55e">ğŸŒ¿ ç¯å¢ƒæ•ˆæœèåŒ–äº† ${pokemon.cnName} èº«ä¸Šçš„å†°å—ï¼</span>` };
            }
        }
        // 4b. è‡ªè§£å†»æ‹›å¼æ£€æŸ¥ (defrost flag)
        // ä½¿ç”¨å¸¦æœ‰ defrost æ ‡è®°çš„æ‹›å¼å¯ä»¥ç«‹å³è§£å†»å¹¶æ”»å‡»
        if (move) {
            const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
            if (fullMoveData.flags && fullMoveData.flags.defrost) {
                pokemon.status = null;
                return { can: true, msg: `${pokemon.cnName} çš„çƒˆç„°èåŒ–äº†èº«ä¸Šçš„å†°!` };
            }
        }
        // 4c. éšæœºè§£å†» (20% å‡ ç‡)
        if (Math.random() < 0.2) {
            pokemon.status = null;
            return { can: true, msg: `${pokemon.cnName} çš„å†°å†»è§£é™¤äº†!` };
        }
        // ã€é‡è¦ã€‘å†°å†»ä¼šä¸­æ–­è“„åŠ›æŠ€èƒ½
        if (pokemon.volatile && pokemon.volatile.chargingMove) {
            delete pokemon.volatile.chargingMove;
            delete pokemon.volatile.flying;
            delete pokemon.volatile.underground;
            delete pokemon.volatile.underwater;
            delete pokemon.volatile.shadow;
        }
        return { can: false, msg: `${pokemon.cnName} è¢«å†»å¾—åŠ¨å¼¹ä¸å¾—!` };
    }
    // ============================================
    // 5. æŒ¥å‘æ€§å°é”æ£€æŸ¥ (Volatile Locks)
    // ============================================
    // 5a. æŒ‘è¡… (Taunt) - æ— æ³•ä½¿ç”¨å˜åŒ–æŠ€
    if (pokemon.volatile && pokemon.volatile.taunt > 0 && move) {
        const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
        const category = fullMoveData.category || move.category || move.cat;
        if (category === 'Status') {
            return { can: false, msg: `${pokemon.cnName} å› ä¸ºæŒ‘è¡…æ— æ³•ä½¿ç”¨ ${move.cn || move.name}!` };
        }
    }
    // 5a2. çªå‡»èƒŒå¿ƒ (Assault Vest) - æ— æ³•ä½¿ç”¨å˜åŒ–æŠ€
    if (pokemon.item && move) {
        const itemId = (pokemon.item || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        const itemData = (typeof window !== 'undefined' && typeof window.getItem === 'function') 
            ? window.getItem(pokemon.item) : null;
        if (itemData && itemData.disableStatus) {
            const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
            const category = fullMoveData.category || move.category || move.cat;
            if (category === 'Status') {
                return { can: false, msg: `${pokemon.cnName} çš„${itemData.cnName || pokemon.item}ä½¿å…¶æ— æ³•ä½¿ç”¨å˜åŒ–æŠ€!` };
            }
        }
    }
    // 5b. å†æ¥ä¸€æ¬¡ (Encore) - åªèƒ½ä½¿ç”¨è¢«é”å®šçš„æ‹›å¼
    if (pokemon.volatile && pokemon.volatile.encore > 0 && pokemon.volatile.encoreMove && move) {
        if (move.name !== pokemon.volatile.encoreMove) {
            return { 
                can: false, 
                msg: `${pokemon.cnName} è¢«å†æ¥ä¸€æ¬¡é”å®šäº†!`,
                forcedMove: pokemon.volatile.encoreMove
            };
        }
    }
    // 5c. å®šèº«æ³• (Disable) - æ— æ³•ä½¿ç”¨è¢«å°å°çš„æ‹›å¼
    if (pokemon.volatile && pokemon.volatile.disable > 0 && pokemon.volatile.disabledMove && move) {
        if (move.name === pokemon.volatile.disabledMove) {
            return { can: false, msg: `${pokemon.cnName} çš„ ${move.cn || move.name} è¢«å°å°äº†!` };
        }
    }
    // 5d. æ€¨æ¨å°å° (Grudge Seal) - è¢«æ€¨æ¨å°å°çš„æ‹›å¼æ— æ³•ä½¿ç”¨
    if (pokemon.volatile && pokemon.volatile.grudgeSealed && move) {
        if (pokemon.volatile.grudgeSealed.includes(move.name)) {
            return { can: false, msg: `${pokemon.cnName} çš„ ${move.cn || move.name} è¢«æ€¨å¿µå°å°äº†!` };
        }
    }
    return { can: true, msg: neuroBacklashMessage, forcedMove: null };
}
/**
 * æ¸…é™¤å›åˆç»“æŸæ—¶çš„ä¸´æ—¶çŠ¶æ€ï¼ˆå¦‚ç•ç¼©ï¼‰
 */
export function clearVolatileStatus(pokemon) {
    if (pokemon.volatile) {
        pokemon.volatile.flinch = false;
    }
}
/**
 * æ¸…é™¤æ¢äººæ—¶çš„æ‰€æœ‰ä¸´æ—¶çŠ¶æ€ï¼ˆåŒ…æ‹¬è“„åŠ›çŠ¶æ€ï¼‰
 * ç”¨äºæ¢äººã€æ¿’æ­»ç­‰æƒ…å†µ
 */
export function clearAllVolatileStatus(pokemon) {
    if (!pokemon) return;
    // æ¸…é™¤è“„åŠ›çŠ¶æ€
    if (typeof clearChargingState === 'function') {
        clearChargingState(pokemon);
    } else if (pokemon.volatile) {
        // Fallback: æ‰‹åŠ¨æ¸…é™¤è“„åŠ›ç›¸å…³çŠ¶æ€
        delete pokemon.volatile.chargingMove;
        delete pokemon.volatile.flying;
        delete pokemon.volatile.underground;
        delete pokemon.volatile.underwater;
        delete pokemon.volatile.shadow;
    }
    // æ¸…é™¤å…¶ä»–ä¸´æ—¶çŠ¶æ€
    if (pokemon.volatile) {
        pokemon.volatile.flinch = false;
        pokemon.volatile.protect = false;
        delete pokemon.volatile.lockedMove;
        delete pokemon.volatile.lastMove;
    }
}
// æ³¨æ„ï¼šapplyEntryHazards å’Œ tickVolatileStatus å·²åœ¨ move-effects.js ä¸­å®ç°
// ä½¿ç”¨ MoveEffects.applyEntryHazards å’Œ MoveEffects.tickVolatileStatus
/**
 * =============================================
 * END TURN STATUS - å·²è¿ç§»
 * =============================================
 * 
 * getEndTurnStatusLogs å‡½æ•°å·²è¿ç§»åˆ° -> battle/battle-turns.js
 */
// getMovePriority å·²è¿ç§»åˆ° move-effects.jsï¼Œä½¿ç”¨ MoveEffects.getMovePriority
if (typeof window !== 'undefined') {
    window.checkCanMove = checkCanMove;
    window.clearVolatileStatus = clearVolatileStatus;
    window.clearAllVolatileStatus = clearAllVolatileStatus;
    // getEndTurnStatusLogs å·²è¿ç§»åˆ° battle-turns.js
    // getMovePriority ä½¿ç”¨ MoveEffects.getMovePriority
    window.getMovePriority = (typeof MoveEffects !== 'undefined' && MoveEffects.getMovePriority) 
        ? MoveEffects.getMovePriority 
        : function(move) { return move?.priority || 0; };
}
/**
 * =============================================
 * MEGA EVOLUTION SYSTEM - å·²è¿ç§»
 * =============================================
 * 
 * ä»£ç å·²è¿ç§»åˆ° -> mechanics/mega-evolution.js
 * 
 * å‡½æ•°åˆ—è¡¨ï¼š
 * - autoDetectFormChangeEligibility()
 * - autoDetectMegaEligibility()
 * - performMegaEvolution()
 * - canMegaEvolve()
 * - isUnofficialMega()
 */
/**
 * æˆ˜æ–—çŠ¶æ€ç®¡ç†å™¨
 */
export class BattleState {
    constructor() {
        this.playerParty = [];
        this.enemyParty = [];
        this.playerActive = 0;
        this.enemyActive = 0;
        this.phase = 'intro';
        this.trainer = null;
        this.locked = false;
        this.scriptedResult = null;
        this.aiDifficulty = 'normal';
        // Mega Evolution çŠ¶æ€
        this.playerMegaUsed = false;    // ç©å®¶æœ¬åœºæ˜¯å¦å·²ä½¿ç”¨ Mega
        this.enemyMegaUsed = false;     // æ•Œæ–¹æœ¬åœºæ˜¯å¦å·²ä½¿ç”¨ Mega
        this.playerMegaArmed = false;   // ç©å®¶æ˜¯å¦å·²é¢„å¤‡ Mega (ç‚¹å‡»äº†æŒ‰é’®)
        // Z-Move / Max Move çŠ¶æ€ (å…¨åœºåªèƒ½ç”¨ä¸€æ¬¡)
        this.playerZUsed = false;       // ç©å®¶æœ¬åœºæ˜¯å¦å·²ä½¿ç”¨ Z æ‹›å¼
        this.enemyZUsed = false;        // æ•Œæ–¹æœ¬åœºæ˜¯å¦å·²ä½¿ç”¨ Z æ‹›å¼
        this.playerMaxUsed = false;     // ç©å®¶æœ¬åœºæ˜¯å¦å·²ä½¿ç”¨æå·¨åŒ–
        this.enemyMaxUsed = false;      // æ•Œæ–¹æœ¬åœºæ˜¯å¦å·²ä½¿ç”¨æå·¨åŒ–
        // å¤ªæ™¶åŒ– (Terastallization) çŠ¶æ€ (å…¨åœºåªèƒ½ç”¨ä¸€æ¬¡ï¼Œç”±ç”Ÿåˆ°æ­»)
        this.playerTeraUsed = false;    // ç©å®¶æœ¬åœºæ˜¯å¦å·²ä½¿ç”¨å¤ªæ™¶åŒ–
        this.enemyTeraUsed = false;     // æ•Œæ–¹æœ¬åœºæ˜¯å¦å·²ä½¿ç”¨å¤ªæ™¶åŒ–
        // =========================================================
        // å…¨å±€æˆ˜åœºçŠ¶æ€ (Field Conditions)
        // ã€è§„èŒƒã€‘æ‰€æœ‰å­—æ®µä½¿ç”¨é©¼å³°å‘½åï¼Œä¸ moves-data.js çš„å°å†™ pseudoWeather å¯¹åº”
        // =========================================================
        this.field = {
            trickRoom: 0,   // æˆæ³•ç©ºé—´å‰©ä½™å›åˆ (0=æœªå¼€å¯)
            gravity: 0,     // é‡åŠ›å‰©ä½™å›åˆ
            magicRoom: 0,   // é­”æ³•ç©ºé—´å‰©ä½™å›åˆ
            wonderRoom: 0,  // å¥‡å¦™ç©ºé—´å‰©ä½™å›åˆ
            fairyLock: 0,   // å¦–ç²¾ä¹‹é”å‰©ä½™å›åˆ
            ionDeluge: 0,   // ç­‰ç¦»å­æµ´å‰©ä½™å›åˆ
            mudSport: 0,    // ç©æ³¥å·´å‰©ä½™å›åˆ
            waterSport: 0   // ç©æ°´å‰©ä½™å›åˆ
        };
        // ç©å®¶ä¾§çŠ¶æ€ (Player Side)
        this.playerSide = {
            tailwind: 0,      // é¡ºé£å‰©ä½™å›åˆ
            reflect: 0,       // åå°„å£å‰©ä½™å›åˆ
            lightScreen: 0,   // å…‰å¢™å‰©ä½™å›åˆ
            auroraVeil: 0,    // æå…‰å¹•å‰©ä½™å›åˆ
            stealthRock: false,  // éšå½¢å²©
            spikes: 0,        // æ’’è±å±‚æ•° (0-3)
            toxicSpikes: 0,   // æ¯’è±å±‚æ•° (0-2)
            stickyWeb: false  // é»é»ç½‘
        };
        // æ•Œæ–¹ä¾§çŠ¶æ€ (Enemy Side)
        this.enemySide = {
            tailwind: 0,
            reflect: 0,
            lightScreen: 0,
            auroraVeil: 0,
            stealthRock: false,
            spikes: 0,
            toxicSpikes: 0,
            stickyWeb: false
        };
    }
    // å›åˆç»“æŸæ—¶é€’å‡åœºåœ°çŠ¶æ€
    tickFieldConditions() {
        const logs = [];
        // å…¨å±€åœºåœ° - ä½¿ç”¨é€šç”¨é€’å‡é€»è¾‘
        const fieldEffects = [
            { key: 'trickRoom', msg: 'æ‰­æ›²çš„æ—¶ç©ºæ¢å¤äº†æ­£å¸¸ï¼' },
            { key: 'gravity', msg: 'é‡åŠ›æ¢å¤äº†æ­£å¸¸ï¼' },
            { key: 'magicRoom', msg: 'é­”æ³•ç©ºé—´æ¶ˆå¤±äº†ï¼' },
            { key: 'wonderRoom', msg: 'å¥‡å¦™ç©ºé—´æ¶ˆå¤±äº†ï¼' },
            { key: 'fairyLock', msg: 'å¦–ç²¾ä¹‹é”è§£é™¤äº†ï¼' },
            { key: 'ionDeluge', msg: 'ç­‰ç¦»å­æµ´ç»“æŸäº†ï¼' },
            { key: 'mudSport', msg: 'ç©æ³¥å·´çš„æ•ˆæœæ¶ˆå¤±äº†ï¼' },
            { key: 'waterSport', msg: 'ç©æ°´çš„æ•ˆæœæ¶ˆå¤±äº†ï¼' }
        ];
        for (const effect of fieldEffects) {
            if (this.field[effect.key] > 0) {
                this.field[effect.key]--;
                if (this.field[effect.key] === 0) {
                    logs.push(effect.msg);
                }
            }
        }
        // ç©å®¶ä¾§
        if (this.playerSide.tailwind > 0) {
            this.playerSide.tailwind--;
            if (this.playerSide.tailwind === 0) {
                logs.push("æˆ‘æ–¹çš„é¡ºé£åœæ­¢äº†ï¼");
            }
        }
        if (this.playerSide.reflect > 0) {
            this.playerSide.reflect--;
            if (this.playerSide.reflect === 0) {
                logs.push("æˆ‘æ–¹çš„åå°„å£æ¶ˆå¤±äº†ï¼");
            }
        }
        if (this.playerSide.lightScreen > 0) {
            this.playerSide.lightScreen--;
            if (this.playerSide.lightScreen === 0) {
                logs.push("æˆ‘æ–¹çš„å…‰å¢™æ¶ˆå¤±äº†ï¼");
            }
        }
        if (this.playerSide.auroraVeil > 0) {
            this.playerSide.auroraVeil--;
            if (this.playerSide.auroraVeil === 0) {
                logs.push("æˆ‘æ–¹çš„æå…‰å¹•æ¶ˆå¤±äº†ï¼");
            }
        }
        // æ•Œæ–¹ä¾§
        if (this.enemySide.tailwind > 0) {
            this.enemySide.tailwind--;
            if (this.enemySide.tailwind === 0) {
                logs.push("æ•Œæ–¹çš„é¡ºé£åœæ­¢äº†ï¼");
            }
        }
        if (this.enemySide.reflect > 0) {
            this.enemySide.reflect--;
            if (this.enemySide.reflect === 0) {
                logs.push("æ•Œæ–¹çš„åå°„å£æ¶ˆå¤±äº†ï¼");
            }
        }
        if (this.enemySide.lightScreen > 0) {
            this.enemySide.lightScreen--;
            if (this.enemySide.lightScreen === 0) {
                logs.push("æ•Œæ–¹çš„å…‰å¢™æ¶ˆå¤±äº†ï¼");
            }
        }
        if (this.enemySide.auroraVeil > 0) {
            this.enemySide.auroraVeil--;
            if (this.enemySide.auroraVeil === 0) {
                logs.push("æ•Œæ–¹çš„æå…‰å¹•æ¶ˆå¤±äº†ï¼");
            }
        }
        // =========================================================
        // ã€ä¿®å¤ã€‘å¤©æ°”å›åˆé€’å‡
        // ã€é‡è¦ã€‘å§‹æºå¤©æ°” (deltastream, harshsun, heavyrain) ä¸é€’å‡
        // å®ƒä»¬åªåœ¨å¯¹åº”ç‰¹æ€§å®å¯æ¢¦åœ¨åœºæ—¶å­˜åœ¨
        // =========================================================
        const PRIMAL_WEATHERS = ['deltastream', 'harshsun', 'heavyrain'];
        if (this.weatherTurns && this.weatherTurns > 0 && !PRIMAL_WEATHERS.includes(this.weather)) {
            this.weatherTurns--;
            console.log(`[WEATHER] å¤©æ°”å›åˆé€’å‡: ${this.weatherTurns + 1} -> ${this.weatherTurns}`);
            if (this.weatherTurns === 0) {
                const weatherNames = {
                    'rain': 'é›¨åœäº†ã€‚',
                    'sun': 'é˜³å…‰æ¢å¤äº†æ­£å¸¸ã€‚',
                    'sandstorm': 'æ²™æš´åœæ­¢äº†ã€‚',
                    'hail': 'å†°é›¹åœæ­¢äº†ã€‚',
                    'snow': 'é›ªåœäº†ã€‚'
                };
                const msg = weatherNames[this.weather] || 'å¤©æ°”æ¢å¤äº†æ­£å¸¸ã€‚';
                logs.push(`ğŸŒ¤ï¸ ${msg}`);
                console.log(`[WEATHER] å¤©æ°”ç»“æŸ: ${this.weather}`);
                // æ£€æŸ¥æ˜¯å¦æœ‰ç¯å¢ƒå¤©æ°”éœ€è¦å›å½’
                if (this.environmentWeather && this.environmentWeather !== 'none') {
                    this.weather = this.environmentWeather;
                    this.weatherTurns = 0; // ç¯å¢ƒå¤©æ°”æ°¸ä¹…
                    // ä½¿ç”¨å‹åˆ¶ç³»ç»Ÿçš„å›å½’æ¶ˆæ¯
                    if (typeof window !== 'undefined' && window.WeatherEffects) {
                        const revertMsg = window.WeatherEffects.getWeatherRevertMessage(this);
                        logs.push(revertMsg);
                    } else {
                        const envWeatherNames = {
                            'rain': 'é›¨å¤©', 'sun': 'æ™´å¤©', 'sandstorm': 'æ²™æš´',
                            'snow': 'é›ªå¤©', 'hail': 'å†°é›¹', 'smog': 'çƒŸéœ¾'
                        };
                        const envName = envWeatherNames[this.environmentWeather] || this.environmentWeather;
                        logs.push(`<span style="color:#9b59b6">ğŸŒ ç¯å¢ƒå¤©æ°”å›å½’ï¼š${envName}ï¼</span>`);
                    }
                    console.log(`[ENVIRONMENT] å›å½’ç¯å¢ƒå¤©æ°”: ${this.environmentWeather}`);
                    // æ›´æ–°å¤©æ°”è§†è§‰æ•ˆæœ
                    if (typeof window !== 'undefined' && window.setWeatherVisuals) {
                        window.setWeatherVisuals(this.environmentWeather);
                    }
                } else {
                    this.weather = null;
                    // æ›´æ–°å¤©æ°”è§†è§‰æ•ˆæœ
                    if (typeof window !== 'undefined' && window.setWeatherVisuals) {
                        window.setWeatherVisuals('none');
                    }
                }
            }
        }
        // =========================================================
        // ã€ä¿®å¤ã€‘åœºåœ°å›åˆé€’å‡ (Terrain)
        // ã€Ambrosiaã€‘ç¥ä¹‹ç¼æµ†å¤©æ°”ä¸‹ï¼Œç²¾ç¥åœºåœ°å’Œè–„é›¾åœºåœ°æ— é™æŒç»­
        // =========================================================
        if (this.terrainTurns && this.terrainTurns > 0) {
            // ã€Ambrosia æ— é™åœºåœ°ã€‘æ£€æŸ¥æ˜¯å¦è·³è¿‡é€’å‡
            let skipTerrainDecrement = false;
            if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.isTerrainInfinite) {
                if (window.WeatherEffects.isTerrainInfinite(this.weather, this.terrain)) {
                    skipTerrainDecrement = true;
                    console.log(`[AMBROSIA] ğŸŒˆ æ— é™åœºåœ°ï¼š${this.terrain} åœ¨ç¥ä¹‹ç¼æµ†ä¸­æ°¸ä¹…æŒç»­`);
                }
            }
            if (!skipTerrainDecrement) {
                this.terrainTurns--;
                console.log(`[TERRAIN] åœºåœ°å›åˆé€’å‡: ${this.terrainTurns + 1} -> ${this.terrainTurns}`);
                if (this.terrainTurns === 0) {
                    const terrainNames = {
                        'electricterrain': 'ç”µæ°”åœºåœ°æ¶ˆå¤±äº†ã€‚',
                        'grassyterrain': 'é’è‰åœºåœ°æ¶ˆå¤±äº†ã€‚',
                        'psychicterrain': 'ç²¾ç¥åœºåœ°æ¶ˆå¤±äº†ã€‚',
                        'mistyterrain': 'è–„é›¾åœºåœ°æ¶ˆå¤±äº†ã€‚'
                    };
                    const msg = terrainNames[this.terrain] || 'åœºåœ°æ•ˆæœæ¶ˆå¤±äº†ã€‚';
                    logs.push(`ğŸŒ¿ ${msg}`);
                    console.log(`[TERRAIN] åœºåœ°ç»“æŸ: ${this.terrain}`);
                    this.terrain = null;
                }
            }
        }
        return logs;
    }
    // ä» AI JSON åˆå§‹åŒ–æ•Œæ–¹
    loadFromJSON(json) {
        const enemyObj = json.enemy || json.trainer || {};
        const typeLabel = typeof enemyObj.type === 'string' ? enemyObj.type.trim() : '';
        const nameId = typeof enemyObj.name === 'string' ? enemyObj.name.trim() : '';
        const isWild = (typeLabel.toLowerCase() === 'wild') || (!nameId && !enemyObj.type);
        let imgId = 'wild';
        if (!isWild) {
            imgId = enemyObj.id || nameId || 'wild';
        }
        let displayName = nameId;
        if (isWild && !displayName) displayName = "Wild Pokemon";
        if (!displayName) displayName = "Unknown";
        const lines = enemyObj.lines || {};
        this.trainer = {
            name: displayName,
            title: typeLabel || '',
            id: imgId,
            lines: {
                start: lines.start || enemyObj.line || "",
                win: lines.win || "",
                lose: lines.lose || "",
                escape: lines.escape || ""
            }
        };
        this.scriptedResult = json.script || null;
        const rawDiff = (json.ai || json.difficulty || enemyObj.difficulty || '').toString().toLowerCase();
        if (rawDiff) {
            this.aiDifficulty = rawDiff;
        } else {
            this.aiDifficulty = isWild ? 'easy' : 'normal';
        }
        const trainerNameLower = (displayName || '').toLowerCase();
        if (/cynthia|red|steven|champion/.test(trainerNameLower)) {
            this.aiDifficulty = 'hard';
        }
        // ã€ä¿®å¤ã€‘è¯»å–æ•Œæ–¹è®­ç»ƒå®¶ç†Ÿç»ƒåº¦ï¼Œç”¨äºæ•Œæ–¹ AI å¯¹å†²è§¦å‘æ¦‚ç‡
        // JSON æ ¼å¼: enemy.trainerProficiency (0-255)
        // æ ¹æ® enable_proficiency_cap è§£é”çŠ¶æ€é™åˆ¶ä¸Šé™ï¼šfalse=155, true=255
        // æ³¨æ„ï¼šæ•Œæ–¹çš„ unlocks åœ¨åé¢è§£æï¼Œè¿™é‡Œå…ˆé¢„è¯»å–
        const enemyProficiencyCapUnlocked = (json.unlocks || enemyObj.unlocks || {}).enable_proficiency_cap === true;
        if (enemyObj.trainerProficiency !== undefined) {
            const enemyProficiencyCap = enemyProficiencyCapUnlocked ? 255 : 155;
            this.enemyTrainerProficiency = Math.min(enemyProficiencyCap, Math.max(0, enemyObj.trainerProficiency));
            console.log(`[ENEMY PROFICIENCY] æ•Œæ–¹è®­ç»ƒå®¶ç†Ÿç»ƒåº¦: ${this.enemyTrainerProficiency} (ä¸Šé™: ${enemyProficiencyCap})`);
        } else {
            this.enemyTrainerProficiency = 0;
        }
        let rawParty = [];
        if (Array.isArray(json.party)) {
            rawParty.push(...json.party);
        }
        if (Array.isArray(enemyObj.party)) {
            rawParty.push(...enemyObj.party);
        }
        if (rawParty.length === 0 && Array.isArray(json.enemyParty)) {
            rawParty.push(...json.enemyParty);
        }
        if (rawParty.length > 6) {
            rawParty = rawParty.slice(0, 6);
        }
        const validPartyData = [];
        for (const p of rawParty) {
            const seed = (p?.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            if (!seed) continue;
            validPartyData.push(p);
        }
        if (validPartyData.length === 0) {
            console.warn("[PKM] Warn: No valid pokemon found in enemy party. Adding fallback.");
            validPartyData.push({ name: 'Magikarp', lv: 5, moves: ['Splash'] });
        }
        // === æ•Œæ–¹è§£é”ç³»ç»Ÿ (Enemy Unlock System) ===
        // è§£æ unlocks å¯¹è±¡ï¼Œå†³å®š NPC æ˜¯å¦æœ‰èµ„æ ¼ä½¿ç”¨å„æœºåˆ¶
        // unlocks å¯ä»¥åœ¨ json.unlocks æˆ– enemyObj.unlocks ä¸­
        const enemyUnlocksRaw = json.unlocks || enemyObj.unlocks || {};
        this.enemyUnlocks = {
            enable_bond: enemyUnlocksRaw.enable_bond === true,        // ç¾ç»Šå…±é¸£ (é»˜è®¤å…³é—­)
            enable_styles: enemyUnlocksRaw.enable_styles === true,    // åˆšçŒ›/è¿…ç–¾ (é»˜è®¤å…³é—­)
            enable_insight: enemyUnlocksRaw.enable_insight === true,  // å¿ƒçœ¼/AVsçªç ´155ä¸Šé™ (é»˜è®¤å…³é—­)
            enable_mega: enemyUnlocksRaw.enable_mega === true,        // Megaè¿›åŒ– (é»˜è®¤å…³é—­)
            enable_z_move: enemyUnlocksRaw.enable_z_move === true,    // Zæ‹›å¼ (é»˜è®¤å…³é—­)
            enable_dynamax: enemyUnlocksRaw.enable_dynamax === true,  // æå·¨åŒ– (é»˜è®¤å…³é—­)
            enable_tera: enemyUnlocksRaw.enable_tera === true,        // å¤ªæ™¶åŒ– (é»˜è®¤å…³é—­)
            enable_proficiency_cap: enemyUnlocksRaw.enable_proficiency_cap === true  // è®­ç»ƒåº¦çªç ´155ä¸Šé™ (é»˜è®¤å…³é—­)
        };
        console.log('[UNLOCK] æ•Œæ–¹è§£é”çŠ¶æ€:', this.enemyUnlocks);
        // æ£€æŸ¥æ•Œæ–¹è®­ç»ƒå®¶æ˜¯å¦æœ‰ Mega æƒé™
        // ä¼˜å…ˆä½¿ç”¨ unlocks.enable_megaï¼Œå…¶æ¬¡æ£€æŸ¥ canMega å­—æ®µæˆ– Boss åç§°
        // (trainerNameLower å·²åœ¨ä¸Šé¢å®šä¹‰)
        const isBossTrainer = /cynthia|red|steven|champion|elite|leader|boss/.test(trainerNameLower);
        const enemyCanMega = this.enemyUnlocks.enable_mega || 
            (enemyObj.canMega !== false && (enemyObj.canMega === true || isBossTrainer));
        this.enemyParty = validPartyData.map(p => {
            // ä½¿ç”¨æ–°ç‰ˆæ„é€ æ–¹å¼ï¼šä¼ å…¥å®Œæ•´é…ç½®å¯¹è±¡
            const poke = new Pokemon(p);
            // ã€ä¿®å¤ã€‘å³ä½¿ enemyCanMega=falseï¼Œå¦‚æœå®å¯æ¢¦æœ‰ mechanic='dynamax'ï¼Œä¹Ÿéœ€è¦æ£€æµ‹å½¢æ€
            // autoDetectMegaEligibility ä¸ä»…å¤„ç† Megaï¼Œè¿˜å¤„ç† Dynamax/GMax å½¢æ€
            const needsFormDetection = (enemyCanMega && !isWild) || 
                poke.mechanic === 'dynamax' || 
                poke.mechanic === 'tera' ||
                poke.canDynamax;
            if (needsFormDetection) {
                console.log('[FORM] Enemy: Calling autoDetectMegaEligibility for', poke.name, 'mechanic:', poke.mechanic);
                autoDetectMegaEligibility(poke, p.mega || null);
                console.log('[FORM] Enemy after detection:', poke.name, 'canMegaEvolve:', poke.canMegaEvolve, 'canDynamax:', poke.canDynamax, 'megaTargetId:', poke.megaTargetId);
            }
            return poke;
        });
        // ã€isLead é¦–å‘é€»è¾‘ã€‘æ£€æŸ¥æ˜¯å¦æœ‰æ ‡è®°ä¸º isLead çš„å®å¯æ¢¦ï¼Œè‡ªåŠ¨å°†å…¶ç§»åˆ°ç¬¬ä¸€ä½
        const leadIndex = this.enemyParty.findIndex(p => p.isLead === true);
        if (leadIndex > 0) {
            // æ‰¾åˆ° isLead=true çš„å®å¯æ¢¦ä¸”ä¸åœ¨ç¬¬ä¸€ä½ï¼Œå°†å…¶ä¸ç¬¬ä¸€ä½äº¤æ¢
            const leadPokemon = this.enemyParty[leadIndex];
            this.enemyParty[leadIndex] = this.enemyParty[0];
            this.enemyParty[0] = leadPokemon;
            console.log(`[LEAD] Enemy: ${leadPokemon.cnName} (${leadPokemon.name}) marked as isLead, swapped to first position`);
        } else if (leadIndex === 0) {
            console.log(`[LEAD] Enemy: ${this.enemyParty[0].cnName} is already in first position with isLead=true`);
        } else {
            console.log('[LEAD] Enemy: No PokÃ©mon marked as isLead, using default order');
        }
        // ã€è°ƒè¯•ã€‘æ‰“å°æ•Œæ–¹é˜Ÿä¼åˆå§‹åŒ–çŠ¶æ€
        console.log('[ENEMY PARTY] Loaded', this.enemyParty.length, 'Pokemon:');
        this.enemyParty.forEach((p, i) => {
            console.log(`  [${i}] ${p.cnName} (${p.name}) - HP: ${p.currHp}/${p.maxHp}, isAlive: ${p.isAlive()}`);
        });
        this.enemyActive = 0;
        this.enemyMegaUsed = false;
        if (isWild && this.enemyParty.length > 0) {
            this.trainer.name = this.enemyParty[0].cnName;
        }
        this.phase = 'battle';
    }
    // è®¾ç½®ç©å®¶é˜Ÿä¼
    // ã€ä¿®å¤ã€‘canMega åªæ§åˆ¶ Mega è¿›åŒ–ï¼Œä½†æå·¨åŒ–/å¤ªæ™¶åŒ–ç­‰éœ€è¦å•ç‹¬æ£€æŸ¥
    setPlayerParty(partyData, canMega = true) {
        console.log('[MEGA] setPlayerParty called, canMega:', canMega, 'partyData:', partyData);
        this.playerParty = partyData.map(p => {
            // ä½¿ç”¨æ–°ç‰ˆæ„é€ æ–¹å¼ï¼šä¼ å…¥å®Œæ•´é…ç½®å¯¹è±¡
            // AVs åº”è¯¥åœ¨ pkm-tavern-plugin.js ä¸­å¤„ç† (AVl/AVup æ ¼å¼)
            const poke = new Pokemon(p);
            // ã€ä¿®å¤ã€‘å³ä½¿ canMega=falseï¼Œå¦‚æœå®å¯æ¢¦æœ‰ mechanic='dynamax'ï¼Œä¹Ÿéœ€è¦æ£€æµ‹å½¢æ€
            // autoDetectMegaEligibility ä¸ä»…å¤„ç† Megaï¼Œè¿˜å¤„ç† Dynamax/GMax å½¢æ€
            const needsFormDetection = canMega || 
                poke.mechanic === 'dynamax' || 
                poke.mechanic === 'tera' ||
                poke.canDynamax;
            if (needsFormDetection) {
                console.log('[FORM] Calling autoDetectMegaEligibility for', poke.name, 'with mega flag:', p.mega, 'mechanic:', poke.mechanic);
                autoDetectMegaEligibility(poke, p.mega || null);
                console.log('[FORM] After detection:', poke.name, 'canMegaEvolve:', poke.canMegaEvolve, 'canDynamax:', poke.canDynamax, 'megaTargetId:', poke.megaTargetId);
            }
            return poke;
        });
        // ã€isLead é¦–å‘é€»è¾‘ã€‘æ£€æŸ¥æ˜¯å¦æœ‰æ ‡è®°ä¸º isLead çš„å®å¯æ¢¦ï¼Œè‡ªåŠ¨å°†å…¶ç§»åˆ°ç¬¬ä¸€ä½
        const leadIndex = this.playerParty.findIndex(p => p.isLead === true);
        if (leadIndex > 0) {
            // æ‰¾åˆ° isLead=true çš„å®å¯æ¢¦ä¸”ä¸åœ¨ç¬¬ä¸€ä½ï¼Œå°†å…¶ä¸ç¬¬ä¸€ä½äº¤æ¢
            const leadPokemon = this.playerParty[leadIndex];
            this.playerParty[leadIndex] = this.playerParty[0];
            this.playerParty[0] = leadPokemon;
            console.log(`[LEAD] ${leadPokemon.cnName} (${leadPokemon.name}) marked as isLead, swapped to first position`);
        } else if (leadIndex === 0) {
            console.log(`[LEAD] ${this.playerParty[0].cnName} is already in first position with isLead=true`);
        } else {
            console.log('[LEAD] No PokÃ©mon marked as isLead, using default order');
        }
        this.playerActive = 0;
        this.playerMegaUsed = false;
    }
    // è·å–å½“å‰å‡ºæˆ˜
    getPlayer() { return this.playerParty[this.playerActive]; }
    getEnemy() { return this.enemyParty[this.enemyActive]; }
    // æ£€æŸ¥èƒœè´Ÿ
    // ã€å®˜æ–¹è§„åˆ™ã€‘åŒå‘½å¯¼è‡´çš„åŒæ€ï¼Œä½¿ç”¨åŒå‘½è€…è¾“
    checkBattleEnd() {
        const playerAlive = this.playerParty.some(p => p.isAlive());
        const enemyAlive = this.enemyParty.some(p => p.isAlive());
        console.log(`[checkBattleEnd] playerAlive: ${playerAlive}, enemyAlive: ${enemyAlive}, destinyBondCauser: ${this.destinyBondCauser}`);
        // åŒæ–¹éƒ½æ²¡æœ‰å­˜æ´»çš„å®å¯æ¢¦ -> éœ€è¦åˆ¤æ–­è°è¾“
        if (!playerAlive && !enemyAlive) {
            // ã€åŒå‘½è§„åˆ™ã€‘å¦‚æœæ˜¯åŒå‘½å¯¼è‡´çš„åŒæ€ï¼Œä½¿ç”¨åŒå‘½è€…è¾“
            // destinyBondCauser è®°å½•äº†è°ä½¿ç”¨äº†åŒå‘½å¯¼è‡´åŒæ€
            if (this.destinyBondCauser === 'enemy') {
                // æ•Œæ–¹ä½¿ç”¨åŒå‘½å¯¼è‡´åŒæ€ -> æ•Œæ–¹è¾“ -> ç©å®¶èµ¢
                console.log('[BATTLE END] åŒå‘½åŒæ€ï¼šæ•Œæ–¹ä½¿ç”¨åŒå‘½ï¼Œæ•Œæ–¹è¾“');
                return 'win';
            } else if (this.destinyBondCauser === 'player') {
                // ç©å®¶ä½¿ç”¨åŒå‘½å¯¼è‡´åŒæ€ -> ç©å®¶è¾“
                console.log('[BATTLE END] åŒå‘½åŒæ€ï¼šç©å®¶ä½¿ç”¨åŒå‘½ï¼Œç©å®¶è¾“');
                return 'loss';
            }
            // å…¶ä»–åŒæ€æƒ…å†µï¼ˆå¦‚å¤§çˆ†ç‚¸ï¼‰ï¼šæ”»å‡»è€…è¾“
            // é»˜è®¤ï¼šç©å®¶è¾“ï¼ˆä¿å®ˆåˆ¤å®šï¼‰
            console.log('[BATTLE END] åŒæ€ï¼šé»˜è®¤ç©å®¶è¾“');
            return 'loss';
        }
        if (!playerAlive) return 'loss';
        if (!enemyAlive) return 'win';
        return null;
    }
    // æ‰¾ä¸‹ä¸€ä¸ªå­˜æ´»çš„æ•Œæ–¹
    nextAliveEnemy() {
        // é‡ç½®å½“å‰æ•Œæ–¹çš„èƒ½åŠ›ç­‰çº§
        const currentEnemy = this.enemyParty[this.enemyActive];
        if (currentEnemy && typeof currentEnemy.resetBoosts === 'function') {
            currentEnemy.resetBoosts();
        }
        // è°ƒè¯•ï¼šæ‰“å°æ‰€æœ‰æ•Œæ–¹å®å¯æ¢¦çš„çŠ¶æ€
        console.log('[nextAliveEnemy] Current active:', this.enemyActive);
        this.enemyParty.forEach((p, i) => {
            console.log(`[nextAliveEnemy] Enemy ${i}: ${p.cnName}, HP: ${p.currHp}/${p.maxHp}, isAlive: ${p.isAlive()}`);
        });
        // ============================================
        // æ™ºèƒ½æ¢äººï¼šExpert/Hard éš¾åº¦ä½¿ç”¨ Revenge Killer é€»è¾‘
        // ============================================
        const difficulty = this.aiDifficulty || 'hard';
        if ((difficulty === 'expert' || difficulty === 'hard') && 
            typeof window !== 'undefined' && typeof window.getBestRevengeKiller === 'function') {
            const playerPoke = this.getPlayer();
            if (playerPoke && playerPoke.isAlive()) {
                const smartIdx = window.getBestRevengeKiller(this.enemyParty, playerPoke, this.enemyActive);
                if (smartIdx !== -1 && smartIdx !== this.enemyActive && 
                    this.enemyParty[smartIdx] && this.enemyParty[smartIdx].isAlive()) {
                    console.log(`[nextAliveEnemy] Smart switch: choosing index ${smartIdx} (Revenge Killer)`);
                    this.enemyActive = smartIdx;
                    return true;
                }
            }
        }
        // Fallback: çº¿æ€§æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå­˜æ´»çš„
        const idx = this.enemyParty.findIndex((p, i) => i !== this.enemyActive && p.isAlive());
        console.log('[nextAliveEnemy] Found next alive at index:', idx);
        if (idx !== -1) this.enemyActive = idx;
        return idx !== -1;
    }
    // æ‰¾ä¸‹ä¸€ä¸ªå­˜æ´»çš„ç©å®¶
    nextAlivePlayer() {
        const idx = this.playerParty.findIndex((p, i) => i !== this.playerActive && p.isAlive());
        if (idx !== -1) this.playerActive = idx;
        this.phase = 'battle';
    }
}
/* =============================================================
 *  BATTLE AI - å·²è¿ç§»åˆ° ai-engine.js
 *  ä¿ç•™æ­¤æ³¨é‡Šä»¥æ ‡è®° AI é€»è¾‘çš„æ–°ä½ç½®
 * ============================================================= */
// å¯¼å‡º
window.TYPE_CHART = TYPE_CHART;
window.NATURE_MODIFIERS = NATURE_MODIFIERS;
window.getTypeEffectiveness = getTypeEffectiveness;
window.getPokemonData = getPokemonData;
window.getMoveData = getMoveData;
window.calcStats = calcStats;
window.Pokemon = Pokemon;
// calcDamage å·²è¿ç§»åˆ° battle/battle-calc.jsï¼Œç”± src/globals.js æŒ‚è½½
// applyMoveSecondaryEffects å·²è¿ç§»åˆ° battle/battle-effects.jsï¼Œç”±è¯¥æ–‡ä»¶è‡ªè¡ŒæŒ‚è½½
window.BattleState = BattleState;
window.checkCanMove = checkCanMove;
window.clearVolatileStatus = clearVolatileStatus;
// applyEntryHazards å’Œ tickVolatileStatus å·²åœ¨ move-effects.js ä¸­å¯¼å‡ºä¸º MoveEffects.xxx
// window.getAiMove - å·²è¿ç§»åˆ° ai-engine.js
]]></file>
        <file name="charge-moves.js"><![CDATA[/**
 * ===========================================
 * CHARGE-MOVES.JS - è“„åŠ›æŠ€èƒ½ç³»ç»Ÿ
 * ===========================================
 * 
 * å¤„ç†éœ€è¦ä¸¤å›åˆæ‰§è¡Œçš„æŠ€èƒ½ï¼š
 * - å¤©æ°”è”åŠ¨å‹ (Solar Beam, Solar Blade, Electro Shot)
 * - åŠæ— æ•ŒçŠ¶æ€å‹ (Fly, Dig, Dive, Phantom Force, Shadow Force)
 * - çº¯è“„åŠ›/å¼ºåŒ–å‹ (Meteor Beam, Skull Bash, Sky Attack, Geomancy)
 * 
 * ä¸ Power Herb é“å…·äº¤äº’
 * 
 * ã€é‡æ„ã€‘ä» moves-data.js è¯»å– flags.charge æ ‡è®°ï¼Œ
 * é¢å¤–é…ç½®ï¼ˆè“„åŠ›æ–‡æœ¬ã€å¤©æ°”è”åŠ¨ã€åŠæ— æ•ŒçŠ¶æ€ç­‰ï¼‰åœ¨æ­¤å®šä¹‰
 */
/**
 * è“„åŠ›æŠ€èƒ½é¢å¤–é…ç½®è¡¨
 * åŸºç¡€è“„åŠ›æ£€æµ‹ç”± moves-data.js çš„ flags.charge æä¾›
 * æ­¤è¡¨ä»…å®šä¹‰é¢å¤–è¡Œä¸ºï¼ˆå¤©æ°”è”åŠ¨ã€åŠæ— æ•ŒçŠ¶æ€ã€è“„åŠ›æ–‡æœ¬ç­‰ï¼‰
 */
export const CHARGE_MOVE_CONFIG = {
    // ============================================
    // ç¬¬ä¸€ç±»ï¼šå¤©æ°”è”åŠ¨å‹
    // ============================================
    'Solar Beam': {
        type: 'weather',
        weather: ['sun', 'harshsun'],
        chargeText: 'å¸æ”¶äº†å…‰èŠ’ï¼',
        releaseText: 'å‘å°„äº†æ—¥å…‰æŸï¼',
        weatherWeakened: ['rain', 'heavyrain', 'sandstorm', 'hail', 'snow'],
    },
    'Solar Blade': {
        type: 'weather',
        weather: ['sun', 'harshsun'],
        chargeText: 'å¸æ”¶äº†å…‰èŠ’ï¼',
        releaseText: 'æŒ¥å‡ºäº†æ—¥å…‰åˆƒï¼',
        weatherWeakened: ['rain', 'heavyrain', 'sandstorm', 'hail', 'snow'],
    },
    'Electro Shot': {
        type: 'weather',
        weather: ['rain', 'heavyrain'],
        chargeText: 'ç§¯è“„äº†ç”µåŠ›ï¼',
        releaseText: 'å‘å°„äº†ç”µå…‰æŸï¼',
        chargeBoost: { spa: 1 },
    },
    // ============================================
    // ç¬¬äºŒç±»ï¼šåŠæ— æ•ŒçŠ¶æ€å‹
    // ============================================
    'Fly': {
        type: 'invuln',
        status: 'flying',
        chargeText: 'é£å‘äº†å¤©ç©ºï¼',
        releaseText: 'ä¿¯å†²æ”»å‡»ï¼',
        vulnerableTo: ['Thunder', 'Hurricane', 'Sky Uppercut', 'Smack Down', 'Thousand Arrows'],
    },
    'Bounce': {
        type: 'invuln',
        status: 'flying',
        chargeText: 'è·³å‘äº†é«˜ç©ºï¼',
        releaseText: 'çŒ›çƒˆåœ°è½ä¸‹ï¼',
        vulnerableTo: ['Thunder', 'Hurricane', 'Sky Uppercut', 'Smack Down', 'Thousand Arrows'],
    },
    'Dig': {
        type: 'invuln',
        status: 'underground',
        chargeText: 'é’»è¿›äº†åœ°ä¸‹ï¼',
        releaseText: 'ä»åœ°ä¸‹å‘åŠ¨æ”»å‡»ï¼',
        vulnerableTo: ['Earthquake', 'Magnitude', 'Fissure'],
        doubleDamageFrom: ['Earthquake', 'Magnitude'], // è¿™äº›æ‹›å¼å¯¹åœ°ä¸‹ç›®æ ‡åŒå€ä¼¤å®³
    },
    'Dive': {
        type: 'invuln',
        status: 'underwater',
        chargeText: 'æ½œå…¥äº†æ°´ä¸­ï¼',
        releaseText: 'ä»æ°´ä¸­å‘åŠ¨æ”»å‡»ï¼',
        vulnerableTo: ['Surf', 'Whirlpool'],
        doubleDamageFrom: ['Surf', 'Whirlpool'],
    },
    'Phantom Force': {
        type: 'invuln',
        status: 'shadow',
        chargeText: 'æ¶ˆå¤±åœ¨äº†å¼‚æ¬¡å…ƒä¸­...',
        releaseText: 'ä»å¼‚æ¬¡å…ƒå‘åŠ¨äº†æ”»å‡»ï¼',
        breaksProtect: true, // ç©¿é€å®ˆä½
    },
    'Shadow Force': {
        type: 'invuln',
        status: 'shadow',
        chargeText: 'æ¶ˆå¤±åœ¨äº†æš—å½±ä¸­...',
        releaseText: 'ä»æš—å½±ä¸­å‘åŠ¨äº†æ”»å‡»ï¼',
        breaksProtect: true,
    },
    // ============================================
    // ç¬¬ä¸‰ç±»ï¼šçº¯è“„åŠ›/å¼ºåŒ–å‹
    // ============================================
    'Meteor Beam': {
        type: 'buff',
        chargeText: 'æº¢å‡ºäº†å®‡å®™èƒ½é‡ï¼',
        releaseText: 'å‘å°„äº†æµæ˜Ÿå…‰æŸï¼',
        chargeBoost: { spa: 1 },
    },
    'Skull Bash': {
        type: 'buff',
        chargeText: 'ç¼©èµ·äº†å¤´ï¼',
        releaseText: 'çŒ›çƒˆåœ°æ’å‡»ï¼',
        chargeBoost: { def: 1 },
    },
    'Sky Attack': {
        type: 'buff',
        chargeText: 'å‘å‡ºäº†è€€çœ¼çš„å…‰èŠ’ï¼',
        releaseText: 'å‘åŠ¨äº†ç¥é¸Ÿæ”»å‡»ï¼',
        highCrit: true, // é«˜æš´å‡»ç‡
    },
    'Razor Wind': {
        type: 'buff',
        chargeText: 'å·èµ·äº†ç‹‚é£ï¼',
        releaseText: 'é‡Šæ”¾äº†çœŸç©ºæ–©ï¼',
        highCrit: true,
    },
    'Freeze Shock': {
        type: 'buff',
        chargeText: 'è¢«å†°å†·çš„ç”µæµåŒ…å›´äº†ï¼',
        releaseText: 'é‡Šæ”¾äº†å†°å†»ä¼ç‰¹ï¼',
    },
    'Ice Burn': {
        type: 'buff',
        chargeText: 'è¢«æå¯’çš„ç«ç„°åŒ…å›´äº†ï¼',
        releaseText: 'é‡Šæ”¾äº†æå¯’å†·ç„°ï¼',
    },
    'Geomancy': {
        type: 'buff',
        chargeText: 'å¸æ”¶äº†å¤§åœ°çš„åŠ›é‡ï¼',
        releaseText: 'é‡Šæ”¾äº†å¤§åœ°æŒæ§ï¼',
        isStatusMove: true, // è¿™æ˜¯å˜åŒ–æŠ€ï¼Œä¸é€ æˆä¼¤å®³
        releaseBoost: { spa: 2, spd: 2, spe: 2 }, // é‡Šæ”¾æ—¶çš„èƒ½åŠ›æå‡
    },
    'Beak Blast': {
        type: 'buff',
        chargeText: 'åŠ çƒ­äº†é¸Ÿå˜´ï¼',
        releaseText: 'å‘å°„äº†é¸Ÿå˜´åŠ å†œç‚®ï¼',
        contactBurn: true, // è“„åŠ›æœŸé—´è¢«æ¥è§¦ä¼šçƒ§ä¼¤å¯¹æ‰‹
    },
    'Focus Punch': {
        type: 'buff',
        chargeText: 'é›†ä¸­äº†ç²¾ç¥ï¼',
        releaseText: 'å‘å‡ºäº†çœŸæ°”æ‹³ï¼',
        interruptOnHit: true, // è¢«æ”»å‡»ä¼šä¸­æ–­
    },
    'Sky Drop': {
        type: 'invuln',
        status: 'flying',
        chargeText: 'æŠ“ä½å¯¹æ‰‹é£å‘äº†å¤©ç©ºï¼',
        releaseText: 'å°†å¯¹æ‰‹æ‘”è½ï¼',
        grabsTarget: true, // ç‰¹æ®Šï¼šåŒæ—¶è®©ç›®æ ‡è¿›å…¥åŠæ— æ•ŒçŠ¶æ€
    },
};
/**
 * æ£€æŸ¥æŠ€èƒ½æ˜¯å¦ä¸ºè“„åŠ›æŠ€èƒ½ï¼ˆä» moves-data.js è¯»å– flags.chargeï¼‰
 * @param {string} moveName æŠ€èƒ½åç§°
 * @returns {object|null} è“„åŠ›é…ç½®æˆ– null
 */
export function getChargeMoveConfig(moveName) {
    // 1. ä» moves-data.js æ£€æŸ¥ flags.charge
    const moveId = (moveName || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const MOVES = (typeof window !== 'undefined' && window.MOVES) ? window.MOVES : null;
    const moveData = MOVES ? MOVES[moveId] : null;
    // å¦‚æœ moves-data.js ä¸­æ²¡æœ‰ charge æ ‡è®°ï¼Œåˆ™ä¸æ˜¯è“„åŠ›æŠ€èƒ½
    if (!moveData || !moveData.flags || !moveData.flags.charge) {
        return null;
    }
    // 2. è·å–é¢å¤–é…ç½®ï¼ˆè“„åŠ›æ–‡æœ¬ã€å¤©æ°”è”åŠ¨ç­‰ï¼‰
    const extraConfig = CHARGE_MOVE_CONFIG[moveName] || {};
    // 3. ç”Ÿæˆé»˜è®¤é…ç½®ï¼ˆå¦‚æœæ²¡æœ‰é¢å¤–é…ç½®ï¼‰
    const defaultConfig = {
        type: 'buff', // é»˜è®¤ç±»å‹
        chargeText: 'æ­£åœ¨è“„åŠ›...',
        releaseText: 'å‘åŠ¨äº†æ”»å‡»ï¼',
    };
    // 4. ä» moves-data.js è¯»å–é¢å¤–ä¿¡æ¯
    // æ£€æŸ¥æ˜¯å¦æœ‰ boostsï¼ˆå¦‚ Meteor Beam çš„ç‰¹æ”»+1ï¼‰
    if (moveData.onTryMove === null && moveData.boosts) {
        // Geomancy ç­‰æŠ€èƒ½åœ¨é‡Šæ”¾æ—¶æå‡èƒ½åŠ›
        extraConfig.releaseBoost = extraConfig.releaseBoost || moveData.boosts;
    }
    // æ£€æŸ¥æ˜¯å¦ç©¿é€å®ˆä½ï¼ˆPhantom Force, Shadow Forceï¼‰
    if (moveData.breaksProtect) {
        extraConfig.breaksProtect = true;
    }
    // åˆå¹¶é…ç½®
    return { ...defaultConfig, ...extraConfig, moveData };
}
/**
 * æ£€æŸ¥æŠ€èƒ½æ˜¯å¦ä¸ºè“„åŠ›æŠ€èƒ½ï¼ˆç®€åŒ–ç‰ˆï¼Œä»…æ£€æŸ¥ flags.chargeï¼‰
 * @param {string} moveName æŠ€èƒ½åç§°
 * @returns {boolean}
 */
export function isChargeMove(moveName) {
    const moveId = (moveName || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const MOVES = (typeof window !== 'undefined' && window.MOVES) ? window.MOVES : null;
    const moveData = MOVES ? MOVES[moveId] : null;
    return !!(moveData && moveData.flags && moveData.flags.charge);
}
// å…¼å®¹æ—§ä»£ç ï¼šCHARGE_MOVES åˆ«å
export const CHARGE_MOVES = CHARGE_MOVE_CONFIG;
/**
 * æ£€æŸ¥æ˜¯å¦æ»¡è¶³ç¬å‘æ¡ä»¶
 * @param {Pokemon} user ä½¿ç”¨è€…
 * @param {object} config è“„åŠ›é…ç½®
 * @param {object} battle æˆ˜æ–—çŠ¶æ€
 * @returns {object} { canSkip: boolean, reason: string, consumeItem: boolean }
 */
export function checkInstantCondition(user, config, battle) {
    // 1. å¤©æ°”è”åŠ¨å‹ï¼šæ£€æŸ¥å¤©æ°”
    if (config.type === 'weather' && config.weather) {
        const currentWeather = battle?.weather || null;
        if (currentWeather && config.weather.includes(currentWeather)) {
            return { canSkip: true, reason: 'weather', consumeItem: false };
        }
    }
    // 2. å¼ºåŠ›é¦™è‰ (Power Herb)ï¼šæ¶ˆè€—é“å…·è·³è¿‡è“„åŠ›
    const userItem = (user.item || '').toLowerCase().replace(/[^a-z]/g, '');
    if (userItem === 'powerherb') {
        return { canSkip: true, reason: 'powerherb', consumeItem: true };
    }
    return { canSkip: false, reason: null, consumeItem: false };
}
/**
 * å¤„ç†è“„åŠ›æŠ€èƒ½çš„ç¬¬ä¸€å›åˆï¼ˆè“„åŠ›é˜¶æ®µï¼‰
 * @param {Pokemon} user ä½¿ç”¨è€…
 * @param {object} move æŠ€èƒ½
 * @param {object} config è“„åŠ›é…ç½®
 * @param {object} battle æˆ˜æ–—çŠ¶æ€
 * @param {Array} logs æ—¥å¿—æ•°ç»„
 * @returns {object} { charging: true, skipDamage: true }
 */
export function handleChargePhase(user, move, config, battle, logs) {
    // è®¾ç½®è“„åŠ›çŠ¶æ€
    user.volatile = user.volatile || {};
    user.volatile.chargingMove = move.name;
    // åŠæ— æ•ŒçŠ¶æ€
    if (config.type === 'invuln' && config.status) {
        user.volatile[config.status] = true;
    }
    // è“„åŠ›æœŸé—´çš„èƒ½åŠ›æå‡
    if (config.chargeBoost) {
        for (const [stat, stages] of Object.entries(config.chargeBoost)) {
            if (user.applyBoost) {
                user.applyBoost(stat, stages);
                const statNames = { atk: 'æ”»å‡»', def: 'é˜²å¾¡', spa: 'ç‰¹æ”»', spd: 'ç‰¹é˜²', spe: 'é€Ÿåº¦' };
                logs.push(`${user.cnName} çš„${statNames[stat] || stat}æå‡äº†ï¼`);
            }
        }
    }
    // è¾“å‡ºè“„åŠ›æ–‡æœ¬
    logs.push(`${user.cnName} ${config.chargeText}`);
    return { charging: true, skipDamage: true };
}
/**
 * å¤„ç†è“„åŠ›æŠ€èƒ½çš„ç¬¬äºŒå›åˆï¼ˆé‡Šæ”¾é˜¶æ®µï¼‰
 * @param {Pokemon} user ä½¿ç”¨è€…
 * @param {object} move æŠ€èƒ½
 * @param {object} config è“„åŠ›é…ç½®
 * @param {object} battle æˆ˜æ–—çŠ¶æ€
 * @param {Array} logs æ—¥å¿—æ•°ç»„
 * @returns {object} { released: true }
 */
export function handleReleasePhase(user, move, config, battle, logs) {
    // æ¸…é™¤è“„åŠ›çŠ¶æ€
    if (user.volatile) {
        delete user.volatile.chargingMove;
        // æ¸…é™¤åŠæ— æ•ŒçŠ¶æ€
        if (config.type === 'invuln' && config.status) {
            delete user.volatile[config.status];
        }
    }
    // é‡Šæ”¾æ—¶çš„èƒ½åŠ›æå‡ï¼ˆå¦‚ Geomancyï¼‰
    if (config.releaseBoost) {
        for (const [stat, stages] of Object.entries(config.releaseBoost)) {
            if (user.applyBoost) {
                user.applyBoost(stat, stages);
                const statNames = { atk: 'æ”»å‡»', def: 'é˜²å¾¡', spa: 'ç‰¹æ”»', spd: 'ç‰¹é˜²', spe: 'é€Ÿåº¦' };
                const changeText = stages >= 2 ? 'å¤§å¹…' : '';
                logs.push(`${user.cnName} çš„${statNames[stat] || stat}${changeText}æå‡äº†ï¼`);
            }
        }
    }
    // è¾“å‡ºé‡Šæ”¾æ–‡æœ¬
    logs.push(`${user.cnName} ${config.releaseText}`);
    return { released: true };
}
/**
 * æ£€æŸ¥ç›®æ ‡æ˜¯å¦å¤„äºåŠæ— æ•ŒçŠ¶æ€
 * @param {Pokemon} target ç›®æ ‡
 * @param {object} move æ”»å‡»æ‹›å¼
 * @returns {object} { invulnerable: boolean, canHit: boolean, doubleDamage: boolean }
 */
export function checkInvulnerability(target, move) {
    if (!target.volatile) {
        return { invulnerable: false, canHit: true, doubleDamage: false };
    }
    const moveName = move.name || '';
    // æ£€æŸ¥å„ç§åŠæ— æ•ŒçŠ¶æ€
    for (const [chargeName, config] of Object.entries(CHARGE_MOVES)) {
        if (config.type !== 'invuln' || !config.status) continue;
        if (target.volatile[config.status]) {
            // ç›®æ ‡å¤„äºåŠæ— æ•ŒçŠ¶æ€
            const vulnerableTo = config.vulnerableTo || [];
            const doubleDamageFrom = config.doubleDamageFrom || [];
            if (vulnerableTo.includes(moveName)) {
                // å¯ä»¥å‘½ä¸­ï¼Œå¯èƒ½åŒå€ä¼¤å®³
                return {
                    invulnerable: true,
                    canHit: true,
                    doubleDamage: doubleDamageFrom.includes(moveName),
                    status: config.status,
                };
            }
            // æ— æ³•å‘½ä¸­
            return {
                invulnerable: true,
                canHit: false,
                doubleDamage: false,
                status: config.status,
            };
        }
    }
    return { invulnerable: false, canHit: true, doubleDamage: false };
}
/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ­£åœ¨è“„åŠ›æŸä¸ªæŠ€èƒ½
 * @param {Pokemon} user ä½¿ç”¨è€…
 * @returns {string|null} æ­£åœ¨è“„åŠ›çš„æŠ€èƒ½åç§°ï¼Œæˆ– null
 */
export function getChargingMove(user) {
    return user.volatile?.chargingMove || null;
}
/**
 * å¼ºåˆ¶æ¸…é™¤è“„åŠ›çŠ¶æ€ï¼ˆç”¨äºæ¢äººã€æ¿’æ­»ç­‰æƒ…å†µï¼‰
 * @param {Pokemon} pokemon å®å¯æ¢¦
 */
export function clearChargingState(pokemon) {
    if (!pokemon.volatile) return;
    const chargingMove = pokemon.volatile.chargingMove;
    if (chargingMove) {
        const config = CHARGE_MOVES[chargingMove];
        if (config && config.type === 'invuln' && config.status) {
            delete pokemon.volatile[config.status];
        }
        delete pokemon.volatile.chargingMove;
    }
}
/**
 * æ£€æŸ¥ Focus Punch æ˜¯å¦è¢«ä¸­æ–­
 * @param {Pokemon} user ä½¿ç”¨è€…
 * @param {number} damageTaken æœ¬å›åˆå—åˆ°çš„ä¼¤å®³
 * @returns {boolean} æ˜¯å¦è¢«ä¸­æ–­
 */
export function checkFocusPunchInterrupt(user, damageTaken) {
    if (!user.volatile?.chargingMove) return false;
    const config = CHARGE_MOVES[user.volatile.chargingMove];
    if (config && config.interruptOnHit && damageTaken > 0) {
        clearChargingState(user);
        return true;
    }
    return false;
}
/**
 * æ£€æŸ¥ Beak Blast çš„æ¥è§¦çƒ§ä¼¤æ•ˆæœ
 * @param {Pokemon} user æ­£åœ¨è“„åŠ›çš„å®å¯æ¢¦
 * @param {Pokemon} attacker æ”»å‡»è€…
 * @param {object} move æ”»å‡»æ‹›å¼
 * @param {Array} logs æ—¥å¿—æ•°ç»„
 * @returns {boolean} æ˜¯å¦è§¦å‘çƒ§ä¼¤
 */
export function checkBeakBlastBurn(user, attacker, move, logs) {
    if (!user.volatile?.chargingMove) return false;
    const config = CHARGE_MOVES[user.volatile.chargingMove];
    if (!config || !config.contactBurn) return false;
    // æ£€æŸ¥æ˜¯å¦ä¸ºæ¥è§¦ç±»æ‹›å¼
    const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    const isContact = fullMoveData.flags?.contact || move.contact;
    if (isContact && !attacker.status) {
        attacker.status = 'brn';
        logs.push(`ğŸ”¥ ${attacker.cnName} è¢« ${user.cnName} åŠ çƒ­çš„é¸Ÿå˜´çƒ§ä¼¤äº†ï¼`);
        return true;
    }
    return false;
}
// ============================================
// å¯¼å‡ºåˆ°å…¨å±€
// ============================================
if (typeof window !== 'undefined') {
    window.CHARGE_MOVES = CHARGE_MOVES;
    window.getChargeMoveConfig = getChargeMoveConfig;
    window.checkInstantCondition = checkInstantCondition;
    window.handleChargePhase = handleChargePhase;
    window.handleReleasePhase = handleReleasePhase;
    window.checkInvulnerability = checkInvulnerability;
    window.getChargingMove = getChargingMove;
    window.clearChargingState = clearChargingState;
    window.checkFocusPunchInterrupt = checkFocusPunchInterrupt;
    window.checkBeakBlastBurn = checkBeakBlastBurn;
}
console.log('[CHARGE MOVES] è“„åŠ›æŠ€èƒ½ç³»ç»Ÿå·²åŠ è½½');
]]></file>
        <file name="items-data.js"><![CDATA[/**
 * ===========================================
 * ITEMS-DATA.JS - é“å…·æ•°æ®åº“
 * ===========================================
 * 
 * é›†ä¸­ç®¡ç†æ‰€æœ‰é“å…·æ•°æ®ï¼Œæ¶ˆé™¤ç¡¬ç¼–ç 
 * å‚è€ƒ Showdown çš„ items.ts ç»“æ„
 * 
 * èŒè´£:
 * - é“å…·åŸºç¡€æ•°æ® (åç§°ã€ç±»å‹ã€æ•ˆæœ)
 * - é“å…·åˆ†ç±»å¸¸é‡
 * - é“å…·æ•ˆæœå¤„ç†å™¨
 */
// ============================================
// é“å…·æ•°æ®åº“
// ============================================
export const ITEMS = {
    // ========== æˆ˜æ–—é“å…· (Battle Items) ==========
    // --- æ°”åŠ¿æŠ«å¸¦ (Focus Sash) ---
    focussash: {
        id: 'focussash',
        name: 'Focus Sash',
        cnName: 'æ°”åŠ¿æŠ«å¸¦',
        category: 'held',
        consumable: true,
        fling: { basePower: 10 },
        // æ•ˆæœ: æ»¡è¡€æ—¶ï¼Œè‡´å‘½ä¼¤å®³åªä¼šè®© HP å‰© 1
        effect: 'surviveLethal',
        description: 'å½“æŒæœ‰è€…HPæ»¡æ—¶ï¼Œå—åˆ°è‡´å‘½ä¼¤å®³ä¼šä¿ç•™1ç‚¹HPï¼ˆä¸€æ¬¡æ€§ï¼‰',
    },
    // --- è®²ç©¶ç³»åˆ— (Choice Items) ---
    choiceband: {
        id: 'choiceband',
        name: 'Choice Band',
        cnName: 'è®²ç©¶å¤´å¸¦',
        category: 'held',
        consumable: false,
        fling: { basePower: 10 },
        effect: 'choiceLock',
        statBoost: { atk: 1.5 },
        isChoice: true,
        description: 'ç‰©æ”»x1.5ï¼Œä½†åªèƒ½ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰æ‹©çš„æ‹›å¼',
    },
    choicescarf: {
        id: 'choicescarf',
        name: 'Choice Scarf',
        cnName: 'è®²ç©¶å›´å·¾',
        category: 'held',
        consumable: false,
        fling: { basePower: 10 },
        effect: 'choiceLock',
        statBoost: { spe: 1.5 },
        isChoice: true,
        description: 'é€Ÿåº¦x1.5ï¼Œä½†åªèƒ½ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰æ‹©çš„æ‹›å¼',
    },
    choicespecs: {
        id: 'choicespecs',
        name: 'Choice Specs',
        cnName: 'è®²ç©¶çœ¼é•œ',
        category: 'held',
        consumable: false,
        fling: { basePower: 10 },
        effect: 'choiceLock',
        statBoost: { spa: 1.5 },
        isChoice: true,
        description: 'ç‰¹æ”»x1.5ï¼Œä½†åªèƒ½ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰æ‹©çš„æ‹›å¼',
    },
    // --- ç”Ÿå‘½å®ç  (Life Orb) ---
    lifeorb: {
        id: 'lifeorb',
        name: 'Life Orb',
        cnName: 'ç”Ÿå‘½å®ç ',
        category: 'held',
        consumable: false,
        fling: { basePower: 30 },
        effect: 'lifeOrb',
        damageBoost: 1.3,
        recoilPercent: 0.1, // 10% æœ€å¤§HP
        description: 'æ”»å‡»ä¼¤å®³x1.3ï¼Œä½†æ¯æ¬¡æ”»å‡»æŸå¤±10%æœ€å¤§HP',
    },
    // --- å‰©é¥­ (Leftovers) ---
    leftovers: {
        id: 'leftovers',
        name: 'Leftovers',
        cnName: 'å‰©é¥­',
        category: 'held',
        consumable: false,
        fling: { basePower: 10 },
        effect: 'endOfTurnHeal',
        healPercent: 1/16, // æ¯å›åˆæ¢å¤ 1/16 æœ€å¤§HP
        description: 'æ¯å›åˆç»“æŸæ—¶æ¢å¤1/16æœ€å¤§HP',
    },
    // --- é»‘è‰²æ·¤æ³¥ (Black Sludge) ---
[... truncated: only first 100 lines included ...]
]]></file>
        <file name="move-effects.js"><![CDATA[/**
 * =============================================
 * MOVE EFFECTS - æŠ€èƒ½æ•ˆæœæ‰©å±•æ¨¡å—
 * =============================================
 * 
 * å¤„ç† moves-data.js ä¸­çš„é€šç”¨å­—æ®µï¼Œå®ç°é«˜çº§æˆ˜æ–—æœºåˆ¶ï¼š
 * - ä¼˜å…ˆçº§ (Priority)
 * - çŠ¶æ€å¼‚å¸¸ (Status Conditions)
 * - å¤©æ°”æ•ˆæœ (Weather)
 * - åœºåœ°æ•ˆæœ (Terrain)
 * - ç‰¹æ®ŠæŠ€èƒ½æ ‡è®° (Flags)
 * - å›ºå®šä¼¤å®³æŠ€èƒ½
 * - ä¸€å‡»å¿…æ€æŠ€èƒ½
 */
// ========== ä¼˜å…ˆçº§ç³»ç»Ÿ (Priority) ==========
// å†³å®šå›åˆå†…çš„è¡ŒåŠ¨é¡ºåº
/**
 * è·å–æŠ€èƒ½ä¼˜å…ˆçº§
 * @param {object} move æŠ€èƒ½æ•°æ®
 * @param {object} user ä½¿ç”¨è€…ï¼ˆå¯é€‰ï¼Œç”¨äºç‰¹æ€§ä¿®æ­£ï¼‰
 * @param {object} target ç›®æ ‡ï¼ˆå¯é€‰ï¼Œç”¨äºæ¶ä½œå‰§ä¹‹å¿ƒå…ç–«åˆ¤å®šï¼‰
 * @returns {number} ä¼˜å…ˆçº§ (-7 ~ +5)
 */
function getMovePriority(move, user = null, target = null) {
    // ã€å¤æ­¦ç³»ç»Ÿã€‘å¦‚æœæ‹›å¼å¯¹è±¡å·²æœ‰ priority å±æ€§ï¼ˆè¢« style ä¿®æ”¹è¿‡ï¼‰ï¼Œç›´æ¥ä½¿ç”¨
    if (typeof move.priority === 'number') {
        return move.priority;
    }
    const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    // ä»æ•°æ®ä¸­è¯»å–ä¼˜å…ˆçº§
    let basePriority = 0;
    if (typeof fullMoveData.priority === 'number') {
        basePriority = fullMoveData.priority;
    }
    // ç¡¬ç¼–ç å¸¸è§ä¼˜å…ˆçº§æŠ€èƒ½ï¼ˆå¦‚æœæ•°æ®åº“æ²¡æœ‰ï¼‰
    if (basePriority === 0) {
        const priorityMap = {
            // +5
            'Helping Hand': 5,
            // +4
            'Protect': 4, 'Detect': 4, 'Endure': 4, 'Magic Coat': 4, 'Snatch': 4,
            'Baneful Bunker': 4, 'Spiky Shield': 4, "King's Shield": 4, 'Obstruct': 4,
            'Silk Trap': 4, 'Burning Bulwark': 4,
            // +3
            'Fake Out': 3, 'Quick Guard': 3, 'Wide Guard': 3, 'Crafty Shield': 3,
            // +2
            'Extreme Speed': 2, 'Feint': 2, 'First Impression': 2, 'Accelerock': 2,
            // +1
            'Aqua Jet': 1, 'Baby-Doll Eyes': 1, 'Bullet Punch': 1, 'Ice Shard': 1,
            'Mach Punch': 1, 'Quick Attack': 1, 'Shadow Sneak': 1, 'Sucker Punch': 1,
            'Vacuum Wave': 1, 'Water Shuriken': 1, 'Grassy Glide': 1, 'Jet Punch': 1,
            // -1
            'Vital Throw': -1,
            // -3
            'Focus Punch': -3,
            // -4
            'Avalanche': -4, 'Revenge': -4,
            // -5
            'Counter': -5, 'Mirror Coat': -5,
            // -6
            'Circle Throw': -6, 'Dragon Tail': -6, 'Roar': -6, 'Whirlwind': -6, 'Teleport': -6,
            // -7
            'Trick Room': -7
        };
        basePriority = priorityMap[move.name] || 0;
    }
    // === ã€æ¶ä½œå‰§ä¹‹å¿ƒ Pranksterã€‘ç‰¹æ€§å¤„ç† ===
    // å˜åŒ–æŠ€ä¼˜å…ˆåº¦+1ï¼Œä½†å¯¹æ¶ç³»ç›®æ ‡æ— æ•ˆ
    if (user && user.ability === 'Prankster') {
        const category = fullMoveData.category || (move.cat === 'spec' ? 'Special' : (move.cat === 'phys' ? 'Physical' : 'Status'));
        if (category === 'Status' || move.cat === 'status') {
            // æ£€æŸ¥ç›®æ ‡æ˜¯å¦ä¸ºæ¶ç³»ï¼ˆæ¶ç³»å…ç–«æ¶ä½œå‰§ä¹‹å¿ƒçš„å˜åŒ–æŠ€ï¼‰
            if (target && target.types && target.types.includes('Dark')) {
                console.log(`[PRANKSTER] ${target.cnName} æ˜¯æ¶å±æ€§ï¼Œå…ç–«æ¶ä½œå‰§ä¹‹å¿ƒçš„å˜åŒ–æŠ€ï¼`);
                // è¿”å›ä¸€ä¸ªç‰¹æ®Šæ ‡è®°ï¼Œè®©è°ƒç”¨æ–¹çŸ¥é“æŠ€èƒ½æ— æ•ˆ
                move.pranksterBlocked = true;
            } else {
                basePriority += 1;
                console.log(`[PRANKSTER] ${user.cnName} çš„æ¶ä½œå‰§ä¹‹å¿ƒä½¿ ${move.name} ä¼˜å…ˆåº¦+1`);
            }
        }
    }
    // === ã€ç–¾é£ä¹‹ç¿¼ Gale Wingsã€‘ç‰¹æ€§å¤„ç† ===
    // æ»¡è¡€æ—¶é£è¡Œç³»æ‹›å¼ä¼˜å…ˆåº¦+1
    if (user && user.ability === 'Gale Wings' && move.type === 'Flying') {
        if (user.currHp === user.maxHp) {
            basePriority += 1;
            console.log(`[GALE WINGS] ${user.cnName} çš„ç–¾é£ä¹‹ç¿¼ä½¿é£è¡Œç³»æ‹›å¼ä¼˜å…ˆåº¦+1`);
        }
    }
    // === ã€æ…¢å‡º Stallã€‘ç‰¹æ€§å¤„ç† ===
[... truncated: only first 100 lines included ...]
]]></file>
        <file name="move-handlers.js"><![CDATA[/**
 * =============================================
 * MOVE HANDLERS - æŠ€èƒ½å¤„ç†å™¨ (ç­–ç•¥æ¨¡å¼)
 * =============================================
 * 
 * æœ¬æ–‡ä»¶ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¤„ç†ç‰¹æ®ŠæŠ€èƒ½é€»è¾‘ï¼Œ
 * é¿å…åœ¨ battle-engine.js ä¸­å †ç§¯å¤§é‡ if-elseã€‚
 * 
 * æ¯ä¸ªæŠ€èƒ½å¯ä»¥æ³¨å†Œä»¥ä¸‹é’©å­ï¼š
 * - basePowerCallback: åŠ¨æ€è®¡ç®—å¨åŠ›
 * - damageCallback: å®Œå…¨è‡ªå®šä¹‰ä¼¤å®³è®¡ç®—
 * - onHit: å‘½ä¸­åçš„é¢å¤–æ•ˆæœ
 * - onMiss: æœªå‘½ä¸­æ—¶çš„æ•ˆæœ
 * - onUse: ä½¿ç”¨æ—¶çš„æ•ˆæœï¼ˆè“„åŠ›ç­‰ï¼‰
 * - onAfterHit: å‘½ä¸­åçš„é¢å¤–æ•ˆæœï¼ˆå¸¦ä¼¤å®³å‚æ•°ï¼‰
 * - modifyAtk: ä¿®æ”¹æ”»å‡»åŠ›è®¡ç®—
 * - modifyDef: ä¿®æ”¹é˜²å¾¡åŠ›è®¡ç®—
 */
// ============================================
// è¾…åŠ©å‡½æ•°
// ============================================
/**
 * ã€ç»Ÿä¸€å›å¤å‡½æ•°ã€‘å¤„ç† HP å›å¤ï¼Œè‡ªåŠ¨åº”ç”¨ç¯å¢ƒå›¾å±‚ä¿®æ­£
 * @param {Pokemon} pokemon è¦å›å¤çš„å®å¯æ¢¦
 * @param {number} baseAmount åŸºç¡€å›å¤é‡
 * @param {string} source å›å¤æ¥æºï¼ˆç”¨äºæ—¥å¿—ï¼‰
 * @returns {number} å®é™…å›å¤é‡
 */
function applyHeal(pokemon, baseAmount, source = 'move') {
    if (baseAmount <= 0) return 0;
    const maxHeal = pokemon.maxHp - pokemon.currHp;
    if (maxHeal <= 0) return 0;
    // ä¼˜å…ˆä½¿ç”¨ WeatherEffects.applyHealï¼ˆåŒ…å«ç¯å¢ƒå›¾å±‚ä¿®æ­£ï¼‰
    if (typeof window !== 'undefined' && window.WeatherEffects?.applyHeal) {
        return window.WeatherEffects.applyHeal(pokemon, baseAmount, { source });
    }
    // Fallback: æ‰‹åŠ¨åº”ç”¨ä¿®æ­£
    let actualHeal = baseAmount;
    // ç¯å¢ƒå›¾å±‚ä¿®æ­£
    if (typeof window !== 'undefined' && window.envOverlay?.getHealMod) {
        const envMult = window.envOverlay.getHealMod(pokemon);
        if (envMult !== 1) {
            const before = actualHeal;
            actualHeal = Math.floor(actualHeal * envMult);
            console.log(`[ENV OVERLAY] ğŸŒ ç¯å¢ƒå›å¤ä¿®æ­£: ${before} -> ${actualHeal} (x${envMult})`);
        }
    }
    actualHeal = Math.min(actualHeal, maxHeal);
    pokemon.currHp += actualHeal;
    return actualHeal;
}
/**
 * å¤„ç†è“„åŠ›æŠ€èƒ½çš„ onUse é’©å­
 * ç»Ÿä¸€å¤„ç†å¤©æ°”è”åŠ¨ã€å¼ºåŠ›é¦™è‰ã€è“„åŠ›çŠ¶æ€ç­‰é€»è¾‘
 * @param {Pokemon} attacker æ”»å‡»æ–¹
 * @param {string} moveName æŠ€èƒ½åç§°
 * @param {object} battle æˆ˜æ–—çŠ¶æ€
 * @param {Array} logs æ—¥å¿—æ•°ç»„
 * @returns {object} { skipDamage, charging, released }
 */
function handleChargeMoveOnUse(attacker, moveName, battle, logs) {
    // è·å–è“„åŠ›é…ç½®
    const config = (typeof getChargeMoveConfig === 'function') 
        ? getChargeMoveConfig(moveName) 
        : (typeof window !== 'undefined' && window.CHARGE_MOVES) 
            ? window.CHARGE_MOVES[moveName] 
            : null;
    if (!config) {
        // æ²¡æœ‰é…ç½®ï¼Œç›´æ¥æ‰§è¡Œ
        return {};
    }
    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨è“„åŠ›ä¸­ï¼ˆç¬¬äºŒå›åˆï¼‰
    const chargingMove = attacker.volatile?.chargingMove;
    if (chargingMove === moveName) {
        // ç¬¬äºŒå›åˆï¼šé‡Šæ”¾æ”»å‡»
        if (attacker.volatile) {
            delete attacker.volatile.chargingMove;
            // æ¸…é™¤åŠæ— æ•ŒçŠ¶æ€
            if (config.type === 'invuln' && config.status) {
                delete attacker.volatile[config.status];
            }
        }
        // é‡Šæ”¾æ—¶çš„èƒ½åŠ›æå‡ï¼ˆå¦‚ Geomancyï¼‰
        if (config.releaseBoost) {
            const statNames = { atk: 'æ”»å‡»', def: 'é˜²å¾¡', spa: 'ç‰¹æ”»', spd: 'ç‰¹é˜²', spe: 'é€Ÿåº¦' };
            for (const [stat, stages] of Object.entries(config.releaseBoost)) {
                if (attacker.applyBoost) {
                    attacker.applyBoost(stat, stages);
[... truncated: only first 100 lines included ...]
]]></file>
        <file name="weather-effects.js"><![CDATA[/**
 * =============================================
 * WEATHER EFFECTS - å¤©æ°”æ•ˆæœæ ¸å¿ƒæ¨¡å—
 * =============================================
 * 
 * ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å¤©æ°”çš„æœºåˆ¶é€»è¾‘ï¼š
 * - å¤©æ°”ä¼¤å®³/å›å¤
 * - å¤©æ°”å…ç–«ç±»å‹
 * - å¤©æ°”å¯¹æ‹›å¼å¨åŠ›çš„ä¿®æ­£
 * - å¤©æ°”å¯¹å‘½ä¸­ç‡çš„ä¿®æ­£
 * - å¤©æ°”å¯¹é˜²å¾¡çš„ä¿®æ­£
 * 
 * ä¾èµ–: æ— ï¼ˆçº¯æ•°æ®æ¨¡å—ï¼‰
 */
// ============================================
// å¤©æ°” ID æ ‡å‡†åŒ–
// ============================================
/**
 * æ ‡å‡†åŒ–å¤©æ°” ID
 * - å†°é›¹ (hail) -> é›ªå¤© (snow)
 * - å…¶ä»–ä¿æŒä¸å˜
 * @param {string} weatherId åŸå§‹å¤©æ°” ID
 * @returns {string} æ ‡å‡†åŒ–åçš„å¤©æ°” ID
 */
export function normalizeWeatherId(weatherId) {
    if (!weatherId) return null;
    const id = weatherId.toLowerCase();
    // å†°é›¹ç»Ÿä¸€è½¬æ¢ä¸ºé›ªå¤© (SVæœºåˆ¶)
    if (id === 'hail') {
        return 'snow';
    }
    return id;
}
// ============================================
// å¤©æ°”é…ç½®æ•°æ®
// ============================================
/**
 * å¤©æ°”æ•ˆæœé…ç½®
 * é›†ä¸­ç®¡ç†æ‰€æœ‰å¤©æ°”çš„æœºåˆ¶é€»è¾‘
 */
export const WEATHER_CONFIG = {
    // ========== æ™®é€šå¤©æ°” ==========
    rain: {
        name: 'é›¨å¤©',
        icon: 'ğŸŒ§ï¸',
        // å¨åŠ›ä¿®æ­£
        powerModifiers: {
            Water: 1.5,  // æ°´ç³»å¨åŠ› x1.5
            Fire: 0.5    // ç«ç³»å¨åŠ› x0.5
        },
        // å‘½ä¸­ç‡ä¿®æ­£
        accuracyModifiers: {
            Thunder: true,      // é›·ç”µå¿…ä¸­
            Hurricane: true     // æš´é£å¿…ä¸­
        },
        // ç‰¹æ®Šæ•ˆæœ
        effects: {
            solarBeamHalved: true,  // æ—¥å…‰æŸå¨åŠ›å‡åŠ
            weatherBallType: 'Water',
            weatherBallPower: 100
        },
        visualKey: 'rain'
    },
    sun: {
        name: 'æ™´å¤©',
        icon: 'â˜€ï¸',
        powerModifiers: {
            Fire: 1.5,   // ç«ç³»å¨åŠ› x1.5
            Water: 0.5   // æ°´ç³»å¨åŠ› x0.5
        },
        effects: {
            solarBeamInstant: true,    // æ—¥å…‰æŸæ— éœ€è“„åŠ›
            synthesisBoost: true,      // å…‰åˆä½œç”¨å›å¤ 2/3
            morningsunBoost: true,     // æ™¨å…‰å›å¤ 2/3
            moonlightBoost: true,      // æœˆå…‰å›å¤ 2/3
            weatherBallType: 'Fire',
            weatherBallPower: 100
        },
        visualKey: 'sun'
    },
    sandstorm: {
        name: 'æ²™æš´',
        icon: 'ğŸŒªï¸',
        // å›åˆæœ«ä¼¤å®³
        endTurnDamage: {
            fraction: 1/16,
            immuneTypes: ['Rock', 'Ground', 'Steel'],
            immuneAbilities: ['sandveil', 'sandforce', 'sandrush', 'magicguard', 'overcoat']
        },
        // é˜²å¾¡åŠ æˆ
        defenseBoost: {
            types: ['Rock'],
            stat: 'spd',      // ç‰¹é˜²
            multiplier: 1.5
        },
        effects: {
            weatherBallType: 'Rock',
            weatherBallPower: 100
        },
        visualKey: 'sand'
    },
    snow: {
        name: 'é›ªå¤©',
        icon: 'â„ï¸',
        // é˜²å¾¡åŠ æˆ (Gen 9 æœºåˆ¶ï¼šå†°ç³»ç‰©é˜² x1.5)
        defenseBoost: {
            types: ['Ice'],
            stat: 'def',      // ç‰©é˜²
            multiplier: 1.5
        },
        effects: {
            weatherBallType: 'Ice',
            weatherBallPower: 100,
            auroraVeilEnabled: true  // å…è®¸ä½¿ç”¨æå…‰å¹•
        },
        visualKey: 'snow'
    },
    // ========== å§‹æºå¤©æ°” (Primal Weather) ==========
    // ä¸å¯è¢«æ™®é€šå¤©æ°”è¦†ç›–ï¼Œä¸é€’å‡å›åˆ
    harshsun: {
        name: 'å¤§æ—¥ç…§',
        icon: 'ğŸ”¥',
        isPrimal: true,
        powerModifiers: {
            Fire: 1.5,
            Water: 0      // æ°´ç³»æ‹›å¼å®Œå…¨å¤±æ•ˆ
        },
        effects: {
            solarBeamInstant: true,
            synthesisBoost: true,
            morningsunBoost: true,
            moonlightBoost: true,
            weatherBallType: 'Fire',
            weatherBallPower: 100,
            blockWaterMoves: true  // æ°´ç³»æ”»å‡»æ‹›å¼å¤±æ•ˆ
        },
        visualKey: 'harshsun'
    },
    heavyrain: {
        name: 'å¤§é›¨',
        icon: 'ğŸŒŠ',
        isPrimal: true,
        powerModifiers: {
            Water: 1.5,
            Fire: 0       // ç«ç³»æ‹›å¼å®Œå…¨å¤±æ•ˆ
        },
        accuracyModifiers: {
            Thunder: true,
            Hurricane: true
        },
        effects: {
            solarBeamHalved: true,
            weatherBallType: 'Water',
            weatherBallPower: 100,
            blockFireMoves: true   // ç«ç³»æ”»å‡»æ‹›å¼å¤±æ•ˆ
        },
        visualKey: 'heavyrain'
    },
    deltastream: {
        name: 'ä¹±æ°”æµ',
        icon: 'ğŸŒ€',
        isPrimal: true,
        // ç‰¹æ®Šæ•ˆæœï¼šé£è¡Œç³»å¼±ç‚¹å˜ä¸ºæ™®é€šæ•ˆæœ
        effects: {
            flyingWeaknessNeutralized: true,
            weatherBallType: 'Flying',
            weatherBallPower: 100
        },
        visualKey: 'deltastream'
    },
    // ========== ç‰¹æ®Šç¯å¢ƒå¤©æ°” ==========
    // ä»¥ä¸‹å¤©æ°”ä¸ºç¡¬ç¼–ç çš„ç‰¹æ®Šç¯å¢ƒï¼Œå…·æœ‰å¤æ‚çš„æ¸¸æˆæœºåˆ¶
    // æ™®é€šåŒºåŸŸå¤©æ°”ï¼ˆå¦‚ Smogã€Ashfallã€Fogã€Galeï¼‰å·²è¿ç§»è‡³ AI è‡ªå®šä¹‰ JSON æ¥å£
    // å‚è§ docs/ENVIRONMENT_OVERLAY_TEMPLATES.md è·å–æ¨¡æ¿ç¤ºä¾‹
    // ========== Ambrosia ç¥ä¹‹ç¼æµ† (CåŒº - ç¥ç§˜åŒº) ==========
    ambrosia: {
        name: 'ç¥ä¹‹ç¼æµ†',
        icon: 'ğŸŒ¸',
        isEnvironmental: true,  // ç¯å¢ƒå¤©æ°”ï¼Œæ— é™æŒç»­
        effects: {
            // A. å”¯å¿ƒå®ä½“åŒ– (Psychic Mind) - å…¨å‘˜æš´å‡»ç‡ +1
            psychicMind: {
                critBoost: 1,  // å…¨å‘˜æš´å‡»ç­‰çº§ +1
                description: 'ç¥ç§˜ç²‰é›¾å¢å¼ºäº†ç²¾ç¥åŠ›é‡ï¼Œæ‰€æœ‰æ‹›å¼æ›´å®¹æ˜“å‘½ä¸­è¦å®³'
            },
            // B. AVS ç¾ç»Šç³»ç»Ÿå€ç‡ (Trust/Passion/Insight/Devotion)
            avsMultiplier: {
                rate: 2.0,  // AVS è§¦å‘ç‡ x2
                description: 'ç¥ä¹‹ç¼æµ†å¼ºåŒ–äº†è®­ç»ƒå®¶ä¸å®å¯æ¢¦çš„ç¾ç»Š'
            },
            // C. æ—¶ç©ºé†‰ (Neuro-Backlash) - ä½¿ç”¨ç‰¹æ®Šæœºåˆ¶åä¸‹å›åˆæ··ä¹±
            neuroBacklash: {
                enabled: true,
                // è§¦å‘æ¡ä»¶ï¼šMega/Z/Dynamax/Terastal
                triggers: ['mega', 'zmove', 'dynamax', 'terastal'],
                // æ•ˆæœï¼šä¸‹å›åˆå¼€å§‹æ—¶é™·å…¥æ··ä¹±
                effect: 'confusion',
                // ç©¿é€ç¥ç§˜å®ˆæŠ¤
                bypassSafeguard: true,
                // Boss å…ç–«ï¼ˆé€šè¿‡ isAdmin æ ‡è®°ï¼‰
                bossImmune: true,
                description: 'ç¥ç»è´Ÿæ‹…å¯¼è‡´æ—¶ç©ºé†‰ï¼Œä½¿ç”¨ç‰¹æ®Šæœºåˆ¶åå®å¯æ¢¦ä¼šé™·å…¥æ··ä¹±'
            },
            // D. æ— é™åœºåœ° (Infinite Terrain) - è¶…èƒ½/è–„é›¾åœºåœ°æ— é™æŒç»­
            infiniteTerrain: {
                affectedTerrains: ['psychicterrain', 'mistyterrain'],
                description: 'è¶…èƒ½åœºåœ°å’Œè–„é›¾åœºåœ°åœ¨ç¥ä¹‹ç¼æµ†ä¸­æ°¸ä¹…æŒç»­'
            },
            // E. æ±¡æŸ“å›ç« (Contamination Recoil) - é«˜å¨åŠ›æ¯’/æ¶æ‹›å¼åå™¬
            contaminationRecoil: {
                enabled: true,
                // è§¦å‘æ¡ä»¶ï¼šæ¯’/æ¶ç³»æ‹›å¼å¨åŠ› >= 90
                affectedTypes: ['Dark', 'Poison'],
                powerThreshold: 90,
                // åå™¬æ•ˆæœï¼šæš´å‡»ç‡ -1 æˆ– æ··ä¹±
                effects: {
                    critDrop: -1,        // æš´å‡»ç‡ -1
                    confusionChance: 0.3  // 30% å‡ ç‡æ··ä¹±
                },
                description: 'é«˜å¨åŠ›çš„æ¯’/æ¶ç³»æ‹›å¼ä¼šè§¦å‘ç²‰é›¾çš„æ’å¼‚ååº”'
            },
            // å¤©æ°”çƒå˜ä¸ºå¦–ç²¾ç³»
            weatherBallType: 'Fairy',
            weatherBallPower: 100
        },
        visualKey: 'ambrosia'
    },
    // ========== Chronal Rift æ—¶ç©ºè£‚éš™ (SåŒº - ç»å¯¹é¢†åŸŸ) ==========
    chronalrift: {
        name: 'æ—¶ç©ºè£‚éš™',
        icon: 'ğŸŒ€',
        isEnvironmental: true,  // ç¯å¢ƒå¤©æ°”ï¼Œæ— é™æŒç»­
        tier: 3,  // Tier 3 ç»å¯¹å¤©æ°”ï¼Œä¸å¯è¢«æ™®é€šå¤©æ°”æ›¿æ¢
        allowsInnerWeather: true,  // å†…éƒ¨å¯ä»¥å­˜åœ¨æ™®é€šå¤©æ°”ï¼ˆå¦‚æš´é›¨ï¼‰
        effects: {
            // A. å¤ä»Šæ‚–è®º (Paradox Resonance) - æ‚–è°¬ç§/å¼‚å…½å¢å¼º
            paradoxResonance: {
                enabled: true,
                // è‡ªåŠ¨æ¿€æ´»å¤ä»£æ´»æ€§/å¤¸å…‹å……èƒ½
                autoActivateAbilities: ['protosynthesis', 'quarkdrive'],
                // å¼‚å…½æ°”åœºï¼šéæ—¶ç©ºç±»æ‹›å¼ä¼¤å®³ -20%
                beastAura: {
                    damageReduction: 0.20,
                    // å…ç–«æ¥æºï¼šæ‚–è°¬ç§ã€å¼‚å…½ã€ç¥è¯
                    immuneSources: ['paradox', 'ultrabeast', 'mythical']
                },
                description: 'æ‚–è°¬ç§ç‰¹æ€§è‡ªåŠ¨æ¿€æ´»ï¼Œå¼‚å…½è·å¾—ä¼¤å®³å‡å…'
            },
            // B. æ´—ç¿ æ— æ³• (Unbound Arts) - å¤æ­¦ç³»ç»Ÿé‡æ„
            unboundArts: {
                enabled: true,
                // åˆšçŒ› (Strong Style) - ç ´åç¥æ¨¡å¼
                strongStyle: {
                    noCooldown: true,
                    damageMultiplier: 1.5,    // ä¼¤å®³ x1.5
                    accuracyMultiplier: 0.85, // å‘½ä¸­ x0.85
                    priority: -1,
                    description: 'æ— å†·å´ï¼Œä¼¤å®³x1.5ï¼Œå‘½ä¸­x0.85ï¼Œä¼˜å…ˆåº¦-1'
                },
                // è¿…ç–¾ (Agile Style) - ç¬èº«æ¨¡å¼
                agileStyle: {
                    noCooldown: true,
                    priorityBoost: 1,         // ä¼˜å…ˆåº¦ +1
                    // å¨åŠ›ä¿®æ­£ï¼šé€Ÿåº¦å¿«=1.0ï¼Œé€Ÿåº¦æ…¢=0.9
                    powerIfFaster: 1.0,
                    powerIfSlower: 0.9,
                    description: 'æ— å†·å´ï¼Œä¼˜å…ˆåº¦+1ï¼Œé€Ÿåº¦å¿«æ— æŸ/é€Ÿåº¦æ…¢å¨åŠ›x0.9'
                },
                description: 'å¤æ­¦ç³»ç»Ÿè§£é™¤é™åˆ¶ï¼Œå˜æˆæ¯å›åˆå¯ç”¨çš„æ ¸å¼¹'
            },
            // C. é€Ÿåº¦ç†µå¢ (Entropy Flux) - éšæœºæˆæ³•ç©ºé—´
            entropyFlux: {
                enabled: true,
                triggerChance: 0.15,  // 15% æ¦‚ç‡è§¦å‘
                effect: 'trickRoomToggle',
                // è§¦å‘åçš„æˆæ³•ç©ºé—´æ— å›åˆé™åˆ¶
                infiniteDuration: true,
                description: 'æ¯å›åˆå¼€å§‹æœ‰15%æ¦‚ç‡ç¿»è½¬æˆæ³•ç©ºé—´çŠ¶æ€'
            },
            // D. èµ·æºå…±é¸£ (Origin Pulse) - æ´—ç¿ /èµ·æºå½¢æ€å¢å¼º
            originPulse: {
                enabled: true,
                // æ´—ç¿ å½¢æ€ï¼šåˆšçŒ›æ— è§†å‘½ä¸­æƒ©ç½šï¼Œè¿…ç–¾æ— è§†å¨åŠ›å‰Šå‡
                hisuianBonus: {
                    strongStyleIgnoreAccPenalty: true,
                    agileStyleFullPower: true
                },
                // èµ·æºå½¢æ€åŒæ ·äº«å—åŠ æˆ
                originFormBonus: true,
                // è¯†åˆ«å…³é”®è¯
                hisuianIdentifiers: ['hisui', 'hisuian'],
                originIdentifiers: ['origin'],
                description: 'æ´—ç¿ /èµ·æºå½¢æ€åœ¨æ—¶ç©ºè£‚éš™ä¸­å¦‚é±¼å¾—æ°´'
            },
            // E. æŠ€èƒ½é»‘ç®± (Move Glitch) - ç§‘æŠ€æ‹›å¼RNG
            moveGlitch: {
                enabled: true,
                // å—å½±å“çš„æ‹›å¼ç±»å‹
                affectedMoves: [
                    'multiattack', 'conversion', 'conversion2', 'lockon',
                    'technoblast', 'gearsaucer', 'geargrind', 'shiftgear',
                    'magnetrise', 'flashcannon', 'steelbeam'
                ],
                // å—å½±å“çš„å®å¯æ¢¦ï¼ˆäººé€ /ç§‘æŠ€ç±»ï¼‰
                affectedPokemon: ['porygon', 'porygon2', 'porygonz', 'genesect', 'magearna', 'silvally', 'typenull'],
                // æ•ˆæœæ¦‚ç‡
                criticalSuccessChance: 0.20,  // 20% å¨åŠ› x2
                criticalFailChance: 0.10,     // 10% å¨åŠ› x0 (å¤±è´¥)
                criticalSuccessMultiplier: 2.0,
                description: 'ç§‘æŠ€ç±»æ‹›å¼æœ‰20%æš´å‡»/10%å¤±è´¥çš„èµŒåšæ•ˆæœ'
            },
            // å¤©æ°”çƒå˜ä¸ºé¾™ç³»ï¼ˆæ—¶ç©ºèƒ½é‡ï¼‰
            weatherBallType: 'Dragon',
            weatherBallPower: 100
        },
        visualKey: 'chronalrift'
    },
    // ========== åŒºåŸŸå¤©æ°” (N/A/S/B) ==========
    // ç®€åŒ–ç‰ˆï¼šä»…æä¾›æ‹›å¼å¨åŠ›ä¿®æ­£
    // N åŒº (Neon) - Smog (çƒŸéœ¾) ğŸ­
    // ã€ç§‘æŠ€è¿‡è½½ã€‘ç”µç³»å’Œæ¯’ç³»æ‹›å¼å¨åŠ› x1.3
    smog: {
        name: 'çƒŸéœ¾',
        icon: 'ğŸ­',
        isEnvironmental: true,
        powerModifiers: {
            Electric: 1.3,
            Poison: 1.3
        },
        effects: {
            weatherBallType: 'Poison',
            weatherBallPower: 100
        },
        visualKey: 'smog'
    },
    // A åŒº (Apex) - Ashfall (ç«å±±ç°) ğŸŒ‹
    // ã€æçƒ­è’åŸã€‘ç«/åœ°é¢å¨åŠ› x1.3ï¼Œå†°ç³»å¨åŠ› x0.7
    ashfall: {
        name: 'ç«å±±ç°',
        icon: 'ğŸŒ‹',
        isEnvironmental: true,
        powerModifiers: {
            Fire: 1.3,
            Ground: 1.3,
            Ice: 0.7
        },
        effects: {
            weatherBallType: 'Fire',
            weatherBallPower: 100
        },
        visualKey: 'ashfall'
    },
    // B åŒº (Bloom) - Gale (é¦™é£) ğŸŒ¿
    // ã€åŸå§‹å¢ç”Ÿã€‘è‰/è™«å¨åŠ› x1.3ï¼Œç«ç³»å¨åŠ› x0.7
    gale: {
        name: 'é¦™é£',
        icon: 'ğŸŒ¿',
        isEnvironmental: true,
        powerModifiers: {
            Grass: 1.3,
            Bug: 1.3,
            Fire: 0.7
        },
        effects: {
            weatherBallType: 'Grass',
            weatherBallPower: 100
        },
        visualKey: 'gale'
    },
    // S åŒº (Shadow) - Fog (è¿·é›¾) ğŸ‘»
    // ã€æš—ç‰©è´¨ã€‘å¹½çµ/æ¶å¨åŠ› x1.3
    fog: {
        name: 'è¿·é›¾',
        icon: 'ğŸ‘»',
        isEnvironmental: true,
        powerModifiers: {
            Ghost: 1.3,
            Dark: 1.3
        },
        effects: {
            weatherBallType: 'Ghost',
            weatherBallPower: 100
        },
        visualKey: 'fog'
    }
};
// ============================================
// å¤©æ°”æ•ˆæœæŸ¥è¯¢å‡½æ•°
// ============================================
/**
 * è·å–å¤©æ°”é…ç½®
 * @param {string} weather å¤©æ°” ID
 * @returns {object|null} å¤©æ°”é…ç½®å¯¹è±¡
 */
export function getWeatherConfig(weather) {
    const normalizedId = normalizeWeatherId(weather);
    return WEATHER_CONFIG[normalizedId] || null;
}
/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºå§‹æºå¤©æ°”
 * @param {string} weather å¤©æ°” ID
 * @returns {boolean}
 */
export function isPrimalWeather(weather) {
    const config = getWeatherConfig(weather);
    return config?.isPrimal === true;
}
/**
 * è·å–å§‹æºå¤©æ°”åˆ—è¡¨
 * @returns {string[]}
 */
export function getPrimalWeathers() {
    return ['deltastream', 'harshsun', 'heavyrain'];
}
// ============================================
// å¤©æ°”ä¼¤å®³è®¡ç®—
// ============================================
/**
 * æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦å…ç–«å¤©æ°”ä¼¤å®³
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @param {string} weather å¤©æ°” ID
 * @returns {boolean}
 */
export function isWeatherDamageImmune(pokemon, weather) {
    const config = getWeatherConfig(weather);
    if (!config || !config.endTurnDamage) return true; // æ— ä¼¤å®³é…ç½® = å…ç–«
    const dmgConfig = config.endTurnDamage;
    // ç±»å‹å…ç–«
    if (dmgConfig.immuneTypes && pokemon.types) {
        if (pokemon.types.some(t => dmgConfig.immuneTypes.includes(t))) {
            return true;
        }
    }
    // ç‰¹æ€§å…ç–«
    if (dmgConfig.immuneAbilities && pokemon.ability) {
        const abilityId = pokemon.ability.toLowerCase().replace(/[^a-z]/g, '');
        if (dmgConfig.immuneAbilities.includes(abilityId)) {
            return true;
        }
    }
    // é“å…·å…ç–« (Safety Goggles)
    if (pokemon.item) {
        const itemId = pokemon.item.toLowerCase().replace(/[^a-z]/g, '');
        if (itemId === 'safetygoggles') {
            return true;
        }
    }
    return false;
}
/**
 * è®¡ç®—å¤©æ°”å›åˆæœ«ä¼¤å®³
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @param {string} weather å¤©æ°” ID
 * @returns {number} ä¼¤å®³å€¼ (0 = å…ç–«)
 */
export function getWeatherDamage(pokemon, weather) {
    if (isWeatherDamageImmune(pokemon, weather)) return 0;
    const config = getWeatherConfig(weather);
    if (!config || !config.endTurnDamage) return 0;
    const fraction = config.endTurnDamage.fraction || 0;
    return Math.max(1, Math.floor(pokemon.maxHp * fraction));
}
/**
 * è·å–å¤©æ°”ä¼¤å®³æ—¥å¿—
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @param {string} weather å¤©æ°” ID
 * @param {number} damage ä¼¤å®³å€¼
 * @returns {string} æ—¥å¿—æ–‡æœ¬
 */
export function getWeatherDamageLog(pokemon, weather, damage) {
    const config = getWeatherConfig(weather);
    if (!config) return '';
    return `${pokemon.cnName} å—åˆ°${config.name}çš„ä¼¤å®³! (-${damage})`;
}
// ============================================
// å¤©æ°”å¨åŠ›ä¿®æ­£
// ============================================
/**
 * è·å–å¤©æ°”å¯¹æ‹›å¼å¨åŠ›çš„ä¿®æ­£
 * @param {string} weather å¤©æ°” ID
 * @param {string} moveType æ‹›å¼å±æ€§
 * @param {string} moveName æ‹›å¼åç§° (ç”¨äºç‰¹æ®Šæ‹›å¼æ£€æŸ¥)
 * @returns {{ modifier: number, log: string|null }}
 */
export function getWeatherPowerModifier(weather, moveType, moveName = '') {
    const config = getWeatherConfig(weather);
    if (!config) return { modifier: 1, log: null };
    const moveId = moveName.toLowerCase().replace(/[^a-z]/g, '');
    // ã€ç‰¹åˆ¤ã€‘Hydro Steam åœ¨æ™´å¤©ä¸‹å¨åŠ› x1.5 è€Œé x0.5
    if (moveId === 'hydrosteam' && (weather === 'sun' || weather === 'harshsun')) {
        return { modifier: 1.5, log: `â˜€ï¸ æ°´è’¸æ°”åœ¨æ™´å¤©ä¸‹å¨åŠ›å¢å¼ºï¼` };
    }
    // æ£€æŸ¥å¨åŠ›ä¿®æ­£
    if (config.powerModifiers && config.powerModifiers[moveType] !== undefined) {
        const modifier = config.powerModifiers[moveType];
        // å¨åŠ›ä¸º 0 è¡¨ç¤ºæ‹›å¼å¤±æ•ˆ
        if (modifier === 0) {
            const blockMsg = (weather === 'harshsun' || config.effects?.blockWaterMoves) 
                ? `æ°´è¢«å¼ºçƒˆçš„é˜³å…‰è’¸å‘äº†ï¼`
                : `ç«è¢«æš´é£é›¨æµ‡ç­äº†ï¼`;
            return { modifier: 0, log: blockMsg };
        }
        if (modifier !== 1) {
            const changeText = modifier > 1 ? 'å¢å¼º' : 'å‡å¼±';
            return { 
                modifier, 
                log: `${config.name}ä½¿${moveType}ç³»æ‹›å¼å¨åŠ›${changeText}äº†ï¼` 
            };
        }
    }
    // æ—¥å…‰æŸ/æ—¥å…‰åˆƒåœ¨æ¶åŠ£å¤©æ°”å¨åŠ›å‡åŠ
    if ((moveId === 'solarbeam' || moveId === 'solarblade') && config.effects?.solarBeamHalved) {
        return { modifier: 0.5, log: `${config.name}ä½¿${moveName}å¨åŠ›å‡åŠï¼` };
    }
    return { modifier: 1, log: null };
}
// ============================================
// å¤©æ°”å‘½ä¸­ç‡ä¿®æ­£
// ============================================
/**
 * è·å–å¤©æ°”å¯¹æ‹›å¼å‘½ä¸­ç‡çš„ä¿®æ­£
 * @param {string} weather å¤©æ°” ID
 * @param {string} moveName æ‹›å¼åç§°
 * @returns {{ accuracy: number|null, log: string|null }} null = ä¸ä¿®æ”¹, true = å¿…ä¸­, number = ä¿®æ­£åå‘½ä¸­ç‡
 */
export function getWeatherAccuracyModifier(weather, moveName) {
    const config = getWeatherConfig(weather);
    if (!config) return { accuracy: null, log: null };
    const moveId = moveName.replace(/[^a-zA-Z]/g, '').toLowerCase();
    // é›¨å¤©å¿…ä¸­æ‹›å¼
    if (config.accuracyModifiers) {
        for (const [move, isGuaranteed] of Object.entries(config.accuracyModifiers)) {
            if (moveId === move.toLowerCase() && isGuaranteed) {
                return { 
                    accuracy: true, // true = å¿…ä¸­
                    log: `${config.name}ä½¿${moveName}å¿…å®šå‘½ä¸­ï¼` 
                };
            }
        }
    }
    // ã€æ™´å¤©ç‰¹æ®Šå¤„ç†ã€‘é›·ç”µ/æš´é£å‘½ä¸­ç‡é™è‡³ 50%
    if (weather === 'sun' || weather === 'harshsun') {
        const sunAccDropMoves = ['thunder', 'hurricane'];
        if (sunAccDropMoves.includes(moveId)) {
            return { 
                accuracy: 50, 
                log: `â˜€ï¸ æ™´å¤©ä½¿${moveName}å‘½ä¸­ç‡é™è‡³ 50%` 
            };
        }
    }
    // ã€é›ªå¤©ç‰¹æ®Šå¤„ç†ã€‘æš´é£é›ªå¿…ä¸­
    if (weather === 'snow' || weather === 'hail') {
        if (moveId === 'blizzard') {
            return { 
                accuracy: true, 
                log: `â„ï¸ é›ªå¤©ä½¿æš´é£é›ªå¿…å®šå‘½ä¸­ï¼` 
            };
        }
    }
    return { accuracy: null, log: null };
}
// ============================================
// å¤©æ°”é˜²å¾¡ä¿®æ­£
// ============================================
/**
 * è·å–å¤©æ°”å¯¹é˜²å¾¡çš„åŠ æˆ
 * @param {string} weather å¤©æ°” ID
 * @param {string[]} defenderTypes é˜²å¾¡æ–¹å±æ€§
 * @param {boolean} isSpecial æ˜¯å¦ä¸ºç‰¹æ®Šæ”»å‡»
 * @returns {{ multiplier: number, log: string|null }}
 */
export function getWeatherDefenseBoost(weather, defenderTypes, isSpecial) {
    const config = getWeatherConfig(weather);
    if (!config || !config.defenseBoost) return { multiplier: 1, log: null };
    const boost = config.defenseBoost;
    // æ£€æŸ¥é˜²å¾¡æ–¹æ˜¯å¦æœ‰å¯¹åº”å±æ€§
    const hasMatchingType = defenderTypes.some(t => boost.types.includes(t));
    if (!hasMatchingType) return { multiplier: 1, log: null };
    // æ£€æŸ¥æ˜¯å¦ä¸ºå¯¹åº”çš„é˜²å¾¡ç±»å‹
    // spd = ç‰¹é˜² (æ²™æš´å¯¹å²©çŸ³ç³»)
    // def = ç‰©é˜² (é›ªå¤©å¯¹å†°ç³»)
    const statMatches = (boost.stat === 'spd' && isSpecial) || (boost.stat === 'def' && !isSpecial);
    if (!statMatches) return { multiplier: 1, log: null };
    const statName = boost.stat === 'spd' ? 'ç‰¹é˜²' : 'ç‰©é˜²';
    return { 
        multiplier: boost.multiplier, 
        log: `${config.name}ä½¿${boost.types.join('/')}ç³»çš„${statName}æå‡äº†ï¼` 
    };
}
// ============================================
// å¤©æ°”ç‰¹æ®Šæ•ˆæœæ£€æŸ¥
// ============================================
/**
 * æ£€æŸ¥æ‹›å¼æ˜¯å¦è¢«å¤©æ°”é˜»æ­¢
 * @param {string} weather å¤©æ°” ID
 * @param {string} moveType æ‹›å¼å±æ€§
 * @param {number} basePower æ‹›å¼å¨åŠ› (0 = å˜åŒ–æŠ€)
 * @returns {{ blocked: boolean, message: string|null }}
 */
export function checkWeatherBlocksMove(weather, moveType, basePower) {
    const config = getWeatherConfig(weather);
    if (!config || basePower === 0) return { blocked: false, message: null };
    // å¤§æ—¥ç…§é˜»æ­¢æ°´ç³»æ”»å‡»æ‹›å¼
    if (config.effects?.blockWaterMoves && moveType === 'Water') {
        return { 
            blocked: true, 
            message: `<span style="color:#f59e0b">ğŸ”¥ æ°´è¢«å¼ºçƒˆçš„é˜³å…‰è’¸å‘äº†ï¼</span>` 
        };
    }
    // å¤§é›¨é˜»æ­¢ç«ç³»æ”»å‡»æ‹›å¼
    if (config.effects?.blockFireMoves && moveType === 'Fire') {
        return { 
            blocked: true, 
            message: `<span style="color:#3b82f6">ğŸŒŠ ç«è¢«æš´é£é›¨æµ‡ç­äº†ï¼</span>` 
        };
    }
    return { blocked: false, message: null };
}
/**
 * æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨æå…‰å¹•
 * @param {string} weather å¤©æ°” ID
 * @returns {boolean}
 */
export function canUseAuroraVeil(weather) {
    const config = getWeatherConfig(weather);
    return config?.effects?.auroraVeilEnabled === true;
}
/**
 * æ£€æŸ¥æ—¥å…‰æŸæ˜¯å¦å¯ä»¥ç¬å‘
 * @param {string} weather å¤©æ°” ID
 * @returns {boolean}
 */
export function isSolarBeamInstant(weather) {
    const config = getWeatherConfig(weather);
    return config?.effects?.solarBeamInstant === true;
}
/**
 * è·å–å¤©æ°”çƒçš„å±æ€§å’Œå¨åŠ›
 * @param {string} weather å¤©æ°” ID
 * @returns {{ type: string, power: number }}
 */
export function getWeatherBallStats(weather) {
    const config = getWeatherConfig(weather);
    if (!config || !config.effects) {
        return { type: 'Normal', power: 50 };
    }
    return {
        type: config.effects.weatherBallType || 'Normal',
        power: config.effects.weatherBallPower || 50
    };
}
/**
 * è·å–å›å¤æŠ€èƒ½çš„å›å¤æ¯”ä¾‹ä¿®æ­£
 * @param {string} weather å¤©æ°” ID
 * @param {string} moveName æ‹›å¼åç§°
 * @returns {number} å›å¤æ¯”ä¾‹ (é»˜è®¤ 0.5)
 */
export function getRecoveryRatio(weather, moveName) {
    const config = getWeatherConfig(weather);
    const moveId = (moveName || '').toLowerCase().replace(/[^a-z]/g, '');
    // å…‰åˆä½œç”¨/æ™¨å…‰/æœˆå…‰ åœ¨æ™´å¤©å›å¤ 2/3
    const sunBoostMoves = ['synthesis', 'morningsun', 'moonlight'];
    if (sunBoostMoves.includes(moveId)) {
        if (config?.effects?.synthesisBoost || config?.effects?.morningsunBoost || config?.effects?.moonlightBoost) {
            return 2/3;
        }
        // åœ¨å…¶ä»–å¤©æ°”ä¸‹å›å¤ 1/4
        if (weather && weather !== 'none' && weather !== 'sun' && weather !== 'harshsun') {
            return 1/4;
        }
    }
    return 1/2; // é»˜è®¤å›å¤æ¯”ä¾‹
}
/**
 * è·å–å¤©æ°”å¯¹å›å¤æ•ˆæœçš„å…¨å±€ä¿®æ­£å€ç‡
 * ã€Smog ä¸“ç”¨ã€‘åŒ–å­¦å±éšœ - æ‰€æœ‰å›å¤æ•ˆæœå‡åŠ
 * @param {string} weather å¤©æ°” ID
 * @returns {number} å›å¤å€ç‡ (1 = æ— ä¿®æ­£, 0.5 = å‡åŠ)
 */
export function getHealingMultiplier(weather) {
    const config = getWeatherConfig(weather);
    if (config?.effects?.healingReduction) {
        return config.effects.healingReduction;
    }
    return 1;
}
/**
 * ã€ç»Ÿä¸€æ²»æ„ˆå‡½æ•°ã€‘å¤„ç† HP å›å¤ï¼Œè‡ªåŠ¨åº”ç”¨ Smog åŒ–å­¦å±éšœå‡åŠæ•ˆæœ
 * æ‰€æœ‰å›å¤æ¥æºï¼ˆæŠ€èƒ½ã€é“å…·ã€ç‰¹æ€§ã€æ ‘æœç­‰ï¼‰éƒ½åº”ä½¿ç”¨æ­¤å‡½æ•°
 * 
 * @param {object} pokemon è¦å›å¤çš„å®å¯æ¢¦
 * @param {number} baseAmount åŸºç¡€å›å¤é‡
 * @param {object} options é…ç½®é¡¹
 * @param {boolean} options.bypassWeather æ˜¯å¦è·³è¿‡å¤©æ°”å‡åŠï¼ˆç”¨äºæ²»æ„ˆä¹‹æ„¿ç­‰ï¼‰
 * @param {string} options.source å›å¤æ¥æºï¼ˆç”¨äºæ—¥å¿—ï¼Œå¦‚ 'leftovers', 'drain', 'ability'ï¼‰
 * @returns {number} å®é™…å›å¤é‡
 */
export function applyHeal(pokemon, baseAmount, options = {}) {
    if (!pokemon || baseAmount <= 0) return 0;
    const maxHeal = pokemon.maxHp - pokemon.currHp;
    if (maxHeal <= 0) return 0;
    let actualHeal = Math.min(baseAmount, maxHeal);
    let totalMult = 1;
    // 1. åº”ç”¨ Smog åŒ–å­¦å±éšœå‡åŠï¼ˆé™¤é bypassWeather = trueï¼‰
    if (!options.bypassWeather && typeof window !== 'undefined' && window.battle) {
        const weather = window.battle.weather;
        const weatherMult = getHealingMultiplier(weather);
        if (weatherMult !== 1) {
            totalMult *= weatherMult;
        }
    }
    // 2. ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘åº”ç”¨ç¯å¢ƒå›å¤ä¿®æ­£
    if (!options.bypassEnv && typeof window !== 'undefined' && window.envOverlay) {
        const envMult = window.envOverlay.getHealMod(pokemon);
        if (envMult !== 1) {
            totalMult *= envMult;
        }
    }
    // åº”ç”¨æ€»å€ç‡
    if (totalMult !== 1) {
        actualHeal = Math.floor(baseAmount * totalMult);
        actualHeal = Math.min(actualHeal, maxHeal);
        if (options.source) {
            console.log(`[HEAL MOD] ${options.source} å›å¤é‡ ${baseAmount} -> ${actualHeal} (x${totalMult.toFixed(2)})`);
        } else {
            console.log(`[HEAL MOD] å›å¤é‡ ${baseAmount} -> ${actualHeal} (x${totalMult.toFixed(2)})`);
        }
    }
    // åº”ç”¨å›å¤
    pokemon.currHp = Math.min(pokemon.maxHp, pokemon.currHp + actualHeal);
    return actualHeal;
}
// ============================================
// åŒºåŸŸå¤©æ°”ä¸“ç”¨å‡½æ•°å·²è¿ç§»è‡³ Environment Overlay API
// å‚è§: systems/environment-overlay.js
// æ–‡æ¡£: docs/ENVIRONMENT_OVERLAY_TEMPLATES.md
// 
// å·²åˆ é™¤çš„ç¡¬ç¼–ç å¤©æ°”å‡½æ•°ï¼š
// - Smog (çƒŸéœ¾) ç›¸å…³å‡½æ•°
// - Ashfall (ç«å±±ç°) ç›¸å…³å‡½æ•°
// - Shadow Fog (æš—å½±è¿·é›¾) ç›¸å…³å‡½æ•°
// - Gale (é¦™é£) ç›¸å…³å‡½æ•°
// 
// è¿™äº›å¤©æ°”æ•ˆæœç°åœ¨é€šè¿‡ environment.overlay ç³»ç»Ÿå®ç°
// ============================================
/**
 * æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦æ¥åœ°ï¼ˆé€šç”¨å‡½æ•°ï¼Œç”¨äºåœ°é¢æ‹›å¼åˆ¤å®šç­‰ï¼‰
 * @param {object} pokemon å®å¯æ¢¦å¯¹è±¡
 * @returns {boolean} æ˜¯å¦æ¥åœ°
 */
export function isGrounded(pokemon) {
    if (!pokemon) return false;
    const types = pokemon.types || [];
    const abilityId = (pokemon.ability || '').toLowerCase().replace(/[^a-z]/g, '');
    const itemId = (pokemon.item || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    // é£è¡Œç³»ä¸æ¥åœ°
    if (types.includes('Flying')) return false;
    // æ¼‚æµ®ç‰¹æ€§ä¸æ¥åœ°
    if (abilityId === 'levitate') return false;
    // æ°”çƒä¸æ¥åœ°
    if (itemId === 'airballoon') return false;
    // ç”µç£æµ®æ¸¸çŠ¶æ€ä¸æ¥åœ°
    if (pokemon.volatile?.magnetrise) return false;
    // é¡ºé£é£ç¿”çŠ¶æ€ä¸æ¥åœ°
    if (pokemon.volatile?.telekinesis) return false;
    return true;
}
// ============================================
// Gale æé€Ÿè§£å†»å·²è¿ç§»è‡³ Environment Overlay API
// ä½¿ç”¨ envOverlay.getStatusEffects().cureStatus æ£€æŸ¥
// ============================================
// ============================================
// Ambrosia (ç¥ä¹‹ç¼æµ† - CåŒºç¥ç§˜åŒº) è¾…åŠ©å‡½æ•°
// ============================================
/**
 * è·å–å”¯å¿ƒå®ä½“åŒ–çš„å…¨å‘˜æš´å‡»åŠ æˆ
 * @param {string} weather å¤©æ°” ID
 * @returns {number} æš´å‡»ç­‰çº§åŠ æˆ (0 = æ— åŠ æˆ, 1 = +1)
 */
export function getPsychicMindCritBoost(weather) {
    const config = getWeatherConfig(weather);
    if (!config?.effects?.psychicMind) return 0;
    const boost = config.effects.psychicMind.critBoost || 0;
    if (boost > 0) {
        console.log(`[AMBROSIA] ğŸŒ¸ å”¯å¿ƒå®ä½“åŒ–ï¼šå…¨å‘˜æš´å‡»ç‡ +${boost}`);
    }
    return boost;
}
/**
 * è·å– AVS ç¾ç»Šç³»ç»Ÿå€ç‡
 * @param {string} weather å¤©æ°” ID
 * @returns {number} AVS è§¦å‘ç‡å€ç‡ (1 = æ— ä¿®æ­£, 2 = åŒå€)
 */
export function getAVSMultiplier(weather) {
    const config = getWeatherConfig(weather);
    if (!config?.effects?.avsMultiplier) return 1;
    const rate = config.effects.avsMultiplier.rate || 1;
    if (rate > 1) {
        console.log(`[AMBROSIA] ğŸ’« ç¥ä¹‹ç¼æµ†ï¼šAVS ç¾ç»Šè§¦å‘ç‡ x${rate}`);
    }
    return rate;
}
/**
 * æ£€æŸ¥æ˜¯å¦åº”è§¦å‘æ—¶ç©ºé†‰ï¼ˆä½¿ç”¨ç‰¹æ®Šæœºåˆ¶åï¼‰
 * @param {string} weather å¤©æ°” ID
 * @param {string} mechanicType æœºåˆ¶ç±»å‹ ('mega', 'zmove', 'dynamax', 'terastal')
 * @param {object} pokemon ä½¿ç”¨æœºåˆ¶çš„å®å¯æ¢¦
 * @param {object} trainer è®­ç»ƒå®¶å¯¹è±¡ï¼ˆæ£€æŸ¥ isAdminï¼‰
 * @returns {{ shouldTrigger: boolean, message: string }}
 */
export function checkNeuroBacklash(weather, mechanicType, pokemon, trainer = null) {
    const config = getWeatherConfig(weather);
    if (!config?.effects?.neuroBacklash?.enabled) {
        return { shouldTrigger: false, message: '' };
    }
    const nb = config.effects.neuroBacklash;
    // Boss å…ç–«æ£€æŸ¥
    if (nb.bossImmune && trainer?.isAdmin) {
        console.log(`[AMBROSIA] âš¡ æ—¶ç©ºé†‰ï¼š${trainer.name || 'Admin'} æœ‰æŠ—ä½“ï¼Œå…ç–«æ—¶ç©ºé†‰`);
        return { shouldTrigger: false, message: '' };
    }
    // æ£€æŸ¥è§¦å‘æ¡ä»¶
    if (!nb.triggers.includes(mechanicType)) {
        return { shouldTrigger: false, message: '' };
    }
    console.log(`[AMBROSIA] âš¡ æ—¶ç©ºé†‰ï¼š${pokemon?.cnName || pokemon?.name} ä½¿ç”¨äº† ${mechanicType}ï¼Œä¸‹å›åˆå°†é™·å…¥æ··ä¹±`);
    return { 
        shouldTrigger: true, 
        message: `<span style="color:#e879f9">âš¡ ç¥ç»è´Ÿæ‹…ï¼${pokemon?.cnName || pokemon?.name} æ„Ÿåˆ°ä¸€é˜µçœ©æ™•...</span>`
    };
}
/**
 * åº”ç”¨æ—¶ç©ºé†‰æ•ˆæœï¼ˆåœ¨ä¸‹å›åˆå¼€å§‹æ—¶è°ƒç”¨ï¼‰
 * @param {object} pokemon å®å¯æ¢¦
 * @returns {{ applied: boolean, message: string }}
 */
export function applyNeuroBacklashConfusion(pokemon) {
    if (!pokemon || !pokemon.volatile?.neuroBacklash) {
        return { applied: false, message: '' };
    }
    // æ¸…é™¤æ ‡è®°
    delete pokemon.volatile.neuroBacklash;
    // åº”ç”¨æ··ä¹±ï¼ˆç©¿é€ç¥ç§˜å®ˆæŠ¤ï¼‰
    pokemon.volatile = pokemon.volatile || {};
    pokemon.volatile.confusion = Math.floor(Math.random() * 4) + 2; // 2-5 å›åˆ
    console.log(`[AMBROSIA] âš¡ æ—¶ç©ºé†‰ï¼š${pokemon?.cnName || pokemon?.name} é™·å…¥æ··ä¹±ï¼`);
    return { 
        applied: true, 
        message: `<span style="color:#e879f9">âš¡ æ—¶ç©ºé†‰å‘ä½œï¼${pokemon?.cnName || pokemon?.name} é™·å…¥äº†æ··ä¹±ï¼</span>`
    };
}
/**
 * æ£€æŸ¥åœºåœ°æ˜¯å¦åº”æ— é™æŒç»­
 * @param {string} weather å¤©æ°” ID
 * @param {string} terrain åœºåœ° ID
 * @returns {boolean} æ˜¯å¦æ— é™æŒç»­
 */
export function isTerrainInfinite(weather, terrain) {
    const config = getWeatherConfig(weather);
    if (!config?.effects?.infiniteTerrain) return false;
    const affectedTerrains = config.effects.infiniteTerrain.affectedTerrains || [];
    const isInfinite = affectedTerrains.includes(terrain);
    if (isInfinite) {
        console.log(`[AMBROSIA] ğŸŒˆ æ— é™åœºåœ°ï¼š${terrain} åœ¨ç¥ä¹‹ç¼æµ†ä¸­æ°¸ä¹…æŒç»­`);
    }
    return isInfinite;
}
/**
 * æ£€æŸ¥æ±¡æŸ“å›ç«æ•ˆæœ
 * @param {string} weather å¤©æ°” ID
 * @param {object} move æ‹›å¼æ•°æ®
 * @param {object} user ä½¿ç”¨è€…
 * @returns {{ triggered: boolean, effects: { critDrop: number, confusion: boolean }, message: string }}
 */
export function checkContaminationRecoil(weather, move, user) {
    const config = getWeatherConfig(weather);
    if (!config?.effects?.contaminationRecoil?.enabled) {
        return { triggered: false, effects: { critDrop: 0, confusion: false }, message: '' };
    }
    const cr = config.effects.contaminationRecoil;
    const moveId = (move?.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : move;
    const moveType = fullMoveData?.type || move?.type;
    const basePower = fullMoveData?.basePower || move?.basePower || 0;
    // æ£€æŸ¥æ˜¯å¦ä¸ºå—å½±å“çš„å±æ€§ä¸”å¨åŠ›è¾¾åˆ°é˜ˆå€¼
    if (!cr.affectedTypes.includes(moveType) || basePower < cr.powerThreshold) {
        return { triggered: false, effects: { critDrop: 0, confusion: false }, message: '' };
    }
    // è§¦å‘æ±¡æŸ“å›ç«
    const effects = {
        critDrop: cr.effects.critDrop || 0,
        confusion: Math.random() < (cr.effects.confusionChance || 0)
    };
    let message = `<span style="color:#a855f7">ğŸ’€ æ±¡æŸ“å›ç«ï¼${user?.cnName || user?.name} ä½¿ç”¨çš„ ${move.name} è§¦å‘äº†ç²‰é›¾çš„æ’å¼‚ååº”ï¼`;
    if (effects.critDrop < 0) {
        message += ` æš´å‡»ç‡ ${effects.critDrop}ï¼`;
    }
    if (effects.confusion) {
        message += ` é™·å…¥æ··ä¹±ï¼`;
    }
    message += `</span>`;
    console.log(`[AMBROSIA] ğŸ’€ æ±¡æŸ“å›ç«ï¼š${user?.cnName || user?.name} çš„ ${move.name} (${moveType}/${basePower}å¨åŠ›) è§¦å‘åå™¬`);
    return { triggered: true, effects, message };
}
// ============================================
// Chronal Rift (æ—¶ç©ºè£‚éš™ - SåŒºç»å¯¹é¢†åŸŸ) è¾…åŠ©å‡½æ•°
// ============================================
/**
 * æ£€æŸ¥æ˜¯å¦åº”è‡ªåŠ¨æ¿€æ´»æ‚–è°¬ç§ç‰¹æ€§ (Paradox Resonance)
 * @param {string} weather å¤©æ°” ID
 * @param {object} pokemon å®å¯æ¢¦
 * @returns {{ shouldActivate: boolean, ability: string, message: string }}
 */
export function checkParadoxResonance(weather, pokemon) {
    const config = getWeatherConfig(weather);
    if (!config?.effects?.paradoxResonance?.enabled) {
        return { shouldActivate: false, ability: '', message: '' };
    }
    const pr = config.effects.paradoxResonance;
    const abilityId = (pokemon?.ability || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    if (pr.autoActivateAbilities.includes(abilityId)) {
        console.log(`[CHRONAL RIFT] ğŸŒ€ å¤ä»Šæ‚–è®ºï¼š${pokemon?.cnName || pokemon?.name} çš„ ${pokemon.ability} è‡ªåŠ¨æ¿€æ´»`);
        return {
            shouldActivate: true,
            ability: abilityId,
            message: `<span style="color:#8b5cf6">ğŸŒ€ æ—¶ç©ºè£‚éš™å…±é¸£ï¼${pokemon?.cnName || pokemon?.name} çš„ ${pokemon.ability} è‡ªåŠ¨æ¿€æ´»ï¼</span>`
        };
    }
    return { shouldActivate: false, ability: '', message: '' };
}
/**
 * æ£€æŸ¥å¼‚å…½æ°”åœºä¼¤å®³å‡å… (Beast Aura)
 * @param {string} weather å¤©æ°” ID
 * @param {object} defender é˜²å¾¡æ–¹
 * @param {object} attacker æ”»å‡»æ–¹
 * @returns {{ hasAura: boolean, damageMultiplier: number, message: string }}
 */
export function checkBeastAura(weather, defender, attacker) {
    const config = getWeatherConfig(weather);
    if (!config?.effects?.paradoxResonance?.beastAura) {
        return { hasAura: false, damageMultiplier: 1.0, message: '' };
    }
    const ba = config.effects.paradoxResonance.beastAura;
    const defenderId = (defender?.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const attackerId = (attacker?.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    // ä½¿ç”¨ POKEMON_CATEGORIES æ£€æŸ¥é˜²å¾¡æ–¹æ˜¯å¦ä¸ºå¼‚å…½
    let isUltraBeast = false;
    if (typeof window !== 'undefined' && window.POKEMON_CATEGORIES) {
        isUltraBeast = window.POKEMON_CATEGORIES.isPokemonInCategory(defenderId, 'ultrabeast');
    } else {
        // é™çº§ï¼šæ£€æŸ¥ tags æˆ–åç§°
        isUltraBeast = defender?.tags?.some(t => t === 'Ultra Beast') || false;
    }
    if (!isUltraBeast) {
        return { hasAura: false, damageMultiplier: 1.0, message: '' };
    }
    // ä½¿ç”¨ POKEMON_CATEGORIES æ£€æŸ¥æ”»å‡»æ–¹æ˜¯å¦ä¸ºå…ç–«æ¥æº
    let isImmuneSource = false;
    if (typeof window !== 'undefined' && window.POKEMON_CATEGORIES) {
        const cats = window.POKEMON_CATEGORIES;
        isImmuneSource = cats.isPokemonInCategory(attackerId, 'paradox') ||
                         cats.isPokemonInCategory(attackerId, 'ultrabeast') ||
                         cats.isPokemonInCategory(attackerId, 'hisuian') ||
                         cats.isPokemonInCategory(attackerId, 'origin');
    } else {
        isImmuneSource = attacker?.tags?.some(t => t === 'Paradox' || t === 'Ultra Beast' || t === 'Mythical') || false;
    }
    if (isImmuneSource) {
        return { hasAura: false, damageMultiplier: 1.0, message: '' };
    }
    const reduction = ba.damageReduction || 0.20;
    console.log(`[CHRONAL RIFT] ğŸ›¡ï¸ å¼‚å…½æ°”åœºï¼š${defender?.cnName || defender?.name} å—åˆ°çš„ä¼¤å®³ -${reduction * 100}%`);
    return {
        hasAura: true,
        damageMultiplier: 1.0 - reduction,
        message: `<span style="color:#8b5cf6">ğŸ›¡ï¸ å¼‚å…½æ°”åœºï¼ä¼¤å®³å‡å°‘ ${Math.round(reduction * 100)}%ï¼</span>`
    };
}
/**
 * è·å–æ´—ç¿ æ— æ³•çš„å¤æ­¦ä¿®æ­£ (Unbound Arts)
 * @param {string} weather å¤©æ°” ID
 * @param {string} style 'strong' æˆ– 'agile'
 * @param {object} pokemon ä½¿ç”¨è€…
 * @param {object} opponent å¯¹æ‰‹
 * @returns {{ active: boolean, damageMultiplier: number, accuracyMultiplier: number, priorityMod: number, noCooldown: boolean, message: string }}
 */
export function getUnboundArtsModifier(weather, style, pokemon, opponent) {
    const config = getWeatherConfig(weather);
    if (!config?.effects?.unboundArts?.enabled) {
        return { active: false, damageMultiplier: 1.0, accuracyMultiplier: 1.0, priorityMod: 0, noCooldown: false, message: '' };
    }
    const ua = config.effects.unboundArts;
    const op = config.effects.originPulse;
    // ä½¿ç”¨ POKEMON_CATEGORIES æ£€æŸ¥æ´—ç¿ /èµ·æºå½¢æ€
    const pokemonId = (pokemon?.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    let isHisuian = false;
    let isOrigin = false;
    if (typeof window !== 'undefined' && window.POKEMON_CATEGORIES) {
        const cats = window.POKEMON_CATEGORIES;
        isHisuian = cats.isPokemonInCategory(pokemonId, 'hisuian');
        isOrigin = cats.isPokemonInCategory(pokemonId, 'origin');
    } else {
        // é™çº§ï¼šä½¿ç”¨å­—ç¬¦ä¸²åŒ¹é…
        isHisuian = pokemonId.includes('hisui');
        isOrigin = pokemonId.includes('origin');
    }
    const hasOriginBonus = isHisuian || isOrigin;
    if (style === 'strong') {
        const ss = ua.strongStyle;
        let accMult = ss.accuracyMultiplier || 0.85;
        // æ´—ç¿ /èµ·æºå½¢æ€æ— è§†å‘½ä¸­æƒ©ç½š
        if (hasOriginBonus && op?.hisuianBonus?.strongStyleIgnoreAccPenalty) {
            accMult = 1.0;
            console.log(`[CHRONAL RIFT] ğŸŒ€ èµ·æºå…±é¸£ï¼š${pokemon?.cnName || pokemon?.name} åˆšçŒ›æ— è§†å‘½ä¸­æƒ©ç½š`);
        }
        return {
            active: true,
            damageMultiplier: ss.damageMultiplier || 1.5,
            accuracyMultiplier: accMult,
            priorityMod: ss.priority || -1,
            noCooldown: ss.noCooldown || true,
            message: `<span style="color:#ef4444">âš”ï¸ æ´—ç¿ æ— æ³•ãƒ»åˆšçŒ›ï¼ä¼¤å®³ x${ss.damageMultiplier}${accMult < 1 ? `ï¼Œå‘½ä¸­ x${accMult}` : ''}ï¼</span>`
        };
    }
    if (style === 'agile') {
        const as = ua.agileStyle;
        const userSpeed = pokemon?.spe || pokemon?.stats?.spe || 100;
        const oppSpeed = opponent?.spe || opponent?.stats?.spe || 100;
        const isFaster = userSpeed >= oppSpeed;
        let powerMult = isFaster ? (as.powerIfFaster || 1.0) : (as.powerIfSlower || 0.9);
        // æ´—ç¿ /èµ·æºå½¢æ€æ€»æ˜¯æ»¡å¨åŠ›
        if (hasOriginBonus && op?.hisuianBonus?.agileStyleFullPower) {
            powerMult = 1.0;
            console.log(`[CHRONAL RIFT] ğŸŒ€ èµ·æºå…±é¸£ï¼š${pokemon?.cnName || pokemon?.name} è¿…ç–¾æ— è§†å¨åŠ›å‰Šå‡`);
        }
        return {
            active: true,
            damageMultiplier: powerMult,
            accuracyMultiplier: 1.0,
            priorityMod: as.priorityBoost || 1,
            noCooldown: as.noCooldown || true,
            message: `<span style="color:#3b82f6">ğŸ’¨ æ´—ç¿ æ— æ³•ãƒ»è¿…ç–¾ï¼ä¼˜å…ˆåº¦ +${as.priorityBoost}${powerMult < 1 ? `ï¼Œå¨åŠ› x${powerMult}` : ''}ï¼</span>`
        };
    }
    return { active: false, damageMultiplier: 1.0, accuracyMultiplier: 1.0, priorityMod: 0, noCooldown: false, message: '' };
}
/**
 * æ£€æŸ¥é€Ÿåº¦ç†µå¢æ•ˆæœ (Entropy Flux)
 * @param {string} weather å¤©æ°” ID
 * @returns {{ shouldTrigger: boolean, message: string }}
 */
export function checkEntropyFlux(weather) {
    const config = getWeatherConfig(weather);
    if (!config?.effects?.entropyFlux?.enabled) {
        return { shouldTrigger: false, message: '' };
    }
    const ef = config.effects.entropyFlux;
    const roll = Math.random();
    if (roll < (ef.triggerChance || 0.15)) {
        console.log(`[CHRONAL RIFT] âš¡ é€Ÿåº¦ç†µå¢ï¼šæ—¶ç©ºç¿»è½¬è§¦å‘ï¼(Roll: ${(roll * 100).toFixed(1)}%)`);
        return {
            shouldTrigger: true,
            message: `<span style="color:#a855f7; font-size:1.1em">âš¡ æ—¶ç©ºç¿»è½¬ï¼ç»´åº¦çš„æµå‘ç¬é—´é€†è½¬äº†ï¼</span>`
        };
    }
    return { shouldTrigger: false, message: '' };
}
/**
 * æ£€æŸ¥æŠ€èƒ½é»‘ç®±æ•ˆæœ (Move Glitch)
 * @param {string} weather å¤©æ°” ID
 * @param {object} move æ‹›å¼
 * @param {object} user ä½¿ç”¨è€…
 * @returns {{ triggered: boolean, effect: 'critical'|'fail'|'normal', powerMultiplier: number, message: string }}
 */
export function checkMoveGlitch(weather, move, user) {
    const config = getWeatherConfig(weather);
    if (!config?.effects?.moveGlitch?.enabled) {
        return { triggered: false, effect: 'normal', powerMultiplier: 1.0, message: '' };
    }
    const mg = config.effects.moveGlitch;
    const moveId = (move?.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const userId = (user?.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    // æ£€æŸ¥æ˜¯å¦ä¸ºå—å½±å“çš„æ‹›å¼
    const isAffectedMove = mg.affectedMoves?.includes(moveId);
    // ä½¿ç”¨ POKEMON_CATEGORIES æ£€æŸ¥å®å¯æ¢¦åˆ†ç±»
    // æ³¨æ„ï¼šåªæœ‰ Artificial ç±»å’Œ iron å¼€å¤´çš„æœªæ¥æ‚–è°¬ç§è§¦å‘æŠ€èƒ½é»‘ç®±
    // Miraidon/Koraidon ç­‰å°é¢ç¥å…½ä¸è§¦å‘
    let isAffectedPokemon = false;
    if (typeof window !== 'undefined' && window.POKEMON_CATEGORIES) {
        const cats = window.POKEMON_CATEGORIES;
        // äººé€ /æœºæ¢°ç±»
        isAffectedPokemon = cats.isPokemonInCategory(userId, 'artificial');
        // æœªæ¥æ‚–è°¬ç§ï¼ˆä»… iron å¼€å¤´çš„ï¼‰
        if (!isAffectedPokemon && userId.startsWith('iron')) {
            isAffectedPokemon = cats.isPokemonInCategory(userId, 'paradox_future');
        }
    } else {
        // é™çº§ï¼šä½¿ç”¨ç¡¬ç¼–ç åˆ—è¡¨
        const artificialList = ['porygon', 'porygon2', 'porygonz', 'magnemite', 'magneton', 'magnezone',
            'genesect', 'metagross', 'magearna', 'rotomheat', 'rotomwash', 'rotomfrost', 'rotomfan', 'rotommow'];
        isAffectedPokemon = artificialList.some(p => userId.includes(p)) || userId.startsWith('iron');
    }
    if (!isAffectedMove && !isAffectedPokemon) {
        return { triggered: false, effect: 'normal', powerMultiplier: 1.0, message: '' };
    }
    const roll = Math.random();
    // 20% æš´å‡»æˆåŠŸ
    if (roll < (mg.criticalSuccessChance || 0.20)) {
        const mult = mg.criticalSuccessMultiplier || 2.0;
        console.log(`[CHRONAL RIFT] ğŸ’¥ æŠ€èƒ½é»‘ç®±ï¼š${move.name} æš´èµ°ï¼å¨åŠ› x${mult}`);
        return {
            triggered: true,
            effect: 'critical',
            powerMultiplier: mult,
            message: `<span style="color:#22c55e">ğŸ’¥ æŠ€èƒ½é»‘ç®±ãƒ»æš´èµ°ï¼${move.name} çš„æ•°æ®æº¢å‡ºï¼å¨åŠ› x${mult}ï¼</span>`
        };
    }
    // 10% å¤±è´¥
    if (roll < (mg.criticalSuccessChance || 0.20) + (mg.criticalFailChance || 0.10)) {
        console.log(`[CHRONAL RIFT] âŒ æŠ€èƒ½é»‘ç®±ï¼š${move.name} å´©æºƒï¼å¨åŠ› x0`);
        return {
            triggered: true,
            effect: 'fail',
            powerMultiplier: 0,
            message: `<span style="color:#ef4444">âŒ æŠ€èƒ½é»‘ç®±ãƒ»å´©æºƒï¼${move.name} çš„æ•°æ®æŸåï¼æ‹›å¼å¤±è´¥ï¼</span>`
        };
    }
    return { triggered: false, effect: 'normal', powerMultiplier: 1.0, message: '' };
}
/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºæ—¶ç©ºè£‚éš™å¤©æ°”
 * @param {string} weather å¤©æ°” ID
 * @returns {boolean}
 */
export function isChronalRift(weather) {
    return weather === 'chronalrift';
}
// ============================================
// ç¯å¢ƒå¤©æ°”å‹åˆ¶ç³»ç»Ÿ (Suppression Tier System)
// ============================================
/**
 * å‹åˆ¶ç­‰çº§å¸¸é‡
 * Tier 1: æ— å½±å“ - å®å¯æ¢¦å¤©æ°”æ­£å¸¸è¦†ç›–
 * Tier 2: æœ‰æŠ‘åˆ¶ - å®å¯æ¢¦å¤©æ°”æŒç»­å›åˆæ•°å‡åŠ
 * Tier 3: ç»å¯¹é¢†åŸŸ - å®å¯æ¢¦å¤©æ°”æŠ€èƒ½ç›´æ¥å¤±è´¥
 */
export const SUPPRESSION_TIER = {
    NORMAL: 1,
    SUPPRESSED: 2,
    ABSOLUTE: 3
};
/**
 * è·å–ç¯å¢ƒå¤©æ°”çš„å‹åˆ¶ç­‰çº§ (æ—§ç‰ˆå…¼å®¹)
 * @param {object} battle æˆ˜æ–—å®ä¾‹
 * @returns {number} å‹åˆ¶ç­‰çº§ (1/2/3)
 * @deprecated ä½¿ç”¨ getWeatherSuppressionStatus ä»£æ›¿
 */
export function getEnvironmentSuppressionTier(battle) {
    if (!battle || !battle.environmentWeather) return SUPPRESSION_TIER.NORMAL;
    // ä¼˜å…ˆä» battle.environmentConfig è¯»å–é…ç½®
    if (battle.environmentConfig && battle.environmentConfig.suppressionTier) {
        return battle.environmentConfig.suppressionTier;
    }
    // æ–°ç‰ˆæ ¼å¼: suppression å¯¹è±¡
    if (battle.environmentConfig?.suppression?.all === 'blocked') {
        return SUPPRESSION_TIER.ABSOLUTE;
    }
    // é»˜è®¤æ ¹æ®å¤©æ°”ç±»å‹æ¨æ–­
    const weather = battle.environmentWeather;
    const config = getWeatherConfig(weather);
    // å§‹æºå¤©æ°” = ç»å¯¹é¢†åŸŸ
    if (config?.isPrimal) {
        return SUPPRESSION_TIER.ABSOLUTE;
    }
    // åŒºåŸŸå¤©æ°” = æœ‰æŠ‘åˆ¶
    if (config?.isRegional) {
        return SUPPRESSION_TIER.SUPPRESSED;
    }
    // æ™®é€šå¤©æ°” = æ— å½±å“
    return SUPPRESSION_TIER.NORMAL;
}
/**
 * ã€æ–°ç‰ˆã€‘è·å–ç‰¹å®šå¤©æ°”çš„å‹åˆ¶çŠ¶æ€
 * @param {object} battle æˆ˜æ–—å®ä¾‹
 * @param {string} targetWeather è¦å±•å¼€çš„å¤©æ°” ID
 * @returns {{ status: 'normal'|'suppressed'|'blocked', reason: string }}
 */
export function getWeatherSuppressionStatus(battle, targetWeather) {
    const normalResult = { status: 'normal', reason: '' };
    if (!battle || !battle.environmentWeather) return normalResult;
    const envConfig = battle.environmentConfig || {};
    const suppression = envConfig.suppression || {};
    const weatherId = (targetWeather || '').toLowerCase();
    // æ ‡å‡†åŒ–å¤©æ°” ID (hail -> snow)
    const normalizedWeather = normalizeWeatherId(weatherId);
    // æ–°ç‰ˆæ ¼å¼: suppression å¯¹è±¡
    // 1. æ£€æŸ¥ all å­—æ®µ (å…¨å±€è®¾ç½®)
    if (suppression.all === 'blocked') {
        return { 
            status: 'blocked', 
            reason: `ç¯å¢ƒå¤©æ°”å®Œå…¨å‹åˆ¶æ‰€æœ‰å®å¯æ¢¦å¤©æ°”` 
        };
    }
    if (suppression.all === 'suppressed') {
        return { 
            status: 'suppressed', 
            reason: `ç¯å¢ƒå¤©æ°”æŠ‘åˆ¶æ‰€æœ‰å®å¯æ¢¦å¤©æ°”` 
        };
    }
    // 2. æ£€æŸ¥ blocked æ•°ç»„ (å®Œå…¨é˜»æ­¢)
    if (Array.isArray(suppression.blocked)) {
        const blockedList = suppression.blocked.map(w => normalizeWeatherId(w.toLowerCase()));
        if (blockedList.includes(normalizedWeather)) {
            return { 
                status: 'blocked', 
                reason: `${targetWeather} è¢«ç¯å¢ƒå¤©æ°”å®Œå…¨é˜»æ­¢` 
            };
        }
    }
    // 3. æ£€æŸ¥ suppressed æ•°ç»„ (å›åˆå‡åŠ)
    if (Array.isArray(suppression.suppressed)) {
        const suppressedList = suppression.suppressed.map(w => normalizeWeatherId(w.toLowerCase()));
        if (suppressedList.includes(normalizedWeather)) {
            return { 
                status: 'suppressed', 
                reason: `${targetWeather} è¢«ç¯å¢ƒå¤©æ°”æŠ‘åˆ¶` 
            };
        }
    }
    // 4. æ—§ç‰ˆå…¼å®¹: suppressionTier æ•°å­—
    if (envConfig.suppressionTier === 3 || envConfig.suppressionTier === SUPPRESSION_TIER.ABSOLUTE) {
        return { 
            status: 'blocked', 
            reason: `ç¯å¢ƒå¤©æ°”å®Œå…¨å‹åˆ¶æ‰€æœ‰å®å¯æ¢¦å¤©æ°” (tier 3)` 
        };
    }
    if (envConfig.suppressionTier === 2 || envConfig.suppressionTier === SUPPRESSION_TIER.SUPPRESSED) {
        return { 
            status: 'suppressed', 
            reason: `ç¯å¢ƒå¤©æ°”æŠ‘åˆ¶æ‰€æœ‰å®å¯æ¢¦å¤©æ°” (tier 2)` 
        };
    }
    // 5. é»˜è®¤æ ¹æ®ç¯å¢ƒå¤©æ°”ç±»å‹æ¨æ–­
    const envWeatherConfig = getWeatherConfig(battle.environmentWeather);
    if (envWeatherConfig?.isPrimal) {
        return { 
            status: 'blocked', 
            reason: `å§‹æºå¤©æ°”å®Œå…¨å‹åˆ¶æ‰€æœ‰å®å¯æ¢¦å¤©æ°”` 
        };
    }
    if (envWeatherConfig?.isRegional) {
        return { 
            status: 'suppressed', 
            reason: `åŒºåŸŸå¤©æ°”æŠ‘åˆ¶æ‰€æœ‰å®å¯æ¢¦å¤©æ°”` 
        };
    }
    return normalResult;
}
/**
 * ã€æ ¸å¿ƒå‡½æ•°ã€‘å°è¯•å±•å¼€å®å¯æ¢¦å¤©æ°”ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
 * @param {object} battle æˆ˜æ–—å®ä¾‹
 * @param {string} newWeather è¦å±•å¼€çš„å¤©æ°” ID
 * @param {object} options é…ç½®é¡¹
 * @param {string} options.itemId ä½¿ç”¨è€…çš„é“å…· IDï¼ˆç”¨äºå»¶é•¿å²©çŸ³åˆ¤å®šï¼‰
 * @param {string} options.weatherName å¤©æ°”ä¸­æ–‡åï¼ˆç”¨äºæ—¥å¿—ï¼‰
 * @param {string} options.visualKey è§†è§‰æ•ˆæœ keyï¼ˆç”¨äº setWeatherVisualsï¼‰
 * @returns {{ success: boolean, logs: string[], weatherTurns: number }}
 */
export function tryDeployWeather(battle, newWeather, options = {}) {
    const logs = [];
    // ã€æ–°ç‰ˆã€‘ä½¿ç”¨æŒ‰å¤©æ°”çš„å‹åˆ¶çŠ¶æ€æ£€æŸ¥
    const suppressionStatus = getWeatherSuppressionStatus(battle, newWeather);
    // blocked: å®Œå…¨é˜»æ­¢
    if (suppressionStatus.status === 'blocked') {
        const envConfig = getWeatherConfig(battle.environmentWeather);
        const envName = envConfig?.name || battle.environmentWeather;
        logs.push(`<span style="color:#dc2626">â›” ${envName}çš„åŠ›é‡å¤ªè¿‡å¼ºå¤§ï¼Œ${options.weatherName || newWeather}æ— æ³•ç”Ÿæ•ˆï¼</span>`);
        console.log(`[WEATHER] ${newWeather} blocked: ${suppressionStatus.reason}`);
        return { success: false, logs, weatherTurns: 0 };
    }
    // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯è¯¥å¤©æ°”
    const sameWeatherMap = {
        'rain': ['rain', 'heavyrain'],
        'sun': ['sun', 'harshsun'],
        'sandstorm': ['sandstorm'],
        'hail': ['hail', 'snow'],
        'snow': ['snow', 'hail']
    };
    const sameWeathers = sameWeatherMap[newWeather] || [newWeather];
    if (sameWeathers.includes(battle.weather)) {
        logs.push('<span style="color:#e74c3c">ä½†æ˜¯å¤±è´¥äº†ï¼</span>');
        return { success: false, logs, weatherTurns: 0 };
    }
    // è®¡ç®—æŒç»­å›åˆ
    const rockMap = {
        'rain': 'damprock',
        'sun': 'heatrock',
        'sandstorm': 'smoothrock',
        'hail': 'icyrock',
        'snow': 'icyrock'
    };
    const extendRock = rockMap[newWeather];
    const itemId = (options.itemId || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    let baseTurns = (extendRock && itemId === extendRock) ? 8 : 5;
    let finalTurns = baseTurns;
    // suppressed: å›åˆæ•°å‡åŠ
    if (suppressionStatus.status === 'suppressed') {
        finalTurns = Math.floor(baseTurns / 2);
        const weatherName = options.weatherName || newWeather;
        logs.push(`<span style="color:#f59e0b">âš ï¸ ç¯å¢ƒå¤©æ°”çš„å‹åˆ¶ä½¿${weatherName}æŒç»­æ—¶é—´å‡åŠï¼(${baseTurns}â†’${finalTurns}å›åˆ)</span>`);
    }
    // è®¾ç½®å¤©æ°”
    battle.weather = newWeather;
    battle.weatherTurns = finalTurns;
    // æ›´æ–°è§†è§‰æ•ˆæœ
    const visualKey = options.visualKey || newWeather;
    if (typeof window !== 'undefined' && window.setWeatherVisuals) {
        window.setWeatherVisuals(visualKey);
    }
    console.log(`[WEATHER] Deployed ${newWeather}: ${finalTurns} turns (status=${suppressionStatus.status})`);
    return { success: true, logs, weatherTurns: finalTurns };
}
/**
 * è·å–å¤©æ°”å›å½’æ—¶çš„æ—¥å¿—æ¶ˆæ¯
 * @param {object} battle æˆ˜æ–—å®ä¾‹
 * @returns {string} å›å½’æ—¥å¿—
 */
export function getWeatherRevertMessage(battle) {
    if (!battle || !battle.environmentWeather) return '';
    // ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰æ¶ˆæ¯
    if (battle.environmentConfig && battle.environmentConfig.revertMessage) {
        return battle.environmentConfig.revertMessage;
    }
    // é»˜è®¤æ¶ˆæ¯
    const config = getWeatherConfig(battle.environmentWeather);
    const envName = config?.name || battle.environmentWeather;
    if (config?.isRegional) {
        return `<span style="color:#9b59b6">ğŸŒ è‡ªç„¶çš„æ¶æ„å‹å€’äº†å¼ºè¡Œæ”¹å˜çš„æ°”è±¡ï¼Œ${envName}å†æ¬¡ç¬¼ç½©äº†æˆ˜åœºï¼</span>`;
    }
    return `<span style="color:#9b59b6">ğŸŒ ç¯å¢ƒå¤©æ°”å›å½’ï¼š${envName}ï¼</span>`;
}
// ============================================
// å¯¼å‡ºåˆ°å…¨å±€
// ============================================
if (typeof window !== 'undefined') {
    window.WeatherEffects = {
        normalizeWeatherId,
        getWeatherConfig,
        isPrimalWeather,
        getPrimalWeathers,
        isWeatherDamageImmune,
        getWeatherDamage,
        getWeatherDamageLog,
        getWeatherPowerModifier,
        getWeatherAccuracyModifier,
        getWeatherDefenseBoost,
        checkWeatherBlocksMove,
        canUseAuroraVeil,
        isSolarBeamInstant,
        getWeatherBallStats,
        getRecoveryRatio,
        // é€šç”¨å‡½æ•°
        getHealingMultiplier,
        applyHeal,  // ã€ç»Ÿä¸€æ²»æ„ˆå‡½æ•°ã€‘æ‰€æœ‰å›å¤æ¥æºéƒ½åº”ä½¿ç”¨æ­¤å‡½æ•°
        isGrounded, // æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦æ¥åœ°
        // Ambrosia (ç¥ä¹‹ç¼æµ†) ä¸“ç”¨å‡½æ•°
        getPsychicMindCritBoost,
        getAVSMultiplier,
        checkNeuroBacklash,
        applyNeuroBacklashConfusion,
        isTerrainInfinite,
        checkContaminationRecoil,
        // Chronal Rift (æ—¶ç©ºè£‚éš™) ä¸“ç”¨å‡½æ•°
        isChronalRift,
        checkParadoxResonance,
        checkBeastAura,
        getUnboundArtsModifier,
        checkEntropyFlux,
        checkMoveGlitch,
        // å‹åˆ¶ç³»ç»Ÿ
        SUPPRESSION_TIER,
        getEnvironmentSuppressionTier,  // æ—§ç‰ˆå…¼å®¹
        getWeatherSuppressionStatus,    // æ–°ç‰ˆï¼šæŒ‰å¤©æ°”æ£€æŸ¥å‹åˆ¶çŠ¶æ€
        tryDeployWeather,  // ç»Ÿä¸€å…¥å£å‡½æ•°
        getWeatherRevertMessage,
        WEATHER_CONFIG
    };
}
]]></file>
    </directory>
    <directory name="mechanics">
        <directory name="form-change">
            <file name="form-change-system.js"><![CDATA[/**
 * =============================================
 * FORM CHANGE SYSTEM - ç»Ÿä¸€å½¢æ€å˜åŒ–ç³»ç»Ÿ
 * =============================================
 * 
 * æ•´åˆè‡ª:
 * - form-change-system.js (é€šç”¨å½¢æ€å˜åŒ–)
 * - mega-selection-dialog.js (Mega X/Y é€‰æ‹©)
 * - necrozma-fusion.js (å¥ˆå…‹æ´›å…¹ç›åˆä½“)
 * 
 * æ”¯æŒçš„å½¢æ€å˜åŒ–ç±»å‹ï¼š
 * 1. Mega Evolutionï¼ˆè¶…è¿›åŒ–ï¼‰- æŒ‰é’®è§¦å‘
 * 2. Ultra Burstï¼ˆç©¶æçˆ†å‘ï¼‰- æŒ‰é’®è§¦å‘
 * 3. Primal Reversionï¼ˆåŸå§‹å›å½’ï¼‰- è¿›åœºè‡ªåŠ¨è§¦å‘
 * 4. Crowned Formï¼ˆå‰‘ç›¾ä¹‹ç‹ï¼‰- è¿›åœºè‡ªåŠ¨è§¦å‘
 * 5. Battle Bondï¼ˆç¾ç»Šè¿›åŒ–ï¼‰- å‡»æ€è§¦å‘
 * 6. HP-Threshold Formsï¼ˆè¡€é‡é˜ˆå€¼å½¢æ€ï¼‰- HP å˜åŒ–è§¦å‘
 * 7. Necrozma Fusionï¼ˆå¥ˆå…‹æ´›å…¹ç›åˆä½“ï¼‰- å¼€å±€è§¦å‘
 */
(function() {
'use strict';
// ============================================
// ç¬¬ä¸€éƒ¨åˆ†ï¼šé€šç”¨å½¢æ€å˜åŒ–æ ¸å¿ƒé€»è¾‘
// ============================================
/**
 * æ‰§è¡Œé€šç”¨å½¢æ€å˜åŒ–ï¼ˆå¼•æ“å±‚é¢ï¼‰
 * @param {Pokemon} pokemon - è¦å˜å½¢çš„å®å¯æ¢¦
 * @param {string} targetFormId - ç›®æ ‡å½¢æ€ IDï¼ˆå¦‚ 'charizardmegax', 'kyogreprimal'ï¼‰
 * @param {string} formType - å½¢æ€ç±»å‹ï¼ˆ'mega', 'primal', 'ultra', 'crowned' ç­‰ï¼‰
 * @returns {object|null} - å˜åŒ–ç»“æœä¿¡æ¯ï¼Œæˆ– null å¦‚æœå¤±è´¥
 */
function performFormChange(pokemon, targetFormId, formType = 'mega') {
    if (!targetFormId) {
        console.warn(`[FORM] No target form ID provided for ${pokemon.name}`);
        return null;
    }
    const formData = getPokemonData(targetFormId);
    if (!formData) {
        console.warn(`[FORM] Form data not found: ${targetFormId}`);
        return null;
    }
    // ä¿å­˜æ—§æ•°æ®ç”¨äºæ—¥å¿—
    const oldName = pokemon.cnName;
    const oldTypes = [...pokemon.types];
    const oldAbility = pokemon.ability;
    // æ›´æ–°åŸºç¡€æ•°æ®
    pokemon.name = formData.name;
    // é‡æ–°ç¿»è¯‘æ–°å½¢æ€çš„åå­—
    if (typeof window !== 'undefined' && window.Locale) {
        const transName = window.Locale.get(formData.name);
        if (transName === formData.name && formType === 'minior') {
            pokemon.cnName = `å°é™¨æ˜Ÿ-${transName.split('-')[1] || 'æ ¸å¿ƒ'}`;
        } 
        else if (transName === formData.name && formData.name.includes("-Hisui")) {
            const baseName = window.Locale.get(formData.name.split('-')[0]);
            pokemon.cnName = `${baseName}-æ´—ç¿ `;
        }
        else {
            pokemon.cnName = transName;
        }
    } else {
        pokemon.cnName = formData.name;
    }
    pokemon.types = formData.types || pokemon.types;
    pokemon.baseStats = formData.baseStats;
    // è·å–æ–°å½¢æ€çš„ç‰¹æ€§
    const formPokedexData = typeof POKEDEX !== 'undefined' ? POKEDEX[targetFormId] : null;
    if (formPokedexData && formPokedexData.abilities) {
        pokemon.ability = formPokedexData.abilities['0'] || formPokedexData.abilities['H'] || pokemon.ability;
    }
    // é‡æ–°è®¡ç®—èƒ½åŠ›å€¼
    const oldHp = pokemon.currHp;
    const oldMaxHp = pokemon.maxHp;
    let autoEv = Math.floor(pokemon.level * 1.5);
    if (autoEv > 85) autoEv = 85;
    const newStats = calcStats(formData.baseStats, pokemon.level, 31, autoEv);
    // HP å¤„ç†ï¼šå¤§éƒ¨åˆ†å½¢æ€å˜åŒ–ä¿æŒ HP ä¸å˜ï¼Œä½†åŸºæ ¼å°”å¾·å®Œå…¨ä½“ä¾‹å¤–
    const isZygardeComplete = targetFormId === 'zygardecomplete';
    if (isZygardeComplete) {
        const hpRatio = oldHp / oldMaxHp;
        pokemon.maxHp = newStats.hp;
        pokemon.currHp = Math.floor(pokemon.maxHp * hpRatio);
    } else {
        pokemon.maxHp = oldMaxHp;
        pokemon.currHp = oldHp;
    }
    // æ›´æ–°å…¶ä»–èƒ½åŠ›å€¼
    pokemon.atk = newStats.atk;
    pokemon.def = newStats.def;
    pokemon.spa = newStats.spa;
    pokemon.spd = newStats.spd;
    pokemon.spe = newStats.spe;
    // æ ‡è®°å·²å˜å½¢
    pokemon.isTransformed = true;
    pokemon.currentForm = targetFormId;
    pokemon.formType = formType;
    // å‘åå…¼å®¹ï¼šå¦‚æœæ˜¯ Mega/Ultraï¼Œä¹Ÿæ ‡è®° isMega
    if (formType === 'mega' || formType === 'ultra') {
        pokemon.isMega = true;
    }
    // è¿”å›å˜åŒ–ä¿¡æ¯
    const typeChanged = JSON.stringify(oldTypes) !== JSON.stringify(pokemon.types);
    const abilityChanged = oldAbility !== pokemon.ability;
    return {
        success: true,
        oldName,
        newName: pokemon.cnName,
        formType,
        typeChanged,
        newTypes: pokemon.types,
        abilityChanged,
        newAbility: pokemon.ability
    };
}
/**
 * æ£€æŸ¥å¹¶æ‰§è¡Œè¿›åœºæ—¶çš„è‡ªåŠ¨å½¢æ€å˜åŒ–ï¼ˆInit-Transformï¼‰
 */
function checkInitTransform(pokemon) {
    if (pokemon.needsInitTransform && pokemon.initTransformTarget && !pokemon.isTransformed) {
        console.log(`[FORM] Init-Transform triggered for ${pokemon.name} -> ${pokemon.initTransformTarget}`);
        const result = performFormChange(pokemon, pokemon.initTransformTarget, pokemon.initTransformType);
        pokemon.needsInitTransform = false;
        return result;
    }
    return null;
}
/**
 * æ£€æŸ¥å¹¶æ‰§è¡Œå‡»æ€è§¦å‘çš„å½¢æ€å˜åŒ–ï¼ˆBattle Bondï¼‰
 */
function checkBattleBondTransform(pokemon) {
    if (pokemon.ability !== 'Battle Bond') return null;
    const baseId = pokemon.name.toLowerCase().replace(/[^a-z0-9]/g, '');
    if (baseId === 'greninjaash' || pokemon.isTransformed) return null;
    const targetId = 'greninjaash';
    const targetData = getPokemonData(targetId);
    if (!targetData) return null;
    console.log(`[FORM] Battle Bond triggered: ${pokemon.name} -> Ash-Greninja`);
    return performFormChange(pokemon, targetId, 'battlebond');
}
/**
 * æ£€æŸ¥å¹¶æ‰§è¡Œè¡€é‡é˜ˆå€¼è§¦å‘çš„å½¢æ€å˜åŒ–
 */
function checkHPThresholdTransform(pokemon) {
    const baseId = pokemon.name.toLowerCase().replace(/[^a-z0-9]/g, '');
    const hpRatio = pokemon.currHp / pokemon.maxHp;
    // å¼±ä¸é±¼ (Wishiwashi) - é±¼ç¾¤ç‰¹æ€§
    if (pokemon.ability === 'Schooling' && baseId.includes('wishiwashi')) {
        const currentlySchool = baseId === 'wishiwashischool';
        if (hpRatio > 0.25 && !currentlySchool) {
            return performFormChange(pokemon, 'wishiwashischool', 'schooling');
        } else if (hpRatio <= 0.25 && currentlySchool) {
            return performFormChange(pokemon, 'wishiwashi', 'schooling');
        }
    }
    // åŸºæ ¼å°”å¾· (Zygarde) - ç¾¤èšå˜å½¢ç‰¹æ€§
    if (pokemon.ability === 'Power Construct' && baseId.includes('zygarde')) {
        const currentlyComplete = baseId === 'zygardecomplete';
        if (hpRatio < 0.5 && !currentlyComplete && !pokemon._zygardeTransformed) {
            pokemon._zygardeTransformed = true;
            return performFormChange(pokemon, 'zygardecomplete', 'powerconstruct');
        }
    }
    // å°é™¨æ˜Ÿ (Minior) - ç•Œé™ç›¾ç‰¹æ€§
    if (pokemon.ability === 'Shields Down' && baseId.includes('minior')) {
        const currentlyShielded = !baseId.includes('core');
        if (hpRatio > 0.5 && !currentlyShielded) {
            return performFormChange(pokemon, 'minior', 'shieldsdown');
        } else if (hpRatio <= 0.5 && currentlyShielded) {
            return performFormChange(pokemon, 'miniorcoreform', 'shieldsdown');
        }
    }
    // è¾¾æ‘©ç‹’ç‹’ (Darmanitan) - è¾¾æ‘©æ¨¡å¼ç‰¹æ€§
    // æ™®é€šç‰ˆï¼šdarmanitan <-> darmanitanzen
    // ä¼½å‹’å°”ç‰ˆï¼šdarmanitangalar <-> darmanitangalarzen
    if (pokemon.ability === 'Zen Mode' && baseId.includes('darmanitan')) {
        const isZen = baseId.includes('zen');
        const isGalar = baseId.includes('galar');
        // HP <= 50% ä¸”ä¸æ˜¯è¾¾æ‘©æ¨¡å¼ -> å˜æˆè¾¾æ‘©æ¨¡å¼
        if (hpRatio <= 0.5 && !isZen) {
            const targetId = isGalar ? 'darmanitangalarzen' : 'darmanitanzen';
            const result = performFormChange(pokemon, targetId, 'zenmode');
            if (result && result.success) {
                console.log(`[ZEN MODE] ${pokemon.cnName} å˜æˆäº†è¾¾æ‘©æ¨¡å¼ï¼`);
            }
            return result;
        }
        // HP > 50% ä¸”æ˜¯è¾¾æ‘©æ¨¡å¼ -> å˜å›æ™®é€šæ¨¡å¼
        else if (hpRatio > 0.5 && isZen) {
            const targetId = isGalar ? 'darmanitangalar' : 'darmanitan';
            const result = performFormChange(pokemon, targetId, 'zenmode');
            if (result && result.success) {
                console.log(`[ZEN MODE] ${pokemon.cnName} æ¢å¤äº†æ™®é€šæ¨¡å¼ï¼`);
            }
            return result;
        }
    }
    return null;
}
// ============================================
// ç¬¬äºŒéƒ¨åˆ†ï¼šå¯¹è¯æ¡†é€šç”¨æ ·å¼
// ============================================
function injectDialogStyles() {
    if (document.getElementById('form-change-dialog-style')) return;
    const style = document.createElement('style');
    style.id = 'form-change-dialog-style';
    style.textContent = `
        :root {
            --fc-mega-x-color: #3b82f6;
            --fc-mega-y-color: #ef4444;
            --fc-mega-base-color: #a855f7;
            --fc-fusion-dusk-color: #f59e0b;
            --fc-fusion-dawn-color: #8b5cf6;
            --fc-fusion-ultra-color: #fbbf24;
        }
        .fc-overlay {
            animation: fcFadeIn 0.3s ease-out forwards;
        }
        @keyframes fcFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fcGlassUp {
            from { opacity: 0; transform: translateY(30px) skewX(-10deg); }
            to { opacity: 1; transform: translateY(0) skewX(-10deg); }
        }
        .fc-bg-grid {
            background-image: 
                linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }
    `;
    document.head.appendChild(style);
}
/**
 * åˆ›å»ºé€šç”¨å¯¹è¯æ¡†å®¹å™¨
 */
function createDialogContainer(isDark = false) {
    injectDialogStyles();
    const overlay = document.createElement('div');
    overlay.className = 'fc-overlay';
    overlay.style.cssText = `
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, ${isDark ? '0.55' : '0.45'});
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 8000;
    `;
    const dialogShape = document.createElement('div');
    dialogShape.style.cssText = `
        position: relative;
        background: ${isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.85)'};
        backdrop-filter: blur(20px) saturate(1.8);
        -webkit-backdrop-filter: blur(20px) saturate(1.8);
        border: 1px solid rgba(255, 255, 255, ${isDark ? '0.1' : '0.6'});
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, ${isDark ? '0.6' : '0.4'});
        padding: 40px 60px;
        border-radius: 20px;
        max-width: ${isDark ? '800px' : '620px'};
        transform: skewX(-10deg);
        animation: fcGlassUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
    `;
    // èƒŒæ™¯ç½‘æ ¼
    const bgDecor = document.createElement('div');
    bgDecor.className = 'fc-bg-grid';
    bgDecor.style.cssText = `
        position: absolute;
        top: -50%; left: -50%; width: 200%; height: 200%;
        z-index: 0;
        pointer-events: none;
        transform: skewX(10deg);
        opacity: ${isDark ? '0.3' : '0.6'};
    `;
    dialogShape.appendChild(bgDecor);
    // å†…å®¹å®¹å™¨
    const content = document.createElement('div');
    content.style.cssText = `
        transform: skewX(10deg);
        position: relative;
        z-index: 5;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    `;
    return { overlay, dialogShape, content };
}
/**
 * åˆ›å»ºå–æ¶ˆæŒ‰é’®
 */
function createCancelButton(text, isDark, onClick) {
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = text;
    cancelBtn.style.cssText = `
        margin-top: 35px;
        background: transparent;
        border: 2px solid ${isDark ? '#475569' : '#cbd5e1'};
        color: ${isDark ? '#64748b' : '#94a3b8'};
        font-weight: 800;
        font-size: ${isDark ? '12px' : '13px'};
        letter-spacing: 1px;
        cursor: pointer;
        padding: 8px 32px;
        border-radius: 50px;
        transition: all 0.2s;
        font-family: inherit;
    `;
    cancelBtn.onmouseenter = () => {
        cancelBtn.style.borderColor = isDark ? '#64748b' : '#94a3b8';
        cancelBtn.style.color = isDark ? '#94a3b8' : '#64748b';
        cancelBtn.style.background = isDark ? 'rgba(255,255,255,0.05)' : '#fff';
    };
    cancelBtn.onmouseleave = () => {
        cancelBtn.style.borderColor = isDark ? '#475569' : '#cbd5e1';
        cancelBtn.style.color = isDark ? '#64748b' : '#94a3b8';
        cancelBtn.style.background = 'transparent';
    };
    cancelBtn.onclick = onClick;
    return cancelBtn;
}
// ============================================
// ç¬¬ä¸‰éƒ¨åˆ†ï¼šMega å½¢æ€é€‰æ‹©å¯¹è¯æ¡†
// ============================================
/**
 * æ˜¾ç¤º Mega å½¢æ€é€‰æ‹©å¯¹è¯æ¡†ï¼ˆå–·ç«é¾™/è¶…æ¢¦ X/Y é€‰æ‹©ï¼‰
 */
function showMegaFormSelectionDialog(pokemon, callback) {
    const { overlay, dialogShape, content } = createDialogContainer(false);
    // é¡¶éƒ¨å½©è‰²è£…é¥°æ¡
    const topBar = document.createElement('div');
    topBar.style.cssText = `
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 6px;
        background: linear-gradient(90deg, #3b82f6 0%, #a855f7 50%, #ef4444 100%);
        z-index: 2;
    `;
    dialogShape.appendChild(topBar);
    // æ ‡é¢˜
    const title = document.createElement('h2');
    title.innerHTML = `MEGA EVOLUTION`;
    title.style.cssText = `
        color: #1e293b;
        font-size: 36px;
        font-weight: 900;
        font-style: italic;
        margin: 0;
        letter-spacing: -1.5px;
        text-shadow: 2px 2px 0px rgba(255,255,255,0.4);
    `;
    const subTitle = document.createElement('div');
    subTitle.textContent = `Select form for ${pokemon.cnName || pokemon.name}`;
    subTitle.style.cssText = `
        color: #64748b;
        font-size: 15px;
        font-weight: 600;
        margin-top: 5px;
        margin-bottom: 35px;
        text-transform: uppercase;
        letter-spacing: 1px;
    `;
    // é€‰é¡¹æŒ‰é’®å®¹å™¨
    const optionsContainer = document.createElement('div');
    optionsContainer.style.cssText = `
        display: flex;
        gap: 24px;
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
    `;
    // å½¢æ€å¤„ç†
    const forms = pokemon.megaFormsAvailable || [];
    if (forms.length === 0) {
        const base = pokemon.name.toLowerCase();
        if (base.includes('mewtwo') || base.includes('charizard')) {
            forms.push(base.endsWith('mega') ? base + 'x' : base + 'megax');
            forms.push(base.endsWith('mega') ? base + 'y' : base + 'megay');
        } else {
            forms.push('default');
        }
    }
    forms.forEach(formId => {
        const isX = formId.toLowerCase().includes('x');
        const isY = formId.toLowerCase().includes('y');
        let labelLarge = isX ? 'X' : isY ? 'Y' : 'âˆ';
        let subText = isX ? 'ATTACK' : isY ? 'SPECIAL' : 'POWER';
        let themeColor = isX ? '#3b82f6' : isY ? '#ef4444' : '#a855f7';
        const btn = document.createElement('div');
        btn.style.cssText = `
            flex: 1;
            min-width: 130px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255,255,255,0.8);
            border-bottom: 4px solid ${themeColor}15;
            border-radius: 16px;
            padding: 25px 15px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        `;
        btn.innerHTML = `
            <div style="font-size: 12px; font-weight: 800; color: ${themeColor}; opacity: 0.8; letter-spacing: 1.5px; margin-bottom: 4px;">MEGA</div>
            <div style="font-size: 56px; font-weight: 900; color: #1e293b; line-height:1; font-style: italic; position: relative; z-index:2;">${labelLarge}</div>
            <div style="font-size: 11px; font-weight: 700; color: #94a3b8; margin-top: 4px; letter-spacing: 0.5px;">${subText}</div>
            <div class="fill-anim" style="
                position: absolute; bottom: 0; left: 0; right: 0; height: 0; 
                background: ${themeColor}; z-index: 1;
                transition: height 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            "></div>
        `;
        btn.onmouseenter = () => {
            btn.style.transform = 'translateY(-6px)';
            btn.style.borderBottomColor = themeColor;
            btn.style.boxShadow = `0 12px 25px -5px ${themeColor}40`;
            btn.children[0].style.color = 'rgba(255,255,255,0.8)';
            btn.children[1].style.color = '#fff';
            btn.children[2].style.color = 'rgba(255,255,255,0.6)';
            btn.querySelector('.fill-anim').style.height = '100%';
        };
        btn.onmouseleave = () => {
            btn.style.transform = 'translateY(0)';
            btn.style.borderBottomColor = `${themeColor}15`;
            btn.style.boxShadow = 'none';
            btn.children[0].style.color = themeColor;
            btn.children[1].style.color = '#1e293b';
            btn.children[2].style.color = '#94a3b8';
            btn.querySelector('.fill-anim').style.height = '0';
        };
        btn.onclick = () => {
            overlay.style.transition = 'opacity 0.2s';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.parentNode && overlay.parentNode.removeChild(overlay), 200);
            callback(formId);
        };
        optionsContainer.appendChild(btn);
    });
    // å–æ¶ˆæŒ‰é’®
    const cancelBtn = createCancelButton('CANCEL', false, () => {
        overlay.style.transition = 'opacity 0.2s';
        overlay.style.opacity = '0';
        setTimeout(() => overlay.parentNode && overlay.parentNode.removeChild(overlay), 200);
        callback(null);
    });
    // ç»„è£…
    content.appendChild(title);
    content.appendChild(subTitle);
    content.appendChild(optionsContainer);
    content.appendChild(cancelBtn);
    dialogShape.appendChild(content);
    overlay.appendChild(dialogShape);
    // æ·»åŠ åˆ° #ui-scale å†…éƒ¨ï¼Œç¡®ä¿åœ¨ .screen-filters çš„å±‚å ä¸Šä¸‹æ–‡ä¸­
    const uiScale = document.getElementById('ui-scale') || document.body;
    uiScale.appendChild(overlay);
    overlay.onclick = (e) => {
        if (e.target === overlay) cancelBtn.click();
    };
}
// ============================================
// ç¬¬å››éƒ¨åˆ†ï¼šNecrozma åˆä½“ç³»ç»Ÿ
// ============================================
/**
 * æ£€æµ‹é˜Ÿä¼ä¸­æ˜¯å¦å­˜åœ¨ Necrozma åˆä½“æ¡ä»¶
 */
function detectNecrozmaFusion(party) {
    if (!party || !Array.isArray(party)) return { canFuse: false };
    let necrozmaIndex = -1, lunalaIndex = -1, solgaleoIndex = -1;
    party.forEach((poke, index) => {
        if (!poke) return;
        const name = (poke.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        if (name === 'necrozma') necrozmaIndex = index;
        if (name === 'lunala') lunalaIndex = index;
        if (name === 'solgaleo') solgaleoIndex = index;
    });
    const hasLunala = lunalaIndex !== -1;
    const hasSolgaleo = solgaleoIndex !== -1;
    const hasNecrozma = necrozmaIndex !== -1;
    return {
        necrozmaIndex, lunalaIndex, solgaleoIndex,
        hasLunala, hasSolgaleo, hasNecrozma,
        canFuse: hasNecrozma && (hasLunala || hasSolgaleo),
        hasBothOptions: hasNecrozma && hasLunala && hasSolgaleo
    };
}
/**
 * æ‰§è¡Œ Necrozma åˆä½“
 */
function executeNecrozmaFusion(party, fusionType, detection) {
    const logs = [];
    if (!detection.canFuse) {
        return { success: false, logs: ['åˆä½“æ¡ä»¶ä¸æ»¡è¶³'], fusedPokemon: null };
    }
    const necrozma = party[detection.necrozmaIndex];
    let fusionPartner = null;
    let fusionPartnerIndex = -1;
    let newFormName = '';
    let newFormCnName = '';
    if (fusionType === 'dawn' && detection.hasLunala) {
        fusionPartner = party[detection.lunalaIndex];
        fusionPartnerIndex = detection.lunalaIndex;
        newFormName = 'Necrozma-Dawn-Wings';
        newFormCnName = 'æ‹‚æ™“ä¹‹ç¿¼Â·å¥ˆå…‹æ´›å…¹ç›';
    } else if (fusionType === 'dusk' && detection.hasSolgaleo) {
        fusionPartner = party[detection.solgaleoIndex];
        fusionPartnerIndex = detection.solgaleoIndex;
        newFormName = 'Necrozma-Dusk-Mane';
        newFormCnName = 'é»„æ˜ä¹‹é¬ƒÂ·å¥ˆå…‹æ´›å…¹ç›';
    } else {
        return { success: false, logs: ['æ— æ•ˆçš„åˆä½“ç±»å‹'], fusedPokemon: null };
    }
    const originalNecrozmaName = necrozma.cnName || necrozma.name;
    const originalPartnerName = fusionPartner.cnName || fusionPartner.name;
    // å˜å½¢ Necrozma
    necrozma.name = newFormName;
    necrozma.cnName = newFormCnName;
    if (typeof POKEDEX !== 'undefined') {
        const formId = newFormName.toLowerCase().replace(/[^a-z0-9]/g, '');
        const formData = POKEDEX[formId];
        if (formData) {
            necrozma.types = formData.types || necrozma.types;
            if (formData.baseStats) necrozma.baseStats = { ...formData.baseStats };
        }
    }
    // æ·»åŠ  Photon Geyser
    const hasPhotonGeyser = (necrozma.moves || []).some(m => {
        const moveName = (m.name || m || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        return moveName === 'photongeyser';
    });
    if (!hasPhotonGeyser) {
        const photonGeyserData = (typeof MOVES !== 'undefined' && MOVES.photongeyser) 
            ? { ...MOVES.photongeyser, name: 'Photon Geyser' }
            : { name: 'Photon Geyser', type: 'Psychic', power: 100, cat: 'spec', accuracy: 100 };
        if (necrozma.moves && necrozma.moves.length >= 4) {
            necrozma.moves[3] = photonGeyserData;
        } else if (necrozma.moves) {
            necrozma.moves.push(photonGeyserData);
        }
        logs.push(`${newFormCnName} ä¹ å¾—äº† å…‰å­å–·æ¶Œï¼`);
    }
    // é‡æ–°è®¡ç®—ç§æ—å€¼
    if (typeof necrozma.recalculateStats === 'function') necrozma.recalculateStats();
    // æ ‡è®°
    necrozma.isFused = true;
    necrozma.fusionType = fusionType;
    necrozma.fusionPartnerIndex = fusionPartnerIndex;
    // å¤„ç†åˆä½“ä¼™ä¼´
    fusionPartner.fusedIntoNecrozma = true;
    fusionPartner.fusionNecrozmaIndex = detection.necrozmaIndex;
    const originalMaxHp = fusionPartner.maxHp;
    const originalCurrHp = fusionPartner.currHp;
    fusionPartner.maxHp = Math.floor(fusionPartner.maxHp / 2);
    fusionPartner.currHp = Math.min(fusionPartner.currHp, fusionPartner.maxHp);
    logs.push(`âœ¦ ${originalNecrozmaName} ä¸ ${originalPartnerName} åˆä½“ï¼`);
    logs.push(`âœ¦ ${originalNecrozmaName} å˜ä¸º ${newFormCnName}ï¼`);
    logs.push(`âœ¦ ${originalPartnerName} çš„åŠ›é‡è¢«åˆ†äº«ï¼ŒHP å‡åŠ (${originalCurrHp}/${originalMaxHp} â†’ ${fusionPartner.currHp}/${fusionPartner.maxHp})ï¼`);
    return { success: true, logs, fusedPokemon: necrozma, fusionPartner };
}
/**
 * æ£€æµ‹æ˜¯å¦å¯ä»¥ Ultra Burst
 */
function canUltraBurst(pokemon) {
    if (!pokemon) return false;
    const name = (pokemon.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const isEligible = name === 'necrozmaduskmane' || name === 'necrozmadawnwings';
    return isEligible && pokemon.mechanic === 'zmove' && !pokemon.isUltraBursted;
}
/**
 * æ‰§è¡Œ Ultra Burst
 */
function executeUltraBurst(pokemon) {
    const logs = [];
    if (!canUltraBurst(pokemon)) {
        return { success: false, logs: ['æ— æ³•æ‰§è¡Œ Ultra Burst'] };
    }
    const originalName = pokemon.cnName || pokemon.name;
    pokemon.name = 'Necrozma-Ultra';
    pokemon.cnName = 'ç©¶æå¥ˆå…‹æ´›å…¹ç›';
    pokemon.isUltraBursted = true;
    delete pokemon._cachedBestZ;
    pokemon.types = ['Psychic', 'Dragon'];
    pokemon.ability = 'Neuroforce';
    pokemon.abilityName = 'è„‘æ ¸ä¹‹åŠ›';
    if (typeof POKEDEX !== 'undefined' && POKEDEX.necrozmaultra) {
        const ultraData = POKEDEX.necrozmaultra;
        if (ultraData.baseStats) pokemon.baseStats = { ...ultraData.baseStats };
    } else {
        pokemon.baseStats = { hp: 97, atk: 167, def: 97, spa: 167, spd: 97, spe: 129 };
    }
    if (typeof pokemon.recalculateStats === 'function') pokemon.recalculateStats();
    logs.push(`<b style="color:#fbbf24; text-shadow: 0 0 10px #fbbf24;">â˜€ ULTRA BURST â˜€</b>`);
    logs.push(`<span style="color:#fbbf24">${originalName} é‡Šæ”¾äº†å…‰è¾‰çš„åŠ›é‡ï¼</span>`);
    logs.push(`<span style="color:#fbbf24">âœ¦ ${originalName} å˜ä¸º ç©¶æå¥ˆå…‹æ´›å…¹ç›ï¼</span>`);
    logs.push(`<span style="color:#fbbf24">âœ¦ ç‰¹æ€§å˜ä¸º è„‘æ ¸ä¹‹åŠ› (Neuroforce)ï¼</span>`);
    return { success: true, logs };
}
/**
 * æ˜¾ç¤º Necrozma åˆä½“é€‰æ‹©å¯¹è¯æ¡†
 */
function showNecrozmaFusionDialog(necrozma, options, callback) {
    const { hasZMechanic, hasLunala, hasSolgaleo } = options;
    const { overlay, dialogShape, content } = createDialogContainer(true);
    // é¡¶éƒ¨å½©è‰²è£…é¥°æ¡
    const topBar = document.createElement('div');
    topBar.style.cssText = `
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 6px;
        background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 50%, #8b5cf6 100%);
        z-index: 2;
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    `;
    dialogShape.appendChild(topBar);
    // æ ‡é¢˜
    const title = document.createElement('h2');
    title.innerHTML = `NECROZMA FUSION`;
    title.style.cssText = `
        color: #fbbf24;
        font-size: 32px;
        font-weight: 900;
        font-style: italic;
        margin: 0;
        letter-spacing: -1px;
        text-shadow: 0 0 30px rgba(251, 191, 36, 0.5);
    `;
    const subTitle = document.createElement('div');
    subTitle.textContent = hasZMechanic ? `é€‰æ‹©åˆä½“å½¢æ€ (Z-MOVE å·²å¯ç”¨)` : `é€‰æ‹©åˆä½“å½¢æ€`;
    subTitle.style.cssText = `
        color: #94a3b8;
        font-size: 14px;
        font-weight: 600;
        margin-top: 8px;
        margin-bottom: 35px;
        text-transform: uppercase;
        letter-spacing: 2px;
    `;
    // ä¸»å®¹å™¨
    const mainContainer = document.createElement('div');
    mainContainer.style.cssText = `display: flex; flex-direction: column; gap: 16px; width: 100%;`;
    // åˆ›å»ºæŒ‰é’®çš„è¾…åŠ©å‡½æ•°
    const createOptionButton = (opt, isLarge) => {
        const btn = document.createElement('div');
        const padding = isLarge ? '24px 20px' : '16px 12px';
        const minHeight = isLarge ? '140px' : '80px';
        btn.style.cssText = `
            flex: 1;
            min-height: ${minHeight};
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255,255,255,0.1);
            border-bottom: 4px solid ${opt.color}30;
            border-radius: 16px;
            padding: ${padding};
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        `;
        const labelSize = isLarge ? '48px' : '32px';
        const subLabelSize = isLarge ? '11px' : '9px';
        const descSize = isLarge ? '13px' : '10px';
        const noteSize = isLarge ? '10px' : '8px';
        btn.innerHTML = `
            <div style="font-size: ${subLabelSize}; font-weight: 800; color: ${opt.color}; opacity: 0.8; letter-spacing: 1.5px; margin-bottom: 4px;">${opt.subLabel}</div>
            <div style="font-size: ${labelSize}; font-weight: 900; color: #f1f5f9; line-height:1; font-style: italic; position: relative; z-index:2;">${opt.label}</div>
            <div style="font-size: ${descSize}; font-weight: 700; color: #64748b; margin-top: 6px; letter-spacing: 0.5px;">${opt.desc}</div>
            <div style="font-size: ${noteSize}; color: #475569; margin-top: 4px;">${opt.note}</div>
            <div class="fill-anim" style="
                position: absolute; bottom: 0; left: 0; right: 0; height: 0; 
                background: ${opt.color}; z-index: 1;
                transition: height 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            "></div>
        `;
        btn.onmouseenter = () => {
            btn.style.transform = 'translateY(-4px)';
            btn.style.borderBottomColor = opt.color;
            btn.style.boxShadow = `0 12px 25px -5px ${opt.color}40, 0 0 30px ${opt.color}20`;
            btn.children[0].style.color = 'rgba(255,255,255,0.9)';
            btn.children[1].style.color = '#fff';
            btn.children[2].style.color = 'rgba(255,255,255,0.7)';
            btn.children[3].style.color = 'rgba(255,255,255,0.5)';
            btn.querySelector('.fill-anim').style.height = '100%';
        };
        btn.onmouseleave = () => {
            btn.style.transform = 'translateY(0)';
            btn.style.borderBottomColor = `${opt.color}30`;
            btn.style.boxShadow = 'none';
            btn.children[0].style.color = opt.color;
            btn.children[1].style.color = '#f1f5f9';
            btn.children[2].style.color = '#64748b';
            btn.children[3].style.color = '#475569';
            btn.querySelector('.fill-anim').style.height = '0';
        };
        btn.onclick = () => {
            overlay.style.transition = 'opacity 0.2s';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.parentNode && overlay.parentNode.removeChild(overlay), 200);
            callback(opt.id);
        };
        return btn;
    };
    // Ultra é€‰é¡¹è¡Œ
    if (hasZMechanic) {
        const ultraRow = document.createElement('div');
        ultraRow.style.cssText = `display: flex; gap: 16px; width: 100%;`;
        if (hasSolgaleo) {
            ultraRow.appendChild(createOptionButton({ 
                id: 'ultra_dusk', label: 'â˜€', subLabel: 'ULTRA BURST',
                desc: 'ç©¶æå¥ˆå…‹æ´›å…¹ç›', note: 'Solgaleo â†’ é»„æ˜ä¹‹é¬ƒ â†’ Ultra', color: '#fbbf24'
            }, true));
        }
        if (hasLunala) {
            ultraRow.appendChild(createOptionButton({ 
                id: 'ultra_dawn', label: 'â˜½', subLabel: 'ULTRA BURST',
                desc: 'ç©¶æå¥ˆå…‹æ´›å…¹ç›', note: 'Lunala â†’ æ‹‚æ™“ä¹‹ç¿¼ â†’ Ultra', color: '#fbbf24'
            }, true));
        }
        if (ultraRow.children.length > 0) mainContainer.appendChild(ultraRow);
    }
    // æ™®é€šé€‰é¡¹è¡Œ
    const normalRow = document.createElement('div');
    normalRow.style.cssText = `display: flex; gap: 16px; width: 100%;`;
    if (hasSolgaleo) {
        normalRow.appendChild(createOptionButton({ 
            id: 'dusk', label: 'æ—¥', subLabel: 'DUSK MANE',
            desc: 'é»„æ˜ä¹‹é¬ƒ', note: '+ Solgaleo', color: '#f59e0b'
        }, false));
    }
    if (hasLunala) {
        normalRow.appendChild(createOptionButton({ 
            id: 'dawn', label: 'æœˆ', subLabel: 'DAWN WINGS',
            desc: 'æ‹‚æ™“ä¹‹ç¿¼', note: '+ Lunala', color: '#8b5cf6'
        }, false));
    }
    if (normalRow.children.length > 0) mainContainer.appendChild(normalRow);
    // å–æ¶ˆæŒ‰é’®
    const cancelBtn = createCancelButton('ä¸åˆä½“', true, () => {
        overlay.style.transition = 'opacity 0.2s';
        overlay.style.opacity = '0';
        setTimeout(() => overlay.parentNode && overlay.parentNode.removeChild(overlay), 200);
        callback(null);
    });
    // ç»„è£…
    content.appendChild(title);
    content.appendChild(subTitle);
    content.appendChild(mainContainer);
    content.appendChild(cancelBtn);
    dialogShape.appendChild(content);
    overlay.appendChild(dialogShape);
    // æ·»åŠ åˆ° #ui-scale å†…éƒ¨ï¼Œç¡®ä¿åœ¨ .screen-filters çš„å±‚å ä¸Šä¸‹æ–‡ä¸­
    const uiScale2 = document.getElementById('ui-scale') || document.body;
    uiScale2.appendChild(overlay);
    overlay.onclick = (e) => {
        if (e.target === overlay) cancelBtn.click();
    };
}
/**
 * æˆ˜æ–—å¼€å§‹æ—¶æ£€æµ‹å¹¶å¤„ç† Necrozma åˆä½“
 */
function checkAndProcessNecrozmaFusion(party, logFn, onComplete) {
    const log = logFn || console.log;
    const detection = detectNecrozmaFusion(party);
    if (!detection.canFuse) {
        if (onComplete) onComplete();
        return;
    }
    const necrozma = party[detection.necrozmaIndex];
    const hasZMechanic = necrozma.mechanic === 'zmove';
    const handleChoice = (choice) => {
        if (!choice) {
            log(`<span style="color:#94a3b8">å¥ˆå…‹æ´›å…¹ç› é€‰æ‹©ä¸è¿›è¡Œåˆä½“ã€‚</span>`);
            if (onComplete) onComplete();
            return;
        }
        let fusionType = choice;
        let shouldUltraBurst = false;
        if (choice.startsWith('ultra_')) {
            shouldUltraBurst = true;
            fusionType = choice.replace('ultra_', '');
        }
        const result = executeNecrozmaFusion(party, fusionType, detection);
        if (result.success) {
            result.logs.forEach(msg => log(msg));
            if (shouldUltraBurst && hasZMechanic) {
                const burstResult = executeUltraBurst(necrozma);
                if (burstResult.success) burstResult.logs.forEach(msg => log(msg));
                updateNecrozmaSprite(necrozma);
                if (onComplete) onComplete();
                return;
            }
            updateNecrozmaSprite(necrozma);
        }
        if (onComplete) onComplete();
    };
    const needsDialog = detection.hasBothOptions || hasZMechanic;
    if (needsDialog) {
        showNecrozmaFusionDialog(necrozma, {
            hasZMechanic,
            hasLunala: detection.hasLunala,
            hasSolgaleo: detection.hasSolgaleo
        }, handleChoice);
    } else {
        const fusionType = detection.hasLunala ? 'dawn' : 'dusk';
        const result = executeNecrozmaFusion(party, fusionType, detection);
        if (result.success) {
            result.logs.forEach(msg => log(msg));
            updateNecrozmaSprite(necrozma);
        }
        if (onComplete) onComplete();
    }
}
/**
 * æ›´æ–° Necrozma çš„ç²¾çµå›¾
 */
function updateNecrozmaSprite(pokemon) {
    if (!pokemon) return;
    if (typeof window !== 'undefined' && typeof window.updateAllVisuals === 'function') {
        window.updateAllVisuals('player');
    }
    if (typeof window !== 'undefined' && typeof window.smartLoadSprite === 'function') {
        const spriteUrl = pokemon.getSprite ? pokemon.getSprite(true) : null;
        if (spriteUrl) window.smartLoadSprite('player-sprite', spriteUrl, true);
    }
}
/**
 * AI è‡ªåŠ¨å¤„ç† Necrozma åˆä½“ï¼ˆæ— å¯¹è¯æ¡†ï¼‰
 * ç”¨äºæ•Œæ–¹ AI åœ¨æˆ˜æ–—å¼€å§‹æ—¶è‡ªåŠ¨åˆä½“
 * @param {Array} party - é˜Ÿä¼æ•°ç»„
 * @param {Function} logFn - æ—¥å¿—å‡½æ•°
 * @returns {Object} - { success, logs }
 */
function autoProcessNecrozmaFusion(party, logFn) {
    const log = logFn || console.log;
    const detection = detectNecrozmaFusion(party);
    if (!detection.canFuse) {
        return { success: false, logs: [] };
    }
    const necrozma = party[detection.necrozmaIndex];
    // é˜²æ­¢é‡å¤åˆä½“
    if (necrozma.isFused || necrozma.isUltraBursted) {
        console.log('[AI NECROZMA] å·²ç»åˆä½“è¿‡ï¼Œè·³è¿‡');
        return { success: false, logs: [] };
    }
    const hasZMechanic = necrozma.mechanic === 'zmove';
    // AI ä¼˜å…ˆé€‰æ‹© Solgaleoï¼ˆé»„æ˜ä¹‹é¬ƒï¼‰ï¼Œå› ä¸ºç‰©æ”»æ›´é«˜
    // å¦‚æœæœ‰ Z æ‹›å¼æœºåˆ¶ï¼Œç›´æ¥é€‰æ‹© Ultra Burst è·¯çº¿
    let fusionType = detection.hasSolgaleo ? 'dusk' : 'dawn';
    const result = executeNecrozmaFusion(party, fusionType, detection);
    const allLogs = [];
    if (result.success) {
        result.logs.forEach(msg => {
            log(msg);
            allLogs.push(msg);
        });
        // å¦‚æœæœ‰ Z æ‹›å¼æœºåˆ¶ï¼Œè‡ªåŠ¨è§¦å‘ Ultra Burst
        if (hasZMechanic) {
            const burstResult = executeUltraBurst(necrozma);
            if (burstResult.success) {
                burstResult.logs.forEach(msg => {
                    log(msg);
                    allLogs.push(msg);
                });
            }
        }
        console.log(`[AI NECROZMA] æ•Œæ–¹ AI è‡ªåŠ¨åˆä½“å®Œæˆ: ${necrozma.name} (Ultra: ${necrozma.isUltraBursted || false})`);
    }
    return { success: result.success, logs: allLogs, fusedPokemon: necrozma };
}
// ============================================
// å¯¼å‡º
// ============================================
if (typeof window !== 'undefined') {
    // é€šç”¨å½¢æ€å˜åŒ–
    window.performFormChange = performFormChange;
    window.checkInitTransform = checkInitTransform;
    window.checkBattleBondTransform = checkBattleBondTransform;
    window.checkHPThresholdTransform = checkHPThresholdTransform;
    // Mega é€‰æ‹©
    window.showMegaFormSelectionDialog = showMegaFormSelectionDialog;
    // Necrozma åˆä½“
    window.detectNecrozmaFusion = detectNecrozmaFusion;
    window.executeNecrozmaFusion = executeNecrozmaFusion;
    window.canUltraBurst = canUltraBurst;
    window.executeUltraBurst = executeUltraBurst;
    window.showNecrozmaFusionDialog = showNecrozmaFusionDialog;
    window.checkAndProcessNecrozmaFusion = checkAndProcessNecrozmaFusion;
    window.autoProcessNecrozmaFusion = autoProcessNecrozmaFusion;
    window.updateNecrozmaSprite = updateNecrozmaSprite;
}
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        performFormChange,
        checkInitTransform,
        checkBattleBondTransform,
        checkHPThresholdTransform,
        showMegaFormSelectionDialog,
        detectNecrozmaFusion,
        executeNecrozmaFusion,
        canUltraBurst,
        executeUltraBurst,
        showNecrozmaFusionDialog,
        checkAndProcessNecrozmaFusion,
        autoProcessNecrozmaFusion,
        updateNecrozmaSprite
    };
}
console.log('[FORM CHANGE] ç»Ÿä¸€å½¢æ€å˜åŒ–ç³»ç»Ÿå·²åŠ è½½');
})();
]]></file>
        </directory>
        <file name="clash-system.js"><![CDATA[/**
 * ===========================================
 * CLASH-SYSTEM.JS - å¯¹å†²ç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - Clash Type æ¨å¯¼ (SOLID/BEAM/WAVE/PIERCE)
 * - æ€æ„æ„ŸçŸ¥ (Insight Check)
 * - å¯¹å†²åˆ¤å®š (Clash Resolution)
 * - Clash Power è®¡ç®—
 * 
 * ä¾èµ–: moves-data.js, battle-engine.js
 */
// ============================================
// å¸¸é‡ä¸é…ç½®
// ============================================
// Clash Type æšä¸¾
const CLASH_TYPE = {
    SOLID: 'SOLID',   // å®ä½“/è¿‘èº«
    BEAM: 'BEAM',     // å…‰æŸ/æŠ•å°„
    WAVE: 'WAVE',     // æ³¢åŠ¨/èŒƒå›´
    PIERCE: 'PIERCE'  // ç©¿é€/åˆ‡è£‚
};
// éœ€è¦å¼ºåˆ¶æ ‡è®°ä¸º WAVE çš„æ‹›å¼ï¼ˆç¼ºå°‘ wind/sound flagï¼‰
// è¿™äº›æ‹›å¼ä¸èƒ½è¢«å¯¹å†²ï¼šåœºåœ°ç±»ã€å‚ç›´ç±»ã€å…¨å±ç±»
const WAVE_OVERRIDE = [
    // åœºåœ°/ç¯å¢ƒç±»ï¼ˆåŠ›é‡æ¥è‡ªè„šä¸‹ï¼‰
    'earthquake', 'magnitude', 'earthpower', 'bulldoze', 'stompingtantrum',
    'surf', 'muddywater', 'sludgewave', 'discharge',
    'heatwave', 'icywind', 'sparklingaria', 'originpulse',
    'precipiceblades', 'thousandarrows', 'thousandwaves',
    // å‚ç›´/å¤©é™ç±»ï¼ˆä»å¤©è€Œé™ï¼Œæ— æ³•æ­£é¢æ‹¦æˆªï¼‰
    'thunder', 'hurricane', 'dracometeor', 'meteorbeam',
    'cometpunch', 'meteormash', 'doomdesire', 'futuresight',
    // å…¨å±/èŒƒå›´ç±»
    'explosion', 'selfdestruct', 'mindblown', 'mistyexplosion'
];
// éœ€è¦å¼ºåˆ¶æ ‡è®°ä¸º SOLID çš„æ‹›å¼ï¼ˆæŠ•å°„å®ä½“ç‰©ï¼Œä¸æ˜¯èƒ½é‡å…‰æŸï¼‰
// è¿™äº›æ‹›å¼è™½ç„¶æ˜¯è¿œç¨‹ï¼Œä½†æŠ•å°„çš„æ˜¯å®ä½“ç‰©è´¨
const SOLID_OVERRIDE = [
    // å²©çŸ³æŠ•å°„ç±»ï¼ˆåŒ…æ‹¬æœ‰ slicing flag ä½†å®é™…æ˜¯æŠ•æ·å²©çŸ³çš„æ‹›å¼ï¼‰
    'stoneedge', 'rockslide', 'rockthrow', 'ancientpower', 'powergem',
    'smackdown', 'accelerock', 'headsmash', 'rockblast', 'rollout',
    'stoneaxe',  // å²©æ–§ï¼šè™½ç„¶æœ‰ slicing flagï¼Œä½†æœ¬è´¨æ˜¯æŠ•æ·çŸ³æ–§
    // é‡‘å±æŠ•å°„ç±»
    'flashcannon', 'steelbeam', 'ironhead', 'gyroball', 'heavyslam',
    'magnetbomb', 'mirrorshot', 'smartstrike',
    // å…¶ä»–å®ä½“æŠ•å°„
    'seedbomb', 'rockwrecker', 'diamondstorm', 'stealthrock'
];
// éœ€è¦å¼ºåˆ¶æ ‡è®°ä¸º PIERCE çš„æ‹›å¼ï¼ˆåˆ‡å‰²/ç©¿åˆºç±»ï¼‰
const PIERCE_OVERRIDE = [
    // åˆ‡å‰²ç±»ï¼ˆæ²¡æœ‰ slicing flag ä½†å®é™…æ˜¯åˆ‡å‰²ï¼‰
    'slash', 'nightslash', 'crosspoison', 'xscissor', 'cut',
    'furycutter', 'razorshell', 'shellblade', 'secretsword'
];
// å¯¹å†²äº¤äº’çŸ©é˜µ
const CLASH_MATRIX = {
    'BEAM': {
        'BEAM':   { interaction: 'cpCheck', advantage: 0, critBonus: 0 },
        'SOLID':  { interaction: 'beamAdvantage', advantage: 0.5, critBonus: 0 },
        'WAVE':   { interaction: 'pierce', advantage: 1.0, critBonus: 0 },
        'PIERCE': { interaction: 'sliced', advantage: -0.5, critBonus: 0 }
    },
    'SOLID': {
        'BEAM':   { interaction: 'tankOrDodge', advantage: -0.3, critBonus: 0 },
        'SOLID':  { interaction: 'cpCheck', advantage: 0, critBonus: 0.2 },
        'WAVE':   { interaction: 'breakthrough', advantage: 0.8, critBonus: 0 },
        'PIERCE': { interaction: 'parry', advantage: 0, critBonus: 0.3 }
    },
    'WAVE': {
        'BEAM':   { interaction: 'pierced', advantage: -1.0, critBonus: 0 },
        'SOLID':  { interaction: 'broken', advantage: -0.8, critBonus: 0 },
        'WAVE':   { interaction: 'cpCheck', advantage: 0, critBonus: 0 },
        'PIERCE': { interaction: 'dissipate', advantage: -0.5, critBonus: 0 }
    },
    'PIERCE': {
        'BEAM':   { interaction: 'slice', advantage: 0.5, critBonus: 0 },
        'SOLID':  { interaction: 'parry', advantage: 0, critBonus: 0.3 },
        'WAVE':   { interaction: 'passThrough', advantage: 0.5, critBonus: 0 },
        'PIERCE': { interaction: 'crossSlash', advantage: 0, critBonus: 0.5 }
    }
};
// å¯¹å†²ç»“æœæ—¥å¿—æ–‡æ¡ˆ
const CLASH_MESSAGES = {
    overpower: [
        '{winner}çš„{move}å®Œå…¨å‹åˆ¶äº†å¯¹æ–¹ï¼',
        '{winner}çš„{move}åŠ¿ä¸å¯æŒ¡ï¼',
        'å‹å€’æ€§çš„åŠ›é‡ï¼{winner}çš„{move}ç¢¾å‹äº†ä¸€åˆ‡ï¼'
    ],
    dominate: [
        '{winner}çš„{move}å æ®äº†ä¸Šé£ï¼',
        '{winner}çš„{move}å‹åˆ¶ä½äº†å¯¹æ–¹çš„æ”»å‡»ï¼'
    ],
    pierce: [
        '{winner}çš„{move}ç©¿é€äº†å¯¹æ–¹çš„æ”»å‡»ï¼',
        'èƒ½é‡å¯¹å†²ï¼{winner}çš„{move}ç•¥èƒœä¸€ç­¹ï¼'
    ],
    neutralize: [
        'ä¸¤è‚¡èƒ½é‡ç›¸äº’æŠµæ¶ˆäº†ï¼',
        'åŠ¿å‡åŠ›æ•Œï¼åŒæ–¹çš„æ”»å‡»åŒæ—¶æ¶ˆæ•£ï¼',
        'å®Œç¾çš„å¯¹å†²ï¼åŒæ–¹éƒ½æ²¡æœ‰å—åˆ°ä¼¤å®³ï¼'
    ],
    backfire: [
        '{winner}çš„{move}åå‡»æˆåŠŸï¼',
        '{loser}çš„æ”»å‡»è¢«å¼¹å›æ¥äº†ï¼'
    ]
};
// Insight é˜ˆå€¼é…ç½®
const INSIGHT_THRESHOLDS = {
    BASIC: 50,      // ä»…çŸ¥é“"æœ‰æ”»å‡»æ„å›¾"
    TYPE: 150,      // çŸ¥é“å±æ€§ç±»å‹
    CATEGORY: 220,  // çŸ¥é“å±æ€§ + ç‰©ç†/ç‰¹æ®Š
    FULL: 255       // çŸ¥é“å…·ä½“æ‹›å¼å
};
// ============================================
// æ ¸å¿ƒå‡½æ•°ï¼šClash Type æ¨å¯¼
// ============================================
/**
 * ä»æ‹›å¼ flags æ¨å¯¼ Clash Type
 * @param {Object} move - æ‹›å¼å¯¹è±¡ (å« flags æˆ– name)
 * @returns {string} 'SOLID' | 'BEAM' | 'WAVE' | 'PIERCE'
 */
function getClashType(move) {
    if (!move) return CLASH_TYPE.BEAM;
    // è·å–å®Œæ•´æ‹›å¼æ•°æ®
    const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    const flags = move.flags || fullMoveData.flags || {};
    // =====================================================
    // === ä¼˜å…ˆçº§ 0: Override åˆ—è¡¨ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰===
    // =====================================================
    // å¼ºåˆ¶ WAVE çš„æ‹›å¼ï¼ˆåœºåœ°ç±»ã€å‚ç›´ç±»ã€å…¨å±ç±»ï¼‰
    if (WAVE_OVERRIDE.includes(moveId)) {
        return CLASH_TYPE.WAVE;
    }
    // å¼ºåˆ¶ SOLID çš„æ‹›å¼ï¼ˆæŠ•å°„å®ä½“ç‰©ï¼‰
    if (SOLID_OVERRIDE.includes(moveId)) {
        return CLASH_TYPE.SOLID;
    }
    // å¼ºåˆ¶ PIERCE çš„æ‹›å¼ï¼ˆåˆ‡å‰²/ç©¿åˆºç±»ï¼‰
    if (PIERCE_OVERRIDE.includes(moveId)) {
        return CLASH_TYPE.PIERCE;
    }
    // =====================================================
    // === ä¼˜å…ˆçº§ 1-4: æ ¹æ® flags æ¨å¯¼ ===
    // =====================================================
    // ä¼˜å…ˆçº§ 1: åˆ‡å‰²ç±» â†’ PIERCE
    if (flags.slicing) return CLASH_TYPE.PIERCE;
    // ä¼˜å…ˆçº§ 2: æŠ•å°„ç‰© â†’ BEAM
    if (flags.bullet || flags.pulse) return CLASH_TYPE.BEAM;
    // ä¼˜å…ˆçº§ 3: èŒƒå›´æ³¢åŠ¨ â†’ WAVE
    if (flags.wind || flags.sound) return CLASH_TYPE.WAVE;
    // ä¼˜å…ˆçº§ 4: æ¥è§¦ç±» â†’ SOLID
    if (flags.contact) return CLASH_TYPE.SOLID;
    // é»˜è®¤: è¿œç¨‹èƒ½é‡ â†’ BEAM
    return CLASH_TYPE.BEAM;
}
/**
 * è·å– Clash Type çš„ä¸­æ–‡åç§°
 * @param {string} clashType 
 * @returns {string}
 */
function getClashTypeName(clashType) {
    const names = {
        'SOLID': 'å®ä½“',
        'BEAM': 'å…‰æŸ',
        'WAVE': 'æ³¢åŠ¨',
        'PIERCE': 'ç©¿é€'
    };
    return names[clashType] || 'æœªçŸ¥';
}
// ============================================
// æ ¸å¿ƒå‡½æ•°ï¼šå¯¹å†²äº¤äº’åˆ¤å®š
// ============================================
/**
 * è·å–å¯¹å†²äº¤äº’ç»“æœ
 * @param {string} typeA - å…ˆæ‰‹ Clash Type
 * @param {string} typeB - åæ‰‹ Clash Type
 * @returns {Object} { interaction, advantage, critBonus }
 */
function getClashInteraction(typeA, typeB) {
    return CLASH_MATRIX[typeA]?.[typeB] || { interaction: 'cpCheck', advantage: 0, critBonus: 0 };
}
/**
 * è·å–å±æ€§å…‹åˆ¶å¯¹å¯¹å†²çš„åŠ æˆ
 * @param {Object} moveA - æ‹›å¼ A
 * @param {Object} moveB - æ‹›å¼ B
 * @returns {number} åŠ æˆå€ç‡ (0.7 ~ 1.3)
 */
function getTypeClashModifier(moveA, moveB) {
    if (!moveA || !moveB) return 1.0;
    const typeA = moveA.type || 'Normal';
    const typeB = moveB.type || 'Normal';
    // ä½¿ç”¨ç°æœ‰çš„å±æ€§å…‹åˆ¶è®¡ç®—
    if (typeof getTypeEffectiveness === 'function') {
        const effectiveness = getTypeEffectiveness(typeA, [typeB]);
        if (effectiveness >= 2) return 1.3;   // å…‹åˆ¶ +30%
        if (effectiveness <= 0.5 && effectiveness > 0) return 0.7;  // è¢«å…‹ -30%
        if (effectiveness === 0) return 0;    // å…ç–« = æ— æ³•å¯¹å†²
    }
    return 1.0;
}
// ============================================
// æ ¸å¿ƒå‡½æ•°ï¼šClash Power è®¡ç®—
// ============================================
/**
 * è®¡ç®— Clash Power
 * @param {Object} user - ä½¿ç”¨è€… Pokemon
 * @param {Object} move - æ‹›å¼
 * @param {Object} opponent - å¯¹æ‰‹ Pokemon
 * @param {Object} opponentMove - å¯¹æ‰‹æ‹›å¼
 * @returns {Object} { cp, clashType, interaction, critBonus }
 */
function calculateClashPower(user, move, opponent, opponentMove) {
    if (!user || !move) return { cp: 0, clashType: CLASH_TYPE.BEAM, interaction: null, critBonus: 0, isZMove: false, isMaxMove: false, isMultiHit: false };
    const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    const flags = move.flags || fullMoveData.flags || {};
    // =====================================================
    // ã€ç‰¹æ®Šæ‹›å¼æ£€æµ‹ã€‘Zæ‹›å¼ / æå·¨æ‹›å¼ / å¤šæ®µæ”»å‡»
    // =====================================================
    const isZMove = move.isZ || fullMoveData.isZ || false;
    const isMaxMove = move.isMax || fullMoveData.isMax || false;
    const multiHitData = fullMoveData.multihit || move.multihit || null;
    const isMultiHit = !!multiHitData;
    // åŸºç¡€å¨åŠ›
    let basePower = move.basePower || move.power || fullMoveData.basePower || 0;
    // ã€Zæ‹›å¼/æå·¨æ‹›å¼ CP åŠ æˆã€‘
    // Zæ‹›å¼ï¼š1.5x CPï¼Œæå·¨æ‹›å¼ï¼š1.3x CP
    let specialMoveBonus = 1.0;
    if (isZMove) {
        specialMoveBonus = 1.5;
        console.log(`[CLASH] Zæ‹›å¼æ£€æµ‹: ${move.cn || move.name}, CP åŠ æˆ 1.5x`);
    } else if (isMaxMove) {
        specialMoveBonus = 1.3;
        console.log(`[CLASH] æå·¨æ‹›å¼æ£€æµ‹: ${move.cn || move.name}, CP åŠ æˆ 1.3x`);
    }
    // æ”»å‡»/ç‰¹æ”»
    const category = fullMoveData.category || move.category || 'Physical';
    const isSpecial = (category === 'Special' || move.cat === 'spec');
    const atkStat = (typeof user.getStat === 'function') 
        ? (isSpecial ? user.getStat('spa') : user.getStat('atk'))
        : (isSpecial ? (user.spa || 100) : (user.atk || 100));
    // ã€å±æ€§å…‹åˆ¶åŠ æˆã€‘æ‹›å¼å¯¹ç›®æ ‡å®å¯æ¢¦çš„å…‹åˆ¶å…³ç³»
    // æ•ˆæœæä½³ = 1.3xï¼Œæ•ˆæœä¸å¥½ = 0.8xï¼Œæ™®é€š = 1.0x
    let typeModifier = 1.0;
    if (opponent && typeof window.getTypeEffectiveness === 'function') {
        const moveType = move.type || fullMoveData.type || 'Normal';
        // ã€ä¿®å¤ã€‘ä¼ å…¥å¯¹æ‰‹çš„ç±»å‹æ•°ç»„ï¼Œè€Œä¸æ˜¯æ•´ä¸ª Pokemon å¯¹è±¡
        const opponentTypes = opponent.types || [opponent.type1, opponent.type2].filter(Boolean);
        if (opponentTypes.length > 0) {
            const effectiveness = window.getTypeEffectiveness(moveType, opponentTypes);
            if (effectiveness >= 2) {
                typeModifier = 1.3; // æ•ˆæœæä½³
            } else if (effectiveness >= 1.5) {
                typeModifier = 1.15; // æ•ˆæœä¸é”™
            } else if (effectiveness <= 0.5 && effectiveness > 0) {
                typeModifier = 0.8; // æ•ˆæœä¸å¥½
            } else if (effectiveness <= 0.25 && effectiveness > 0) {
                typeModifier = 0.6; // æ•ˆæœå¾ˆå·®
            }
            // å…ç–«ä¸å½±å“ CPï¼ˆå¯¹å†²æ˜¯æ‹›å¼ç¢°æ’ï¼Œä¸æ˜¯æ‰“å®å¯æ¢¦ï¼‰
        }
    }
    // Clash Type ä¼˜åŠ¿
    const myClashType = getClashType(move);
    const theirClashType = opponentMove ? getClashType(opponentMove) : CLASH_TYPE.BEAM;
    const interaction = getClashInteraction(myClashType, theirClashType);
    // ã€ä¿®å¤ã€‘clashAdvantage æœ€å°å€¼ä¸º 0.3ï¼Œé¿å… CP ç›´æ¥å½’é›¶
    // advantage èŒƒå›´æ˜¯ -1.0 ~ +1.0ï¼Œè½¬æ¢ä¸º 0.3 ~ 2.0 çš„å€ç‡
    // å³ä½¿å¤„äºæç«¯åŠ£åŠ¿ï¼ˆBEAM vs PIERCEï¼‰ï¼Œä¹Ÿæœ‰ 30% çš„åŸºç¡€ CP
    const rawAdvantage = 1 + interaction.advantage;
    const clashAdvantage = Math.max(0.3, rawAdvantage);
    // ä¹±æ•° (0.9 ~ 1.1)
    const rng = 0.9 + Math.random() * 0.2;
    // æœ€ç»ˆ CP = å¨åŠ› Ã— (æ”»å‡»/100) Ã— å±æ€§å…‹åˆ¶ Ã— Clash Type ä¼˜åŠ¿ Ã— ç‰¹æ®Šæ‹›å¼åŠ æˆ Ã— ä¹±æ•°
    const cp = Math.floor(basePower * (atkStat / 100) * typeModifier * clashAdvantage * specialMoveBonus * rng);
    console.log(`[CLASH CP] ${user.cnName} ${move.name || move.cn}: basePower=${basePower}, atk=${atkStat}, type=${myClashType} vs ${theirClashType}, typeMod=${typeModifier.toFixed(2)}, clashAdv=${clashAdvantage.toFixed(2)}, specialBonus=${specialMoveBonus}, cp=${cp}`);
    return {
        cp,
        clashType: myClashType,
        interaction: interaction.interaction,
        critBonus: interaction.critBonus,
        isZMove,
        isMaxMove,
        isMultiHit,
        multiHitData
    };
}
// ============================================
// æ ¸å¿ƒå‡½æ•°ï¼šå¯¹å†²ç»“æœåˆ¤å®š
// ============================================
/**
 * å¯¹å†²ç»“ç®—
 * @param {Object} moveA - å…ˆæ‰‹æ‹›å¼ï¼ˆç©å®¶åæ‰‹å¯¹å†²æ—¶ï¼Œè¿™æ˜¯ç©å®¶çš„æ‹›å¼ï¼‰
 * @param {Object} moveB - åæ‰‹æ‹›å¼ï¼ˆç©å®¶åæ‰‹å¯¹å†²æ—¶ï¼Œè¿™æ˜¯æ•Œæ–¹çš„æ‹›å¼ï¼‰
 * @param {Object} userA - å…ˆæ‰‹ä½¿ç”¨è€…ï¼ˆç©å®¶åæ‰‹å¯¹å†²æ—¶ï¼Œè¿™æ˜¯ç©å®¶ï¼‰
 * @param {Object} userB - åæ‰‹ä½¿ç”¨è€…ï¼ˆç©å®¶åæ‰‹å¯¹å†²æ—¶ï¼Œè¿™æ˜¯æ•Œæ–¹ï¼‰
 * @param {Object} options - { applySpeedModifier: boolean } æ˜¯å¦åº”ç”¨é€Ÿåº¦ä¿®æ­£
 * @returns {Object|null} { winner, loser, resultType, damageMultiplierA, damageMultiplierB, logs }
 */
function resolveClash(moveA, moveB, userA, userB, options = {}) {
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¯¹å†²
    if (!canClash(moveA) || !canClash(moveB)) {
        console.log('[CLASH] æ‹›å¼ä¸æ»¡è¶³å¯¹å†²æ¡ä»¶');
        return null;
    }
    // è®¡ç®—åŒæ–¹ CP
    const resultA = calculateClashPower(userA, moveA, userB, moveB);
    const resultB = calculateClashPower(userB, moveB, userA, moveA);
    let cpA = resultA.cp;
    let cpB = resultB.cp;
    const originalCpA = cpA;
    const originalCpB = cpB;
    // ã€é€Ÿåº¦ä¿®æ­£ã€‘åŒå‘ç”Ÿæ•ˆ
    // userA = åæ‰‹ï¼ˆå‘èµ·å¯¹å†²æ–¹ï¼‰ï¼ŒuserB = å…ˆæ‰‹ï¼ˆè¢«å¯¹å†²æ–¹ï¼‰
    // åæ‰‹æ–¹ CP å‰Šå¼±ï¼Œå…ˆæ‰‹æ–¹ CP åŠ æˆ
    if (options.applySpeedModifier !== false) {
        const speedResult = getSpeedModifiers(userA, userB);
        cpA = Math.floor(cpA * speedResult.slowerModifier);
        cpB = Math.floor(cpB * speedResult.fasterModifier);
        console.log(`[CLASH] é€Ÿåº¦ä¿®æ­£: ${userA.cnName}(${originalCpA} Ã— ${speedResult.slowerModifier.toFixed(2)} = ${cpA}), ${userB.cnName}(${originalCpB} Ã— ${speedResult.fasterModifier.toFixed(2)} = ${cpB})`);
    }
    console.log(`[CLASH] CP å¯¹æ¯”: ${userA.cnName}(${cpA}) vs ${userB.cnName}(${cpB})`);
    // é¿å…é™¤ä»¥ 0ï¼šå½“å¯¹æ–¹ CP=0 æ—¶ï¼Œç›´æ¥ç¢¾å‹
    if (cpB === 0) {
        const result = {
            winner: 'A',
            loser: 'B',
            resultType: 'overpower',
            damageMultiplierA: 1.0,
            damageMultiplierB: 0,
            cpA, cpB,
            clashTypeA: resultA.clashType,
            clashTypeB: resultB.clashType,
            logs: []
        };
        // ã€ä¿®å¤ã€‘ç”Ÿæˆå¯¹å†²æ—¥å¿—
        result.logs = generateClashLogs(result, moveA, moveB, userA, userB);
        return result;
    }
    const ratio = cpA / cpB;
    let result = {
        winner: null,
        loser: null,
        damageMultiplierA: 0,
        damageMultiplierB: 0,
        resultType: 'neutralize',
        cpA, cpB,
        clashTypeA: resultA.clashType,
        clashTypeB: resultB.clashType,
        critBonusA: resultA.critBonus,
        critBonusB: resultB.critBonus,
        logs: []
    };
    // =====================================================
    // ã€æ–°ç‰ˆå¯¹å†²åˆ¤å®šã€‘æŒ‰ CP å·®å€¼æ¯”ä¾‹è®¡ç®—ä¼¤å®³
    // =====================================================
    // æ ¸å¿ƒæ€æƒ³ï¼šCP é«˜çš„ä¸€æ–¹é€ æˆ (å·®å€¼/æ€»å’Œ) æ¯”ä¾‹çš„ä¼¤å®³
    // ä¾‹å¦‚ï¼š453 vs 382ï¼Œå·®å€¼=71ï¼Œæ€»å’Œ=835ï¼Œèƒœè€…ä¼¤å®³å€ç‡=71/835=0.085
    // è¿™æ ·åŠ¿å‡åŠ›æ•Œæ—¶åŒæ–¹éƒ½é€ æˆå¾ˆå°‘ä¼¤å®³ï¼Œå·®è·å¤§æ—¶èƒœè€…é€ æˆæ›´å¤šä¼¤å®³
    const cpDiff = Math.abs(cpA - cpB);
    const cpTotal = cpA + cpB;
    const diffRatio = cpDiff / cpTotal; // 0 ~ 1
    if (ratio >= 2.0) {
        // Overpower: A ç¢¾å‹ Bï¼ˆCP å·®è· >= 2å€ï¼‰
        result.winner = 'A';
        result.loser = 'B';
        result.damageMultiplierA = 1.0;
        result.damageMultiplierB = 0;
        result.resultType = 'overpower';
    } else if (ratio >= 1.5) {
        // Dominate: A å‹åˆ¶ Bï¼ˆCP å·®è· 1.5~2å€ï¼‰
        result.winner = 'A';
        result.loser = 'B';
        result.damageMultiplierA = 0.6 + diffRatio * 0.4; // 0.6 ~ 1.0
        result.damageMultiplierB = 0;
        result.resultType = 'dominate';
    } else if (ratio >= 1.15) {
        // Pierce: A ç•¥èƒœï¼ˆCP å·®è· 1.15~1.5å€ï¼‰
        // A é€ æˆæŒ‰æ¯”ä¾‹å‰Šå‡çš„ä¼¤å®³ï¼ŒB ä¸é€ æˆä¼¤å®³
        result.winner = 'A';
        result.loser = 'B';
        result.damageMultiplierA = 0.3 + diffRatio * 2; // çº¦ 0.3 ~ 0.6
        result.damageMultiplierB = 0;
        result.resultType = 'pierce';
    } else if (ratio >= 0.87) {
        // Neutralize: åŠ¿å‡åŠ›æ•Œï¼ˆCP å·®è·åœ¨ 15% ä»¥å†…ï¼‰
        // ã€æ”¹è¿›ã€‘åŒæ–¹éƒ½é€ æˆå‰Šå‡åçš„ä¼¤å®³ï¼Œè€Œä¸æ˜¯å®Œå…¨æŠµæ¶ˆ
        // ä¼¤å®³å€ç‡ = 0.2 + (å·±æ–¹CPå æ¯” - 0.5) * 0.6
        const ratioA = cpA / cpTotal; // 0.435 ~ 0.535
        const ratioB = cpB / cpTotal;
        result.winner = cpA > cpB ? 'A' : (cpB > cpA ? 'B' : null);
        result.loser = cpA > cpB ? 'B' : (cpB > cpA ? 'A' : null);
        // åŒæ–¹éƒ½é€ æˆå°‘é‡ä¼¤å®³ï¼ŒCP é«˜çš„ä¸€æ–¹ç•¥å¤š
        result.damageMultiplierA = Math.max(0.1, 0.2 + (ratioA - 0.5) * 1.5);
        result.damageMultiplierB = Math.max(0.1, 0.2 + (ratioB - 0.5) * 1.5);
        result.resultType = 'neutralize';
    } else if (ratio >= 0.67) {
        // Backfire: B ç•¥èƒœï¼ˆCP å·®è· 1.15~1.5å€ï¼ŒB ä¼˜åŠ¿ï¼‰
        result.winner = 'B';
        result.loser = 'A';
        result.damageMultiplierA = 0;
        result.damageMultiplierB = 0.3 + diffRatio * 2;
        result.resultType = 'backfire';
    } else if (ratio >= 0.5) {
        // B Dominate
        result.winner = 'B';
        result.loser = 'A';
        result.damageMultiplierA = 0;
        result.damageMultiplierB = 0.6 + diffRatio * 0.4;
        result.resultType = 'dominate';
    } else {
        // B Overpower
        result.winner = 'B';
        result.loser = 'A';
        result.damageMultiplierA = 0;
        result.damageMultiplierB = 1.0;
        result.resultType = 'overpower';
    }
    console.log(`[CLASH] ratio=${ratio.toFixed(2)}, diffRatio=${diffRatio.toFixed(2)}, result=${result.resultType}, dmgA=${result.damageMultiplierA.toFixed(2)}, dmgB=${result.damageMultiplierB.toFixed(2)}`);
    // =====================================================
    // ã€Zæ‹›å¼/æå·¨æ‹›å¼ æœ€ä½ä¼¤å®³ä¿åº•ã€‘
    // Zæ‹›å¼å³ä½¿è¢«æŠµæ¶ˆä¹Ÿè‡³å°‘é€ æˆ 30% ä¼¤å®³
    // æå·¨æ‹›å¼å³ä½¿è¢«æŠµæ¶ˆä¹Ÿè‡³å°‘é€ æˆ 20% ä¼¤å®³
    // =====================================================
    if (resultA.isZMove && result.damageMultiplierA < 0.3) {
        console.log(`[CLASH] Zæ‹›å¼ä¿åº•: ${result.damageMultiplierA.toFixed(2)} â†’ 0.30`);
        result.damageMultiplierA = 0.3;
        result.isZMoveProtected = true;
    } else if (resultA.isMaxMove && result.damageMultiplierA < 0.2) {
        console.log(`[CLASH] æå·¨æ‹›å¼ä¿åº•: ${result.damageMultiplierA.toFixed(2)} â†’ 0.20`);
        result.damageMultiplierA = 0.2;
        result.isMaxMoveProtected = true;
    }
    if (resultB.isZMove && result.damageMultiplierB < 0.3) {
        console.log(`[CLASH] Zæ‹›å¼ä¿åº•: ${result.damageMultiplierB.toFixed(2)} â†’ 0.30`);
        result.damageMultiplierB = 0.3;
        result.isZMoveProtected = true;
    } else if (resultB.isMaxMove && result.damageMultiplierB < 0.2) {
        console.log(`[CLASH] æå·¨æ‹›å¼ä¿åº•: ${result.damageMultiplierB.toFixed(2)} â†’ 0.20`);
        result.damageMultiplierB = 0.2;
        result.isMaxMoveProtected = true;
    }
    // =====================================================
    // ã€å¤šæ®µæ”»å‡» æœ‰æ•ˆæ®µæ•°è®¡ç®—ã€‘
    // æ ¹æ®å¯¹å†²ç»“æœå†³å®šå¤šå°‘æ®µèƒ½ç©¿é€
    // =====================================================
    result.multiHitInfoA = null;
    result.multiHitInfoB = null;
    if (resultA.isMultiHit && resultA.multiHitData) {
        const totalHits = Array.isArray(resultA.multiHitData) 
            ? resultA.multiHitData[1]  // [min, max] å–æœ€å¤§å€¼
            : resultA.multiHitData;
        let effectiveHits = totalHits;
        if (result.winner === 'A') {
            // A èµ¢äº†ï¼Œæ ¹æ®ç»“æœç±»å‹å†³å®šæœ‰æ•ˆæ®µæ•°
            if (result.resultType === 'overpower' || result.resultType === 'dominate') {
                effectiveHits = totalHits; // å…¨éƒ¨æ®µæ•°
            } else if (result.resultType === 'pierce') {
                effectiveHits = Math.ceil(totalHits * 0.6); // 60%
            }
        } else if (result.winner === 'B') {
            // A è¾“äº†
            if (result.resultType === 'neutralize') {
                effectiveHits = Math.ceil(totalHits * 0.4); // 40%
            } else {
                effectiveHits = 1; // åªæœ‰ 1 æ®µ
            }
        } else {
            // å¹³å±€
            effectiveHits = Math.ceil(totalHits * 0.4);
        }
        result.multiHitInfoA = { totalHits, effectiveHits };
        console.log(`[CLASH] å¤šæ®µæ”»å‡»A: ${totalHits}æ®µ â†’ ${effectiveHits}æ®µæœ‰æ•ˆ`);
    }
    if (resultB.isMultiHit && resultB.multiHitData) {
        const totalHits = Array.isArray(resultB.multiHitData) 
            ? resultB.multiHitData[1] 
            : resultB.multiHitData;
        let effectiveHits = totalHits;
        if (result.winner === 'B') {
            if (result.resultType === 'overpower' || result.resultType === 'dominate') {
                effectiveHits = totalHits;
            } else if (result.resultType === 'pierce' || result.resultType === 'backfire') {
                effectiveHits = Math.ceil(totalHits * 0.6);
            }
        } else if (result.winner === 'A') {
            if (result.resultType === 'neutralize') {
                effectiveHits = Math.ceil(totalHits * 0.4);
            } else {
                effectiveHits = 1;
            }
        } else {
            effectiveHits = Math.ceil(totalHits * 0.4);
        }
        result.multiHitInfoB = { totalHits, effectiveHits };
        console.log(`[CLASH] å¤šæ®µæ”»å‡»B: ${totalHits}æ®µ â†’ ${effectiveHits}æ®µæœ‰æ•ˆ`);
    }
    // ç”Ÿæˆæ—¥å¿—
    result.logs = generateClashLogs(result, moveA, moveB, userA, userB);
    return result;
}
/**
 * ç”Ÿæˆå¯¹å†²æ—¥å¿—
 */
function generateClashLogs(result, moveA, moveB, userA, userB) {
    const logs = [];
    const messages = CLASH_MESSAGES[result.resultType] || CLASH_MESSAGES.neutralize;
    const template = messages[Math.floor(Math.random() * messages.length)];
    const winnerName = result.winner === 'A' ? userA.cnName : (result.winner === 'B' ? userB.cnName : null);
    const loserName = result.loser === 'A' ? userA.cnName : (result.loser === 'B' ? userB.cnName : null);
    const winnerMove = result.winner === 'A' ? (moveA.cn || moveA.name) : (result.winner === 'B' ? (moveB.cn || moveB.name) : null);
    let message = template
        .replace('{winner}', winnerName || '')
        .replace('{loser}', loserName || '')
        .replace('{move}', winnerMove || '');
    // æ·»åŠ  CP ä¿¡æ¯ï¼ˆåŒ…å«æŠ€èƒ½åç§°ï¼‰
    const moveNameA = moveA.cn || moveA.name || '???';
    const moveNameB = moveB.cn || moveB.name || '???';
    logs.push(`<b style="color:#f59e0b">âš”ï¸ å¯¹å†²å‘ç”Ÿï¼</b>`);
    logs.push(`${userA.cnName} çš„ <b>${moveNameA}</b> [${getClashTypeName(result.clashTypeA)}] CP:${result.cpA} vs ${userB.cnName} çš„ <b>${moveNameB}</b> [${getClashTypeName(result.clashTypeB)}] CP:${result.cpB}`);
    // ã€æ–°å¢ã€‘æ˜¾ç¤ºä¼¤å®³å‰Šå‡ä¿¡æ¯
    if (result.resultType === 'neutralize' && result.damageMultiplierA > 0 && result.damageMultiplierB > 0) {
        // åŠ¿å‡åŠ›æ•Œï¼šåŒæ–¹éƒ½é€ æˆå‰Šå‡ä¼¤å®³
        const dmgPctA = Math.round(result.damageMultiplierA * 100);
        const dmgPctB = Math.round(result.damageMultiplierB * 100);
        logs.push(`<span style="color:#f59e0b">åŒæ–¹åŠ¿å‡åŠ›æ•Œï¼${userA.cnName} å¨åŠ›å‰Šå‡è‡³ ${dmgPctA}%ï¼Œ${userB.cnName} å¨åŠ›å‰Šå‡è‡³ ${dmgPctB}%</span>`);
    } else {
        logs.push(`<span style="color:#ef4444">${message}</span>`);
        // ã€ä¿®å¤ã€‘æ˜¾ç¤ºéé›¶ä¼¤å®³å‰Šå‡ï¼ˆbackfire/pierce ç­‰æœ‰å‰Šå‡çš„æƒ…å†µï¼‰
        if (result.damageMultiplierA > 0 && result.damageMultiplierA < 1) {
            const dmgPctA = Math.round(result.damageMultiplierA * 100);
            logs.push(`<span style="color:#22c55e">${userA.cnName} çš„æ”»å‡»å¨åŠ›å‰Šå‡è‡³ ${dmgPctA}%</span>`);
        }
        if (result.damageMultiplierB > 0 && result.damageMultiplierB < 1) {
            const dmgPctB = Math.round(result.damageMultiplierB * 100);
            logs.push(`<span style="color:#22c55e">${userB.cnName} çš„æ”»å‡»å¨åŠ›å‰Šå‡è‡³ ${dmgPctB}%</span>`);
        }
    }
    // ã€Zæ‹›å¼/æå·¨æ‹›å¼ä¿åº•æç¤ºã€‘
    if (result.isZMoveProtected) {
        logs.push(`<span style="color:#a855f7">ğŸ’ Zæ‹›å¼çš„åŠ›é‡æ— æ³•è¢«å®Œå…¨æŠµæ¶ˆï¼ä¿ç•™ 30% å¨åŠ›ï¼</span>`);
    }
    if (result.isMaxMoveProtected) {
        logs.push(`<span style="color:#ec4899">ğŸ”¥ æå·¨æ‹›å¼çš„åŠ›é‡æ— æ³•è¢«å®Œå…¨æŠµæ¶ˆï¼ä¿ç•™ 20% å¨åŠ›ï¼</span>`);
    }
    // ã€å¤šæ®µæ”»å‡»æœ‰æ•ˆæ®µæ•°æç¤ºã€‘
    if (result.multiHitInfoA) {
        const { totalHits, effectiveHits } = result.multiHitInfoA;
        if (effectiveHits < totalHits) {
            logs.push(`<span style="color:#06b6d4">${userA.cnName} çš„å¤šæ®µæ”»å‡»ï¼š${totalHits}æ®µä¸­æœ‰ ${effectiveHits}æ®µ ç©¿é€äº†å¯¹å†²ï¼</span>`);
        }
    }
    if (result.multiHitInfoB) {
        const { totalHits, effectiveHits } = result.multiHitInfoB;
        if (effectiveHits < totalHits) {
            logs.push(`<span style="color:#06b6d4">${userB.cnName} çš„å¤šæ®µæ”»å‡»ï¼š${totalHits}æ®µä¸­æœ‰ ${effectiveHits}æ®µ ç©¿é€äº†å¯¹å†²ï¼</span>`);
        }
    }
    return logs;
}
// ============================================
// æ ¸å¿ƒå‡½æ•°ï¼šå¯¹å†²æ¡ä»¶æ£€æŸ¥
// ============================================
/**
 * æ£€æŸ¥æ‹›å¼æ˜¯å¦å¯ä»¥å‚ä¸å¯¹å†²
 * @param {Object} move - æ‹›å¼å¯¹è±¡
 * @returns {{ canClash: boolean, reason: string }}
 */
function canClash(move) {
    if (!move) return { canClash: false, reason: 'æ— æ•ˆæ‹›å¼' };
    const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    const flags = move.flags || fullMoveData.flags || {};
    // =====================================================
    // === ã€ä¸å¯å¯¹å†²é»‘åå•ã€‘Hard Logic ===
    // =====================================================
    // 1. å˜åŒ–æŠ€ä¸èƒ½å¯¹å†²ï¼ˆæ²¡æœ‰å¼¹é“ï¼‰
    const category = fullMoveData.category || move.category || 'Physical';
    if (category === 'Status') {
        return { canClash: false, reason: 'å˜åŒ–æŠ€æ— æ³•å¯¹å†²' };
    }
    // 2. å¨åŠ›ä¸º 0 çš„æ‹›å¼ä¸èƒ½å¯¹å†²
    const basePower = move.basePower || move.power || fullMoveData.basePower || 0;
    if (basePower === 0) {
        return { canClash: false, reason: 'æ— å¨åŠ›æ‹›å¼æ— æ³•å¯¹å†²' };
    }
    // 3. å£°éŸ³ç±»æ‹›å¼ä¸èƒ½å¯¹å†²ï¼ˆæ³¢åŠ¨/å£°éŸ³ï¼Œæ— å®ä½“ï¼‰
    if (flags.sound) {
        return { canClash: false, reason: 'å£°éŸ³ç±»æ‹›å¼æ— æ³•å¯¹å†²' };
    }
    // 4. ç²‰æœ«ç±»æ‹›å¼ä¸èƒ½å¯¹å†²ï¼ˆæ— å½¢ç‰©è´¨ï¼‰
    if (flags.powder) {
        return { canClash: false, reason: 'ç²‰æœ«ç±»æ‹›å¼æ— æ³•å¯¹å†²' };
    }
    // 5. åœºåœ°/ç¯å¢ƒç±»æ‹›å¼ä¸èƒ½å¯¹å†²ï¼ˆåœ°éœ‡ç­‰ï¼ŒåŠ›é‡æ¥è‡ªè„šä¸‹ï¼‰
    // ä½¿ç”¨ WAVE_OVERRIDE åˆ—è¡¨æˆ– nonsky flag
    if (WAVE_OVERRIDE.includes(moveId)) {
        return { canClash: false, reason: 'åœºåœ°ç±»æ‹›å¼æ— æ³•å¯¹å†²' };
    }
    // 6. å®ˆä½ç±»æ‹›å¼ä¸èƒ½å¯¹å†²
    const protectMoves = ['protect', 'detect', 'kingsshield', 'spikyshield', 'banefulbunker', 'obstruct', 'silktrap', 'burningbulwark'];
    if (protectMoves.includes(moveId)) {
        return { canClash: false, reason: 'é˜²æŠ¤ç±»æ‹›å¼æ— æ³•å¯¹å†²' };
    }
    // =====================================================
    // === ã€ä¸å¯å¯¹å†²é»‘åå•ã€‘Soft Logic ===
    // =====================================================
    // 7. å¿…ä¸­æ‹›å¼ä¸èƒ½è¢«å¯¹å†²ï¼ˆæ¦‚å¿µç±»æˆ˜æŠ€ï¼‰
    // æ³¨æ„ï¼šè¿™é‡Œåªæ£€æŸ¥æ”»å‡»æ–¹æ‹›å¼æ˜¯å¦å¿…ä¸­ï¼Œå¿…ä¸­æ‹›å¼å¯ä»¥ä¸»åŠ¨å¯¹å†²åˆ«äºº
    // ä½†åœ¨ canTriggerClash ä¸­ä¼šæ£€æŸ¥é˜²å®ˆæ–¹æ‹›å¼æ˜¯å¦å¿…ä¸­
    // 8. å¼‚æ¬¡å…ƒæ½œè¢­ç±»ï¼ˆä»å¼‚æ¬¡å…ƒé’»å‡ºï¼‰
    const phasingMoves = ['phantomforce', 'shadowforce', 'hyperspacefury', 'hyperspacehole'];
    if (phasingMoves.includes(moveId)) {
        return { canClash: false, reason: 'å¼‚æ¬¡å…ƒç±»æ‹›å¼æ— æ³•å¯¹å†²' };
    }
    // 9. ç²¾ç¥/å¿µåŠ›ç±»ï¼ˆç›´æ¥ä½œç”¨äºç²¾ç¥ï¼Œæ— å¼¹é“ï¼‰
    const mentalMoves = ['psychic', 'psyshock', 'dreameater', 'hex', 'nightshade', 'seismictoss', 'counter', 'mirrorcoat'];
    if (mentalMoves.includes(moveId)) {
        return { canClash: false, reason: 'ç²¾ç¥ç±»æ‹›å¼æ— æ³•å¯¹å†²' };
    }
    return { canClash: true, reason: 'å¯ä»¥å¯¹å†²' };
}
/**
 * æ£€æŸ¥æ˜¯å¦æ»¡è¶³å¯¹å†²è§¦å‘æ¡ä»¶ï¼ˆæ”¾å®½ç‰ˆæœ¬ï¼‰
 * @param {Object} attacker - æ”»å‡»æ–¹
 * @param {Object} defender - é˜²å®ˆæ–¹
 * @param {Object} attackerMove - æ”»å‡»æ–¹æ‹›å¼
 * @param {Object} defenderMove - é˜²å®ˆæ–¹æ‹›å¼
 * @param {Object} options - { requireSpeedDisadvantage: boolean }
 * @returns {Object} { canTrigger, reason }
 */
function canTriggerClash(attacker, defender, attackerMove, defenderMove, options = {}) {
    // åŸºç¡€æ£€æŸ¥ï¼šä½¿ç”¨æ–°çš„ canClash è¿”å›æ ¼å¼
    const attackerClashCheck = canClash(attackerMove);
    if (!attackerClashCheck.canClash) {
        return { canTrigger: false, reason: `æˆ‘æ–¹æ‹›å¼: ${attackerClashCheck.reason}` };
    }
    const defenderClashCheck = canClash(defenderMove);
    if (!defenderClashCheck.canClash) {
        return { canTrigger: false, reason: `å¯¹æ–¹æ‹›å¼: ${defenderClashCheck.reason}` };
    }
    // å¯¹æ–¹æ‹›å¼å¿…é¡»æ˜¯"éå¿…ä¸­"çš„æ”»å‡»æŠ€èƒ½ï¼ˆå¿…ä¸­æ‹›å¼æ— æ³•è¢«æ‹¦æˆªï¼‰
    const defenderMoveId = (defenderMove.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const defenderMoveData = (typeof MOVES !== 'undefined' && MOVES[defenderMoveId]) ? MOVES[defenderMoveId] : {};
    if (defenderMoveData.accuracy === true || defenderMove.accuracy === true) {
        return { canTrigger: false, reason: 'å¯¹æ–¹æ‹›å¼å¿…ä¸­ï¼Œæ— æ³•å¯¹å†²' };
    }
    return { canTrigger: true, reason: 'æ»¡è¶³å¯¹å†²æ¡ä»¶' };
}
/**
 * æ£€æŸ¥å¯¹å†²æ˜¯å¦æˆåŠŸè§¦å‘ï¼ˆæ¦‚ç‡æ£€æŸ¥ï¼‰
 * åŸºäºè®­ç»ƒå®¶ç†Ÿç»ƒåº¦ï¼Œæœ€é«˜ 255 = 75% è§¦å‘ç‡
 * @param {number} proficiency - è®­ç»ƒå®¶ç†Ÿç»ƒåº¦ (0-255)
 * @returns {{ success: boolean, roll: number, chance: number }}
 */
function rollClashTrigger(proficiency = 0) {
    // æ¦‚ç‡å…¬å¼ï¼šchance = proficiency / 340
    // æ»¡ç†Ÿç»ƒåº¦ 255 æ—¶çº¦ 75% è§¦å‘ç‡
    // 0 ç†Ÿç»ƒåº¦æ—¶ 0% è§¦å‘ç‡ï¼ˆæ–°æ‰‹æ— æ³•è§¦å‘å¯¹å†²ï¼‰
    const clampedProf = Math.min(255, Math.max(0, proficiency));
    const triggerChance = clampedProf / 340;
    const roll = Math.random();
    const success = roll < triggerChance;
    console.log(`[CLASH] è§¦å‘åˆ¤å®š: roll=${roll.toFixed(3)} vs chance=${triggerChance.toFixed(3)} (ç†Ÿç»ƒåº¦=${clampedProf}) => ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
    return { success, roll, chance: triggerChance };
}
/**
 * è®¡ç®—é€Ÿåº¦ä¿®æ­£ç³»æ•°ï¼ˆåŒå‘ï¼‰
 * å…ˆæ‰‹æ–¹æœ‰é€Ÿåº¦åŠ æˆï¼ˆæ‹›å¼å·²ç»æ‰“å‡ºå»äº†ï¼‰
 * åæ‰‹æ–¹æœ‰é€Ÿåº¦æƒ©ç½šï¼ˆå¯¹å†²æ•ˆæœå‰Šå¼±ï¼‰
 * @param {Object} slower - åæ‰‹æ–¹ï¼ˆå‘èµ·å¯¹å†²çš„ä¸€æ–¹ï¼‰
 * @param {Object} faster - å…ˆæ‰‹æ–¹ï¼ˆè¢«å¯¹å†²çš„ä¸€æ–¹ï¼‰
 * @returns {{ slowerModifier: number, fasterModifier: number, speedRatio: number }}
 */
function getSpeedModifiers(slower, faster) {
    const slowerSpeed = (typeof slower.getStat === 'function') ? slower.getStat('spe') : (slower.spe || 100);
    const fasterSpeed = (typeof faster.getStat === 'function') ? faster.getStat('spe') : (faster.spe || 100);
    // é€Ÿåº¦æ¯”ä¾‹ï¼šåæ‰‹/å…ˆæ‰‹
    const speedRatio = slowerSpeed / fasterSpeed;
    // åæ‰‹æ–¹ä¿®æ­£ï¼šé€Ÿåº¦è¶Šæ…¢ï¼Œå¯¹å†²æ•ˆæœè¶Šå·®
    // speedRatio = 0.5 æ—¶ï¼Œä¿®æ­£ = 0.75ï¼ˆå¯¹å†²ä¼¤å®³å‰Šå‡ 25%ï¼‰
    // speedRatio = 0.7 æ—¶ï¼Œä¿®æ­£ = 0.85ï¼ˆå¯¹å†²ä¼¤å®³å‰Šå‡ 15%ï¼‰
    // speedRatio = 1.0 æ—¶ï¼Œä¿®æ­£ = 1.0ï¼ˆæ— å‰Šå‡ï¼‰
    const slowerModifier = Math.min(1.0, 0.5 + speedRatio * 0.5);
    // å…ˆæ‰‹æ–¹ä¿®æ­£ï¼šé€Ÿåº¦è¶Šå¿«ï¼Œæ‹›å¼å¨åŠ›è¶Šå¼º
    // speedRatio = 0.5 æ—¶ï¼ˆå…ˆæ‰‹æ˜¯åæ‰‹çš„2å€é€Ÿï¼‰ï¼ŒåŠ æˆ = 1.25
    // speedRatio = 0.7 æ—¶ï¼ŒåŠ æˆ = 1.15
    // speedRatio = 1.0 æ—¶ï¼ŒåŠ æˆ = 1.0ï¼ˆæ— åŠ æˆï¼‰
    const fasterModifier = Math.min(1.3, 1.0 + (1 - speedRatio) * 0.5);
    console.log(`[CLASH] é€Ÿåº¦ä¿®æ­£è®¡ç®—: åæ‰‹${slowerSpeed} vs å…ˆæ‰‹${fasterSpeed}, ratio=${speedRatio.toFixed(2)}`);
    console.log(`[CLASH] åæ‰‹ä¿®æ­£=${slowerModifier.toFixed(2)}, å…ˆæ‰‹ä¿®æ­£=${fasterModifier.toFixed(2)}`);
    return { slowerModifier, fasterModifier, speedRatio };
}
// ä¿ç•™æ—§å‡½æ•°ä»¥å…¼å®¹
function getSpeedModifier(attacker, defender) {
    const result = getSpeedModifiers(attacker, defender);
    return result.slowerModifier;
}
// ============================================
// æ ¸å¿ƒå‡½æ•°ï¼šæ€æ„æ„ŸçŸ¥ (Insight Check)
// ============================================
/**
 * é¢„è®¡ç®—æ„å›¾ (æ€æ„æ„ŸçŸ¥)
 * @param {Object} attacker - æ”»å‡»æ–¹ (é€Ÿåº¦å¿«çš„ä¸€æ–¹)
 * @param {Object} defender - é˜²å®ˆæ–¹ (é€Ÿåº¦æ…¢çš„ä¸€æ–¹)
 * @param {Object} move - æ”»å‡»æ–¹æ‹›å¼
 * @returns {Object} { success, level, message, moveType, moveCategory }
 */
function preCalculateIntent(attacker, defender, move) {
    if (!attacker || !defender || !move) {
        return { success: false, level: 0, message: null };
    }
    // è·å–é˜²å®ˆæ–¹çš„ Insight AVsï¼ˆä¸å†é™åˆ¶ isAceï¼‰
    let insightValue = 0;
    if (defender.avs && typeof defender.getEffectiveAVs === 'function') {
        insightValue = defender.getEffectiveAVs('insight');
    } else if (defender.avs?.insight) {
        insightValue = defender.avs.insight;
    }
    // è·å–è®­ç»ƒå®¶ç†Ÿç»ƒåº¦
    const proficiency = (typeof battle !== 'undefined' && battle.trainerProficiency) 
        ? battle.trainerProficiency 
        : 0;
    // ã€æ–°å…¬å¼ã€‘ç»“åˆ Insight AVS å’Œ trainerProficiencyï¼Œå°é¡¶ 30%
    // åŸºç¡€æ¦‚ç‡ = (Insight / 255) * 15% + (Proficiency / 255) * 15%
    // æ»¡å€¼æ—¶ï¼š15% + 15% = 30%
    const insightContrib = (Math.min(insightValue, 255) / 255) * 0.15;
    const profContrib = (Math.min(proficiency, 255) / 255) * 0.15;
    const successRate = Math.min(0.30, insightContrib + profContrib);
    // æ ¹æ® Insight å€¼å†³å®šä¿¡æ¯ç­‰çº§
    let level = 0;
    if (insightValue >= INSIGHT_THRESHOLDS.FULL) {
        level = 4; // å®Œæ•´ä¿¡æ¯ï¼ˆçŸ¥é“å…·ä½“æ‹›å¼åï¼‰
    } else if (insightValue >= INSIGHT_THRESHOLDS.CATEGORY) {
        level = 3; // å±æ€§ + åˆ†ç±»
    } else if (insightValue >= INSIGHT_THRESHOLDS.TYPE) {
        level = 2; // ä»…å±æ€§
    } else if (insightValue >= INSIGHT_THRESHOLDS.BASIC) {
        level = 1; // ä»…æ„å›¾
    } else {
        // Insight å¤ªä½ï¼Œæ— æ³•æ„ŸçŸ¥
        return { success: false, level: 0, message: null };
    }
    console.log(`[INSIGHT] è§¦å‘åˆ¤å®š: Insight=${insightValue}, Prof=${proficiency}, Rate=${(successRate * 100).toFixed(1)}%, Level=${level}`);
    const success = Math.random() < successRate;
    if (!success) {
        return { success: false, level: 0, message: null };
    }
    // ç”Ÿæˆæ„ŸçŸ¥ä¿¡æ¯
    const moveId = (move.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const fullMoveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : {};
    const moveType = move.type || fullMoveData.type || 'Normal';
    const moveCategory = fullMoveData.category || move.category || 'Physical';
    const moveCn = move.cn || move.name || 'æœªçŸ¥æ‹›å¼';
    let message = '';
    switch (level) {
        case 4:
            message = `ç›´è§‰å‘Šè¯‰ä½ ï¼Œå¯¹æ–¹å‡†å¤‡ä½¿ç”¨ã€${moveCn}ã€‘ï¼`;
            break;
        case 3:
            message = `ç›´è§‰å‘Šè¯‰ä½ ï¼Œä¸€è‚¡${moveType}ç³»çš„${moveCategory === 'Physical' ? 'ç‰©ç†' : 'ç‰¹æ®Š'}èƒ½é‡æ­£åœ¨æ±‡èš...`;
            break;
        case 2:
            message = `ç›´è§‰å‘Šè¯‰ä½ ï¼Œä¸€è‚¡${moveType}ç³»çš„èƒ½é‡æ­£åœ¨æ±‡èš...`;
            break;
        case 1:
            message = `ç›´è§‰å‘Šè¯‰ä½ ï¼Œå¯¹æ–¹æ­£åœ¨å‡†å¤‡æ”»å‡»...`;
            break;
    }
    return {
        success: true,
        level,
        message,
        moveType,
        moveCategory,
        insightValue,
        successRate: Math.round(successRate * 100)
    };
}
// ============================================
// UI è¾…åŠ©å‡½æ•°
// ============================================
/**
 * æ˜¾ç¤ºæ€æ„æ„ŸçŸ¥è­¦å‘Š
 * @param {Object} insightResult - preCalculateIntent çš„è¿”å›å€¼
 */
function showInsightWarning(insightResult) {
    if (!insightResult || !insightResult.success) return;
    // åˆ›å»ºæˆ–è·å– Insight è­¦å‘Šå…ƒç´ 
    let warningEl = document.getElementById('insight-warning');
    if (!warningEl) {
        warningEl = document.createElement('div');
        warningEl.id = 'insight-warning';
        warningEl.className = 'insight-warning';
        // æ’å…¥åˆ°æˆ˜æ–—åŒºåŸŸ
        const battleStage = document.querySelector('.battle-stage');
        if (battleStage) {
            battleStage.appendChild(warningEl);
        }
    }
    // è®¾ç½®å†…å®¹
    warningEl.innerHTML = `
        <div class="insight-icon">ğŸ”´</div>
        <div class="insight-text">${insightResult.message}</div>
    `;
    // æ˜¾ç¤ºåŠ¨ç”»
    warningEl.classList.add('active');
    // 3ç§’åéšè—
    setTimeout(() => {
        warningEl.classList.remove('active');
    }, 3000);
}
/**
 * æ˜¾ç¤ºå¯¹å†²é€‰é¡¹
 * @param {Object} playerMove - ç©å®¶æ‹›å¼
 * @param {Object} enemyMove - æ•Œæ–¹æ‹›å¼ (å¯èƒ½æ˜¯é¢„åˆ¤çš„)
 * @returns {Promise<string>} 'clash' | 'normal'
 */
function showClashOption(playerMove, enemyMove) {
    return new Promise((resolve) => {
        // åˆ›å»ºå¯¹å†²é€‰é¡¹ UI
        let clashModal = document.getElementById('clash-option-modal');
        if (!clashModal) {
            clashModal = document.createElement('div');
            clashModal.id = 'clash-option-modal';
            clashModal.className = 'clash-option-modal';
            // æ·»åŠ åˆ° .ui-scale å†…éƒ¨ï¼Œç¡®ä¿åœ¨ .screen-filters çš„å±‚å ä¸Šä¸‹æ–‡ä¸­
            const uiScale = document.getElementById('ui-scale') || document.body;
            uiScale.appendChild(clashModal);
        }
        const playerClashType = getClashType(playerMove);
        const enemyClashType = enemyMove ? getClashType(enemyMove) : null;
        // 1. å®šä¹‰ä¸¤ä¸ªçŸ¢é‡ SVG å›¾æ ‡ (ä¿è¯é«˜æ¸…æ— é”¯é½¿ï¼Œä¸è¦ç”¨ Emoji)
        const iconClashAction = `
<svg width="28" height="32" viewBox="0 0 64 80" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path d="M46.85449,37.19678l9.33106-3.73242a.49983.49983,0,0,0-.09619-.95606L45.98047,30.66992l10.38818-11.332a.50008.50008,0,0,0-.60547-.77832L43.87305,24.96191,47.47412,14.1582a.49989.49989,0,0,0-.82764-.51172l-9.27734,9.27686L35.49609,7.938a.49945.49945,0,0,0-.44677-.43555.50692.50692,0,0,0-.52344.33936L29.79541,22.03174,20.37012,11.66357a.50019.50019,0,0,0-.85742.44873l2.82617,12.24561-9.24073-1.84814a.5.5,0,0,0-.4746.81933l6.40966,7.3252L7.918,32.50684a.4998.4998,0,0,0-.08887.96289L18.05127,37.187,7.66357,46.62988a.5.5,0,0,0,.5044.84082l12.90137-4.60742L17.543,50.79688a.50017.50017,0,0,0,.76953.59375l9.37891-7.50342L30.5127,56.1123a.49925.49925,0,0,0,.45214.38624L31,56.5a.50064.50064,0,0,0,.4668-.32031l4.72363-12.28223,5.456,5.45606A.5.5,0,0,0,42.5,49V42.7583l13.30322,5.70117a.5.5,0,0,0,.5669-.7959Z"/>
</svg>`;
        const iconHoldAction = `
<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="10" />
  <polyline points="12 6 12 12 16 14" />
</svg>`;
        const headerIcon = `
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
</svg>`;
        // 2. åªæœ‰å†…éƒ¨ç»“æ„çš„ HTML
        clashModal.innerHTML = `
            <div class="clash-card-core">
                <!-- é»‘è‰²åˆ‡å‰²é¡¶æ  -->
                <div class="clash-header-bar">
                    <span class="header-deco">${headerIcon}</span>
                    <span class="header-title">CLASH OPPORTUNITY</span>
                    <span class="header-sub">å¯¹å†²åˆ¤å®š</span>
                </div>
                <!-- å†…å®¹åŒºåŸŸ -->
                <div class="clash-body-grid">
                    <!-- Left (You) -->
                    <div class="unit-group p1-side">
                        <div class="unit-role-lbl">YOUR ACTION</div>
                        <div class="unit-main-name">${playerMove.cn || playerMove.name}</div>
                        <div class="unit-divider p1-divider"></div>
                        <div class="unit-badge tier-1">${getClashTypeName(playerClashType)}</div>
                    </div>
                    <!-- VS Central Divider -->
                    <div class="vs-divider-shape">
                        <div class="vs-shockwave"></div>
                        <div class="vs-text">VS</div>
                    </div>
                    <!-- Right (Enemy) -->
                    <div class="unit-group p2-side">
                        <div class="unit-role-lbl">INCOMING</div>
                        <div class="unit-main-name">${enemyMove ? (enemyMove.cn || enemyMove.name) : 'PREDICTING...'}</div>
                        <div class="unit-divider p2-divider"></div>
                        <div class="unit-badge tier-2">${enemyMove ? getClashTypeName(enemyClashType) : '???'}</div>
                    </div>
                </div>
                <!-- åº•éƒ¨æ— ç¼æŒ‰é’®åŒº -->
                <div class="clash-action-deck">
                    <button id="btn-clash-yes" class="deck-btn primary is-skew">
                        <div class="btn-inner-unskew">
                            <span class="btn-msg">CLASH</span>
                            <span class="btn-sub-msg">å¼ºåˆ¶æ‹¦æˆª</span>
                            <div class="btn-floating-icon">${iconClashAction}</div>
                        </div>
                        <div class="btn-shine"></div>
                    </button>
                    <button id="btn-clash-no" class="deck-btn secondary is-skew">
                        <div class="btn-inner-unskew">
                            <div class="btn-floating-icon right">${iconHoldAction}</div>
                            <span class="btn-msg">PASS</span>
                            <span class="btn-sub-msg">æ”¾å¼ƒå¯¹å†²</span>
                        </div>
                    </button>
                </div>
            </div>
        `;
        // å¼ºåˆ¶é‡æ’ä»¥è§¦å‘åŠ¨ç”»
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                clashModal.classList.add('active');
            });
        });
        // ç»‘å®šäº‹ä»¶
        document.getElementById('btn-clash-yes').onclick = () => {
            // æ’­æ”¾é‡å‡»éŸ³æ•ˆ
            if (typeof playSFX === 'function') {
                playSFX('HIT_SUPER');
            }
            clashModal.classList.remove('active');
            setTimeout(() => resolve('clash'), 200);
        };
        document.getElementById('btn-clash-no').onclick = () => {
            clashModal.classList.remove('active');
            setTimeout(() => resolve('normal'), 200);
        };
    });
}
/**
 * æ›´æ–° Insight Bar UI
 * @param {Object} pokemon - å½“å‰å®å¯æ¢¦
 */
function updateInsightBar(pokemon) {
    const insightBar = document.getElementById('insight-bar');
    if (!insightBar) return;
    const insightValue = (pokemon && pokemon.isAce && pokemon.avs && typeof pokemon.getEffectiveAVs === 'function')
        ? pokemon.getEffectiveAVs('insight')
        : 0;
    const percentage = Math.min(100, (insightValue / 255) * 100);
    const fill = insightBar.querySelector('.insight-bar-fill');
    if (fill) {
        fill.style.width = `${percentage}%`;
    }
    const text = insightBar.querySelector('.insight-bar-text');
    if (text) {
        text.textContent = `ç›´è§‰: ${insightValue}`;
    }
}
// ============================================
// AI å¯¹å†²å†³ç­–
// ============================================
/**
 * AI å†³å®šæ˜¯å¦å‘èµ·å¯¹å†²ï¼ˆæ•Œæ–¹åæ‰‹æ—¶è°ƒç”¨ï¼‰
 * @param {Object} enemy - æ•Œæ–¹å®å¯æ¢¦
 * @param {Object} player - ç©å®¶å®å¯æ¢¦
 * @param {Object} enemyMove - æ•Œæ–¹æ‹›å¼
 * @param {Object} playerMove - ç©å®¶æ‹›å¼
 * @returns {Object} { shouldClash: boolean, reason: string }
 */
function aiDecideClash(enemy, player, enemyMove, playerMove) {
    // åŸºç¡€æ£€æŸ¥ï¼šä½¿ç”¨æ–°çš„ canClash è¿”å›æ ¼å¼
    const enemyClashCheck = canClash(enemyMove);
    if (!enemyClashCheck.canClash) {
        return { shouldClash: false, reason: `AI æ”¾å¼ƒå¯¹å†² (æ•Œæ–¹æ‹›å¼: ${enemyClashCheck.reason})` };
    }
    const playerClashCheck = canClash(playerMove);
    if (!playerClashCheck.canClash) {
        return { shouldClash: false, reason: `AI æ”¾å¼ƒå¯¹å†² (ç©å®¶æ‹›å¼: ${playerClashCheck.reason})` };
    }
    // ç©å®¶æ‹›å¼å¿…ä¸­åˆ™æ— æ³•å¯¹å†²
    const playerMoveId = (playerMove.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const playerMoveData = (typeof MOVES !== 'undefined' && MOVES[playerMoveId]) ? MOVES[playerMoveId] : {};
    if (playerMoveData.accuracy === true || playerMove.accuracy === true) {
        return { shouldClash: false, reason: 'AI æ”¾å¼ƒå¯¹å†² (ç©å®¶æ‹›å¼å¿…ä¸­)' };
    }
    // è®¡ç®—åŒæ–¹ Clash Power
    const enemyCP = calculateClashPower(enemy, enemyMove, player, playerMove);
    const playerCP = calculateClashPower(player, playerMove, enemy, enemyMove);
    const cpRatio = enemyCP.cp / (playerCP.cp || 1);
    // è·å– Clash Type äº¤äº’
    const enemyClashType = getClashType(enemyMove);
    const playerClashType = getClashType(playerMove);
    const interaction = getClashInteraction(enemyClashType, playerClashType);
    // === AI å†³ç­–å› ç´  ===
    let clashScore = 0;
    // 1. CP ä¼˜åŠ¿åŠ åˆ†
    if (cpRatio >= 2.0) {
        clashScore += 60; // ç¢¾å‹ä¼˜åŠ¿
    } else if (cpRatio >= 1.5) {
        clashScore += 40; // æ˜æ˜¾ä¼˜åŠ¿
    } else if (cpRatio >= 1.2) {
        clashScore += 20; // è½»å¾®ä¼˜åŠ¿
    } else if (cpRatio >= 0.8) {
        clashScore += 0; // åŠ¿å‡åŠ›æ•Œ
    } else if (cpRatio >= 0.5) {
        clashScore -= 10; // è½»å¾®åŠ£åŠ¿
    } else {
        clashScore -= 20; // æ˜æ˜¾åŠ£åŠ¿
    }
    // 2. Clash Type ä¼˜åŠ¿åŠ åˆ†
    if (interaction.advantage >= 0.5) {
        clashScore += 20; // ç±»å‹ä¼˜åŠ¿
    } else if (interaction.advantage <= -0.5) {
        clashScore -= 20; // ç±»å‹åŠ£åŠ¿
    }
    // 3. ã€å…³é”®ã€‘ç”Ÿå­˜å‹åŠ›ï¼šè¡€çº¿æ—¶å¿…é¡»å¯¹å†²ï¼
    const enemyHp = enemy.currHp || 0;
    const enemyMaxHp = enemy.maxHp || enemy.hp || 100;
    const hpPercent = enemyHp / enemyMaxHp;
    // è¡€çº¿åˆ¤å®šï¼šHP < 30% æ—¶å¤§å¹…å¢åŠ å¯¹å†²å€¾å‘
    if (hpPercent <= 0.30) {
        clashScore += 80; // è¡€çº¿æ—¶å¼ºçƒˆå€¾å‘å¯¹å†²ï¼Œè¿™æ˜¯æœ€åçš„æœºä¼š
        console.log(`[AI CLASH] è¡€çº¿å‹åŠ›: HP ${Math.round(hpPercent * 100)}% <= 30%ï¼Œ+80åˆ†`);
    } else if (hpPercent <= 0.50) {
        clashScore += 40; // åŠè¡€æ—¶ä¹Ÿå¢åŠ å¯¹å†²å€¾å‘
        console.log(`[AI CLASH] åŠè¡€å‹åŠ›: HP ${Math.round(hpPercent * 100)}% <= 50%ï¼Œ+40åˆ†`);
    }
    // é¢„ä¼°ä¼¤å®³æ£€æŸ¥ï¼šå¦‚æœä¸å¯¹å†²ä¼šè¢«ç§’æ€
    const playerMoveBasePower = playerMove.basePower || playerMoveData.basePower || 0;
    const estimatedDamage = Math.floor(playerMoveBasePower * 2); // ç²—ç•¥ä¼°ç®—
    if (estimatedDamage >= enemyHp) {
        clashScore += 50; // ä¼šè¢«ç§’æ€ï¼Œå¯¹å†²æ˜¯å”¯ä¸€ç”Ÿè·¯
        console.log(`[AI CLASH] ç§’æ€å‹åŠ›: é¢„ä¼°ä¼¤å®³ ${estimatedDamage} >= HP ${enemyHp}ï¼Œ+50åˆ†`);
    }
    // 4. éšæœºå› ç´ ï¼ˆå¢åŠ ä¸å¯é¢„æµ‹æ€§ï¼‰
    const randomFactor = Math.random() * 20 - 10; // -10 ~ +10
    clashScore += randomFactor;
    console.log(`[AI CLASH] å†³ç­–è¯„åˆ†: ${Math.round(clashScore)} (CPæ¯”=${cpRatio.toFixed(2)}, ç±»å‹ä¼˜åŠ¿=${interaction.advantage}, HP=${Math.round(hpPercent * 100)}%)`);
    // é˜ˆå€¼ï¼šè¯„åˆ† >= 20 åˆ™å¯¹å†²ï¼ˆé™ä½é˜ˆå€¼ï¼Œè®©å¯¹å†²æ›´å®¹æ˜“è§¦å‘ï¼‰
    const shouldClash = clashScore >= 20;
    return {
        shouldClash,
        reason: shouldClash 
            ? `AI å†³å®šå¯¹å†² (è¯„åˆ†: ${Math.round(clashScore)})` 
            : `AI æ”¾å¼ƒå¯¹å†² (è¯„åˆ†: ${Math.round(clashScore)})`,
        score: clashScore,
        cpRatio,
        enemyClashType,
        playerClashType
    };
}
// ============================================
// å¯¼å‡º
// ============================================
if (typeof window !== 'undefined') {
    // å¸¸é‡
    window.CLASH_TYPE = CLASH_TYPE;
    // æ ¸å¿ƒå‡½æ•°
    window.getClashType = getClashType;
    window.getClashTypeName = getClashTypeName;
    window.getClashInteraction = getClashInteraction;
    window.getTypeClashModifier = getTypeClashModifier;
    window.calculateClashPower = calculateClashPower;
    window.resolveClash = resolveClash;
    window.canClash = canClash;
    window.canTriggerClash = canTriggerClash;
    window.preCalculateIntent = preCalculateIntent;
    window.rollClashTrigger = rollClashTrigger;
    window.getSpeedModifier = getSpeedModifier;
    window.getSpeedModifiers = getSpeedModifiers;
    // AI å‡½æ•°
    window.aiDecideClash = aiDecideClash;
    // UI å‡½æ•°
    window.showInsightWarning = showInsightWarning;
    window.showClashOption = showClashOption;
    window.updateInsightBar = updateInsightBar;
}
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        CLASH_TYPE,
        getClashType,
        getClashTypeName,
        getClashInteraction,
        getTypeClashModifier,
        calculateClashPower,
        resolveClash,
        canClash,
        canTriggerClash,
        preCalculateIntent
    };
}
console.log('[CLASH SYSTEM] å¯¹å†²ç³»ç»Ÿå·²åŠ è½½');
]]></file>
        <file name="dynamax.js"><![CDATA[/**
 * ===========================================
 * DYNAMAX.JS - æå·¨åŒ–ç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - æå·¨åŒ–çŠ¶æ€ç®¡ç†
 * - æ‹›å¼è½¬æ¢ï¼ˆæ™®é€šæ‹›å¼ <-> æå·¨æ‹›å¼ï¼‰
 * - æå·¨æ‹›å¼æ¨å¯¼ï¼ˆMax Move / G-Max Moveï¼‰
 * - HP å€å¢/æ¢å¤
 */
// ============================================
// G-Max ä¸“å±æ‹›å¼è¡¨ (åŠ¨æ€æ„å»º)
// ============================================
const GMAX_MOVE_MAP = {};
// ============================================
// åˆå§‹åŒ–ï¼šä»æ•°æ®åº“æ„å»º G-Max æ˜ å°„è¡¨
// ============================================
(function buildGMaxMoveMap() {
    if (typeof MOVES === 'undefined') {
        console.warn('[DYNAMAX] MOVES database not loaded');
        return;
    }
    // éå†æ‰€æœ‰æ‹›å¼ï¼Œæ„å»º G-Max ä¸“å±æ‹›å¼è¡¨
    for (const moveId in MOVES) {
        const moveData = MOVES[moveId];
        // æ„å»º G-Max ä¸“å±æ‹›å¼è¡¨
        if (moveData.isMax && typeof moveData.isMax === 'string') {
            const species = moveData.isMax.toLowerCase().replace(/[^a-z0-9]/g, '');
            GMAX_MOVE_MAP[species] = {
                name: moveData.name,
                id: moveId,
                type: moveData.type,
                basePower: moveData.basePower || 130
            };
        }
    }
    console.log('[DYNAMAX] Built GMAX_MOVE_MAP:', Object.keys(GMAX_MOVE_MAP).length, 'entries');
})();
// ============================================
// æå·¨æ‹›å¼æ¨å¯¼å‡½æ•°
// ============================================
/**
 * è®¡ç®—æå·¨æ‹›å¼å¨åŠ›
 * @param {number} basePower - åŸæ‹›å¼å¨åŠ›
 * @param {string} moveType - æ‹›å¼å±æ€§
 * @returns {number} æå·¨æ‹›å¼å¨åŠ›
 */
function calculateMaxMovePower(basePower, moveType) {
    // æ ¼æ–—ç³»å’Œæ¯’ç³»æå·¨æ‹›å¼å¨åŠ›ç¨ä½ï¼ˆå› ä¸ºæœ‰åŠ æ”»/åŠ ç‰¹æ”»ç‰¹æ•ˆï¼‰
    if (moveType === 'Fighting' || moveType === 'Poison') {
        if (basePower >= 150) return 100;
        if (basePower >= 110) return 95;
        if (basePower >= 75) return 90;
        if (basePower >= 65) return 85;
        if (basePower >= 55) return 80;
        if (basePower >= 45) return 75;
        return 70;
    }
    // é€šç”¨å¨åŠ›è®¡ç®—
    if (basePower >= 150) return 150;
    if (basePower >= 110) return 140;
    if (basePower >= 75) return 130;
    if (basePower >= 65) return 120;
    if (basePower >= 55) return 110;
    if (basePower >= 45) return 100;
    return 90;
}
/**
 * è·å–å®å¯æ¢¦çš„åŸºç¡€ç‰©ç§ IDï¼ˆç”¨äº G-Max æŸ¥è¡¨ï¼‰
 * @param {Object} pokemon - å®å¯æ¢¦å¯¹è±¡
 * @returns {string} åŸºç¡€ç‰©ç§ ID
 */
function getBaseSpeciesId(pokemon) {
    const pokeName = pokemon.name || '';
    // ç§»é™¤ gmax/mega/gigantamax åç¼€ï¼Œä½†ä¿ç•™å½¢æ€åç¼€å¦‚ lowkey/rapidstrike
    let speciesId = pokeName.toLowerCase().replace(/[^a-z0-9]/g, '');
    speciesId = speciesId.replace(/(gmax|mega|gigantamax)$/g, '');
    return speciesId;
}
/**
 * æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦æœ‰è¶…æå·¨åŒ–å› å­
 * @param {Object} pokemon - å®å¯æ¢¦å¯¹è±¡
 * @returns {Object|null} G-Max æ•°æ® { move, type, cn } æˆ– null
 */
function getGMaxFactor(pokemon) {
    // å¦‚æœæ˜¾å¼æ ‡è®°ä¸ºé€šç”¨æå·¨åŒ–ï¼Œåˆ™è·³è¿‡
    if (pokemon.isGenericDynamax) return null;
    // ä¼˜å…ˆä½¿ç”¨ GMAX_SPECIES_DATAï¼ˆæ¥è‡ª move-constants.jsï¼‰
    const gmaxTable = typeof GMAX_SPECIES_DATA !== 'undefined' ? GMAX_SPECIES_DATA : 
                      (typeof window !== 'undefined' && window.GMAX_SPECIES_DATA) ? window.GMAX_SPECIES_DATA : null;
    if (!gmaxTable) return null;
    const speciesId = getBaseSpeciesId(pokemon);
    return gmaxTable[speciesId] || null;
}
/**
 * è·å–æ‹›å¼å¯¹åº”çš„æå·¨åŒ–æ‹›å¼åç§°
 * @param {Object} baseMoveObj - åŸå§‹æ‹›å¼å¯¹è±¡
 * @param {Object} pokemon - å®å¯æ¢¦å¯¹è±¡
 * @returns {Object|null} Max æ‹›å¼ä¿¡æ¯ { name, type, power, isGMax, cn } æˆ– null
 */
function getMaxMoveTarget(baseMoveObj, pokemon) {
    // å˜åŒ–æŠ€å˜æˆ Max Guard
    if (baseMoveObj.category === 'Status' || baseMoveObj.cat === 'status') {
        const cnTable = typeof GENERIC_MAX_CN !== 'undefined' ? GENERIC_MAX_CN :
                        (typeof window !== 'undefined' && window.GENERIC_MAX_CN) ? window.GENERIC_MAX_CN : {};
        return {
            name: 'Max Guard',
            type: 'Normal',
            power: 0,
            isGMax: false,
            cn: cnTable['Max Guard'] || 'æå·¨é˜²å£'
        };
    }
    const moveType = baseMoveObj.type || 'Normal';
    const basePower = baseMoveObj.basePower || baseMoveObj.power || 60;
    // === æ ¸å¿ƒä¿®æ”¹ï¼šä¼˜å…ˆæŸ¥é˜… GMAX_SPECIES_DATA è¡¨ ===
    const gmaxFactor = getGMaxFactor(pokemon);
    if (gmaxFactor && gmaxFactor.type === moveType) {
        // è¯¥ç‰©ç§åœ¨è¡¨é‡Œï¼Œä¸”å½“å‰æ‹›å¼å±æ€§åŒ¹é…ä¸“å±å±æ€§
        // G-Max æ‹›å¼å¨åŠ›é€šå¸¸è¾ƒé«˜ï¼Œå– max(è®¡ç®—å¨åŠ›, 130)
        const maxPower = Math.max(calculateMaxMovePower(basePower, moveType), 130);
        return {
            name: gmaxFactor.move,
            type: moveType,
            power: maxPower,
            isGMax: true,
            cn: gmaxFactor.cn
        };
    }
    // å¤‡ç”¨ï¼šæ£€æŸ¥ GMAX_MOVE_MAPï¼ˆä» moves-data.js åŠ¨æ€æ„å»ºçš„ï¼‰
    const speciesId = getBaseSpeciesId(pokemon);
    if (GMAX_MOVE_MAP[speciesId] && !pokemon.isGenericDynamax) {
        const gmaxData = GMAX_MOVE_MAP[speciesId];
        if (gmaxData.type === moveType) {
            return {
                name: gmaxData.name,
                type: gmaxData.type,
                power: gmaxData.basePower || 130,
                isGMax: true,
                cn: gmaxData.cn || gmaxData.name
            };
        }
    }
    // é€šç”¨ Max æ‹›å¼ (ä» move-constants.js è·å–)
    const maxByType = typeof window !== 'undefined' && window.GENERIC_MAX_BY_TYPE ? window.GENERIC_MAX_BY_TYPE : {};
    const genericMaxName = maxByType[moveType];
    if (genericMaxName) {
        const maxPower = calculateMaxMovePower(basePower, moveType);
        const cnTable = typeof GENERIC_MAX_CN !== 'undefined' ? GENERIC_MAX_CN :
                        (typeof window !== 'undefined' && window.GENERIC_MAX_CN) ? window.GENERIC_MAX_CN : {};
        return {
            name: genericMaxName,
            type: moveType,
            power: maxPower,
            isGMax: false,
            cn: cnTable[genericMaxName] || genericMaxName
        };
    }
    return null;
}
// ============================================
// æå·¨åŒ–çŠ¶æ€ç®¡ç†å‡½æ•°
// ============================================
/**
 * åº”ç”¨æå·¨åŒ–çŠ¶æ€å˜æ¢ï¼ˆæ‹›å¼æ›¿æ¢/å›é€€ï¼‰
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @param {boolean} isActive true=å¼€å¯æå·¨åŒ–, false=å…³é—­æå·¨åŒ–
 */
function applyDynamaxState(pokemon, isActive) {
    if (!pokemon) return;
    // === æ— ææ±°é‚£ (Eternatus) ç‰¹åˆ¤ ===
    // æ— ææ±°é‚£çš„"æå·¨åŒ–"æ˜¯å‰§æƒ…å˜èº«ï¼Œæ‹›å¼ä¿æŒåŸæ ·ï¼ˆä¸éµå¾ª Max Move è§„åˆ™ï¼‰
    const pokeName = (pokemon.name || '').toLowerCase();
    if (pokeName.includes('eternatus')) {
        console.log(`[DYNAMAX] Eternatus detected - Skipping Move Transformation (Boss Logic)`);
        // æ— ææ±°é‚£åªåšè§†è§‰å˜åŒ–ï¼Œä¸æ”¹æ‹›å¼
        if (isActive) {
            pokemon.isEternamax = true;
        } else {
            pokemon.isEternamax = false;
        }
        return;
    }
    if (isActive) {
        // [ON] å¼€å¯æå·¨åŒ–
        console.log(`[DYNAMAX] ${pokemon.name} æ‹›å¼è½¬æ¢ä¸ºæå·¨æ‹›å¼`);
        // === ã€Ambrosia æ—¶ç©ºé†‰ã€‘æ ‡è®°ä¸‹å›åˆæ··ä¹± ===
        if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.checkNeuroBacklash) {
            const currentWeather = window.battle?.weather || '';
            const trainer = window.battle?.isPlayerTurn ? null : window.battle?.enemyTrainer;
            const neuroResult = window.WeatherEffects.checkNeuroBacklash(currentWeather, 'dynamax', pokemon, trainer);
            if (neuroResult.shouldTrigger) {
                pokemon.volatile = pokemon.volatile || {};
                pokemon.volatile.neuroBacklash = true;
                console.log(`[AMBROSIA] âš¡ æ—¶ç©ºé†‰ï¼š${pokemon.name} è¢«æ ‡è®°ï¼Œä¸‹å›åˆå°†æ··ä¹±`);
            }
        }
        // === æ£€æµ‹æ˜¯å¦æœ‰è¶…æå·¨åŒ–å› å­ ===
        const gmaxFactor = getGMaxFactor(pokemon);
        if (gmaxFactor) {
            pokemon.hasGMaxFactor = true;
            console.log(`[DYNAMAX] ${pokemon.name} æ£€æµ‹åˆ°è¶…æå·¨åŒ–å› å­: ${gmaxFactor.move} (${gmaxFactor.type})`);
            // è‡ªåŠ¨è®¾ç½® G-Max ç²¾çµå›¾ URL
            const speciesId = (pokemon.name || '').toLowerCase().replace(/[^a-z0-9]/g, '').replace(/(gmax|mega|gigantamax)$/g, '');
            pokemon.gmaxSpriteUrl = `https://play.pokemonshowdown.com/sprites/ani/${speciesId}-gmax.gif`;
            console.log(`[DYNAMAX] G-Max ç²¾çµå›¾ URL: ${pokemon.gmaxSpriteUrl}`);
        } else {
            pokemon.hasGMaxFactor = false;
            pokemon.gmaxSpriteUrl = null;
        }
        // === æ’­æ”¾æå·¨åŒ–å«å£° ===
        if (typeof window.playPokemonCry === 'function') {
            window.playPokemonCry(pokemon.name);
        }
        // 1. å¤‡ä»½åŸå§‹æŠ€èƒ½ (éå¸¸é‡è¦ï¼ä¸ºäº†å›é€€)
        pokemon._originalMoves = JSON.parse(JSON.stringify(pokemon.moves));
        // 2. ä½¿ç”¨è‡ªåŠ¨æ¨å¯¼ç³»ç»Ÿç”Ÿæˆæå·¨æ‹›å¼
        pokemon.moves = pokemon._originalMoves.map(m => {
            const maxTarget = getMaxMoveTarget(m, pokemon);
            if (!maxTarget) {
                // æ— æ³•æ¨å¯¼ï¼Œä¿æŒåŸæ ·
                return { ...m, isMax: true };
            }
            const maxMoveId = maxTarget.name.toLowerCase().replace(/[^a-z0-9]/g, '');
            const MOVES = typeof window !== 'undefined' ? window.MOVES : null;
            const maxMoveData = (MOVES && MOVES[maxMoveId]) ? MOVES[maxMoveId] : {};
            const inheritedCat = m.cat || (maxMoveData.category === 'Physical' ? 'phys' : 'spec');
            return {
                name: maxTarget.name,
                cn: maxTarget.cn || maxMoveData.cn || maxTarget.name,
                type: maxTarget.type,
                power: maxTarget.power,
                basePower: maxTarget.power,
                accuracy: 100,
                pp: 5,
                cat: inheritedCat,
                category: maxMoveData.category || (inheritedCat === 'phys' ? 'Physical' : 'Special'),
                isMax: true,
                isGMax: maxTarget.isGMax
            };
        });
        console.log(`[DYNAMAX] è‡ªåŠ¨æ¨å¯¼æå·¨æ‹›å¼:`, pokemon.moves.map(m => `${m.name}(${m.type}, pow:${m.power}, gmax:${m.isGMax})`));
    } else {
        // [OFF] å…³é—­æå·¨åŒ–
        console.log(`[DYNAMAX] ${pokemon.name} æ‹›å¼æ¢å¤ä¸ºæ™®é€šæ‹›å¼`);
        // æ¸…ç† G-Max ç›¸å…³çŠ¶æ€
        pokemon.hasGMaxFactor = false;
        pokemon.gmaxSpriteUrl = null;
        // è¿˜åŸæŠ€èƒ½
        if (pokemon._originalMoves) {
            pokemon.moves = pokemon._originalMoves;
            delete pokemon._originalMoves;
            console.log(`[DYNAMAX] æ‹›å¼å·²æ¢å¤:`, pokemon.moves.map(m => m.name));
        }
    }
}
/**
 * åº”ç”¨æå·¨åŒ– HP å˜åŒ–
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @param {boolean} isActive true=å¼€å¯æå·¨åŒ–, false=å…³é—­æå·¨åŒ–
 * @param {number} multiplier HP å€ç‡ï¼ˆé»˜è®¤ 2ï¼‰
 */
function applyDynamaxHP(pokemon, isActive, multiplier = 2) {
    if (!pokemon) return;
    // === æ— ææ±°é‚£ (Eternatus) æ— æå·¨åŒ–ç‰¹æ®Šå¤„ç† ===
    // æ— æå·¨åŒ–ä¸ä»…æ”¹ HPï¼Œè¿˜æ”¹å…¨å±æ€§ï¼ˆBOSS æ¨¡å¼ï¼‰
    if (pokemon.isEternamax) {
        if (isActive) {
            // å¤‡ä»½åŸå§‹å±æ€§
            pokemon._originalStats = {
                maxHp: pokemon.maxHp,
                currHp: pokemon.currHp,
                atk: pokemon.atk,
                def: pokemon.def,
                spa: pokemon.spa,
                spd: pokemon.spd,
                spe: pokemon.spe
            };
            // æ— æå·¨åŒ–ç§æ—å€¼å˜åŒ–ï¼ˆå®˜æ–¹æ•°æ®ï¼‰
            // HP: 140 -> 255 (çº¦ 1.82x)
            // Atk: 85 -> 115 (çº¦ 1.35x)
            // Def: 95 -> 250 (çº¦ 2.63x)
            // SpA: 145 -> 125 (ä¸‹é™)
            // SpD: 95 -> 250 (çº¦ 2.63x)
            // Spe: 130 -> 130 (ä¸å˜)
            const hpRatio = pokemon.currHp / pokemon.maxHp;
            pokemon.maxHp = Math.floor(pokemon.maxHp * 1.82);
            pokemon.currHp = Math.floor(pokemon.maxHp * hpRatio);
            pokemon.atk = Math.floor(pokemon.atk * 1.35);
            pokemon.def = Math.floor(pokemon.def * 2.63);
            pokemon.spa = Math.floor(pokemon.spa * 0.86); // ç‰¹æ”»ä¸‹é™
            pokemon.spd = Math.floor(pokemon.spd * 2.63);
            // é€Ÿåº¦ä¸å˜
            console.log(`[ETERNAMAX] Boss Mode Activated! Def/SpD Skyrocketed!`);
            console.log(`[ETERNAMAX] HP: ${pokemon._originalStats.currHp}/${pokemon._originalStats.maxHp} -> ${pokemon.currHp}/${pokemon.maxHp}`);
            console.log(`[ETERNAMAX] Def: ${pokemon._originalStats.def} -> ${pokemon.def}, SpD: ${pokemon._originalStats.spd} -> ${pokemon.spd}`);
        } else {
            // è¿˜åŸåŸå§‹å±æ€§
            if (pokemon._originalStats) {
                const hpRatio = pokemon.currHp / pokemon.maxHp;
                pokemon.maxHp = pokemon._originalStats.maxHp;
                pokemon.currHp = Math.max(1, Math.floor(pokemon.maxHp * hpRatio));
                pokemon.atk = pokemon._originalStats.atk;
                pokemon.def = pokemon._originalStats.def;
                pokemon.spa = pokemon._originalStats.spa;
                pokemon.spd = pokemon._originalStats.spd;
                pokemon.spe = pokemon._originalStats.spe;
                delete pokemon._originalStats;
                console.log(`[ETERNAMAX] Boss Mode Deactivated, stats restored`);
            }
        }
        return; // è·³è¿‡å¸¸è§„å¤„ç†
    }
    // === å¸¸è§„æå·¨åŒ– HP å¤„ç† ===
    if (isActive) {
        // å¤‡ä»½åŸå§‹ HP
        pokemon._originalMaxHp = pokemon.maxHp;
        pokemon._originalCurrHp = pokemon.currHp;
        // HP ç¿»å€
        const hpRatio = pokemon.currHp / pokemon.maxHp;
        pokemon.maxHp = Math.floor(pokemon.maxHp * multiplier);
        pokemon.currHp = Math.floor(pokemon.maxHp * hpRatio);
        console.log(`[DYNAMAX] ${pokemon.name} HP: ${pokemon._originalCurrHp}/${pokemon._originalMaxHp} -> ${pokemon.currHp}/${pokemon.maxHp}`);
    } else {
        // æ¢å¤åŸå§‹ HP
        if (pokemon._originalMaxHp) {
            const hpRatio = pokemon.currHp / pokemon.maxHp;
            pokemon.maxHp = pokemon._originalMaxHp;
            pokemon.currHp = Math.max(1, Math.floor(pokemon.maxHp * hpRatio));
            delete pokemon._originalMaxHp;
            delete pokemon._originalCurrHp;
            console.log(`[DYNAMAX] ${pokemon.name} HP æ¢å¤: ${pokemon.currHp}/${pokemon.maxHp}`);
        }
    }
}
/**
 * å®Œæ•´çš„æå·¨åŒ–åˆ‡æ¢ï¼ˆæ‹›å¼ + HPï¼‰
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @param {boolean} isActive true=å¼€å¯æå·¨åŒ–, false=å…³é—­æå·¨åŒ–
 */
function toggleDynamax(pokemon, isActive) {
    if (!pokemon) return;
    applyDynamaxState(pokemon, isActive);
    applyDynamaxHP(pokemon, isActive);
    pokemon.isDynamaxed = isActive;
    if (isActive) {
        pokemon.dynamaxTurns = 3; // æå·¨åŒ–æŒç»­ 3 å›åˆ
    } else {
        pokemon.dynamaxTurns = 0;
    }
}
/**
 * æ¿€æ´»æå·¨åŒ–ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @param {Object} options é€‰é¡¹ { isEnemy: boolean, justSwitchedIn: boolean }
 * @returns {Object} { success: boolean, hpMultiplier: number }
 */
function activateDynamax(pokemon, options = {}) {
    if (!pokemon) return { success: false };
    const hpMultiplier = 1.5;
    const oldMaxHp = pokemon.maxHp;
    const oldCurrHp = pokemon.currHp;
    // HP å€ç‡
    pokemon.maxHp = Math.floor(oldMaxHp * hpMultiplier);
    pokemon.currHp = Math.floor(oldCurrHp * hpMultiplier);
    // è®¾ç½®æå·¨åŒ–çŠ¶æ€
    pokemon.isDynamaxed = true;
    pokemon.dynamaxTurns = 3;
    pokemon.preDynamaxMaxHp = oldMaxHp;
    pokemon.preDynamaxCurrHp = oldCurrHp;
    // å¦‚æœæ˜¯æ¢å…¥æ—¶æå·¨åŒ–ï¼Œæ ‡è®°è·³è¿‡ç¬¬ä¸€æ¬¡ tick
    if (options.justSwitchedIn) {
        pokemon.dynamaxJustActivated = true;
    }
    // æ‹›å¼è½¬æ¢ä¸ºæå·¨æ‹›å¼
    applyDynamaxState(pokemon, true);
    console.log(`[DYNAMAX] ${pokemon.name} æ¿€æ´»æå·¨åŒ–: HP ${oldCurrHp}/${oldMaxHp} -> ${pokemon.currHp}/${pokemon.maxHp}`);
    return { success: true, hpMultiplier, oldMaxHp, oldCurrHp };
}
/**
 * å‡å°‘æå·¨åŒ–å›åˆæ•°
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @returns {boolean} æ˜¯å¦åº”è¯¥ç»“æŸæå·¨åŒ–
 */
function tickDynamaxTurn(pokemon) {
    if (!pokemon || !pokemon.isDynamaxed) return false;
    pokemon.dynamaxTurns = (pokemon.dynamaxTurns || 0) - 1;
    if (pokemon.dynamaxTurns <= 0) {
        console.log(`[DYNAMAX] ${pokemon.name} æå·¨åŒ–ç»“æŸ`);
        return true;
    }
    console.log(`[DYNAMAX] ${pokemon.name} æå·¨åŒ–å‰©ä½™ ${pokemon.dynamaxTurns} å›åˆ`);
    return false;
}
/**
 * å¤„ç†æå·¨åŒ–å›åˆç»“æŸï¼ˆç»Ÿä¸€å…¥å£ï¼‰
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @param {boolean} isPlayer æ˜¯å¦ä¸ºç©å®¶æ–¹
 * @param {Function} logFn æ—¥å¿—å‡½æ•°
 * @returns {Object} { ended: boolean, logs: string[] }
 */
async function processDynamaxEndTurn(pokemon, isPlayer, logFn) {
    const logs = [];
    const log = logFn || console.log;
    if (!pokemon || !pokemon.isAlive() || !pokemon.isDynamaxed || pokemon.dynamaxTurns <= 0) {
        return { ended: false, logs };
    }
    // ã€ä¿®å¤ã€‘å¦‚æœæ˜¯æœ¬å›åˆåˆšæå·¨åŒ–çš„ï¼Œè·³è¿‡è¿™æ¬¡ tick
    if (pokemon.dynamaxJustActivated) {
        delete pokemon.dynamaxJustActivated;
        console.log(`[DYNAMAX] ${isPlayer ? 'ç©å®¶' : 'æ•Œæ–¹'}æœ¬å›åˆåˆšæå·¨åŒ–ï¼Œè·³è¿‡ tick`);
        return { ended: false, logs, skipped: true };
    }
    // å‡å°‘å›åˆæ•°
    pokemon.dynamaxTurns--;
    if (pokemon.dynamaxTurns === 0) {
        // æå·¨åŒ–ç»“æŸ
        const prefix = isPlayer ? '' : 'æ•Œæ–¹çš„ ';
        logs.push(`<b style="color:#94a3b8">âš¡ ${prefix}æå·¨åŒ–èƒ½é‡è€—å°½äº†...</b>`);
        // æ‹›å¼æ¢å¤ä¸ºæ™®é€šæ‹›å¼
        applyDynamaxState(pokemon, false);
        // æ¢å¤åŸå§‹åç§°å’Œä¸­æ–‡å
        if (pokemon.originalName) {
            pokemon.name = pokemon.originalName;
            if (typeof window !== 'undefined' && window.Locale) {
                pokemon.cnName = window.Locale.get(pokemon.originalName);
            } else {
                pokemon.cnName = pokemon.originalName;
            }
            delete pokemon.originalName;
        }
        logs.push(`${prefix}${pokemon.cnName} å˜å›äº†åŸæ¥çš„æ ·å­ã€‚`);
        // æ¢å¤ HP
        const hpRatio = pokemon.currHp / pokemon.maxHp;
        pokemon.maxHp = pokemon.preDynamaxMaxHp || Math.floor(pokemon.maxHp / 1.5);
        pokemon.currHp = Math.max(1, Math.floor(pokemon.maxHp * hpRatio));
        pokemon.isDynamaxed = false;
        delete pokemon.preDynamaxMaxHp;
        delete pokemon.preDynamaxCurrHp;
        return { ended: true, logs };
    } else {
        // è¿˜æœ‰å‰©ä½™å›åˆ
        const prefix = isPlayer ? '' : 'æ•Œæ–¹';
        logs.push(`<span style="color:#ff6b8a">[${prefix}æå·¨åŒ–å‰©ä½™å›åˆ: ${pokemon.dynamaxTurns}]</span>`);
        return { ended: false, logs };
    }
}
// ============================================
// å¯¼å‡º
// ============================================
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    // æå·¨æ‹›å¼æ¨å¯¼å‡½æ•°
    window.GMAX_MOVE_MAP = GMAX_MOVE_MAP;
    window.calculateMaxMovePower = calculateMaxMovePower;
    window.getBaseSpeciesId = getBaseSpeciesId;
    window.getGMaxFactor = getGMaxFactor;
    window.getMaxMoveTarget = getMaxMoveTarget;
    // æå·¨åŒ–çŠ¶æ€ç®¡ç†å‡½æ•°
    window.applyDynamaxState = applyDynamaxState;
    window.applyDynamaxHP = applyDynamaxHP;
    window.toggleDynamax = toggleDynamax;
    window.activateDynamax = activateDynamax;
    window.tickDynamaxTurn = tickDynamaxTurn;
    window.processDynamaxEndTurn = processDynamaxEndTurn;
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        // æå·¨æ‹›å¼æ¨å¯¼
        GMAX_MOVE_MAP,
        calculateMaxMovePower,
        getBaseSpeciesId,
        getGMaxFactor,
        getMaxMoveTarget,
        // æå·¨åŒ–çŠ¶æ€ç®¡ç†
        applyDynamaxState,
        applyDynamaxHP,
        toggleDynamax,
        tickDynamaxTurn
    };
}
]]></file>
        <file name="mechanic-checker.js"><![CDATA[/**
 * ===========================================
 * MECHANIC-CHECKER.JS - æœºåˆ¶äº’æ–¥æ£€æŸ¥ç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦å¯ä»¥æ¿€æ´»æŒ‡å®šæœºåˆ¶
 * - æœºåˆ¶äº’æ–¥é€»è¾‘ (Mega/Dynamax/Z-Move/Tera)
 * - é“å…·å†²çªæ£€æŸ¥
 */
// ============================================
// æ ¸å¿ƒå‡½æ•°
// ============================================
/**
 * æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦å¯ä»¥æ¿€æ´»æŒ‡å®šæœºåˆ¶
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @param {string} mechanicType æœºåˆ¶ç±»å‹: 'mega' | 'dynamax' | 'zmove' | 'tera'
 * @returns {boolean} æ˜¯å¦å¯ä»¥æ¿€æ´»
 */
function canActivateMechanic(pokemon, mechanicType) {
    if (!pokemon) return false;
    // 1. å¦‚æœå¤„äºä»»ä½•ä¸€ç§ "Super State"ï¼Œåˆ™ç¦æ­¢å¼€å¯å¦ä¸€ç§
    const inBeastMode = pokemon.isMega || 
                        pokemon.isDynamaxed || 
                        pokemon.hasBondResonance ||
                        pokemon.isTera;
    if (inBeastMode) {
        console.log(`[MECHANIC] ${pokemon.name} å·²å¤„äºç‰¹æ®ŠçŠ¶æ€ï¼Œæ— æ³•æ¿€æ´» ${mechanicType}`);
        return false;
    }
    // 2. æ£€æŸ¥ JSON é…ç½®çš„ç³»ç»Ÿé”
    // å¦‚æœ JSON é‡Œ explicitly è®¾ç½®äº† mechanic: "dynamax"ï¼Œé‚£ä¹ˆå®ƒå°±ä¸èƒ½ Mega
    if (pokemon.mechanic && pokemon.mechanic !== mechanicType) {
        console.log(`[MECHANIC] ${pokemon.name} è¢«é”å®šä¸º ${pokemon.mechanic}ï¼Œæ— æ³•æ¿€æ´» ${mechanicType}`);
        return false;
    }
    // 3. é“å…·å†²çªæ£€æŸ¥
    // Mega çŸ³å’Œ Z çº¯æ™¶äº’æ–¥
    const item = (pokemon.item || '').toLowerCase();
    if (mechanicType === 'zmove' && item.includes('ite') && !item.includes('ium')) {
        // æºå¸¦ Mega çŸ³ï¼ˆå¦‚ Lucarioniteï¼‰æ— æ³•ä½¿ç”¨ Z æ‹›å¼
        console.log(`[MECHANIC] ${pokemon.name} æºå¸¦ Mega çŸ³ï¼Œæ— æ³•ä½¿ç”¨ Z æ‹›å¼`);
        return false;
    }
    if (mechanicType === 'mega' && item.includes('ium z')) {
        // æºå¸¦ Z çº¯æ™¶æ— æ³• Mega
        console.log(`[MECHANIC] ${pokemon.name} æºå¸¦ Z çº¯æ™¶ï¼Œæ— æ³• Mega è¿›åŒ–`);
        return false;
    }
    return true;
}
/**
 * æ£€æŸ¥æ˜¯å¦å¤„äºä»»ä½•ç‰¹æ®ŠçŠ¶æ€
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @returns {boolean} æ˜¯å¦å¤„äºç‰¹æ®ŠçŠ¶æ€
 */
function isInSuperState(pokemon) {
    if (!pokemon) return false;
    return pokemon.isMega || 
           pokemon.isDynamaxed || 
           pokemon.hasBondResonance ||
           pokemon.isTera;
}
/**
 * è·å–å½“å‰æ¿€æ´»çš„æœºåˆ¶ç±»å‹
 * @param {Pokemon} pokemon å®å¯æ¢¦å¯¹è±¡
 * @returns {string|null} 'mega' | 'dynamax' | 'bond' | 'tera' | null
 */
function getActiveMechanic(pokemon) {
    if (!pokemon) return null;
    if (pokemon.isMega) return 'mega';
    if (pokemon.isDynamaxed) return 'dynamax';
    if (pokemon.hasBondResonance) return 'bond';
    if (pokemon.isTera) return 'tera';
    return null;
}
/**
 * æ£€æŸ¥é“å…·æ˜¯å¦ä¸º Mega çŸ³
 * @param {string} itemName é“å…·åç§°
 * @returns {boolean}
 */
function isMegaStoneItem(itemName) {
    if (!itemName) return false;
    const item = itemName.toLowerCase();
    // Mega çŸ³ä»¥ 'ite' ç»“å°¾ï¼Œä½†ä¸æ˜¯ 'eviolite'
    return item.endsWith('ite') && item !== 'eviolite';
}
/**
 * æ£€æŸ¥é“å…·æ˜¯å¦ä¸º Z çº¯æ™¶
 * @param {string} itemName é“å…·åç§°
 * @returns {boolean}
 */
function isZCrystalItem(itemName) {
    if (!itemName) return false;
    const item = itemName.toLowerCase();
    return item.endsWith('iumz') || item.endsWith('iniumz') || item.includes('ium z');
}
// ============================================
// å¯¼å‡º
// ============================================
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    window.canActivateMechanic = canActivateMechanic;
    window.isInSuperState = isInSuperState;
    window.getActiveMechanic = getActiveMechanic;
    window.isMegaStoneItem = isMegaStoneItem;
    window.isZCrystalItem = isZCrystalItem;
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        canActivateMechanic,
        isInSuperState,
        getActiveMechanic,
        isMegaStoneItem,
        isZCrystalItem
    };
}
]]></file>
        <file name="mega-evolution.js"><![CDATA[/**
 * =============================================
 * MEGA EVOLUTION SYSTEM
 * =============================================
 * 
 * ä» battle-engine.js è¿ç§»çš„ Mega è¿›åŒ–æ ¸å¿ƒé€»è¾‘
 * 
 * èŒè´£:
 * - å½¢æ€å˜åŒ–èµ„æ ¼æ£€æµ‹ (Mega/Ultra/Primal/Dynamax/Crowned)
 * - Mega è¿›åŒ–æ‰§è¡Œ
 * - éå®˜æ–¹ Mega æ£€æµ‹
 * 
 * ä¾èµ–: pokedex-data.js, battle-engine.js (Pokemon, calcStats, getPokemonData)
 */
/* ==========================================================
 *  æ™ºèƒ½å½¢æ€æ¢æµ‹å™¨ v3 : Zero-Config, Database-Driven
 *  åŸºäº mechanic å­—æ®µå’Œæ•°æ®åº“è‡ªåŠ¨æ£€æµ‹å¯ç”¨å½¢æ€
 * ========================================================== */ 
/**
 * è‡ªåŠ¨æ£€æµ‹å®å¯æ¢¦çš„å½¢æ€å˜åŒ–èµ„æ ¼ï¼ˆMega/Ultra/Primal/Dynamax ç­‰ï¼‰
 * 
 * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
 * @param {string|null} explicitFormFlag - JSON ä¸­æ˜¾å¼æŒ‡å®šçš„å½¢æ€ ('x', 'y', 'primal', 'ultra', 'crowned', 'machampgmax' ç­‰)
 */
function autoDetectFormChangeEligibility(pokemon, explicitFormFlag = null) {
    // ä½¿ç”¨è§„èŒƒåŒ–åç§°æŸ¥æ‰¾ POKEDEX
    const normalizedName = typeof normalizePokemonName === 'function' 
        ? normalizePokemonName(pokemon.name) 
        : pokemon.name;
    const baseId = normalizedName.toLowerCase().replace(/[^a-z0-9]/g, '');
    const data = typeof POKEDEX !== 'undefined' ? POKEDEX[baseId] : null;
    // è·å–ç©å®¶åœ¨ JSON é…ç½®é‡ŒæŒ‡å®šçš„"æ„æ„¿" (Mechanic Lock)
    const desiredMechanic = pokemon.mechanic || 'any'; // 'mega', 'dynamax', 'zmove', 'any'(Auto)
    console.log(`[FORM] Auto-Scan for ${pokemon.name} (baseId: ${baseId}), mechanic: ${desiredMechanic}, hasData: ${!!data}`);
    // ========================================
    // æ­¥éª¤ 1ï¼šæ‰«ææ•°æ®åº“çš„æ‰€æœ‰å½¢æ€æ ‘
    // ========================================
    let avail = {
        mega: [],
        gmax: [],
        primal: null,
        ultra: null,
        crowned: null
    };
    // ä» otherFormes æ”¶é›†
    if (data && data.otherFormes) {
        for (const formeName of data.otherFormes) {
            const formeId = formeName.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (formeId.includes('gmax') || formeId.includes('gigantamax')) {
                avail.gmax.push(formeId);
            } else if (formeName.includes('Mega') && formeId.match(/mega[xy]?$/)) {
                avail.mega.push(formeId);
            } else if (formeName.includes('Primal')) {
                avail.primal = formeId;
            } else if (formeName.includes('Ultra')) {
                avail.ultra = formeId;
            } else if (formeName.includes('Crowned')) {
                avail.crowned = formeId;
            }
        }
    }
    // æ¿€è¿›æ¢æµ‹ï¼šå°è¯•æ‹¼æ¥ IDï¼ˆæ•°æ®åº“å¯èƒ½æ²¡æœ‰ otherFormes ä½†æœ‰å®é™…æ•°æ®ï¼‰
    const guessedGmaxId = baseId + 'gmax';
    const guessedMegaId = baseId + 'mega';
    if (avail.gmax.length === 0 && typeof POKEDEX !== 'undefined' && POKEDEX[guessedGmaxId]) {
        avail.gmax.push(guessedGmaxId);
    }
    if (avail.mega.length === 0 && typeof POKEDEX !== 'undefined' && POKEDEX[guessedMegaId]) {
        avail.mega.push(guessedMegaId);
    }
    // åŒ Mega ç™½åå•
    const KNOWN_DUAL_MEGAS = ['charizard', 'mewtwo'];
    const hasDualMega = (avail.mega.length >= 2) && KNOWN_DUAL_MEGAS.includes(baseId);
    console.log(`[FORM] Available forms:`, avail);
    // ========================================
    // æ­¥éª¤ 2ï¼šåŸå§‹å›å½’ / Crowned - ç«‹å³å›ºåŒ–
    // ========================================
    if (avail.primal && typeof POKEDEX !== 'undefined' && POKEDEX[avail.primal]) {
        pokemon.isPrimal = true;
        pokemon.primalTargetId = avail.primal;
        pokemon.needsInitTransform = true;
        pokemon.initTransformTarget = avail.primal;
        pokemon.initTransformType = 'primal';
    }
    if (avail.crowned && typeof POKEDEX !== 'undefined' && POKEDEX[avail.crowned]) {
        pokemon.isCrowned = true;
        pokemon.crownedTargetId = avail.crowned;
        pokemon.needsInitTransform = true;
        pokemon.initTransformTarget = avail.crowned;
        pokemon.initTransformType = 'crowned';
    }
    // ===================================
    //  å†³ç­–åŒº: æ ¹æ® mechanic å†³å®š Target
    // ===================================
    // ğŸ‘‰ åœºæ™¯ A: æ˜ç¡®æƒ³è¦æå·¨åŒ– (mechanic='dynamax')
    if (desiredMechanic === 'dynamax') {
        // ã€ä¿®å¤ã€‘ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·åœ¨ JSON ä¸­æ˜¾å¼æŒ‡å®šçš„ mega/mega_target å­—æ®µ
        if (pokemon.megaTargetId && pokemon.megaTargetId.includes('gmax')) {
            // ç”¨æˆ·å·²ç»æŒ‡å®šäº† G-Max å½¢æ€ï¼Œç›´æ¥ä½¿ç”¨
            pokemon.canMegaEvolve = true;
            pokemon.canDynamax = true;
            pokemon.evolutionType = 'dynamax';
            console.log(`[FORM] Using explicit G-Max target: ${pokemon.megaTargetId}`);
        } else if (avail.gmax.length > 0) {
            // æ‰¾åˆ°æ­£ç‰ˆ Gmax æ•°æ®
            pokemon.megaTargetId = avail.gmax[0];
            pokemon.canMegaEvolve = true;
            pokemon.canDynamax = true;
            pokemon.evolutionType = 'dynamax';
            console.log(`[FORM] Locked Dynamax target: ${pokemon.megaTargetId}`);
        } else {
            // æ²¡æœ‰ GMax æ•°æ®ï¼Œèµ°é€šç”¨æå·¨åŒ– (Non-GMax Dynamax)
            pokemon.megaTargetId = guessedGmaxId; // è™šæ‹Ÿ IDï¼Œä¾›å›¾ç‰‡åŠ è½½å°è¯•
            pokemon.canMegaEvolve = true;
            pokemon.canDynamax = true;
            pokemon.evolutionType = 'dynamax';
            pokemon.isGenericDynamax = true; // æ ‡è®°ä¸ºé€šç”¨æå·¨åŒ–
            console.log(`[FORM] Generic Dynamax (No G-Form in DB) target: ${pokemon.megaTargetId}`);
        }
        return;
    }
    // ğŸ‘‰ åœºæ™¯ B: æ˜ç¡®æƒ³è¦ Mega (mechanic='mega')
    if (desiredMechanic === 'mega') {
        if (avail.mega.length > 0) {
            const validMegaForms = avail.mega.filter(f => typeof POKEDEX !== 'undefined' && POKEDEX[f]);
            if (validMegaForms.length > 0) {
                if (hasDualMega && validMegaForms.length >= 2) {
                    pokemon.hasDualMega = true;
                    pokemon.megaFormsAvailable = validMegaForms;
                    // ã€ä¿®å¤ã€‘ä¼˜å…ˆä½¿ç”¨ JSON ä¸­æŒ‡å®šçš„ mega_targetï¼Œå¦åˆ™é»˜è®¤ X å½¢æ€
                    const specifiedTarget = pokemon.mega_target || pokemon.megaTarget;
                    if (specifiedTarget && validMegaForms.includes(specifiedTarget)) {
                        pokemon.megaTargetId = specifiedTarget;
                    } else {
                        pokemon.megaTargetId = validMegaForms.find(f => f.endsWith('x')) || validMegaForms[0];
                    }
                } else {
                    pokemon.megaTargetId = validMegaForms[0];
                }
                pokemon.canMegaEvolve = true;
                pokemon.evolutionType = 'mega';
                console.log(`[FORM] Locked Mega target: ${pokemon.megaTargetId}`);
                return;
            }
        }
        // æ²¡æœ‰ Mega æ•°æ®ï¼Œç¦ç”¨
        pokemon.canMegaEvolve = false;
        console.log(`[FORM] ${pokemon.name} has no Mega form - Mega DISABLED`);
        return;
    }
    // ğŸ‘‰ åœºæ™¯ C: Z æ‹›å¼æ¨¡å¼ (mechanic='zmove')
    if (desiredMechanic === 'zmove') {
        // Z æ‹›å¼ä¸éœ€è¦å½¢æ€å˜åŒ–ï¼Œä½†ç¦æ­¢ Mega/Dynamax
        pokemon.canMegaEvolve = false;
        pokemon.canDynamax = false;
        console.log(`[FORM] ${pokemon.name} locked to Z-Move - form changes DISABLED`);
        return;
    }
    if (desiredMechanic === 'tera') {
        // å¤ªæ™¶åŒ–ä¸éœ€è¦å½¢æ€å˜åŒ–ï¼Œç¦æ­¢è‡ªåŠ¨æ£€æµ‹ Mega/Dynamax
        pokemon.canMegaEvolve = false;
        pokemon.canDynamax = false;
        console.log(`[FORM] ${pokemon.name} locked to Tera - form changes DISABLED`);
        return;
    }
    // ğŸ‘‰ åœºæ™¯ D: è‡ªåŠ¨æŒ¡ (mechanic ä¸å¡«æˆ– 'any')
    // ä¼˜å…ˆ Megaï¼ˆå› ä¸º Mega æ”¹å˜ç§æ—ç‰¹æ€§æ›´æ˜æ˜¾ï¼‰ï¼Œæ²¡ Mega çœ‹èƒ½ä¸èƒ½ GMax
    if (avail.ultra && typeof POKEDEX !== 'undefined' && POKEDEX[avail.ultra]) {
        pokemon.megaTargetId = avail.ultra;
        pokemon.canMegaEvolve = true;
        pokemon.evolutionType = 'ultra';
        console.log(`[FORM] Auto-detected Ultra: ${pokemon.megaTargetId}`);
    } else if (avail.mega.length > 0) {
        // ã€ä¿®å¤ã€‘åªæœ‰æºå¸¦å¯¹åº” Mega çŸ³çš„å®å¯æ¢¦æ‰èƒ½è‡ªåŠ¨æ£€æµ‹ Mega
        const pokemonItem = (pokemon.item || '').toLowerCase().replace(/[^a-z]/g, '');
        const validMegaForms = avail.mega.filter(f => {
            if (typeof POKEDEX === 'undefined' || !POKEDEX[f]) return false;
            const megaData = POKEDEX[f];
            // æ£€æŸ¥æ˜¯å¦æºå¸¦å¯¹åº”çš„ Mega çŸ³
            const requiredItem = (megaData.requiredItem || '').toLowerCase().replace(/[^a-z]/g, '');
            return requiredItem && pokemonItem === requiredItem;
        });
        if (validMegaForms.length > 0) {
            // ã€åŒ Mega ç‰¹æ®Šå¤„ç†ã€‘å–·ç«é¾™/è¶…æ¢¦æºå¸¦ä»»æ„ä¸€ä¸ª Mega çŸ³æ—¶ï¼Œéƒ½å¯ä»¥é€‰æ‹© X æˆ– Y
            if (hasDualMega) {
                // è·å–æ‰€æœ‰å¯ç”¨çš„ Mega å½¢æ€ï¼ˆä¸ç®¡æºå¸¦å“ªä¸ªçŸ³å¤´ï¼‰
                const allMegaForms = avail.mega.filter(f => typeof POKEDEX !== 'undefined' && POKEDEX[f]);
                if (allMegaForms.length >= 2) {
                    pokemon.hasDualMega = true;
                    pokemon.megaFormsAvailable = allMegaForms;
                    console.log(`[FORM] Dual Mega enabled: ${allMegaForms.join(', ')}`);
                }
            }
            pokemon.megaTargetId = validMegaForms.find(f => f.endsWith('x')) || validMegaForms[0];
            pokemon.canMegaEvolve = true;
            pokemon.evolutionType = 'mega';
            console.log(`[FORM] Auto-detected Mega (with item): ${pokemon.megaTargetId}`);
        } else {
            // æ²¡æœ‰æºå¸¦ Mega çŸ³ï¼Œç¦ç”¨è‡ªåŠ¨ Mega
            pokemon.canMegaEvolve = false;
            console.log(`[FORM] ${pokemon.name} has Mega form but no Mega Stone - Mega DISABLED`);
        }
    } else if (avail.gmax.length > 0) {
        // åªæœ‰ä¸“å± GMax çš„æ‰è‡ªåŠ¨æ¿€æ´»ï¼Œé€šç”¨æå·¨åŒ–éœ€è¦æ‰‹åŠ¨æŒ‡å®š mechanic
        pokemon.megaTargetId = avail.gmax[0];
        pokemon.canMegaEvolve = true;
        pokemon.canDynamax = true;
        pokemon.evolutionType = 'dynamax';
        console.log(`[FORM] Auto-detected GMax: ${pokemon.megaTargetId}`);
    } else {
        pokemon.canMegaEvolve = false;
        pokemon.canFormChange = false;
        console.log(`[FORM] ${pokemon.name} has NO form changes available`);
    }
}
// å‘åå…¼å®¹åˆ«å
const autoDetectMegaEligibility = autoDetectFormChangeEligibility;
/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºéå®˜æ–¹ Megaï¼ˆåŠ¨æ€æ£€æµ‹ï¼‰
 * ä¸å†ä½¿ç”¨ç¡¬ç¼–ç åˆ—è¡¨ï¼
 * å®é™…æ£€æµ‹åœ¨ smartLoadSprite ä¸­è¿›è¡Œï¼šå½“æ‰€æœ‰ç²¾çµå›¾å›é€€éƒ½å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨åˆ¤æ–­ä¸ºéå®˜æ–¹ Mega
 */
function isUnofficialMega(megaTargetId) {
    // ä¸å†é¢„åˆ¤ï¼Œè®© smartLoadSprite çš„å›é€€æœºåˆ¶æ¥åŠ¨æ€æ£€æµ‹
    return false;
}
/**
 * æ‰§è¡Œ Mega è¿›åŒ– (å¼•æ“å±‚é¢)
 * @param {Pokemon} pokemon - è¦è¿›åŒ–çš„å®å¯æ¢¦
 * @returns {object|null} - è¿›åŒ–ç»“æœä¿¡æ¯ï¼Œæˆ– null å¦‚æœå¤±è´¥
 */
function performMegaEvolution(pokemon) {
    if (!pokemon.canMegaEvolve || pokemon.isMega || !pokemon.megaTargetId) {
        return null;
    }
    // === ã€Ambrosia æ—¶ç©ºé†‰ã€‘æ ‡è®°ä¸‹å›åˆæ··ä¹± ===
    if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.checkNeuroBacklash) {
        const currentWeather = window.battle?.weather || '';
        const trainer = window.battle?.isPlayerTurn ? null : window.battle?.enemyTrainer;
        const neuroResult = window.WeatherEffects.checkNeuroBacklash(currentWeather, 'mega', pokemon, trainer);
        if (neuroResult.shouldTrigger) {
            pokemon.volatile = pokemon.volatile || {};
            pokemon.volatile.neuroBacklash = true;
            console.log(`[AMBROSIA] âš¡ æ—¶ç©ºé†‰ï¼š${pokemon.name} Megaè¿›åŒ–åè¢«æ ‡è®°ï¼Œä¸‹å›åˆå°†æ··ä¹±`);
        }
    }
    const megaData = typeof getPokemonData === 'function' 
        ? getPokemonData(pokemon.megaTargetId)
        : null;
    if (!megaData) {
        console.warn(`[MEGA] Mega form data not found: ${pokemon.megaTargetId}`);
        return null;
    }
    // æ£€æµ‹æ˜¯å¦ä¸ºéå®˜æ–¹ Mega
    const isUnofficial = isUnofficialMega(pokemon.megaTargetId);
    if (isUnofficial) {
        console.log(`[MEGA] Detected unofficial Mega: ${pokemon.megaTargetId} (Radical Red / ROM Hack)`);
        pokemon.isUnofficialMega = true;
    }
    // ä¿å­˜æ—§æ•°æ®ç”¨äºæ—¥å¿—
    const oldName = pokemon.cnName;
    const oldTypes = [...pokemon.types];
    const oldAbility = pokemon.ability;
    // æ›´æ–°åŸºç¡€æ•°æ®
    pokemon.name = megaData.name;
    // [BUG FIX] å¼ºåˆ¶åˆ·æ–°ä¸­æ–‡åï¼Œé˜²æ­¢å˜å›è‹±æ–‡
    if (typeof window !== 'undefined' && window.Locale) {
        // å…ˆå°è¯•æŸ¥å…¨å "Lucario-Mega" => "è¶…çº§è·¯å¡åˆ©æ¬§"
        let cn = window.Locale.get(megaData.name);
        // æ£€æµ‹æ˜¯å¦ä¸º Mega å½¢æ€ï¼ˆåå­—åŒ…å« -Mega æˆ– -Mega-X/Yï¼‰
        const isMegaForm = megaData.name.includes('-Mega');
        // å¦‚æœæ˜¯ Mega å½¢æ€ï¼Œä½†ç¿»è¯‘ç»“æœä¸åŒ…å«"è¶…çº§"ï¼Œåˆ™å¼ºåˆ¶æ·»åŠ 
        if (isMegaForm && !cn.startsWith('è¶…çº§')) {
            // ä¼˜å…ˆä½¿ç”¨ POKEDEX ä¸­çš„ baseSpecies å­—æ®µï¼Œæ›´å¯é 
            const megaPokedex = typeof POKEDEX !== 'undefined' ? POKEDEX[pokemon.megaTargetId] : null;
            const baseSpeciesName = megaPokedex?.baseSpecies || megaData.name.split('-')[0];
            const baseCn = window.Locale.get(baseSpeciesName);
            cn = `è¶…çº§${baseCn}`;
            console.log(`[MEGA] æ™ºèƒ½æ‹¼è£…ä¸­æ–‡å: baseSpecies=${baseSpeciesName}, baseCn=${baseCn}, result=${cn}`);
        }
        pokemon.cnName = cn;
    } else {
        pokemon.cnName = megaData.name;
    }
    pokemon.types = megaData.types || pokemon.types;
    pokemon.baseStats = megaData.baseStats;
    // è·å– Mega å½¢æ€çš„ç‰¹æ€§
    // ã€ä¿®å¤ã€‘å¦‚æœç”¨æˆ·åœ¨ JSON ä¸­è‡ªå®šä¹‰äº†ç‰¹æ€§ï¼ˆéé»˜è®¤ç‰¹æ€§ï¼‰ï¼Œåˆ™ä¿ç•™ç”¨æˆ·ç‰¹æ€§
    const megaPokedexData = typeof POKEDEX !== 'undefined' ? POKEDEX[pokemon.megaTargetId] : null;
    const basePokedexData = typeof POKEDEX !== 'undefined' ? POKEDEX[pokemon.megaTargetId.replace(/mega[xy]?$/, '')] : null;
    const isCustomAbility = basePokedexData && basePokedexData.abilities && 
        !Object.values(basePokedexData.abilities).includes(oldAbility);
    if (isCustomAbility) {
        // ç”¨æˆ·è‡ªå®šä¹‰äº†ç‰¹æ€§ï¼ˆå¦‚ Magic Guardï¼‰ï¼Œä¿ç•™ä¸è¦†ç›–
        console.log(`[MEGA] Preserving custom ability: ${oldAbility}`);
    } else if (megaPokedexData && megaPokedexData.abilities) {
        pokemon.ability = megaPokedexData.abilities['0'] || megaPokedexData.abilities['H'] || pokemon.ability;
    }
    // é‡æ–°è®¡ç®—èƒ½åŠ›å€¼ (HP ä¸å˜!)
    const oldHp = pokemon.currHp;
    const oldMaxHp = pokemon.maxHp;
    // ä¿ç•™åŸå§‹ Pokemon çš„ EV é…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨è‡ªåŠ¨è®¡ç®—
    let evLevel = pokemon.statsMeta?.ev_level;
    if (evLevel === undefined || evLevel === null) {
        evLevel = Math.floor(pokemon.level * 1.5);
        if (evLevel > 85) evLevel = 85;
    }
    const newStats = typeof calcStats === 'function'
        ? calcStats(megaData.baseStats, pokemon.level, 31, evLevel)
        : megaData.baseStats;
    // HP ä¿æŒä¸å˜ (Mega è¿›åŒ–çš„æ ¸å¿ƒè§„åˆ™)
    // pokemon.maxHp = oldMaxHp; // ä¸å˜
    // pokemon.currHp = oldHp;   // ä¸å˜
    // æ›´æ–°å…¶ä»–èƒ½åŠ›å€¼
    pokemon.atk = newStats.atk;
    pokemon.def = newStats.def;
    pokemon.spa = newStats.spa;
    pokemon.spd = newStats.spd;
    pokemon.spe = newStats.spe;
    // æ ‡è®°å·² Mega è¿›åŒ–
    pokemon.isMega = true;
    pokemon.canMegaEvolve = false;
    // === æ’­æ”¾ Mega è¿›åŒ–å«å£° ===
    if (typeof window !== 'undefined' && typeof window.playPokemonCry === 'function') {
        window.playPokemonCry(pokemon.name);
    }
    return {
        oldName,
        newName: pokemon.cnName,
        oldTypes,
        newTypes: pokemon.types,
        oldAbility,
        newAbility: pokemon.ability,
        typeChanged: JSON.stringify(oldTypes) !== JSON.stringify(pokemon.types),
        abilityChanged: oldAbility !== pokemon.ability
    };
}
/**
 * æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦å¯ä»¥ Mega è¿›åŒ–
 * @param {Pokemon} pokemon
 * @returns {boolean}
 */
function canMegaEvolve(pokemon) {
    return pokemon && pokemon.canMegaEvolve && !pokemon.isMega && pokemon.megaTargetId;
}
// ============================================
// å¯¼å‡ºåˆ°å…¨å±€
// ============================================
if (typeof window !== 'undefined') {
    window.autoDetectFormChangeEligibility = autoDetectFormChangeEligibility;
    window.autoDetectMegaEligibility = autoDetectMegaEligibility;
    window.performMegaEvolution = performMegaEvolution;
    window.canMegaEvolve = canMegaEvolve;
    window.isUnofficialMega = isUnofficialMega;
}
// å¯¼å‡ºä¸ºæ¨¡å—ï¼ˆå¦‚æœæ”¯æŒï¼‰
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        autoDetectFormChangeEligibility,
        autoDetectMegaEligibility,
        performMegaEvolution,
        canMegaEvolve,
        isUnofficialMega
    };
}
]]></file>
        <file name="move-styles.js"><![CDATA[/**
 * ===========================================
 * MOVE-STYLES.JS - å¤æ­¦ç³»ç»Ÿï¼ˆæ‹›å¼é£æ ¼ï¼‰
 * ===========================================
 * 
 * èŒè´£:
 * - æ‹›å¼é£æ ¼çŠ¶æ€ç®¡ç† (é“/è¿…/åˆš)
 * - é£æ ¼åˆ‡æ¢ UI æ›´æ–°
 * - å†·å´çŠ¶æ€æ˜¾ç¤º
 */
// ============================================
// çŠ¶æ€ä¸å¸¸é‡
// ============================================
// å½“å‰é€‰æ‹©çš„æ‹›å¼é£æ ¼
let currentMoveStyle = 'normal';
// é£æ ¼åºåˆ—
const STYLE_SEQUENCE = ['normal', 'agile', 'strong', 'focus'];
// é£æ ¼æ ‡ç­¾ï¼ˆä¸­æ–‡æ˜¾ç¤ºï¼‰
const STYLE_LABELS = {
    normal: 'é“',
    agile: 'è¿…',
    strong: 'åˆš',
    focus: 'å‡'
};
// ============================================
// æ ¸å¿ƒå‡½æ•°
// ============================================
/**
 * è®¾ç½®å½“å‰æ‹›å¼é£æ ¼
 * @param {string} style - 'normal' | 'agile' | 'strong' | 'focus'
 * @param {{silent?: boolean, animate?: boolean}} options
 */
function setMoveStyle(style, options = {}) {
    if (!STYLE_SEQUENCE.includes(style)) style = 'normal';
    const prev = currentMoveStyle;
    currentMoveStyle = style;
    // åŒæ­¥æ›´æ–°å…¨å±€å˜é‡ï¼Œç¡®ä¿æˆ˜æ–—é€»è¾‘èƒ½è¯»å–åˆ°æœ€æ–°å€¼
    if (typeof window !== 'undefined') {
        window.currentMoveStyle = currentMoveStyle;
    }
    const orb = document.getElementById('btn-style-taiji');
    const label = document.getElementById('taiji-text');
    if (orb) {
        STYLE_SEQUENCE.forEach(cls => orb.classList.remove(cls));
        orb.classList.add(style);
        // ã€å†·å´çŠ¶æ€ã€‘æ£€æŸ¥æ˜¯å¦åœ¨å†·å´ä¸­ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ  disabled æ ·å¼
        // éœ€è¦è®¿é—®å…¨å±€ battle å¯¹è±¡
        const battle = typeof window !== 'undefined' ? window.battle : null;
        if (battle && battle.playerStyleCooldown > 0) {
            orb.classList.add('cooldown');
            orb.style.opacity = '0.4';
            orb.style.filter = 'grayscale(80%)';
            orb.style.pointerEvents = 'none';
        } else {
            orb.classList.remove('cooldown');
            orb.style.opacity = '';
            orb.style.filter = '';
            orb.style.pointerEvents = '';
        }
    }
    if (label) {
        const nextChar = STYLE_LABELS[style] || 'é“';
        // ã€å†·å´çŠ¶æ€ã€‘å†·å´ä¸­æ˜¾ç¤ºç‰¹æ®Šå­—ç¬¦
        const battle = typeof window !== 'undefined' ? window.battle : null;
        const displayChar = (battle && battle.playerStyleCooldown > 0) ? 'ä¼‘' : nextChar;
        if (options.animate !== false && prev !== style) {
            animateTaijiText(label, displayChar);
        } else {
            label.textContent = displayChar;
        }
    }
    if (!options.silent) {
        console.log(`[STYLES] æ‹›å¼é£æ ¼åˆ‡æ¢ä¸º: ${style}`);
    }
}
/**
 * æ›´æ–°é£æ ¼æŒ‰é’®çš„å†·å´çŠ¶æ€æ˜¾ç¤º
 */
function updateStyleButtonCooldown() {
    const orb = document.getElementById('btn-style-taiji');
    const label = document.getElementById('taiji-text');
    if (!orb) return;
    const battle = typeof window !== 'undefined' ? window.battle : null;
    const isCooldown = battle && battle.playerStyleCooldown > 0;
    if (isCooldown) {
        orb.classList.add('cooldown');
        orb.style.opacity = '0.4';
        orb.style.filter = 'grayscale(80%)';
        orb.style.pointerEvents = 'none';
        if (label) label.textContent = 'ä¼‘';
    } else {
        orb.classList.remove('cooldown');
        orb.style.opacity = '';
        orb.style.filter = '';
        orb.style.pointerEvents = '';
        if (label) label.textContent = STYLE_LABELS[currentMoveStyle] || 'é“';
    }
}
/**
 * æ–‡å­—åˆ‡æ¢åŠ¨ç”»
 */
function animateTaijiText(el, newChar) {
    if (!el) return;
    el.style.transition = 'transform 0.15s ease, opacity 0.15s ease';
    el.style.transform = 'skewX(15deg) scale(0)';
    el.style.opacity = '0';
    setTimeout(() => {
        el.textContent = newChar;
        el.style.transform = 'skewX(15deg) scale(1.2)';
        el.style.opacity = '1';
        setTimeout(() => {
            el.style.transform = 'skewX(15deg) scale(1)';
        }, 150);
    }, 150);
}
/**
 * å¾ªç¯åˆ‡æ¢é£æ ¼ï¼šnormal -> agile -> strong -> normal
 */
function cycleMoveStyle() {
    const idx = STYLE_SEQUENCE.indexOf(currentMoveStyle);
    const nextStyle = STYLE_SEQUENCE[(idx + 1) % STYLE_SEQUENCE.length];
    setMoveStyle(nextStyle);
}
/**
 * è·å–å½“å‰æ‹›å¼é£æ ¼
 * @returns {string} 'normal' | 'agile' | 'strong'
 */
function getCurrentMoveStyle() {
    return currentMoveStyle;
}
/**
 * é‡ç½®æ‹›å¼é£æ ¼ä¸ºé»˜è®¤
 */
function resetMoveStyle() {
    currentMoveStyle = 'normal';
    setMoveStyle('normal', { silent: true, animate: false });
}
// ============================================
// å¯¼å‡º
// ============================================
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    window.currentMoveStyle = currentMoveStyle;
    window.STYLE_SEQUENCE = STYLE_SEQUENCE;
    window.STYLE_LABELS = STYLE_LABELS;
    window.setMoveStyle = setMoveStyle;
    window.updateStyleButtonCooldown = updateStyleButtonCooldown;
    window.animateTaijiText = animateTaijiText;
    window.cycleMoveStyle = cycleMoveStyle;
    window.getCurrentMoveStyle = getCurrentMoveStyle;
    window.resetMoveStyle = resetMoveStyle;
    // ä½¿ç”¨ getter ä¿æŒ currentMoveStyle åŒæ­¥
    Object.defineProperty(window, 'currentMoveStyle', {
        get: () => currentMoveStyle,
        set: (val) => { currentMoveStyle = val; }
    });
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        STYLE_SEQUENCE,
        STYLE_LABELS,
        setMoveStyle,
        updateStyleButtonCooldown,
        animateTaijiText,
        cycleMoveStyle,
        getCurrentMoveStyle,
        resetMoveStyle,
        get currentMoveStyle() { return currentMoveStyle; },
        set currentMoveStyle(val) { currentMoveStyle = val; }
    };
}
]]></file>
        <file name="z-moves.js"><![CDATA[/**
 * ===========================================
 * Z-MOVES.JS - Z æ‹›å¼æ¨å¯¼ç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - Z æ‹›å¼æ¨å¯¼ (é€šç”¨ Z / ä¸“å± Z)
 * - Z æ‹›å¼æ˜ å°„è¡¨ç®¡ç†
 * 
 * æ³¨æ„ï¼šæå·¨åŒ–ç›¸å…³åŠŸèƒ½å·²è¿ç§»è‡³ mechanics/dynamax.js
 */
// ============================================
// Z æ‹›å¼æ•°æ®è¡¨
// ============================================
// é€šç”¨å±æ€§ Z æ‹›å¼è¡¨ (Type -> Z-Move Name)
const GENERIC_Z_BY_TYPE = {
    'Normal': 'Breakneck Blitz', 'Fire': 'Inferno Overdrive', 'Water': 'Hydro Vortex',
    'Grass': 'Bloom Doom', 'Electric': 'Gigavolt Havoc', 'Ice': 'Subzero Slammer',
    'Fighting': 'All-Out Pummeling', 'Poison': 'Acid Downpour', 'Ground': 'Tectonic Rage',
    'Flying': 'Supersonic Skystrike', 'Psychic': 'Shattered Psyche', 'Bug': 'Savage Spin-Out',
    'Rock': 'Continental Crush', 'Ghost': 'Never-Ending Nightmare', 'Dragon': 'Devastating Drake',
    'Dark': 'Black Hole Eclipse', 'Steel': 'Corkscrew Crash', 'Fairy': 'Twinkle Tackle'
};
// ============================================
// ä¸“å± Z çŸ©é˜µ (Signature Z Matrix)
// æ ¼å¼: "basemove+species" => "Z-Move Name"
// ============================================
const SIGNATURE_Z_MATRIX = {
    // çš®å¡ä¸˜ç³»
    'thunderbolt+pikachu': '10,000,000 Volt Thunderbolt',
    'volttackle+pikachu': 'Catastropika',
    'thunderbolt+raichu': 'Stoked Sparksurfer',
    'thunderbolt+raichualola': 'Stoked Sparksurfer',
    // ä¼Šå¸ƒ
    'lastresort+eevee': 'Extreme Evoboost',
    // å¡æ¯”å…½
    'gigaimpact+snorlax': 'Pulverizing Pancake',
    // å¾¡ä¸‰å®¶
    'darkestlariat+incineroar': 'Malicious Moonsault',
    'sparklingaria+primarina': 'Oceanic Operetta',
    'spiritshackle+decidueye': 'Sinister Arrow Raid',
    // ä¼ è¯´/ç¥å…½ - å¥ˆå…‹æ´›å…¹ç›ä¸“å± Zï¼ˆåªæœ‰ç©¶æå½¢æ€æ‰èƒ½ä½¿ç”¨ï¼‰
    // åŸå§‹ Necrozmaã€æ—¥éª¡å­ã€æœˆéª¡å­ä¸èƒ½ç›´æ¥ä½¿ç”¨ä¸“å± Z
    // å¿…é¡»å…ˆ Ultra Burst å˜æˆç©¶æå¥ˆå…‹æ´›å…¹ç›æ‰èƒ½ä½¿ç”¨
    'photongeyser+necrozmaultra': 'Light That Burns the Sky',
    'sunsteelstrike+solgaleo': 'Searing Sunraze Smash',
    'moongeistbeam+lunala': 'Menacing Moonraze Maelstrom',
    'spectralthief+marshadow': 'Soul-Stealing 7-Star Strike',
    'clangingscales+kommoo': 'Clangorous Soulblaze',
    'psychic+mew': 'Genesis Supernova',
    // å…¶ä»–
    'playrough+mimikyu': "Let's Snuggle Forever",
    'stoneedge+lycanroc': 'Splintered Stormshards',
    'naturesmadness+tapukoko': 'Guardian of Alola',
    'naturesmadness+tapulele': 'Guardian of Alola',
    'naturesmadness+tapubulu': 'Guardian of Alola',
    'naturesmadness+tapufini': 'Guardian of Alola'
};
// ============================================
// ä¸“å± Z ä¼˜å…ˆçº§è¡¨ (è¶Šé å‰ä¼˜å…ˆçº§è¶Šé«˜)
// ç”¨äºè§£å†³åŒä¸€åªå®å¯æ¢¦æœ‰å¤šä¸ªä¸“å± Z æ—¶çš„å†²çª
// ============================================
const SIGNATURE_Z_PRIORITY = [
    '10,000,000 Volt Thunderbolt', // æ™ºçš® Z (æœ€é«˜ä¼˜å…ˆçº§)
    'Catastropika',                 // çš®å¡ Z
    'Stoked Sparksurfer',           // é›·ä¸˜ Z
    'Extreme Evoboost',             // ä¼Šå¸ƒ Z
    'Clangorous Soulblaze',         // æ–å°¾é³ç”²é¾™ Z
    'Light That Burns the Sky',     // å¥ˆå…‹æ´›å…¹ç› Z
    'Searing Sunraze Smash',        // ç´¢å°”è¿¦é›·æ¬§ Z
    'Menacing Moonraze Maelstrom',  // éœ²å¥ˆé›…æ‹‰ Z
    'Soul-Stealing 7-Star Strike',  // ç›å¤å¤š Z
    'Malicious Moonsault',          // ç‚½ç„°å’†å“®è™ Z
    'Oceanic Operetta',             // è¥¿ç‹®æµ·å£¬ Z
    'Sinister Arrow Raid',          // ç‹™å°„æ ‘æ­ Z
    'Genesis Supernova',            // æ¢¦å¹» Z
    "Let's Snuggle Forever",        // è°œæ‹ŸQ Z
    'Splintered Stormshards',       // é¬ƒå²©ç‹¼äºº Z
    'Guardian of Alola',            // å¡ç’ Z
    'Pulverizing Pancake'           // å¡æ¯”å…½ Z
];
// ============================================
// åŠ¨æ€ç”Ÿæˆçš„æ˜ å°„è¡¨
// ============================================
// ä¸“å± Z æ‹›å¼åæŸ¥è¡¨ (BaseMove ID -> Z-Move Data)
const EXCLUSIVE_Z_MAP = {};
// ============================================
// åˆå§‹åŒ–ï¼šä»æ•°æ®åº“æ„å»º Z æ‹›å¼åæŸ¥è¡¨
// ============================================
(function buildZMoveMaps() {
    if (typeof MOVES === 'undefined') {
        console.warn('[Z-MOVES] MOVES database not loaded');
        return;
    }
    // ä¸“å± Z æ‹›å¼çš„ baseMove æ˜ å°„ (æ‰‹åŠ¨ç»´æŠ¤ï¼Œå› ä¸ºæ•°æ®åº“æ²¡æœ‰è¿™ä¸ªå­—æ®µ)
    const EXCLUSIVE_Z_BASE_MOVES = {
        '10000000voltthunderbolt': 'thunderbolt',
        'catastropika': 'volttackle',
        'stokedsparksurfer': 'thunderbolt',
        'extremeevoboost': 'lastresort',
        'oceanicoperetta': 'sparklingaria',
        'maliciousmoonsault': 'darkestlariat',
        'soulstealing7starstrike': 'spectralthief',
        'sinisterarrowraid': 'spiritshackle',
        'clangoroussoulblaze': 'clangingscales',
        'lightthatburnsthesky': 'photongeyser',
        'searingsunrazesmash': 'sunsteelstrike',
        'menacingmoonrazemaelstrom': 'moongeistbeam',
        'letssnuggleforever': 'playrough',
        'splinteredstormshards': 'stoneedge',
        'pulverizingpancake': 'gigaimpact',
        'genesis supernova': 'psychic'
    };
    // éå†æ‰€æœ‰æ‹›å¼ï¼Œæ„å»ºä¸“å± Z æ‹›å¼åæŸ¥è¡¨
    for (const moveId in MOVES) {
        const moveData = MOVES[moveId];
        if (moveData.isZ && typeof moveData.isZ === 'string') {
            const baseMove = EXCLUSIVE_Z_BASE_MOVES[moveId];
            if (baseMove) {
                EXCLUSIVE_Z_MAP[baseMove] = {
                    name: moveData.name,
                    id: moveId,
                    type: moveData.type,
                    basePower: moveData.basePower || 180,
                    zCrystal: moveData.isZ
                };
            }
        }
    }
    console.log('[Z-MOVES] Built EXCLUSIVE_Z_MAP:', Object.keys(EXCLUSIVE_Z_MAP).length, 'entries');
})();
// ============================================
// Z æ‹›å¼æ¨å¯¼å‡½æ•°
// ============================================
/**
 * è®¡ç®—å®å¯æ¢¦çš„"å‘½ä¸­æ³¨å®šä¸“å± Z"ï¼ˆä¼˜å…ˆçº§æœ€é«˜çš„é‚£ä¸ªï¼‰
 * @param {Object} pokemon - å®å¯æ¢¦å¯¹è±¡
 * @returns {string|null} æœ€é«˜ä¼˜å…ˆçº§çš„ä¸“å± Z åç§°ï¼Œæˆ– null
 */
function calculateBestZForPokemon(pokemon) {
    // ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è®¡ç®—
    if (pokemon._cachedBestZ !== undefined) return pokemon._cachedBestZ;
    // æ³¨æ„ï¼šä¸è¿‡æ»¤ ultraï¼Œå› ä¸º Necrozma-Ultra éœ€è¦ä¿ç•™å®Œæ•´åç§°æ¥åŒ¹é…ä¸“å± Z
    const speciesId = (pokemon.name || '').toLowerCase().replace(/[^a-z0-9]/g, '').replace(/(partner|alola|galar|gmax|mega|cap|duskmane|dawnwings)/g, '');
    let bestFound = null;
    let highestPrio = Infinity;
    // éå†ç²¾çµæ‰€æœ‰æ‹›å¼ï¼Œæ‰¾å‡ºä¼˜å…ˆçº§æœ€é«˜çš„ä¸“å± Z
    (pokemon.moves || []).forEach(m => {
        const moveId = (m.name || m || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        const matrixKey = `${moveId}+${speciesId}`;
        const targetZName = SIGNATURE_Z_MATRIX[matrixKey];
        if (targetZName) {
            let prio = SIGNATURE_Z_PRIORITY.indexOf(targetZName);
            if (prio === -1) prio = 999; // æœªæ’åºçš„é»˜è®¤å¾ˆä½
            if (prio < highestPrio) {
                highestPrio = prio;
                bestFound = targetZName;
            }
        }
    });
    // ç¼“å­˜ç»“æœ
    pokemon._cachedBestZ = bestFound;
    return bestFound;
}
/**
 * è·å–æ‹›å¼å¯¹åº”çš„ Z æ‹›å¼åç§° (å•ä¸€ Z é”å®šç­–ç•¥)
 * @param {Object} baseMoveObj - åŸå§‹æ‹›å¼å¯¹è±¡
 * @param {Object} pokemon - å®å¯æ¢¦å¯¹è±¡
 * @returns {Object|null} Z æ‹›å¼ä¿¡æ¯ { name, type, power } æˆ– null
 */
function getZMoveTarget(baseMoveObj, pokemon) {
    // 0. åŸºç¡€é—¨æ§›
    const battle = typeof window !== 'undefined' ? window.battle : null;
    if (battle && battle.playerUnlocks && !battle.playerUnlocks.enable_z_move) return null;
    if (pokemon.mechanic !== 'zmove') return null;
    if (pokemon.isMega || pokemon.isDynamaxed || pokemon.hasBondResonance) return null;
    if (baseMoveObj.category === 'Status' || baseMoveObj.cat === 'status') return null;
    // å‡†å¤‡ Key
    const moveId = (baseMoveObj.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const moveType = baseMoveObj.type || 'Normal';
    // æ³¨æ„ï¼šä¸è¿‡æ»¤ ultraï¼Œå› ä¸º Necrozma-Ultra éœ€è¦ä¿ç•™å®Œæ•´åç§°æ¥åŒ¹é…ä¸“å± Z
    const speciesRoot = (pokemon.name || '').toLowerCase().replace(/[^a-z0-9]/g, '').replace(/(partner|alola|galar|gmax|mega|cap|duskmane|dawnwings)/g, '');
    // 1. è·å–è¿™åªå®å¯æ¢¦"å‘½ä¸­æ³¨å®š"çš„ä¸“å± Zï¼ˆä¼˜å…ˆçº§æœ€é«˜çš„é‚£ä¸ªï¼‰
    const theOneZ = calculateBestZForPokemon(pokemon);
    // 2. æ£€æŸ¥å½“å‰æ‹›å¼æ˜¯å¦èƒ½äº§ç”Ÿä¸“å± Z
    const sigKey = `${moveId}+${speciesRoot}`;
    const potentialZ = SIGNATURE_Z_MATRIX[sigKey];
    if (potentialZ) {
        // å…³é”®åˆ¤æ–­ï¼šåªæœ‰å½“è¿™ä¸ªæ‹›å¼äº§ç”Ÿçš„ Z ç­‰äº"å‘½ä¸­æ³¨å®š"çš„ Z æ—¶ï¼Œæ‰ç‚¹äº®
        if (potentialZ === theOneZ) {
            return {
                name: potentialZ,
                type: moveType,
                power: 200,
                isExclusive: true
            };
        }
        // è™½ç„¶æ˜¯ä¸“å±æ‹›å¼ï¼Œä½†å› ä¼˜å…ˆçº§è¾“äº†ï¼Œè¿”å› null
        return null;
    }
    // 3. å¦‚æœè¿™åªå®å¯æ¢¦æ²¡æœ‰ä»»ä½•ä¸“å± Z èƒ½åŠ›ï¼Œå…è®¸é€šç”¨ Z
    if (!theOneZ) {
        if (GENERIC_Z_BY_TYPE[moveType]) {
            const basePower = baseMoveObj.basePower || baseMoveObj.power || 60;
            let zPower = 100;
            if (basePower >= 140) zPower = 200;
            else if (basePower >= 130) zPower = 195;
            else if (basePower >= 120) zPower = 190;
            else if (basePower >= 110) zPower = 185;
            else if (basePower >= 100) zPower = 180;
            else if (basePower >= 90) zPower = 175;
            else if (basePower >= 80) zPower = 160;
            else if (basePower >= 70) zPower = 140;
            else if (basePower >= 60) zPower = 120;
            else zPower = 100;
            return {
                name: GENERIC_Z_BY_TYPE[moveType],
                type: moveType,
                power: zPower,
                isExclusive: false
            };
        }
    }
    // 4. å¦‚æœè¿™åªå®å¯æ¢¦æœ‰ä¸“å± Zï¼ˆtheOneZ å­˜åœ¨ï¼‰ï¼Œå…¶ä»–æ‹›å¼ä¸èƒ½å˜æˆé€šç”¨ Z
    return null;
}
// ============================================
// å¯¼å‡º
// ============================================
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    window.GENERIC_Z_BY_TYPE = GENERIC_Z_BY_TYPE;
    window.SIGNATURE_Z_MATRIX = SIGNATURE_Z_MATRIX;
    window.SIGNATURE_Z_PRIORITY = SIGNATURE_Z_PRIORITY;
    window.EXCLUSIVE_Z_MAP = EXCLUSIVE_Z_MAP;
    window.calculateBestZForPokemon = calculateBestZForPokemon;
    window.getZMoveTarget = getZMoveTarget;
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        GENERIC_Z_BY_TYPE,
        SIGNATURE_Z_MATRIX,
        SIGNATURE_Z_PRIORITY,
        EXCLUSIVE_Z_MAP,
        calculateBestZForPokemon,
        getZMoveTarget
    };
}
]]></file>
    </directory>
    <directory name="src">
        <file name="globals.js"><![CDATA[/**
 * ===========================================
 * GLOBALS.JS - å…¨å±€å˜é‡æŒ‚è½½
 * ===========================================
 * 
 * æ­¤æ–‡ä»¶å¿…é¡»æœ€å…ˆå¯¼å…¥ï¼Œç¡®ä¿æ‰€æœ‰å…¨å±€å˜é‡åœ¨å…¶ä»–æ¨¡å—ä½¿ç”¨å‰å·²æŒ‚è½½
 */
// ============================================
// æ•°æ®å±‚å¯¼å…¥
// ============================================
import { POKEDEX } from '../data/pokedex-data.js';
import { MOVES } from '../data/moves-data.js';
import {
    TRAPPING_MOVES,
    AI_PROTECT_MOVES,
    FORM_SUFFIXES,
    FALLBACK_MOVES,
    GMAX_SPECIES_DATA,
    GENERIC_MAX_BY_TYPE,
    GENERIC_MAX_CN
} from '../data/move-constants.js';
import {
    ITEMS,
    UNSWAPPABLE_ITEMS,
    ItemEffects,
    getItem,
    getItemId,
    getAllPokeballs,
    getAllBerries,
    isChoiceItem,
    isMegaStone,
    isZCrystal,
    isSwappable
} from '../engine/items-data.js';
// ============================================
// å¼•æ“å±‚å¯¼å…¥
// ============================================
import {
    TYPE_CHART,
    NATURE_MODIFIERS,
    getTypeEffectiveness,
    getPokemonData,
    getMoveData,
    calcStats,
    Pokemon,
    BattleState,
    checkCanMove,
    clearVolatileStatus,
    extractBaseFormId,
    resolveSpriteId,
    getFallbackSpriteId,
    normalizePokemonName
} from '../engine/battle-engine.js';
import {
    AbilityHandlers,
    isPinching,
    moveHasFlag,
    checkCanSwitch
} from '../engine/ability-handlers.js';
import {
    MoveHandlers,
    getMoveHandler,
    hasMoveHandler,
    canKnockOff
} from '../engine/move-handlers.js';
import {
    CHARGE_MOVES,
    CHARGE_MOVE_CONFIG,
    getChargeMoveConfig,
    isChargeMove,
    checkInstantCondition,
    handleChargePhase,
    handleReleasePhase,
    checkInvulnerability,
    getChargingMove,
    clearChargingState,
    checkFocusPunchInterrupt,
    checkBeakBlastBurn
} from '../engine/charge-moves.js';
import { calcDamage } from '../battle/battle-calc.js';
import { applyMoveSecondaryEffects } from '../battle/battle-effects.js';
import { applyDamage } from '../battle/battle-damage.js';
import {
    hasAliveSwitch,
    handlePlayerPivot,
    handleEnemyPivot,
    handleEnemyFainted,
    handlePlayerFainted,
    triggerEntryAbilities,
    canPlayerSwitch,
    canEnemySwitch
} from '../battle/battle-switch.js';
import {
    onTurnStart,
    executePlayerTurn,
    executeEnemyTurn,
    enemyTurn,
    getEndTurnStatusLogs
} from '../battle/battle-turns.js';
import {
    getAiAction,
    getExpertAiAction,
    getHardAiMove,
    getNormalAiMove,
    getEasyAiMove,
    getBestRevengeKiller
} from '../engine/ai-engine.js';
// ============================================
// ç«‹å³æŒ‚è½½åˆ° window
// ============================================
// æ•°æ®å¸¸é‡
window.POKEDEX = POKEDEX;
window.MOVES = MOVES;
window.Moves = MOVES;
// æ‹›å¼å¸¸é‡
window.TRAPPING_MOVES = TRAPPING_MOVES;
window.AI_PROTECT_MOVES = AI_PROTECT_MOVES;
window.FORM_SUFFIXES = FORM_SUFFIXES;
window.FALLBACK_MOVES = FALLBACK_MOVES;
window.GMAX_SPECIES_DATA = GMAX_SPECIES_DATA;
window.GENERIC_MAX_BY_TYPE = GENERIC_MAX_BY_TYPE;
window.GENERIC_MAX_CN = GENERIC_MAX_CN;
// é“å…·
window.ITEMS = ITEMS;
window.UNSWAPPABLE_ITEMS = UNSWAPPABLE_ITEMS;
window.ItemEffects = ItemEffects;
window.getItem = getItem;
window.getItemId = getItemId;
window.getAllPokeballs = getAllPokeballs;
window.getAllBerries = getAllBerries;
window.isChoiceItem = isChoiceItem;
window.isMegaStone = isMegaStone;
window.isZCrystal = isZCrystal;
window.isSwappable = isSwappable;
// å±æ€§å…‹åˆ¶
window.TYPE_CHART = TYPE_CHART;
window.NATURE_MODIFIERS = NATURE_MODIFIERS;
window.getTypeEffectiveness = getTypeEffectiveness;
// æ•°æ®æŸ¥è¯¢
window.getPokemonData = getPokemonData;
window.getMoveData = getMoveData;
window.calcStats = calcStats;
window.Pokemon = Pokemon;
// ç²¾çµå›¾è¾…åŠ©
window.extractBaseFormId = extractBaseFormId;
window.resolveSpriteId = resolveSpriteId;
window.getFallbackSpriteId = getFallbackSpriteId;
window.normalizePokemonName = normalizePokemonName;
// ç‰¹æ€§å¤„ç†å™¨
window.AbilityHandlers = AbilityHandlers;
window.isPinching = isPinching;
window.moveHasFlag = moveHasFlag;
window.checkCanSwitch = checkCanSwitch;
// æ‹›å¼å¤„ç†å™¨
window.MoveHandlers = MoveHandlers;
window.getMoveHandler = getMoveHandler;
window.hasMoveHandler = hasMoveHandler;
window.canKnockOff = canKnockOff;
// è“„åŠ›æŠ€èƒ½ç³»ç»Ÿ
window.CHARGE_MOVES = CHARGE_MOVES;
window.CHARGE_MOVE_CONFIG = CHARGE_MOVE_CONFIG;
window.getChargeMoveConfig = getChargeMoveConfig;
window.isChargeMove = isChargeMove;
window.checkInstantCondition = checkInstantCondition;
window.handleChargePhase = handleChargePhase;
window.handleReleasePhase = handleReleasePhase;
window.checkInvulnerability = checkInvulnerability;
window.getChargingMove = getChargingMove;
window.clearChargingState = clearChargingState;
window.checkFocusPunchInterrupt = checkFocusPunchInterrupt;
window.checkBeakBlastBurn = checkBeakBlastBurn;
// ä¼¤å®³è®¡ç®—
window.calcDamage = calcDamage;
// å‰¯ä½œç”¨å¤„ç†
window.applyMoveSecondaryEffects = applyMoveSecondaryEffects;
// æˆ˜æ–—çŠ¶æ€ç®¡ç†
window.BattleState = BattleState;
window.checkCanMove = checkCanMove;
window.clearVolatileStatus = clearVolatileStatus;
// ä¼¤å®³åº”ç”¨
window.applyDamage = applyDamage;
// æ¢äººç³»ç»Ÿ
window.hasAliveSwitch = hasAliveSwitch;
window.handlePlayerPivot = handlePlayerPivot;
window.handleEnemyPivot = handleEnemyPivot;
window.handleEnemyFainted = handleEnemyFainted;
window.handlePlayerFainted = handlePlayerFainted;
window.triggerEntryAbilities = triggerEntryAbilities;
window.canPlayerSwitch = canPlayerSwitch;
window.canEnemySwitch = canEnemySwitch;
// å›åˆç³»ç»Ÿ
window.onTurnStart = onTurnStart;
window.executePlayerTurn = executePlayerTurn;
window.executeEnemyTurn = executeEnemyTurn;
window.enemyTurn = enemyTurn;
window.getEndTurnStatusLogs = getEndTurnStatusLogs;
// AI ç³»ç»Ÿ
window.getAiAction = getAiAction;
window.getExpertAiAction = getExpertAiAction;
window.getHardAiMove = getHardAiMove;
window.getNormalAiMove = getNormalAiMove;
window.getEasyAiMove = getEasyAiMove;
window.getBestRevengeKiller = getBestRevengeKiller;
console.log('[Vite] æ ¸å¿ƒå…¨å±€å˜é‡å·²æŒ‚è½½');
console.log('[Vite] POKEDEX entries:', Object.keys(POKEDEX).length);
console.log('[Vite] MOVES entries:', Object.keys(MOVES).length);
console.log('[Vite] ITEMS entries:', Object.keys(ITEMS).length);
]]></file>
        <file name="main.js"><![CDATA[/**
 * ===========================================
 * MAIN.JS - Vite ES Module å…¥å£æ–‡ä»¶
 * ===========================================
 * 
 * èšåˆæ‰€æœ‰æ¨¡å—ï¼ŒVite ä¼šè‡ªåŠ¨å¤„ç†ä¾èµ–å’Œæ‰“åŒ…
 * 
 * åŠ è½½é¡ºåºï¼š
 * 1. globals.js - æŒ‚è½½æ ¸å¿ƒå…¨å±€å˜é‡
 * 2. å…¶ä»–æ¨¡å— - ä¾èµ–å…¨å±€å˜é‡
 * 3. index.js - ä¸»å…¥å£
 */
// ============================================
// 1. é¦–å…ˆåŠ è½½å…¨å±€å˜é‡ï¼ˆå¿…é¡»ç¬¬ä¸€ä¸ªï¼‰
// ============================================
import './globals.js';
// ============================================
// 2. æˆ˜æ–—æœºåˆ¶æ¨¡å—
// ============================================
import '../mechanics/move-styles.js';
import '../mechanics/z-moves.js';
import '../mechanics/mechanic-checker.js';
import '../mechanics/dynamax.js';
import '../mechanics/mega-evolution.js';
import '../mechanics/form-change/form-change-system.js';
import '../mechanics/clash-system.js';
// ============================================
// 3. UI æ¨¡å—
// ============================================
import '../ui/ui-renderer.js';
import '../ui/ui-sprites.js';
import '../ui/sprite-duplicate-fix.js';
import '../ui/ui-trainer-hud.js';
import '../ui/ui-menus.js';
// ============================================
// 4. ç³»ç»Ÿæ¨¡å—
// ============================================
import '../systems/translations.js';
import '../systems/environment-overlay.js';  // ç¯å¢ƒå›¾å±‚ç³»ç»Ÿ (éœ€åœ¨ data-loader ä¹‹å‰)
import '../systems/data-loader.js';
import '../systems/catch-system.js';
import '../systems/bgm-system.js';
import '../systems/audio-manager.js';
import '../systems/preloader.js';
import '../systems/growth-system.js';
// ============================================
// 5. æˆ˜æ–—æ¨¡å—
// ============================================
import '../engine/weather-effects.js';  // å¤©æ°”æ•ˆæœæ ¸å¿ƒæ¨¡å—ï¼ˆéœ€åœ¨å…¶ä»–æˆ˜æ–—æ¨¡å—ä¹‹å‰ï¼‰
import '../battle/battle-effects.js';
import '../battle/battle-damage.js';
import '../battle/battle-switch.js';
import '../battle/battle-turns.js';
import '../battle/battle-weather.js';
// ============================================
// 6. AI å¼•æ“
// ============================================
import '../engine/ai-engine.js';
// ============================================
// 7. æŠ€èƒ½æ•ˆæœæ‰©å±•
// ============================================
import '../engine/move-effects.js';
// ============================================
// 8. ä¸»å…¥å£
// ============================================
import '../index.js';
console.log('[Vite] æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆ');
]]></file>
    </directory>
    <directory name="systems">
        <file name="audio-manager.js"><![CDATA[/**
 * ===========================================
 * AUDIO-MANAGER.JS - éŸ³æ•ˆç®¡ç†ç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - é¢„åŠ è½½çŸ­éŸ³æ•ˆ (æé«˜å“åº”é€Ÿåº¦)
 * - å®ç°å¹¶å‘æ’­æ”¾ (cloneNode)
 * - ä¸ BGM ç³»ç»ŸååŒå·¥ä½œ
 */
// ============================================
// è·¯å¾„å…¼å®¹ (GitHub Pages)
// ============================================
function getSfxBasePath() {
    // ä¼˜å…ˆä½¿ç”¨å…¨å±€ getBasePathï¼ˆç”± index.js å®šä¹‰ï¼‰
    if (typeof window !== 'undefined' && typeof window.getBasePath === 'function') {
        return window.getBasePath();
    }
    const path = window.location.pathname;
    // GitHub Pages: /pkm33/
    if (path.includes('/pkm33/')) {
        return path.substring(0, path.indexOf('/pkm33/') + 7);
    }
    return './';
}
// SFX æ–‡ä»¶åé…ç½®ï¼ˆä¸åŒ…å«è·¯å¾„ï¼Œè·¯å¾„åœ¨æ’­æ”¾æ—¶åŠ¨æ€è·å–ï¼‰
const SFX_FILES = {
    'CONFIRM':    'ui_01_confirm.mp3',
    'CANCEL':     'ui_01_confirm.mp3',
    'HIT_NORMAL': 'hit_00_normal.mp3',
    'HIT_SUPER':  'Hit_Super_Effective_XY.mp3',
    'HIT_WEAK':   'hit_02_weak.mp3',
    'STAT_UP':    'stat_up.mp3',
    'STAT_DOWN':  'stat_down.mp3',
    'FAINT':      'battle_faint.mp3',
    'HEAL':       'battle_heal.mp3',
    'THROW':      'ball_throw.mp3',
    'BALL_OPEN':  'ball_open.mp3',
    'CLASH':      'Hit_Super_Effective_XY.mp3'
};
// åŠ¨æ€è·å– SFX å®Œæ•´è·¯å¾„
function getSfxPath(filename) {
    const basePath = getSfxBasePath();
    return `${basePath}data/sfx/${filename}`;
}
// å…¼å®¹æ—§ä»£ç ï¼šåŠ¨æ€ç”Ÿæˆ SFX_CONFIG
const SFX_CONFIG = {};
// ============================================
// SFX éŸ³é‡é…ç½®è¡¨ (0.0 - 1.0)
// ============================================
const SFX_VOLUME_CONFIG = {
    'CONFIRM':    0.5,
    'CANCEL':     0.5,
    'HIT_NORMAL': 0.6,
    'HIT_SUPER':  0.7,
    'HIT_WEAK':   0.5,
    'STAT_UP':    0.3,
    'STAT_DOWN':  0.3,
    'FAINT':      0.6,
    'HEAL':       0.5,
    'THROW':      0.6,
    'BALL_OPEN':  0.6,
    'CLASH':      0.8
};
// éŸ³é¢‘ç¼“å­˜æ± 
const sfxCache = {};
// ============================================
// é¢„åŠ è½½ SFXï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾… DOM å’Œè·¯å¾„å°±ç»ªï¼‰
// ============================================
let sfxPreloaded = false;
function initSfxPreload() {
    if (sfxPreloaded) return;
    sfxPreloaded = true;
    console.log('[SFX] Starting preload...');
    let loadedCount = 0;
    const totalCount = Object.keys(SFX_FILES).length;
    for (const [key, filename] of Object.entries(SFX_FILES)) {
        const path = getSfxPath(filename);
        const audio = new Audio();
        audio.src = path;
        audio.preload = 'auto';
        audio.volume = SFX_VOLUME_CONFIG[key] || 0.6;
        // åŒæ—¶å¡«å…… SFX_CONFIG ä»¥å…¼å®¹æ—§ä»£ç 
        SFX_CONFIG[key] = path;
        audio.addEventListener('canplaythrough', () => {
            loadedCount++;
            if (loadedCount === totalCount) {
                console.log(`[SFX] All ${loadedCount} files preloaded.`);
            }
        }, { once: true });
        audio.addEventListener('error', () => {
            console.warn(`[SFX] Failed to load: ${key} (${path})`);
            loadedCount++;
        }, { once: true });
        sfxCache[key] = audio;
        audio.load();
    }
    console.log(`[SFX] Queued ${Object.keys(sfxCache).length} files for preload.`);
}
// ç«‹å³å°è¯•é¢„åŠ è½½ï¼Œå¦‚æœè·¯å¾„è¿˜æ²¡å‡†å¤‡å¥½ï¼Œç­‰ DOMContentLoaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSfxPreload);
} else {
    // DOM å·²å°±ç»ªï¼Œå»¶è¿Ÿä¸€ç‚¹ç¡®ä¿å…¶ä»–è„šæœ¬åŠ è½½å®Œæˆ
    setTimeout(initSfxPreload, 100);
}
// ============================================
// æ’­æ”¾ SFX (æ”¯æŒå¹¶å‘)
// ============================================
/**
 * æ’­æ”¾çŸ­éŸ³æ•ˆ (æ”¯æŒå¹¶å‘)
 * @param {string} key - SFX_CONFIG ä¸­çš„é”®å
 * @param {number} volumeOverride - å¯é€‰çš„éŸ³é‡è¦†ç›– (0.0 - 1.0)
 */
function playSFX(key, volumeOverride = null) {
    // ã€å…¨å±€å¼€å…³ã€‘SFX ç³»ç»Ÿå…³é—­æ—¶ä¸æ’­æ”¾
    if (typeof window !== 'undefined' && window.GAME_SETTINGS && !window.GAME_SETTINGS.enableSFX) {
        return;
    }
    let original = sfxCache[key];
    // ç¼“å­˜æœªå‘½ä¸­æ—¶åŠ¨æ€åŠ è½½
    if (!original && SFX_FILES[key]) {
        const path = getSfxPath(SFX_FILES[key]);
        original = new Audio(path);
        original.volume = SFX_VOLUME_CONFIG[key] || 0.6;
        sfxCache[key] = original;
        console.log(`[SFX] Dynamic load: ${key} -> ${path}`);
    }
    if (!original) {
        console.warn(`[SFX] Unknown key: ${key}`);
        return;
    }
    try {
        const clone = original.cloneNode();
        clone.volume = volumeOverride !== null 
            ? volumeOverride 
            : (SFX_VOLUME_CONFIG[key] || 0.6);
        clone.play().catch(() => {
            // å¿½ç•¥æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶é”™è¯¯
        });
    } catch (e) {
        console.error('[SFX] Play error:', e);
    }
}
/**
 * æ ¹æ®ä¼¤å®³æ•ˆæœæ’­æ”¾å¯¹åº”æ‰“å‡»éŸ³æ•ˆ
 * @param {number} effectiveness - å…‹åˆ¶å€ç‡
 * @param {boolean} isCrit - æ˜¯å¦æš´å‡»
 */
function playHitSFX(effectiveness, isCrit = false) {
    if (isCrit || effectiveness >= 2) {
        playSFX('HIT_SUPER');
    } else if (effectiveness > 0 && effectiveness <= 0.5) {
        playSFX('HIT_WEAK');
    } else {
        playSFX('HIT_NORMAL');
    }
}
// ============================================
// å¯¼å‡ºåˆ°å…¨å±€
// ============================================
window.playSFX = playSFX;
window.playHitSFX = playHitSFX;
window.initSfxPreload = initSfxPreload;
window.SFX_CONFIG = SFX_CONFIG;
window.SFX_FILES = SFX_FILES;
// ============================================
// å®å¯æ¢¦å«å£°ç³»ç»Ÿ
// ============================================
const CRY_VOLUME = 0.45;
/**
 * æ’­æ”¾å®å¯æ¢¦å«å£° (åœ¨çº¿æ‹‰å– Showdown éŸ³é¢‘åº“)
 * @param {string} speciesName - å®å¯æ¢¦åå­— (å¦‚ "Pikachu", "Charizard-Mega-Y")
 */
window.playPokemonCry = function(speciesName) {
    // ã€å…¨å±€å¼€å…³ã€‘SFX ç³»ç»Ÿå…³é—­æ—¶ä¸æ’­æ”¾å«å£°
    if (typeof window !== 'undefined' && window.GAME_SETTINGS && !window.GAME_SETTINGS.enableSFX) {
        return;
    }
    if (!speciesName) return;
    // ä¼˜å…ˆä½¿ç”¨é¢„åŠ è½½ç¼“å­˜
    if (typeof playCachedCry === 'function') {
        playCachedCry(speciesName, CRY_VOLUME);
        return;
    }
    // Fallback: åœ¨çº¿åŠ è½½
    let id = speciesName.toLowerCase().replace(/[^a-z0-9]/g, '');
    if (typeof POKEDEX !== 'undefined' && POKEDEX[id]) {
        if (POKEDEX[id].baseSpecies) {
            id = POKEDEX[id].baseSpecies.toLowerCase().replace(/[^a-z0-9]/g, '');
        }
    }
    const suffixes = ['mega', 'megax', 'megay', 'gmax', 'alola', 'hisui', 'paldea', 'galar'];
    for (const s of suffixes) {
        if (id.endsWith(s) && id.length > s.length) {
            id = id.replace(s, '');
            break;
        }
    }
    const url = `https://play.pokemonshowdown.com/audio/cries/${id}.mp3`;
    const cryAudio = new Audio(url);
    cryAudio.volume = CRY_VOLUME;
    cryAudio.play().catch(() => {});
    console.log(`[CRY] Playing online: ${speciesName} -> ${id}`);
};
]]></file>
        <file name="bgm-system.js"><![CDATA[/**
 * ===========================================
 * BGM-SYSTEM.JS - èƒŒæ™¯éŸ³ä¹ç³»ç»Ÿ
 * ===========================================
 * 
 * æ´›è¿ªäºšç‰¹åŒº BGM ç®¡ç†ç³»ç»Ÿ
 * 
 * èŒè´£:
 * - æˆ˜æ–— BGM é€‰æ‹© (æ ¹æ®ç­‰çº§/è®­ç»ƒå®¶ç±»å‹)
 * - èƒœåˆ©éŸ³ä¹æ’­æ”¾ (é‡ç”Ÿ/è®­ç»ƒå®¶)
 * - åŠ¨æ€åˆ‡æ­Œ (é¦†ä¸»æˆ˜å±æœºæ—¶åˆ»)
 * - éŸ³é¢‘æ·¡å…¥æ·¡å‡º
 */
// ============================================
// BGM èµ„æºç´¢å¼•è¡¨
// ============================================
// è·å–åŸºç¡€è·¯å¾„ (å…¼å®¹ GitHub Pages)
function getBgmBasePath() {
    // ä¼˜å…ˆä½¿ç”¨å…¨å±€ getBasePathï¼ˆç”± index.js å®šä¹‰ï¼‰
    if (typeof window !== 'undefined' && typeof window.getBasePath === 'function') {
        return window.getBasePath();
    }
    const path = window.location.pathname;
    // GitHub Pages: /pkm33/
    if (path.includes('/pkm33/')) {
        return path.substring(0, path.indexOf('/pkm33/') + 7);
    }
    return './';
}
// BGM æ–‡ä»¶åé…ç½®ï¼ˆä¸åŒ…å«è·¯å¾„ï¼Œè·¯å¾„åœ¨æ’­æ”¾æ—¶åŠ¨æ€è·å–ï¼‰
const BGM_FILES = {
    WILD_LOW:     'wild_01_low_unova.mp3',
    WILD_MID:     'wild_02_mid_sinnoh.mp3',
    WILD_HIGH:    'wild_03_ex_areazero.mp3',
    TIER_1:       'battle_01_raw.mp3',
    TIER_2:       'battle_02_standard.mp3',
    TIER_3_MAIN:  'battle_03_gym_main.mp3',
    TIER_3_LAST:  'battle_03_gym_crisis.mp3',
    TIER_4:       'battle_04_elite.mp3',
    TIER_5_BOSS:  'battle_05_legend.mp3',
    WIN_WILD:     'win_01_wild.mp3',
    WIN_TRAINER:  'win_02_trainer.mp3'
};
// åŠ¨æ€è·å– BGM å®Œæ•´è·¯å¾„
function getBgmPath(key) {
    const basePath = getBgmBasePath();
    const filename = BGM_FILES[key];
    return filename ? `${basePath}data/bgm/${filename}` : null;
}
// BGM_INDEX ç°åœ¨å­˜å‚¨ key è€Œä¸æ˜¯å®Œæ•´ URLï¼Œå®é™…è·¯å¾„é€šè¿‡ getBgmPath() åŠ¨æ€è·å–
const BGM_INDEX = {
    WILD_LOW:     'WILD_LOW',
    WILD_MID:     'WILD_MID',
    WILD_HIGH:    'WILD_HIGH',
    TIER_1:       'TIER_1',
    TIER_2:       'TIER_2',
    TIER_3_MAIN:  'TIER_3_MAIN',
    TIER_3_LAST:  'TIER_3_LAST',
    TIER_4:       'TIER_4',
    TIER_5_BOSS:  'TIER_5_BOSS',
    WIN_WILD:     'WIN_WILD',
    WIN_TRAINER:  'WIN_TRAINER'
};
// ============================================
// BGM éŸ³é‡é…ç½®è¡¨ (0.0 - 1.0) - ä½¿ç”¨ key ä½œä¸ºç´¢å¼•
// ============================================
const BGM_VOLUME_CONFIG = {
    'WILD_LOW':     0.25,
    'WILD_MID':     0.28,
    'WILD_HIGH':    0.20,
    'TIER_1':       0.22,
    'TIER_2':       0.25,
    'TIER_3_MAIN':  0.28,
    'TIER_3_LAST':  0.32,
    'TIER_4':       0.30,
    'TIER_5_BOSS':  0.35,
    'WIN_WILD':     0.20,
    'WIN_TRAINER':  0.27
};
// ============================================
// BGM æ’­æ”¾å™¨çŠ¶æ€
// ============================================
const BgmPlayer = {
    currentAudio: null,
    currentKey: null,
    defaultVolume: 0.25,
    // key: BGM_INDEX ä¸­çš„ key (å¦‚ 'WILD_LOW', 'TIER_1')
    play(key, loop = true, fadeInDuration = 500) {
        // ã€å…¨å±€å¼€å…³ã€‘BGM ç³»ç»Ÿå…³é—­æ—¶ä¸æ’­æ”¾
        if (typeof window !== 'undefined' && window.GAME_SETTINGS && !window.GAME_SETTINGS.enableBGM) {
            console.log('[BGM] Disabled by GAME_SETTINGS');
            return;
        }
        // å¦‚æœæ­£åœ¨æ’­æ”¾ç›¸åŒçš„ BGM ä¸”æœªæš‚åœï¼Œè·³è¿‡
        if (this.currentAudio && this.currentKey === key && !this.currentAudio.paused) {
            console.log('[BGM] Already playing:', key);
            return;
        }
        // åŠ¨æ€è·å–å®Œæ•´è·¯å¾„
        const url = getBgmPath(key);
        if (!url) {
            console.warn('[BGM] Unknown key:', key);
            return;
        }
        // åœæ­¢å½“å‰æ’­æ”¾çš„ BGM
        this.stop(0);
        console.log('[BGM] Starting playback:', key, '->', url);
        try {
            this.currentAudio = new Audio(url);
            this.currentKey = key;
            this.currentAudio.loop = loop;
            this.currentAudio.volume = 0;
            const playPromise = this.currentAudio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('[BGM] Playback started successfully');
                }).catch(err => {
                    console.warn('[BGM] Autoplay blocked:', err);
                });
            }
            // ä½¿ç”¨é…ç½®è¡¨ä¸­çš„éŸ³é‡ï¼Œå¦‚æœæ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨é»˜è®¤å€¼
            const targetVolume = BGM_VOLUME_CONFIG[key] || this.defaultVolume;
            this._fadeIn(fadeInDuration, targetVolume);
        } catch (err) {
            console.error('[BGM] Play error:', err);
        }
    },
    stop(fadeOutDuration = 300) {
        if (!this.currentAudio) return;
        if (fadeOutDuration > 0) {
            this._fadeOut(fadeOutDuration, () => {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio = null;
                    this.currentKey = null;
                }
            });
        } else {
            this.currentAudio.pause();
            this.currentAudio = null;
            this.currentKey = null;
        }
    },
    // key: BGM_INDEX ä¸­çš„ key
    crossFade(key, loop = true) {
        if (this.currentKey === key) return;
        const url = getBgmPath(key);
        if (!url) {
            console.warn('[BGM] Unknown key for crossFade:', key);
            return;
        }
        const oldAudio = this.currentAudio;
        try {
            const newAudio = new Audio(url);
            newAudio.loop = loop;
            newAudio.volume = 0;
            newAudio.play().then(() => {
                if (oldAudio) {
                    this._fadeOutAudio(oldAudio, 800, () => {
                        oldAudio.pause();
                    });
                }
                this.currentAudio = newAudio;
                this.currentKey = key;
                const targetVolume = BGM_VOLUME_CONFIG[key] || this.defaultVolume;
                this._fadeIn(800, targetVolume);
            }).catch(err => {
                console.warn('[BGM] åˆ‡æ¢å¤±è´¥:', err.message);
            });
        } catch (e) {
            console.warn('[BGM] åˆ‡æ¢éŸ³é¢‘å¤±è´¥:', e.message);
        }
    },
    setVolume(vol) {
        this.defaultVolume = Math.max(0, Math.min(1, vol));
        if (this.currentAudio) {
            this.currentAudio.volume = this.defaultVolume;
        }
    },
    _fadeIn(duration, targetVolume = null) {
        if (!this.currentAudio) return;
        const startTime = Date.now();
        const volume = targetVolume !== null ? targetVolume : this.defaultVolume;
        const fade = () => {
            if (!this.currentAudio) return;
            const elapsed = Date.now() - startTime;
            const progress = Math.min(1, elapsed / duration);
            this.currentAudio.volume = volume * progress;
            if (progress < 1) requestAnimationFrame(fade);
        };
        requestAnimationFrame(fade);
    },
    _fadeOut(duration, callback) {
        if (!this.currentAudio) {
            if (callback) callback();
            return;
        }
        this._fadeOutAudio(this.currentAudio, duration, callback);
    },
    _fadeOutAudio(audio, duration, callback) {
        const startTime = Date.now();
        const startVolume = audio.volume;
        const fade = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(1, elapsed / duration);
            audio.volume = startVolume * (1 - progress);
            if (progress < 1) {
                requestAnimationFrame(fade);
            } else {
                if (callback) callback();
            }
        };
        requestAnimationFrame(fade);
    }
};
// ============================================
// BGM é€‰æ‹©é€»è¾‘
// ============================================
function getBattleBgm(avgLevel, isTrainer, isCrisis = false) {
    if (!isTrainer) {
        if (avgLevel >= 70) return BGM_INDEX.WILD_HIGH;
        if (avgLevel >= 40) return BGM_INDEX.WILD_MID;
        return BGM_INDEX.WILD_LOW;
    } else {
        if (avgLevel >= 85) return BGM_INDEX.TIER_5_BOSS;
        // Tier 4 (70-84çº§) ä¹Ÿæ”¯æŒå±æœº BGM
        if (avgLevel >= 70) return isCrisis ? BGM_INDEX.TIER_3_LAST : BGM_INDEX.TIER_4;
        // Tier 3 (50-69çº§) æ”¯æŒå±æœº BGM
        if (avgLevel >= 50) return isCrisis ? BGM_INDEX.TIER_3_LAST : BGM_INDEX.TIER_3_MAIN;
        if (avgLevel >= 25) return BGM_INDEX.TIER_2;
        return BGM_INDEX.TIER_1;
    }
}
function getPartyAvgLevel(party) {
    if (!party || party.length === 0) return 1;
    const total = party.reduce((sum, p) => sum + (p.level || p.lv || 1), 0);
    return Math.round(total / party.length);
}
function playBattleBgm() {
    if (typeof battle === 'undefined' || !battle) {
        console.warn('[BGM] battle å¯¹è±¡æœªå®šä¹‰');
        return;
    }
    const enemyParty = battle.enemyParty || [];
    if (enemyParty.length === 0) {
        console.warn('[BGM] æ•Œæ–¹é˜Ÿä¼ä¸ºç©ºï¼Œå»¶è¿Ÿ 100ms é‡è¯•');
        setTimeout(playBattleBgm, 100);
        return;
    }
    const avgLevel = getPartyAvgLevel(enemyParty);
    const isTrainer = battle.trainer && battle.trainer.id !== 'wild';
    const bgmUrl = getBattleBgm(avgLevel, isTrainer, false);
    console.log(`[BGM] æˆ˜æ–—å¼€å§‹ - å¹³å‡ç­‰çº§: ${avgLevel}, è®­ç»ƒå®¶: ${isTrainer}, é˜Ÿä¼æ•°: ${enemyParty.length}`);
    console.log(`[BGM] æ’­æ”¾: ${bgmUrl}`);
    BgmPlayer.play(bgmUrl, true);
}
function checkCrisisBgm() {
    if (typeof battle === 'undefined' || !battle) return;
    const enemyParty = battle.enemyParty || [];
    const avgLevel = getPartyAvgLevel(enemyParty);
    const isTrainer = battle.trainer && battle.trainer.id !== 'wild';
    // åªåœ¨ Tier 3 (50-69çº§) å’Œ Tier 4 (70-84çº§) è§¦å‘å±æœº BGM
    if (!isTrainer || avgLevel < 50 || avgLevel >= 85) return;
    const totalEnemies = enemyParty.length;
    const aliveEnemies = enemyParty.filter(p => p.currHp > 0);
    const aliveCount = aliveEnemies.length;
    // æ ¹æ®é˜Ÿä¼æ€»æ•°å†³å®šè§¦å‘æ—¶æœº
    let shouldTriggerCrisis = false;
    if (totalEnemies <= 2) {
        // 1-2åª: ä¸æ’­æ”¾å±æœº BGM
        shouldTriggerCrisis = false;
    } else if (totalEnemies >= 3 && totalEnemies <= 5) {
        // 3-5åª: æœ€åä¸€åªæ—¶æ’­æ”¾
        shouldTriggerCrisis = (aliveCount === 1);
    } else if (totalEnemies === 6) {
        // 6åª: æœ€åä¸¤åªæ—¶æ’­æ”¾
        shouldTriggerCrisis = (aliveCount <= 2);
    }
    if (shouldTriggerCrisis) {
        const crisisBgm = BGM_INDEX.TIER_3_LAST;
        if (BgmPlayer.currentKey !== crisisBgm) {
            console.log(`[BGM] å±æœºæ—¶åˆ»ï¼é˜Ÿä¼: ${totalEnemies}åª, å‰©ä½™: ${aliveCount}åª, åˆ‡æ¢BGM`);
            BgmPlayer.crossFade(crisisBgm, true);
        }
    }
}
function playVictoryBgm(isTrainerBattle) {
    const bgmUrl = isTrainerBattle ? BGM_INDEX.WIN_TRAINER : BGM_INDEX.WIN_WILD;
    console.log(`[BGM] èƒœåˆ©éŸ³ä¹ - è®­ç»ƒå®¶: ${isTrainerBattle}`);
    BgmPlayer.play(bgmUrl, false, 300);
}
function stopBgm(fadeOut = 500) {
    BgmPlayer.stop(fadeOut);
}
// ============================================
// å¯¼å‡º
// ============================================
if (typeof window !== 'undefined') {
    window.BGM_INDEX = BGM_INDEX;
    window.BgmPlayer = BgmPlayer;
    window.getBattleBgm = getBattleBgm;
    window.getPartyAvgLevel = getPartyAvgLevel;
    window.playBattleBgm = playBattleBgm;
    window.checkCrisisBgm = checkCrisisBgm;
    window.playVictoryBgm = playVictoryBgm;
    window.stopBgm = stopBgm;
}
]]></file>
        <file name="catch-system.js"><![CDATA[/**
 * ===========================================
 * CATCH-SYSTEM.JS - æ•è·ç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - ç²¾çµçƒèœå•æ§åˆ¶
 * - æ•è·æ¦‚ç‡è®¡ç®—
 * - æ•è·åŠ¨ç”»ä¸æµç¨‹
 */
// ============================================
// ç²¾çµçƒèœå•æ§åˆ¶
// ============================================
/**
 * æ‰“å¼€ç²¾çµçƒèœå•
 */
function openBallMenu() {
    const battle = typeof window !== 'undefined' ? window.battle : null;
    if (!battle) return;
    const trainer = battle.trainer;
    const isWild = trainer && (trainer.id === 'wild' || !trainer.id);
    if (battle.locked || !isWild) return;
    const layer = document.getElementById('ball-layer');
    if (layer) layer.classList.remove('hidden');
}
/**
 * å…³é—­ç²¾çµçƒèœå•
 */
function closeBallMenu() {
    const layer = document.getElementById('ball-layer');
    if (layer) layer.classList.add('hidden');
}
// ============================================
// æ•è·é€»è¾‘
// ============================================
/**
 * å°è¯•æ•è·é‡ç”Ÿå®å¯æ¢¦
 * @param {number} ballMultiplier ç²¾çµçƒæ•è·ç‡å€æ•°
 */
async function tryCatch(ballMultiplier = 1) {
    closeBallMenu();
    const battle = typeof window !== 'undefined' ? window.battle : null;
    if (!battle) return;
    const trainer = battle.trainer;
    const isWild = trainer && (trainer.id === 'wild' || !trainer.id);
    if (battle.locked || !isWild) return;
    const enemy = typeof battle.getEnemy === 'function' ? battle.getEnemy() : null;
    if (!enemy || !enemy.isAlive()) {
        log('å½“å‰æ²¡æœ‰å¯æ•æ‰çš„ç›®æ ‡ã€‚');
        return;
    }
    battle.locked = true;
    // æ’­æ”¾æ•è·åŠ¨ç”»
    const sprite = document.getElementById('enemy-sprite');
    if (sprite) {
        sprite.style.transition = 'transform 0.4s ease-in, opacity 0.3s';
        sprite.style.transform = 'scale(0.1) rotate(360deg)';
        sprite.style.opacity = '0';
    }
    log(`ä½ å‘ ${enemy.cnName} æŠ•æ·äº†ç²¾çµçƒï¼`);
    await wait(600);
    // è®¡ç®—æ•è·ç‡
    const catchResult = calculateCatchRate(enemy, ballMultiplier);
    const { finalChance, caught } = catchResult;
    // æ‘‡æ™ƒåŠ¨ç”»
    const shakeLog = async (count) => {
        log(`(ç²¾çµçƒæ‘‡æ™ƒäº† ${count} ä¸‹...)`);
        await wait(600);
    };
    if (!caught) {
        // æ•è·å¤±è´¥
        const breakShakes = finalChance > 0.7 ? 3 : finalChance > 0.4 ? 2 : 1;
        for (let i = 1; i <= breakShakes; i++) {
            await shakeLog(i);
        }
        if (breakShakes >= 3) {
            log("å•Šï¼æ˜æ˜å°±å·®ä¸€ç‚¹ç‚¹äº†ï¼");
        } else {
            log("å¤ªå¯æƒœäº†ï¼çƒç ´å¼€äº†ï¼");
        }
        // æ¢å¤ç²¾çµå›¾
        if (sprite) {
            sprite.style.transition = 'transform 0.35s ease-out, opacity 0.35s';
            sprite.style.transform = 'scale(1) rotate(0deg)';
            sprite.style.opacity = '1';
            sprite.classList.remove('entering');
            setTimeout(() => {
                sprite.style.transition = '';
                sprite.style.transform = '';
                sprite.style.opacity = '';
                sprite.classList.add('entering');
                setTimeout(() => sprite.classList.remove('entering'), 650);
            }, 400);
        }
        await wait(500);
        if (typeof updateAllVisuals === 'function') {
            updateAllVisuals(true);
        }
        if (typeof enemyTurn === 'function') {
            await enemyTurn();
        }
        return;
    }
    // æ•è·æˆåŠŸ
    await shakeLog(1);
    await shakeLog(2);
    await shakeLog(3);
    log("âœ¨ å’šï¼");
    await wait(500);
    const catchColor = (getComputedStyle(document.documentElement).getPropertyValue('--color-catch') || '#4ade80').trim() || '#4ade80';
    log(`<b style="color:${catchColor}">æˆåŠŸæ”¶æœäº† ${enemy.cnName}!</b>`);
    enemy.currHp = 0;
    battle.phase = 'caught';
    await wait(800);
    if (typeof battleEndSequence === 'function') {
        battleEndSequence('caught');
    }
}
/**
 * è®¡ç®—æ•è·ç‡
 * @param {Object} enemy æ•Œæ–¹å®å¯æ¢¦
 * @param {number} ballMultiplier ç²¾çµçƒå€ç‡
 * @returns {Object} { finalChance, caught }
 */
function calculateCatchRate(enemy, ballMultiplier = 1) {
    // è®¡ç®—ç§æ—å€¼æ€»å’Œ
    const statKeys = ['hp', 'atk', 'def', 'spa', 'spd', 'spe'];
    const stats = enemy.baseStats || {};
    let bst = 0;
    statKeys.forEach(key => {
        const val = typeof stats[key] === 'number' ? stats[key] : 50;
        bst += val;
    });
    // åŸºç¡€æ•è·ç‡ï¼ˆç§æ—å€¼è¶Šé«˜è¶Šéš¾æ•è·ï¼‰
    let baseCatchRate = 350 - (bst / 1.8);
    baseCatchRate = Math.max(3, Math.min(255, baseCatchRate));
    // HP å› å­ï¼ˆHP è¶Šä½è¶Šå®¹æ˜“æ•è·ï¼‰
    const hpFactorRaw = ((3 * enemy.maxHp) - (2 * enemy.currHp)) / (3 * Math.max(1, enemy.maxHp));
    const hpFactor = Math.min(1, Math.max(0.1, hpFactorRaw));
    // çŠ¶æ€å› å­ï¼ˆæš‚æœªå®ç°å¼‚å¸¸çŠ¶æ€åŠ æˆï¼‰
    const statusFactor = 1;
    // æœ€ç»ˆæ•è·ç‡
    let finalChance = (baseCatchRate * hpFactor * ballMultiplier * statusFactor) / 255;
    // å¤§å¸ˆçƒä¿è¯æ•è·
    if (ballMultiplier >= 255) {
        finalChance = 2;
    } else {
        finalChance = Math.max(0.02, Math.min(0.95, finalChance));
    }
    // åˆ¤å®šæ˜¯å¦æ•è·æˆåŠŸ
    const caught = finalChance >= 1 || Math.random() <= finalChance;
    return { finalChance, caught, baseCatchRate, hpFactor };
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šç­‰å¾…
 */
function wait(ms) { 
    return new Promise(r => setTimeout(r, ms)); 
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šæ—¥å¿—è¾“å‡º
 */
function log(msg) {
    if (typeof window !== 'undefined' && typeof window.log === 'function') {
        window.log(msg);
    } else {
        console.log(msg);
    }
}
// ============================================
// å¯¼å‡º
// ============================================
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    window.openBallMenu = openBallMenu;
    window.closeBallMenu = closeBallMenu;
    window.tryCatch = tryCatch;
    window.calculateCatchRate = calculateCatchRate;
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        openBallMenu,
        closeBallMenu,
        tryCatch,
        calculateCatchRate
    };
}
]]></file>
        <file name="data-loader.js"><![CDATA[/**
 * ===========================================
 * DATA-LOADER.JS - æ•°æ®åŠ è½½ç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - é»˜è®¤æˆ˜æ–—æ•°æ®
 * - JSON æ•°æ®è§£æä¸åŠ è½½
 * - æˆ˜æ–—åˆå§‹åŒ–æ•°æ®å¤„ç†
 */
// ============================================
// é»˜è®¤æˆ˜æ–—æ•°æ®
// ============================================
/**
 * è·å–é»˜è®¤æˆ˜æ–—æ•°æ® (å½“æ²¡æœ‰å¤–éƒ¨JSONæ³¨å…¥æ—¶ä½¿ç”¨)
 * 
 * æ–°ç‰ˆæ ¼å¼æ”¯æŒï¼š
 * - stats_meta: { ivs: {...}, ev_level: 0~252 }
 * - nature: æ€§æ ¼åç§°
 * - ability: ç‰¹æ€§åç§°
 * - gender: 'M' | 'F' | null
 * - shiny: boolean
 * - mechanic: 'mega' | 'dynamax' | 'zmove' | 'tera' (äº’æ–¥æœºåˆ¶é”)
 * - dynamax_moves: string[] (æå·¨åŒ–æ—¶çš„æ‹›å¼åˆ—è¡¨)
 * - z_move_config: { base_move, target_move, is_unique }
 */
function getDefaultBattleData() {
    return {
  "difficulty": "expert",
  "settings": {
    "enableAVS": true,
    "enableCommander": true,
    "enableEVO": true,
    "enableBGM": true,
    "enableSFX": true,
    "enableClash": true
  },
  "player": {
    "name": "Tester",
    "trainerProficiency": 101,
    "unlocks": {
      "enable_mega": true,
      "enable_z_move": true,
      "enable_styles": true,
      "enable_tera": true,
      "enable_dynamax": true,
      "enable_bond": true
    },
    "party": [
      {
        "slot": 1,
        "name": "Raboot",
        "nickname": "ç‚ç‹(æµ‹è¯•è¿›åŒ–)",
        "species": "Raboot",
        "lv": 36,
        "gender": "M",
        "isLead": true,
        "isAce": true,
        "shiny": false,
        "item": "Charcoal",
        "nature": "Adamant",
        "ability": "Libero",
        "moves": ["Flame Charge", "Double Kick", "Headbutt", "Electro Ball"],
        "stats_meta": { "ev_level": 150 },
        "friendship": {
          "avs": { 
             "trust": 100, 
             "passion": 120, 
             "insight": 50, 
             "devotion": 50 
          }
        },
        "_comment": "Satisfies Life Evolution: Level 36 > EvoLv 35, AVS Sum 320 > 140, isAce=true"
      },
      {
        "slot": 2,
        "name": "Lucario",
        "nickname": "æ³¢å¯¼(æµ‹è¯•å…±é¸£)",
        "species": "Lucario",
        "lv": 50,
        "gender": "M",
        "isAce": true,
        "shiny": true,
        "item": "Expert Belt",
        "nature": "Jolly",
        "ability": "Inner Focus",
        "moves": ["Aura Sphere", "Meteor Mash", "Extreme Speed", "Swords Dance"],
        "stats_meta": { "ev_level": 200 },
        "friendship": {
          "avs": { 
             "trust": 255, 
             "passion": 255, 
             "insight": 255, 
             "devotion": 255 
          }
        },
        "_comment": "Satisfies Bond Resonance: Final Stage, AVS Sum > 220, isAce=true"
      }
    ]
  },
  "enemy": {
    "name": "ACE OPS",
    "type": "ACE_TRAINER",
    "trainerProficiency": 200,
    "unlocks": { "enable_mega": true },
    "party": [
      {
        "name": "Swampert",
        "lv": 45,
        "isLead": true,
        "ability": "Torrent",
        "item": "Rindo Berry",
        "moves": ["Waterfall", "Earthquake", "Ice Punch", "Flip Turn"],
        "stats_meta": { "ev_level": 200 }
      },
      {
        "name": "Salamence",
        "lv": 48,
        "ability": "Intimidate",
        "item": "Salamencite",
        "mechanic": "mega",
        "mega_target": "salamencemega",
        "moves": ["Double-Edge", "Dragon Claw", "Flamethrower", "Roost"],
        "stats_meta": { "ev_level": 220 }
      },
      {
        "name": "Metagross",
        "lv": 52,
        "ability": "Clear Body",
        "item": "Assault Vest",
        "moves": ["Meteor Mash", "Zen Headbutt", "Bullet Punch", "Hammer Arm"],
        "stats_meta": { "ev_level": 250 }
      }
    ],
    "lines": {
      "start": "ä¸è®ºæ˜¯è¿›åŒ–è¿˜æ˜¯ç¾ç»Šï¼Œéƒ½è¦åœ¨æé™ä¸­æ‰èƒ½ç»½æ”¾å…‰èŠ’ï¼æ¥å§ï¼",
      "lose": "å¤šä¹ˆè€€çœ¼çš„å…‰èŠ’â€¦â€¦ï¼",
      "win": "ä½ çš„è§‰æ‚Ÿè¿˜å·®ç‚¹ç«å€™ã€‚"
    }
  }
}
}
// ============================================
// JSON æ•°æ®åŠ è½½
// ============================================
/**
 * ä»å¤–éƒ¨ JSON å­—ç¬¦ä¸²åŠ è½½å¯¹æˆ˜ (ä¾› AI RP è°ƒç”¨)
 * JSON æ ¼å¼:
 * {
 *   "player": { "name": "ä¸»è§’å", "party": [...] },  // å¯é€‰
 *   "trainer": { "name": "è®­ç»ƒå®¶", "id": "xxx", "line": "å°è¯" },
 *   "party": [...],  // æ•Œæ–¹é˜Ÿä¼
 *   "script": "loss" | "win" | null
 * }
 */
function loadBattleFromJSON(jsonString) {
    const battle = typeof window !== 'undefined' ? window.battle : null;
    if (!battle) {
        console.error('[DATA-LOADER] battle object not found');
        return false;
    }
    try {
        const json = typeof jsonString === 'string' ? JSON.parse(jsonString) : jsonString;
        // åŠ è½½ç©å®¶é˜Ÿä¼ (å¦‚æœæœ‰)
        if (json.player && json.player.party) {
            const unlocks = json.player.unlocks || {};
            battle.playerUnlocks = {
                enable_bond: unlocks.enable_bond !== false,
                enable_styles: unlocks.enable_styles !== false,
                enable_insight: unlocks.enable_insight !== false,
                enable_mega: unlocks.enable_mega !== false,
                enable_z_move: unlocks.enable_z_move !== false,
                enable_dynamax: unlocks.enable_dynamax !== false,
                enable_tera: unlocks.enable_tera !== false
            };
            const playerCanMega = battle.playerUnlocks.enable_mega;
            battle.setPlayerParty(json.player.party, playerCanMega);
            battle.playerName = json.player.name || 'ä¸»è§’';
        }
        // åŠ è½½æ•Œæ–¹æ•°æ®
        battle.loadFromJSON(json);
        // æ›´æ–°è§†è§‰
        if (typeof updateAllVisuals === 'function') {
            updateAllVisuals();
        }
        return true;
    } catch (e) {
        console.error('Invalid battle JSON:', e);
        return false;
    }
}
/**
 * è§£æç©å®¶è§£é”é…ç½®
 * @param {Object} unlocks è§£é”é…ç½®å¯¹è±¡
 * @returns {Object} æ ‡å‡†åŒ–çš„è§£é”é…ç½®
 */
function parseUnlocks(unlocks = {}) {
    return {
        enable_bond: unlocks.enable_bond !== false,
        enable_styles: unlocks.enable_styles !== false,
        enable_insight: unlocks.enable_insight !== false,
        enable_mega: unlocks.enable_mega !== false,
        enable_z_move: unlocks.enable_z_move !== false,
        enable_dynamax: unlocks.enable_dynamax !== false,
        enable_tera: unlocks.enable_tera !== false
    };
}
/**
 * è§£æç¯å¢ƒå¤©æ°”é…ç½®
 * 
 * æ–°ç‰ˆ JSON æ ¼å¼:
 * {
 *   "environment": {
 *     "weather": "chronalrift",      // ç¯å¢ƒå¤©æ°” ID
 *     "weatherTurns": 0,             // æŒç»­å›åˆ (0 = æ— é™)
 *     "revertMessage": "...",        // å¤©æ°”å›å½’æ—¶çš„æ¶ˆæ¯
 *     "suppression": {
 *       // æ–¹å¼ä¸€: å…¨å±€è®¾ç½®
 *       "all": "blocked" | "suppressed" | "normal",
 *       // æ–¹å¼äºŒ: æŒ‰å¤©æ°”è®¾ç½® (ä¼˜å…ˆçº§é«˜äº all)
 *       "blocked": ["rain", "sun"],      // å®Œå…¨é˜»æ­¢çš„å¤©æ°”
 *       "suppressed": ["sandstorm"]      // å›åˆå‡åŠçš„å¤©æ°”
 *     },
 *     "effects": { ... }             // ç¯å¢ƒç‰¹æ•ˆå¼€å…³
 *   }
 * }
 * 
 * æ—§ç‰ˆå…¼å®¹:
 * {
 *   "environment": {
 *     "suppressionTier": 3           // 1=normal, 2=suppressed, 3=blocked
 *   }
 * }
 * 
 * @param {Object} envConfig ç¯å¢ƒé…ç½®å¯¹è±¡
 * @returns {Object} æ ‡å‡†åŒ–çš„ç¯å¢ƒé…ç½®
 */
function parseEnvironmentConfig(envConfig = {}) {
    const result = {
        weather: envConfig.weather || null,
        weatherTurns: envConfig.weatherTurns ?? 0,
        revertMessage: envConfig.revertMessage || null,
        suppression: {},
        effects: envConfig.effects || {}
    };
    // è§£æ suppression é…ç½®
    if (envConfig.suppression) {
        const supp = envConfig.suppression;
        // all å­—æ®µ: å…¨å±€è®¾ç½®
        if (supp.all) {
            result.suppression.all = supp.all;
        }
        // blocked æ•°ç»„: å®Œå…¨é˜»æ­¢çš„å¤©æ°”
        if (Array.isArray(supp.blocked)) {
            result.suppression.blocked = supp.blocked.map(w => w.toLowerCase());
        }
        // suppressed æ•°ç»„: å›åˆå‡åŠçš„å¤©æ°”
        if (Array.isArray(supp.suppressed)) {
            result.suppression.suppressed = supp.suppressed.map(w => w.toLowerCase());
        }
    }
    // æ—§ç‰ˆå…¼å®¹: suppressionTier
    else if (envConfig.suppressionTier !== undefined) {
        const tier = envConfig.suppressionTier;
        if (tier === 3) {
            result.suppression.all = 'blocked';
        } else if (tier === 2) {
            result.suppression.all = 'suppressed';
        }
        // tier 1 = normal, ä¸éœ€è¦è®¾ç½®
    }
    console.log('[DATA-LOADER] ç¯å¢ƒé…ç½®è§£æ:', result);
    return result;
}
/**
 * åº”ç”¨ç¯å¢ƒé…ç½®åˆ°æˆ˜æ–—å®ä¾‹
 * @param {Object} battle æˆ˜æ–—å®ä¾‹
 * @param {Object} envConfig ç¯å¢ƒé…ç½® (å·²è§£æ)
 */
function applyEnvironmentConfig(battle, envConfig) {
    if (!battle || !envConfig) return;
    // è®¾ç½®ç¯å¢ƒå¤©æ°”
    if (envConfig.weather) {
        battle.environmentWeather = envConfig.weather;
        battle.environmentConfig = envConfig;
        // å¦‚æœæ²¡æœ‰æ™®é€šå¤©æ°”ï¼Œç¯å¢ƒå¤©æ°”ä¹Ÿä½œä¸ºå½“å‰å¤©æ°”
        if (!battle.weather) {
            battle.weather = envConfig.weather;
            battle.weatherTurns = envConfig.weatherTurns;
        }
        // æ›´æ–°è§†è§‰æ•ˆæœ
        if (typeof window !== 'undefined' && window.setWeatherVisuals) {
            window.setWeatherVisuals(envConfig.weather);
        }
        console.log(`[DATA-LOADER] ç¯å¢ƒå¤©æ°”å·²è®¾ç½®: ${envConfig.weather}`);
    }
}
// ============================================
// ç¯å¢ƒå›¾å±‚ API
// ============================================
/**
 * æ³¨å…¥ç¯å¢ƒå›¾å±‚æ•ˆæœ
 * @param {Object|string} envJSON - ç¯å¢ƒ JSON å¯¹è±¡æˆ–å­—ç¬¦ä¸²
 * @returns {Object|null} è§£æåçš„ç¯å¢ƒå¯¹è±¡
 */
function injectEnvironmentOverlay(envJSON) {
    if (typeof window === 'undefined' || !window.envOverlay) {
        console.error('[ENV OVERLAY] envOverlay æœªåˆå§‹åŒ–');
        return null;
    }
    const env = window.envOverlay.inject(envJSON);
    if (env) {
        console.log(`[ENV OVERLAY] æ³¨å…¥ç¯å¢ƒ: ${env.env_name}`);
    }
    return env;
}
/**
 * æ¸…é™¤æ‰€æœ‰ç¯å¢ƒå›¾å±‚
 */
function clearEnvironmentOverlay() {
    if (typeof window !== 'undefined' && window.envOverlay) {
        window.envOverlay.clear();
        console.log('[ENV OVERLAY] å·²æ¸…é™¤æ‰€æœ‰ç¯å¢ƒ');
    }
}
/**
 * éªŒè¯æˆ˜æ–— JSON æ ¼å¼
 * @param {Object} json æˆ˜æ–—æ•°æ®
 * @returns {Object} { valid: boolean, errors: string[] }
 */
function validateBattleJSON(json) {
    const errors = [];
    if (!json) {
        errors.push('JSON data is null or undefined');
        return { valid: false, errors };
    }
    // æ£€æŸ¥æ•Œæ–¹é˜Ÿä¼
    if (!json.party || !Array.isArray(json.party) || json.party.length === 0) {
        errors.push('Missing or empty enemy party');
    }
    // æ£€æŸ¥æ¯ä¸ªå®å¯æ¢¦çš„å¿…è¦å­—æ®µ
    const checkPokemon = (pokemon, index, side) => {
        if (!pokemon.name) {
            errors.push(`${side} Pokemon #${index + 1}: missing name`);
        }
        if (typeof pokemon.lv !== 'number' || pokemon.lv < 1 || pokemon.lv > 100) {
            errors.push(`${side} Pokemon #${index + 1}: invalid level`);
        }
        if (!pokemon.moves || !Array.isArray(pokemon.moves) || pokemon.moves.length === 0) {
            errors.push(`${side} Pokemon #${index + 1}: missing moves`);
        }
    };
    if (json.party) {
        json.party.forEach((p, i) => checkPokemon(p, i, 'Enemy'));
    }
    if (json.player && json.player.party) {
        json.player.party.forEach((p, i) => checkPokemon(p, i, 'Player'));
    }
    return { valid: errors.length === 0, errors };
}
// ============================================
// å¯¼å‡º
// ============================================
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    window.getDefaultBattleData = getDefaultBattleData;
    window.loadBattleFromJSON = loadBattleFromJSON;
    window.parseUnlocks = parseUnlocks;
    window.parseEnvironmentConfig = parseEnvironmentConfig;
    window.applyEnvironmentConfig = applyEnvironmentConfig;
    window.validateBattleJSON = validateBattleJSON;
    // ç¯å¢ƒå›¾å±‚ API
    window.injectEnvironmentOverlay = injectEnvironmentOverlay;
    window.clearEnvironmentOverlay = clearEnvironmentOverlay;
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        getDefaultBattleData,
        loadBattleFromJSON,
        parseUnlocks,
        parseEnvironmentConfig,
        applyEnvironmentConfig,
        validateBattleJSON,
        injectEnvironmentOverlay,
        clearEnvironmentOverlay
    };
}
]]></file>
        <file name="environment-overlay.js"><![CDATA[/**
 * ===========================================
 * ENVIRONMENT OVERLAY SYSTEM - ç¯å¢ƒå›¾å±‚ç³»ç»Ÿ
 * ===========================================
 * 
 * æ ¸å¿ƒç†å¿µ: è®© AI ç”¨"æ–‡å­¦æè¿°"ç”Ÿæˆ"æ•°å­¦åŸå­"ï¼ŒJS å¼•æ“åªè´Ÿè´£æ‰§è¡Œ
 * 
 * ä¸‰å¤§åŸå­ç±»å‹:
 * - Aç±»: æ•°å€¼ä¿®æ­£ (Stat Mod) - Atk/Def/SpA/SpD/Spd/Acc/Crit/Dmg Ã— N
 * - Bç±»: èµ„æºè·³åŠ¨ (HP/Resource) - HP Â± N% æ¯å›åˆ
 * - Cç±»: ç±»å‹ä¸å…æ§ (Tags) - Immune/Weak/Ban/Grant
 * 
 * JSON åè®®ç¤ºä¾‹:
 * {
 *   "env_id": "radiation_rain",
 *   "env_name": "è¾å°„é…¸é›¨",
 *   "narrative": "è…èš€æ€§çš„ç»¿è‰²é…¸é›¨ä»å¤©è€Œé™...",
 *   "duration": 5,
 *   "rules": [
 *     { "target": "Type:Steel", "eff": ["Def:0.7", "HP:-0.125"] },
 *     { "target": "Type:Poison", "eff": ["Spd:1.5", "HP:0.06"] },
 *     { "target": "MoveType:Fire", "eff": ["Dmg:0.5"] }
 *   ]
 * }
 */
// ============================================
// ç¯å¢ƒå›¾å±‚ç®¡ç†å™¨
// ============================================
class EnvironmentOverlay {
    constructor() {
        this.activeEnvs = [];      // å½“å‰æ¿€æ´»çš„ç¯å¢ƒåˆ—è¡¨
        this.envCounter = 0;       // ç¯å¢ƒ ID è®¡æ•°å™¨
        // æ•ˆæœåŸå­åˆ«åæ˜ å°„ (æ”¯æŒæ¨¡ç³ŠåŒ¹é…)
        this.statAliases = {
            // æ”»å‡»
            'atk': 'atk', 'attack': 'atk', 'æ”»å‡»': 'atk', 'ç‰©æ”»': 'atk',
            // é˜²å¾¡
            'def': 'def', 'defense': 'def', 'é˜²å¾¡': 'def', 'ç‰©é˜²': 'def',
            // ç‰¹æ”»
            'spa': 'spa', 'spatk': 'spa', 'specialattack': 'spa', 'ç‰¹æ”»': 'spa',
            // ç‰¹é˜²
            'spd': 'spd', 'spdef': 'spd', 'specialdefense': 'spd', 'ç‰¹é˜²': 'spd',
            // é€Ÿåº¦
            'spe': 'spe', 'spd': 'spe', 'speed': 'spe', 'é€Ÿåº¦': 'spe',
            // å‘½ä¸­
            'acc': 'accuracy', 'accuracy': 'accuracy', 'å‘½ä¸­': 'accuracy',
            // æš´å‡»
            'crit': 'crit', 'critical': 'crit', 'æš´å‡»': 'crit',
            // ä¼¤å®³
            'dmg': 'dmg', 'damage': 'dmg', 'ä¼¤å®³': 'dmg', 'å¨åŠ›': 'dmg',
            // HP
            'hp': 'hp', 'è¡€é‡': 'hp', 'ç”Ÿå‘½': 'hp'
        };
        // å±æ€§åˆ«åæ˜ å°„
        this.typeAliases = {
            'normal': 'Normal', 'ä¸€èˆ¬': 'Normal',
            'fire': 'Fire', 'ç«': 'Fire',
            'water': 'Water', 'æ°´': 'Water',
            'electric': 'Electric', 'ç”µ': 'Electric',
            'grass': 'Grass', 'è‰': 'Grass',
            'ice': 'Ice', 'å†°': 'Ice',
            'fighting': 'Fighting', 'æ ¼æ–—': 'Fighting',
            'poison': 'Poison', 'æ¯’': 'Poison',
            'ground': 'Ground', 'åœ°é¢': 'Ground',
            'flying': 'Flying', 'é£è¡Œ': 'Flying',
            'psychic': 'Psychic', 'è¶…èƒ½': 'Psychic',
            'bug': 'Bug', 'è™«': 'Bug',
            'rock': 'Rock', 'å²©çŸ³': 'Rock',
            'ghost': 'Ghost', 'å¹½çµ': 'Ghost',
            'dragon': 'Dragon', 'é¾™': 'Dragon',
            'dark': 'Dark', 'æ¶': 'Dark',
            'steel': 'Steel', 'é’¢': 'Steel',
            'fairy': 'Fairy', 'å¦–ç²¾': 'Fairy'
        };
    }
    // ============================================
    // æ ¸å¿ƒ API
    // ============================================
    /**
     * æ³¨å…¥æ–°ç¯å¢ƒ
     * @param {Object|string} envJSON - ç¯å¢ƒ JSON å¯¹è±¡æˆ–å­—ç¬¦ä¸²
     * @returns {Object} è§£æåçš„ç¯å¢ƒå¯¹è±¡
     */
    inject(envJSON) {
        const env = this.parse(envJSON);
        if (!env) {
            console.error('[ENV OVERLAY] ç¯å¢ƒè§£æå¤±è´¥');
            return null;
        }
        // åˆ†é…å”¯ä¸€ ID
        env._id = ++this.envCounter;
        env._startTurn = this._getCurrentTurn();
        this.activeEnvs.push(env);
        console.log(`[ENV OVERLAY] âœ¨ ç¯å¢ƒæ³¨å…¥: ${env.env_name || env.env_id || 'Unknown'}`);
        console.log(`[ENV OVERLAY] è§„åˆ™æ•°: ${env.rules?.length || 0}`);
        return env;
    }
    /**
     * ç§»é™¤ç¯å¢ƒ
     * @param {number|string} envIdOrIndex - ç¯å¢ƒ ID æˆ–ç´¢å¼•
     */
    remove(envIdOrIndex) {
        if (typeof envIdOrIndex === 'number' && envIdOrIndex < 100) {
            // æŒ‰ç´¢å¼•ç§»é™¤
            this.activeEnvs.splice(envIdOrIndex, 1);
        } else {
            // æŒ‰ ID ç§»é™¤
            this.activeEnvs = this.activeEnvs.filter(e => e._id !== envIdOrIndex && e.env_id !== envIdOrIndex);
        }
    }
    /**
     * æ¸…ç©ºæ‰€æœ‰ç¯å¢ƒ
     */
    clear() {
        this.activeEnvs = [];
        console.log('[ENV OVERLAY] æ‰€æœ‰ç¯å¢ƒå·²æ¸…ç©º');
    }
    // ============================================
    // JSON è§£æå™¨ (å®¹é”™è®¾è®¡)
    // ============================================
    /**
     * è§£æç¯å¢ƒ JSON
     * @param {Object|string} input - JSON å¯¹è±¡æˆ–å­—ç¬¦ä¸²
     * @returns {Object|null} è§£æåçš„ç¯å¢ƒå¯¹è±¡
     */
    parse(input) {
        let json;
        // å­—ç¬¦ä¸²è§£æ
        if (typeof input === 'string') {
            try {
                // å°è¯•æå– JSON å— (æ”¯æŒ AI è¾“å‡ºä¸­çš„ ```json ... ```)
                const jsonMatch = input.match(/```(?:json)?\s*([\s\S]*?)```/);
                const jsonStr = jsonMatch ? jsonMatch[1] : input;
                json = JSON.parse(jsonStr.trim());
            } catch (e) {
                console.error('[ENV OVERLAY] JSON è§£æå¤±è´¥:', e.message);
                return null;
            }
        } else {
            json = input;
        }
        if (!json || typeof json !== 'object') {
            return null;
        }
        // æ„å»ºæ ‡å‡†åŒ–ç¯å¢ƒå¯¹è±¡
        const env = {
            env_id: json.env_id || json.id || `env_${Date.now()}`,
            env_name: json.env_name || json.name || json.env_ui_name || 'æœªçŸ¥ç¯å¢ƒ',
            narrative: json.narrative || json.description || '',
            duration: json.duration ?? 0,  // 0 = æ°¸ä¹…
            rules: []
        };
        // è§£æè§„åˆ™
        const rawRules = json.rules || json.effects || [];
        for (const rule of rawRules) {
            const parsed = this._parseRule(rule);
            if (parsed) {
                env.rules.push(parsed);
            }
        }
        return env;
    }
    /**
     * è§£æå•æ¡è§„åˆ™
     * @private
     */
    _parseRule(rule) {
        if (!rule) return null;
        const parsed = {
            target: this._normalizeTarget(rule.target || 'ALL'),
            effects: {
                statMods: {},    // { atk: 1.5, def: 0.7 }
                hpChange: 0,     // æ¯å›åˆ HP å˜åŒ– (æ­£æ•°å›è¡€ï¼Œè´Ÿæ•°æ‰£è¡€)
                hpOnce: 0,       // ä¸€æ¬¡æ€§ HP å˜åŒ–
                dmgMod: 1,       // ä¼¤å®³å€ç‡
                accMod: 1,       // å‘½ä¸­å€ç‡
                critMod: 1,      // æš´å‡»å€ç‡
                critStage: 0,    // æš´å‡»ç­‰çº§åŠ æˆ (+1, +2, -1)
                evasionStage: 0, // é—ªé¿ç­‰çº§åŠ æˆ (+1, +2, -1)
                priorityMod: 0,  // ä¼˜å…ˆåº¦ä¿®æ­£ (+1, -1)
                healMod: 1,      // å›å¤æ•ˆæœå€ç‡ (<1 å‡å¼±, >1 å¢å¼º)
                immuneTypes: [], // å…ç–«å±æ€§
                weakTypes: [],   // è¿½åŠ å¼±ç‚¹
                banTypes: [],    // ç¦ç”¨å±æ€§
                banMoves: [],    // ç¦ç”¨æŠ€èƒ½
                banItems: [],    // ç¦ç”¨é“å…·
                grantTypes: [],  // è·å¾—å±æ€§
                drainMod: 1,     // å¸è¡€æ•ˆç‡ä¿®æ­£ (<1 å‡å¼±, >1 å¢å¼º)
                // ç¯å¢ƒåä¼¤ (å¯¹ç›®æ ‡é€ æˆæ¦‚ç‡åä¼¤)
                envRecoil: null, // { chance: 0.3, damage: 0.1 } = 30%æ¦‚ç‡é€ æˆ10%maxHPåä¼¤
                // çŠ¶æ€æ•ˆæœ
                inflictStatus: null,     // æ–½åŠ çŠ¶æ€: 'burn'/'poison'/'paralysis'/'freeze'/'sleep'/'confusion'/'toxic'
                inflictChance: 0,        // æ–½åŠ æ¦‚ç‡ (0-1)
                immuneStatus: [],        // å…ç–«çŠ¶æ€åˆ—è¡¨
                cureStatus: [],          // æ²»æ„ˆçŠ¶æ€åˆ—è¡¨: [{status: 'frz', chance: 0.5}]
                preventStatus: []        // é˜»æ­¢æ–½åŠ çš„çŠ¶æ€åˆ—è¡¨
            }
        };
        // è§£ææ•ˆæœæ•°ç»„
        const effs = rule.eff || rule.effects || rule.effect_atoms || [];
        const effArray = Array.isArray(effs) ? effs : [effs];
        for (const eff of effArray) {
            this._parseEffect(eff, parsed.effects);
        }
        return parsed;
    }
    /**
     * è§£æå•ä¸ªæ•ˆæœåŸå­
     * @private
     */
    _parseEffect(eff, effects) {
        if (!eff || typeof eff !== 'string') return;
        // æ ¼å¼: "Stat:Value" æˆ– "Stat * Value" æˆ– "Stat x Value"
        // ä¾‹å¦‚: "Atk:1.5", "HP:-0.125", "Immune:Ground", "Ban:Flying"
        const normalized = eff.trim().toLowerCase();
        // ã€ä¼˜å…ˆå¤„ç†ã€‘åŒ¹é…ç¯å¢ƒåä¼¤: "Recoil:0.3" æˆ– "Recoil:0.5:0.15"
        // å¿…é¡»åœ¨é€šç”¨ stat:value åŒ¹é…ä¹‹å‰å¤„ç†ï¼Œå¦åˆ™ä¼šè¢«é”™è¯¯åŒ¹é…
        const recoilMatch = normalized.match(/^(recoil|åä¼¤)\s*[:ï¼š]\s*([\d.]+)(?:\s*[:ï¼š]\s*([\d.]+))?$/i);
        if (recoilMatch) {
            const [, , chanceStr, damageStr] = recoilMatch;
            const chance = Math.max(0, Math.min(1, parseFloat(chanceStr)));
            const damage = damageStr ? Math.max(0, Math.min(0.5, parseFloat(damageStr))) : 0.1; // é»˜è®¤10%
            effects.envRecoil = { chance, damage };
            console.log(`[ENV OVERLAY] è§£æç¯å¢ƒåä¼¤: chance=${chance}, damage=${damage}`);
            return;
        }
        // ã€ä¼˜å…ˆå¤„ç†ã€‘åŒ¹é…å¸è¡€æ•ˆç‡: "Drain:0.5" æˆ– "DrainMod:1.5"
        const drainMatch = normalized.match(/^(drain|drainmod|å¸è¡€)\s*[:ï¼š]\s*([\d.]+)$/i);
        if (drainMatch) {
            const [, , valueStr] = drainMatch;
            effects.drainMod = Math.max(0, Math.min(3, parseFloat(valueStr)));
            console.log(`[ENV OVERLAY] è§£æå¸è¡€æ•ˆç‡: ${effects.drainMod}`);
            return;
        }
        // åŒ¹é… "stat:value" æˆ– "stat*value" æˆ– "stat x value"
        const match = normalized.match(/^([a-z\u4e00-\u9fa5]+)\s*[:*xÃ—]\s*(-?[\d.]+)(:once)?$/i);
        if (match) {
            const [, statRaw, valueStr, once] = match;
            const stat = this._normalizeStat(statRaw);
            const value = parseFloat(valueStr);
            if (isNaN(value)) return;
            // HP å˜åŒ–ç‰¹æ®Šå¤„ç†ï¼šå…è®¸è´Ÿå€¼ï¼ˆæ‰£è¡€ï¼‰ï¼ŒèŒƒå›´ -0.5 ~ 0.5
            if (stat === 'hp') {
                const clampedHP = Math.max(-0.5, Math.min(0.5, value));
                if (once) {
                    effects.hpOnce = clampedHP;
                } else {
                    effects.hpChange = clampedHP;
                }
                return;
            }
            // å…¶ä»–æ•°å€¼é™åˆ¶ (é˜²æ­¢ç ´åå¹³è¡¡)
            const clampedValue = Math.max(0.1, Math.min(10, value));
            if (stat === 'dmg') {
                effects.dmgMod = clampedValue;
            } else if (stat === 'accuracy') {
                effects.accMod = clampedValue;
            } else if (stat === 'crit') {
                effects.critMod = clampedValue;
            } else if (stat === 'heal' || stat === 'å›å¤' || stat === 'æ²»æ„ˆ') {
                // å›å¤æ•ˆæœä¿®æ­£: Heal:0.5 = å›å¤å‡åŠ, Heal:1.5 = å›å¤å¢å¼º
                effects.healMod = clampedValue;
            } else if (['atk', 'def', 'spa', 'spd', 'spe'].includes(stat)) {
                effects.statMods[stat] = clampedValue;
            }
            return;
        }
        // åŒ¹é…ç±»å‹æ•ˆæœ: "Immune:Type", "Weak:Type", "Ban:Type", "Grant:Type"
        const typeMatch = normalized.match(/^(immune|weak|ban|grant|ç¦ç”¨|å…ç–«|å¼±ç‚¹|è·å¾—)\s*[:ï¼š]\s*(.+)$/i);
        if (typeMatch) {
            const [, action, typeRaw] = typeMatch;
            const type = this._normalizeType(typeRaw);
            if (!type) return;
            const actionLower = action.toLowerCase();
            if (actionLower === 'immune' || actionLower === 'å…ç–«') {
                effects.immuneTypes.push(type);
            } else if (actionLower === 'weak' || actionLower === 'å¼±ç‚¹') {
                effects.weakTypes.push(type);
            } else if (actionLower === 'ban' || actionLower === 'ç¦ç”¨') {
                // åˆ¤æ–­æ˜¯ç¦ç”¨å±æ€§è¿˜æ˜¯ç¦ç”¨æŠ€èƒ½
                if (this.typeAliases[typeRaw.toLowerCase()]) {
                    effects.banTypes.push(type);
                } else {
                    effects.banMoves.push(typeRaw);
                }
            } else if (actionLower === 'grant' || actionLower === 'è·å¾—') {
                effects.grantTypes.push(type);
            }
            return;
        }
        // åŒ¹é…é“å…·ç¦ç”¨: "BanItem:Leftovers" æˆ– "BanItem:Berry"
        const banItemMatch = normalized.match(/^(banitem|ç¦ç”¨é“å…·)\s*[:ï¼š]\s*(.+)$/i);
        if (banItemMatch) {
            const [, , itemRaw] = banItemMatch;
            effects.banItems.push(itemRaw.toLowerCase().replace(/[^a-z0-9]/g, ''));
            return;
        }
        // åŒ¹é…ç±»å‹è½¬æ¢: "ToType:Src>Dest" (ä¾‹å¦‚ "ToType:Normal>Electric")
        const toTypeMatch = normalized.match(/^totype\s*[:ï¼š]\s*(\w+)\s*[>â†’]\s*(\w+)$/i);
        if (toTypeMatch) {
            const [, srcRaw, destRaw] = toTypeMatch;
            const srcType = this._normalizeType(srcRaw);
            const destType = this._normalizeType(destRaw);
            if (srcType && destType) {
                if (!effects.typeConversions) {
                    effects.typeConversions = [];
                }
                effects.typeConversions.push({ from: srcType, to: destType });
            }
            return;
        }
        // åŒ¹é…çŠ¶æ€æ–½åŠ : "Status:burn:0.2" æˆ– "Inflict:poison:0.3"
        // æ ¼å¼: Status:çŠ¶æ€å:æ¦‚ç‡ (æ¦‚ç‡å¯é€‰ï¼Œé»˜è®¤1.0)
        const statusMatch = normalized.match(/^(status|inflict|æ–½åŠ )\s*[:ï¼š]\s*(\w+)(?:\s*[:ï¼š]\s*([\d.]+))?$/i);
        if (statusMatch) {
            const [, , statusRaw, chanceStr] = statusMatch;
            const status = this._normalizeStatus(statusRaw);
            if (status) {
                effects.inflictStatus = status;
                effects.inflictChance = chanceStr ? Math.min(1, Math.max(0, parseFloat(chanceStr))) : 1.0;
            }
            return;
        }
        // åŒ¹é…çŠ¶æ€å…ç–«: "ImmuneStatus:burn" æˆ– "NoStatus:poison"
        const immuneStatusMatch = normalized.match(/^(immunestatus|nostatus|å…ç–«çŠ¶æ€)\s*[:ï¼š]\s*(\w+)$/i);
        if (immuneStatusMatch) {
            const [, , statusRaw] = immuneStatusMatch;
            const status = this._normalizeStatus(statusRaw);
            if (status) {
                effects.immuneStatus.push(status);
            }
            return;
        }
        // åŒ¹é…çŠ¶æ€æ²»æ„ˆ: "Cure:burn" æˆ– "Cure:freeze:0.5" (å¸¦æ¦‚ç‡) æˆ– "CureStatus:all"
        const cureMatch = normalized.match(/^(cure|curestatus|æ²»æ„ˆ)\s*[:ï¼š]\s*(\w+)(?:\s*[:ï¼š]\s*([0-9.]+))?$/i);
        if (cureMatch) {
            const [, , statusRaw, chanceStr] = cureMatch;
            const chance = chanceStr ? parseFloat(chanceStr) : 1.0; // é»˜è®¤ 100% æ²»æ„ˆ
            if (statusRaw.toLowerCase() === 'all') {
                const allStatuses = ['brn', 'psn', 'tox', 'par', 'frz', 'slp', 'confusion'];
                allStatuses.forEach(s => effects.cureStatus.push({ status: s, chance }));
            } else {
                const status = this._normalizeStatus(statusRaw);
                if (status) {
                    effects.cureStatus.push({ status, chance });
                }
            }
            return;
        }
        // åŒ¹é…é˜»æ­¢çŠ¶æ€: "Prevent:freeze" æˆ– "Block:burn"
        const preventMatch = normalized.match(/^(prevent|block|é˜»æ­¢)\s*[:ï¼š]\s*(\w+)$/i);
        if (preventMatch) {
            const [, , statusRaw] = preventMatch;
            const status = this._normalizeStatus(statusRaw);
            if (status) {
                effects.preventStatus.push(status);
            }
            return;
        }
        // åŒ¹é…æš´å‡»ç­‰çº§: "CritStage:+1" æˆ– "Crit:+2"
        const critStageMatch = normalized.match(/^(critstage|æš´å‡»ç­‰çº§)\s*[:ï¼š]\s*([+-]?\d+)$/i);
        if (critStageMatch) {
            const [, , stageStr] = critStageMatch;
            effects.critStage = Math.max(-6, Math.min(6, parseInt(stageStr)));
            return;
        }
        // åŒ¹é…é—ªé¿ç­‰çº§: "Evasion:+1" æˆ– "Eva:+2"
        const evasionMatch = normalized.match(/^(evasion|eva|evasionstage|é—ªé¿|é—ªé¿ç­‰çº§)\s*[:ï¼š]\s*([+-]?\d+)$/i);
        if (evasionMatch) {
            const [, , stageStr] = evasionMatch;
            effects.evasionStage = Math.max(-6, Math.min(6, parseInt(stageStr)));
            return;
        }
        // åŒ¹é…ä¼˜å…ˆåº¦: "Priority:+1" æˆ– "Pri:-1"
        const priorityMatch = normalized.match(/^(priority|pri|ä¼˜å…ˆåº¦)\s*[:ï¼š]\s*([+-]?\d+)$/i);
        if (priorityMatch) {
            const [, , prioStr] = priorityMatch;
            effects.priorityMod = Math.max(-7, Math.min(7, parseInt(prioStr)));
            return;
        }
        // æœªè¯†åˆ«çš„æ•ˆæœ
        console.warn(`[ENV OVERLAY] âš ï¸ æ— æ³•è§£ææ•ˆæœ: "${eff}"`);
    }
    /**
     * æ ‡å‡†åŒ–çŠ¶æ€å
     * @private
     */
    _normalizeStatus(raw) {
        if (!raw) return null;
        const key = raw.toString().trim().toLowerCase();
        // è¿”å›å¼•æ“ä½¿ç”¨çš„æ ‡å‡†çŠ¶æ€å (brn, psn, tox, par, frz, slp)
        const statusAliases = {
            // ç¼ä¼¤ -> brn
            'burn': 'brn', 'brn': 'brn', 'ç¼ä¼¤': 'brn', 'çƒ§ä¼¤': 'brn',
            // ä¸­æ¯’ -> psn
            'poison': 'psn', 'psn': 'psn', 'ä¸­æ¯’': 'psn',
            // å‰§æ¯’ -> tox
            'toxic': 'tox', 'tox': 'tox', 'badpoison': 'tox', 'å‰§æ¯’': 'tox',
            // éº»ç—¹ -> par
            'paralysis': 'par', 'par': 'par', 'paralyze': 'par', 'éº»ç—¹': 'par',
            // å†°å†» -> frz
            'freeze': 'frz', 'frz': 'frz', 'frozen': 'frz', 'å†°å†»': 'frz', 'å†»ç»“': 'frz',
            // ç¡çœ  -> slp
            'sleep': 'slp', 'slp': 'slp', 'ç¡çœ ': 'slp',
            // æ··ä¹± -> confusion (volatile, ä¸æ˜¯ä¸»çŠ¶æ€)
            'confusion': 'confusion', 'confuse': 'confusion', 'cnf': 'confusion', 'æ··ä¹±': 'confusion'
        };
        return statusAliases[key] || null;
    }
    /**
     * æ ‡å‡†åŒ–ç›®æ ‡é€‰æ‹©å™¨
     * @private
     * 
     * æ”¯æŒç»„åˆé€‰æ‹©å™¨ (AND é€»è¾‘):
     * - "MoveType:Water+Flag:Contact" = æ°´ç³»æ¥è§¦æŠ€èƒ½
     * - "Type:Fire+HasAbility:FlashFire" = ç«ç³»ä¸”æœ‰å¼•ç«ç‰¹æ€§
     * - "Side:Player+Type:Ghost" = ç©å®¶æ–¹çš„å¹½çµç³»
     */
    _normalizeTarget(target) {
        if (!target) return { type: 'all' };
        const t = target.toString().trim();
        // æ£€æŸ¥ç»„åˆé€‰æ‹©å™¨ (OR é€»è¾‘ï¼Œç”¨ | æˆ– , è¿æ¥) - ä¼˜å…ˆçº§é«˜äº AND
        // ä¾‹å¦‚: "Type:Poison|Type:Steel|Type:Electric" = æ¯’ç³»æˆ–é’¢ç³»æˆ–ç”µç³»
        if (t.includes('|') || (t.includes(',') && !t.includes('+'))) {
            const parts = t.split(/[|,]/).map(p => p.trim()).filter(p => p);
            if (parts.length > 1) {
                const conditions = parts.map(p => this._normalizeTarget(p));
                return { type: 'or', conditions };
            }
        }
        // æ£€æŸ¥ç»„åˆé€‰æ‹©å™¨ (AND é€»è¾‘ï¼Œç”¨ + æˆ– & è¿æ¥)
        // ä¾‹å¦‚: "MoveType:Water+Flag:Contact" = æ°´ç³»ä¸”æ¥è§¦
        if (t.includes('+') || t.includes('&')) {
            const parts = t.split(/[+&]/).map(p => p.trim()).filter(p => p);
            if (parts.length > 1) {
                const conditions = parts.map(p => this._normalizeTarget(p));
                return { type: 'and', conditions };
            }
        }
        // ALL
        if (t.toUpperCase() === 'ALL' || t === 'å…¨éƒ¨' || t === 'æ‰€æœ‰') {
            return { type: 'all' };
        }
        // Type:X
        const typeMatch = t.match(/^type\s*[:ï¼š]\s*(.+)$/i);
        if (typeMatch) {
            return { type: 'pokemonType', value: this._normalizeType(typeMatch[1]) };
        }
        // MoveType:X
        const moveTypeMatch = t.match(/^movetype\s*[:ï¼š]\s*(.+)$/i);
        if (moveTypeMatch) {
            return { type: 'moveType', value: this._normalizeType(moveTypeMatch[1]) };
        }
        // Side:Player / Side:Enemy
        const sideMatch = t.match(/^side\s*[:ï¼š]\s*(player|enemy|ç©å®¶|æ•Œæ–¹)$/i);
        if (sideMatch) {
            const side = sideMatch[1].toLowerCase();
            return { type: 'side', value: (side === 'player' || side === 'ç©å®¶') ? 'player' : 'enemy' };
        }
        // NOT:X
        const notMatch = t.match(/^not\s*[:ï¼š]\s*(.+)$/i);
        if (notMatch) {
            const inner = this._normalizeTarget(notMatch[1]);
            return { type: 'not', inner };
        }
        // HasAbility:X
        const abilityMatch = t.match(/^hasability\s*[:ï¼š]\s*(.+)$/i);
        if (abilityMatch) {
            return { type: 'hasAbility', value: abilityMatch[1] };
        }
        // Flag:X (æŠ€èƒ½æ ‡è®°ï¼Œå¦‚ Contact, Pulse, Sound, Punch, Bite, Slicing, Bullet)
        const flagMatch = t.match(/^flag\s*[:ï¼š]\s*(.+)$/i);
        if (flagMatch) {
            return { type: 'moveFlag', value: flagMatch[1].toLowerCase().trim() };
        }
        // HasItem:X (æŒæœ‰é“å…·)
        const itemMatch = t.match(/^hasitem\s*[:ï¼š]\s*(.+)$/i);
        if (itemMatch) {
            return { type: 'hasItem', value: itemMatch[1].toLowerCase().replace(/[^a-z0-9]/g, '') };
        }
        // Grounded (æ¥åœ°)
        if (t.toLowerCase() === 'grounded' || t === 'æ¥åœ°') {
            return { type: 'grounded' };
        }
        // é»˜è®¤å½“ä½œå±æ€§å¤„ç†
        const maybeType = this._normalizeType(t);
        if (maybeType) {
            return { type: 'pokemonType', value: maybeType };
        }
        return { type: 'all' };
    }
    /**
     * æ ‡å‡†åŒ–å±æ€§å
     * @private
     */
    _normalizeType(raw) {
        if (!raw) return null;
        const key = raw.toString().trim().toLowerCase();
        return this.typeAliases[key] || (key.charAt(0).toUpperCase() + key.slice(1));
    }
    /**
     * æ ‡å‡†åŒ–èƒ½åŠ›å
     * @private
     */
    _normalizeStat(raw) {
        if (!raw) return null;
        const key = raw.toString().trim().toLowerCase();
        return this.statAliases[key] || key;
    }
    /**
     * è·å–å½“å‰å›åˆæ•°
     * @private
     */
    _getCurrentTurn() {
        if (typeof window !== 'undefined' && window.battle) {
            return window.battle.turn || 0;
        }
        return 0;
    }
    // ============================================
    // æ•ˆæœæŸ¥è¯¢ API (ä¾›å¼•æ“è°ƒç”¨)
    // ============================================
    /**
     * è·å–å®å¯æ¢¦çš„æ•°å€¼ä¿®æ­£
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @param {string} statName - èƒ½åŠ›å (atk/def/spa/spd/spe)
     * @returns {number} å€ç‡ (é»˜è®¤ 1, èŒƒå›´ 0.1 ~ 6.0)
     * 
     * ã€å åŠ è§„åˆ™ã€‘å¤šé‡ç¯å¢ƒé‡‡ç”¨ä¹˜ç®—å åŠ  (Multiplicative Stacking)
     * ä¾‹å¦‚: ç¯å¢ƒA Atk:2.0 + ç¯å¢ƒB Atk:0.5 = 2.0 * 0.5 = 1.0
     */
    getStatMod(pokemon, statName) {
        let multiplier = 1;
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, pokemon, null)) {
                    const mod = rule.effects?.statMods?.[statName];
                    if (mod !== undefined) {
                        multiplier *= mod;
                    }
                }
            }
        }
        // ã€å®‰å…¨é™åˆ¶ã€‘é˜²æ­¢æç«¯æ•°å€¼ï¼ŒèŒƒå›´ 0.1 ~ 6.0
        return Math.max(0.1, Math.min(6.0, multiplier));
    }
    /**
     * è·å–æŠ€èƒ½ä¼¤å®³ä¿®æ­£
     * @param {Pokemon} attacker - æ”»å‡»æ–¹
     * @param {Pokemon} defender - é˜²å¾¡æ–¹
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡
     * @returns {number} å€ç‡ (é»˜è®¤ 1, èŒƒå›´ 0.1 ~ 6.0)
     * 
     * ã€å åŠ è§„åˆ™ã€‘å¤šé‡ç¯å¢ƒé‡‡ç”¨ä¹˜ç®—å åŠ  (Multiplicative Stacking)
     */
    getDamageMod(attacker, defender, move) {
        let multiplier = 1;
        const moveType = move?.type || 'Normal';
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                // æ£€æŸ¥ MoveType ç›®æ ‡
                if (rule.target?.type === 'moveType') {
                    if (rule.target.value === moveType) {
                        multiplier *= rule.effects?.dmgMod ?? 1;
                    }
                }
                // æ£€æŸ¥ MoveFlag ç›®æ ‡ (å¦‚ Flag:Contact, Flag:Pulse)
                else if (rule.target?.type === 'moveFlag') {
                    if (this._matchTarget(rule.target, attacker, move)) {
                        multiplier *= rule.effects?.dmgMod ?? 1;
                    }
                }
                // æ£€æŸ¥æ”»å‡»æ–¹å±æ€§
                else if (this._matchTarget(rule.target, attacker, move)) {
                    multiplier *= rule.effects?.dmgMod ?? 1;
                }
            }
        }
        // ã€å®‰å…¨é™åˆ¶ã€‘é˜²æ­¢æç«¯æ•°å€¼ï¼ŒèŒƒå›´ 0.1 ~ 6.0
        return Math.max(0.1, Math.min(6.0, multiplier));
    }
    /**
     * è·å–å›åˆæœ« HP å˜åŒ–
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @returns {number} HP å˜åŒ–é‡ (æ­£æ•°å›è¡€ï¼Œè´Ÿæ•°æ‰£è¡€ï¼ŒåŸºäº maxHp çš„æ¯”ä¾‹)
     */
    getTurnEndHPChange(pokemon) {
        let totalChange = 0;
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, pokemon, null)) {
                    const hpChange = rule.effects?.hpChange ?? 0;
                    if (hpChange !== 0) {
                        totalChange += hpChange;
                    }
                }
            }
        }
        // è¿”å›åŸºäº maxHp çš„å®é™…å˜åŒ–é‡
        if (totalChange !== 0 && pokemon.maxHp) {
            return Math.floor(pokemon.maxHp * totalChange);
        }
        return 0;
    }
    /**
     * è·å–å‘½ä¸­ç‡ä¿®æ­£
     * @param {Pokemon} attacker - æ”»å‡»æ–¹
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡
     * @returns {number} å€ç‡ (é»˜è®¤ 1)
     */
    getAccuracyMod(attacker, move) {
        let multiplier = 1;
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, attacker, null)) {
                    multiplier *= rule.effects?.accMod ?? 1;
                }
            }
        }
        return multiplier;
    }
    /**
     * æ£€æŸ¥æŠ€èƒ½æ˜¯å¦è¢«ç¦ç”¨
     * @param {Pokemon} pokemon - ä½¿ç”¨æŠ€èƒ½çš„å®å¯æ¢¦
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡
     * @returns {boolean} æ˜¯å¦è¢«ç¦ç”¨
     */
    isMoveBanned(pokemon, move) {
        const moveType = move?.type || 'Normal';
        const moveName = move?.name || '';
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                // å…¨å±€ç¦ç”¨æ£€æŸ¥
                if (rule.target?.type === 'all' || this._matchTarget(rule.target, pokemon, null)) {
                    // æ£€æŸ¥å±æ€§ç¦ç”¨
                    if (rule.effects?.banTypes?.includes(moveType)) {
                        return true;
                    }
                    // æ£€æŸ¥æŠ€èƒ½åç¦ç”¨
                    const bannedMoves = rule.effects?.banMoves || [];
                    if (bannedMoves.some(m => m.toLowerCase() === moveName.toLowerCase())) {
                        return true;
                    }
                }
            }
        }
        return false;
    }
    /**
     * è·å–å›å¤æ•ˆæœä¿®æ­£ (Heal Mod)
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @returns {number} å€ç‡ (é»˜è®¤ 1, <1 å‡å¼±å›å¤, >1 å¢å¼ºå›å¤)
     */
    getHealMod(pokemon) {
        let multiplier = 1;
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, pokemon, null)) {
                    const mod = rule.effects?.healMod;
                    if (mod !== undefined) {
                        multiplier *= mod;
                    }
                }
            }
        }
        // é™åˆ¶èŒƒå›´ 0.1 ~ 3.0
        return Math.max(0.1, Math.min(3.0, multiplier));
    }
    /**
     * è·å–ç±»å‹è¦†ç›– (å…ç–«/å¼±ç‚¹)
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @returns {Object} { immuneTypes: [], weakTypes: [], grantTypes: [] }
     */
    getTypeOverrides(pokemon) {
        const result = {
            immuneTypes: [],
            weakTypes: [],
            grantTypes: []
        };
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, pokemon, null)) {
                    result.immuneTypes.push(...(rule.effects?.immuneTypes || []));
                    result.weakTypes.push(...(rule.effects?.weakTypes || []));
                    result.grantTypes.push(...(rule.effects?.grantTypes || []));
                }
            }
        }
        return result;
    }
    /**
     * æ£€æŸ¥é“å…·æ˜¯å¦è¢«ç¦ç”¨
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @param {string} itemId - é“å…· ID
     * @returns {boolean} æ˜¯å¦è¢«ç¦ç”¨
     */
    isItemBanned(pokemon, itemId) {
        if (!itemId) return false;
        const normalizedItem = itemId.toLowerCase().replace(/[^a-z0-9]/g, '');
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, pokemon, null)) {
                    const bannedItems = rule.effects?.banItems || [];
                    // æ”¯æŒç²¾ç¡®åŒ¹é…å’Œç±»åˆ«åŒ¹é… (å¦‚ "berry" åŒ¹é…æ‰€æœ‰æ ‘æœ)
                    for (const banned of bannedItems) {
                        if (normalizedItem === banned) {
                            console.log(`[ENV OVERLAY] ğŸš« é“å…·ç¦ç”¨: ${pokemon.cnName || pokemon.name} çš„ ${itemId} è¢«ç¦ç”¨ (ç²¾ç¡®åŒ¹é…: ${banned})`);
                            return true;
                        }
                        // ç±»åˆ«åŒ¹é…
                        if (banned === 'berry' && normalizedItem.endsWith('berry')) {
                            console.log(`[ENV OVERLAY] ğŸš« é“å…·ç¦ç”¨: ${pokemon.cnName || pokemon.name} çš„ ${itemId} è¢«ç¦ç”¨ (ç±»åˆ«åŒ¹é…: berry)`);
                            return true;
                        }
                        if (banned === 'plate' && normalizedItem.endsWith('plate')) return true;
                        if (banned === 'gem' && normalizedItem.endsWith('gem')) return true;
                    }
                }
            }
        }
        return false;
    }
    /**
     * è·å–å¸è¡€æ•ˆç‡ä¿®æ­£
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡ (å¯é€‰)
     * @returns {number} å€ç‡ (é»˜è®¤ 1, <1 å‡å¼±å¸è¡€, >1 å¢å¼ºå¸è¡€)
     */
    getDrainMod(pokemon, move = null) {
        let multiplier = 1;
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, pokemon, move)) {
                    const mod = rule.effects?.drainMod;
                    if (mod !== undefined) {
                        multiplier *= mod;
                    }
                }
            }
        }
        return Math.max(0, Math.min(3.0, multiplier));
    }
    /**
     * è·å–ç¯å¢ƒåä¼¤æ•ˆæœ (å¯¹æ”»å‡»æ–¹é€ æˆæ¦‚ç‡åä¼¤)
     * @param {Pokemon} attacker - ä½¿ç”¨æŠ€èƒ½çš„å®å¯æ¢¦
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡
     * @returns {Object|null} { chance: number, damage: number } æˆ– null
     */
    getEnvRecoil(attacker, move = null) {
        let result = null;
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                const hasRecoil = rule.effects?.envRecoil;
                if (hasRecoil) {
                    const matched = this._matchTarget(rule.target, attacker, move);
                    console.log(`[ENV OVERLAY] åä¼¤è§„åˆ™æ£€æŸ¥: target=${JSON.stringify(rule.target)}, move=${move?.name}, moveType=${move?.type}, moveFlags=${JSON.stringify(move?.flags)}, matched=${matched}`);
                    if (matched) {
                        const recoil = rule.effects.envRecoil;
                        // å–æœ€é«˜æ¦‚ç‡å’Œä¼¤å®³
                        if (!result) {
                            result = { chance: recoil.chance, damage: recoil.damage };
                        } else {
                            result.chance = Math.max(result.chance, recoil.chance);
                            result.damage = Math.max(result.damage, recoil.damage);
                        }
                    }
                }
            }
        }
        return result;
    }
    /**
     * å°è¯•å¯¹æ”»å‡»æ–¹æ–½åŠ ç¯å¢ƒåä¼¤
     * @param {Pokemon} attacker - ä½¿ç”¨æŠ€èƒ½çš„å®å¯æ¢¦
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡
     * @returns {Object} { applied: boolean, damage: number, log: string|null }
     */
    tryApplyEnvRecoil(attacker, move = null) {
        const recoilConfig = this.getEnvRecoil(attacker, move);
        if (!recoilConfig) {
            return { applied: false, damage: 0, log: null };
        }
        const roll = Math.random();
        if (roll >= recoilConfig.chance) {
            console.log(`[ENV OVERLAY] ç¯å¢ƒåä¼¤åˆ¤å®šå¤±è´¥: ${attacker.cnName || attacker.name}, æ¦‚ç‡=${Math.round(recoilConfig.chance * 100)}%, roll=${roll.toFixed(3)}`);
            return { applied: false, damage: 0, log: null };
        }
        const damage = Math.floor(attacker.maxHp * recoilConfig.damage);
        const chancePercent = Math.round(recoilConfig.chance * 100);
        const damagePercent = Math.round(recoilConfig.damage * 100);
        console.log(`[ENV OVERLAY] ğŸ”¥ ç¯å¢ƒåä¼¤: ${attacker.cnName || attacker.name} å—åˆ° ${damage} ä¼¤å®³ (${damagePercent}% maxHP), æ¦‚ç‡=${chancePercent}%, roll=${roll.toFixed(3)}`);
        return {
            applied: true,
            damage: damage,
            log: `${attacker.cnName || attacker.name} å—åˆ°ç¯å¢ƒåä¼¤ï¼ŒæŸå¤±äº† ${damage} HPï¼`
        };
    }
    /**
     * è·å–æš´å‡»ç­‰çº§åŠ æˆ
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡ (å¯é€‰)
     * @returns {number} æš´å‡»ç­‰çº§åŠ æˆ (-6 ~ +6)
     */
    getCritStage(pokemon, move = null) {
        let stage = 0;
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, pokemon, move)) {
                    stage += rule.effects?.critStage || 0;
                }
            }
        }
        return Math.max(-6, Math.min(6, stage));
    }
    /**
     * è·å–é—ªé¿ç­‰çº§åŠ æˆ
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @returns {number} é—ªé¿ç­‰çº§åŠ æˆ (-6 ~ +6)
     */
    getEvasionStage(pokemon) {
        let stage = 0;
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, pokemon, null)) {
                    stage += rule.effects?.evasionStage || 0;
                }
            }
        }
        return Math.max(-6, Math.min(6, stage));
    }
    /**
     * è·å–ä¼˜å…ˆåº¦ä¿®æ­£
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡
     * @returns {number} ä¼˜å…ˆåº¦ä¿®æ­£ (-7 ~ +7)
     */
    getPriorityMod(pokemon, move) {
        let mod = 0;
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, pokemon, move)) {
                    mod += rule.effects?.priorityMod || 0;
                }
            }
        }
        return Math.max(-7, Math.min(7, mod));
    }
    /**
     * è·å–çŠ¶æ€æ•ˆæœ (æ–½åŠ /å…ç–«/æ²»æ„ˆ/é˜»æ­¢)
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡ (å¯é€‰ï¼Œç”¨äºåˆ¤æ–­æ‹›å¼è§¦å‘)
     * @returns {Object} { inflict: {status, chance}, immuneStatus: [], cureStatus: [], preventStatus: [] }
     */
    getStatusEffects(pokemon, move = null) {
        const result = {
            inflict: null,       // { status: 'burn', chance: 0.2 }
            immuneStatus: [],    // å…ç–«çš„çŠ¶æ€åˆ—è¡¨
            cureStatus: [],      // æ²»æ„ˆçš„çŠ¶æ€åˆ—è¡¨
            preventStatus: []    // é˜»æ­¢æ–½åŠ çš„çŠ¶æ€åˆ—è¡¨
        };
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                if (this._matchTarget(rule.target, pokemon, move)) {
                    // æ–½åŠ çŠ¶æ€
                    if (rule.effects?.inflictStatus && rule.effects?.inflictChance > 0) {
                        // å¤šä¸ªæ–½åŠ æ•ˆæœæ—¶ï¼Œå–æ¦‚ç‡æœ€é«˜çš„
                        if (!result.inflict || rule.effects.inflictChance > result.inflict.chance) {
                            result.inflict = {
                                status: rule.effects.inflictStatus,
                                chance: rule.effects.inflictChance
                            };
                        }
                    }
                    // å…ç–«çŠ¶æ€
                    result.immuneStatus.push(...(rule.effects?.immuneStatus || []));
                    // æ²»æ„ˆçŠ¶æ€ (åˆå¹¶ç›¸åŒçŠ¶æ€ï¼Œå–æœ€é«˜æ¦‚ç‡)
                    const cures = rule.effects?.cureStatus || [];
                    for (const cure of cures) {
                        const existing = result.cureStatus.find(c => c.status === cure.status);
                        if (existing) {
                            existing.chance = Math.max(existing.chance, cure.chance);
                        } else {
                            result.cureStatus.push({ ...cure });
                        }
                    }
                    // é˜»æ­¢çŠ¶æ€
                    result.preventStatus.push(...(rule.effects?.preventStatus || []));
                }
            }
        }
        // å»é‡
        result.immuneStatus = [...new Set(result.immuneStatus)];
        // cureStatus å·²åœ¨ä¸Šé¢å»é‡å¹¶åˆå¹¶æ¦‚ç‡
        result.preventStatus = [...new Set(result.preventStatus)];
        return result;
    }
    /**
     * æ£€æŸ¥æ˜¯å¦é˜»æ­¢æ–½åŠ æŸçŠ¶æ€
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @param {string} status - çŠ¶æ€å
     * @returns {boolean}
     */
    isStatusPrevented(pokemon, status) {
        const effects = this.getStatusEffects(pokemon);
        return effects.preventStatus.includes(status) || effects.immuneStatus.includes(status);
    }
    /**
     * å°è¯•æ–½åŠ ç¯å¢ƒçŠ¶æ€æ•ˆæœ
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡ (å¯é€‰)
     * @returns {Object|null} { status: string, applied: boolean, log: string } æˆ– null
     */
    tryInflictStatus(pokemon, move = null) {
        const effects = this.getStatusEffects(pokemon, move);
        if (!effects.inflict) return null;
        const { status, chance } = effects.inflict;
        // æ£€æŸ¥æ˜¯å¦å…ç–«
        if (this.isStatusPrevented(pokemon, status)) {
            return { status, applied: false, log: `${pokemon.cnName || pokemon.name} å…ç–«äº†${this._getStatusName(status)}ï¼` };
        }
        // æ¦‚ç‡åˆ¤å®š
        if (Math.random() < chance) {
            return { status, applied: true, log: `${pokemon.cnName || pokemon.name} å› ç¯å¢ƒå½±å“é™·å…¥äº†${this._getStatusName(status)}ï¼` };
        }
        return null;
    }
    /**
     * è·å–çŠ¶æ€ä¸­æ–‡å
     * @private
     */
    _getStatusName(status) {
        const names = {
            // æ”¯æŒæ–°æ—§ä¸¤ç§æ ¼å¼
            'burn': 'ç¼ä¼¤', 'brn': 'ç¼ä¼¤',
            'poison': 'ä¸­æ¯’', 'psn': 'ä¸­æ¯’',
            'toxic': 'å‰§æ¯’', 'tox': 'å‰§æ¯’',
            'paralysis': 'éº»ç—¹', 'par': 'éº»ç—¹',
            'freeze': 'å†°å†»', 'frz': 'å†°å†»',
            'sleep': 'ç¡çœ ', 'slp': 'ç¡çœ ',
            'confusion': 'æ··ä¹±'
        };
        return names[status] || status;
    }
    /**
     * è·å–æŠ€èƒ½ç±»å‹è½¬æ¢
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡
     * @returns {string} è½¬æ¢åçš„ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰è½¬æ¢åˆ™è¿”å›åŸç±»å‹
     * 
     * ç”¨æ³•ç¤ºä¾‹: "ToType:Normal>Electric" å°†æ™®é€šç³»æŠ€èƒ½è½¬æ¢ä¸ºç”µç³»
     */
    getMoveTypeConversion(move) {
        const originalType = move?.type || 'Normal';
        for (const env of this.activeEnvs) {
            for (const rule of env.rules || []) {
                const conversions = rule.effects?.typeConversions || [];
                for (const conv of conversions) {
                    if (conv.from === originalType) {
                        console.log(`[ENV OVERLAY] ç±»å‹è½¬æ¢: ${originalType} â†’ ${conv.to}`);
                        return conv.to;
                    }
                }
            }
        }
        return originalType;
    }
    // ============================================
    // ç›®æ ‡åŒ¹é…å™¨
    // ============================================
    /**
     * æ£€æŸ¥ç›®æ ‡æ˜¯å¦åŒ¹é…
     * @param {Object} selector - ç›®æ ‡é€‰æ‹©å™¨
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @param {Object} move - æŠ€èƒ½å¯¹è±¡ (å¯é€‰)
     * @returns {boolean}
     */
    _matchTarget(selector, pokemon, move) {
        if (!selector || !pokemon) return false;
        switch (selector.type) {
            case 'all':
                return true;
            // ç»„åˆé€‰æ‹©å™¨ (AND é€»è¾‘)
            case 'and':
                if (!selector.conditions || !Array.isArray(selector.conditions)) return false;
                return selector.conditions.every(cond => this._matchTarget(cond, pokemon, move));
            // ç»„åˆé€‰æ‹©å™¨ (OR é€»è¾‘)
            case 'or':
                if (!selector.conditions || !Array.isArray(selector.conditions)) return false;
                return selector.conditions.some(cond => this._matchTarget(cond, pokemon, move));
            case 'pokemonType':
                const pokeTypes = pokemon.types || [];
                return pokeTypes.includes(selector.value);
            case 'moveType':
                return move?.type === selector.value;
            case 'side':
                // éœ€è¦ battle ä¸Šä¸‹æ–‡åˆ¤æ–­
                if (typeof window !== 'undefined' && window.battle) {
                    const isPlayer = window.battle.playerParty?.includes(pokemon);
                    return selector.value === 'player' ? isPlayer : !isPlayer;
                }
                return false;
            case 'not':
                return !this._matchTarget(selector.inner, pokemon, move);
            case 'hasAbility':
                const abilityId = (pokemon.ability || '').toLowerCase().replace(/[^a-z]/g, '');
                const targetAbility = (selector.value || '').toLowerCase().replace(/[^a-z]/g, '');
                return abilityId === targetAbility;
            case 'moveFlag':
                // æ£€æŸ¥æŠ€èƒ½æ˜¯å¦å…·æœ‰æŒ‡å®šçš„ flag (å¦‚ contact, pulse, sound, punch, bite, slicing, bullet)
                if (!move) return false;
                const moveFlags = move.flags || {};
                const targetFlag = selector.value;
                return !!moveFlags[targetFlag];
            case 'hasItem':
                // æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦æŒæœ‰æŒ‡å®šé“å…·
                const itemId = (pokemon.item || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                return itemId === selector.value;
            case 'grounded':
                // æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦æ¥åœ°
                return this._isGrounded(pokemon);
            default:
                return false;
        }
    }
    /**
     * æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦æ¥åœ°
     * @private
     */
    _isGrounded(pokemon) {
        if (!pokemon) return false;
        const types = pokemon.types || [];
        const abilityId = (pokemon.ability || '').toLowerCase().replace(/[^a-z]/g, '');
        const itemId = (pokemon.item || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        // é£è¡Œç³»ä¸æ¥åœ°
        if (types.includes('Flying')) return false;
        // æ¼‚æµ®ç‰¹æ€§ä¸æ¥åœ°
        if (abilityId === 'levitate') return false;
        // æ°”çƒä¸æ¥åœ°
        if (itemId === 'airballoon') return false;
        // ç”µç£æµ®æ¸¸çŠ¶æ€ä¸æ¥åœ°
        if (pokemon.volatile?.magnetrise) return false;
        // é¡ºé£é£ç¿”çŠ¶æ€ä¸æ¥åœ°
        if (pokemon.volatile?.telekinesis) return false;
        return true;
    }
    // ============================================
    // å›åˆæœ«å¤„ç†
    // ============================================
    /**
     * å¤„ç†å›åˆæœ«æ•ˆæœ (HP è·³åŠ¨ã€çŠ¶æ€æ²»æ„ˆç­‰)
     * @param {Pokemon} pokemon - å®å¯æ¢¦å®ä¾‹
     * @returns {Object} { hpChange: number, curedStatus: string|null, logs: string[] }
     */
    processTurnEnd(pokemon) {
        const result = {
            hpChange: 0,
            curedStatus: null,
            logs: []
        };
        // 1. HP å˜åŒ–
        const hpDelta = this.getTurnEndHPChange(pokemon);
        if (hpDelta !== 0) {
            result.hpChange = hpDelta;
            if (hpDelta > 0) {
                result.logs.push(`${pokemon.cnName || pokemon.name} å—åˆ°ç¯å¢ƒå½±å“ï¼Œå›å¤äº† ${hpDelta} HPï¼`);
            } else {
                result.logs.push(`${pokemon.cnName || pokemon.name} å—åˆ°ç¯å¢ƒå½±å“ï¼ŒæŸå¤±äº† ${Math.abs(hpDelta)} HPï¼`);
            }
        }
        // 2. çŠ¶æ€æ²»æ„ˆ (æ¦‚ç‡åˆ¤å®š)
        if (pokemon.status) {
            const statusEffects = this.getStatusEffects(pokemon, null);
            if (statusEffects.cureStatus.length > 0) {
                const currentStatus = pokemon.status;
                // æŸ¥æ‰¾å½“å‰çŠ¶æ€çš„æ²»æ„ˆé…ç½®
                const cureConfig = statusEffects.cureStatus.find(c => c.status === currentStatus);
                if (cureConfig) {
                    // æ¦‚ç‡åˆ¤å®š
                    const roll = Math.random();
                    if (roll < cureConfig.chance) {
                        result.curedStatus = currentStatus;
                        const statusName = this._getStatusName(currentStatus);
                        const chancePercent = Math.round(cureConfig.chance * 100);
                        result.logs.push(`${pokemon.cnName || pokemon.name} çš„${statusName}çŠ¶æ€è¢«ç¯å¢ƒæ²»æ„ˆäº†ï¼`);
                        console.log(`[ENV OVERLAY] ğŸ©¹ çŠ¶æ€æ²»æ„ˆ: ${pokemon.cnName || pokemon.name} çš„ ${currentStatus} (${statusName}), æ¦‚ç‡=${chancePercent}%, roll=${roll.toFixed(3)}`);
                    } else {
                        console.log(`[ENV OVERLAY] çŠ¶æ€æ²»æ„ˆåˆ¤å®šå¤±è´¥: ${pokemon.cnName || pokemon.name} çš„ ${currentStatus}, æ¦‚ç‡=${Math.round(cureConfig.chance * 100)}%, roll=${roll.toFixed(3)}`);
                    }
                }
            }
        }
        return result;
    }
    /**
     * å¤„ç†ç¯å¢ƒæŒç»­æ—¶é—´
     */
    tickDuration() {
        const currentTurn = this._getCurrentTurn();
        this.activeEnvs = this.activeEnvs.filter(env => {
            if (env.duration <= 0) return true; // æ°¸ä¹…ç¯å¢ƒ
            const elapsed = currentTurn - (env._startTurn || 0);
            if (elapsed >= env.duration) {
                console.log(`[ENV OVERLAY] â° ç¯å¢ƒç»“æŸ: ${env.env_name}`);
                return false;
            }
            return true;
        });
    }
    // ============================================
    // è°ƒè¯• API
    // ============================================
    /**
     * è·å–å½“å‰æ‰€æœ‰æ¿€æ´»ç¯å¢ƒçš„æ‘˜è¦
     */
    getSummary() {
        return this.activeEnvs.map(env => ({
            id: env._id,
            name: env.env_name,
            rules: env.rules?.length || 0,
            duration: env.duration,
            elapsed: this._getCurrentTurn() - (env._startTurn || 0)
        }));
    }
    /**
     * æ‰“å°è°ƒè¯•ä¿¡æ¯
     */
    debug() {
        console.log('=== Environment Overlay Debug ===');
        console.log('Active Environments:', this.activeEnvs.length);
        for (const env of this.activeEnvs) {
            console.log(`  [${env._id}] ${env.env_name}`);
            for (const rule of env.rules || []) {
                console.log(`    Target: ${JSON.stringify(rule.target)}`);
                console.log(`    Effects:`, rule.effects);
            }
        }
    }
}
// ============================================
// UI æ›´æ–°å‡½æ•°
// ============================================
/**
 * æ›´æ–°ç¯å¢ƒå›¾å±‚ HUD æ˜¾ç¤º
 */
function updateEnvOverlayHUD() {
    if (typeof document === 'undefined') return;
    const hud = document.getElementById('env-overlay-hud');
    const nameEl = document.getElementById('env-overlay-name');
    const descEl = document.getElementById('env-overlay-desc');
    if (!hud) return;
    const envs = envOverlay.activeEnvs;
    if (envs.length === 0) {
        hud.classList.add('hidden');
        return;
    }
    // æ˜¾ç¤ºç¬¬ä¸€ä¸ªç¯å¢ƒï¼ˆæˆ–åˆå¹¶æ˜¾ç¤ºï¼‰
    const env = envs[0];
    if (nameEl) nameEl.textContent = env.env_name || 'ç¯å¢ƒæ•ˆæœ';
    if (descEl) descEl.textContent = env.narrative || `${env.rules?.length || 0} æ¡è§„åˆ™ç”Ÿæ•ˆä¸­`;
    hud.classList.remove('hidden');
}
// ============================================
// å…¨å±€å•ä¾‹ & å¯¼å‡º
// ============================================
const envOverlay = new EnvironmentOverlay();
// é‡å†™ inject æ–¹æ³•ä»¥è‡ªåŠ¨æ›´æ–° UI
const originalInject = envOverlay.inject.bind(envOverlay);
envOverlay.inject = function(envJSON) {
    const result = originalInject(envJSON);
    updateEnvOverlayHUD();
    return result;
};
// é‡å†™ remove å’Œ clear æ–¹æ³•ä»¥è‡ªåŠ¨æ›´æ–° UI
const originalRemove = envOverlay.remove.bind(envOverlay);
envOverlay.remove = function(envIdOrIndex) {
    originalRemove(envIdOrIndex);
    updateEnvOverlayHUD();
};
const originalClear = envOverlay.clear.bind(envOverlay);
envOverlay.clear = function() {
    originalClear();
    updateEnvOverlayHUD();
};
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    window.envOverlay = envOverlay;
    window.EnvironmentOverlay = EnvironmentOverlay;
    window.updateEnvOverlayHUD = updateEnvOverlayHUD;
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { EnvironmentOverlay, envOverlay };
}
export { EnvironmentOverlay, envOverlay };
]]></file>
        <file name="growth-system.js"><![CDATA[/**
 * ===========================================
 * GROWTH SYSTEM - åŠ¨æ¼«é£æ ¼ç­‰çº§å»ºè®®ç³»ç»Ÿ
 * ===========================================
 * 
 * åŸºäº"æˆ˜åŠŸ"å’Œ"æˆå‰§æ€§"è®¡ç®—æˆé•¿æ½œåŠ›ç³»æ•°
 * ä¸å†è®¡ç®—å…·ä½“ EXP æ•°å€¼ï¼Œè€Œæ˜¯ç»™å‡º"æé™çªç ´"å»ºè®®
 * 
 * è®¾è®¡æ€è·¯ï¼š
 * - è™èœ (Stomp) -> å‡ ä¹æ— æˆé•¿ (+0 ~ +1 Lv)
 * - è‹¦æˆ˜ (Clutch) -> é«˜æˆé•¿ (+2 ~ +3 Lv)
 * - ä¸‹å…‹ä¸Š (Underdog) -> æé™çˆ†å‘ (+5 Lv ä»¥ä¸Š)
 */
/**
 * æ ¸å¿ƒé€»è¾‘ï¼šç»éªŒå»ºè®®è®¡ç®—å™¨
 * @param {object} analysis - åŒ…å« rank, hpHealth, levelDiff, resultLabel çš„åˆ†æå¯¹è±¡
 * @param {string} result - 'win' | 'loss' | 'escape' | 'caught'
 * @returns {object} { val: number, reason: string, distribution: string[] }
 */
function calculateAnimeGrowth(analysis, result) {
    const battle = window.battle;
    if (!battle) {
        return { val: 0, reason: 'æ— æ³•è·å–æˆ˜æ–—æ•°æ®ã€‚', distribution: [] };
    }
    const pParty = battle.playerParty || [];
    const eParty = battle.enemyParty || [];
    if (pParty.length === 0) {
        return { val: 0, reason: 'æ— æ³•è·å–é˜Ÿä¼æ•°æ®ã€‚', distribution: [] };
    }
    // åŸºç¡€æˆé•¿å€¼
    let levels = 0;
    // =========================================================
    // 1. ç»“æœåŸºç¡€åˆ†ï¼ˆé™ä½åŸºç¡€å€¼ï¼‰
    // =========================================================
    if (result === 'win') {
        levels += 0.3; // é™ä½åŸºç¡€å€¼ï¼Œé¿å…é€šè´§è†¨èƒ€
    } else if (result === 'loss') {
        levels += 0.2; // å³ä½¿è¾“äº†ï¼Œä¹Ÿæ˜¯å¾ˆå¥½çš„æ•™è®­
    } else if (result === 'caught') {
        levels += 0.2; // æ•è·æˆ˜æ–—é€šå¸¸ä¸æ˜¯é«˜å¼ºåº¦å¯¹å†³
    } else if (result === 'escape') {
        levels += 0; // é€ƒè·‘æ²¡æœ‰æˆé•¿
    }
    // =========================================================
    // 2. å¯¹æ‰‹å¼ºåº¦æƒé‡ (Bossæˆ˜åŠ æˆ)
    // =========================================================
    const isBoss = battle.aiDifficulty === 'expert' || battle.aiDifficulty === 'hard';
    const isTrainer = battle.trainer && battle.trainer.id !== 'wild';
    const isEliteFour = battle.trainer && (
        battle.trainer.title?.includes('å››å¤©ç‹') ||
        battle.trainer.title?.includes('Elite') ||
        battle.trainer.title?.includes('Champion') ||
        battle.trainer.title?.includes('å† å†›')
    );
    if (isEliteFour) {
        levels += 3; // å››å¤©ç‹/å† å†›çº§åˆ«
    } else if (isBoss) {
        levels += 2; // æ‰“å¼ºæ•Œä¸ç®¡è¾“èµ¢éƒ½è¡€èµš
    } else if (isTrainer) {
        levels += 1;
    }
    // =========================================================
    // 3. ç­‰çº§è·ƒè¿ï¼šä½ è¶Šå¼±ï¼Œä½ è¶Šå¼ºï¼ˆæ‰©å±•åˆ¤å®šï¼‰
    // =========================================================
    const avgPLv = pParty.reduce((sum, p) => sum + (p.level || p.lv || 1), 0) / Math.max(1, pParty.length);
    const avgELv = eParty.reduce((sum, p) => sum + (p.level || p.lv || 1), 0) / Math.max(1, eParty.length);
    const levelDiff = avgELv - avgPLv;
    // æ•Œæ–¹ç­‰çº§æ›´é«˜ï¼ˆä¸‹å…‹ä¸Šï¼‰
    if (levelDiff >= 30) {
        levels += 7; // è·¨è¶Š30çº§çš„æŒ‘æˆ˜ï¼Œç®€ç›´æ˜¯ç¥è¯
    } else if (levelDiff >= 20) {
        levels += 5; // è·¨è¶Š20çº§çš„æŒ‘æˆ˜ï¼Œç®€ç›´æ˜¯ç¥è¿¹
    } else if (levelDiff >= 10) {
        levels += 3;
    } else if (levelDiff >= 5) {
        levels += 1.5;
    } else if (levelDiff >= 3) {
        levels += 0.5; // å°å¹…é¢†å…ˆ
    }
    // åŒçº§åˆ«æˆ–æˆ‘æ–¹ç•¥é«˜ï¼ˆæ­£å¸¸æˆé•¿ï¼‰
    else if (levelDiff >= -2 && levelDiff < 3) {
        levels += 0; // åŠ¿å‡åŠ›æ•Œï¼ŒåŸºç¡€åˆ†å·²ç»™
    }
    // æˆ‘æ–¹ç­‰çº§æ›´é«˜ï¼ˆè™èœæƒ©ç½šï¼‰
    else if (levelDiff >= -5) {
        levels -= 0.3; // è½»å¾®è™èœ
    } else if (levelDiff >= -10) {
        levels -= 0.6; // è™èœ
    } else if (levelDiff >= -20) {
        levels -= 1.2; // ä¸¥é‡è™èœ
    } else if (levelDiff < -20) {
        levels -= 2; // æç«¯è™èœï¼ˆ-30çº§ä»¥ä¸Šï¼‰
    }
    // =========================================================
    // 4. æˆå‰§æ€§å› å­ (Drama Factor)
    // =========================================================
    const hpHealth = analysis.hpHealth || 0;
    const rank = analysis.rank || '';
    // æ¿’æ­»åæ€ï¼Ÿ(æˆ‘æ–¹å¾ˆæƒ¨ä¸”èµ¢äº†)
    if (result === 'win' && hpHealth < 10) {
        levels += 2; // æåº¦æ®‹è¡€åæ€ï¼ˆ<10%ï¼‰ï¼Œçªç ´æé™çš„è¯æ˜
    } else if (result === 'win' && hpHealth < 20) {
        levels += 1.5; // æ®‹è¡€åæ€ï¼ˆ<20%ï¼‰
    } else if (result === 'win' && hpHealth < 40) {
        levels += 0.5; // æ®‹è¡€é™©èƒœï¼ˆ<40%ï¼‰
    }
    // æ— ä¼¤ï¼Ÿ(Rank S+)
    if (rank && rank.startsWith('S')) {
        // æ— ä¼¤åè€Œè¯´æ˜å­¦ä¸åˆ°å¤ªå¤šä¸œè¥¿ï¼ˆå› ä¸ºå¤ªè½»æ¾ï¼‰ï¼Œé™¤éå¯¹é¢ç­‰çº§å¾ˆé«˜
        if (levelDiff > 10) {
            levels += 2; // é«˜è¶…æŠ€å·§ç¢¾å‹å¼ºæ•Œ
        } else if (levelDiff > 0) {
            levels += 1; // æŠ€å·§å–èƒœ
        } else {
            levels = Math.max(0, levels - 1); // è¿™ä¸ªå«ç‚¸é±¼
        }
    }
    // ç»å¢ƒåæ€ç‰¹æ®ŠåŠ æˆ
    if (rank && rank.includes('ç»å¢ƒåæ€')) {
        levels += 2;
    }
    // æ­»æ–—/è‹¦æˆ˜åŠ æˆ
    if (rank && (rank.includes('æ­»æ–—') || rank.includes('è‹¦æˆ˜'))) {
        levels += 1;
    }
    // =========================================================
    // 5. æœºåˆ¶æŒæ¡åŠ æˆ
    // =========================================================
    if (battle.playerMegaUsed) levels += 0.5;
    if (battle.playerZUsed) levels += 0.5;
    if (battle.playerMaxUsed) levels += 0.5;
    if (battle.playerTeraUsed) levels += 0.5;
    if (battle.playerBondUsed) levels += 1.5; // ç¾ç»Šè¿›åŒ–è¯æ˜äº†å¿ƒçµçš„æˆé•¿
    // =========================================================
    // 6. å¯¹å†²ç³»ç»Ÿä½¿ç”¨åŠ æˆ
    // =========================================================
    if (battle.clashCount && battle.clashCount > 0) {
        levels += Math.min(1, battle.clashCount * 0.3); // å¯¹å†²æ¬¡æ•°åŠ æˆï¼Œä¸Šé™1çº§
    }
    // =========================================================
    // 7. é‡ç”Ÿæˆ˜æ–—å‰Šå¼±ï¼ˆÃ—0.6ï¼‰
    // =========================================================
    if (!isTrainer && result !== 'caught') {
        levels *= 0.6; // é‡ç”Ÿæˆ˜æ–—ç»éªŒå‰Šå¼±40%
        console.log('[GROWTH] é‡ç”Ÿæˆ˜æ–—å‰Šå¼±: Ã—0.6');
    }
    // =========================================================
    // æ ¼å¼åŒ–è¾“å‡º
    // =========================================================
    levels = Math.max(0, levels);
    const rawGain = Math.ceil(levels);
    // ç”Ÿæˆè¯„ä¼°æ–‡æ¡ˆ
    let reason = 'æ—¥å¸¸çš„è®­ç»ƒç§¯ç´¯ã€‚';
    if (rawGain >= 10) {
        reason = 'è¶…è¶Šç¥è¯çš„å£®ä¸¾ï¼è¿ä¼ è¯´ä¸­çš„å®å¯æ¢¦éƒ½ä¼šä¸ºä¹‹ä¾§ç›®ï¼';
    } else if (rawGain >= 8) {
        reason = 'çµé­‚æ·±å¤„çš„è§‰é†’ï¼æ‰“ç ´äº†ç”Ÿç‰©å­¦çš„ç•Œé™ï¼';
    } else if (rawGain >= 5) {
        reason = 'ç”šè‡³è¿åŸºå› åºåˆ—éƒ½å¾—åˆ°äº†å‡åçš„æ­»æ–—æˆé•¿ï¼';
    } else if (rawGain >= 3) {
        reason = 'é€šè¿‡è¿™ä¸€æˆ˜ï¼Œç†è§£äº†å®å¯æ¢¦æˆ˜æ–—çš„çœŸè°›ã€‚';
    } else if (rawGain === 2) {
        reason = 'åœ¨å®æˆ˜ä¸­è·å¾—äº†æ˜¾è‘—çš„æˆé•¿ã€‚';
    } else if (rawGain === 1) {
        reason = 'ç§¯ç´¯äº†å®è´µçš„å®æˆ˜ç»éªŒã€‚';
    } else {
        reason = 'è¿™ç§ç¨‹åº¦çš„å¯¹æ‰‹ï¼Œå·²ç»èµ·ä¸åˆ°é”»ç‚¼æ•ˆæœäº†ã€‚';
    }
    // =========================================================
    // é˜Ÿä¼åˆ†é…å»ºè®®
    // =========================================================
    const distribution = [];
    if (rawGain > 0) {
        pParty.forEach(p => {
            const pName = p.cnName || p.name || '???';
            const isFallen = p.currHp <= 0;
            // å€’ä¸‹çš„å®å¯æ¢¦è·å¾—ä¸€åŠç»éªŒï¼ˆä½†è‡³å°‘1çº§å¦‚æœæœ‰ç»éªŒçš„è¯ï¼‰
            let pokeGain = rawGain;
            if (isFallen && rawGain > 1) {
                pokeGain = Math.max(1, Math.floor(rawGain * 0.5));
                distribution.push(`${pName}(+${pokeGain})[è´¥æˆ˜]`);
            } else if (isFallen && rawGain === 1) {
                distribution.push(`${pName}(+0)[è´¥æˆ˜]`);
            } else {
                distribution.push(`${pName}(+${pokeGain})`);
            }
        });
    }
    return {
        val: rawGain,
        reason: reason,
        distribution: distribution,
        levelDiff: Math.round(levelDiff),
        avgPlayerLevel: Math.round(avgPLv),
        avgEnemyLevel: Math.round(avgELv)
    };
}
/**
 * ç”Ÿæˆæˆé•¿å»ºè®®æ–‡æœ¬å—ï¼ˆç”¨äºæ’å…¥æˆ˜æŠ¥ï¼‰
 * @param {object} growth - calculateAnimeGrowth çš„è¿”å›å€¼
 * @returns {string[]} æ–‡æœ¬è¡Œæ•°ç»„
 */
function formatGrowthReport(growth) {
    const rows = [];
    rows.push('');
    rows.push('<GROWTH_SUGGESTION>');
    rows.push(`ã€âš”ï¸ æˆé•¿å»ºè®® Systemã€‘: +${growth.val} LEVELS`);
    rows.push(`  > ç­‰çº§å·®: æˆ‘æ–¹ Lv.${growth.avgPlayerLevel} vs æ•Œæ–¹ Lv.${growth.avgEnemyLevel} (å·®è·: ${growth.levelDiff > 0 ? '+' : ''}${growth.levelDiff})`);
    rows.push(`  > è¯„ä¼°é€»è¾‘: ${growth.reason}`);
    if (growth.distribution && growth.distribution.length > 0) {
        rows.push(`  > é˜Ÿä¼åˆ†é…å»ºè®®: ${growth.distribution.join('ã€')}`);
    }
    rows.push('</GROWTH_SUGGESTION>');
    return rows;
}
// å¯¼å‡ºåˆ°å…¨å±€
window.calculateAnimeGrowth = calculateAnimeGrowth;
window.formatGrowthReport = formatGrowthReport;
console.log('[GROWTH SYSTEM] åŠ¨æ¼«é£æ ¼ç­‰çº§å»ºè®®ç³»ç»Ÿå·²åŠ è½½');
]]></file>
        <file name="preloader.js"><![CDATA[/**
 * ===========================================
 * PRELOADER.JS - èµ„æºé¢„åŠ è½½ç³»ç»Ÿ
 * ===========================================
 */
const PreloadCache = {
    sprites: {},
    cries: {},
    bgm: {},
    sfx: {},
    trainerAvatars: {},
    pokemonIcons: {}
};
// è·å–åŸºç¡€è·¯å¾„ (å…¼å®¹ GitHub Pages)
function getPreloadBasePath() {
    // å¦‚æœå·²æœ‰å…¨å±€ getBasePathï¼Œä½¿ç”¨å®ƒ
    if (typeof window !== 'undefined' && typeof window.getBasePath === 'function') {
        return window.getBasePath();
    }
    const path = window.location.pathname;
    // GitHub Pages: /repo-name/
    if (path.includes('/pkm33/')) {
        return path.substring(0, path.indexOf('/pkm33/') + 7);
    }
    return './';
}
// æœ¬åœ°èµ„æºè·¯å¾„é…ç½®ï¼ˆåŠ¨æ€è·å–åŸºç¡€è·¯å¾„ï¼‰
function getLocalResources() {
    const basePath = getPreloadBasePath();
    return {
        avatarPath: `${basePath}data/avatar/`,
        bgmPath: `${basePath}data/bgm/`,
        sfxPath: `${basePath}data/sfx/`,
        // BGM æ–‡ä»¶åˆ—è¡¨
        bgmFiles: LOCAL_RESOURCE_FILES.bgm,
        // SFX æ–‡ä»¶åˆ—è¡¨
        sfxFiles: LOCAL_RESOURCE_FILES.sfx,
        // è®­ç»ƒå®¶å¤´åƒåˆ—è¡¨
        avatarFiles: LOCAL_RESOURCE_FILES.avatars
    };
}
// é™æ€æ–‡ä»¶åˆ—è¡¨ï¼ˆä¸ä¾èµ–è·¯å¾„ï¼‰
const LOCAL_RESOURCE_FILES = {
    // BGM æ–‡ä»¶åˆ—è¡¨
    bgm: [
        'battle_01_raw', 'battle_02_standard', 'battle_03_gym_crisis', 'battle_03_gym_main',
        'battle_04_elite', 'battle_05_legend', 'wild_01_low_unova', 'wild_02_mid_sinnoh',
        'wild_03_ex_areazero', 'win_01_wild', 'win_02_trainer'
    ],
    // SFX æ–‡ä»¶åˆ—è¡¨
    sfx: [
        'Hit_Super_Effective_XY', 'ball_open', 'ball_throw', 'battle_faint', 'battle_heal',
        'hit_00_normal', 'hit_02_weak', 'stat_down', 'stat_up', 'ui_01_confirm'
    ],
    // è®­ç»ƒå®¶å¤´åƒåˆ—è¡¨
    avatars: [
        'akari', 'bea', 'cynthia', 'dawn', 'erika', 'gloria', 'hexmaniac', 'iono',
        'irida', 'juliana', 'lana', 'lillie', 'lusamine', 'mallow', 'marnie', 'nessa',
        'rosa', 'roxie', 'selene', 'serena', 'sonia'
    ]
};
/**
 * é¢„åŠ è½½ç²¾çµå›¾
 */
function preloadSprite(name, isBack = false) {
    return new Promise((resolve) => {
        // ä½¿ç”¨ä¸ battle-engine.js resolveSpriteId ç›¸åŒçš„æ ¼å¼ï¼ˆä¿ç•™æ¨ªæ ï¼‰
        const id = name.toLowerCase().replace(/[^a-z0-9-]/g, '');
        const cacheKey = `${id}_${isBack ? 'back' : 'front'}`;
        if (PreloadCache.sprites[cacheKey]) {
            resolve(PreloadCache.sprites[cacheKey]);
            return;
        }
        const folder = isBack ? 'ani-back' : 'ani';
        const url = `https://play.pokemonshowdown.com/sprites/${folder}/${id}.gif`;
        const img = new Image();
        img.onload = () => {
            PreloadCache.sprites[cacheKey] = img;
            resolve(img);
        };
        img.onerror = () => resolve(null);
        img.src = url;
        setTimeout(() => resolve(null), 5000);
    });
}
/**
 * é¢„åŠ è½½å«å£°
 */
function preloadCry(name) {
    return new Promise((resolve) => {
        let id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
        if (typeof POKEDEX !== 'undefined' && POKEDEX[id] && POKEDEX[id].baseSpecies) {
            id = POKEDEX[id].baseSpecies.toLowerCase().replace(/[^a-z0-9]/g, '');
        }
        const suffixes = ['mega', 'megax', 'megay', 'gmax', 'alola', 'hisui', 'paldea', 'galar'];
        for (const s of suffixes) {
            if (id.endsWith(s) && id.length > s.length) {
                id = id.replace(s, '');
                break;
            }
        }
        if (PreloadCache.cries[id]) {
            resolve(PreloadCache.cries[id]);
            return;
        }
        const url = `https://play.pokemonshowdown.com/audio/cries/${id}.mp3`;
        const audio = new Audio();
        audio.preload = 'auto';
        audio.oncanplaythrough = () => {
            PreloadCache.cries[id] = audio;
            resolve(audio);
        };
        audio.onerror = () => resolve(null);
        audio.src = url;
        setTimeout(() => resolve(null), 5000);
    });
}
/**
 * é¢„åŠ è½½è®­ç»ƒå®¶å¤´åƒ
 */
function preloadTrainerAvatar(trainerId) {
    return new Promise((resolve) => {
        if (!trainerId || trainerId === 'wild') {
            resolve(null);
            return;
        }
        if (PreloadCache.trainerAvatars[trainerId]) {
            resolve(PreloadCache.trainerAvatars[trainerId]);
            return;
        }
        // ä¿®å¤è·¯å¾„: data/trainers -> data/avatar
        const resources = getLocalResources();
        const url = `${resources.avatarPath}${trainerId}.png`;
        const img = new Image();
        img.onload = () => {
            PreloadCache.trainerAvatars[trainerId] = img;
            console.log(`[PRELOAD] Trainer avatar loaded: ${trainerId}`);
            resolve(img);
        };
        img.onerror = () => {
            console.warn(`[PRELOAD] Failed to load trainer avatar: ${trainerId}`);
            resolve(null);
        };
        img.src = url;
        setTimeout(() => resolve(null), 3000);
    });
}
/**
 * é¢„åŠ è½½æœ¬åœ° BGM
 */
function preloadBGM(bgmId) {
    return new Promise((resolve) => {
        if (PreloadCache.bgm[bgmId]) {
            resolve(PreloadCache.bgm[bgmId]);
            return;
        }
        const resources = getLocalResources();
        const url = `${resources.bgmPath}${bgmId}.mp3`;
        const audio = new Audio();
        audio.preload = 'auto';
        audio.oncanplaythrough = () => {
            PreloadCache.bgm[bgmId] = audio;
            console.log(`[PRELOAD] BGM loaded: ${bgmId}`);
            resolve(audio);
        };
        audio.onerror = () => {
            console.warn(`[PRELOAD] Failed to load BGM: ${bgmId}`);
            resolve(null);
        };
        audio.src = url;
        setTimeout(() => resolve(null), 10000);
    });
}
/**
 * é¢„åŠ è½½æœ¬åœ° SFX
 */
function preloadSFX(sfxId) {
    return new Promise((resolve) => {
        if (PreloadCache.sfx[sfxId]) {
            resolve(PreloadCache.sfx[sfxId]);
            return;
        }
        const resources = getLocalResources();
        const url = `${resources.sfxPath}${sfxId}.mp3`;
        const audio = new Audio();
        audio.preload = 'auto';
        audio.oncanplaythrough = () => {
            PreloadCache.sfx[sfxId] = audio;
            resolve(audio);
        };
        audio.onerror = () => resolve(null);
        audio.src = url;
        setTimeout(() => resolve(null), 5000);
    });
}
/**
 * é¢„åŠ è½½æ‰€æœ‰æœ¬åœ° BGM å’Œ SFX
 */
async function preloadAllLocalAudio() {
    const tasks = [];
    const resources = getLocalResources();
    // é¢„åŠ è½½æ‰€æœ‰ BGM
    for (const bgmId of resources.bgmFiles) {
        tasks.push(preloadBGM(bgmId));
    }
    // é¢„åŠ è½½æ‰€æœ‰ SFX
    for (const sfxId of resources.sfxFiles) {
        tasks.push(preloadSFX(sfxId));
    }
    await Promise.all(tasks);
    console.log('[PRELOAD] All local audio loaded');
}
/**
 * é¢„åŠ è½½æ‰€æœ‰æœ¬åœ°è®­ç»ƒå®¶å¤´åƒ
 */
async function preloadAllAvatars() {
    const resources = getLocalResources();
    const tasks = resources.avatarFiles.map(id => preloadTrainerAvatar(id));
    await Promise.all(tasks);
    console.log('[PRELOAD] All trainer avatars loaded');
}
/**
 * é¢„åŠ è½½å®å¯æ¢¦å¤´åƒ sprite sheet (æ‰€æœ‰å®å¯æ¢¦å…±äº«)
 */
function preloadPokemonIconSheet() {
    return new Promise((resolve) => {
        if (PreloadCache.pokemonIcons['sheet']) {
            resolve(PreloadCache.pokemonIcons['sheet']);
            return;
        }
        const url = `https://play.pokemonshowdown.com/sprites/pokemonicons-sheet.png`;
        const img = new Image();
        img.onload = () => {
            PreloadCache.pokemonIcons['sheet'] = img;
            console.log('[PRELOAD] Pokemon icon sheet loaded');
            resolve(img);
        };
        img.onerror = () => {
            console.warn('[PRELOAD] Failed to load pokemon icon sheet');
            resolve(null);
        };
        img.src = url;
        setTimeout(() => resolve(null), 5000);
    });
}
/**
 * è·å–å®å¯æ¢¦æ‰€æœ‰å¯èƒ½çš„å½¢æ€ï¼ˆç”¨äºé¢„åŠ è½½ï¼‰
 * @param {object} pokemon - å®å¯æ¢¦å¯¹è±¡
 * @returns {string[]} - æ‰€æœ‰å¯èƒ½çš„å½¢æ€ ID åˆ—è¡¨
 */
function getPossibleForms(pokemon) {
    const forms = [];
    const baseName = pokemon.name || pokemon;
    // ä¿ç•™æ¨ªæ ï¼Œä¸ Showdown ç²¾çµå›¾ URL æ ¼å¼ä¸€è‡´
    const baseId = baseName.toLowerCase().replace(/[^a-z0-9-]/g, '');
    forms.push(baseId);
    // æ£€æŸ¥ mechanic å­—æ®µå†³å®šå¯èƒ½çš„å½¢æ€å˜åŒ–
    const mechanic = pokemon.mechanic || '';
    // Mega è¿›åŒ– - Showdown æ ¼å¼å¸¦æ¨ªæ : charizard-mega-x
    if (mechanic === 'mega' || pokemon.canMega) {
        // æ£€æŸ¥æ˜¯å¦æœ‰ X/Y åŒå½¢æ€ï¼ˆå–·ç«é¾™ã€è¶…æ¢¦ï¼‰
        if (baseId === 'charizard' || baseId === 'mewtwo') {
            forms.push(`${baseId}-mega-x`);
            forms.push(`${baseId}-mega-y`);
        } else {
            forms.push(`${baseId}-mega`);
        }
    }
    // æå·¨åŒ– - Showdown æ ¼å¼å¸¦æ¨ªæ : lapras-gmax
    if (mechanic === 'dynamax' || pokemon.canDynamax) {
        if (pokemon.canGmax || pokemon.gmaxMove) {
            forms.push(`${baseId}-gmax`);
        }
    }
    // åŸå§‹å›å½’ - Showdown æ ¼å¼å¸¦æ¨ªæ : groudon-primal
    if (baseId === 'groudon' || baseId === 'kyogre') {
        forms.push(`${baseId}-primal`);
    }
    // ç©¶æçˆ†å‘ï¼ˆå¥ˆå…‹æ´›å…¹ç›ï¼‰- Showdown æ ¼å¼
    if (baseId.includes('necrozma')) {
        forms.push('necrozma-dawn-wings');
        forms.push('necrozma-dusk-mane');
        forms.push('necrozma-ultra');
    }
    // åŸºæ ¼å°”å¾·å½¢æ€
    if (baseId.includes('zygarde')) {
        forms.push('zygarde');
        forms.push('zygarde-10');
        forms.push('zygarde-complete');
    }
    // å¼±ä¸é±¼å½¢æ€
    if (baseId.includes('wishiwashi')) {
        forms.push('wishiwashi');
        forms.push('wishiwashi-school');
    }
    return [...new Set(forms)]; // å»é‡
}
/**
 * é¢„åŠ è½½åˆ‡æ¢ç•Œé¢å›¾æ ‡ï¼ˆgen5 é™æ€å›¾ + pokesprite ç‰¹æ®Šå½¢æ€ï¼‰
 * @param {object} pokemon - å®å¯æ¢¦å¯¹è±¡
 * @returns {Promise} - é¢„åŠ è½½ Promise
 */
function preloadSwitchIcon(pokemon) {
    return new Promise((resolve) => {
        const name = pokemon.name || pokemon;
        const seedIdWithHyphen = name.toLowerCase().replace(/[^a-z0-9-]/g, '');
        const seedIdCompact = name.toLowerCase().replace(/[^a-z0-9]/g, '');
        // ä» POKEDEX è·å–å½¢æ€ä¿¡æ¯
        const pokeData = (typeof POKEDEX !== 'undefined' && POKEDEX[seedIdCompact]) 
            ? POKEDEX[seedIdCompact] : null;
        const forme = pokeData?.forme || '';
        const baseSpecies = pokeData?.baseSpecies || '';
        const formeLower = forme.toLowerCase();
        // æ£€æµ‹å½¢æ€ç±»å‹
        const regionalForms = ['alola', 'galar', 'hisui', 'paldea'];
        const isRegionalForm = regionalForms.some(r => formeLower.includes(r)) ||
            regionalForms.some(r => seedIdWithHyphen.includes(`-${r}`));
        const isMegaForm = formeLower.includes('mega') || seedIdWithHyphen.includes('-mega');
        const isPrimalForm = formeLower === 'primal' || seedIdWithHyphen.includes('-primal');
        const isUltraForm = formeLower === 'ultra' || seedIdWithHyphen.includes('-ultra');
        const isCrownedForm = formeLower === 'crowned' || seedIdWithHyphen.includes('-crowned');
        const specialForms = ['wash', 'heat', 'mow', 'frost', 'fan', 'dusk-mane', 'dawn-wings',
            'ice', 'shadow', 'zen', 'therian', 'origin', 'sky', 'attack', 'defense', 'speed',
            'combat', 'blaze', 'aqua'];
        const isOtherSpecialForm = specialForms.some(f => formeLower.includes(f)) ||
            specialForms.some(f => seedIdWithHyphen.includes(`-${f}`));
        const needsPokesprite = isRegionalForm || isMegaForm || isPrimalForm || isUltraForm || 
            isCrownedForm || isOtherSpecialForm;
        // ç”Ÿæˆå›¾æ ‡ URL
        let imgSrc;
        if (needsPokesprite) {
            let pokespriteId = seedIdWithHyphen;
            // Mega X/Y æ ¼å¼ä¿®æ­£
            if (isMegaForm && !pokespriteId.includes('-mega')) {
                pokespriteId = pokespriteId.replace(/mega([xy])$/i, '-mega-$1');
                if (!pokespriteId.includes('-mega')) {
                    pokespriteId = pokespriteId.replace(/mega$/i, '-mega');
                }
            }
            // Primal æ ¼å¼ä¿®æ­£
            if (isPrimalForm && !pokespriteId.includes('-primal')) {
                pokespriteId = pokespriteId.replace(/primal$/i, '-primal');
            }
            // Necrozma ç‰¹æ®Šå½¢æ€æ ¼å¼ä¿®æ­£
            pokespriteId = pokespriteId.replace(/-dusk-mane$/, '-dusk');
            pokespriteId = pokespriteId.replace(/-dawn-wings$/, '-dawn');
            imgSrc = `https://raw.githubusercontent.com/msikma/pokesprite/master/pokemon-gen8/regular/${pokespriteId}.png`;
        } else {
            imgSrc = `https://play.pokemonshowdown.com/sprites/gen5/${seedIdCompact}.png`;
        }
        // ç¼“å­˜é”®
        const cacheKey = `icon_${seedIdCompact}`;
        if (PreloadCache.sprites[cacheKey]) {
            resolve(PreloadCache.sprites[cacheKey]);
            return;
        }
        const img = new Image();
        img.onload = () => {
            PreloadCache.sprites[cacheKey] = img;
            resolve(img);
        };
        img.onerror = () => resolve(null);
        img.src = imgSrc;
        setTimeout(() => resolve(null), 5000);
    });
}
/**
 * é¢„åŠ è½½æœ¬å±€æ‰€æœ‰èµ„æºï¼ˆå¢å¼ºç‰ˆï¼‰
 */
async function preloadBattleResources(playerParty, enemyParty, trainerId, onProgress) {
    const spriteTasks = [];
    const cryTasks = [];
    const iconTasks = [];
    const otherTasks = [];
    // æ”¶é›†æ‰€æœ‰éœ€è¦é¢„åŠ è½½çš„å½¢æ€
    const allForms = new Set();
    // ç©å®¶é˜Ÿä¼
    for (const p of playerParty) {
        const forms = getPossibleForms(p);
        forms.forEach(f => allForms.add(f));
        // é¢„åŠ è½½åˆ‡æ¢ç•Œé¢å›¾æ ‡
        iconTasks.push(preloadSwitchIcon(p));
    }
    // æ•Œæ–¹é˜Ÿä¼
    for (const e of enemyParty) {
        const forms = getPossibleForms(e);
        forms.forEach(f => allForms.add(f));
    }
    // è®¡ç®—æ€»æ•°
    const formsList = [...allForms];
    // ç²¾çµå›¾(æ­£é¢+èƒŒé¢) + å«å£° + å›¾æ ‡ + è®­ç»ƒå®¶å¤´åƒ + å¤´åƒsheet
    const total = formsList.length * 3 + iconTasks.length + 2;
    let loaded = 0;
    const updateProgress = () => {
        loaded++;
        if (onProgress) onProgress(loaded, total);
    };
    // é¢„åŠ è½½æ‰€æœ‰å½¢æ€çš„ç²¾çµå›¾å’Œå«å£°
    for (const formId of formsList) {
        // æ­£é¢ç²¾çµå›¾ï¼ˆæ•Œæ–¹ï¼‰
        spriteTasks.push(preloadSprite(formId, false).then(updateProgress));
        // èƒŒé¢ç²¾çµå›¾ï¼ˆç©å®¶ï¼‰
        spriteTasks.push(preloadSprite(formId, true).then(updateProgress));
        // å«å£°
        cryTasks.push(preloadCry(formId).then(updateProgress));
    }
    // å›¾æ ‡ä»»åŠ¡æ·»åŠ è¿›åº¦æ›´æ–°
    const iconTasksWithProgress = iconTasks.map(task => task.then(updateProgress));
    // è®­ç»ƒå®¶å¤´åƒ
    otherTasks.push(preloadTrainerAvatar(trainerId).then(updateProgress));
    // å®å¯æ¢¦å¤´åƒ sprite sheet
    otherTasks.push(preloadPokemonIconSheet().then(updateProgress));
    // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
    await Promise.all([...spriteTasks, ...cryTasks, ...iconTasksWithProgress, ...otherTasks]);
    console.log(`[PRELOAD] All resources loaded (${formsList.length} forms, ${iconTasks.length} icons)`);
}
/**
 * é¢„åŠ è½½æ‰€æœ‰é™æ€èµ„æºï¼ˆæ¸¸æˆå¯åŠ¨æ—¶è°ƒç”¨ï¼‰
 */
async function preloadStaticResources(onProgress) {
    const resources = getLocalResources();
    const tasks = [];
    let loaded = 0;
    const total = resources.bgmFiles.length + resources.sfxFiles.length + resources.avatarFiles.length;
    const updateProgress = () => {
        loaded++;
        if (onProgress) onProgress(loaded, total);
    };
    // BGM
    for (const bgmId of resources.bgmFiles) {
        tasks.push(preloadBGM(bgmId).then(updateProgress));
    }
    // SFX
    for (const sfxId of resources.sfxFiles) {
        tasks.push(preloadSFX(sfxId).then(updateProgress));
    }
    // è®­ç»ƒå®¶å¤´åƒ
    for (const avatarId of resources.avatarFiles) {
        tasks.push(preloadTrainerAvatar(avatarId).then(updateProgress));
    }
    await Promise.all(tasks);
    console.log('[PRELOAD] All static resources loaded');
}
/**
 * è·å–ç¼“å­˜çš„å«å£°å¹¶æ’­æ”¾
 */
function playCachedCry(name, volume = 0.45) {
    // ã€å…¨å±€å¼€å…³ã€‘SFX ç³»ç»Ÿå…³é—­æ—¶ä¸æ’­æ”¾å«å£°
    if (typeof window !== 'undefined' && window.GAME_SETTINGS && !window.GAME_SETTINGS.enableSFX) {
        return;
    }
    let id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
    if (typeof POKEDEX !== 'undefined' && POKEDEX[id] && POKEDEX[id].baseSpecies) {
        id = POKEDEX[id].baseSpecies.toLowerCase().replace(/[^a-z0-9]/g, '');
    }
    const suffixes = ['mega', 'megax', 'megay', 'gmax', 'alola', 'hisui', 'paldea', 'galar'];
    for (const s of suffixes) {
        if (id.endsWith(s) && id.length > s.length) {
            id = id.replace(s, '');
            break;
        }
    }
    const cached = PreloadCache.cries[id];
    if (cached) {
        const clone = cached.cloneNode();
        clone.volume = volume;
        clone.play().catch(() => {});
        console.log(`[CRY] Playing cached: ${name} -> ${id}`);
    } else {
        // Fallback: ç›´æ¥åœ¨çº¿åŠ è½½ (é¿å…é€’å½’è°ƒç”¨ playPokemonCry)
        const url = `https://play.pokemonshowdown.com/audio/cries/${id}.mp3`;
        const cryAudio = new Audio(url);
        cryAudio.volume = volume;
        cryAudio.play().catch(() => {});
        console.log(`[CRY] Playing online (cache miss): ${name} -> ${id}`);
    }
}
// å¯¼å‡º
window.preloadBattleResources = preloadBattleResources;
window.preloadStaticResources = preloadStaticResources;
window.preloadAllLocalAudio = preloadAllLocalAudio;
window.preloadAllAvatars = preloadAllAvatars;
window.preloadTrainerAvatar = preloadTrainerAvatar;
window.preloadPokemonIconSheet = preloadPokemonIconSheet;
window.preloadSwitchIcon = preloadSwitchIcon;
window.preloadBGM = preloadBGM;
window.preloadSFX = preloadSFX;
window.playCachedCry = playCachedCry;
window.getPossibleForms = getPossibleForms;
window.getPreloadBasePath = getPreloadBasePath;
window.getLocalResources = getLocalResources;
window.PreloadCache = PreloadCache;
window.LOCAL_RESOURCE_FILES = LOCAL_RESOURCE_FILES;
]]></file>
        <file name="translations.js"><![CDATA[/**
 * ===========================================
 * TRANSLATIONS.JS - æ±‰åŒ–æ•°æ®åº“
 * æ•°æ®æ¥æº: PSChina Tampermonkey Script (Ceca3)
 * ===========================================
 */
var translations={
    // Abilities Translations
    "Stench":"æ¶è‡­",
    "Drizzle":"é™é›¨",
    "Speed Boost":"åŠ é€Ÿ",
    "Battle Armor":"æˆ˜æ–—ç›”ç”²",
    "Sturdy":"ç»“å®",
    "Damp":"æ¹¿æ°”",
    "Limber":"æŸ”è½¯",
    "Sand Veil":"æ²™éš",
    "Static":"é™ç”µ",
    "Volt Absorb":"è“„ç”µ",
    "Water Absorb":"å‚¨æ°´",
    "Oblivious":"è¿Ÿé’",
    "Cloud Nine":"æ— å…³å¤©æ°”",
    "Compound Eyes":"å¤çœ¼",
    "Insomnia":"ä¸çœ ",
    "Color Change":"å˜è‰²",
    "Immunity":"å…ç–«",
    "Flash Fire":"å¼•ç«",
    "Shield Dust":"é³ç²‰",
    "Own Tempo":"æˆ‘è¡Œæˆ‘ç´ ",
    "Suction Cups":"å¸ç›˜",
    "Intimidate":"å¨å“",
    "Shadow Tag":"è¸©å½±",
    "Rough Skin":"ç²—ç³™çš®è‚¤",
    "Wonder Guard":"ç¥å¥‡å®ˆæŠ¤",
    "Levitate":"é£˜æµ®",
    "Effect Spore":"å­¢å­",
    "Synchronize":"åŒæ­¥",
    "Clear Body":"æ’å‡€ä¹‹èº¯",
    "Natural Cure":"è‡ªç„¶å›å¤",
    "Lightning Rod":"é¿é›·é’ˆ",
    "Serene Grace":"å¤©æ©",
    "Swift Swim":"æ‚ æ¸¸è‡ªå¦‚",
    "Chlorophyll":"å¶ç»¿ç´ ",
    "Illuminate":"å‘å…‰",
    "Trace":"å¤åˆ¶",
    "Huge Power":"å¤§åŠ›å£«",
    "Poison Point":"æ¯’åˆº",
    "Inner Focus":"ç²¾ç¥åŠ›",
    "Magma Armor":"ç†”å²©é“ ç”²",
    "Water Veil":"æ°´å¹•",
    "Magnet Pull":"ç£åŠ›",
    "Soundproof":"éš”éŸ³",
    "Rain Dish":"é›¨ç›˜",
    "Sand Stream":"æ‰¬æ²™",
    "Pressure":"å‹è¿«æ„Ÿ",
    "Thick Fat":"åšè„‚è‚ª",
    "Early Bird":"æ—©èµ·",
    "Flame Body":"ç«ç„°ä¹‹èº¯",
    "Run Away":"é€ƒè·‘",
    "Keen Eye":"é”åˆ©ç›®å…‰",
    "Hyper Cutter":"æ€ªåŠ›é’³",
    "Pickup":"æ¡æ‹¾",
    "Truant":"æ‡’æƒ°",
    "Hustle":"æ´»åŠ›",
    "Cute Charm":"è¿·äººä¹‹èº¯",
    "Plus":"æ­£ç”µ",
    "Minus":"è´Ÿç”µ",
    "Forecast":"é˜´æ™´ä¸å®š",
    "Sticky Hold":"é»ç€",
    "Shed Skin":"èœ•çš®",
    "Guts":"æ¯…åŠ›",
    "Marvel Scale":"ç¥å¥‡é³ç‰‡",
    "Liquid Ooze":"æ±¡æ³¥æµ†",
    "Overgrow":"èŒ‚ç››",
    "Blaze":"çŒ›ç«",
    "Torrent":"æ¿€æµ",
    "Swarm":"è™«ä¹‹é¢„æ„Ÿ",
    "Rock Head":"åšç¡¬è„‘è¢‹",
    "Drought":"æ—¥ç…§",
    "Arena Trap":"æ²™ç©´",
    "Vital Spirit":"å¹²åŠ²",
    "White Smoke":"ç™½è‰²çƒŸé›¾",
    "Pure Power":"ç‘œçˆä¹‹åŠ›",
    "Shell Armor":"ç¡¬å£³ç›”ç”²",
    "Air Lock":"æ°”é—¸",
    "Tangled Feet":"è¹’è·š",
    "Motor Drive":"ç”µæ°”å¼•æ“",
    "Rivalry":"æ–—äº‰å¿ƒ",
    "Steadfast":"ä¸å±ˆä¹‹å¿ƒ",
    "Snow Cloak":"é›ªéš",
    "Gluttony":"è´ªåƒé¬¼",
    "Anger Point":"æ„¤æ€’ç©´ä½",
    "Unburden":"è½»è£…",
    "Heatproof":"è€çƒ­",
    "Simple":"å•çº¯",
    "Dry Skin":"å¹²ç‡¥çš®è‚¤",
    "Download":"ä¸‹è½½",
    "Iron Fist":"é“æ‹³",
    "Poison Heal":"æ¯’ç–—",
    "Adaptability":"é€‚åº”åŠ›",
[... truncated: only first 100 lines included ...]
]]></file>
    </directory>
    <directory name="ui">
        <file name="sprite-duplicate-fix.js"><![CDATA[/**
 * ===========================================
 * SPRITE-DUPLICATE-FIX.JS - é‡å¤ç²¾çµå›¾ä¿®å¤
 * ===========================================
 * 
 * é—®é¢˜ï¼šå½“å¤šåªç›¸åŒå®å¯æ¢¦å‡ºç°æ—¶ï¼Œæµè§ˆå™¨ç¼“å­˜ GIF å¯¼è‡´
 *       åç»­ç›¸åŒ URL çš„ç²¾çµå›¾ä¸ä¼šé‡æ–°æ’­æ”¾åŠ¨ç”»
 * 
 * è§£å†³æ–¹æ¡ˆï¼šé”€æ¯å¹¶é‡å»º img å…ƒç´ ï¼Œå¼ºåˆ¶æµè§ˆå™¨é‡æ–°æ¸²æŸ“ GIF
 */
(function() {
    'use strict';
    // è®°å½•å½“å‰æ˜¾ç¤ºçš„ç²¾çµå›¾ URLï¼ˆå»é™¤æŸ¥è¯¢å‚æ•°åçš„åŸºç¡€ URLï¼‰
    let currentEnemySpriteUrl = null;
    // æ ‡è®°æ˜¯å¦æ˜¯çœŸæ­£çš„æ¢äººï¼ˆç”±å¤–éƒ¨è°ƒç”¨è®¾ç½®ï¼‰
    let isActualSwitch = false;
    /**
     * é”€æ¯å¹¶é‡å»ºç²¾çµå›¾å…ƒç´ ï¼ˆç»ˆææ–¹æ¡ˆï¼‰
     * ã€ä¼˜åŒ–ã€‘ä½¿ç”¨æ·¡å…¥æ·¡å‡ºæ•ˆæœï¼Œé¿å…çªç„¶æ¶ˆå¤±
     * @param {string} spriteId - DOM å…ƒç´  ID
     * @param {string} url - å›¾ç‰‡ URL
     */
    function recreateSpriteElement(spriteId, url) {
        const oldImg = document.getElementById(spriteId);
        if (!oldImg) return;
        const parent = oldImg.parentNode;
        if (!parent) return;
        console.log(`[SPRITE-FIX] Recreating element for: ${url}`);
        // æ·»åŠ å”¯ä¸€å‚æ•°ç¡®ä¿ä¸ä½¿ç”¨ç¼“å­˜
        const separator = url.includes('?') ? '&' : '?';
        const uniqueUrl = `${url}${separator}_t=${Date.now()}`;
        // ã€åŒæ­¥æ›¿æ¢ã€‘ç«‹å³åˆ›å»ºæ–°å…ƒç´ å¹¶æ›¿æ¢
        const newImg = document.createElement('img');
        newImg.id = spriteId;
        // ã€ä¿®å¤ã€‘ä¿ç•™åŸå§‹ç±»ï¼ˆåŒ…æ‹¬ player-scaleï¼‰
        newImg.className = oldImg.className.replace(/loaded|entering|fainted-hidden|fainting/g, '').trim() || 'p-sprite';
        newImg.alt = oldImg.alt || '';
        // è®¾ç½®åŠ è½½å›è°ƒ
        newImg.onload = function() {
            newImg.classList.add('loaded');
            newImg.classList.remove('entering');
            void newImg.offsetWidth;
            newImg.classList.add('entering');
            setTimeout(() => newImg.classList.remove('entering'), 650);
            console.log(`[SPRITE-FIX] Recreate complete: ${spriteId}`);
        };
        newImg.onerror = function() {
            console.error(`[SPRITE-FIX] Failed to load: ${uniqueUrl}`);
        };
        // å…ˆè®¾ç½® src
        newImg.src = uniqueUrl;
        // ç«‹å³æ›¿æ¢æ—§å…ƒç´ 
        parent.replaceChild(newImg, oldImg);
    }
    /**
     * åŒ…è£…åŸå§‹çš„ smartLoadSprite å‡½æ•°
     * æ£€æµ‹é‡å¤ URL å¹¶é‡å»ºå…ƒç´ 
     */
    function wrapSmartLoadSprite() {
        const originalSmartLoadSprite = window.smartLoadSprite;
        if (!originalSmartLoadSprite) {
            console.warn('[SPRITE-FIX] smartLoadSprite not found, retrying...');
            setTimeout(wrapSmartLoadSprite, 100);
            return;
        }
        window.smartLoadSprite = function(id, url, forceAnim = false) {
            // åªå¤„ç†æ•Œæ–¹ç²¾çµå›¾çš„é‡å¤é—®é¢˜
            if (id === 'enemy-sprite') {
                const baseUrl = url.split('?')[0];
                // ã€ç®€åŒ–é€»è¾‘ã€‘åªæœ‰å½“ isActualSwitch=true ä¸” URL ç›¸åŒæ—¶æ‰è§¦å‘é‡å»º
                // isActualSwitch ç”±å¤–éƒ¨åœ¨æ¢äººå‰è®¾ç½®ä¸º true
                if (isActualSwitch && currentEnemySpriteUrl === baseUrl) {
                    console.log(`[SPRITE-FIX] Duplicate enemy sprite on switch: ${baseUrl}`);
                    isActualSwitch = false; // é‡ç½®æ ‡è®°
                    recreateSpriteElement(id, url);
                    return;
                }
                // é‡ç½®æ ‡è®°ï¼ˆæ— è®ºæ˜¯å¦è§¦å‘é‡å»ºï¼‰
                isActualSwitch = false;
                // è®°å½•å½“å‰ URL
                currentEnemySpriteUrl = baseUrl;
            }
            // è°ƒç”¨åŸå§‹å‡½æ•°
            originalSmartLoadSprite.call(this, id, url, forceAnim);
        };
        console.log('[SPRITE-FIX] smartLoadSprite wrapped successfully');
    }
    /**
     * é‡ç½®çŠ¶æ€ï¼ˆæˆ˜æ–—ç»“æŸæ—¶è°ƒç”¨ï¼‰
     */
    function resetDuplicateFix() {
        currentEnemySpriteUrl = null;
        isActualSwitch = false;
        console.log('[SPRITE-FIX] State reset');
    }
    /**
     * æ ‡è®°å³å°†è¿›è¡Œæ¢äººï¼ˆåœ¨æ¢äººå‰è°ƒç”¨ï¼‰
     * è¿™æ · smartLoadSprite å°±çŸ¥é“è¿™æ˜¯çœŸæ­£çš„æ¢äººï¼Œè€Œä¸æ˜¯å½¢æ€åˆ‡æ¢æˆ–å›åˆæ›´æ–°
     */
    function markEnemySwitch() {
        isActualSwitch = true;
        console.log('[SPRITE-FIX] Enemy switch marked');
    }
    // å¯¼å‡ºå‡½æ•°
    window.resetSpriteDuplicateFix = resetDuplicateFix;
    window.markEnemySwitch = markEnemySwitch;
    // åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', wrapSmartLoadSprite);
    } else {
        setTimeout(wrapSmartLoadSprite, 50);
    }
    console.log('[SPRITE-FIX] Module loaded');
})();
]]></file>
        <file name="ui-menus.js"><![CDATA[/**
 * ===========================================
 * UI-MENUS.JS - èœå•ç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - ä¸»èœå•/æŠ€èƒ½èœå•åˆ‡æ¢
 * - Mega/Dynamax/Tera æŒ‰é’®æ§åˆ¶
 * - è¿›åŒ–åŠ¨ç”»æ’­æ”¾
 */
// ============================================
// èœå•åˆ‡æ¢
// ============================================
/**
 * æ˜¾ç¤ºæŠ€èƒ½èœå•
 */
function showMovesMenu() {
    console.log('[UI-MENUS] showMovesMenu called');
    const battle = typeof window !== 'undefined' ? window.battle : null;
    // =========================================================
    // ã€è“„åŠ›æŠ€èƒ½é”å®šã€‘æ£€æŸ¥ç©å®¶æ˜¯å¦æ­£åœ¨è“„åŠ›
    // =========================================================
    if (battle) {
        const player = battle.getPlayer();
        if (player && player.volatile?.chargingMove) {
            const chargingMove = player.volatile.chargingMove;
            // ã€é‡è¦ã€‘å…ˆæ£€æŸ¥æ˜¯å¦èƒ½è¡ŒåŠ¨ï¼ˆç•ç¼©/ç¡çœ /éº»ç—¹/å†°å†»ç­‰ä¼šé˜»æ­¢è¡ŒåŠ¨ï¼‰
            // å¦‚æœæ— æ³•è¡ŒåŠ¨ï¼ŒcheckCanMove ä¼šæ¸…é™¤ chargingMove çŠ¶æ€
            if (typeof window.checkCanMove === 'function') {
                const canMoveCheck = window.checkCanMove(player);
                if (!canMoveCheck.can) {
                    // æ— æ³•è¡ŒåŠ¨ï¼ŒchargingMove å·²è¢« checkCanMove æ¸…é™¤
                    // æ˜¾ç¤ºæ— æ³•è¡ŒåŠ¨çš„åŸå› ï¼Œç„¶åæ­£å¸¸æ˜¾ç¤ºæŠ€èƒ½èœå•
                    console.log(`[CHARGE MOVE] Player cannot move: ${canMoveCheck.msg}`);
                    // ä¸åœ¨è¿™é‡Œæ˜¾ç¤ºæ¶ˆæ¯ï¼Œè®© executePlayerTurn å¤„ç†
                    // ç»§ç»­æ˜¾ç¤ºæ­£å¸¸çš„æŠ€èƒ½èœå•
                }
            }
            // å†æ¬¡æ£€æŸ¥ chargingMove æ˜¯å¦ä»ç„¶å­˜åœ¨ï¼ˆå¯èƒ½å·²è¢« checkCanMove æ¸…é™¤ï¼‰
            if (player.volatile?.chargingMove) {
                console.log(`[CHARGE MOVE] Player is charging ${chargingMove}, forcing move execution`);
                // æ‰¾åˆ°å¯¹åº”çš„æŠ€èƒ½ç´¢å¼•
                const moveIndex = player.moves?.findIndex(m => m.name === chargingMove);
                if (moveIndex >= 0 && typeof window.handleAttack === 'function') {
                    const moveToUse = player.moves[moveIndex];
                    // æ˜¾ç¤ºæç¤º
                    if (typeof window.log === 'function') {
                        window.log(`<span style="color:#f59e0b">âš¡ ${player.cnName} ç»§ç»­æ‰§è¡Œ ${moveToUse.cn || chargingMove}!</span>`);
                    }
                    // å¼ºåˆ¶æ‰§è¡Œè“„åŠ›æŠ€èƒ½ï¼ˆä¼ é€’ç´¢å¼•è€Œéå¯¹è±¡ï¼‰
                    setTimeout(() => {
                        window.handleAttack(moveIndex);
                    }, 100);
                    return; // ä¸æ˜¾ç¤ºæŠ€èƒ½èœå•
                }
            }
        }
    }
    // =========================================================
    // ã€Insight é¢„è­¦ç³»ç»Ÿã€‘é¢„æµ‹ AI çš„"åˆå§‹æ„å›¾"
    // AI æœ€ç»ˆå†³ç­–å¯èƒ½ä¸åŒï¼ˆè§æ‹›æ‹†æ‹›ï¼‰ï¼Œä½† Insight æ˜¾ç¤ºçš„æ˜¯åˆå§‹æ„å›¾
    // =========================================================
    if (battle && window.GAME_SETTINGS?.enableClash !== false) {
        const p = battle.getPlayer();
        const e = battle.getEnemy();
        if (p && e && p.isAlive() && e.isAlive()) {
            // è®¡ç®—é€Ÿåº¦åˆ¤æ–­æ˜¯å¦åæ‰‹
            let playerSpeed = (typeof p.getStat === 'function') ? p.getStat('spe') : (p.spe || 100);
            let enemySpeed = (typeof e.getStat === 'function') ? e.getStat('spe') : (e.spe || 100);
            if (p.status === 'par') playerSpeed = Math.floor(playerSpeed * 0.5);
            if (e.status === 'par') enemySpeed = Math.floor(enemySpeed * 0.5);
            const isTrickRoom = battle.field && battle.field.trickRoom > 0;
            const playerIsSlower = isTrickRoom ? (playerSpeed > enemySpeed) : (playerSpeed < enemySpeed);
            // åªæœ‰ç©å®¶åæ‰‹æ—¶æ‰è§¦å‘ Insight
            if (playerIsSlower && typeof window.preCalculateIntent === 'function') {
                // ä½¿ç”¨ getHardAiMove è·å– AI çš„"åˆå§‹æ„å›¾"ï¼ˆæœ€ä¼˜æ‹›å¼ï¼‰
                let predictedMove = null;
                if (typeof window.getHardAiMove === 'function') {
                    predictedMove = window.getHardAiMove(e, p, battle.enemyParty);
                }
                if (!predictedMove && e.moves && e.moves.length > 0) {
                    predictedMove = e.moves[0];
                }
                if (predictedMove) {
                    const insightResult = window.preCalculateIntent(e, p, predictedMove);
                    if (insightResult && insightResult.success) {
                        console.log(`[INSIGHT] é¢„è­¦è§¦å‘: Level ${insightResult.level}, é¢„æµ‹æ‹›å¼: ${predictedMove.cn || predictedMove.name}`);
                        // æ ‡è®°æœ¬å›åˆ Insight å·²è§¦å‘ï¼Œä¾›å¯¹å†²ç³»ç»Ÿä½¿ç”¨
                        battle.insightTriggeredThisTurn = true;
                        battle.insightPredictedMove = predictedMove;
                        // æ˜¾ç¤ºé¢„è­¦
                        if (typeof window.showInsightWarning === 'function') {
                            window.showInsightWarning(insightResult);
                        }
                    } else {
                        battle.insightTriggeredThisTurn = false;
                        battle.insightPredictedMove = null;
                    }
                }
            } else {
                // ç©å®¶å…ˆæ‰‹ï¼Œä¸è§¦å‘ Insight
                battle.insightTriggeredThisTurn = false;
                battle.insightPredictedMove = null;
            }
        }
    }
    // ã€æˆ˜æœ¯æŒ‡æŒ¥ç³»ç»Ÿã€‘è‡ªåŠ¨å¼¹çª—å·²ç§»é™¤ï¼Œæ”¹ä¸ºé€šè¿‡ Smart Bubble æ‰‹åŠ¨è§¦å‘
    // ã€ä¿®å¤ã€‘åªæœ‰åœ¨æ²¡æœ‰é”å®šçŠ¶æ€æ—¶æ‰åˆ·æ–°æ‚¬æµ®çª—ï¼Œé¿å…ç‚¹å‡»FIGHTåé‡ç½®é”å®šçŠ¶æ€
    // é”å®šçŠ¶æ€åŒ…æ‹¬ï¼šcommandArmed, evoArmed, playerMegaArmed, currentMoveStyle
    const hasLockedState = battle?.commandArmed || battle?.evoArmed || battle?.playerMegaArmed || 
                           (window.currentMoveStyle && window.currentMoveStyle !== 'normal');
    if (!hasLockedState && typeof window.refreshCommanderBubble === 'function') {
        window.refreshCommanderBubble();
    }
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('moves-menu').classList.remove('hidden');
    // ã€å¤æ­¦ç³»ç»Ÿã€‘å¤ªæçƒå·²ç§»é™¤ï¼ŒåŠŸèƒ½è¿ç§»åˆ° Commander System V2
    // ä¸å†é‡ç½®é£æ ¼ï¼Œä¿æŒç©å®¶é€‰æ‹©çš„é£æ ¼ç›´åˆ°ä½¿ç”¨
    // æ›´æ–° Mega æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
    console.log('[UI-MENUS] Calling updateMegaButtonVisibility');
    updateMegaButtonVisibility();
}
/**
 * æ˜¾ç¤ºä¸»èœå•
 */
function showMainMenu() {
    if (typeof window.playSFX === 'function') window.playSFX('CANCEL');
    document.getElementById('moves-menu').classList.add('hidden');
    document.getElementById('main-menu').classList.remove('hidden');
    const battle = typeof window !== 'undefined' ? window.battle : null;
    // è¿”å›ä¸»èœå•æ—¶é‡ç½® Mega é¢„å¤‡çŠ¶æ€
    if (battle && battle.playerMegaArmed) {
        battle.playerMegaArmed = false;
        const megaBtn = document.getElementById('btn-mega');
        if (megaBtn) megaBtn.classList.remove('armed');
    }
}
// ============================================
// Mega/Dynamax/Tera æŒ‰é’®æ§åˆ¶
// ============================================
/**
 * æ›´æ–° Mega/Dynamax/Tera æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
 * ã€å·²è¿ç§»ã€‘å°çƒæŒ‰é’®åŠŸèƒ½å·²è¿ç§»åˆ° Commander System V2 æ‚¬æµ®çª—
 * æ­¤å‡½æ•°ç°åœ¨åªè´Ÿè´£éšè—å°çƒæŒ‰é’®å¹¶åˆ·æ–°æ‚¬æµ®çª—
 */
function updateMegaButtonVisibility() {
    // ã€è¿ç§»ã€‘å°çƒæŒ‰é’®å§‹ç»ˆéšè—ï¼ŒåŠŸèƒ½ç”±æ‚¬æµ®çª—æ¥ç®¡
    const megaBtn = document.getElementById('btn-mega');
    const evoBtn = document.getElementById('btn-evolved');
    if (megaBtn) {
        megaBtn.classList.add('hidden');
        megaBtn.classList.remove('armed');
    }
    if (evoBtn) evoBtn.classList.add('hidden');
    // ã€ä¿®å¤ã€‘åªæœ‰åœ¨æ²¡æœ‰é”å®šçŠ¶æ€æ—¶æ‰åˆ·æ–°æ‚¬æµ®çª—
    const battle = typeof window !== 'undefined' ? window.battle : null;
    const hasLockedState = battle?.commandArmed || battle?.evoArmed || battle?.playerMegaArmed || 
                           (window.currentMoveStyle && window.currentMoveStyle !== 'normal');
    if (!hasLockedState && typeof window.refreshCommanderBubble === 'function') {
        window.refreshCommanderBubble();
    }
    // ã€é‡è¦ã€‘ç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œåé¢çš„æ˜¾ç¤ºé€»è¾‘
    return;
    console.log(`[MEGA UI] Player: ${p.name}, canMegaEvolve: ${p.canMegaEvolve}, canDynamax: ${p.canDynamax}, canTera: ${p.canTera}, mechanic: ${lockedMechanic}`);
    const canMegaEvolveFunc = window.canMegaEvolve;
    const canActivateMechanicFunc = window.canActivateMechanic || (() => true);
    // è§£é”ç³»ç»Ÿæ£€æŸ¥
    const unlocks = battle.playerUnlocks || {};
    // =========================================================
    // æœºåˆ¶é”æ£€æŸ¥ï¼šä¸¤å±‚é”æœºåˆ¶
    // ä¸€å±‚é” (unlocks)ï¼šç©å®¶æ˜¯å¦è§£é”äº†è¯¥æœºåˆ¶
    // äºŒå±‚é” (mechanic)ï¼šå®å¯æ¢¦æ˜¯å¦è¢«æŒ‡å®šä½¿ç”¨è¯¥æœºåˆ¶
    // =========================================================
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥ Mega è¿›åŒ–
    // ã€ä¿®å¤ã€‘å¿…é¡»æ˜ç¡® enable_mega === true æ‰èƒ½ä½¿ç”¨ Mega
    // ã€äºŒå±‚é”ã€‘å®å¯æ¢¦å¿…é¡»æœ‰ mechanic === 'mega' æ‰èƒ½ Mega è¿›åŒ–
    const canMega = unlocks.enable_mega === true
        && typeof canMegaEvolveFunc === 'function' 
        && canMegaEvolveFunc(p) 
        && !battle.playerMegaUsed
        && canActivateMechanicFunc(p, 'mega')
        && lockedMechanic === 'mega';  // ã€å…³é”®ä¿®å¤ã€‘å¿…é¡»æ˜ç¡®æŒ‡å®š mechanic
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æå·¨åŒ–
    // ã€ä¿®å¤ã€‘å¿…é¡»æ˜ç¡® enable_dynamax === true æ‰èƒ½ä½¿ç”¨æå·¨åŒ–
    // ã€äºŒå±‚é”ã€‘å®å¯æ¢¦å¿…é¡»æœ‰ mechanic === 'dynamax' æ‰èƒ½æå·¨åŒ–
    const canDynamax = unlocks.enable_dynamax === true
        && p.canDynamax 
        && !p.isDynamaxed 
        && !battle.playerMaxUsed
        && canActivateMechanicFunc(p, 'dynamax')
        && lockedMechanic === 'dynamax';  // ã€å…³é”®ä¿®å¤ã€‘å¿…é¡»æ˜ç¡®æŒ‡å®š mechanic
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¤ªæ™¶åŒ–
    // ã€ä¿®å¤ã€‘å¿…é¡»æ˜ç¡® enable_tera === true æ‰èƒ½ä½¿ç”¨å¤ªæ™¶åŒ–
    // ã€äºŒå±‚é”ã€‘å®å¯æ¢¦å¿…é¡»æœ‰ mechanic === 'tera' æ‰èƒ½å¤ªæ™¶åŒ–
    const canTerastallize = unlocks.enable_tera === true
        && p.canTera 
        && !p.isTerastallized 
        && !battle.playerTeraUsed
        && canActivateMechanicFunc(p, 'tera')
        && lockedMechanic === 'tera';
    const isDynamaxTarget = p.megaTargetId && p.megaTargetId.toLowerCase().includes('gmax');
    console.log(`[MEGA UI] canMega: ${canMega}, canDynamax: ${canDynamax}, canTera: ${canTerastallize}, lockedMechanic: ${lockedMechanic}, isDynamaxTarget: ${isDynamaxTarget}`);
    // å¤ªæ™¶åŒ–æ¨¡å¼
    if (lockedMechanic === 'tera') {
        if (canTerastallize) {
            megaBtn.classList.remove('hidden');
            megaBtn.classList.add('tera-style');
            if (iconText) iconText.textContent = 'T';
            p.evolutionType = 'tera';
        } else {
            megaBtn.classList.add('hidden');
            battle.playerMegaArmed = false;
        }
        return;
    }
    // Z-Move æ¨¡å¼ä¸æ˜¾ç¤ºæŒ‰é’®
    if (lockedMechanic === 'zmove') {
        megaBtn.classList.add('hidden');
        battle.playerMegaArmed = false;
        return;
    }
    // Dynamax æ¨¡å¼ï¼ˆä¼˜å…ˆæ£€æŸ¥ï¼‰
    if (lockedMechanic === 'dynamax') {
        if (canDynamax) {
            megaBtn.classList.remove('hidden');
            megaBtn.classList.add('dynamax-style');
            if (iconText) iconText.textContent = 'X';
            p.evolutionType = 'dynamax';
            console.log('[MEGA UI] Showing Dynamax button (mechanic locked)');
        } else {
            megaBtn.classList.add('hidden');
            console.log('[MEGA UI] Hidden: mechanic locked to dynamax but canDynamax is false');
        }
        return;
    }
    // Mega æ¨¡å¼
    if (lockedMechanic === 'mega') {
        if (canMega) {
            megaBtn.classList.remove('hidden');
            megaBtn.classList.remove('dynamax-style');
            p.evolutionType = 'mega';
            console.log('[MEGA UI] Showing Mega button (mechanic locked)');
        } else {
            megaBtn.classList.add('hidden');
            console.log('[MEGA UI] Hidden: mechanic locked to mega but canMega is false');
        }
        return;
    }
    // æ— é”å®šæœºåˆ¶æ—¶ï¼šéšè—æŒ‰é’®
    // ã€å…³é”®ã€‘å››å¤§æœºåˆ¶ (Mega/Dynamax/Tera/Z-Move) éƒ½å¿…é¡»æœ‰æ˜ç¡®çš„ mechanic å­—æ®µ
    megaBtn.classList.add('hidden');
    console.log('[MEGA UI] Hidden: no mechanic specified (all mechanics require explicit mechanic field)');
    battle.playerMegaArmed = false;
    megaBtn.classList.remove('armed');
}
// ============================================
// è¿›åŒ–åŠ¨ç”»
// ============================================
/**
 * æ‰§è¡Œ Mega è¿›åŒ–çš„è§†è§‰æ•ˆæœ
 */
async function playMegaEvolutionAnimation(pokemon, isPlayer = true) {
    const spriteId = isPlayer ? 'player-sprite' : 'enemy-sprite';
    const sprite = document.getElementById(spriteId);
    if (!sprite) return;
    const isBack = isPlayer;
    const newSpriteUrl = pokemon.getSprite(isBack);
    sprite.classList.remove('evo-silhouette', 'evo-burst', 'evo-finish');
    // é˜¶æ®µ 1: DNA å‰ªå½±
    sprite.classList.add('evo-silhouette');
    await wait(1000);
    // é˜¶æ®µ 2: ç™½å…‰çˆ†å‘ + åˆ‡æ¢å›¾ç‰‡
    sprite.classList.remove('evo-silhouette');
    sprite.classList.add('evo-burst');
    const spriteRequestedUrls = window.spriteRequestedUrls || {};
    delete spriteRequestedUrls[spriteId];
    if (typeof smartLoadSprite === 'function') {
        smartLoadSprite(spriteId, newSpriteUrl, false);
    }
    spriteRequestedUrls[spriteId] = newSpriteUrl;
    await wait(300);
    // é˜¶æ®µ 3: å†·å´åŠ¨ç”»
    sprite.classList.remove('evo-burst');
    sprite.classList.add('evo-finish');
    await wait(800);
    // ã€ä¿®å¤ã€‘ä¿ç•™ player-scale ç±»ï¼Œé¿å…ç²¾çµå›¾å¤§å°å˜åŒ–
    sprite.classList.remove('evo-silhouette', 'evo-burst', 'evo-finish');
    if (!sprite.classList.contains('loaded')) {
        sprite.classList.add('loaded');
    }
    sprite.classList.add(isPlayer ? 'mega-player' : 'mega-enemy');
}
/**
 * æ‰§è¡Œæå·¨åŒ–çš„è§†è§‰æ•ˆæœ
 */
async function playDynamaxAnimation(pokemon, isPlayer = true) {
    const spriteId = isPlayer ? 'player-sprite' : 'enemy-sprite';
    const sprite = document.getElementById(spriteId);
    if (!sprite) return;
    sprite.classList.remove('evo-silhouette', 'evo-burst', 'evo-finish', 'state-dynamax', 'dynamax-burst', 'dynamax-shrink');
    // é˜¶æ®µ 1: çº¢è‰²çˆ†å‘åŠ¨ç”»
    sprite.classList.add('dynamax-burst');
    await wait(800);
    // é˜¶æ®µ 2: è¿›å…¥æå·¨åŒ–çŠ¶æ€
    sprite.classList.remove('dynamax-burst');
    sprite.classList.add('state-dynamax');
    await wait(200);
}
/**
 * ç»“æŸæå·¨åŒ–çš„è§†è§‰æ•ˆæœ
 */
async function endDynamaxAnimation(pokemon, isPlayer = true) {
    const spriteId = isPlayer ? 'player-sprite' : 'enemy-sprite';
    const sprite = document.getElementById(spriteId);
    if (!sprite) return;
    sprite.classList.remove('state-dynamax');
    sprite.classList.add('dynamax-shrink');
    await wait(600);
    sprite.classList.remove('dynamax-shrink', 'dynamax-burst');
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šç­‰å¾…
 */
function wait(ms) { 
    return new Promise(r => setTimeout(r, ms)); 
}
/**
 * è¾…åŠ©å‡½æ•°ï¼šæ—¥å¿—è¾“å‡º
 */
function log(msg) {
    if (typeof window !== 'undefined' && typeof window.log === 'function') {
        window.log(msg);
    } else {
        console.log(msg);
    }
}
// ============================================
// Mega/Dynamax/Tera åˆ‡æ¢
// ============================================
/**
 * åˆ‡æ¢ Mega/Dynamax/Tera è¿›åŒ–é¢„å¤‡çŠ¶æ€
 */
function toggleMega() {
    const megaBtn = document.getElementById('btn-mega');
    if (!megaBtn) return;
    const battle = typeof window !== 'undefined' ? window.battle : null;
    if (!battle) return;
    const p = battle.getPlayer();
    const canMegaEvolveFunc = window.canMegaEvolve;
    // =========================================================
    // å¤ªæ™¶åŒ–æ¨¡å¼ (ä¼˜å…ˆæ£€æŸ¥)
    // ã€ä¿®å¤ã€‘å¿…é¡»æ£€æŸ¥ï¼š1) unlocks.enable_tera === true  2) mechanic === 'tera'
    // =========================================================
    const teraUnlocks = battle.playerUnlocks || {};
    if (p && teraUnlocks.enable_tera === true && p.mechanic === 'tera' && p.canTera) {
        if (battle.playerTeraUsed || p.isTerastallized) {
            return;
        }
        battle.playerMegaArmed = !battle.playerMegaArmed;
        if (battle.playerMegaArmed) {
            megaBtn.classList.add('armed');
            log(`<span style="color:#22d3ee">ğŸ’ å¤ªæ™¶åŒ–å°±ç»ªï¼é€‰æ‹©æ‹›å¼åå°†è¿›è¡Œå¤ªæ™¶åŒ–ï¼(${p.teraType})</span>`);
        } else {
            megaBtn.classList.remove('armed');
            log(`<span style="color:#94a3b8">å–æ¶ˆå¤ªæ™¶åŒ–é¢„å¤‡ã€‚</span>`);
        }
        return;
    }
    // æ£€æŸ¥æ˜¯å¦æ˜¯æå·¨åŒ–æ¨¡å¼
    // ã€ä¿®å¤ã€‘å¿…é¡»æ£€æŸ¥ï¼š1) unlocks.enable_dynamax === true  2) mechanic === 'dynamax'
    const unlocks = battle.playerUnlocks || {};
    const isDynamaxMode = p 
        && unlocks.enable_dynamax === true 
        && p.mechanic === 'dynamax'  // ã€äºŒå±‚é”ã€‘å¿…é¡»æ˜ç¡®æŒ‡å®š mechanic
        && (p.canDynamax || (p.megaTargetId && p.megaTargetId.toLowerCase().includes('gmax')));
    if (isDynamaxMode) {
        // === æå·¨åŒ–æ¨¡å¼ ===
        if (battle.playerMaxUsed || p.isDynamaxed) {
            return;
        }
        battle.playerMegaArmed = !battle.playerMegaArmed;
        if (battle.playerMegaArmed) {
            megaBtn.classList.add('armed');
            log(`<span style="color:#e11d48">âœ¦ æå·¨åŒ–å°±ç»ªï¼é€‰æ‹©æ‹›å¼åå°†è¿›è¡Œæå·¨åŒ–ï¼</span>`);
        } else {
            megaBtn.classList.remove('armed');
            log(`<span style="color:#94a3b8">å–æ¶ˆæå·¨åŒ–é¢„å¤‡ã€‚</span>`);
        }
        return;
    }
    // === æ™®é€š Mega æ¨¡å¼ ===
    // ã€ä¿®å¤ã€‘å¿…é¡»æ£€æŸ¥ unlocks.enable_mega === true
    const megaUnlocks = battle.playerUnlocks || {};
    if (!p || megaUnlocks.enable_mega !== true || !canMegaEvolveFunc || !canMegaEvolveFunc(p) || battle.playerMegaUsed) {
        return;
    }
    // æ£€æŸ¥æ˜¯å¦æ˜¯åŒ Mega å®å¯æ¢¦ï¼ˆå–·ç«é¾™/è¶…æ¢¦ï¼‰
    if (p.hasDualMega && p.megaFormsAvailable && p.megaFormsAvailable.length >= 2) {
        // å¦‚æœå·²ç»é¢„å¤‡ï¼Œåˆ™å–æ¶ˆ
        if (battle.playerMegaArmed) {
            battle.playerMegaArmed = false;
            megaBtn.classList.remove('armed');
            log(`<span style="color:#94a3b8">å–æ¶ˆ Mega è¿›åŒ–é¢„å¤‡ã€‚</span>`);
            return;
        }
        // æ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
        if (typeof showMegaFormSelectionDialog === 'function') {
            showMegaFormSelectionDialog(p, (selectedFormId) => {
                if (selectedFormId) {
                    p.megaTargetId = selectedFormId;
                    p.formTargetId = selectedFormId;
                    battle.playerMegaArmed = true;
                    megaBtn.classList.add('armed');
                    const formName = selectedFormId.includes('megax') ? 'Mega X' : 'Mega Y';
                    log(`<span style="color:#a855f7">âœ¦ ${formName} è¿›åŒ–å°±ç»ªï¼é€‰æ‹©æ‹›å¼åå°†è¿›è¡Œ Mega è¿›åŒ–ï¼</span>`);
                }
            });
        }
    } else {
        // æ™®é€š Megaï¼ˆå•ä¸€å½¢æ€ï¼‰
        battle.playerMegaArmed = !battle.playerMegaArmed;
        if (battle.playerMegaArmed) {
            megaBtn.classList.add('armed');
            log(`<span style="color:#a855f7">âœ¦ Mega è¿›åŒ–å°±ç»ªï¼é€‰æ‹©æ‹›å¼åå°†è¿›è¡Œ Mega è¿›åŒ–ï¼</span>`);
        } else {
            megaBtn.classList.remove('armed');
            log(`<span style="color:#94a3b8">å–æ¶ˆ Mega è¿›åŒ–é¢„å¤‡ã€‚</span>`);
        }
    }
}
// ============================================
// å¯¼å‡º
// ============================================
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    window.showMovesMenu = showMovesMenu;
    window.showMainMenu = showMainMenu;
    window.updateMegaButtonVisibility = updateMegaButtonVisibility;
    window.toggleMega = toggleMega;
    window.playMegaEvolutionAnimation = playMegaEvolutionAnimation;
    window.playDynamaxAnimation = playDynamaxAnimation;
    window.endDynamaxAnimation = endDynamaxAnimation;
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        showMovesMenu,
        showMainMenu,
        toggleMega,
        updateMegaButtonVisibility,
        playMegaEvolutionAnimation,
        playDynamaxAnimation,
        endDynamaxAnimation
    };
}
]]></file>
        <file name="ui-renderer.js"><![CDATA[/**
 * ===========================================
 * UI-RENDERER.JS - æ ¸å¿ƒ UI æ¸²æŸ“
 * ===========================================
 * 
 * èŒè´£:
 * - è¡€æ¡æ¸²æŸ“
 * - ç²¾çµçƒæ§½æ¸²æŸ“
 * - UI ç¼©æ”¾
 */
// ============================================
// UI ç¼©æ”¾
// ============================================
/**
 * å›ºå®šç”»å¸ƒç­‰æ¯”ç¼©æ”¾ (åŸºå‡† 1280x720)
 */
function updateUIScale() {
    const baseW = 1280;
    const baseH = 720;
    const pad = 0;
    const vw = Math.max(0, window.innerWidth - pad * 2);
    const vh = Math.max(0, window.innerHeight - pad * 2);
    const scale = Math.min(vw / baseW, vh / baseH);
    const el = document.getElementById('ui-scale');
    if (!el) return;
    el.style.setProperty('--ui-scale', String(scale));
}
// ============================================
// è¡€æ¡æ¸²æŸ“
// ============================================
/**
 * æ¸²æŸ“è¡€æ¡
 * @param {string} who 'player' æˆ– 'enemy'
 * @param {number} curr å½“å‰ HP
 * @param {number} max æœ€å¤§ HP
 */
function renderHp(who, curr, max) {
    const pct = Math.max(0, (curr / max) * 100);
    const bar = document.getElementById(`${who}-hp-fill`);
    const txt = document.getElementById(`${who}-hp-txt`);
    if (bar) {
        bar.style.width = pct + "%";
        bar.style.background = pct < 20 ? 'var(--hp-low)' : (pct < 50 ? 'var(--hp-mid)' : 'var(--hp-high)');
    }
    if (txt) txt.innerText = `${curr}/${max}`;
}
// ============================================
// ç²¾çµçƒæ§½æ¸²æŸ“
// ============================================
/**
 * æ¸²æŸ“ 6 ä¸ªç²¾çµçƒæ§½ä½œä¸ºçŠ¶æ€æ˜¾ç¤º
 * @param {string} idBox DOM å…ƒç´  ID
 * @param {Array} party é˜Ÿä¼æ•°ç»„
 * @param {number} idxActive å½“å‰å‡ºæˆ˜ç´¢å¼•
 */
function renderDots(idBox, party, idxActive) {
    const box = document.getElementById(idBox);
    if (!box) return;
    box.innerHTML = '';
    for (let i = 0; i < 6; i++) {
        const slot = document.createElement('div');
        slot.className = 'poke-slot';
        if (i >= party.length) {
            slot.classList.add('empty');
        } else {
            const pm = party[i];
            if (pm.isAlive()) {
                slot.classList.add('alive');
            } else {
                slot.classList.add('dead');
            }
            if (i === idxActive) {
                slot.classList.add('active');
            }
        }
        box.appendChild(slot);
    }
}
// ============================================
// å¯¼å‡º
// ============================================
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    window.updateUIScale = updateUIScale;
    window.renderHp = renderHp;
    window.renderDots = renderDots;
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        updateUIScale,
        renderHp,
        renderDots
    };
}
]]></file>
        <file name="ui-sprites.js"><![CDATA[/**
 * ===========================================
 * UI-SPRITES.JS - ç²¾çµå›¾åŠ è½½ä¸ç®¡ç†
 * ===========================================
 * 
 * èŒè´£:
 * - ç²¾çµå›¾æ™ºèƒ½åŠ è½½ï¼ˆæ”¯æŒå¤šå›¾åº“å›é€€ï¼‰
 * - ID å˜ä½“ç”Ÿæˆï¼ˆæ”¯æŒåœ°åŒºå½¢æ€ã€Mega ç­‰ï¼‰
 * - ç²¾çµå›¾çŠ¶æ€é‡ç½®
 */
// ============================================
// çŠ¶æ€ç®¡ç†
// ============================================
// è®°å½•æ¯ä¸ªç²¾çµå½“å‰è¯·æ±‚çš„åŸå§‹URLï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½ï¼‰
const spriteRequestedUrls = {};
// ============================================
// ID å˜ä½“ç”Ÿæˆ
// ============================================
/**
 * ç”Ÿæˆ ID å˜ä½“ï¼ˆæ”¯æŒå¸¦æ¨ªæ çš„å®å¯æ¢¦åå­—ï¼‰
 * @param {string} name åŸå§‹åç§°
 * @returns {object} åŒ…å«å¤šç§ ID å˜ä½“çš„å¯¹è±¡
 */
function generateIdVariants(name = '') {
    const raw = name.toLowerCase().trim();
    // 1. ä¸¥æ ¼æ¨¡å¼ (ä¿ç•™æ¨ªæ ): "vulpix-alola", "ho-oh"
    const strict = raw.replace(/[^a-z0-9-]/g, '');
    // 2. ç´§å‡‘æ¨¡å¼ (æ— æ¨ªæ ): "vulpixalola", "hooh"
    const compact = raw.replace(/[^a-z0-9]/g, '');
    // 3. åŸºç¡€æ¨¡å¼ (å°è¯•ç§»é™¤åç¼€): "vulpix-alola" -> "vulpix"
    const suffixes = [
        '-alola', '-galar', '-hisui', '-paldea',
        '-mega', '-megax', '-megay', '-gmax',
        '-origin', '-therian', '-incarnate',
        '-black', '-white', '-dusk', '-dawn',
        '-school', '-complete', '-attack', '-defense', '-speed',
        '-primal', '-combat', '-blaze', '-aqua'
    ];
    let base = strict;
    for (const suffix of suffixes) {
        if (base.endsWith(suffix)) {
            base = base.replace(suffix, '');
            break;
        }
    }
    // ä¿ç•™ç‰¹æ®Šåå­—çš„æ¨ªæ 
    if (base !== 'ho-oh' && base !== 'porygon-z' && base !== 'jangmo-o' && base !== 'hakamo-o' && base !== 'kommo-o') {
        base = base.replace(/-/g, '');
    }
    return { strict, compact, base };
}
// ============================================
// æ™ºèƒ½ç²¾çµå›¾åŠ è½½
// ============================================
/**
 * æ™ºèƒ½åŠ è½½ç²¾çµå›¾ï¼ˆæ”¯æŒå¤šå›¾åº“å›é€€ï¼‰
 * @param {string} id DOM å…ƒç´  ID
 * @param {string} url ç›®æ ‡ URL
 * @param {boolean} forceAnim æ˜¯å¦å¼ºåˆ¶æ’­æ”¾å…¥åœºåŠ¨ç”»
 */
function smartLoadSprite(id, url, forceAnim = false) {
    const img = document.getElementById(id);
    if (!img) return;
    // å¦‚æœè¯·æ±‚çš„URLæ²¡å˜ä¸”å·²åŠ è½½å®Œæˆï¼Œè·³è¿‡ï¼ˆé¿å…é‡å¤åŠ è½½ï¼‰
    if (!forceAnim && spriteRequestedUrls[id] === url && img.classList.contains('loaded')) {
        return;
    }
    // å¼ºåˆ¶é‡æ’­åŠ¨ç”»ï¼ˆæ¢äººæ—¶ï¼‰
    if (forceAnim && spriteRequestedUrls[id] === url && img.classList.contains('loaded')) {
        console.log(`[SPRITE] Replay entry animation for: ${url}`);
        img.classList.remove('entering');
        void img.offsetWidth;
        img.classList.add('entering');
        setTimeout(() => img.classList.remove('entering'), 650);
        return;
    }
    // è®°å½•æœ¬æ¬¡è¯·æ±‚çš„åŸå§‹URL
    spriteRequestedUrls[id] = url;
    // æ ‡è®°æ˜¯å¦å·²ç»æ’­æ”¾è¿‡å…¥åœºåŠ¨ç”»
    let hasPlayedAnimation = false;
    // æ’­æ”¾å…¥åœºåŠ¨ç”»çš„helper
    const playEntryAnimation = () => {
        if (!hasPlayedAnimation) {
            hasPlayedAnimation = true;
            img.classList.remove('entering');
            void img.offsetWidth;
            img.classList.add('entering');
            setTimeout(() => img.classList.remove('entering'), 650);
        }
    };
    // === å…³é”®ä¿®å¤ï¼šä½¿ç”¨é¢„åŠ è½½ï¼Œå®Œå…¨åŠ è½½åå†ä¸€æ¬¡æ€§åˆ‡æ¢ ===
    const tryLoadUrl = (targetUrl, fallbackUrls = []) => {
        console.log(`[SPRITE] Trying to load: ${targetUrl}, fallbacks: ${fallbackUrls.length}`);
        const preloader = new Image();
        preloader.onload = () => {
            console.log(`[SPRITE] SUCCESS: ${preloader.src}`);
            // ã€å…³é”®ã€‘å¦‚æœ URL å˜åŒ–äº†ï¼ˆçœŸæ­£çš„ç²¾çµå›¾åˆ‡æ¢ï¼‰ï¼Œè§¦å‘æ·¡å…¥æ•ˆæœ
            const isUrlChanged = img.src !== preloader.src;
            if (isUrlChanged) {
                // URL å˜åŒ–ï¼šç§»é™¤ loaded ç±»è§¦å‘æ·¡å…¥
                img.style.transition = 'none';
                img.classList.remove('loaded', 'fainted-hidden', 'fainting', 'entering');
                img.src = preloader.src;
                void img.offsetWidth; // å¼ºåˆ¶é‡æ’
                img.style.transition = '';
                img.classList.add('loaded');
            } else {
                // URL æœªå˜ï¼šåªç§»é™¤åŠ¨ç”»ç±»ï¼Œä¿æŒæ˜¾ç¤ºçŠ¶æ€
                img.classList.remove('fainted-hidden', 'fainting', 'entering');
                img.src = preloader.src;
                if (!img.classList.contains('loaded')) {
                    img.classList.add('loaded');
                }
            }
            playEntryAnimation();
        };
        preloader.onerror = () => {
            console.log(`[SPRITE] FAILED: ${targetUrl}, trying next fallback...`);
            if (fallbackUrls.length > 0) {
                tryLoadUrl(fallbackUrls[0], fallbackUrls.slice(1));
            } else {
                console.log(`[SPRITE] All fallbacks exhausted for: ${targetUrl}`);
                // === åŠ¨æ€æ£€æµ‹éå®˜æ–¹ Megaï¼šæ‰€æœ‰å›é€€éƒ½å¤±è´¥ ===
                const originalUrl = spriteRequestedUrls[id] || url;
                const megaMatch = originalUrl.match(/sprites\/(ani|ani-back)\/(.+?)\.gif$/);
                if (megaMatch && megaMatch[2].includes('mega')) {
                    const isBack = megaMatch[1] === 'ani-back';
                    const baseId = megaMatch[2].replace(/mega[xy]?$/, '').replace(/-$/, '');
                    const baseSpriteUrl = `https://play.pokemonshowdown.com/sprites/${isBack ? 'ani-back' : 'ani'}/${baseId}.gif`;
                    console.log(`[SPRITE] Unofficial Mega detected! Falling back to base form: ${baseSpriteUrl}`);
                    img.classList.add('unofficial-mega');
                    const baseLoader = new Image();
                    baseLoader.onload = () => {
                        img.style.transition = 'none';
                        img.classList.remove('loaded', 'entering');
                        img.src = baseLoader.src;
                        void img.offsetWidth;
                        img.style.transition = '';
                        img.classList.add('loaded');
                        playEntryAnimation();
                    };
                    baseLoader.onerror = () => {
                        img.style.transition = 'none';
                        img.classList.remove('loaded', 'entering');
                        img.src = targetUrl;
                        void img.offsetWidth;
                        img.style.transition = '';
                        img.classList.add('loaded');
                    };
                    baseLoader.src = baseSpriteUrl;
                    return;
                }
                img.style.transition = 'none';
                img.classList.remove('loaded', 'entering');
                img.src = targetUrl;
                void img.offsetWidth;
                img.style.transition = '';
                img.classList.add('loaded');
            }
        };
        preloader.src = targetUrl;
    };
    // æ„å»ºå›é€€URLåˆ—è¡¨
    const m = url.match(/https?:\/\/play\.pokemonshowdown\.com\/sprites\/(ani|ani-back|ani-back-shiny|ani-shiny)\/(.+?)\.gif$/);
    if (m) {
        const spriteFolder = m[1];
        const isBack = spriteFolder.includes('back');
        const isShiny = spriteFolder.includes('shiny');
        const spriteId = m[2];
        const { strict, compact, base } = generateIdVariants(spriteId);
        const baseId = typeof getFallbackSpriteId === 'function' ? getFallbackSpriteId(spriteId) : base;
        const idVariants = [spriteId];
        if (strict !== spriteId) idVariants.push(strict);
        if (compact !== spriteId && compact !== strict) idVariants.push(compact);
        const semiCompact = spriteId.replace(/-([a-z]+)-/g, '-$1');
        if (semiCompact !== spriteId && !idVariants.includes(semiCompact)) {
            idVariants.push(semiCompact);
        }
        if (baseId !== spriteId && !idVariants.includes(baseId)) {
            idVariants.push(baseId);
        }
        const fallbacks = [];
        const isMega = spriteId.includes('mega');
        const isGmax = spriteId.includes('gmax');
        const isPrimal = spriteId.includes('primal');
        const isSpecialForm = isMega || isGmax || isPrimal;
        const aniFolder = isShiny 
            ? (isBack ? 'ani-back-shiny' : 'ani-shiny')
            : (isBack ? 'ani-back' : 'ani');
        const frontFolder = isShiny ? 'ani-shiny' : 'ani';
        const gen5aniFolder = isBack ? 'gen5ani-back' : 'gen5ani';
        const gen5Folder = isBack ? 'gen5-back' : 'gen5';
        const formVariants = idVariants.filter(id => id !== baseId);
        if (isSpecialForm) {
            // ç‰¹æ®Šå½¢æ€ä¼˜å…ˆ
            for (const id of formVariants) {
                if (id !== spriteId) {
                    fallbacks.push(`https://play.pokemonshowdown.com/sprites/${aniFolder}/${id}.gif`);
                }
            }
            if (isBack) {
                for (const id of formVariants) {
                    fallbacks.push(`https://play.pokemonshowdown.com/sprites/${frontFolder}/${id}.gif`);
                }
            }
            // pkparaiso å›¾åº“
            let pkparaisoId = spriteId;
            if (/mega[xy]?$/i.test(pkparaisoId)) {
                pkparaisoId = pkparaisoId.replace(/mega([xy])?$/i, '-mega$1');
            } else if (/gmax$/i.test(pkparaisoId)) {
                pkparaisoId = pkparaisoId.replace(/gmax$/i, '-gmax');
            } else if (/primal$/i.test(pkparaisoId)) {
                pkparaisoId = pkparaisoId.replace(/primal$/i, '-primal');
            }
            const pkparaisoFolder = isBack ? 'animados-espalda' : 'animados';
            const isORASForm = spriteId.includes('rayquaza') || spriteId.includes('primal');
            const pkparaisoGen = isORASForm ? 'rubi-omega-zafiro-alfa' : (isGmax ? 'espada_escudo' : 'xy');
            fallbacks.push(`https://www.pkparaiso.com/imagenes/${pkparaisoGen}/sprites/${pkparaisoFolder}/${pkparaisoId}.gif`);
            for (const id of formVariants) {
                fallbacks.push(`https://play.pokemonshowdown.com/sprites/${gen5aniFolder}/${id}.gif`);
            }
            for (const id of formVariants) {
                fallbacks.push(`https://play.pokemonshowdown.com/sprites/${gen5Folder}/${id}.png`);
            }
            // æœ€åå›é€€åˆ°åŸºç¡€å½¢æ€
            fallbacks.push(`https://play.pokemonshowdown.com/sprites/${aniFolder}/${baseId}.gif`);
            if (isBack) {
                fallbacks.push(`https://play.pokemonshowdown.com/sprites/${frontFolder}/${baseId}.gif`);
            }
            fallbacks.push(`https://play.pokemonshowdown.com/sprites/${gen5aniFolder}/${baseId}.gif`);
            fallbacks.push(`https://play.pokemonshowdown.com/sprites/${gen5Folder}/${baseId}.png`);
        } else {
            // æ™®é€šå½¢æ€æŒ‰å±‚çº§å›é€€
            for (const id of idVariants) {
                if (id !== spriteId) {
                    fallbacks.push(`https://play.pokemonshowdown.com/sprites/${aniFolder}/${id}.gif`);
                }
            }
            if (isBack) {
                for (const id of idVariants) {
                    fallbacks.push(`https://play.pokemonshowdown.com/sprites/${frontFolder}/${id}.gif`);
                }
            }
            for (const id of idVariants) {
                fallbacks.push(`https://play.pokemonshowdown.com/sprites/${gen5aniFolder}/${id}.gif`);
            }
            for (const id of idVariants) {
                fallbacks.push(`https://play.pokemonshowdown.com/sprites/${gen5Folder}/${id}.png`);
            }
        }
        // Pokesprite å›¾åº“ï¼ˆåªæœ‰æ­£é¢å›¾ï¼‰
        if (!isBack) {
            for (const id of idVariants) {
                fallbacks.push(`https://raw.githubusercontent.com/msikma/pokesprite/master/pokemon-gen8/regular/${id}.png`);
            }
        }
        tryLoadUrl(url, fallbacks);
    } else {
        tryLoadUrl(url, []);
    }
}
// ============================================
// ç²¾çµå›¾çŠ¶æ€é‡ç½®
// ============================================
/**
 * é‡ç½®ç²¾çµå›¾çŠ¶æ€
 */
function resetSpriteState() {
    ['player-sprite', 'enemy-sprite'].forEach(id => {
        const sprite = document.getElementById(id);
        if (!sprite) return;
        sprite.classList.remove('fainted-hidden', 'fainting', 'entering', 'loaded', 'shake-hit-anim');
        sprite.style.removeProperty('opacity');
        sprite.style.removeProperty('transform');
    });
}
// ============================================
// å¯¼å‡º
// ============================================
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    window.spriteRequestedUrls = spriteRequestedUrls;
    window.generateIdVariants = generateIdVariants;
    window.smartLoadSprite = smartLoadSprite;
    window.resetSpriteState = resetSpriteState;
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        spriteRequestedUrls,
        generateIdVariants,
        smartLoadSprite,
        resetSpriteState
    };
}
]]></file>
        <file name="ui-trainer-hud.js"><![CDATA[/**
 * ===========================================
 * UI-TRAINER-HUD.JS - è®­ç»ƒå®¶å¤´åƒä¸ Cut-in ç³»ç»Ÿ
 * ===========================================
 * 
 * èŒè´£:
 * - è®­ç»ƒå®¶å¤´åƒæ˜¾ç¤ºä¸åŠ è½½
 * - å¤´åƒ ID è§£æä¸å›é€€
 * - Cut-in å‰§åœºåŒ–æ¼”å‡ºç³»ç»Ÿ
 */
// ============================================
// å¤´åƒåº“é…ç½®
// ============================================
const AVATAR_LIBRARY = [
    'player',
    'wild',
    'gloria',
    'rosa',
    'dawn',
    'akari',
    'serena',
    'lusamine',
    'lillie',
    'mallow',
    'lana',
    'irida',
    'roxie',
    'iono',
    'erika',
    'nessa',
    'marnie',
    'hexmaniac',
    'bea',
    'cynthia',
    'sonia',
    'juliana',
    'selene',
    'may',
    'lacey',
    'misty',
    'acerola',
    'skyla',
    'iris',
    'nemona'
];
const AVATAR_ALIAS_MAP = {
    hex: 'hexmaniac'
};
const NORMALIZED_AVATARS = AVATAR_LIBRARY.map(name => ({
    original: name,
    normalized: name.toLowerCase().replace(/[^a-z0-9]/g, '')
}));
// ç”¨äºè®­ç»ƒå®¶å¤´åƒç¼ºå¤±æ—¶çš„é—®å·å¤‡ç”¨å›¾
const MISSING_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23f1f3f6'/%3E%3Cpath fill='%23dde1e7' d='M0,0 L200,200 L200,0 Z' opacity='0.3'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='900' font-size='120' fill='%23cbd5e1'%3E?%3C/text%3E%3Crect x='10' y='10' width='180' height='180' rx='20' fill='none' stroke='%23cbd5e1' stroke-width='8' stroke-dasharray='15,15'/%3E%3C/svg%3E";
// ============================================
// å¤´åƒ ID è§£æ
// ============================================
/**
 * è§£æå¤´åƒ ID
 * @param {string} source åŸå§‹æ¥æºï¼ˆè®­ç»ƒå®¶åç§°æˆ– IDï¼‰
 * @returns {string|null} è§£æåçš„å¤´åƒ ID
 */
function resolveAvatarId(source) {
    const slug = String(source || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]/g, '');
    if (!slug) return null;
    if (AVATAR_ALIAS_MAP[slug]) {
        return AVATAR_ALIAS_MAP[slug];
    }
    const exact = NORMALIZED_AVATARS.find(entry => entry.normalized === slug);
    if (exact) return exact.original;
    const partial = NORMALIZED_AVATARS.find(entry =>
        entry.normalized.includes(slug) || slug.includes(entry.normalized)
    );
    return partial ? partial.original : null;
}
// ============================================
// è®­ç»ƒå®¶åç§°æ ¼å¼åŒ–
// ============================================
/**
 * æ ¼å¼åŒ–è®­ç»ƒå®¶åç§°
 * @param {Object} trainer è®­ç»ƒå®¶å¯¹è±¡
 * @returns {string} æ ¼å¼åŒ–åçš„åç§°
 */
function formatTrainerName(trainer) {
    if (!trainer) return 'TRAINER';
    if (trainer.displayName) return trainer.displayName;
    if (trainer.name_en) return trainer.name_en;
    if (trainer.id && trainer.id !== 'wild') {
        return trainer.id
            .split(/[-_]/)
            .filter(Boolean)
            .map(part => part.charAt(0).toUpperCase() + part.slice(1))
            .join(' ');
    }
    return 'TRAINER';
}
// ============================================
// è®­ç»ƒå®¶ HUD æ›´æ–°
// ============================================
/**
 * æ›´æ–°è®­ç»ƒå®¶ HUD æ˜¾ç¤º
 */
function updateTrainerHud() {
    const hud = document.getElementById('trainer-hud');
    const nameEl = document.getElementById('trainer-name');
    const avatarEl = document.getElementById('trainer-avatar');
    if (!hud || !nameEl || !avatarEl) return;
    const battle = typeof window !== 'undefined' ? window.battle : null;
    const t = battle?.trainer;
    if (!t) {
        hud.classList.add('hidden');
        return;
    }
    const isWild = t.id === 'wild' || !t.id;
    if (isWild) {
        hud.classList.add('hidden');
        return;
    }
    const displayName = (t.name || '').trim();
    if (displayName) {
        nameEl.textContent = displayName.replace(/^./, match => match.toUpperCase());
    } else {
        nameEl.textContent = 'Unknown';
    }
    const resolvedFromName = resolveAvatarId(displayName);
    const resolvedFromId = resolveAvatarId(t.id);
    const rawId = String(t.id || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '');
    const candidates = [];
    if (resolvedFromId) candidates.push(resolvedFromId);
    if (resolvedFromName) candidates.push(resolvedFromName);
    if (rawId) candidates.push(rawId);
    if (displayName) candidates.push(displayName.toLowerCase());
    const uniqueCandidates = [...new Set(candidates)].filter(Boolean);
    let attemptIndex = 0;
    avatarEl.onload = null;
    avatarEl.onerror = null;
    const tryNext = () => {
        if (attemptIndex >= uniqueCandidates.length) {
            avatarEl.onload = null;
            avatarEl.onerror = () => { hud.classList.add('hidden'); };
            avatarEl.src = MISSING_AVATAR;
            hud.classList.remove('hidden');
            return;
        }
        const candidate = uniqueCandidates[attemptIndex++];
        avatarEl.onload = () => {
            hud.classList.remove('hidden');
        };
        avatarEl.onerror = () => {
            tryNext();
        };
        avatarEl.src = `data/avatar/${candidate}.png`;
    };
    tryNext();
}
// ============================================
// Cut-in å‰§åœºåŒ–æ¼”å‡ºç³»ç»Ÿ
// ============================================
/**
 * æ’­æ”¾ Cut-in æ¼”å‡º
 * @param {string} text æ¼”å‡ºæ–‡æœ¬
 * @param {number} duration æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 */
function playCutIn(text, duration = 3000) {
    if (!text) return;
    const stage = document.getElementById('cutin-stage');
    const nameEl = document.getElementById('cutin-name');
    const textEl = document.getElementById('cutin-text');
    const imgEl = document.getElementById('cutin-avatar');
    if (!stage || !nameEl || !textEl || !imgEl) return;
    const battle = typeof window !== 'undefined' ? window.battle : null;
    const trainer = battle?.trainer;
    const trainerName = trainer?.name || trainer?.title || 'ENEMY';
    nameEl.textContent = trainerName;
    textEl.textContent = text;
    const isWild = trainer?.id === 'wild';
    let targetSrc = '';
    if (isWild) {
        const enemySprite = document.getElementById('enemy-sprite');
        if (enemySprite?.src) {
            targetSrc = enemySprite.src;
        }
    } else {
        const trainerHudImg = document.getElementById('trainer-avatar');
        if (trainerHudImg?.src) {
            targetSrc = trainerHudImg.src;
        }
    }
    if (targetSrc && !targetSrc.includes('html')) {
        imgEl.style.opacity = '';
        imgEl.src = targetSrc;
    } else {
        imgEl.style.opacity = 0;
    }
    stage.classList.remove('hidden', 'outro');
    void stage.offsetWidth;
    stage.classList.add('active');
    clearTimeout(stage._cutinTimer);
    stage._cutinTimer = setTimeout(() => {
        stage.classList.remove('active');
        stage.classList.add('outro');
        clearTimeout(stage._cutinHideTimer);
        stage._cutinHideTimer = setTimeout(() => {
            stage.classList.add('hidden');
            stage.classList.remove('outro');
        }, 650);
    }, duration);
}
// ============================================
// å¯¼å‡º
// ============================================
// æµè§ˆå™¨ç¯å¢ƒ
if (typeof window !== 'undefined') {
    window.AVATAR_LIBRARY = AVATAR_LIBRARY;
    window.AVATAR_ALIAS_MAP = AVATAR_ALIAS_MAP;
    window.NORMALIZED_AVATARS = NORMALIZED_AVATARS;
    window.MISSING_AVATAR = MISSING_AVATAR;
    window.resolveAvatarId = resolveAvatarId;
    window.formatTrainerName = formatTrainerName;
    window.updateTrainerHud = updateTrainerHud;
    window.playCutIn = playCutIn;
}
// Node.js ç¯å¢ƒ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        AVATAR_LIBRARY,
        AVATAR_ALIAS_MAP,
        NORMALIZED_AVATARS,
        MISSING_AVATAR,
        resolveAvatarId,
        formatTrainerName,
        updateTrainerHud,
        playCutIn
    };
}
]]></file>
    </directory>
    <file name="index.css"><![CDATA[/* ============================================
   Web Font Imports - è§†è§‰å‡çº§
   ============================================ */
/* M PLUS Rounded 1c - æ—¥ç³»åœ†ä½“ï¼Œå®Œç¾å¥‘åˆå®å¯æ¢¦UIé£æ ¼ */
@import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800;900&display=swap');
/* Noto Sans SC - æ€æºé»‘ä½“ï¼Œä¸­æ–‡æ˜¾ç¤ºæ›´ä¼˜ */
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap');
.trainer-avatar-wrap img {
    text-indent: -9999px;
    color: transparent;
}
.trainer-avatar-wrap img:not([src]),
.trainer-avatar-wrap img[src=""] {
    opacity: 0;
}
.hidden {
    display: none !important;
}
:root {
    --bg-base: #f4f6fd;
    --primary-white: #ffffff;
    --primary-pink: #fa709a;
    --primary-dark: #403b4a;
    --accent-yellow: #fee140;
    --accent-blue: #00f2fe;
    --hp-high: #4fd1c5;
    --hp-mid: #fbc63e;
    --hp-low: #ff6b6b;
    /* å­—ä½“å‡çº§ï¼šä¼˜å…ˆåœ†ä½“ï¼Œå›é€€åˆ°ç³»ç»Ÿå­—ä½“ */
    --font-main: 'M PLUS Rounded 1c', 'Noto Sans SC', 'Microsoft YaHei UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
    --font-number: 'Rubik', 'M PLUS Rounded 1c', monospace;
    --radius-l: 18px;
    --radius-m: 12px;
    --color-fight: #ff5e78;
    --color-pokemon: #4fabff;
    --color-run: #ffb830;
    --color-catch: #4ade80;
    --ui-glass: rgba(255, 255, 255, 0.95);
}
@keyframes spawn-rise {
    0% {
        opacity: 0;
        transform: translateY(40px) scale(calc(var(--sprite-scale, 1) * 0.45));
    }
    50% {
        opacity: 0.85;
        transform: translateY(-10px) scale(calc(var(--sprite-scale, 1) * 1.05));
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(var(--sprite-scale, 1));
    }
}
@keyframes spawn-rise-enemy {
    0% {
        opacity: 0;
        transform: translateY(-20px) scale(calc(var(--sprite-scale, 1) * 1.35)) rotate(-3deg);
    }
    40% {
        opacity: 0.65;
        transform: translateY(25px) scale(calc(var(--sprite-scale, 1) * 0.8)) rotate(2deg);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(var(--sprite-scale, 1)) rotate(0deg);
    }
}
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    /* å­—ä½“æŠ—é”¯é½¿ä¼˜åŒ– */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    background: transparent;
    width: 100vw;
    height: 100vh;
}
.ui-root {
    position: relative;
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(circle at top, rgba(20,20,30,0.1), transparent), #000;
    overflow: hidden;
}
.bg-gradient {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    opacity: 0.3;
    background-size: cover !important;
    background-position: center center !important;
    background-repeat: no-repeat !important;
}
.ui-scale {
    width: 1100px !important;
    height: 720px !important;
    flex-shrink: 0;
    position: relative;
    z-index: 10;
    margin: 0;
    border-radius: 32px;
    overflow: hidden;
    box-shadow: none;
    transform-origin: center center;
    transform: scale(var(--ui-scale, 1));
    background: #eef1f5;
    text-shadow:
        1.5px 0px 1px rgba(255, 0, 80, 0.15),
        -1.5px 0px 1px rgba(0, 240, 255, 0.15);
}
/* å¤å¤ç”µè§†å“‘å…‰é®ç½© */
.screen-filters {
    position: absolute;
    inset: 0;
    z-index: 9999;
    pointer-events: none;
    backdrop-filter: brightness(1.05) contrast(0.92) grayscale(0.1) sepia(0.05) blur(0.5px);
    background:
        linear-gradient(rgba(0, 0, 0, 0) 66%, rgba(0, 0, 0, 0.15) 66%),
        radial-gradient(circle at center, transparent 50%, rgba(10, 20, 30, 0.25) 90%, rgba(0, 0, 0, 0.4) 100%);
    background-size: 100% 3px, 100% 100%;
    mix-blend-mode: normal;
}
.screen-filters::before {
    content: "";
    position: absolute;
    inset: -10px;
    z-index: 10;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.5'/%3E%3C/svg%3E");
    box-shadow: inset 1px 0px 1px rgba(255, 0, 0, 0.15), inset -1px 0px 1px rgba(0, 255, 255, 0.15);
    opacity: 0.12;
    pointer-events: none;
    animation: noise-move 0.2s steps(4) infinite;
}
.screen-filters::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, transparent 40%, rgba(255,255,255,0.02) 100%);
    pointer-events: none;
    z-index: 11;
}
@keyframes noise-move {
    0%, 100% { transform: translate(0, 0); }
    10% { transform: translate(-3px, -2px); }
    50% { transform: translate(2px, 3px); }
    80% { transform: translate(-2px, 1px); }
}
.ui-scale::after {
    content: "";
    position: absolute;
    inset: 0;
    z-index: 9998;
    pointer-events: none;
    background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPjxyZWN0IHdpZHRoPSI0IiBoZWlnaHQ9IjQiIGZpbGw9IiNmZmYiLz48cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxIiBmaWxsPSIjY2NjIi8+PC9zdmc+');
    background-size: 2px 2px;
    opacity: 0.1;
    mix-blend-mode: multiply;
}
.overlay-screen {
    position: absolute;
    inset: 0;
    background: rgba(250, 250, 250, 0.85);
    backdrop-filter: blur(15px);
    z-index: 800;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.5s ease;
}
.result-screen {
    position: absolute;
    inset: 0;
    z-index: 999;
    background: rgba(15, 20, 25, 0.85);
    backdrop-filter: blur(15px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}
.result-screen.active {
    opacity: 1;
    pointer-events: auto;
}
.start-card {
    background: white;
    padding: 60px 100px;
    border-radius: 40px;
    box-shadow: 0 20px 60px rgba(250, 112, 154, 0.2);
    text-align: center;
    border: 4px solid var(--primary-pink);
    transform: rotate(-2deg);
}
.logo-title {
    font-size: 3.5rem;
    margin: 0;
    color: var(--primary-dark);
    font-weight: 900;
    text-shadow: -2px 0 var(--accent-blue), 2px 0 var(--primary-pink);
    letter-spacing: -2px;
}
.logo-title .accent {
    color: var(--primary-pink);
}
.loader-notch {
    width: 120px;
    height: 10px;
    border-radius: 999px;
    margin: 22px auto 18px;
    background: linear-gradient(90deg, rgba(250,112,154,0.2), rgba(250,112,154,0.9), rgba(0,242,254,0.65));
    filter: blur(0.2px);
}
.sys-msg {
    color: #999;
    font-size: 0.9rem;
    letter-spacing: 2px;
    margin-top: 10px;
    font-weight: 700;
}
.start-btn {
    margin-top: 30px;
    background: var(--primary-pink);
    color: white;
    border: none;
    padding: 15px 50px;
    font-size: 1.5rem;
    cursor: pointer;
    font-family: inherit;
    font-weight: 900;
    border-radius: 50px;
    box-shadow: 0 5px 0 #d64d78;
    transition: transform 0.1s;
}
.start-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #d64d78; }
.start-btn:disabled {
    cursor: default;
    background: #ccc;
    box-shadow: none;
    opacity: 0.5;
}
.game-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.game-container.hidden {
    display: none;
}
.battle-stage {
    position: relative;
    flex: 1;
    overflow: hidden;
}
/* ============================================
   Canvas ç²’å­å¤©æ°”ç³»ç»Ÿ
   ============================================ */
#weather-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    pointer-events: none;
    opacity: 0;
    transition: opacity 1s ease;
}
/* å¤©æ°”èƒŒæ™¯è‰²è°ƒæ»¤é•œå®¹å™¨ - ç¡®ä¿æœ‰ blur æˆ– opacity è¿‡æ¸¡ */
.bg-gradient {
    transition: filter 1.5s ease, background-color 1.5s ease;
    backdrop-filter: blur(0px); /* é»˜è®¤æ— æ¨¡ç³Š */
    background-size: cover !important;
    background-position: center center !important;
    background-repeat: no-repeat !important;
}
/* ================== åŸç‰ˆå¤©æ°” ================== */
.bg-rain, .bg-heavyrain { 
    background-color: rgba(160, 180, 200, 0.35) !important;
    background-size: cover !important;
    background-position: center center !important;
}
.bg-sand { 
    background-color: rgba(210, 180, 140, 0.4) !important;
    background-size: cover !important;
    background-position: center center !important;
}
.bg-snow, .bg-hail { 
    background-color: rgba(166, 198, 230, 0.55) !important;
    background-size: cover !important;
    background-position: center center !important;
}
.bg-sun { 
    background-color: rgba(255, 240, 200, 0.5) !important;
    background-size: cover !important;
    background-position: center center !important;
}
.bg-harshsun { 
    background-color: rgba(252, 148, 64, 0.5) !important;
    background-size: cover !important;
    background-position: center center !important;
}
.bg-deltastream { 
    background-color: rgba(100, 220, 200, 0.35) !important;
    background-size: cover !important;
    background-position: center center !important;
}
/* ================== å®è£…çš„æ–°ç‰¹æ®Šå¤©æ°” ================== */
/* Smog (NåŒº): è‚®è„çš„ç´«ç»¿è‰²éœ“è™¹å·¥ä¸šåºŸæ°” */
.bg-smog {
    background-color: rgba(120, 80, 140, 0.55) !important;
    background-size: cover !important;
    background-position: center center !important;
}
/* Ashfall (AåŒº): æ²‰é‡å‹æŠ‘çš„æ·±ç°è‰²ç«å±±åŒº */
.bg-ashfall {
    background-color: rgba(80, 80, 90, 0.55) !important;
    background-size: cover !important;
    background-position: center center !important;
}
/* Fog (SåŒº): æš—å½±è¿·é›¾ - æµ…ç°è“è‰²éš§é“è§†è§‰ */
@keyframes fog-breathe {
    0% { backdrop-filter: blur(2px) grayscale(20%); }
    50% { backdrop-filter: blur(5px) grayscale(40%); }
    100% { backdrop-filter: blur(2px) grayscale(20%); }
}
.bg-fog {
    /* æµ…ç°è“è‰²å¾„å‘æ¸å˜ï¼šä¸­å¿ƒæ¸…æ™°ï¼Œå››å‘¨æµ“é‡ */
    background: radial-gradient(
        ellipse 70% 80% at center, 
        rgba(0, 110, 255, 0.25) 20%, 
        rgba(32, 90, 176, 0.55) 55%, 
        rgba(31, 85, 167, 0.9) 100%
    ) !important;
    /* åŠ¨æ€æ¨¡ç³Šå‘¼å¸æ•ˆæœ */
    backdrop-filter: blur(3px) grayscale(25%);
    animation: fog-breathe 6s ease-in-out infinite;
}
/* Gale (BåŒº): æ¹¿æ¶¦çƒ­å¸¦é£“é£ - å……æ»¡èŠ±ç²‰ä¸ç”Ÿå‘½åŠ› */
@keyframes gale-sway {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
.bg-gale {
    /* æ¸å˜ï¼šé’ç»¿è‰²åˆ°ç²‰è‰²èŠ±ç“£è‰²è°ƒ */
    background: linear-gradient(
        135deg,
        rgba(100, 200, 150, 0.35) 0%,
        rgba(135, 206, 235, 0.25) 40%,
        rgba(255, 182, 193, 0.3) 70%,
        rgba(144, 238, 144, 0.35) 100%
    ) !important;
    background-size: 200% 200%;
    animation: gale-sway 8s ease-in-out infinite;
    /* è½»å¾®æ¨¡ç³Šå¢åŠ æ¹¿æ¶¦æ„Ÿ */
    backdrop-filter: blur(1px) saturate(120%);
}
/* Ambrosia (ç¥ä¹‹ç¼æµ†): è¯¡å¼‚ã€é«˜é¥±å’Œåº¦çš„äº®ç²‰/æ´‹çº¢è‰²ç¥é¦”èƒ½é‡ */
@keyframes ambrosia-pulse {
    0% { 
        background-position: 0% 50%;
        filter: brightness(1) saturate(1.2);
    }
    50% { 
        background-position: 100% 50%;
        filter: brightness(1.1) saturate(1.4);
    }
    100% { 
        background-position: 0% 50%;
        filter: brightness(1) saturate(1.2);
    }
}
.bg-ambrosia {
    /* æ¸å˜ï¼šäº®ç²‰è‰²åˆ°æ´‹çº¢è‰²åˆ°ç´«è‰² */
    background: linear-gradient(
        135deg,
        rgba(255, 105, 180, 0.5) 0%,
        rgba(255, 20, 147, 0.45) 30%,
        rgba(219, 112, 219, 0.4) 60%,
        rgba(186, 85, 211, 0.45) 100%
    ) !important;
    background-size: 200% 200%;
    animation: ambrosia-pulse 6s ease-in-out infinite;
    /* è½»å¾®æ¨¡ç³Šå¢åŠ ç¥ç§˜æ„Ÿ */
    backdrop-filter: blur(2px) saturate(130%);
}
/* ================== Chronal Rift (æ—¶ç©ºè£‚éš™) ================== */
.bg-distortion {
    background-color: #f5f5f5 !important;
    background-size: cover !important;
    background-position: center center !important;
}
.sprite-wrapper {
    position: absolute;
    pointer-events: none;
}
.p-sprite {
    --sprite-scale: 1;
    opacity: 0;
    transition: opacity 0.5s ease-out, transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
.p-sprite.mega-player {
    --sprite-scale: 1.5;
    filter: drop-shadow(0 0 18px rgba(147, 197, 253, 0.55));
}
.p-sprite.mega-enemy {
    --sprite-scale: 1.2;
    filter: drop-shadow(0 0 16px rgba(250, 113, 113, 0.55));
}
/* éå®˜æ–¹ Megaï¼ˆRadical Red / ROM Hackï¼‰- ä½¿ç”¨åŸå§‹å›¾ç‰‡ + ç‰¹æ®Šæ»¤é•œ */
.p-sprite.unofficial-mega {
    --sprite-scale: 1.15;
    filter: 
        drop-shadow(0 0 20px rgba(220, 38, 127, 0.8))
        drop-shadow(0 0 10px rgba(147, 51, 234, 0.6))
        saturate(1.4)
        brightness(1.1)
        contrast(1.2);
    animation: unofficial-mega-pulse 2s ease-in-out infinite;
}
@keyframes unofficial-mega-pulse {
    0%, 100% {
        filter: 
            drop-shadow(0 0 20px rgba(220, 38, 127, 0.8))
            drop-shadow(0 0 10px rgba(147, 51, 234, 0.6))
            saturate(1.4)
            brightness(1.1)
            contrast(1.2);
    }
    50% {
        filter: 
            drop-shadow(0 0 25px rgba(220, 38, 127, 1))
            drop-shadow(0 0 15px rgba(147, 51, 234, 0.8))
            saturate(1.5)
            brightness(1.15)
            contrast(1.25);
    }
}
.p-sprite {
    width: 100%;
    height: 100%;
    object-fit: contain;
    image-rendering: pixelated;
    filter: contrast(1.15) brightness(1.05) drop-shadow(4px 8px 6px rgba(0, 0, 0, 0.3));
    transform: translateY(0) scale(var(--sprite-scale));
    animation:
        var(--sprite-animation, none),
        var(--sprite-faint-animation, none),
        var(--sprite-entry-animation, none);
}
.p-sprite.loaded { opacity: 1; }
.p-sprite.fainted-hidden {
    opacity: 0 !important;
    visibility: hidden;
}
.p-sprite.entering {
    --sprite-entry-animation: spawn-rise 0.55s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}
.enemy-pos .p-sprite.entering {
    --sprite-entry-animation: spawn-rise-enemy 0.65s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}
.sprite-wrapper::after {
    content: '';
    position: absolute;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 15px;
    background: rgba(60, 50, 80, 0.18);
    border-radius: 50%;
    z-index: -1;
    opacity: 0.35;
    filter: blur(2px);
    transition: opacity 0.25s ease;
}
.sprite-wrapper.sprite-empty::after {
    opacity: 0;
}
.enemy-pos {
    top: 15%;
    right: 10%;
    width: 250px;
    height: 250px;
    z-index: 2;
}
.player-pos {
    bottom: 200px;
    left: 150px;
    width: 260px;
    height: 270px;
    z-index: 5;
}
.shadow-base {
    display: none;
}
.player-scale {
    --sprite-scale: 1.4;
    transform-origin: center bottom;
}
.hud {
    position: absolute;
    z-index: 10;
    width: 320px;
    filter: drop-shadow(4px 10px 0 rgba(70, 70, 80, 0.1));
    background: var(--primary-white);
    border-radius: var(--radius-l);
    padding: 15px 20px;
    border: none;
    box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.15);
}
.panel-enemy {
    top: 40px;
    left: 40px;
}
.panel-player {
    bottom: 250px;
    right: 40px;
    z-index: 11;
}
.hud-top {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 6px;
}
.hud-top.right-align {
    justify-content: space-between;
}
.p-name {
    font-family: var(--font-main);
    font-size: 1.4rem;
    font-weight: 800;
    color: var(--primary-dark);
}
.p-lv {
    color: #888;
    font-size: 1rem;
    font-weight: 700;
    white-space: nowrap;
}
.p-lv-capsule {
    background: var(--accent-yellow);
    color: #5d5122;
    padding: 2px 10px;
    border-radius: 20px;
    font-weight: 800;
    font-size: 0.9em;
    white-space: nowrap;
}
.ball-slots {
    display: flex;
    gap: 6px;
}
.ball-slots.right {
    justify-content: flex-end;
}
.dot {
    width: 12px;
    height: 12px;
    background: #e0e0e0;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 1px #ddd;
    transition: 0.3s;
}
.dot.alive {
    background: var(--primary-pink);
    box-shadow: 0 0 0 1px var(--primary-pink);
}
.dot.dead {
    background: #555;
}
.dot.active {
    outline: 2px solid rgba(250, 112, 154, 0.35);
    outline-offset: 2px;
}
.hp-badge {
    position: absolute;
    right: 0;
    bottom: -30px;
    background: var(--primary-dark);
    color: white;
    padding: 4px 12px;
    border-radius: 0 0 10px 10px;
    font-size: 1rem;
    font-weight: 700;
    pointer-events: none;
}
.hp-nums {
    text-align: right;
    font-size: 0.9rem;
    font-weight: 800;
    margin-top: 6px;
    color: #6d6874;
}
.hp-container {
    height: 12px;
    background: #444;
    border-radius: 6px;
    overflow: hidden;
    position: relative;
    border: none;
    box-shadow: none;
}
.panel-enemy .hp-container {
    height: 10px;
    margin-top: 10px;
}
.hp-bar-bg {
    width: 100%;
    height: 12px;
    background: transparent;
    border-radius: 20px;
}
.main-hp .hp-bar-bg {
    height: 18px;
    border-radius: 10px;
}
.hp-fill {
    height: 100%;
    width: 100%;
    background: var(--hp-high);
    transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.4s;
    box-shadow: none;
    border-right: 2px solid rgba(255, 255, 255, 0.85);
}
.command-dashboard {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 220px;
    display: flex;
    gap: 16px;
    padding: 10px 10px 10px 10px;
    box-sizing: border-box;
    background: linear-gradient(to top, rgba(255, 255, 255, 0.95), transparent);
    z-index: 50;
    clip-path: polygon(0 20%, 5% 0, 100% 0, 100% 100%, 0 100%);
}
.log-entry {
    margin-bottom: 6px;
    padding-left: 10px;
    border-left: 3px solid rgba(250, 112, 154, 0.35);
    position: relative;
}
.log-entry:last-child {
    font-weight: 800;
    color: #2e2a35;
}
/* =========================================
   ä¸»èœå• (æˆ˜æ–—/å®å¯æ¢¦/é€ƒè·‘)
   ========================================= */
.main-menu {
    flex: 2;
    display: flex;
    flex-direction: column;
    gap: 12px;
    height: 100%;
}
.menu-btn {
    flex: 1;
    border: none;
    background: white;
    color: var(--primary-dark);
    cursor: pointer;
    font-family: inherit;
    font-size: 1.6rem;
    font-weight: 900;
    border: 3px solid #eee;
    border-radius: 14px;
    box-shadow: 4px 4px 0 #bbb;
    transition: all 0.12s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}
.menu-btn::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 8px;
    border-radius: 10px 0 0 10px;
}
.menu-btn.fight::before { background: var(--primary-pink); }
.menu-btn.pokemon::before { background: var(--accent-blue); }
.menu-btn.run::before { background: var(--accent-yellow); }
.menu-btn:hover {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0 #999;
}
.menu-btn:active {
    transform: translate(3px, 3px);
    box-shadow: 1px 1px 0 #888;
}
.menu-label {
    text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.08);
    opacity: 0;
}
/* =========================================
   MODERN RESULT CARD (Switch / SV style)
   ========================================= */
.result-screen.hidden {
    display: none;
}
.res-modern-card {
    width: 680px;
    background: #f7f9fc;
    border-radius: 24px;
    overflow: hidden;
    position: relative;
    box-shadow:
        0 25px 50px -12px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.1);
    transform: scale(0.95);
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    display: flex;
    flex-direction: column;
}
.result-screen.active .res-modern-card {
    transform: scale(1);
}
.res-header-banner {
    background: var(--res-color, #718093);
    color: white;
    padding: 20px 30px 50px;
    position: relative;
    clip-path: polygon(0 0, 100% 0, 100% 85%, 0% 100%);
}
.res-header-content {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.res-modern-card.theme-win { --res-color: #f1c40f; --res-color-dark: #d35400; }
.res-modern-card.theme-win .res-header-banner {
    background: linear-gradient(135deg, #fbc531 0%, #e1b12c 100%);
    color: #2f3640;
}
.res-modern-card.theme-loss { --res-color: #e74c3c; --res-color-dark: #c0392b; }
.res-modern-card.theme-loss .res-header-banner {
    background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
}
.res-modern-card.theme-escape { --res-color: #95a5a6; --res-color-dark: #7f8c8d; }
.res-modern-card.theme-escape .res-header-banner {
    background: linear-gradient(135deg, #b2bec3 0%, #636e72 100%);
}
.res-flag {
    font-size: 0.8rem;
    font-weight: 900;
    letter-spacing: 2px;
    opacity: 0.8;
}
.res-big-title {
    margin: 5px 0 0;
    font-size: 3.5rem;
    font-style: italic;
    font-weight: 900;
    text-transform: uppercase;
    line-height: 0.9;
    transform: skewX(-5deg);
    text-shadow: 3px 3px 0 rgba(0,0,0,0.1);
}
.res-header-pattern {
    position: absolute;
    right: 0; top: 0; bottom: 0; left: 40%;
    background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.08) 0, rgba(255,255,255,0.08) 10px, transparent 10px, transparent 20px);
    pointer-events: none;
}
.res-rank-stamp-wrap {
    position: absolute;
    top: 25px;
    right: 40px;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
}
.res-rank-ring {
    width: 90px;
    height: 90px;
    background: #fff;
    border: 5px solid var(--res-color-dark, #ccc);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transform: rotate(15deg);
    color: var(--res-color-dark, #ccc);
    animation: stamp-bounce 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) 0.2s both;
}
@keyframes stamp-bounce {
    from { opacity: 0; transform: scale(3) rotate(-30deg); }
    to { opacity: 1; transform: scale(1) rotate(15deg); }
}
#res-grade-letter {
    font-size: 3rem;
    font-weight: 900;
    line-height: 0.8;
}
#res-grade-sub {
    font-size: 0.65em;
    font-weight: 800;
    background: var(--res-color-dark, #ccc);
    color: white;
    padding: 1px 6px;
    border-radius: 4px;
    line-height: 1;
    margin-top: 2px;
}
.res-body {
    padding: 0 35px 20px;
}
.res-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: -10px;
    z-index: 10;
    position: relative;
}
.res-info-tile {
    background: white;
    border-radius: 12px;
    padding: 12px 18px;
    box-shadow: 0 4px 0 #edf0f5;
    border: 1px solid #eef2f7;
    display: flex;
    flex-direction: column;
}
.res-info-tile.full-width {
    grid-column: span 2;
}
.res-info-tile.description-tile {
    background: #fff;
    border-left: 5px solid var(--res-color, #999);
    flex-direction: row;
    align-items: center;
    gap: 12px;
}
.tile-label {
    font-size: 0.7rem;
    font-weight: 900;
    color: #b2bec3;
    margin-bottom: 4px;
    letter-spacing: 0.5px;
}
.tile-val {
    font-weight: 800;
    color: #2d3436;
    font-size: 1.1rem;
    line-height: 1.2;
}
.tile-val.major {
    font-size: 1.3rem;
}
.tile-icon {
    font-size: 1.5rem;
}
.tile-val.text-desc {
    font-weight: 600;
    font-size: 1rem;
    color: #636e72;
}
.mini-party-dots {
    display: flex;
    gap: 6px;
    height: 18px;
    align-items: center;
}
.res-info-tile.team-tile {
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
}
.mini-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 1px #ddd;
    background: #eee;
}
.mini-dot.hp-100 { background: #4fd1c5; }
.mini-dot.hp-mid { background: #fbc63e; }
.mini-dot.hp-low { background: #ff6b6b; }
.mini-dot.hp-dead {
    background: #444;
    position: relative;
    opacity: 0.6;
}
.mini-dot.hp-dead::after {
    content: "Ã—";
    position: absolute;
    left: 0;
    right: 0;
    text-align: center;
    color: white;
    line-height: 12px;
    font-weight: bold;
}
.res-pills-action {
    padding: 24px 35px 30px;
    display: flex;
    gap: 16px;
    background: #fff;
    border-top: 1px solid #f0f0f0;
}
.pill-btn {
    border: none;
    border-radius: 500px;
    height: 64px;
    cursor: pointer;
    font-family: inherit;
    font-weight: 800;
    font-size: 1.1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.pill-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}
.pill-btn:active {
    transform: translateY(-1px);
}
.pill-btn.restart,
.pill-btn.sec {
    background: #f0f2f5;
    color: #636e72;
    padding: 0 24px;
}
.pill-btn.restart {
    flex: 0.7;
    font-size: 0.85rem;
    color: #999;
}
.pill-btn.restart svg {
    margin-bottom: 4px;
}
.pill-btn.sec {
    flex: 1;
}
.pill-btn.primary {
    flex: 2;
    background: var(--res-color, #2d3436);
    color: white;
    box-shadow: 0 8px 15px -4px currentColor;
}
.res-modern-card.theme-win .pill-btn.primary {
    color: #000;
    box-shadow: 0 8px 15px -4px rgba(241, 196, 15, 0.5);
}
.pill-btn.primary .btn-text {
    font-size: 1.25rem;
    letter-spacing: 0.5px;
}
.pill-btn.primary .btn-sub {
    font-size: 0.75rem;
    opacity: 0.7;
    font-weight: normal;
    margin-top: 2px;
}
#res-clipboard-text {
    position: absolute;
    width: 1px;
    height: 1px;
    opacity: 0;
    pointer-events: none;
    border: none;
    resize: none;
}
.moves-menu {
    flex: 2;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 12px;
    height: 100%;
}
.moves-menu.hidden,
.main-menu.hidden {
    display: none;
}
/* è¿”å›æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
.action-btn.back {
    background: #f5f5f5;
    border-color: #ddd;
    color: #888;
}
.action-btn.back:hover:enabled {
    background: #eee;
    color: #666;
}
/* =========================================
   æ”¹è‰¯ç‰ˆèœå•æ ·å¼ - P5 x SWSH Refined
   ========================================= */
.main-menu {
    flex: 2.2;
    position: relative;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: flex-start;
    gap: 0;
    pointer-events: none;
    margin-left: 0;
}
.radical-menu-container {
    display: flex;
    align-items: stretch;
    justify-content: flex-start;
    gap: 16px;
    width: 100%;
    height: 100%;
    padding: 10px 5px;
    perspective: 1000px;
    pointer-events: auto;
    box-sizing: border-box;
}
.radical-btn {
    border: 1px solid rgba(55, 65, 81, 0.3);
    cursor: pointer;
    position: relative;
    background: #fff;
    padding: 0;
    outline: none;
    transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.25), box-shadow 0.2s;
    border-radius: 16px;
    transform: skewX(-15deg);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
}
.skew-fix {
    width: 100%;
    height: 100%;
    transform: skewX(15deg);
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: flex-end;
    padding-right: 20px;
    position: relative;
    z-index: 2;
}
.btn-fight {
    flex: 1.5;
    color: var(--color-fight);
    background: #fff;
    z-index: 10;
}
.btn-fight .skew-fix {
    justify-content: flex-end;
    padding-right: 35px;
}
.r-icon-bg {
    display: none;
}
.btn-fight .r-icon {
    width: 200px;
    height: 200px;
    opacity: 0.22;
    position: absolute;
    right: -25px;
    bottom: -60px;
    transform: rotate(5deg) scale(1.1);
    fill: color-mix(in srgb, var(--color-fight) 85%, #000);
    transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
}
.btn-fight .r-label {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    z-index: 5;
    transform: translateY(2px);
}
.btn-fight .en {
    font-family: var(--font-main);
    font-size: 3.8rem;
    font-weight: 900;
    line-height: 0.85;
    letter-spacing: -2px;
    display: block;
    text-transform: uppercase;
    font-style: italic;
    text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
}
.btn-fight .jp {
    font-size: 1rem;
    font-weight: 800;
    opacity: 0.4;
    letter-spacing: 0.4em;
    margin-top: 6px;
    margin-right: 4px;
    border-bottom: 3px solid rgba(255, 94, 120, 0.3);
}
.btn-fight:hover {
    background: var(--color-fight); 
    color: white; 
    border-color: var(--color-fight); 
    box-shadow: 6px 6px 0 rgba(0,0,0,0.15); 
    transform: skewX(-15deg) scale(1.05) translateY(-3px); 
    z-index: 20;
}
.btn-fight:hover .r-icon {
    opacity: 0.3;
    transform: rotate(-10deg) scale(1.0) translateX(-20px);
    fill: #000;
}
.radical-sub-group {
    flex: 1.1;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.radical-sub-group.two-btn .radical-btn {
    flex: 0 0 45%;
}
.radical-sub-group .radical-btn {
    flex: 1;
    border-radius: 12px;
    border: 1px solid rgba(55, 65, 81, 0.3);
    background: #fff;
}
.radical-sub-group .radical-btn .skew-fix {
    justify-content: flex-start;
    padding-left: 20px;
}
.btn-pokemon {
    color: var(--color-pokemon);
    margin-left: 16px;
}
.btn-run {
    color: var(--color-run);
    margin-left: -10px;
    width: 96%;
    align-self: flex-end;
}
.r-icon.small {
    width: 90px;
    height: 90px;
    opacity: 0.22;
    position: absolute;
    right: 5px;
    bottom: -25px;
    transform: rotate(5deg);
    transition: 0.3s;
    fill: rgba(0,0,0,0.25);
}
.r-label-min {
    font-size: 1.9rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -1px;
    font-style: italic;
    text-shadow: 1px 1px 0 rgba(0,0,0,0.05);
}
.btn-pokemon .r-icon.small {
    fill: color-mix(in srgb, var(--color-pokemon) 80%, #000);
}
.btn-run .r-icon.small {
    fill: color-mix(in srgb, var(--color-run) 80%, #000);
}
.btn-pokemon:hover {
    background: var(--color-pokemon);
    color: white;
    border-color: var(--color-pokemon);
    box-shadow: 6px 6px 0 rgba(20, 50, 80, 0.15);
    transform: skewX(-15deg) scale(1.05) translateX(5px);
}
.btn-pokemon:hover .r-icon.small {
    opacity: 0.3;
    fill: #000;
    transform: rotate(-10deg) scale(1.1);
}
.btn-run:hover {
    background: var(--color-run);
    color: white;
    border-color: var(--color-run);
    box-shadow: 6px 6px 0 rgba(80, 60, 20, 0.12);
    transform: skewX(-15deg) scale(1.05) translateX(5px);
}
.btn-run:hover .r-label-min {
    color: #fff;
    text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
}
.btn-run:hover .r-icon.small {
    opacity: 0.3;
    fill: #000;
    transform: translateX(5px) rotate(0deg);
}
.btn-catch {
    color: var(--color-catch) !important;
    background: #fff;
    margin-left: 25px;
}
.btn-catch .r-icon.small {
    color: color-mix(in srgb, var(--color-catch) 80%, #000);
    fill: currentColor;
    transform: rotate(8deg) scale(1);
    transition: transform 0.35s ease, opacity 0.35s ease, color 0.35s ease;
    opacity: 0.35;
}
.btn-catch:hover {
    background: var(--color-catch) !important;
    color: #fff !important;
    border-color: var(--color-catch) !important;
    box-shadow: 6px 6px 0 rgba(40, 160, 80, 0.15) !important;
    transform: skewX(-15deg) scale(1.05) translateX(5px) !important;
}
.btn-catch:hover .r-icon.small {
    color: #000;
    fill: #000 !important;
    opacity: 1 !important;
    transform: rotate(-12deg) scale(1.15);
}
.radical-btn:active {
    transition: 0.05s;
    transform: skewX(-15deg) scale(0.98);
    box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
}
.radical-sub-group .r-label-min {
    position: relative;
    z-index: 5;
}
.radical-sub-group .radical-btn:hover .r-icon.small {
    opacity: 1;
    filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.2));
}
.r-label-min {
    font-family: var(--font-main);
    font-size: 1.6rem;
    font-weight: 800;
    font-style: normal;
    text-transform: uppercase;
    letter-spacing: 0;
}
.radical-btn .en,
.radical-btn .jp,
.r-label-min {
    font-weight: 900;
}
.radical-btn .en,
.radical-btn .jp {
    text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.15);
}
.radical-btn:active {
    filter: none;
}
.btn-fight:active .r-icon {
    transform: scale(0.9);
}
.action-btn {
    border: none;
    background: white;
    color: var(--primary-dark);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 10px;
    transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
    position: relative;
    border: 3px solid #eee;
    border-radius: 12px;
    box-shadow: 4px 4px 0 #bbb;
}
.action-btn:hover:enabled {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0 #999;
    color: var(--primary-pink);
    background: #fffafa;
}
.action-btn:active:enabled {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0 #999;
}
.action-btn:disabled {
    opacity: 0.5;
    cursor: default;
    filter: grayscale(1);
}
.action-btn .move-name {
    font-size: 1.3rem;
    font-weight: 900;
    margin-bottom: 4px;
    pointer-events: none;
    text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1);
    font-family: var(--font-main);
}
.action-btn .move-type {
    font-size: 0.8em;
    opacity: 0.6;
    pointer-events: none;
    text-transform: uppercase;
    font-weight: bold;
    font-family: var(--font-main);
}
.action-btn.util {
    background: var(--accent-blue);
    color: white;
    box-shadow: 0 8px 0 #00bfcb, 0 15px 15px rgba(0, 242, 254, 0.3);
}
.action-btn.util .move-name {
    color: #024;
}
.action-btn .badge-type {
    position: absolute;
    bottom: 8px;
    right: 15px;
    pointer-events: none;
    border: none;
    box-shadow: none;
    border-radius: 8px;
    font-size: 0.7em;
    font-family: var(--font-main);
}
.overlay-modal {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(245, 246, 253, 0.92);
    z-index: 200;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}
.overlay-modal.hidden {
    display: none;
}
.cutin-overlay {
    position: absolute;
    inset: 0;
    z-index: 2000;
    pointer-events: none;
    display: flex;
    justify-content: flex-end;
    align-items: flex-start;
    padding-top: 3%;
    padding-right: 25px;
    overflow: hidden;
}
.compact-bar {
    position: relative;
    background: rgba(30, 39, 46, 0.90);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 60px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    display: flex;
    align-items: center;
    box-shadow:
        0 10px 25px rgba(0,0,0,0.4),
        0 4px 10px rgba(0,0,0,0.1);
    min-width: 260px;
    max-width: 360px;
    height: 70px;
    transform: translateX(150%);
    opacity: 0;
    transition:
        transform 0.5s cubic-bezier(0.22, 1, 0.36, 1),
        opacity 0.4s ease;
}
.compact-bar.hidden {
    display: none;
}
.compact-bar.active {
    display: flex;
    transform: translateX(0);
    opacity: 1;
}
.compact-bar.outro {
    transform: translateX(120%);
    opacity: 0;
    transition:
        transform 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53),
        opacity 0.3s ease;
}
.deco-edge {
    width: 6px;
    height: 60%;
    background: var(--accent-yellow);
    border-radius: 10px;
    margin-left: 20px;
    margin-right: 15px;
    box-shadow: 0 0 10px rgba(254, 225, 64, 0.3);
}
.compact-content {
    display: flex;
    align-items: center;
    gap: 12px;
    padding-right: 28px;
    max-width: 100%;
}
.avatar-slot {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.9);
    box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    overflow: hidden;
    background: #555;
    flex-shrink: 0;
}
.c-avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #e0e0e0;
}
.text-slot {
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: white;
    min-width: 160px;
    max-width: 320px;
}
.c-name-strip {
    font-size: 0.65rem;
    color: #dfe6e9;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    line-height: 1.2;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    font-family: var(--font-main);
}
.container-enemy .party-track.enemy-side {
    margin-bottom: -4px;
    margin-left: 6px;
    transform: skewX(-22deg);
    height: 24px;
}
.container-player .party-track.player-side {
    margin-top: 2px;
    margin-left: -4px;
    justify-content: flex-end;
    height: 28px;
    transform: translateX(-22px) skewX(-22deg);
}
.container-player .party-track .poke-slot {
    width: 19px;
    height: 19px;
}
.container-enemy .party-track .poke-slot {
    width: 17px;
    height: 17px;
}
.c-name-strip::before {
    content: 'â—†';
    font-size: 0.6em;
    color: var(--primary-pink);
    margin-right: 4px;
}
.c-dialogue {
    font-family: var(--font-main);
    font-size: 0.98rem;
    font-weight: 600;
    line-height: 1.35;
    color: #fff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    overflow: hidden;
    display: -webkit-box;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}
.switch-header {
    text-align: center;
    color: var(--primary-dark);
}
.switch-header h2 {
    font-size: 2rem;
    margin-bottom: 5px;
}
.switch-grid-v2 {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(2, 1fr);
    padding: 20px;
}
.p-card {
    background: white;
    border-radius: 20px;
    padding: 15px;
    display: flex;
    gap: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    border: 3px solid transparent;
    transition: 0.2s;
}
.p-card.active {
    border-color: var(--accent-blue);
    background: #f7feff;
}
.p-card:hover:not(.active) {
    border-color: var(--primary-pink);
    transform: scale(1.02);
}
.card-icon {
    width: 70px;
    height: 70px;
    background: #f4f4f4;
    border-radius: 50%;
    margin-right: 10px;
}
.card-info .name {
    color: var(--primary-dark);
}
.card-info .lvl {
    color: #bbb;
}
.switch-hp-bar {
    background: #eee;
    height: 8px;
    border-radius: 4px;
}
.shake-hit-anim,
.shake-hit {
    --sprite-animation: shake-hard 0.4s cubic-bezier(.36, .07, .19, .97) both;
}
@keyframes shake-hard {
    10% { transform: translateX(-10px) scale(var(--sprite-scale, 1)); }
    50% { transform: translateX(10px) scale(var(--sprite-scale, 1)); }
    100% { transform: translateX(0) scale(var(--sprite-scale, 1)); }
}
.p-sprite.fainting {
    --sprite-faint-animation: faint-blip 0.7s ease forwards;
}
@keyframes faint-blip {
    0% {
        opacity: 1;
        transform: translateY(0) scale(var(--sprite-scale, 1));
    }
    15% {
        opacity: 0.25;
        transform: translateY(0) scale(calc(var(--sprite-scale, 1) * 0.92));
    }
    35% {
        opacity: 0.85;
        transform: translateY(-6px) scale(calc(var(--sprite-scale, 1) * 0.85));
    }
    55% {
        opacity: 0.2;
        transform: translateY(12px) scale(calc(var(--sprite-scale, 1) * 0.55));
    }
    100% {
        opacity: 0;
        transform: translateY(40px) scale(calc(var(--sprite-scale, 1) * 0.25));
    }
}
/* =========================================================
   ä¿®æ­£ç‰ˆå¸ƒå±€ - å½»åº•è§£å†³é‡å é—®é¢˜
   ========================================================= */
/* 1. ä»ªè¡¨ç›˜æ€»å®¹å™¨ */
.command-dashboard {
    position: absolute;
    bottom: 24px;
    left: 24px;
    right: 24px;
    height: 190px;
    display: flex;
    gap: 30px; 
    padding: 0;
    box-sizing: border-box;
    background: transparent;
    z-index: 50;
    clip-path: none;
    perspective: 1000px;
}
.msg-box-modern {
    flex: 0 0 40%; 
    width: 40%; 
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
    background: #fff;
    border: 1px solid rgba(55, 65, 81, 0.2);
    transform: skewX(-15deg);
    margin-left: -39px;
    border-radius: 16px;
    box-shadow:
        8px 8px 0 rgba(20, 30, 40, 0.15), 
        inset 0 0 0 1px rgba(255, 255, 255, 0.8);
    overflow: hidden;
    transition: all 0.3s ease;
    padding: 0;
    font-family: var(--font-main);
}
.msg-header,
.msg-content-area {
    transform: skewX(15deg);
    transform-origin: center center;
    margin: 0 16px;
}
.msg-header {
    flex: 0 0 42px;
    width: 112%;
    margin-left: -6%;
    background: #f1f3f6;
    border-bottom: 3px solid #e0e4eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-left: 30px;
    padding-right: 50px;
    box-sizing: border-box;
    position: relative;
    z-index: 5;
}
.sys-label {
    font-size: 0.9rem;
    font-weight: 950;
    letter-spacing: 1px;
    color: var(--primary-dark);
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: var(--font-main);
}
.sys-label::before {
    content: '';
    width: 14px;
    height: 14px;
    background: var(--accent-blue);
    border: 2px solid #fff;
    box-shadow: 2px 2px 0 rgba(0,0,0,0.15);
    border-radius: 4px;
    transform: rotate(15deg);
}
.sys-dots { display: none; }
.msg-content-area {
    flex: 1;
    padding: 12px 10px;
    overflow-y: auto;
    font-size: 0.95rem;
    line-height: 1.6;
    color: #334155;
    scrollbar-width: none;
    padding-right: 20px;
    margin-right: -10px;
    font-family: var(--font-main);
    mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 100%);
    margin: 0 10px;
    margin-right: -10px;
}
.msg-content-area::-webkit-scrollbar {
    display: none;
}
.log-entry {
    margin-bottom: 6px;
    font-size: 1rem;
    color: #64748b;
    line-height: 1.4;
    font-weight: 600;
    opacity: 0.7;
    padding-left: 2px;
    font-family: var(--font-main);
}
.log-entry:last-child {
    font-size: 1.25rem;
    color: #333;
    font-weight: 800;
    margin-top: 8px;
    padding-left: 12px;
    border-left: 6px solid var(--accent-blue);
    background: linear-gradient(90deg, rgba(82, 226, 255, 0.1) 0%, transparent 100%);
    opacity: 1;
    border-radius: 0 8px 8px 0;
    text-shadow: 1px 1px 0 #fff;
    animation: simpleSlideIn 0.25s ease-out;
}
@keyframes simpleSlideIn {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}
.hl-dmg {
    color: white;
    background: #ef4444;
    padding: 0 5px;
    border-radius: 4px;
    box-shadow: 1px 1px 0 rgba(0,0,0,0.2);
}
.hl-crit {
    color: #b45309;
    padding: 2px 6px;
    border: 2px solid var(--accent-yellow);
    background: #fffbeb;
    font-weight: 900;
    font-style: italic;
    display: inline-block;
    transform: rotate(-3deg);
}
.next-cursor {
    position: absolute;
    bottom: -5px;
    right: -5px;
    width: 0;
    height: 0;
    border-bottom: 30px solid var(--accent-blue);
    border-left: 30px solid transparent;
    animation: cursor-bounce 1s infinite;
    opacity: 1;
    z-index: 10;
}
@keyframes cursor-bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(5px);
    }
}
.hl-sup {
    color: #fff;
    background: var(--color-fight);
    padding: 1px 8px;
    clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
    font-size: 0.85em;
    margin-left: 6px;
}
.hl-res {
    color: #475569;
    background: #cbd5e1;
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 0.85em;
    margin-left: 6px;
}
.hl-sys {
    color: var(--accent-blue);
    font-weight: 800;
}
.main-menu {
    margin-left: 5px;
    z-index: 60;
}
/* 
   2. å³ä¾§æ“ä½œé¢æ¿é€šç”¨å¤–å£³ (æ ¸å¿ƒä¿®æ­£ç‚¹)
   ä¸å†å¼ºåˆ¶æ‹‰ä¼¸å®½åº¦ï¼Œä¸¥æ ¼éµå®ˆ flex è¾¹ç•Œ 
*/
.main-menu, .moves-menu {
    flex: 1; 
    width: auto; 
    height: 100%;
    margin-left: 0; 
    background: #fff;
    border: 1px solid rgba(55, 65, 81, 0.2);
    border-radius: 16px;
    transform: skewX(-15deg);
    box-shadow: 6px 6px 0 rgba(20, 30, 40, 0.08);
    padding: 0;
    overflow: hidden; 
    pointer-events: auto;
    animation: simpleOpacity 0.3s ease-out;
    font-family: Rubik;
}
@keyframes simpleOpacity { from { opacity: 0; } to { opacity: 1; } }
.main-menu.hidden, .moves-menu.hidden {
    display: none;
}
/* =========================================
   ä¸»èœå• (FIGHT/RUN) - ä»…éœ€åŒæ­¥å†…éƒ¨è¾¹è·
   ========================================= */
.radical-menu-container {
     transform: skewX(15deg); /* åå‘æ‰¶æ­£ */
     height: 100%;
     width: 100%; 
     display: flex;
     margin: 0;
     padding: 10px 25px; 
     box-sizing: border-box;
     font-family: Rubik;
}
/* =========================================
   B. æŠ€èƒ½èœå• (Moves Menu) - é«˜åº¦ç˜¦èº« & æ ·å¼é‡æ„
   ========================================= */ 
.moves-menu {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 12px;
    padding: 20px 30px;
    box-sizing: border-box;
    width: auto;
    margin-left: 0; 
    height: 100%;
    position: relative;
    overflow: visible;
    font-family: var(--font-main);
}
/* æŠ€èƒ½æŒ‰é’® - æç®€ç§‘å¹»é£æ ¼ */
.action-btn {
    position: relative;
    background: #ffffff;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    outline: none;
    overflow: hidden;
    /* Switchå¹³é¢é£æ ¼ */
    border-radius: 8px;
    box-shadow: 
        4px 4px 0 rgba(0,0,0,0.15),
        inset 0 0 0 1px rgba(255,255,255,0.8);
    transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s;
    /* å¼¹æ€§å¸ƒå±€ï¼šå·¦å›¾å³å­— */
    display: flex;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    font-family: var(--font-main);
}
/* ç±»å‹é¢œè‰²å®šä¹‰ (CSSå˜é‡) */
.action-btn[data-type="bug"]      { --type-color: #92BC2C; }
.action-btn[data-type="dark"]     { --type-color: #595761; }
.action-btn[data-type="dragon"]   { --type-color: #0C69C8; }
.action-btn[data-type="electric"] { --type-color: #F2D94E; }
.action-btn[data-type="fire"]     { --type-color: #FBA54C; }
.action-btn[data-type="fairy"]    { --type-color: #EE90E6; }
.action-btn[data-type="fighting"] { --type-color: #D3425F; }
.action-btn[data-type="flying"]   { --type-color: #A1BBEC; }
.action-btn[data-type="ghost"]    { --type-color: #5F6DBC; }
.action-btn[data-type="grass"]    { --type-color: #5FBD58; }
.action-btn[data-type="ground"]   { --type-color: #DA7C4D; }
.action-btn[data-type="ice"]      { --type-color: #75D0C1; }
.action-btn[data-type="normal"]   { --type-color: #A0A29F; }
.action-btn[data-type="poison"]   { --type-color: #B763CF; }
.action-btn[data-type="psychic"]  { --type-color: #FA8581; }
.action-btn[data-type="rock"]     { --type-color: #C9BB8A; }
.action-btn[data-type="steel"]    { --type-color: #5695A3; }
.action-btn[data-type="water"]    { --type-color: #539DDF; }
/* æ‚¬åœæ•ˆæœï¼šè½»å¾®ä¸Šæµ® + æŒ‰ä¸‹çš„é¢œè‰²åé¦ˆ */
.action-btn:hover:enabled {
    transform: translateY(-2px);
    box-shadow: 6px 6px 0 rgba(0,0,0,0.2);
    background: white;
    z-index: 10;
}
.action-btn:active {
    transform: translateY(1px);
    box-shadow: 2px 2px 0 rgba(0,0,0,0.15);
}
/* å·¦ä¾§è£…é¥°æ¡ (Sci-fi Chip Look) */
.action-btn .deco-bar {
    width: 6px;
    height: 100%;
    background: var(--type-color);
    position: absolute;
    left: 0;
    top: 0;
}
/* å†…éƒ¨å®¹å™¨ï¼šè´Ÿè´£åå‘å€¾æ–œ (Un-skew) */
.action-btn .content-unskew {
    width: 100%;
    height: 100%;
    transform: skewX(15deg);
    display: flex;
    align-items: center;
    padding-left: 32px;
}
/* å›¾æ ‡å®¹å™¨ï¼šåœ†å½¢ + å±…ä¸­ */
.action-btn .icon-circle {
    width: 44px;
    height: 44px;
    background: var(--type-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-right: 12px;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    position: relative;
    z-index: 2;
}
.action-btn .icon-circle img {
    width: 65%;
    height: 65%;
    object-fit: contain;
    filter: brightness(0) invert(1);
}
/* æ–‡å­—åŒºåŸŸ */
.action-btn .text-group {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
    flex: 1;
    position: relative;
    z-index: 2;
}
.back-btn-pill {
    position: absolute;
    top: -15px;
    left: -10px;
    width: 44px;
    height: 44px;
    background: #f8fafc;
    color: #334155;
    border: 3px solid rgba(255,255,255,0.85);
    border-radius: 50%;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: transform 0.2s, background 0.2s;
    transform: skewX(15deg); /* è¡¥å¿çˆ¶çº§å€¾æ–œ */
    font-family: var(--font-main);
}
.back-btn-pill:hover {
    transform: skewX(15deg) scale(1.15) rotate(-10deg);
    background: #e2e8f0;
}
.back-btn-pill svg {
    width: 22px;
    height: 22px;
    fill: currentColor;
}
/* ===========================
   Mega Evolution Button
   =========================== */
 .mega-btn-pill {
    position: absolute;
    top: -35px;
    left: 50px;
    right: auto;
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #FF00CC 0%, #6366f1 50%, #333399 100%);
    color: #fff;
    border: 3px solid rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    box-shadow: 0 0 15px rgba(255, 0, 204, 0.5), inset 0 0 10px rgba(255,255,255,0.2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 101;
    transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    transform: skewX(15deg);
    overflow: hidden;
    font-family: var(--font-main);
}
.mega-btn-pill:hover {
    transform: skewX(15deg) scale(1.1);
    box-shadow: 0 0 25px rgba(255, 0, 204, 0.7), inset 0 0 15px rgba(255,255,255,0.3);
}
.mega-btn-pill.armed {
    transform: skewX(15deg) scale(1.15);
    box-shadow: 0 0 30px #FF00CC, 0 0 60px rgba(99, 102, 241, 0.5);
    border-color: #fff;
    animation: mega-pulse 0.8s infinite alternate ease-in-out;
}
@keyframes mega-pulse {
    0% { 
        box-shadow: 0 0 20px #FF00CC, 0 0 40px rgba(255, 0, 204, 0.4); 
        filter: brightness(1);
    }
    100% { 
        box-shadow: 0 0 35px #00ffff, 0 0 60px rgba(0, 255, 255, 0.5); 
        filter: brightness(1.15);
    }
}
.mega-btn-pill .mega-icon {
    width: 36px;
    height: 36px;
    transform: skewX(-15deg);
}
.mega-btn-pill.hidden {
    display: none;
}
.action-btn .move-name {
    font-size: 1.25rem;
    font-weight: 800;
    color: #333;
    line-height: 1.1;
    letter-spacing: -0.5px;
}
.action-btn .move-type-name {
    font-size: 0.75rem;
    font-weight: 700;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 2px;
}
/* èƒŒæ™¯æ°´å° (è£…é¥°æ€§) */
.action-btn .bg-watermark {
    position: absolute;
    right: -10px;
    bottom: -15px;
    width: 80px;
    height: 80px;
    opacity: 0.08;
    pointer-events: none;
    z-index: 0;
}
.action-btn .bg-watermark img {
    width: 100%;
    height: 100%;
}
/* ======================
   Back (è¿”å›) æŒ‰é’®ç‰¹æ®Šæ ·å¼
   ====================== */
.action-btn.back {
    /* è¿”å›æŒ‰é’®é“ºæ»¡èƒŒæ™¯ */
    background: #fff;
    border-color: #cbd5e1;
    justify-content: center; /* æ–‡å­—å±…ä¸­ */
    padding: 0;
}
.action-btn.back::before {
    display: none; /* æ²¡æœ‰è‰²æ¡ */
}
.action-btn.back .move-name {
    margin-left: 0;
    color: #94a3b8;
    font-size: 0.9rem;
}
.action-btn.back:hover {
    background: #f1f5f9;
    border-color: #94a3b8;
}
.action-btn.back .move-name::before {
    content: 'â†© '; /* åŠ ä¸ªç®€å•çš„è¿”å›ç®­å¤´ */
    font-size: 1.1em;
}
/* =========================================
   NEW HUD DESIGN: æ— è¾¹æ¡†æ‚¬æµ®æ–œåˆ‡é£æ ¼
   ========================================= */
.hud-modern {
    position: absolute;
    z-index: 20;
    font-family: var(--font-main);
    color: var(--primary-dark);
    background: transparent;
    border: none;
    padding: 0;
    box-shadow: none;
    filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.15));
}
.hud-enemy {
    top: 50px;
    left: env(safe-area-inset-left, 40px);
    width: 340px;
}
.hud-player {
    bottom: 220px;
    right: env(safe-area-inset-right, 40px);
    width: 380px;
    text-align: right;
}
.info-group, .main-info {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 2px;
}
.hud-player .main-info {
    justify-content: flex-end;
}
.hud-modern .card-name {
    font-size: 1.3rem;
    font-weight: 800;
    color: #2d3436;
    letter-spacing: -0.5px;
    margin-bottom: 4px;
    font-family: var(--font-main);
}
.hud-modern .p-lv {
    font-size: 1.1rem;
    font-weight: 900;
    color: #999;
    text-shadow: 1px 1px 0 #fff;
}
.p-lv-tag {
    background: #2d3436;
    color: var(--accent-yellow);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 800;
    transform: skewX(-15deg);
    box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
}
.p-lv-tag span {
    display: inline-block;
    transform: skewX(15deg);
}
.hp-track {
    position: relative;
    height: 14px;
    width: 100%;
    margin-top: 4px;
    display: flex;
    align-items: center;
}
.hp-track.is-player {
    justify-content: flex-end;
    height: 18px;
    gap: 6px;
}
.hp-intro-label {
    background: #fecea8;
    color: #cb5309;
    font-size: 0.7em;
    font-weight: 900;
    padding: 2px 4px;
    border-radius: 2px;
    transform: skewX(-20deg);
}
.hp-bar-shape {
    flex-grow: 1;
    height: 100%;
    background: rgba(45, 52, 54, 0.8);
    position: relative;
    clip-path: polygon(0 0, 100% 0, 95% 100%, 0% 100%);
    transform: skewX(-20deg);
    border-radius: 4px;
    border: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    overflow: hidden;
}
.hud-enemy .hp-bar-shape {
    transform: skewX(-20deg);
    clip-path: polygon(0 0, 100% 0, 100% 100%, 5% 100%);
}
.hp-fill-modern {
    height: 100%;
    background: linear-gradient(90deg, #4fd1c5 0%, #38b2ac 100%);
    width: 100%;
    transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.4s;
    position: relative;
}
.hp-shine {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 50%;
    background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
    pointer-events: none;
    z-index: 5;
}
.hp-val-floating {
    position: absolute;
    right: 0;
    bottom: -18px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #555;
    text-shadow: 1px 1px 0 #fff;
    font-style: italic;
}
.ball-track-modern {
    display: flex;
    gap: 4px;
    margin-top: 8px;
    opacity: 0.8;
}
.ball-track-modern.is-right {
    justify-content: flex-end;
}
.ball-track-modern .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #dcdde1;
    border: 1px solid #718093;
    transition: 0.3s;
}
.ball-track-modern .dot.alive {
    background: var(--primary-pink);
    border-color: white;
    filter: drop-shadow(0 0 3px var(--primary-pink));
}
.ball-track-modern .dot.dead {
    background: #353b48;
    border-color: #353b48;
    opacity: 0.3;
}
.ball-track-modern .dot.active {
    transform: scale(1.5);
    background: white;
    border-color: var(--primary-pink);
    box-shadow: 0 0 4px var(--primary-pink);
}
/* ==============================================
   SHARP ANGULAR HUD ( J-RPG å°–è§’é£æ ¼ )
   ============================================== */
.hud {
    position: absolute;
    z-index: 20;
    pointer-events: none;
}
.container-enemy {
    top: 30px;
    left: env(safe-area-inset-left, 30px);
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}
.container-player {
    bottom: 240px;
    right: env(safe-area-inset-right, 30px);
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}
.sharp-panel {
    position: relative;
    transform: skewX(-15deg);
    padding: 12px 35px 12px 25px;
    background: rgba(255, 255, 255, 0.95);
    border: none;
    box-shadow:
        0 18px 30px rgba(15, 23, 42, 0.18),
        0 10px 0 rgba(15, 23, 42, 0.10);
    min-width: 320px;
    backdrop-filter: blur(8px);
}
.sharp-panel::before {
    content: '';
    position: absolute;
    inset: 0;
    pointer-events: none;
    background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0));
    opacity: 0.9;
    mix-blend-mode: soft-light;
}
.container-enemy .sharp-panel {
    background: rgba(255, 255, 255, 0.95);
    border: none;
    color: #1e293b;
    border-left-width: 0;
}
.container-player .sharp-panel {
    border: none;
}
.container-player .sharp-panel {
    box-shadow:
        0 -10px 20px rgba(15, 23, 42, 0.08),
        0 18px 28px rgba(15, 23, 42, 0.08),
        0 8px 0 rgba(15, 23, 42, 0.07);
}
.container-player .sharp-panel::before {
    opacity: 1;
    background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0));
}
.panel-content.unskew {
    transform: skewX(15deg);
}
.deco-strip {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 8px;
    background: var(--primary-pink);
}
.container-enemy .deco-strip {
    left: -11px;
    border: none;
    transform: skewX(0deg);
}
.player-strip {
    right: -11px;
    left: auto;
    background: var(--accent-blue);
    border: 2px solid rgba(255, 255, 255, 0.9);
    transform: skewX(0deg);
}
.info-row {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 6px;
    white-space: nowrap;
}
.right-align {
    justify-content: flex-end;
}
.p-name {
    font-family: var(--font-main);
    font-size: 1.6rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    /* å¢å¼ºæ–‡å­—ç«‹ä½“æ„Ÿ */
    text-shadow: 2px 2px 0 rgba(255,255,255,0.9), 0px 0px 1px rgba(0,0,0,0.1);
    /* é˜²æ­¢è¿‡é•¿åç§°æ¢è¡Œ */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 220px;
}
.container-enemy .p-name { 
    color: #1e293b; 
}
.container-player .p-name { 
    color: #1e293b; 
}
/* ç¡®ä¿ç­‰çº§æ˜¾ç¤ºä¸è¢«å‹ç¼© */
.sw-top-row {
    display: flex;
    align-items: baseline;
    gap: 8px;
    overflow: hidden;
}
.sw-row-right-group,
.p-lv {
    flex-shrink: 0;
}
.p-lv {
    font-size: 1rem;
    font-family: var(--font-number);
    color: #94a3b8;
    font-weight: 700;
}
.p-lv-badge {
    background: #0f172a;
    color: var(--accent-yellow);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    display: inline-block;
    vertical-align: middle;
}
.hp-nums-floating {
    position: absolute;
    right: 0;
    top: -24px;
    font-weight: 800;
    font-size: 1.1rem;
    color: #475569;
    text-shadow: 1px 1px 0 #fff;
    font-style: italic;
}
.hp-track-wrapper {
    width: 100%;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.hp-intro {
    font-size: 0.75rem;
    font-weight: 900;
    background: #000;
    color: var(--accent-yellow);
    padding: 1px 4px;
    border-radius: 2px;
}
.hp-border-frame {
    flex: 1;
    background: #334155;
    border: none;
    height: 14px;
    position: relative;
    box-shadow: inset 2px 2px 4px rgba(0,0,0,0.5);
    border-radius: 2px;
    overflow: hidden;
}
.container-player .hp-border-frame {
    height: 18px;
    background: #e2e8f0;
}
.hp-fill-colors {
    height: 100%;
    background: linear-gradient(180deg, #4fd1c5 0%, #2c7a7b 90%);
    box-shadow: 0 0 10px rgba(79, 209, 197, 0.4);
    transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1), background 0.3s;
    position: relative;
    border-right: none;
}
.hp-gloss {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(to bottom, rgba(255,255,255,0.25), transparent);
    z-index: 5;
    pointer-events: none;
}
/* =========================================
   [æ”¹] 6æ§½ç²¾çµçƒ HUD è®¾è®¡ (Black Glass UI)
   ========================================= */
.party-track {
    display: flex;
    gap: 8px;
    margin-bottom: 5px;
    transform: skewX(-15deg);
    height: 32px;
    align-items: center;
    padding: 2px 12px;
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.35);
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-sizing: border-box;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}
.player-side {
    margin-top: 5px;
    margin-bottom: 0px;
    justify-content: flex-end;
}
.poke-slot {
    width: 20px;
    height: 20px;
    transform: skewX(15deg) rotate(-10deg);
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    transition: all 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}
.ball-menu-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(5px);
    z-index: 250;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}
.ball-menu-overlay.hidden {
    display: none;
}
.ball-menu-card {
    background: #fff;
    border-radius: 16px;
    padding: 20px 30px;
    width: 320px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    transform: skewX(-5deg);
    border-right: 6px solid var(--color-catch);
}
.ball-header {
    font-size: 1.2rem;
    font-weight: 800;
    color: #333;
    margin-bottom: 20px;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
}
.ball-option {
    width: 100%;
    padding: 15px;
    margin-bottom: 10px;
    border: 2px solid #eee;
    border-radius: 10px;
    background: #fff;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    transition: 0.2s;
}
.ball-option:hover {
    background: #f0fdf4;
    border-color: var(--color-catch);
    color: #166534;
    transform: translateX(5px);
}
.ball-multi {
    font-size: 0.8rem;
    background: #333;
    color: #fff;
    padding: 2px 6px;
    border-radius: 4px;
}
.close-ball-menu {
    margin-top: 15px;
    background: transparent;
    border: none;
    color: #999;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
}
.close-ball-menu:hover {
    color: #555;
}
.poke-slot.alive {
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='46' fill='%23eee' stroke='%23333' stroke-width='6'/%3E%3Cpath d='M4,50 A46,46 0 0,1 96,50' fill='%23fe6b6b'/%3E%3Cpath d='M4,50 L96,50' stroke='%23333' stroke-width='6'/%3E%3Ccircle cx='50' cy='50' r='14' fill='%23fff' stroke='%23333' stroke-width='4'/%3E%3C/svg%3E");
    opacity: 0.9;
    filter: drop-shadow(1px 2px 2px rgba(0,0,0,0.3));
}
.poke-slot.dead {
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='46' fill='%235E5E5E' stroke='%23333' stroke-width='6'/%3E%3Cpath d='M4,50 L96,50' stroke='%23111' stroke-width='6'/%3E%3Ccircle cx='50' cy='50' r='14' fill='%23999' stroke='%23111' stroke-width='4'/%3E%3Cpath d='M30,30 L70,70 M70,30 L30,70' stroke='%23222' stroke-width='8' opacity='0.5'/%3E%3C/svg%3E");
    opacity: 0.6;
    transform: skewX(15deg) rotate(-15deg) scale(0.85);
    filter: grayscale(1);
}
.poke-slot.active {
    transform: skewX(15deg) rotate(-15deg) scale(1.3) translateY(-4px);
    z-index: 10;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='46' fill='%23f5f5f5' stroke='%23333' stroke-width='6'/%3E%3Cpath d='M4,50 A46,46 0 0,1 96,50' fill='%23FFCB05'/%3E%3Cpath d='M4,50 L96,50' stroke='%23333' stroke-width='6'/%3E%3Ccircle cx='50' cy='50' r='15' fill='%23fff' stroke='%23333' stroke-width='4'/%3E%3Cpath d='M25,25 L40,40 M75,25 L60,40' stroke='%23C13E3E' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E");
    filter: drop-shadow(0 0 6px rgb(255, 230, 91)) drop-shadow(0 4px 6px rgba(0,0,0,0.3));
}
.poke-slot.empty::after {
    content: "";
    display: block;
    width: 6px;
    height: 6px;
    background: linear-gradient(135deg, #fff 0%, #ddd 100%);
    border-radius: 50%;
    box-shadow: 0 0 4px rgba(255, 255, 255, 0.4);
    opacity: 0.6;
}
/* ==========================================================
   MODERN SWITCH MENU REVAMP (ç°ä»£æ— è¾¹æ¡†é£æ ¼)
   ========================================================== */
.overlay-modal.modern-layer {
    background: rgba(240, 242, 245, 0.4);
    backdrop-filter: blur(25px) saturate(160%) brightness(1.1);
    -webkit-backdrop-filter: blur(25px) saturate(160%) brightness(1.1);
}
.sharp-panel,
.container-enemy .sharp-panel,
.container-player .sharp-panel {
    background: rgba(0, 0, 0, 0.35) !important;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    color: #fff;
    transform: skewX(-15deg);
    padding: 10px 25px;
}
.sharp-panel::before,
.container-player .sharp-panel::before {
    display: none !important;
}
.deco-strip {
    left: 0;
    width: 4px;
}
.container-player .deco-strip {
    right: 0;
    left: auto;
    border: none;
    to { opacity: 1; }
}
.switch-container-modern {
    width: min(95vw, 640px);
    max-width: 640px;
    height: 100%;
    max-height: none;
    margin: 0 auto;
    padding: 25px 35px 35px;
    position: relative;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.85);
    border-radius: 24px;
    overflow-y: auto;
}
.switch-header-modern {
    margin-bottom: 25px;
    padding-left: 20px;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 15px;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 15px;
    font-family: var(--font-main);
}
.switch-header-modern h2 {
    font-size: 2.2rem;
    color: #2d3436;
    margin: 0;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 2px;
    font-family: var(--font-main);
}
.switch-header-subtitle {
    font-weight: 500;
    color: #a4b0be;
    font-size: 1rem;
    margin-top: 8px;
    letter-spacing: 1px;
    font-family: var(--font-main);
}
.party-grid-modern {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 5px 0 20px;
    overflow-y: auto;
    overflow-x: hidden;
    width: 100%;
    max-height: none;
    flex: 1;
    box-sizing: border-box;
}
.party-grid-modern::-webkit-scrollbar {
    width: 10px;
}
.party-grid-modern::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.12);
    border-radius: 999px;
}
.party-grid-modern::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.04);
    border-radius: 999px;
}
.party-card-modern {
    position: relative;
    background: #ffffff;
    border-radius: 20px;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 18px;
    flex-shrink: 0;
    min-height: 86px;
    box-shadow:
        0 10px 20px rgba(0,0,0,0.03),
        0 2px 5px rgba(0,0,0,0.02);
    transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer;
    overflow: hidden;
    opacity: 0;
    animation: slide-up-card 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}
@keyframes slide-up-card {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
.party-card-modern:hover:not(.disabled) {
    transform: translateY(-4px) scale(1.02);
    box-shadow:
        0 15px 30px rgba(0,0,0,0.08),
        0 5px 10px rgba(0,0,0,0.03);
    z-index: 10;
}
.party-card-modern:active:not(.disabled) {
    transform: scale(0.98);
}
.party-card-modern.current {
    background: #f1f3f6;
    box-shadow: inset 0 0 0 2px #dcdde1;
    pointer-events: none;
    opacity: 0.8;
}
.party-card-modern.dead {
    background: #fdfdfd;
    filter: grayscale(1);
    opacity: 0.7;
    cursor: not-allowed;
}
.party-card-modern.dead:not(.disabled) {
    cursor: default;
}
.card-icon-modern {
    width: 65px;
    height: 65px;
    flex-shrink: 0;
    border-radius: 50%;
    background: #fafafa;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}
.card-icon-modern img {
    width: 130%;
    height: auto;
    transform: translateY(-2px);
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
}
/* Mega å½¢æ€å›¾æ ‡æ”¾å¤§ */
.card-icon-modern img.mega-icon {
    width: 165% !important;
    transform: translateY(-4px) scale(1.55) !important;
    filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.4)) drop-shadow(0 4px 6px rgba(0,0,0,0.2)) !important;
}
.card-info-modern {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.card-top-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 6px;
}
.card-name {
    font-size: 1.3rem;
    font-weight: 800;
    color: #2d3436;
}
.card-lv {
    font-size: 0.9rem;
    font-weight: 700;
    color: #b2bec3;
    font-style: italic;
}
.card-hp-nums {
    font-size: 0.8rem;
    font-weight: 700;
    color: #636e72;
    letter-spacing: 0.5px;
    font-family: var(--font-number);
}
.modern-hp-track {
    height: 8px;
    width: 100%;
    background: #eaeaea;
    border-radius: 10px;
    overflow: hidden;
}
.modern-hp-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s;
    background: var(--hp-high);
}
.status-tag {
    position: absolute;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    font-size: 0.8rem;
    font-weight: 900;
    color: #d63031;
    border: 2px solid rgba(214, 48, 49, 0.2);
    padding: 2px 8px;
    border-radius: 8px;
    transform: rotate(5deg) translateY(-50%);
}
.current-tag {
    position: absolute;
    right: 0;
    top: 0;
    background: var(--accent-blue);
    color: white;
    font-size: 0.6rem;
    font-weight: 900;
    padding: 2px 10px;
    border-radius: 0 20px 0 10px;
}
/* =========================================================
   [æ”¹] SWSH å‰‘ç›¾é£æ ¼ç™½è‰²é¢æ¿é‡æ„
   ========================================================= */
body {
    font-family: var(--font-main);
}
/* ä¸»èœå•æŒ‰é’®ä¿æŒåŸè‹±æ–‡å­—ä½“ */
.radical-btn,
.radical-btn .en,
.radical-btn .jp,
.r-label,
.r-label-min {
    font-family: 'Rubik', sans-serif !important;
}
.hud {
    position: absolute;
    z-index: 10;
    width: 330px;
    background: var(--primary-white);
    border-radius: var(--radius-l);
    padding: 15px 20px;
    border: 2px solid #ffffff;
    box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.08),
        4px 4px 0 rgba(70, 70, 80, 0.08);
    filter: none;
    transform: translateX(5px);
}
.sharp-panel,
.container-player .sharp-panel,
.container-enemy .sharp-panel {
    position: relative;
    transform: skewX(-22deg);
    background: rgba(255, 255, 255, 0.98) !important;
    border: 2px solid rgba(255, 255, 255, 1);
    border-radius: 6px;
    padding: 8px 30px 8px 40px;
    min-width: 290px;
    box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.1),
        2px 4px 6px rgba(0, 0, 0, 0.12),
        0 10px 25px rgba(0, 0, 0, 0.15);
    z-index: 10;
}
.panel-content.unskew {
    transform: skewX(22deg);
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.deco-strip {
    background: var(--primary-pink);
    width: 6px;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    border-radius: 2px 0 0 2px;
    box-shadow: 1px 0 2px rgba(0,0,0,0.2);
    filter: brightness(0.95);
    z-index: 2;
}
.deco-strip.player {
    background: var(--accent-blue);
    left: auto;
    right: 0;
    border-radius: 0 2px 2px 0;
    border: none;
}
.sw-top-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    width: 100%;
    margin-bottom: 2px;
    line-height: 1;
}
.p-name {
    font-family: var(--font-main);
    font-size: 1.55rem;
    font-weight: 800;
    color: #2c3e50;
    text-shadow: 2px 2px 0px #fff, -1px -1px 0 #fff;
    letter-spacing: -0.5px;
    margin-right: 15px;
}
.sw-row-right-group {
    display: flex;
    align-items: baseline;
    gap: 10px;
}
.hp-v-nums {
    font-size: 1.1rem;
    font-weight: 700;
    font-family: "Menlo", "Consolas", monospace;
    color: #7f8c8d;
    letter-spacing: -0.5px;
}
.p-lv {
    font-size: 1.2rem;
    font-weight: 500;
    color: #2c3e50;
}
.p-lv span {
    font-weight: 800;
    margin-left: 1px;
}
.hp-track-wrappersw {
    width: 100%;
    height: 13px;
    position: relative;
    margin-bottom: 2px;
}
.container-player .hp-track-wrappersw {
    height: 13px;
}
.hp-border-frame {
    width: 100%;
    height: 100%;
    background: #e6eaea;
    border-radius: 20px;
    overflow: hidden;
    position: relative;
    border: none;
    box-shadow: none;
}
.hp-fill-colors {
    border-radius: 20px;
    height: 100%;
    background: #4cd137;
    transition: width 0.4s ease-out;
    box-shadow: none;
    border: none;
}
.hp-intro,
.p-lv-badge,
.hp-nums-floating,
.hp-gloss,
.sw-bot-row {
    display: none !important;
}
.party-track {
    height: 26px;
    background: rgba(0, 0, 0, 0.45);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.15);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    padding: 2px 12px;
    gap: 8px;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    transform: skewX(-22deg);
}
.switch-footer {
    margin-top: 30px;
    display: flex;
    justify-content: center;
}
.btn-close-modern {
    background: #fff;
    border: none;
    padding: 12px 30px;
    border-radius: 50px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: inherit;
    font-weight: 800;
    font-size: 1.1rem;
    color: #636e72;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: 0.2s;
}
.btn-close-modern:hover {
    transform: scale(1.05);
    background: #fff0f5;
    color: var(--primary-pink);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}
.key-hint {
    background: #dfececb6;
    color: #555;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 0.8rem;
}
.trainer-hud {
    position: absolute;
    top: 22px;
    right: 22px;
    z-index: 30;
    display: flex;
    align-items: center;
    gap: 12px;
    pointer-events: none;
}
.trainer-panel {
    transform: skewX(-15deg);
    padding: 10px 18px;
    background: rgba(255, 255, 255, 0.92);
    border: none;
    border-radius: 14px;
    box-shadow:
        0 18px 30px rgba(15, 23, 42, 0.14),
        0 10px 0 rgba(15, 23, 42, 0.08);
    backdrop-filter: blur(8px);
}
.trainer-panel-content {
    transform: skewX(15deg);
}
.trainer-name {
    font-family: var(--font-main);
    font-weight: 900;
    font-size: 1rem;
    color: #1e293b;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    white-space: nowrap;
}
.trainer-avatar-wrap {
    width: 58px;
    height: 58px;
    border-radius: 16px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.75);
    box-shadow:
        0 14px 24px rgba(15, 23, 42, 0.14),
        0 8px 0 rgba(15, 23, 42, 0.06);
}
#trainer-avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
    image-rendering: pixelated;
}
/* =========================================
   [ADDON] BATTLE EVOLUTION UI - ä¸´åœºè¿›åŒ–æŒ‰é’®
   ä½äº Mega æŒ‰é’®å³ä¾§ï¼Œé‡‡ç”¨é—ªè€€çš„é‡‘è‰²æµå…‰é£æ ¼
   ========================================= */
.mega-btn-pill.evo-style {
    left: 120px;
    background: linear-gradient(135deg, #FFD700 0%, #FDB931 50%, #FFFACD 100%);
    box-shadow: 
        0 0 15px rgba(255, 215, 0, 0.6), 
        inset 0 0 10px rgba(255,255,255,0.4);
    border: 3px solid #FFF;
    z-index: 105;
    animation: gold-pulse 2s infinite ease-in-out;
}
.mega-btn-pill.evo-style:hover {
    transform: skewX(15deg) scale(1.15);
    box-shadow: 
        0 0 25px rgba(255, 215, 0, 0.9), 
        inset 0 0 15px rgba(255,255,255,0.6);
}
.evo-particles {
    position: absolute;
    width: 60%;
    height: 60%;
    background: radial-gradient(circle, rgba(255,255,255,0.9), transparent 70%);
    opacity: 0.5;
    animation: spin-shine 3s linear infinite;
}
.evo-text {
    font-size: 0.8rem;
    font-weight: 900;
    color: #8B4513;
    font-style: italic;
    transform: skewX(-15deg);
    letter-spacing: 1px;
}
@keyframes gold-pulse {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.2) drop-shadow(0 0 5px gold); }
    100% { filter: brightness(1); }
}
@keyframes spin-shine {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
/* =========================================
   Mega Evolution DNA-Style Visual Effects
   ========================================= */
.p-sprite.loaded {
    opacity: 1;
    filter: drop-shadow(0 2px 5px rgba(0,0,0,0.4));
}
.p-sprite.evo-silhouette {
    filter:
        brightness(0)
        contrast(200%)
        drop-shadow(0 0 10px #ff00ff)
        drop-shadow(2px 2px 4px #00ffff)
        drop-shadow(-2px -2px 4px #ffff00);
    opacity: 0.9;
    animation: dna-struggle 0.12s linear infinite alternate;
}
.p-sprite.evo-burst {
    filter: brightness(10) contrast(0.5) blur(2px) drop-shadow(0 0 30px rgba(255,255,255,0.9));
    transform: scale(1.1);
    opacity: 1;
}
.p-sprite.evo-finish {
    animation: evolve-cooldown 0.8s ease-out forwards;
}
@keyframes dna-struggle {
    from { transform: translateX(-1px) scale(0.98); }
    to { transform: translateX(1px) scale(1.02); }
}
@keyframes evolve-cooldown {
    0% {
        filter: brightness(2) saturate(1.5) drop-shadow(0 0 20px #5ee7ff);
        transform: scale(1.05);
    }
    100% {
        filter: brightness(1.05) saturate(1.05) drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
        transform: scale(1);
    }
}
/* ============================================ */
/* æ™®é€šè¿›åŒ–åŠ¨ç”»ï¼ˆä¸ Mega è¿›åŒ–åŒºåˆ†ï¼‰*/
/* ============================================ */
.p-sprite.bio-evo-glow {
    filter: brightness(2) saturate(0.3) drop-shadow(0 0 15px rgba(255,255,255,0.8));
    animation: bio-evo-pulse 0.4s ease-in-out infinite alternate;
}
.p-sprite.bio-evo-burst {
    filter: brightness(5) contrast(0.8) blur(1px) drop-shadow(0 0 25px rgba(255,255,255,0.95));
    transform: scale(1.08);
    opacity: 1;
}
.p-sprite.bio-evo-finish {
    animation: bio-evo-cooldown 0.6s ease-out forwards;
}
@keyframes bio-evo-pulse {
    from { 
        filter: brightness(1.8) saturate(0.3) drop-shadow(0 0 12px rgba(255,255,255,0.7));
        transform: scale(1.0);
    }
    to { 
        filter: brightness(2.2) saturate(0.3) drop-shadow(0 0 18px rgba(255,255,255,0.9));
        transform: scale(1.02);
    }
}
@keyframes bio-evo-cooldown {
    0% {
        filter: brightness(3) saturate(1.3) drop-shadow(0 0 20px #ffffff);
        transform: scale(1.08);
    }
    100% {
        filter: brightness(1.05) saturate(1.05) drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
        transform: scale(1);
    }
}
/* Bond Resonance ç¾ç»Šå…±é¸£çŠ¶æ€ */
.p-sprite.bond-resonance {
    filter: drop-shadow(0 0 12px gold) brightness(1.1) saturate(1.15);
    animation: bond-pulse 2s ease-in-out infinite;
}
@keyframes bond-pulse {
    0%, 100% {
        filter: drop-shadow(0 0 12px gold) brightness(1.1) saturate(1.15);
    }
    50% {
        filter: drop-shadow(0 0 20px #fbbf24) brightness(1.2) saturate(1.3);
    }
}
/* EVO æŒ‰é’® Bond æ¨¡å¼æ ·å¼ */
#btn-evolved.bond-mode {
    background: linear-gradient(135deg, #22c55e 0%, #4ade80 50%, #86efac 100%);
    box-shadow: 0 0 15px rgba(74, 222, 128, 0.6), inset 0 1px 0 rgba(255,255,255,0.3);
    animation: bond-btn-pulse 1.5s ease-in-out infinite;
}
#btn-evolved.bond-mode::before {
    content: 'âˆ';
    font-size: 1.2em;
}
@keyframes bond-btn-pulse {
    0%, 100% {
        box-shadow: 0 0 15px rgba(74, 222, 128, 0.6), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    50% {
        box-shadow: 0 0 25px rgba(74, 222, 128, 0.9), inset 0 1px 0 rgba(255,255,255,0.5);
    }
}
/* =========================================
   [DYNAMAX] æå·¨åŒ–ä¸“ç”¨æ ·å¼
   ========================================= */
/* 1. æå·¨åŒ–çŠ¶æ€ä¸‹çš„ç²¾çµï¼šå·¨å¤§åŒ– + çº¢è‰²æš—äº‘æ»¤é•œ */
.p-sprite.state-dynamax {
    --sprite-scale: 1.8 !important;
    transform: scale(1.8) !important;
    filter: 
        drop-shadow(0 0 25px #ff0055) 
        drop-shadow(0 0 50px rgba(255, 0, 85, 0.6))
        brightness(1.05)
        contrast(1.15) 
        saturate(1.25);
    animation: dynamax-breath 3s ease-in-out infinite;
    z-index: 100 !important;
    position: relative;
}
/* ç©å®¶æ–¹æå·¨åŒ–ï¼šå‘ä¸Šç§»åŠ¨ */
#player-sprite.state-dynamax {
    transform: translateY(-30px) scale(1.8) !important;
}
/* æ•Œæ–¹æå·¨åŒ–ï¼šå‘ä¸‹ç§»åŠ¨ä»¥ä¿æŒåœ¨ç”»é¢å†… */
#enemy-sprite.state-dynamax {
    transform: translateY(20px) scale(1.8) !important;
}
/* æå·¨åŒ–å‘¼å¸åŠ¨ç”» - ç©å®¶æ–¹ */
@keyframes dynamax-breath {
    0%, 100% { 
        filter: 
            drop-shadow(0 0 25px #ff0055) 
            drop-shadow(0 0 50px rgba(255, 0, 85, 0.6))
            brightness(1.05)
            contrast(1.15) 
            saturate(1.25);
    }
    50% { 
        filter: 
            drop-shadow(0 0 35px #ff0055) 
            drop-shadow(0 0 70px rgba(255, 0, 85, 0.8))
            brightness(1.1)
            contrast(1.2) 
            saturate(1.35);
    }
}
/* ç©å®¶æ–¹å‘¼å¸åŠ¨ç”»ï¼ˆå¸¦ä¸Šä¸‹æµ®åŠ¨ï¼‰*/
#player-sprite.state-dynamax {
    animation: dynamax-breath-player 3s ease-in-out infinite;
}
@keyframes dynamax-breath-player {
    0%, 100% { 
        transform: translateY(-30px) scale(1.8);
        filter: 
            drop-shadow(0 0 25px #ff0055) 
            drop-shadow(0 0 50px rgba(255, 0, 85, 0.6))
            brightness(1.05)
            contrast(1.15) 
            saturate(1.25);
    }
    50% { 
        transform: translateY(-35px) scale(1.85);
        filter: 
            drop-shadow(0 0 35px #ff0055) 
            drop-shadow(0 0 70px rgba(255, 0, 85, 0.8))
            brightness(1.1)
            contrast(1.2) 
            saturate(1.35);
    }
}
/* æ•Œæ–¹å‘¼å¸åŠ¨ç”»ï¼ˆå¸¦ä¸Šä¸‹æµ®åŠ¨ï¼‰*/
#enemy-sprite.state-dynamax {
    animation: dynamax-breath-enemy 3s ease-in-out infinite;
}
@keyframes dynamax-breath-enemy {
    0%, 100% { 
        transform: translateY(20px) scale(1.8);
        filter: 
            drop-shadow(0 0 25px #ff0055) 
            drop-shadow(0 0 50px rgba(255, 0, 85, 0.6))
            brightness(1.05)
            contrast(1.15) 
            saturate(1.25);
    }
    50% { 
        transform: translateY(25px) scale(1.85);
        filter: 
            drop-shadow(0 0 35px #ff0055) 
            drop-shadow(0 0 70px rgba(255, 0, 85, 0.8))
            brightness(1.1)
            contrast(1.2) 
            saturate(1.35);
    }
}
/* 2. æå·¨åŒ–æŒ‰é’®ï¼šç²‰çº¢/çº¢è‰²èºæ—‹é£æ ¼ */
.mega-btn-pill.dynamax-style {
    background: linear-gradient(135deg, #ff0055 0%, #cc0033 50%, #990022 100%);
    box-shadow: 
        0 0 15px rgba(255, 0, 85, 0.6), 
        0 0 30px rgba(255, 0, 85, 0.3),
        inset 0 0 5px rgba(0, 0, 0, 0.2);
    border: 3px solid #ff99aa;
}
.mega-btn-pill.dynamax-style:hover {
    transform: skewX(15deg) scale(1.15);
    box-shadow: 
        0 0 25px rgba(255, 0, 85, 0.8), 
        0 0 50px rgba(255, 0, 85, 0.4),
        inset 0 0 10px rgba(0, 0, 0, 0.2);
}
.mega-btn-pill.dynamax-style.armed {
    transform: skewX(15deg) scale(1.2);
    box-shadow: 
        0 0 35px #ff0055, 
        0 0 70px rgba(255, 0, 85, 0.6);
    border-color: #fff;
    animation: dynamax-btn-pulse 0.6s infinite alternate ease-in-out;
}
@keyframes dynamax-btn-pulse {
    0% { 
        box-shadow: 0 0 25px #ff0055, 0 0 50px rgba(255, 0, 85, 0.5); 
        filter: brightness(1);
    }
    100% { 
        box-shadow: 0 0 40px #ff3377, 0 0 80px rgba(255, 51, 119, 0.6); 
        filter: brightness(1.2);
    }
}
/* æå·¨åŒ–æŒ‰é’®å†…çš„ X å›¾æ ‡ */
.mega-btn-pill.dynamax-style .mega-icon text {
    font-size: 55px;
}
/* 3. æå·¨åŒ–çˆ†å‘åŠ¨ç”»ï¼ˆè§¦å‘æ—¶çš„è§†è§‰æ•ˆæœï¼‰*/
.p-sprite.dynamax-burst {
    animation: dynamax-explosion 0.8s ease-out forwards;
}
@keyframes dynamax-explosion {
    0% {
        transform: scale(1);
        filter: brightness(1) saturate(1);
    }
    30% {
        transform: scale(1.2);
        filter: brightness(3) saturate(0.5) drop-shadow(0 0 50px #ff0055);
    }
    60% {
        transform: translateY(-20px) scale(1.6);
        filter: brightness(1.5) saturate(1.5) drop-shadow(0 0 40px #ff0055);
    }
    100% {
        transform: translateY(-30px) scale(1.8);
        filter: 
            drop-shadow(0 0 20px #ff0055) 
            drop-shadow(0 0 40px rgba(255, 0, 85, 0.5))
            contrast(1.1) 
            saturate(1.2);
    }
}
/* 4. æå·¨åŒ–ç»“æŸæ”¶ç¼©åŠ¨ç”» */
.p-sprite.dynamax-shrink {
    animation: dynamax-shrink 0.6s ease-in forwards;
}
@keyframes dynamax-shrink {
    0% {
        transform: translateY(-30px) scale(1.8);
        filter: 
            drop-shadow(0 0 20px #ff0055) 
            drop-shadow(0 0 40px rgba(255, 0, 85, 0.5))
            contrast(1.1) 
            saturate(1.2);
    }
    50% {
        transform: translateY(-10px) scale(1.3);
        filter: brightness(2) drop-shadow(0 0 30px #ffffff);
    }
    100% {
        transform: translateY(0) scale(var(--sprite-scale, 1));
        filter: contrast(1.15) brightness(1.05) drop-shadow(4px 8px 6px rgba(0, 0, 0, 0.3));
    }
}
/* 5. æå·¨åŒ–å›åˆå€’è®¡æ—¶æŒ‡ç¤ºå™¨ */
.dynamax-turns-indicator {
    position: absolute;
    top: -60px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #ff0055, #cc0033);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 800;
    box-shadow: 0 2px 8px rgba(255, 0, 85, 0.5);
    z-index: 101;
    animation: indicator-pulse 1s ease-in-out infinite;
}
@keyframes indicator-pulse {
    0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
    50% { opacity: 0.8; transform: translateX(-50%) scale(1.05); }
}
/* =========================================
   [Z-MOVE] Zæ‹›å¼æŒ‰é’®æ ·å¼ - æ”¹è‰¯ç‰ˆ
   Theme: å…¨æ¯æ™¶ä½“ (Holographic Crystal)
   é£æ ¼ï¼šæ´ç™½åº•è‰² + é«˜é¥±å’Œåº¦æ£±é•œæŠ˜å°„å…‰ï¼Œå¼ºè°ƒé”‹é”æ„Ÿ
   ========================================= */
/* Zæ‹›å¼æŒ‰é’®åŸºç¡€æ ·å¼ */
.action-btn.z-move-btn {
    /* èƒŒæ™¯æ”¹ä¸ºæ›´çº¯å‡€çš„ç å…‰æ¸å˜ï¼Œå‡å°‘æµ‘æµŠå½©åº¦ */
    background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 50%, #e2e8f0 100%);
    position: relative;
    border: 2px solid transparent !important;
    background-clip: padding-box; /* å…³é”®ï¼šé˜²æ­¢èƒŒæ™¯å¹²æ‰°è¾¹æ¡†åŒº */
    box-shadow: 
        0 8px 20px -5px rgba(99, 102, 241, 0.4), 
        inset 0 0 15px rgba(255, 255, 255, 0.8);
    overflow: hidden;
}
/* åŠ¨æ€åŒ–è¾¹æ¡† - æ”¹ä¸ºæ£±é•œè‰²è°± (Cyan/Magenta/Yellow/Light) */
.action-btn.z-move-btn::after {
    content: '';
    position: absolute;
    inset: -2px;
    z-index: -1;
    border-radius: 12px; /* ç¨å¾®åŠ å¤§åœ†è§’é€‚é…æ–°é£æ ¼ */
    /* æ›´åŠ é”‹åˆ©çš„â€œæ¿€å…‰â€é…è‰² */
    background: linear-gradient(
        60deg,
        #22d3ee, /* é’è‰² */
        #c084fc, /* ç´«è‰² */
        #f472b6, /* ç²‰è‰² */
        #fbbf24, /* é‡‘è‰² */
        #22d3ee  /* å¾ªç¯å›é’è‰² */
    );
    background-size: 200% 200%;
    animation: z-prism-border 2.5s linear infinite;
}
@keyframes z-prism-border {
    0% { background-position: 0% 50%; filter: brightness(1); }
    50% { background-position: 100% 50%; filter: brightness(1.2); }
    100% { background-position: 0% 50%; filter: brightness(1); }
}
/* Zæ‹›å¼æ–‡å­—ç‰¹æ•ˆ - æ·±é‚ƒå®‡å®™è‰² */
.action-btn.z-move-btn .move-name {
    font-weight: 800;
    font-style: italic;
    /* ä½¿ç”¨æ·±ç´«åˆ°æ·±é’çš„æ¸å˜ï¼Œæ›´æœ‰ç§‘å¹»æ„Ÿï¼Œå¯¹æ¯”åº¦æ›´é«˜ */
    background: linear-gradient(90deg, #312e81, #4c1d95); 
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 2px 2px 0px rgba(255, 255, 255, 0.1); /* å¾®å¼±ä¿®é¥° */
}
/* å³ä¸Šè§’æ‰“æ ‡ Z - æ™¶ä½“è´¨æ„Ÿå¾½ç«  */
.action-btn.z-move-btn .z-badge-icon {
    position: absolute;
    top: 8px;
    right: 20px;
    width: 34px;
    height: 34px;
    /* ä½¿ç”¨é€šé€çš„æ™¶ä½“æ¸å˜ */
    background: linear-gradient(135deg, #a855f7, #6366f1, #06b6d4);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem; /* Zå­—åŠ å¤§ */
    font-family: 'Exo 2', sans-serif;
    font-weight: 900;
    border: 2px solid rgba(255, 255, 255, 0.9);
    box-shadow: 0 4px 10px rgba(99, 102, 241, 0.6);
    z-index: 10;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
/* =========================================
   [MAX-MOVE] æå·¨æ‹›å¼æŒ‰é’®æ ·å¼ - æ”¹è‰¯ç‰ˆ
   Theme: æå·¨é£æš´ (Dynamax Storm)
   é£æ ¼ï¼šæå·¨ç²‰çº¢(#ff0055) + æš—äº‘çº¢ï¼Œå¼ºè°ƒåŠ›é‡æ„Ÿä¸èƒ½é‡æº¢å‡º
   ========================================= */
/* æå·¨æ‹›å¼æŒ‰é’®åŸºç¡€ */
.action-btn.max-move-btn {
    /* ç™½çº¢æ¸å˜ï¼Œåº•éƒ¨å¸¦ä¸€ç‚¹æš—å½±ï¼Œå¢åŠ é‡é‡æ„Ÿ */
    background: linear-gradient(160deg, #ffffff 30%, #fff1f2 70%, #ffe4e6 100%);
    position: relative;
    border: 2px solid transparent !important;
    background-clip: padding-box;
    box-shadow: 
        0 8px 20px -5px rgba(225, 29, 72, 0.5), /* çº¢è‰²æŠ•å½± */
        inset 0 0 20px rgba(255, 0, 85, 0.05);
}
/* åŠ¨æ€è¾¹æ¡† - åŠ æ·±ï¼ŒåŠ ä¸Šæå·¨åŒ–ç‰¹å¾æ€§çš„æ´‹çº¢è‰²é«˜å…‰ */
.action-btn.max-move-btn::after {
    content: '';
    position: absolute;
    inset: -2px;
    z-index: -1;
    border-radius: 12px;
    /* æå·¨åŒ–æ ‡å‡†é…è‰²ï¼šæš—ç«çº¢ -> éœ“è™¹ç²‰ -> æš—çº¢ */
    background: linear-gradient(
        45deg, 
        #be123c, /* æš—çº¢ */
        #ff0055, /* æå·¨ç²‰ (ç‰¹å¾è‰²) */
        #db2777, /* ç«çº¢ */
        #9f1239  /* æ·±ç´«çº¢ */
    );
    background-size: 300% 300%;
    animation: max-surge-border 2s ease infinite alternate;
}
@keyframes max-surge-border {
    0% { background-position: 0% 50%; filter: drop-shadow(0 0 2px rgba(255,0,85,0.4)); }
    100% { background-position: 100% 50%; filter: drop-shadow(0 0 6px rgba(255,0,85,0.8)); }
}
/* æå·¨æ‹›å¼æ–‡å­— - æš—çº¢æ¸å˜ï¼Œå¼ºè°ƒç ´ååŠ› */
.action-btn.max-move-btn .move-name {
    font-weight: 800;
    font-style: italic;
    /* ä»æš—çº¢åˆ°éœ“è™¹ç²‰çš„æ¸å˜ */
    background: linear-gradient(90deg, #be123c, #ff0055);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    /* å¢åŠ ä¸€ä¸ªç¨å¾®â€œæŠ–åŠ¨â€é”™ä½çš„æ–‡å­—é˜´å½±æ„Ÿè§‰ */
    filter: drop-shadow(1px 1px 0 rgba(0,0,0,0.1));
}
/* å³ä¸Šè§’æ‰“æ ‡ Max - æš—äº‘å›¾è…¾ */
.action-btn.max-move-btn .z-badge-icon {
    position: absolute;
    top: 8px;
    right: 20px;
    width: 36px;
    height: 36px;
    /* æ¨¡æ‹Ÿæå·¨äº‘æ¼©æ¶¡çš„é¢œè‰² */
    background: linear-gradient(135deg, #be123c, #881337); 
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem; /* å­—ä½“æ”¹å°ä¸€ç‚¹ä»¥å®¹çº³å›¾æ ‡æˆ– MAX å­—æ · */
    font-weight: 900;
    font-family: 'Rubik', sans-serif;
    border: 2px solid white;
    /* è¿™ç§æ´‹çº¢è‰²çš„å…‰æ™•æ˜¯çµé­‚ */
    box-shadow: 0 0 10px #ff0055, inset 0 0 6px rgba(0,0,0,0.3);
    z-index: 10;
}
/* åœ¨ Max æ ‡è®°å†…å¢åŠ ä¸€ä¸ªå°å°çš„ç²’å­åŠ¨ç”» (ä¼ªè£…æˆèƒ½é‡ç‚¹) */
.action-btn.max-move-btn .z-badge-icon::before {
    content: 'âœ–'; /* æå·¨åŒ–çš„å‰å·ç‰¹å¾ */
    font-size: 1.2rem;
    position: absolute;
    animation: max-symbol-pulse 1.5s infinite;
}
@keyframes max-symbol-pulse {
    0%, 100% { transform: scale(1); opacity: 0.9; }
    50% { transform: scale(1.2); opacity: 1; text-shadow: 0 0 5px white; }
}
/* =========================================================
   å¤ªæ™¶åŒ– (Terastallization) æ ·å¼ç³»ç»Ÿ
   ========================================================= */
/* 1. å¤ªæ™¶åŒ–æŒ‰é’®ï¼šé’»çŸ³/æ°´æ™¶é£æ ¼ - é’è“è‰²æ¸å˜ */
.mega-btn-pill.tera-style {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 50%, #0e7490 100%);
    box-shadow: 
        0 0 15px rgba(6, 182, 212, 0.6), 
        0 0 30px rgba(6, 182, 212, 0.3),
        inset 0 0 5px rgba(255, 255, 255, 0.3);
    border: 3px solid #67e8f9;
}
.mega-btn-pill.tera-style:hover {
    transform: skewX(15deg) scale(1.15);
    box-shadow: 
        0 0 25px rgba(6, 182, 212, 0.8), 
        0 0 50px rgba(6, 182, 212, 0.4),
        inset 0 0 10px rgba(255, 255, 255, 0.4);
}
.mega-btn-pill.tera-style.armed {
    transform: skewX(15deg) scale(1.2);
    box-shadow: 
        0 0 35px #22d3ee, 
        0 0 70px rgba(34, 211, 238, 0.6);
    border-color: #fff;
    animation: tera-btn-pulse 0.6s infinite alternate ease-in-out;
}
@keyframes tera-btn-pulse {
    0% { 
        box-shadow: 0 0 25px #22d3ee, 0 0 50px rgba(34, 211, 238, 0.5); 
        filter: brightness(1);
    }
    100% { 
        box-shadow: 0 0 40px #67e8f9, 0 0 80px rgba(103, 232, 249, 0.6); 
        filter: brightness(1.2);
    }
}
/* å¤ªæ™¶åŒ–æŒ‰é’®å†…çš„ T å›¾æ ‡ */
.mega-btn-pill.tera-style .mega-icon text {
    font-size: 50px;
}
/* 2. å¤ªæ™¶åŒ–ç²¾çµå›¾æ•ˆæœï¼šæ°´æ™¶å‘å…‰æ»¤é•œ */
.p-sprite.state-terastal {
    filter: 
        brightness(1.3) 
        saturate(1.2)
        drop-shadow(0 0 8px var(--tera-glow-color, #22d3ee))
        drop-shadow(0 0 15px var(--tera-glow-color, #22d3ee));
    animation: tera-crystal-shimmer 2s infinite ease-in-out;
}
@keyframes tera-crystal-shimmer {
    0%, 100% {
        filter: 
            brightness(1.3) 
            saturate(1.2)
            drop-shadow(0 0 8px var(--tera-glow-color, #22d3ee))
            drop-shadow(0 0 15px var(--tera-glow-color, #22d3ee));
    }
    50% {
        filter: 
            brightness(1.5) 
            saturate(1.4)
            drop-shadow(0 0 12px var(--tera-glow-color, #22d3ee))
            drop-shadow(0 0 25px var(--tera-glow-color, #22d3ee));
    }
}
/* 3. å¤ªæ™¶åŒ–çˆ†å‘åŠ¨ç”»ï¼ˆè§¦å‘æ—¶çš„è§†è§‰æ•ˆæœï¼‰*/
.p-sprite.tera-burst {
    animation: tera-crystallize 0.8s ease-out forwards;
}
@keyframes tera-crystallize {
    0% {
        transform: scale(1);
        filter: brightness(1) saturate(1);
    }
    30% {
        transform: scale(1.15);
        filter: brightness(2) saturate(0.5) hue-rotate(180deg);
    }
    60% {
        transform: scale(1.1);
        filter: brightness(1.8) saturate(1.5);
    }
    100% {
        transform: scale(1);
        filter: 
            brightness(1.3) 
            saturate(1.2)
            drop-shadow(0 0 8px var(--tera-glow-color, #22d3ee))
            drop-shadow(0 0 15px var(--tera-glow-color, #22d3ee));
    }
}
/* 4. å¤ªæ™¶å±æ€§é¢œè‰²æ˜ å°„ (ç”¨äºå‘å…‰æ•ˆæœ) */
.tera-type-normal { --tera-glow-color: #a8a878; }
.tera-type-fire { --tera-glow-color: #f08030; }
.tera-type-water { --tera-glow-color: #6890f0; }
.tera-type-electric { --tera-glow-color: #f8d030; }
.tera-type-grass { --tera-glow-color: #78c850; }
.tera-type-ice { --tera-glow-color: #98d8d8; }
.tera-type-fighting { --tera-glow-color: #c03028; }
.tera-type-poison { --tera-glow-color: #a040a0; }
.tera-type-ground { --tera-glow-color: #e0c068; }
.tera-type-flying { --tera-glow-color: #a890f0; }
.tera-type-psychic { --tera-glow-color: #f85888; }
.tera-type-bug { --tera-glow-color: #a8b820; }
.tera-type-rock { --tera-glow-color: #b8a038; }
.tera-type-ghost { --tera-glow-color: #705898; }
.tera-type-dragon { --tera-glow-color: #7038f8; }
.tera-type-dark { --tera-glow-color: #705848; }
.tera-type-steel { --tera-glow-color: #b8b8d0; }
.tera-type-fairy { --tera-glow-color: #ee99ac; }
/* =========================================
   [ADDON] Stellar (æ˜Ÿæ™¶) å±æ€§è§†è§‰é£æ ¼
   æµåŠ¨çš„å½©è™¹å…‰æ•ˆ + çš‡å† è´¨æ„Ÿ
   ========================================= */
.tera-type-stellar { 
    --tera-glow-color: #ffffff;
}
/* è¦†ç›–é»˜è®¤çš„ filter åŠ¨ç”»ï¼Œå®ç°å½©è™¹æµå…‰ */
.p-sprite.state-terastal.tera-type-stellar {
    filter: 
        brightness(1.1)
        contrast(1.1)
        drop-shadow(0 0 5px rgba(255, 0, 0, 0.4))
        drop-shadow(0 0 10px rgba(0, 255, 0, 0.4))
        drop-shadow(0 0 15px rgba(0, 0, 255, 0.4));
    animation: stellar-rainbow-pulse 3s linear infinite;
}
/* å¦‚æœæ˜¯æ˜Ÿæ™¶çˆ†å‘ç¬é—´ */
.p-sprite.tera-burst.tera-type-stellar {
    animation: stellar-crystallize 1s ease-out forwards;
}
@keyframes stellar-rainbow-pulse {
    0% { filter: drop-shadow(0 0 8px #ff0000) brightness(1.2); }
    15% { filter: drop-shadow(0 0 8px #ffbd00) brightness(1.2); }
    30% { filter: drop-shadow(0 0 8px #00ff00) brightness(1.2); }
    45% { filter: drop-shadow(0 0 8px #00ffff) brightness(1.2); }
    60% { filter: drop-shadow(0 0 8px #0000ff) brightness(1.2); }
    75% { filter: drop-shadow(0 0 8px #d400ff) brightness(1.2); }
    100% { filter: drop-shadow(0 0 8px #ff0000) brightness(1.2); }
}
@keyframes stellar-crystallize {
    0% { transform: scale(1); filter: brightness(1); }
    50% { transform: scale(1.3); filter: brightness(5) hue-rotate(360deg) saturate(2); }
    100% { transform: scale(1); filter: brightness(1.2) drop-shadow(0 0 15px white); }
}
/* åå­—æ ‡ç­¾çš„ç‰¹æ®Šæ ·å¼ */
.tera-name-badge.stellar {
    background: linear-gradient(90deg, #ff0000, #ffff00, #00fbff, #d400ff);
    background-size: 200% 200%;
    animation: gradient-scroll 2s ease infinite;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    border: 1px solid white;
}
@keyframes gradient-scroll {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
/* 5. å¤ªæ™¶åŒ–åå­—æ ‡ç­¾æ ·å¼ */
.tera-name-badge {
    display: inline-block;
    padding: 2px 6px;
    margin-left: 4px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
    background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    box-shadow: 0 0 5px rgba(34, 211, 238, 0.5);
}
/* 6. å¤ªæ™¶åŒ–æˆ˜è´¥åŠ¨ç”»ï¼šæ°´æ™¶ç¢è£‚æ•ˆæœ */
.p-sprite.state-terastal.fainting {
    --sprite-faint-animation: tera-shatter 0.9s ease forwards;
}
@keyframes tera-shatter {
    0% {
        opacity: 1;
        transform: translateY(0) scale(var(--sprite-scale, 1));
        filter: 
            brightness(1.3) 
            saturate(1.2)
            drop-shadow(0 0 8px var(--tera-glow-color, #22d3ee))
            drop-shadow(0 0 15px var(--tera-glow-color, #22d3ee));
    }
    20% {
        opacity: 1;
        transform: translateY(-5px) scale(calc(var(--sprite-scale, 1) * 1.05));
        filter: 
            brightness(2) 
            saturate(0.5)
            drop-shadow(0 0 20px var(--tera-glow-color, #22d3ee))
            drop-shadow(0 0 40px var(--tera-glow-color, #22d3ee));
    }
    40% {
        opacity: 0.8;
        transform: translateY(0) scale(calc(var(--sprite-scale, 1) * 0.9));
        filter: 
            brightness(1.5) 
            saturate(1.5)
            hue-rotate(30deg)
            drop-shadow(0 0 15px var(--tera-glow-color, #22d3ee));
    }
    60% {
        opacity: 0.5;
        transform: translateY(10px) scale(calc(var(--sprite-scale, 1) * 0.6));
        filter: 
            brightness(1.2) 
            saturate(2)
            hue-rotate(-30deg)
            drop-shadow(0 0 10px var(--tera-glow-color, #22d3ee));
    }
    80% {
        opacity: 0.2;
        transform: translateY(25px) scale(calc(var(--sprite-scale, 1) * 0.35));
        filter: 
            brightness(0.8) 
            saturate(0.5)
            drop-shadow(0 0 5px var(--tera-glow-color, #22d3ee));
    }
    100% {
        opacity: 0;
        transform: translateY(45px) scale(calc(var(--sprite-scale, 1) * 0.15));
        filter: 
            brightness(0.3) 
            saturate(0)
            drop-shadow(0 0 0px transparent);
    }
}
/* =========================================================
   ã€å¿ƒçœ¼ç³»ç»Ÿã€‘å±æ€§å…‹åˆ¶æç¤ºæ ·å¼ (enable_insight)
   ========================================================= */
.insight-hint {
    display: inline-block;
    margin-left: 4px;
    font-weight: bold;
    font-size: 0.9em;
    vertical-align: middle;
}
.insight-super {
    color: #22c55e;
    text-shadow: 0 0 4px rgba(34, 197, 94, 0.6);
    animation: insight-pulse 1.2s ease-in-out infinite;
}
.insight-resist {
    color: #f97316;
    text-shadow: 0 0 4px rgba(249, 115, 22, 0.5);
}
.insight-immune {
    color: #ef4444;
    text-shadow: 0 0 4px rgba(239, 68, 68, 0.6);
    font-size: 1em;
}
@keyframes insight-pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.15); }
}
/* =========================================================
   ã€å¤æ­¦ç³»ç»Ÿ V4ã€‘å¤ªæå®šå¼ç  (The Taiji Orb)
   è§†è§‰é€»è¾‘ï¼šç±»ä¼¼ Mega æŒ‰é’®çš„åœ†å½¢æµ®é›•ï¼Œç‚¹å‡»åé˜´é˜³æµè½¬
   ========================================================= */
.taiji-orb {
    position: absolute;
    top: -40px;
    right: 100px;
    z-index: 50;
    appearance: none;
    border: none;
    cursor: pointer;
    background: transparent;
    padding: 0;
    width: 58px;
    height: 58px;
    border-radius: 50%;
    transform: skewX(-15deg);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.2s ease;
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
}
.taiji-orb.hidden {
    opacity: 0;
    pointer-events: none;
    transform: skewX(-15deg) scale(0);
}
.taiji-orb:hover {
    transform: skewX(-15deg) scale(1.08);
    filter: brightness(1.1);
}
.taiji-orb .spinner {
    position: absolute;
    inset: 4px;
    border-radius: 50%;
    overflow: hidden;
    background: conic-gradient(
        from 90deg,
        #0fb6f2 0% 50%,
        #ff5050 50% 100%
    );
    box-shadow: inset 0 0 12px rgba(0,0,0,0.4);
    transition: transform 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28), background 0.4s ease;
    transform: rotate(0deg);
}
.taiji-orb::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 3px solid rgba(255, 230, 200, 0.85);
    box-shadow:
        inset 0 0 8px rgba(255,255,255,0.4),
        0 2px 5px rgba(0,0,0,0.3);
    pointer-events: none;
}
.taiji-orb .center-content {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
}
.taiji-orb .label-kanji {
    font-weight: 900;
    font-size: 1.4rem;
    color: white;
    text-shadow:
        0 2px 6px rgba(0,0,0,0.7),
        0 0 8px rgba(0,0,0,0.5);
    transform: skewX(15deg);
    transition: transform 0.15s ease, opacity 0.15s ease;
}
.taiji-orb .aura-ring {
    position: absolute;
    inset: -4px;
    border-radius: 50%;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
}
/* çŠ¶æ€ï¼šNormal */
.taiji-orb.normal .spinner {
    transform: rotate(0deg);
    filter: grayscale(0.4);
}
.taiji-orb.normal .label-kanji {
    opacity: 0.8;
}
/* çŠ¶æ€ï¼šAgile */
.taiji-orb.agile .spinner {
    transform: rotate(360deg);
    background: #0ea5e9;
    box-shadow: inset 0 0 20px rgba(255,255,255,0.5);
}
.taiji-orb.agile .label-kanji {
    transform: skewX(15deg) scale(1.1);
    text-shadow: 0 0 12px #38bdf8, 0 0 6px rgba(0,0,0,0.7);
}
.taiji-orb.agile .aura-ring {
    opacity: 0.6;
    box-shadow: 0 0 20px #22d3ee, 0 0 35px rgba(56,189,248,0.7);
    animation: pulse-blue 1.5s infinite;
}
/* çŠ¶æ€ï¼šStrong */
.taiji-orb.strong .spinner {
    transform: rotate(-200deg);
    background: #dc2626;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.6);
}
.taiji-orb.strong .label-kanji {
    transform: skewX(15deg) scale(1.15);
    text-shadow: 0 0 10px rgba(220,38,38,0.8), 0 0 4px rgba(0,0,0,0.8);
}
.taiji-orb.strong .aura-ring {
    opacity: 0.6;
    box-shadow: 0 0 22px #f87171, 0 0 35px rgba(248,113,113,0.8);
    animation: pulse-red 1.1s infinite alternate;
}
@keyframes pulse-blue {
    0% { transform: scale(1); opacity: 0.45; }
    50% { transform: scale(1.08); opacity: 0.75; }
    100% { transform: scale(1); opacity: 0.45; }
}
@keyframes pulse-red {
    0% { transform: scale(1); opacity: 0.5; }
    100% { transform: scale(1.05); opacity: 0.85; }
}
/* =========================================
   COMMANDER SYSTEM STYLES (æœºæ¢°å¿«é—¨é£æ ¼)
   Designer Note: 
   é‡‡ç”¨æ—‹è½¬åå­—å¸ƒå±€ + åœ†å½¢æŒ–å­” + æœºæ¢°è´¨æ„Ÿ
   ========================================= */
/* 1. Commander Layer (å®¹å™¨) */
#commander-overlay {
    position: absolute;
    inset: 0;
    z-index: 9000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.4);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}
#commander-overlay:not(.hidden) {
    opacity: 1;
    pointer-events: auto;
    animation: overlay-fade-in 0.3s ease-out;
}
@keyframes overlay-fade-in {
    0% {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    100% {
        opacity: 1;
        backdrop-filter: blur(4px);
    }
}
/* 2. Center Core (æœºæ¢°å¿«é—¨æ ¸å¿ƒ) */
.cmd-hub {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    z-index: 20;
    pointer-events: none;
    border-radius: 50%;
    background: #1e1e1e;
    box-shadow: 
        0 0 0 3px #2d3436,
        0 0 0 5px #121417;
    display: flex;
    align-items: center;
    justify-content: center;
}
.pulse-ring {
    width: 10px;
    height: 10px;
    background: #333;
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 50%;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
    transition: background 0.3s;
}
#commander-overlay:hover .pulse-ring {
    background: #747d8c;
}
/* 3. The Radial System (æ—‹è½¬åå­—å¸ƒå±€) */
.commander-container {
    position: relative;
    width: 360px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 40px;
}
.commander-title {
    display: none;
}
.commander-wheel {
    position: relative;
    width: 360px;
    height: 360px;
    transform: rotate(-45deg);
}
/* é€šç”¨æŒ‰é’®å½¢æ€ */
.cmd-btn {
    position: absolute;
    width: calc(50% - 8px);
    height: calc(50% - 8px);
    background: #fff;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    overflow: visible;
    outline: none;
    transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), background-color 0.2s;
    -webkit-mask: radial-gradient(circle at var(--org-x) var(--org-y), transparent 45px, black 46px);
    mask: radial-gradient(circle at var(--org-x) var(--org-y), transparent 45px, black 46px);
    opacity: 0;
    animation: btn-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}
@keyframes btn-slide-in {
    0% {
        opacity: 0;
        transform: scale(0.8);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}
/* æŒ‰é’®å†…å®¹å¸ƒå±€ */
.cmd-content {
    width: 100%;
    height: 100%;
    transform: rotate(45deg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    position: relative;
}
/* å››ä¸ªæ–¹ä½å®šä½ */
.pos-top {
    top: 0;
    right: 0;
    border-radius: 0 100px 0 0;
    --org-x: 0%;
    --org-y: 100%;
    transform-origin: -20% 120%;
    animation-delay: 0.1s;
}
.pos-right {
    bottom: 0;
    right: 0;
    border-radius: 0 0 100px 0;
    --org-x: 0%;
    --org-y: 0%;
    transform-origin: -20% -20%;
    animation-delay: 0.15s;
}
.pos-bottom {
    bottom: 0;
    left: 0;
    border-radius: 0 0 0 100px;
    --org-x: 100%;
    --org-y: 0%;
    transform-origin: 120% -20%;
    animation-delay: 0.2s;
}
.pos-left {
    top: 0;
    left: 0;
    border-radius: 100px 0 0 0;
    --org-x: 100%;
    --org-y: 100%;
    transform-origin: 120% 120%;
    animation-delay: 0.25s;
}
/* Typography */
.cmd-label {
    font-family: var(--font-main);
    font-size: 1.8rem;
    font-weight: 900;
    color: var(--active-c);
    margin: 0;
    padding: 0;
    line-height: 0.9;
    letter-spacing: -1px;
    font-style: italic;
    text-transform: uppercase;
    transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: inline-block;
    transform-origin: center;
}
.cmd-sub {
    font-family: var(--font-main);
    font-size: 0.8rem;
    font-weight: 800;
    color: var(--active-c);
    opacity: 0.8;
    margin-top: 6px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    transition: color 0.2s;
}
/* SVG å›¾æ ‡èƒŒæ™¯ */
.icon-bg {
    position: absolute;
    top: 65%;
    left: 65%;
    transform: translate(-50%, -50%) rotate(45deg);
    width: 200px;
    height: 200px;
    opacity: 0.15;
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 0;
}
/* SVG é»˜è®¤å¡«å……è‰² - ä½¿ç”¨ä¸»é¢˜è‰² */
.theme-insight .icon-bg,
.theme-insight .icon-bg path,
.theme-insight .icon-bg g { fill: #00d2d3; }
.theme-trust .icon-bg,
.theme-trust .icon-bg path,
.theme-trust .icon-bg g { fill: #ff9f43; }
.theme-passion .icon-bg,
.theme-passion .icon-bg path,
.theme-passion .icon-bg g { fill: #ff6b6b; }
.theme-devotion .icon-bg,
.theme-devotion .icon-bg path,
.theme-devotion .icon-bg g { fill: #a55eea; }
.cmd-emoji {
    display: none;
}
/* é¢œè‰²ä¸»é¢˜ */
.theme-insight  { --active-c: #00d2d3; }
.theme-trust    { --active-c: #ff9f43; }
.theme-passion  { --active-c: #ff6b6b; }
.theme-devotion { --active-c: #a55eea; }
/* Hover äº¤äº’ - ä»…èƒŒæ™¯è‰²å˜åŒ–ï¼Œç§»é™¤æ•´ä½“æŒ‰é’®ç¼©æ”¾ */
.cmd-btn:hover {
    z-index: 50;
    background: var(--active-c);
    box-shadow: 0 0 0 6px rgba(255,255,255,0.1);
}
/* é€†è½¬è£åˆ¤å¼æ–‡å­—å–Šå‡ºæ•ˆæœ - åªé’ˆå¯¹æ–‡å­— */
@keyframes text-shout {
    0% {
        transform: scale(1) rotate(0deg);
        text-shadow: 0 0 0 transparent;
    }
    20% {
        transform: scale(1.5) rotate(-3deg);
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.9);
    }
    40% {
        transform: scale(1.2) rotate(2deg);
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
    }
    60% {
        transform: scale(1.35) rotate(-1deg);
        text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
    }
    80% {
        transform: scale(1.25) rotate(0deg);
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }
    100% {
        transform: scale(1.3);
        text-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
    }
}
.cmd-btn:hover .cmd-label {
    color: #121417;
    /* æ›´åŠ å‰§çƒˆçš„æ–‡å­—å¼¹è·³åŠ¨ç”» */
    animation: text-shout 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
.cmd-btn:hover .cmd-sub {
    color: #121417;
    opacity: 0.9;
}
.cmd-btn:hover .icon-bg,
.cmd-btn:hover .icon-bg path,
.cmd-btn:hover .icon-bg g {
    fill: #000 !important;
}
.cmd-btn:hover .icon-bg {
    opacity: 0.2;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(30deg) scale(1.1);
}
.cmd-btn:active {
    transform: scale(0.98);
    background: #f1f2f6;
    transition: 0.05s;
}
/* ç¦ç”¨çŠ¶æ€ */
.cmd-btn:disabled {
    opacity: 0.4;
    pointer-events: none;
    filter: grayscale(1);
}
/* åº•éƒ¨å–æ¶ˆæŒ‰é’® */
.cmd-cancel-hint {
    position: relative;
    background: #2d3436;
    border: 2px solid #57606f;
    border-radius: 99px;
    padding: 12px 40px;
    color: #fff;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-weight: 900;
    font-size: 1rem;
    letter-spacing: 2px;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: 0.2s;
    animation: cancel-fade-in 0.4s ease-out 0.3s both;
}
@keyframes cancel-fade-in {
    0% {
        opacity: 0;
        transform: translateY(20px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}
.cmd-cancel-hint:hover {
    background: #fff;
    border-color: #fff;
    color: #2d3436;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255,255,255,0.3);
}
.cmd-cancel-hint .key {
    display: inline-block;
    padding: 3px 10px;
    background: #333;
    border: 1px solid #666;
    border-radius: 4px;
    margin-right: 8px;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-weight: 900;
    font-size: 0.85rem;
    transition: 0.2s;
}
.cmd-cancel-hint:hover .key {
    background: #e0e0e0;
    border-color: #ccc;
    color: #2d3436;
}
/* ==========================================================
   CLASH SYSTEM - å¯¹å†²ç³»ç»Ÿ UI (Visual Remastered)
   é£æ ¼ï¼šSwitch Gen9 / Persona æ··åˆé£æ ¼ (æ˜äº®ã€ç£¨ç ‚ã€æ–œåˆ‡)
   ========================================================== */
/* 1. Insight Warning Banner (é¡¶éƒ¨æ€æ„æ„ŸçŸ¥æ¨ªå¹…) */
.insight-warning {
    position: absolute;
    top: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    width: auto;
    min-width: 320px;
    padding: 10px 25px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(12px) saturate(120%);
    border: 1px solid rgba(255, 94, 94, 0.3);
    border-left: 6px solid #ff4757;
    border-radius: 4px;
    box-shadow: 0 8px 20px rgba(255, 71, 87, 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    opacity: 0;
    pointer-events: none;
    z-index: 800;
    transition: all 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    transform-origin: top center;
    clip-path: polygon(0 0, 100% 0, 98% 100%, 2% 100%);
}
.insight-warning.active {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}
.insight-icon {
    font-size: 1.5rem;
    filter: drop-shadow(0 0 5px rgba(255, 71, 87, 0.6));
    animation: insight-blink 0.8s ease-in-out infinite alternate;
}
@keyframes insight-blink {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0.6; transform: scale(0.9); }
}
.insight-text {
    color: #2f3542;
    font-family: var(--font-main);
    font-size: 1.05rem;
    font-weight: 800;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}
/* 2. AVS Insight Bar (HUD æ›´æ–°) */
.insight-bar {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    height: 4px;
    background: rgba(0,0,0,0.2);
    border-radius: 2px;
    overflow: hidden;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
}
.insight-bar.active {
    opacity: 1;
}
.insight-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #74b9ff, #fb5151);
    width: 0%;
    transition: width 0.3s;
}
.insight-bar-text {
    position: absolute;
    width: 100%;
    text-align: center;
    top: -18px;
    color: #fff;
    font-weight: 900;
    font-size: 0.7rem;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    letter-spacing: 1px;
}
/* ======================================================= 
   Environment Overlay HUD - ç¯å¢ƒå›¾å±‚æ˜¾ç¤º
   å·²ç§»é™¤ï¼šæ”¹ä¸ºä»…åœ¨æˆ˜æ–—æ—¥å¿—ä¸­æ˜¾ç¤ºç¯å¢ƒæ•ˆæœ
   ======================================================= */
/* ======================================================= 
   2. CLASH UI v4 - "Versus Overload" (çº¢è“å¯¹æˆ˜å¢å¼ºç‰ˆ)
   ç‰¹å¾ï¼šä¿ç•™åœ†æ»‘æ–œåˆ‡ï¼ŒåŠ å¼ºåŒæ–¹é˜µè¥è‰²å½©å¯¹æ¯”
   P1: Cyan Blue | P2: Hot Pink/Red
   ======================================================= */
.clash-option-modal {
    position: absolute;
    inset: 0; 
    z-index: 8000;
    display: flex;
    align-items: center;
    justify-content: center;
    background: 
        radial-gradient(circle at center, rgba(20, 20, 30, 0.4) 0%, rgba(20, 20, 30, 0.7) 100%),
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.1) 3px);
    backdrop-filter: blur(6px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s cubic-bezier(0.2, 0.8, 0.2, 1),
                backdrop-filter 0.3s ease;
}
.clash-option-modal.active {
    opacity: 1;
    pointer-events: auto;
}
.clash-card-core {
    position: relative;
    width: 540px;
    background: #fff;
    transform: skewX(-12deg); 
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 
        0 20px 50px -10px rgba(0,0,0,0.3), 
        0 0 0 1px rgba(255,255,255,0.1);
    display: flex;
    flex-direction: column;
    opacity: 0;
    transform: skewX(-12deg) translateY(30px) scale(0.92);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.clash-option-modal.active .clash-card-core {
    opacity: 1;
    transform: skewX(-12deg) translateY(0) scale(1);
}
.clash-header-bar {
    width: 120%; 
    margin-left: -10%;
    background: #111827; 
    padding: 12px 0;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    position: relative;
    z-index: 10;
    border-bottom: 3px solid transparent; 
    background-image: 
        linear-gradient(#111827, #111827), 
        linear-gradient(90deg, #12c2e9, #c471ed, #f64f59);
    background-origin: border-box;
    background-clip: padding-box, border-box;
}
.clash-header-bar span {
    transform: skewX(12deg);
    font-family: var(--font-main);
}
.header-deco { color: #f64f59; filter: drop-shadow(0 0 5px rgba(246, 79, 89, 0.5)); }
.header-title { font-weight: 900; font-size: 1.2rem; letter-spacing: 1px; font-style: italic; }
.header-sub { 
    font-size: 0.9rem; 
    font-weight: 700; 
    background: linear-gradient(90deg, #fff 0%, #aaa 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.clash-body-grid {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 32px 40px 40px; 
    width: 100%;
    box-sizing: border-box;
    position: relative;
    background: linear-gradient(90deg, 
        rgba(0, 150, 255, 0.03) 0%, 
        rgba(0, 150, 255, 0.03) 49%, 
        rgba(255, 255, 255, 0) 50%,
        rgba(255, 50, 50, 0.03) 51%, 
        rgba(255, 50, 50, 0.03) 100%
    );
}
.unit-group {
    display: flex;
    flex-direction: column;
    width: 45%; 
    transform: skewX(12deg); 
}
.p1-side { 
    align-items: flex-start; 
    text-align: left; 
    opacity: 0;
    transform: skewX(12deg) translateX(-40px);
    transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1);
}
.clash-option-modal.active .p1-side {
    opacity: 1;
    transform: skewX(12deg) translateX(0);
    transition-delay: 0.1s;
}
.p1-side .unit-role-lbl {
    font-size: 0.75rem; 
    font-weight: 900; 
    color: #4facfe;
    letter-spacing: 1px;
    margin-bottom: 5px; 
    text-transform: uppercase;
}
.p1-side .unit-main-name {
    font-size: 2rem; 
    font-weight: 900;
    color: #0c1a2e; 
    line-height: 1;
    margin-bottom: 12px;
}
.unit-divider {
    width: 70%;
    height: 4px;
    border-radius: 999px;
    margin: 6px 0 14px;
    align-self: flex-start;
}
.p1-divider {
    background: linear-gradient(90deg, rgba(0, 150, 255, 0.45), rgba(255,255,255,0));
}
.p1-side .unit-badge {
    color: #026388;
    background: rgba(79, 172, 254, 0.15);
    border: 1px solid rgba(79, 172, 254, 0.2);
}
.p2-side { 
    align-items: flex-end; 
    text-align: right; 
    opacity: 0;
    transform: skewX(12deg) translateX(40px);
    transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1);
}
.clash-option-modal.active .p2-side {
    opacity: 1;
    transform: skewX(12deg) translateX(0);
    transition-delay: 0.1s;
}
.p2-side .unit-role-lbl {
    font-size: 0.75rem; 
    font-weight: 900; 
    color: #ff5e78;
    letter-spacing: 1px;
    margin-bottom: 5px; 
    text-transform: uppercase;
}
.p2-side .unit-main-name {
    font-size: 2rem; 
    font-weight: 900;
    color: #2e0c10; 
    line-height: 1;
    margin-bottom: 12px;
}
.p2-side .unit-divider {
    align-self: flex-end;
}
.p2-divider {
    background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255, 94, 120, 0.45));
}
.p2-side .unit-badge {
    color: #920b22;
    background: rgba(255, 94, 120, 0.15);
    border: 1px solid rgba(255, 94, 120, 0.2);
}
.unit-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 8px; 
    font-weight: 800;
    font-size: 0.85rem;
    font-family: var(--font-number);
    text-transform: uppercase;
}
.vs-divider-shape {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) skewX(12deg);
    width: 2px;
    height: 70%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
}
 .vs-divider-shape .skew-line { display: none; }
.vs-shockwave {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 100px; height: 100px;
    background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 70%);
    border-radius: 50%;
    z-index: 1;
    opacity: 0;
    pointer-events: none;
}
.clash-option-modal.active .vs-shockwave {
    animation: vs-boom 0.8s ease-out 0.3s forwards;
}
@keyframes vs-boom {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 0.8; }
    50% { opacity: 0.4; }
    100% { transform: translate(-50%, -50%) scale(8); opacity: 0; }
}
.vs-text {
    color: #adb5bd;
    font-weight: 900;
    font-size: 3rem;
    font-style: italic;
    padding: 5px;
    font-family: var(--font-main);
    z-index: 2;
    -webkit-text-stroke: 2px rgba(255,255,255,0.8);
    opacity: 0;
    transform: scale(0);
    transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.clash-option-modal.active .vs-text {
    opacity: 1;
    transform: scale(1);
    transition-delay: 0.3s;
}
.clash-action-deck {
    display: flex;
    height: 72px; 
    width: 100%;
    border-top: 1px solid rgba(0,0,0,0.1); 
    box-sizing: border-box;
}
.deck-btn {
    border: none;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.2s;
    font-family: var(--font-main);
    display: block;
    outline: none;
}
.deck-btn.primary {
    flex: 2;
    background: 
        repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.03) 5px, rgba(0,0,0,0.03) 10px),
        linear-gradient(135deg, #ff5e78 0%, #e84393 100%);
    color: white;
    transform-origin: center right;
}
.deck-btn.primary:hover {
    filter: brightness(1.1);
}
.deck-btn.primary:active {
    filter: brightness(0.9);
}
.deck-btn.secondary {
    flex: 1;
    background: #f8fafc;
    color: #64748b;
    border-left: 1px solid rgba(0,0,0,0.1);
}
.deck-btn.secondary:hover {
    background: #f1f5f9;
    color: #1e293b;
}
.btn-inner-unskew {
    transform: skewX(12deg); 
    width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center; 
    justify-content: center;
    position: relative;
}
.btn-floating-icon {
    position: absolute;
    font-size: 2.5rem;
    opacity: 0.15;
    z-index: 0;
    right: 20%;
    top: 60%;
    transform: translateY(-50%) rotate(-10deg) scale(3);
    color: currentColor;
    pointer-events: none;
}
.btn-msg {
    position: relative; z-index: 2;
    font-size: 1.5rem; font-weight: 900; line-height: 1;
    text-transform: uppercase; letter-spacing: 1px;
}
.btn-sub-msg {
    position: relative; z-index: 2;
    font-size: 0.8rem; font-weight: 700; opacity: 0.85; margin-top: 4px;
}
/* 4. è§’æ ‡æŒ‡ç¤ºå™¨ (Move Menu Upgrade) */
.move-btn .clash-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    z-index: 10;
    background: #fff;
    color: #e55039;
    border: 2px solid #e55039;
    border-radius: 6px;
    padding: 2px 6px;
    font-size: 0.7rem;
    font-weight: 900;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    animation: badge-bounce 1s infinite;
    transform-origin: bottom center;
}
@keyframes badge-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
}
/* 5. Result Animation (å¯¹å†²æ–‡å­—ç‰¹æ•ˆ) */
.clash-result-overlay {
    position: fixed;
    inset: 0;
    z-index: 3000;
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: center;
}
.clash-result-text {
    font-family: var(--font-main);
    font-style: italic;
    font-weight: 900;
    font-size: 5rem;
    line-height: 1;
    text-align: center;
    -webkit-text-stroke: 3px #fff;
    paint-order: stroke fill;
    transform: scale(0);
    animation: comic-boom 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
}
.clash-result-text.overpower {
    color: #ff4757;
    filter: drop-shadow(4px 4px 0 #2f3542);
}
.clash-result-text.neutralize {
    color: #ffa502;
    filter: drop-shadow(4px 4px 0 #2f3542);
}
.clash-result-text.pierce {
    color: #5352ed;
    filter: drop-shadow(4px 4px 0 #2f3542);
}
@keyframes comic-boom {
    0% { transform: scale(0) rotate(-15deg); opacity: 0; }
    50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
    70% { transform: scale(1.0) rotate(0deg); opacity: 1; }
    100% { transform: scale(1.1) translateY(-100px); opacity: 0; }
}
.clash-impact {
    position: absolute;
    left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    width: 300px;
    height: 300px;
    border-radius: 50%;
    background: radial-gradient(circle, 
        rgba(255,255,255,0.95) 0%, 
        rgba(255,200,100,0.6) 30%,
        rgba(255,100,50,0.3) 60%,
        transparent 80%
    );
    z-index: 2999;
    opacity: 0;
    pointer-events: none;
    animation: clash-boom 0.6s ease-out forwards;
}
@keyframes clash-boom {
    0% { 
        transform: translate(-50%, -50%) scale(0); 
        opacity: 1; 
    }
    40% { 
        opacity: 0.8; 
    }
    100% { 
        transform: translate(-50%, -50%) scale(4); 
        opacity: 0; 
    }
}
.clash-shake {
    animation: clash-sprite-shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
}
@keyframes clash-sprite-shake {
    0%, 100% { transform: translateX(0) scale(var(--sprite-scale, 1)); }
    10% { transform: translateX(-12px) rotate(-2deg) scale(var(--sprite-scale, 1)); }
    20% { transform: translateX(10px) rotate(2deg) scale(var(--sprite-scale, 1)); }
    30% { transform: translateX(-8px) rotate(-1deg) scale(var(--sprite-scale, 1)); }
    40% { transform: translateX(8px) rotate(1deg) scale(var(--sprite-scale, 1)); }
    50% { transform: translateX(-6px) scale(var(--sprite-scale, 1)); }
    60% { transform: translateX(6px) scale(var(--sprite-scale, 1)); }
    70% { transform: translateX(-4px) scale(var(--sprite-scale, 1)); }
    80% { transform: translateX(4px) scale(var(--sprite-scale, 1)); }
    90% { transform: translateX(-2px) scale(var(--sprite-scale, 1)); }
}
/* ç»“æŸæ ‡è®° */
/* ========================================================== END CLASH SYSTEM ========================================================== */
]]></file>
    <file name="index.html"><![CDATA[<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKM Battle System - Switch Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,700;0,800;0,900;1,900&family=Rubik:ital,wght@0,400;0,500;0,700;0,900;1,700&family=M+PLUS+Rounded+1c:wght@500;700;800;900&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./index.css">
    <!-- Commander System V2 Styles -->
    <link rel="stylesheet" href="./cmd/styles.css">
    <link rel="stylesheet" href="./cmd/theme-update.css">
    <!-- Vite ES Module å…¥å£ -->
    <script type="module" src="./src/main.js"></script>
</head>
<body>
    <!-- Hidden defs for global gradients (Commander System) -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" aria-hidden="true">
        <defs>
            <linearGradient id="mega-rainbow" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#ff9cd6" />
                <stop offset="25%" style="stop-color:#ffeb3b" />
                <stop offset="50%" style="stop-color:#5affda" />
                <stop offset="75%" style="stop-color:#4bcffa" />
                <stop offset="100%" style="stop-color:#d49bfd" />
            </linearGradient>
        </defs>
    </svg>
    <div class="ui-root" id="ui-root">
        <div class="ui-scale" id="ui-scale">
            <div class="screen-filters"></div>
            <div class="bg-gradient"></div>
            <div id="start-view" class="overlay-screen">
                <div class="start-card">
                    <h1 class="logo-title">BATTLE <span class="accent">LINK</span></h1>
                    <div class="loader-notch"></div>
                    <p class="sys-msg">PRESS START TO INITIALIZE</p>
                    <button class="start-btn" onclick="initGame()" id="btn-start" disabled>è¿æ¥ä¸­...</button>
                </div>
            </div>
            <div id="game-view" class="game-container hidden">
                <div class="battle-stage">
                    <!-- Canvas ç²’å­å¤©æ°”ç³»ç»Ÿ -->
                    <canvas id="weather-canvas" width="1100" height="720"></canvas>
                    <!-- å¯¹å†²ç³»ç»Ÿï¼šInsight Bar (ç›´è§‰æ¡) -->
                    <div id="insight-bar" class="insight-bar">
                        <div class="insight-bar-fill" style="width: 0%;"></div>
                        <div class="insight-bar-text">ç›´è§‰: 0</div>
                    </div>
                    <div class="trainer-hud hidden" id="trainer-hud">
                        <div class="trainer-panel">
                            <div class="trainer-panel-content">
                                <div class="trainer-name" id="trainer-name">TRAINER</div>
                            </div>
                        </div>
                        <div class="trainer-avatar-wrap">
                            <img id="trainer-avatar" alt="trainer" />
                        </div>
                    </div>
                    <div class="hud container-enemy">
                        <div class="party-track enemy-side" id="ui-enemy-dots"></div>
                        <div class="sharp-panel panel-enemy-bg">
                            <div class="panel-content unskew">
                                <div class="sw-top-row">
                                    <span class="p-name" id="enemy-name">Pokemon</span>
                                    <span class="p-lv">Lv.<span id="enemy-lvl">50</span></span>
                                </div>
                                <div class="hp-track-wrappersw">
                                    <div class="hp-border-frame">
                                        <div class="hp-fill-colors" id="enemy-hp-fill" style="width: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="deco-strip enemy"></div>
                        </div>
                    </div>
                    <div class="sprite-wrapper enemy-pos">
                        <img id="enemy-sprite" class="p-sprite" src="" alt="">
                        <div class="shadow-base"></div>
                    </div>
                    <div class="sprite-wrapper player-pos">
                        <img id="player-sprite" class="p-sprite player-scale" src="" alt="">
                        <div class="shadow-base"></div>
                    </div>
                    <div class="hud container-player">
                        <div class="sharp-panel panel-player-bg">
                            <div class="panel-content unskew">
                                <div class="sw-top-row">
                                    <span class="p-name" id="player-name">Pokemon</span>
                                    <div class="sw-row-right-group">
                                        <span class="hp-v-nums" id="player-hp-txt">--/--</span>
                                        <span class="p-lv">Lv.<span id="player-lvl">80</span></span>
                                    </div>
                                </div>
                                <div class="hp-track-wrappersw">
                                    <div class="hp-border-frame bg-player">
                                        <div class="hp-fill-colors" id="player-hp-fill" style="width: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="deco-strip player"></div>
                        </div>
                        <div class="party-track player-side" id="ui-player-dots"></div>
                    </div>
                </div>
                <!-- ============================================== -->
                <!-- COMMANDER SYSTEM V2 (è½®æ’­æ‚¬æµ®çª— + å››è±¡é™èœå•) -->
                <!-- ============================================== -->
                <!-- SMART INTEL BUBBLE (æ™ºèƒ½è½®æ’­æ°”æ³¡) -->
                <div id="smart-bubble" class="smart-bubble-wrapper" onclick="toggleCommanderRoot()">
                    <div class="bubble-glow-ring"></div>
                    <div class="bubble-core">
                        <div class="bubble-icon-stage" id="bubble-icon-stage"></div>
                    </div>
                    <div class="bubble-label-pill" id="bubble-text">LINK</div>
                    <svg class="bubble-progress" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="46" stroke-width="4" stroke="rgba(255,255,255,0.1)" fill="none"></circle>
                        <circle id="bubble-timer-circle" cx="50" cy="50" r="46" stroke-width="4" stroke="currentColor" fill="none" stroke-dasharray="289" stroke-dashoffset="0"></circle>
                    </svg>
                </div>
                <!-- COMMANDER OVERLAY (å››è±¡é™è½®ç›˜èœå•) -->
                <div id="commander-overlay" class="cmd-layer hidden">
                    <div class="commander-container">
                        <div class="commander-wheel" id="cmd-wheel">
                            <button class="cmd-btn pos-top" id="slot-top" onclick="handleQuadrant('top')">
                                <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                                <div class="cmd-content">
                                    <span class="cmd-label">---</span>
                                    <span class="cmd-sub">---</span>
                                </div>
                            </button>
                            <button class="cmd-btn pos-right" id="slot-right" onclick="handleQuadrant('right')">
                                <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                                <div class="cmd-content">
                                    <span class="cmd-label">---</span>
                                    <span class="cmd-sub">---</span>
                                </div>
                            </button>
                            <button class="cmd-btn pos-bottom" id="slot-bottom" onclick="handleQuadrant('bottom')">
                                <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                                <div class="cmd-content">
                                    <span class="cmd-label">---</span>
                                    <span class="cmd-sub">---</span>
                                </div>
                            </button>
                            <button class="cmd-btn pos-left" id="slot-left" onclick="handleQuadrant('left')">
                                <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                                <div class="cmd-content">
                                    <span class="cmd-label">---</span>
                                    <span class="cmd-sub">---</span>
                                </div>
                            </button>
                            <div class="cmd-hub">
                                <div class="pulse-ring"></div>
                            </div>
                        </div>
                        <div class="cmd-cancel-hint" onclick="handleCloseOrBack()">
                            <span class="key" id="cancel-key-text">X</span>
                            <span id="cancel-text">å…³é—­æŒ‡ä»¤</span>
                        </div>
                    </div>
                </div>
                <div class="command-dashboard">
                    <div class="msg-box-modern">
                        <div class="msg-header">
                            <span class="sys-label">BATTLE LOG</span>
                            <div class="sys-dots">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                        <div class="msg-content-area" id="log-box"></div>
                        <div class="next-cursor"></div>
                    </div>
                    <!-- ä¸»èœå• (P5 x å‰‘ç›¾ æ··åˆé£æ ¼) -->
                    <div class="main-menu" id="main-menu">
                        <div class="radical-menu-container">
                            <button class="radical-btn btn-fight" id="btn-fight" onclick="showMovesMenu()">
                                <div class="skew-fix">
                                    <div class="r-icon-bg"></div>
                                    <svg class="r-icon" viewBox="0 0 256 256" fill="currentColor" aria-hidden="true">
                                        <path d="M168,16H120A56,56,0,0,0,64,72v31.73A8.17,8.17,0,0,1,56.53,112,8,8,0,0,1,48,104V78.7a4,4,0,0,0-5.63-3.65A32,32,0,0,0,24,104v29.19a16.14,16.14,0,0,0,3.5,10q.3.36.63.69L64,179.34V216a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V177.12l15.38-53.84a16,16,0,0,0,.62-4.4V72A56,56,0,0,0,168,16Zm3.58,168.84a8,8,0,0,1-7.16,14.32L136,184.94l-28.42,14.22a8,8,0,1,1-7.16-14.32L118.11,176l-17.69-8.84a8,8,0,1,1,7.16-14.32L136,167.06l28.42-14.22a8,8,0,1,1,7.16,14.32L153.89,176Z"/>
                                    </svg>
                                    <div class="r-label">
                                        <span class="en">FIGHT</span>
                                        <span class="jp">æˆ¦é—˜</span>
                                    </div>
                                </div>
                            </button>
                            <div class="radical-sub-group" id="menu-right-col">
                                <button class="radical-btn btn-catch hidden" id="btn-catch" onclick="openBallMenu()">
                                    <div class="skew-fix">
                                        <svg class="r-icon small" viewBox="0 0 100 125">
                                            <g><path d="M50,70.2c-9.2,0-16.9-6.4-19-14.9H6.6c2.3,21.9,20.8,39,43.4,39s41.1-17.1,43.4-39H68.9C66.9,63.8,59.2,70.2,50,70.2z"/></g><circle cx="50" cy="50.7" r="12"/><path d="M30.9,46C33,37.4,40.7,31,50,31S67,37.4,69,46h24.5c-0.4-4.1-1.4-8-2.9-11.6c0.5-0.7,0.9-1.5,1.1-2.4c0.5-1.9,0.1-4-0.9-5.8  c-3.6-6-9.8-12.2-13.8-15c-1.2-0.9-2.6-1.4-4.1-1.4h0c-1.5,0-2.8,0.5-3.9,1.4C63.3,8.4,56.8,6.8,50,6.8c-6.8,0-13.3,1.6-19.1,4.4  c-1.1-0.9-2.5-1.4-3.9-1.4c-1.5,0-2.9,0.5-4.1,1.4c-4,2.9-10.2,9.1-13.8,15C8,28,7.6,30.1,8.1,32c0.2,0.9,0.6,1.7,1.1,2.4  C7.8,38.1,6.8,42,6.4,46H30.9z M68,24.7C68,24.7,68,24.7,68,24.7l4-9c0.2-0.4,0.6-0.6,1-0.6c0.3,0,0.7,0.1,1,0.4  c3.7,2.6,9.4,8.5,12.5,13.5c0.6,1.1,0.5,2.3-0.4,2.8l-6.5,3.8c-0.3,0.2-0.6,0.2-0.9,0.2c-0.5,0-1.1-0.2-1.4-0.7  c-2.4-3.2-5.3-6-8.5-8.4C68,26.2,67.7,25.4,68,24.7z M13.5,29c3.1-5.1,8.7-10.9,12.5-13.5c0.3-0.2,0.7-0.4,1-0.4  c0.4,0,0.8,0.2,1,0.6l4,9c0,0,0,0,0,0c0.3,0.7,0,1.6-0.6,2c-3.2,2.4-6.1,5.2-8.5,8.4c-0.3,0.5-0.9,0.7-1.4,0.7  c-0.3,0-0.6-0.1-0.9-0.2L14,31.8C13.1,31.2,12.9,30,13.5,29z"/>
                                        </svg>
                                        <span class="r-label-min">CATCH</span>
                                    </div>
                                </button>
                                <button class="radical-btn btn-pokemon" id="btn-pokemon" onclick="renderSwitchMenu()">
                                    <div class="skew-fix">
                                        <svg class="r-icon small" viewBox="22 28 56 48" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd" d="m50.004 29.184c10.695 0 19.656 8.0234 20.699 18.609h-13.609c-0.92969-3.0234-3.7188-5.2383-7.0938-5.2383-3.3711 0-6.1602 2.2148-7.0938 5.2383h-13.605c1.1641-10.586 10.113-18.609 20.703-18.609zm0 16.512c2.4453 0 4.4219 1.8594 4.4219 4.3047s-1.9766 4.4219-4.4219 4.4219c-2.4414 0-4.3047-1.9766-4.3047-4.4219 0-2.4414 1.8594-4.3047 4.3047-4.3047zm20.695 6.5195c-1.0391 10.582-10 18.602-20.695 18.602-10.586 0-19.535-8.0234-20.703-18.605l13.609 0.003906c0.92969 3.0195 3.7188 5.2305 7.0938 5.2305s6.1602-2.2148 7.0938-5.2305z"/>
                                        </svg>
                                        <span class="r-label-min">POKÃ‰MON</span>
                                    </div>
                                </button>
                                <button class="radical-btn btn-run" id="btn-run" onclick="tryRun()">
                                    <div class="skew-fix">
                                        <svg class="r-icon small" viewBox="0 0 100 100" fill="currentColor" aria-hidden="true">
                                            <path d="M71.738,94.995c-0.03-0.001-0.06-0.001-0.091-0.003C71.677,94.993,71.707,94.994,71.738,94.995z"/>
                                            <path d="M27.068,30.372c-0.239,0.239-0.487,0.492-0.733,0.739c0.591-0.563,1.195-1.09,1.811-1.586   C27.785,29.797,27.425,30.075,27.068,30.372z"/>
                                            <path d="M71.04,22.853c0.205-0.186,0.396-0.385,0.586-0.585c-1.787,1.653-4.176,2.653-6.788,2.653   C67.283,24.92,69.351,24.17,71.04,22.853z"/>
                                            <path d="M72.329,43.413c-0.086,0.007-0.172,0.011-0.257,0.017C72.158,43.424,72.244,43.42,72.329,43.413z"/>
                                            <path d="M68.214,43.376c-0.211-0.02-0.422-0.037-0.634-0.062C67.791,43.339,68.002,43.357,68.214,43.376z"/>
                                            <path d="M75.362,32.625c-0.024,0.024-0.046,0.038-0.07,0.056c0.338-0.13,0.672-0.28,1.004-0.44   C75.986,32.385,75.674,32.514,75.362,32.625z"/>
                                            <path d="M73.767,43.251c-0.031,0.005-0.063,0.01-0.094,0.014C73.704,43.261,73.736,43.256,73.767,43.251z"/>
                                            <path d="M61.835,30.935c-0.189-0.188-0.566-0.375-0.755-0.375c0.229,0.135,0.455,0.249,0.683,0.375H61.835z"/>
                                            <path d="M83.421,39.525c-0.074,0.049-0.15,0.094-0.224,0.142C83.272,39.619,83.347,39.573,83.421,39.525z"/>
                                            <path d="M22.886,34.977c0.206-0.269,0.415-0.531,0.625-0.791C23.299,34.445,23.092,34.709,22.886,34.977z"/>
                                            <path d="M72.258,94.986c-0.013,0.001-0.026,0.001-0.04,0.002C72.231,94.988,72.244,94.987,72.258,94.986z"/>
                                            <path d="M75.362,93.888c0.108-0.108,0.202-0.228,0.299-0.345c-0.69,0.629-1.552,1.08-2.472,1.301   C73.965,94.666,74.711,94.34,75.362,93.888z"/>
                                            <path d="M57.136,62.318c-0.357-0.238-0.737-0.476-1.125-0.714c0.374,0.232,0.749,0.472,1.124,0.715L57.136,62.318z"/>
                                            <path d="M64.886,42.847c-0.578-0.132-1.156-0.275-1.736-0.448C63.73,42.571,64.309,42.717,64.886,42.847z"/>
                                            <path d="M66.597,43.174c-0.292-0.047-0.585-0.099-0.878-0.157C66.012,43.074,66.305,43.128,66.597,43.174z"/>
                                            <path d="M71.264,94.957c-0.061-0.008-0.123-0.013-0.184-0.023C71.141,94.943,71.203,94.949,71.264,94.957z"/>
                                            <path d="M72.81,94.923c-0.018,0.003-0.035,0.005-0.053,0.008C72.775,94.928,72.793,94.926,72.81,94.923z"/>
                                            <path d="M57.51,28.492c-6.577-3.946-13.152-5.073-19.166-3.946c0,0.028-0.012,0.046-0.019,0.067   C44.361,23.365,50.934,24.602,57.51,28.492z"/>
                                            <path d="M83.802,25.422c-0.12,0.078-0.24,0.159-0.356,0.249c-0.188,0.189-0.376,0.379-0.563,0.755   C83.163,26.033,83.474,25.704,83.802,25.422z"/>
                                            <path d="M67.471,92.197c0.797,1.594,2.056,2.43,3.417,2.698C69.545,94.619,68.287,93.777,67.471,92.197z"/>
                                            <path d="M58.457,7.356c-0.129,0.091-0.26,0.18-0.383,0.275c-0.288,0.288-0.557,0.6-0.815,0.921   C57.625,8.122,58.025,7.721,58.457,7.356z"/>
                                            <path d="M85.887,37.701c0.096-0.086,0.185-0.179,0.28-0.266c-0.174,0.15-0.345,0.31-0.521,0.455   C85.726,37.824,85.807,37.766,85.887,37.701z"/>
                                            <path d="M85.126,38.296c-0.26,0.204-0.524,0.399-0.788,0.591C84.603,38.697,84.865,38.498,85.126,38.296z"/>
                                            <path d="M76.43,32.178c0.233-0.115,0.465-0.231,0.694-0.361C76.894,31.944,76.662,32.068,76.43,32.178z"/>
                                            <path d="M83.802,25.422c-0.328,0.282-0.639,0.611-0.919,1.004c-1.759,2.44-3.692,4.217-5.758,5.391   c-0.229,0.13-0.462,0.246-0.694,0.361c-0.044,0.022-0.089,0.042-0.133,0.064c-0.332,0.16-0.666,0.31-1.004,0.44   c-4.132,1.583-8.728,0.912-13.529-1.746c-0.228-0.126-0.454-0.24-0.683-0.375c-0.563-0.376-3.007-1.881-3.57-2.069   c-6.576-3.889-13.15-5.126-19.185-3.879c-3.627,0.749-7.059,2.398-10.179,4.912c-0.616,0.496-1.22,1.023-1.811,1.586   c-0.979,0.933-1.921,1.96-2.824,3.076c-0.21,0.26-0.42,0.521-0.625,0.791c-0.302,0.396-0.601,0.801-0.893,1.218   c-3.757,5.263,5.075,10.337,8.647,5.077c4.695-6.578,10.523-8.458,16.914-6.391c-3.195,5.826-6.202,11.462-10.15,19.357   c-4.136,8.08-12.966,14.469-21.614,9.582c-6.198-3.757-11.649,5.263-5.635,8.834c11.837,6.764,25.557,2.631,32.509-6.202   c0.188,0,0.563,0.186,0.751,0.186c5.826,2.069,13.344,7.329,15.6,9.212c2.253,1.877,6.199,11.462,8.456,16.346   c0.815,1.58,2.074,2.422,3.417,2.698c0.064,0.013,0.127,0.028,0.191,0.039c0.061,0.01,0.123,0.015,0.184,0.023   c0.127,0.016,0.255,0.028,0.383,0.035c0.03,0.002,0.06,0.002,0.091,0.003c0.16,0.005,0.32,0.003,0.48-0.006   c0.013-0.001,0.026-0.001,0.04-0.002c0.167-0.011,0.334-0.029,0.5-0.056c0.018-0.003,0.036-0.005,0.053-0.008   c0.128-0.022,0.254-0.049,0.379-0.079c0.92-0.221,1.782-0.672,2.472-1.301c1.423-1.296,2.11-3.339,1.019-5.668   c-2.633-5.449-7.142-16.349-10.524-19.167c-2.064-1.515-5.539-4.134-9.022-6.388c-0.375-0.243-0.75-0.483-1.124-0.715   c-0.896-0.557-1.782-1.079-2.635-1.541c3.195-6.014,6.391-11.838,9.773-17.664c0.58,0.173,1.159,0.316,1.736,0.448   c0.278,0.064,0.555,0.116,0.833,0.17c0.293,0.057,0.586,0.11,0.878,0.157c0.328,0.053,0.656,0.101,0.983,0.14   c0.212,0.026,0.423,0.042,0.634,0.062c1.3,0.123,2.587,0.14,3.858,0.054c0.086-0.006,0.172-0.01,0.257-0.017   c0.45-0.036,0.898-0.085,1.344-0.147c0.031-0.004,0.063-0.01,0.094-0.014c3.309-0.475,6.481-1.674,9.43-3.585   c0.074-0.048,0.15-0.093,0.224-0.142c0.308-0.204,0.613-0.418,0.917-0.638c0.265-0.192,0.528-0.387,0.788-0.591   c0.173-0.136,0.348-0.266,0.52-0.407c0.176-0.145,0.347-0.305,0.521-0.455c1.915-1.652,3.716-3.619,5.359-5.936   C95.002,26.631,87.866,21.929,83.802,25.422z"/>
                                            <path d="M64.838,24.92c2.612,0,5.001-0.999,6.788-2.653c1.943-1.798,3.174-4.37,3.174-7.307c0-5.448-4.511-9.958-9.962-9.958   c-2.417,0-4.645,0.891-6.381,2.354c-0.432,0.365-0.833,0.765-1.199,1.197c-1.476,1.74-2.376,3.979-2.376,6.408   C54.882,20.6,59.39,24.92,64.838,24.92z"/>
                                        </svg>
                                        <span class="r-label-min">ESCAPE</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- æŠ€èƒ½èœå• (ç‚¹å‡»æˆ˜æ–—åæ˜¾ç¤º) -->
                    <div class="moves-menu hidden" id="moves-menu">
                        <!-- å¤æ­¦æµæ´¾åˆ‡æ¢å·²è¿ç§»åˆ° Commander System V2 -->
                        <button class="action-btn" id="btn-m0" onclick="handleAttack(0)">
                            <span class="move-name">---</span>
                            <span class="move-type">---</span>
                        </button>
                        <button class="action-btn" id="btn-m1" onclick="handleAttack(1)">
                            <span class="move-name">---</span>
                            <span class="move-type">---</span>
                        </button>
                        <button class="action-btn" id="btn-m2" onclick="handleAttack(2)">
                            <span class="move-name">---</span>
                            <span class="move-type">---</span>
                        </button>
                        <button class="action-btn" id="btn-m3" onclick="handleAttack(3)">
                            <span class="move-name">---</span>
                            <span class="move-type">---</span>
                        </button>
                        <button class="back-btn-pill" id="btn-back" onclick="showMainMenu()" title="Back">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path d="M19 11H7.83l4.88-4.88a1 1 0 0 0-1.42-1.42l-6.59 6.59a1 1 0 0 0 0 1.41l6.59 6.59a1 1 0 0 0 1.42-1.41L7.83 13H19a1 1 0 0 0 0-2z"/>
                            </svg>
                        </button>
                        <!-- Mega Evolution Button -->
                        <button class="mega-btn-pill hidden" id="btn-mega" onclick="toggleMega()" title="Mega Evolution">
                            <svg viewBox="0 0 100 100" class="mega-icon">
                                <circle cx="50" cy="50" r="42" stroke="currentColor" stroke-width="6" fill="none" opacity="0.4"/>
                                <text x="50" y="68" font-size="50" text-anchor="middle" fill="currentColor" font-weight="900" style="font-family: inherit;">M</text>
                            </svg>
                        </button>
                        <!-- âœ¨ ä¸´åœºè¿›åŒ–æŒ‰é’® âœ¨ -->
                        <button class="mega-btn-pill evo-style hidden" id="btn-evolved" onclick="triggerBattleEvolution()" title="Evolution">
                            <div class="evo-particles"></div>
                            <span class="evo-text">EVO</span>
                        </button>
                    </div>
                </div>
                <!-- ç»“ç®—ç”»é¢ Overlay -->
                <div id="result-overlay" class="result-screen hidden">
                    <div class="res-modern-card" id="res-card-bg">
                        <div class="res-header-banner">
                            <div class="res-header-content">
                                <span class="res-flag">BATTLE RESULT</span>
                                <h1 class="res-big-title" id="res-title">VICTORY</h1>
                            </div>
                            <div class="res-header-pattern"></div>
                        </div>
                        <div class="res-rank-stamp-wrap">
                            <div class="res-rank-ring">
                                <span id="res-grade-letter">S</span>
                                <span id="res-grade-sub">RANK</span>
                            </div>
                        </div>
                        <div class="res-body">
                            <div class="res-info-grid">
                                <div class="res-info-tile full-width">
                                    <span class="tile-label">STATUS</span>
                                    <span class="tile-val major" id="col-status">Victory against Cynthia</span>
                                </div>
                                <div class="res-info-tile full-width description-tile">
                                    <span class="tile-icon">ğŸ’¬</span>
                                    <span class="tile-val text-desc" id="col-desc">ä¸€åœºå‹å€’æ€§çš„å®Œèƒœã€‚</span>
                                </div>
                                <div class="res-info-tile team-tile">
                                    <span class="tile-label">PARTY</span>
                                    <div class="mini-party-dots" id="res-party-viz"></div>
                                </div>
                                <div class="res-info-tile">
                                    <span class="tile-label">REASON</span>
                                    <span class="tile-val" id="col-reason">Total Domination</span>
                                </div>
                            </div>
                            <textarea id="res-clipboard-text" readonly></textarea>
                        </div>
                        <div class="res-pills-action">
                            <button class="pill-btn restart" onclick="restartBattle()">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" class="pill-icon">
                                    <path d="M4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4V2M12 4L8 8M12 4L16 8" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                RETRY
                            </button>
                            <button class="pill-btn sec" onclick="copyResultOnly()">
                                DATA ONLY
                            </button>
                            <button class="pill-btn primary" onclick="copyFullProcess()">
                                <span class="btn-text">COPY FULL LOG</span>
                                <span class="btn-sub">RP Mode</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overlay-modal hidden" id="switch-menu-layer"></div>
                <div id="ball-layer" class="ball-menu-overlay hidden">
                    <div class="ball-menu-card">
                        <div class="ball-header">SELECT BALL</div>
                        <button class="ball-option" onclick="tryCatch(1)">
                            <span>Poke Ball</span> <span class="ball-multi">x1.0</span>
                        </button>
                        <button class="ball-option" onclick="tryCatch(1.5)">
                            <span>Great Ball</span> <span class="ball-multi">x1.5</span>
                        </button>
                        <button class="ball-option" onclick="tryCatch(2.0)">
                            <span>Ultra Ball</span> <span class="ball-multi">x2.0</span>
                        </button>
                        <button class="ball-option" style="border-color:#a855f7;color:#9333ea" onclick="tryCatch(255)">
                            <span style="font-weight:900">Master Ball</span> <span class="ball-multi" style="background:#9333ea">MAX</span>
                        </button>
                        <button class="close-ball-menu" onclick="closeBallMenu()">CANCEL</button>
                    </div>
                </div>
            </div>
            <!-- å‰§åœºåŒ–åˆ‡å…¥å±‚ -->
            <div id="theater-layer" class="cutin-overlay pointer-events-none">
                <div id="cutin-stage" class="compact-bar hidden">
                    <div class="deco-edge"></div>
                    <div class="compact-content">
                        <div class="avatar-slot">
                            <img id="cutin-avatar" src="" class="c-avatar-img" alt="cutin avatar" onerror="this.style.opacity=0">
                        </div>
                        <div class="text-slot">
                            <div class="c-name-strip" id="cutin-name">TRAINER</div>
                            <div class="c-dialogue" id="cutin-text">Battle text goes here...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
    (function () {
        function handleInjectedData(data) {
            if (!data) return;
            window.globalBattleData = data;
            if (typeof window.onBattleDataInjected === 'function' && window.onBattleDataInjected !== handleInjectedData) {
                try {
                    window.onBattleDataInjected(data);
                } catch (e) {
                    console.warn('[PKM] onBattleDataInjected error:', e);
                }
            }
        }
        window.globalBattleData = window.globalBattleData || null;
        window.onBattleDataInjected = handleInjectedData;
        window.addEventListener('message', (event) => {
            const payload = event?.data;
            if (!payload || payload.type !== 'pkm-battle-data') return;
            handleInjectedData(payload.payload);
        });
        window.requestBattleDataFromParent = function () {
            if (window.parent && window.parent !== window) {
                try {
                    window.parent.postMessage({ type: 'pkm-battle-data-request' }, '*');
                } catch (e) {
                    console.warn('[PKM] requestBattleDataFromParent failed:', e);
                }
            }
        };
        window.requestBattleDataFromParent();
    })();
</script>
    <!-- Commander System V2 Script -->
    <script src="./cmd/mechanics.js"></script>
</body>
</html>]]></file>
    <file name="index.js"><![CDATA[/**
 * ===========================================
 * INDEX.JS - UI æ§åˆ¶å™¨ & å…¥å£
 * ===========================================
 * 
 * ä¾èµ–: pokedex-data.js, moves-data.js, battle-engine.js
 * 
 * èŒè´£:
 * - UI æ¸²æŸ“ (è¡€æ¡ã€ç²¾çµå›¾ã€æŒ‰é’®)
 * - ç”¨æˆ·äº¤äº’å¤„ç†
 * - æˆ˜æ–—æµç¨‹æ§åˆ¶
 * - JSON åŠ è½½å…¥å£
 */
// å…¨å±€æˆ˜æ–—çŠ¶æ€
let battle = new BattleState();
window.battle = battle;  // å¯¼å‡ºåˆ°å…¨å±€ï¼Œä¾›æ¨¡å—è®¿é—®
// ============================================
// ã€å¤æ­¦ç³»ç»Ÿ v3ã€‘åŠ¨æ€å†·å´è®¡ç®—
// åŸºäºè®­ç»ƒå®¶ç†Ÿç»ƒåº¦å†³å®šä¼‘æ†©å›åˆæ•°
// ============================================
/**
 * æ ¹æ®ç†Ÿç»ƒåº¦è®¡ç®—å¤æ­¦é£æ ¼å†·å´å›åˆæ•°
 * @param {number} proficiency - è®­ç»ƒå®¶ç†Ÿç»ƒåº¦ (0-255)
 * @returns {number} å†·å´å›åˆæ•° (0-4)
 */
function getStyleCooldown(proficiency) {
    if (proficiency > 200) return 0;  // å®—å¸ˆï¼šæ°”è„‰è´¯é€šï¼Œæ— å†·å´
    if (proficiency > 150) return 1;  // ç²¾é€šï¼šæ ‡å‡†èŠ‚å¥
    if (proficiency > 100) return 2;  // ç†Ÿæ‰‹ï¼šç¨æœ‰æµç•…
    if (proficiency > 50)  return 3;  // å…¥é—¨ï¼šèŠ‚å¥è¾ƒæ…¢
    return 4;                          // åˆå­¦è€…ï¼šåªèƒ½ä½œä¸ºç»æ€
}
window.getStyleCooldown = getStyleCooldown;
// ============================================
// ã€æŒ‡æŒ¥å®˜ç³»ç»Ÿ v2ã€‘åŒæ­¥ç‡è®¡ç®—ä¸åŠ¨æ€å†·å´
// åŒæ­¥ç‡ = (è®­ç»ƒå®¶ç†Ÿç»ƒåº¦ + AVSå››ç»´å¹³å‡) / 2
// ============================================
/**
 * è®¡ç®—è®­ç»ƒå®¶ä¸å®å¯æ¢¦çš„åŒæ­¥ç‡
 * @param {number} proficiency - è®­ç»ƒå®¶ç†Ÿç»ƒåº¦ (0-255)
 * @param {Pokemon} pokemon - å½“å‰å®å¯æ¢¦
 * @returns {number} åŒæ­¥ç‡ (0-255)
 */
function getCommanderSyncScore(proficiency, pokemon) {
    if (!pokemon || !pokemon.isAce) return 0;
    // è·å– AVS å››ç»´å¹³å‡å€¼
    let avsAverage = 0;
    if (pokemon.avs) {
        const trust = pokemon.getEffectiveAVs?.('trust') || pokemon.avs.trust || 0;
        const passion = pokemon.getEffectiveAVs?.('passion') || pokemon.avs.passion || 0;
        const insight = pokemon.getEffectiveAVs?.('insight') || pokemon.avs.insight || 0;
        const devotion = pokemon.getEffectiveAVs?.('devotion') || pokemon.avs.devotion || 0;
        avsAverage = (trust + passion + insight + devotion) / 4;
    }
    // åŒæ­¥ç‡ = (ç†Ÿç»ƒåº¦ + AVSå¹³å‡) / 2
    const syncScore = Math.floor((proficiency + avsAverage) / 2);
    return Math.min(255, Math.max(0, syncScore));
}
window.getCommanderSyncScore = getCommanderSyncScore;
/**
 * æ ¹æ®åŒæ­¥ç‡è®¡ç®—æŒ‡æŒ¥å®˜ç³»ç»Ÿå†·å´å›åˆæ•°
 * @param {number} syncScore - åŒæ­¥ç‡ (0-255)
 * @returns {number} å†·å´å›åˆæ•° (1-4, æˆ– -1 è¡¨ç¤ºä¸å¯ç”¨)
 */
function getCommanderCooldown(syncScore) {
    if (syncScore < 60)  return -1; // ä¸å¯ç”¨ï¼šé»˜å¥‘ä¸è¶³
    if (syncScore >= 240) return 1; // äºŒå­—å¹²æ¶‰(Zone)ï¼šé«˜é¢‘å¹²æ¶‰
    if (syncScore >= 180) return 2; // ç›¸å½“æ•é”
    if (syncScore >= 120) return 3; // è¾ƒä¸ºç¨³å®š
    return 4;                        // å¶å°”çµå…‰ä¸€ç°
}
window.getCommanderCooldown = getCommanderCooldown;
// ============================================
// ã€å·²è¿ç§»ã€‘å¤æ­¦ç³»ç»Ÿ -> mechanics/move-styles.js
// ã€å·²è¿ç§»ã€‘Z-Move/Max Move æ¨å¯¼ -> mechanics/z-moves.js
// ============================================
// ============================================
// ã€å·²è¿ç§»ã€‘è®­ç»ƒå®¶å¤´åƒç³»ç»Ÿ -> ui/ui-trainer-hud.js
// ã€å·²è¿ç§»ã€‘Cut-in æ¼”å‡ºç³»ç»Ÿ -> ui/ui-trainer-hud.js
// ã€å·²è¿ç§»ã€‘UI ç¼©æ”¾ -> ui/ui-renderer.js
// ============================================
// é¢„åŠ è½½æ¨¡æ‹Ÿ
setTimeout(() => {
    document.getElementById('btn-start').innerText = "START GAME";
    document.getElementById('btn-start').disabled = false;
    document.getElementById('btn-start').style.fontWeight = "900";
}, 800);
window.addEventListener('resize', updateUIScale);
updateUIScale();
/**
 * åˆå§‹åŒ–æ¸¸æˆ - åŠ è½½ç¤ºä¾‹å¯¹æˆ˜
 */
async function initGame() {
    const startBtn = document.getElementById('btn-start');
    const sysMsg = document.querySelector('.sys-msg');
    // === é¢„åŠ è½½é˜¶æ®µ ===
    startBtn.disabled = true;
    startBtn.innerText = "LOADING...";
    if (sysMsg) sysMsg.textContent = "PRELOADING RESOURCES...";
    // è·å–æˆ˜æ–—æ•°æ®
    // è®¾ç½®ä¸º true å¯å¼ºåˆ¶ä½¿ç”¨ data-loader.js ä¸­çš„é»˜è®¤æ•°æ®ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    const FORCE_USE_DEFAULT_DATA = false;
    let json;
    if (!FORCE_USE_DEFAULT_DATA && typeof globalBattleData !== 'undefined' && globalBattleData) {
        json = globalBattleData;
        console.log('[PKM] ä½¿ç”¨å¤–éƒ¨æ³¨å…¥æ•°æ® (globalBattleData)');
    } else {
        json = getDefaultBattleData();
        console.log('[PKM] ä½¿ç”¨é»˜è®¤æ•°æ® (data-loader.js)');
    }
    // ============================================
    // ã€å…¨å±€ç³»ç»Ÿå¼€å…³ã€‘ä» JSON settings è¯»å–
    // ============================================
    const settings = json.settings || {};
    window.GAME_SETTINGS = {
        enableAVS: settings.enableAVS !== false,           // AVS ç¾ç»Šå€¼ç³»ç»Ÿ
        enableCommander: settings.enableCommander !== false, // æˆ˜æœ¯æŒ‡æŒ¥ç³»ç»Ÿ
        enableEVO: settings.enableEVO !== false,           // è¿›åŒ–/ç¾ç»Šå…±é¸£ç³»ç»Ÿ
        enableBGM: settings.enableBGM !== false,           // èƒŒæ™¯éŸ³ä¹
        enableSFX: settings.enableSFX !== false,           // éŸ³æ•ˆ
        enableClash: settings.enableClash !== false,       // å¯¹å†²ç³»ç»Ÿ
        enableEnvironment: settings.enableEnvironment !== false  // ç¯å¢ƒå¤©æ°”ç³»ç»Ÿ
    };
    console.log('[SETTINGS] å…¨å±€ç³»ç»Ÿå¼€å…³:', window.GAME_SETTINGS);
    // é¢„åŠ è½½æœ¬å±€èµ„æº
    const playerParty = (json.player && json.player.party) || [];
    const enemyParty = json.party || (json.enemy && json.enemy.party) || [];
    const trainerId = (json.enemy && json.enemy.id) || (json.trainer && json.trainer.id) || null;
    if (typeof preloadBattleResources === 'function' && (playerParty.length > 0 || enemyParty.length > 0)) {
        try {
            await preloadBattleResources(playerParty, enemyParty, trainerId, (loaded, total) => {
                if (sysMsg) sysMsg.textContent = `LOADING... ${Math.floor(loaded/total*100)}%`;
            });
        } catch (e) {
            console.warn('[PRELOAD] Error:', e);
        }
    }
    if (sysMsg) sysMsg.textContent = "READY!";
    // éšè—åŠ è½½é¡µï¼Œæ˜¾ç¤ºæ¸¸æˆç•Œé¢
    document.getElementById('start-view').style.opacity = 0;
    setTimeout(() => document.getElementById('start-view').style.display = 'none', 500);
    document.getElementById('game-view').classList.remove('hidden');
    resetSpriteState();
    // åˆå§‹åŒ–å¤©æ°”è§†è§‰ç³»ç»Ÿ
    if (typeof window.initWeatherSystem === 'function') {
        window.initWeatherSystem();
    }
    // åŠ è½½å¯¹æˆ˜ JSON (å·²åœ¨é¢„åŠ è½½é˜¶æ®µè·å–)
    try {
        console.log('[PKM] ä½¿ç”¨æˆ˜æ–—æ•°æ®:', json);
        // ä» JSON åŠ è½½ç©å®¶é˜Ÿä¼
        if (json.player && json.player.party) {
            // === è§£é”ç³»ç»Ÿ (Unlock System) ===
            // è§£æ unlocks å¯¹è±¡ï¼Œå†³å®šç©å®¶æ˜¯å¦æœ‰èµ„æ ¼ä½¿ç”¨å„æœºåˆ¶
            const unlocks = json.player.unlocks || {};
            battle.playerUnlocks = {
                enable_bond: unlocks.enable_bond !== false,        // ç¾ç»Šå…±é¸£
                enable_styles: unlocks.enable_styles === true,     // åˆšçŒ›/è¿…ç–¾ (å¿…é¡»æ˜¾å¼å¯ç”¨)
                enable_insight: unlocks.enable_insight !== false,  // å¿ƒçœ¼/AVsçªç ´
                enable_mega: unlocks.enable_mega !== false,        // Megaè¿›åŒ–
                enable_z_move: unlocks.enable_z_move !== false,    // Zæ‹›å¼
                enable_dynamax: unlocks.enable_dynamax !== false,  // æå·¨åŒ–
                enable_tera: unlocks.enable_tera !== false,        // å¤ªæ™¶åŒ–
                enable_proficiency_cap: unlocks.enable_proficiency_cap === true  // è®­ç»ƒåº¦çªç ´155ä¸Šé™ (é»˜è®¤å…³é—­)
            };
            console.log('[UNLOCK] ç©å®¶è§£é”çŠ¶æ€:', battle.playerUnlocks);
            // ã€æˆ˜æœ¯æŒ‡æŒ¥ç³»ç»Ÿã€‘è¯»å–è®­ç»ƒå®¶ç†Ÿç»ƒåº¦
            // JSON æ ¼å¼: player.trainerProficiency (0-255)
            // æ ¹æ® enable_proficiency_cap è§£é”çŠ¶æ€é™åˆ¶ä¸Šé™ï¼šfalse=155, true=255
            if (json.player.trainerProficiency !== undefined) {
                const proficiencyCap = battle.playerUnlocks.enable_proficiency_cap ? 255 : 155;
                battle.trainerProficiency = Math.min(proficiencyCap, Math.max(0, json.player.trainerProficiency));
                console.log(`[COMMANDER] ä» JSON è¯»å–è®­ç»ƒå®¶ç†Ÿç»ƒåº¦: ${battle.trainerProficiency} (ä¸Šé™: ${proficiencyCap})`);
            }
            // ã€æˆ˜æœ¯æŒ‡æŒ¥ç³»ç»Ÿã€‘åˆå§‹åŒ–
            if (typeof initCommanderSystem === 'function') {
                initCommanderSystem();
            }
            // æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰ Mega æƒé™ (ç›´æ¥ä» unlocks è¯»å–)
            const playerCanMega = battle.playerUnlocks.enable_mega;
            battle.setPlayerParty(json.player.party, playerCanMega);
            battle.playerName = json.player.name || 'ä¸»è§’';
            log(`<b>${battle.playerName}</b> å‡†å¤‡æˆ˜æ–—ï¼`);
            // === Necrozma åˆä½“æ£€æµ‹ ===
            // æ£€æµ‹é˜Ÿä¼ä¸­æ˜¯å¦æœ‰ Necrozma + Solgaleo/Lunala ç»„åˆ
            if (typeof checkAndProcessNecrozmaFusion === 'function') {
                checkAndProcessNecrozmaFusion(battle.playerParty, log, () => {
                    console.log('[NECROZMA FUSION] åˆä½“æ£€æµ‹å®Œæˆ');
                });
            }
        } else {
            // Fallback: é»˜è®¤ç©å®¶é˜Ÿä¼
            battle.setPlayerParty([
                { name: 'Charmander', lv: 5, moves: ['Scratch', 'Ember'] },
                { name: 'Pikachu', lv: 5, moves: ['Thunder Shock', 'Quick Attack'] },
            ], false);
            battle.playerName = 'ä¸»è§’';
        }
        // åŠ è½½æ•Œæ–¹æ•°æ®
        battle.loadFromJSON(json);
        updateTrainerHud();
        const t = battle.trainer;
        const btnCatch = document.getElementById('btn-catch');
        const rightCol = document.getElementById('menu-right-col');
        const catchLayer = document.getElementById('ball-layer');
        if (btnCatch && rightCol) {
            if (t && (t.id === 'wild' || !t.id)) {
                btnCatch.classList.remove('hidden');
                rightCol.classList.remove('two-btn');
            } else {
                btnCatch.classList.add('hidden');
                rightCol.classList.add('two-btn');
                if (catchLayer) catchLayer.classList.add('hidden');
            }
        }
        if (t) {
            const isWild = t.id === 'wild';
            if (isWild) {
                log(`é‡ç”Ÿå®å¯æ¢¦ã€${battle.getEnemy().cnName}ã€‘å‡ºç°äº†ï¼`);
            } else {
                log(`<b style="color:#e74c3c">ã€${t.name}ã€‘</b>å‘èµ·æŒ‘æˆ˜ï¼`);
            }
            if (t.lines?.start) {
                log(`<i>${t.name}: "${t.lines.start}"</i>`);
            }
        }
        log(`æ•Œæ–¹æ´¾å‡ºäº† <b>${battle.getEnemy().cnName}</b> (Lv.${battle.getEnemy().level})!`);
        if (battle.scriptedResult === 'loss') {
            log(`<span style="color:#e67e22">[å‰§æƒ…æˆ˜] è¿™æ˜¯ä¸€åœºå¿…è´¥çš„æˆ˜æ–—...</span>`);
        }
    } catch (e) {
        console.error('Failed to load battle JSON:', e);
        // Fallback: ç®€å•å¯¹æˆ˜
        battle.setPlayerParty([
            { name: 'Pikachu', lv: 5, moves: ['Thunder Shock', 'Quick Attack'] }
        ]);
        battle.loadFromJSON({
            trainer: { name: 'é‡ç”Ÿå®å¯æ¢¦', id: 'wild', line: '' },
            party: [{ name: 'Rattata', lv: 3, moves: ['Tackle'] }]
        });
        log("é‡ç”Ÿçš„å°æ‹‰è¾¾å‡ºç°äº†ï¼");
    }
    const openingPoke = battle.getPlayer();
    const openingEnemy = battle.getEnemy();
    if (openingPoke) {
        log(`å»å§ï¼${openingPoke.cnName}ï¼ˆLv.${openingPoke.level}ï¼‰ï¼`);
    }
    // === æ’­æ”¾åŒæ–¹å®å¯æ¢¦å«å£° ===
    setTimeout(() => {
        if (openingPoke && typeof window.playPokemonCry === 'function') {
            window.playPokemonCry(openingPoke.name);
        }
    }, 500);
    setTimeout(() => {
        if (openingEnemy && typeof window.playPokemonCry === 'function') {
            window.playPokemonCry(openingEnemy.name);
        }
    }, 1200);
    // === æ£€æŸ¥å¹¶æ‰§è¡Œè¿›åœºè‡ªåŠ¨å˜å½¢ (Primal/Crowned) ===
    const checkInitTransformFunc = typeof window.checkInitTransform === 'function' ? window.checkInitTransform : null;
    if (checkInitTransformFunc) {
        // æ£€æŸ¥ç©å®¶å®å¯æ¢¦
        if (openingPoke && openingPoke.needsInitTransform) {
            console.log('[FORM] Checking player init transform:', openingPoke.name);
            const result = checkInitTransformFunc(openingPoke);
            if (result) {
                log(`<span style="color:#a855f7">âœ¦ ${result.oldName} å˜ä¸º ${result.newName}ï¼</span>`);
                // é¢„åŠ è½½æ–°å½¢æ€çš„ç²¾çµå›¾ï¼Œé¿å…é—ªçƒ
                const newSpriteUrl = openingPoke.getSprite(true); // ç©å®¶æ˜¯èƒŒé¢
                const preloader = new Image();
                preloader.src = newSpriteUrl;
            }
        }
        // æ£€æŸ¥æ•Œæ–¹å®å¯æ¢¦
        if (openingEnemy && openingEnemy.needsInitTransform) {
            console.log('[FORM] Checking enemy init transform:', openingEnemy.name);
            const result = checkInitTransformFunc(openingEnemy);
            if (result) {
                log(`<span style="color:#ef4444">âœ¦ æ•Œæ–¹ ${result.oldName} å˜ä¸º ${result.newName}ï¼</span>`);
                // é¢„åŠ è½½æ–°å½¢æ€çš„ç²¾çµå›¾ï¼Œé¿å…é—ªçƒ
                const newSpriteUrl = openingEnemy.getSprite(false); // æ•Œæ–¹æ˜¯æ­£é¢
                const preloader = new Image();
                preloader.src = newSpriteUrl;
            }
        }
    }
    // === ã€æ•Œæ–¹é¦–å‘ Necrozma åˆä½“ + Ultra Burstã€‘===
    // æ£€æµ‹é¦–å‘æ•Œæ–¹æ˜¯å¦æ˜¯ Necrozmaï¼Œä¸”é˜Ÿä¼ä¸­æœ‰ Solgaleo/Lunala å¯ä»¥åˆä½“
    if (typeof window.autoProcessNecrozmaFusion === 'function' && openingEnemy) {
        const necrozmaName = (openingEnemy.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        if (necrozmaName === 'necrozma') {
            // å»¶è¿Ÿæ‰§è¡Œï¼Œè®©ç©å®¶å…ˆçœ‹åˆ°æ™®é€š Necrozma å‡ºåœº
            setTimeout(async () => {
                updateAllVisuals('enemy');
                await new Promise(r => setTimeout(r, 800));
                const fusionResult = window.autoProcessNecrozmaFusion(battle.enemyParty, (msg) => {
                    log(msg); // æ˜¾ç¤ºåˆä½“/å˜èº«æ—¥å¿—
                });
                if (fusionResult.success) {
                    // æ›´æ–°ç²¾çµå›¾
                    const newSpriteUrl = openingEnemy.getSprite ? openingEnemy.getSprite(false) : null;
                    if (newSpriteUrl && typeof window.smartLoadSprite === 'function') {
                        window.smartLoadSprite('enemy-sprite', newSpriteUrl, false);
                    }
                    updateAllVisuals('enemy');
                    // æ’­æ”¾å˜èº«åçš„å«å£°
                    setTimeout(() => {
                        if (typeof window.playPokemonCry === 'function') {
                            window.playPokemonCry(openingEnemy.name);
                        }
                    }, 500);
                }
            }, 1500);
        }
    }
    // å»¶è¿Ÿä¸€å¸§å†æ›´æ–°è§†è§‰ï¼Œç¡®ä¿é¢„åŠ è½½å®Œæˆ
    setTimeout(() => {
        updateAllVisuals();
    }, 50);
    // === æ’­æ”¾æˆ˜æ–— BGM ===
    if (typeof playBattleBgm === 'function') {
        playBattleBgm();
    }
    // === ç¯å¢ƒå¤©æ°”åˆå§‹åŒ– (åœ°å›¾æ¨¡å—æ¥å£) ===
    // åœ¨å…¥åœºç‰¹æ€§ä¹‹å‰è§¦å‘ï¼Œå®å¯æ¢¦ç‰¹æ€§å¯ä»¥è¦†ç›–ç¯å¢ƒå¤©æ°”
    // å— settings.enableEnvironment å¼€å…³æ§åˆ¶
    const enableEnv = window.GAME_SETTINGS && window.GAME_SETTINGS.enableEnvironment;
    if (enableEnv && json.environment && json.environment.weather && json.environment.weather !== 'none') {
        const envWeather = json.environment.weather;
        const envTurns = json.environment.weatherTurns || 0;
        const suppressionTier = json.environment.suppressionTier || 1;
        const revertMessage = json.environment.revertMessage || null;
        // ä¿å­˜ç¯å¢ƒå¤©æ°”åˆ° battle å¯¹è±¡ï¼Œç”¨äºå¤©æ°”ç»“æŸåå›å½’
        battle.environmentWeather = envWeather;
        battle.weather = envWeather;
        battle.weatherTurns = envTurns; // 0 = æ°¸ä¹…
        // ã€å‹åˆ¶ç³»ç»Ÿã€‘ä¿å­˜ç¯å¢ƒé…ç½®
        battle.environmentConfig = {
            weather: envWeather,
            weatherTurns: envTurns,
            suppressionTier: suppressionTier,
            revertMessage: revertMessage
        };
        // å¤©æ°”åç§°æ˜ å°„
        const weatherNames = {
            'rain': 'ä¸‹èµ·äº†é›¨',
            'sun': 'é˜³å…‰å˜å¾—å¼ºçƒˆ',
            'sandstorm': 'åˆ®èµ·äº†æ²™æš´',
            'snow': 'ä¸‹èµ·äº†é›ª',
            'hail': 'ä¸‹èµ·äº†å†°é›¹',
            'smog': 'çƒŸéœ¾ç¬¼ç½©äº†æˆ˜åœº',
            'fog': 'æµ“é›¾å¼¥æ¼«',
            'ashfall': 'ç«å±±ç°é£˜è½',
            'gale': 'ç‹‚é£å‘¼å•¸'
        };
        const weatherName = weatherNames[envWeather] || envWeather;
        // æ ¹æ®å‹åˆ¶ç­‰çº§æ˜¾ç¤ºä¸åŒæç¤º
        let tierHint = '';
        if (suppressionTier === 2) {
            tierHint = ' <span style="color:#f59e0b">[æŠ‘åˆ¶åŒºåŸŸ]</span>';
        } else if (suppressionTier === 3) {
            tierHint = ' <span style="color:#dc2626">[ç»å¯¹é¢†åŸŸ]</span>';
        }
        log(`<span style="color:#9b59b6">ğŸŒ ç¯å¢ƒæ•ˆæœï¼š${weatherName}ï¼${tierHint}</span>`);
        // è§¦å‘å¤©æ°”è§†è§‰æ•ˆæœ
        if (typeof window.setWeatherVisuals === 'function') {
            window.setWeatherVisuals(envWeather);
        }
        console.log(`[ENVIRONMENT] åˆå§‹åŒ–ç¯å¢ƒå¤©æ°”: ${envWeather}, æŒç»­: ${envTurns || 'æ°¸ä¹…'}, å‹åˆ¶ç­‰çº§: ${suppressionTier}`);
    }
    // === ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘åˆå§‹åŒ– ===
    // ä» JSON çš„ environment.overlay åŠ è½½ç¯å¢ƒæ•ˆæœ
    console.log(`[ENV OVERLAY] æ£€æŸ¥: enableEnv=${enableEnv}, hasEnv=${!!json.environment}, hasOverlay=${!!(json.environment && json.environment.overlay)}`);
    if (enableEnv && json.environment && json.environment.overlay) {
        console.log(`[ENV OVERLAY] å¼€å§‹åŠ è½½ç¯å¢ƒå›¾å±‚...`);
        const overlay = json.environment.overlay;
        // å…ˆæ¸…é™¤æ—§ç¯å¢ƒ
        if (typeof window.clearEnvironmentOverlay === 'function') {
            window.clearEnvironmentOverlay();
        }
        // æ³¨å…¥æ–°ç¯å¢ƒ
        if (typeof window.injectEnvironmentOverlay === 'function') {
            const env = window.injectEnvironmentOverlay(overlay);
            if (env) {
                // æ˜¾ç¤ºç¯å¢ƒæ•ˆæœè¯´æ˜
                log(`<span style="color:#a855f7">ğŸŒ <b>${env.env_name}</b></span>`);
                if (env.narrative) {
                    log(`<span style="color:#a855f7; font-style:italic">${env.narrative}</span>`);
                }
                // æ˜¾ç¤ºå…·ä½“è§„åˆ™æ•ˆæœ
                for (const rule of env.rules || []) {
                    const targetDesc = _getTargetDescription(rule.target);
                    const effectsDesc = _getEffectsDescription(rule.effects);
                    if (effectsDesc) {
                        log(`<span style="color:#c084fc">  â†’ ${targetDesc}: ${effectsDesc}</span>`);
                    }
                }
                console.log(`[ENV OVERLAY] åˆå§‹åŒ–ç¯å¢ƒå›¾å±‚: ${env.env_name}, è§„åˆ™æ•°: ${env.rules?.length || 0}`);
            }
        }
    }
    // === è§¦å‘åŒæ–¹å…¥åœºç‰¹æ€§ (å¨å“ã€å¤©æ°”ç­‰) ===
    if (openingEnemy) {
        triggerEntryAbilities(openingEnemy, openingPoke);
    }
    if (openingPoke) {
        triggerEntryAbilities(openingPoke, openingEnemy);
    }
    const trainerHud = document.getElementById('trainer-hud');
    if (trainerHud) {
        trainerHud.classList.add('hidden');
        trainerHud.style.opacity = '0';
    }
    const trainer = battle.trainer;
    if (trainer && trainer.id !== 'wild') {
        const introLine = trainer.lines?.start || `${trainer.name || 'Opponent'} is challenging you!`;
        setTimeout(() => {
            playCutIn(introLine, 3500);
            setTimeout(() => {
                updateTrainerHud();
                if (trainerHud) {
                    trainerHud.classList.remove('hidden');
                    trainerHud.style.transition = 'opacity 1s';
                    trainerHud.style.opacity = '1';
                }
            }, 3800);
        }, 500);
    }
    // ã€Commander System V2ã€‘åˆå§‹åŒ–è½®æ’­æ‚¬æµ®çª—ï¼ˆåœ¨æ‰€æœ‰é˜Ÿä¼åŠ è½½å®Œæˆåï¼‰
    if (typeof window.initCommanderSystemV2 === 'function') {
        window.initCommanderSystemV2();
    }
}
// =========================================================
// ã€å·²è¿ç§»ã€‘æœºåˆ¶äº’æ–¥ç³»ç»Ÿ -> mechanics/mechanic-checker.js
// ã€å·²è¿ç§»ã€‘æå·¨åŒ–çŠ¶æ€ç®¡ç† -> mechanics/dynamax.js
// =========================================================
// =========================================================
// ã€å·²è¿ç§»ã€‘é»˜è®¤æˆ˜æ–—æ•°æ® -> systems/data-loader.js
// ã€å·²è¿ç§»ã€‘JSON æ•°æ®åŠ è½½ -> systems/data-loader.js
// =========================================================
/**
 * æ›´æ–°æˆ˜æ–—ç²¾çµå›¾ï¼ˆç”¨äº Imposter/Illusion ç‰¹æ€§è§¦å‘ååˆ·æ–°ï¼‰
 * å¯¼å‡ºåˆ° window ä¾› ability-handlers.js è°ƒç”¨
 */
function updateBattleSprites() {
    updateAllVisuals(false);
}
window.updateBattleSprites = updateBattleSprites;
/**
 * ç•Œé¢åˆ·æ–°ï¼šæ¸²æŸ“æ–‡æœ¬ã€è¡€é‡ã€å›¾ç‰‡
 * @param {string|boolean} forceSpriteAnim - false: ä¸å¼ºåˆ¶åŠ¨ç”», 'player': åªæœ‰ç©å®¶åŠ¨ç”», 'enemy': åªæœ‰æ•Œæ–¹åŠ¨ç”», true: ä¸¤è¾¹éƒ½åŠ¨ç”»
 */
function updateAllVisuals(forceSpriteAnim = false) {
    const p = battle.getPlayer();
    const e = battle.getEnemy();
    if (!p || !e) return;
    // 1. åå­— LV (æ•Œæ–¹é«˜ç­‰çº§ç”¨çº¢è‰²å¼ºè°ƒ)
    // ã€Illusion/Imposterã€‘æ”¯æŒæ˜¾ç¤ºä¼ªè£…åç§°
    document.getElementById('player-name').innerText = p.displayCnName || p.cnName;
    document.getElementById('player-lvl').innerText = p.level;
    const enemyNameEl = document.getElementById('enemy-name');
    // é‡ç”Ÿæˆ˜æ–—æ—¶æ˜¾ç¤ºå½“å‰æ•Œæ–¹å®å¯æ¢¦çš„åå­—ï¼Œè®­ç»ƒå®¶æˆ˜æ–—æ—¶æ˜¾ç¤ºå®å¯æ¢¦åå­—
    enemyNameEl.innerText = e.displayCnName || e.cnName;
    const enemyLvEl = document.getElementById('enemy-lvl');
    enemyLvEl.innerText = e.level;
    enemyLvEl.style.color = (e.level > p.level + 20) ? '#e74c3c' : '';
    enemyLvEl.style.fontWeight = (e.level > p.level + 20) ? '900' : '';
    // 2. è¡€æ¡æ¸²æŸ“
    renderHp('player', p.currHp, p.maxHp);
    renderHp('enemy', e.currHp, e.maxHp);
    // 3. å›¾ç‰‡æ™ºèƒ½åŠ è½½ (é˜²é—ªçƒ: åŠ è½½å®Œå†æ˜¾ç¤º)
    // forceSpriteAnim å¯ä»¥æ˜¯ 'player' æˆ– 'enemy' æ¥æŒ‡å®šåªæœ‰ä¸€æ–¹æ’­æ”¾åŠ¨ç”»
    const playerAnim = (forceSpriteAnim === true || forceSpriteAnim === 'player');
    const enemyAnim = (forceSpriteAnim === true || forceSpriteAnim === 'enemy');
    // æå·¨åŒ–çŠ¶æ€ä¸‹ä¸é‡æ–°åŠ è½½ç²¾çµå›¾ï¼ˆä¿æŒ G-Max å›¾ç‰‡ï¼‰
    if (!p.isDynamaxed) {
        // ã€Illusion/Imposterã€‘æ”¯æŒæ˜¾ç¤ºä¼ªè£…ç²¾çµå›¾
        const playerSpriteUrl = p.displaySpriteId 
            ? `https://play.pokemonshowdown.com/sprites/ani-back/${p.displaySpriteId}.gif`
            : p.getSprite(true);
        smartLoadSprite('player-sprite', playerSpriteUrl, playerAnim);
    }
    if (!e.isDynamaxed) {
        // ã€Illusion/Imposterã€‘æ”¯æŒæ˜¾ç¤ºä¼ªè£…ç²¾çµå›¾
        const enemySpriteUrl = e.displaySpriteId 
            ? `https://play.pokemonshowdown.com/sprites/ani/${e.displaySpriteId}.gif`
            : e.getSprite(false);
        smartLoadSprite('enemy-sprite', enemySpriteUrl, enemyAnim);
    }
    const playerSpriteEl = document.getElementById('player-sprite');
    if (playerSpriteEl) {
        playerSpriteEl.classList.toggle('mega-player', !!p.isMega);
        playerSpriteEl.classList.toggle('mega-enemy', false);
        // æå·¨åŒ–çŠ¶æ€
        playerSpriteEl.classList.toggle('state-dynamax', !!p.isDynamaxed);
        // ã€ä¿®å¤ã€‘å¤ªæ™¶åŒ–çŠ¶æ€å’Œå±æ€§é¢œè‰²ç±»ç®¡ç†
        playerSpriteEl.classList.toggle('state-terastal', !!p.isTerastallized);
        // æ¸…é™¤æ‰€æœ‰å¤ªæ™¶å±æ€§é¢œè‰²ç±»
        const allTeraTypes = ['normal', 'fire', 'water', 'electric', 'grass', 'ice', 'fighting', 'poison', 'ground', 'flying', 'psychic', 'bug', 'rock', 'ghost', 'dragon', 'dark', 'steel', 'fairy', 'stellar'];
        allTeraTypes.forEach(type => playerSpriteEl.classList.remove(`tera-type-${type}`));
        // å¦‚æœå¤ªæ™¶åŒ–ï¼Œæ·»åŠ å¯¹åº”å±æ€§é¢œè‰²ç±»
        if (p.isTerastallized && p.teraType) {
            playerSpriteEl.classList.add(`tera-type-${p.teraType.toLowerCase()}`);
        }
        // æ¸…é™¤éå®˜æ–¹ Mega æ•ˆæœï¼ˆå¦‚æœå½“å‰å®å¯æ¢¦ä¸æ˜¯éå®˜æ–¹ Megaï¼‰
        if (!p.isUnofficialMega) {
            playerSpriteEl.classList.remove('unofficial-mega');
        }
        // ç¾ç»Šå…±é¸£çŠ¶æ€ï¼šåªæœ‰å½“å‰å®å¯æ¢¦æœ‰ hasBondResonance æ ‡è®°æ—¶æ‰ä¿ç•™æ ·å¼
        if (p.hasBondResonance) {
            playerSpriteEl.classList.add('bond-resonance');
            playerSpriteEl.style.filter = 'drop-shadow(0 0 12px gold) brightness(1.1) saturate(1.15)';
        } else {
            playerSpriteEl.classList.remove('bond-resonance');
            // æ¸…é™¤å¯èƒ½æ®‹ç•™çš„ filter æ ·å¼
            if (playerSpriteEl.style.filter && playerSpriteEl.style.filter.includes('gold')) {
                playerSpriteEl.style.filter = '';
            }
        }
    }
    const enemySpriteEl = document.getElementById('enemy-sprite');
    if (enemySpriteEl) {
        enemySpriteEl.classList.toggle('mega-enemy', !!e.isMega);
        enemySpriteEl.classList.toggle('mega-player', false);
        // æå·¨åŒ–çŠ¶æ€
        enemySpriteEl.classList.toggle('state-dynamax', !!e.isDynamaxed);
        // ã€ä¿®å¤ã€‘å¤ªæ™¶åŒ–çŠ¶æ€å’Œå±æ€§é¢œè‰²ç±»ç®¡ç†
        enemySpriteEl.classList.toggle('state-terastal', !!e.isTerastallized);
        // æ¸…é™¤æ‰€æœ‰å¤ªæ™¶å±æ€§é¢œè‰²ç±»
        const allTeraTypes = ['normal', 'fire', 'water', 'electric', 'grass', 'ice', 'fighting', 'poison', 'ground', 'flying', 'psychic', 'bug', 'rock', 'ghost', 'dragon', 'dark', 'steel', 'fairy', 'stellar'];
        allTeraTypes.forEach(type => enemySpriteEl.classList.remove(`tera-type-${type}`));
        // å¦‚æœå¤ªæ™¶åŒ–ï¼Œæ·»åŠ å¯¹åº”å±æ€§é¢œè‰²ç±»
        if (e.isTerastallized && e.teraType) {
            enemySpriteEl.classList.add(`tera-type-${e.teraType.toLowerCase()}`);
        }
        // æ¸…é™¤éå®˜æ–¹ Mega æ•ˆæœï¼ˆå¦‚æœå½“å‰å®å¯æ¢¦ä¸æ˜¯éå®˜æ–¹ Megaï¼‰
        if (!e.isUnofficialMega) {
            enemySpriteEl.classList.remove('unofficial-mega');
        }
        // ã€ä¿®å¤ã€‘ç¾ç»Šå…±é¸£çŠ¶æ€ï¼šåªæœ‰å½“å‰å®å¯æ¢¦æœ‰ hasBondResonance æ ‡è®°æ—¶æ‰ä¿ç•™æ ·å¼
        if (e.hasBondResonance) {
            enemySpriteEl.classList.add('bond-resonance');
            enemySpriteEl.style.filter = 'drop-shadow(0 0 12px gold) brightness(1.1) saturate(1.15)';
        } else {
            enemySpriteEl.classList.remove('bond-resonance');
            // æ¸…é™¤å¯èƒ½æ®‹ç•™çš„ filter æ ·å¼
            if (enemySpriteEl.style.filter && enemySpriteEl.style.filter.includes('gold')) {
                enemySpriteEl.style.filter = '';
            }
        }
    }
    // 4. é˜Ÿä¼çŠ¶æ€çƒ
    renderDots('ui-player-dots', battle.playerParty, battle.playerActive);
    renderDots('ui-enemy-dots', battle.enemyParty, battle.enemyActive);
    updateTrainerHud();
    // 5. æŒ‰é’®åŒº
    document.getElementById('switch-menu-layer').classList.add('hidden');
    if (p.currHp <= 0) {
        // æ­»äº¡çŠ¶æ€ï¼Œç­‰å¾…å¼ºåˆ¶æ¢äºº
    } else {
        // æ¸²æŸ“æŠ€èƒ½æŒ‰é’®ï¼ˆæ”¯æŒ 4 æŠ€ï¼‰
        const btnIds = ['btn-m0', 'btn-m1', 'btn-m2', 'btn-m3'];
        btnIds.forEach((id, i) => {
            const btn = document.getElementById(id);
            if (!btn) return;
            // é‡ç½®æ‰€æœ‰ç‰¹æ®Šæ ·å¼
            btn.className = 'action-btn';
            btn.style.opacity = '1';
            if (i < p.moves.length) {
                const m = p.moves[i];
                // =========================================================
                // Z-Move / Max Move è‡ªåŠ¨æ¨å¯¼ç³»ç»Ÿ
                // åŸºäº mechanic å­—æ®µå’Œæ•°æ®åº“è‡ªåŠ¨åˆ¤æ–­æ‹›å¼å˜æ¢
                // =========================================================
                const mId = (m.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                const mData = (typeof MOVES !== 'undefined' && MOVES[mId]) ? MOVES[mId] : {};
                // ä½¿ç”¨æ–°çš„è‡ªåŠ¨æ¨å¯¼å‡½æ•°
                const zTarget = getZMoveTarget(m, p);  // è¿”å› { name, type, power } æˆ– null
                const maxTarget = p.isDynamaxed ? getMaxMoveTarget(m, p) : null; // åªæœ‰æå·¨åŒ–çŠ¶æ€æ‰æ¨å¯¼
                // åˆ¤æ–­å½“å‰æ‹›å¼åº”è¯¥æ˜¾ç¤ºä»€ä¹ˆæ ·å¼
                const showZStyle = zTarget && !battle.playerZUsed;
                const showMaxStyle = maxTarget !== null;
                // ç¦ç”¨é€»è¾‘
                let isDisabled = false;
                if (showZStyle && battle.playerZUsed) isDisabled = true;
                // ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥å®šèº«æ³•/è¯…å’’ä¹‹èº¯å°å°
                if (p.volatile && p.volatile.disable > 0 && p.volatile.disabledMove) {
                    if (m.name === p.volatile.disabledMove) {
                        isDisabled = true;
                        console.log(`[DISABLE UI] ${m.name} è¢«å°å°ï¼ŒæŒ‰é’®ç¦ç”¨`);
                    }
                }
                // ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥æ€¨æ¨å°å° (Grudge)
                if (p.volatile && p.volatile.grudgeSealed && p.volatile.grudgeSealed.includes(m.name)) {
                    isDisabled = true;
                    console.log(`[GRUDGE UI] ${m.name} è¢«æ€¨æ¨å°å°ï¼ŒæŒ‰é’®ç¦ç”¨`);
                }
                // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘æ£€æŸ¥æŠ€èƒ½æ˜¯å¦è¢«ç¯å¢ƒç¦ç”¨
                let envBanned = false;
                if (typeof window.envOverlay !== 'undefined' && window.envOverlay.isMoveBanned) {
                    if (window.envOverlay.isMoveBanned(p, m)) {
                        isDisabled = true;
                        envBanned = true;
                        console.log(`[ENV BAN UI] ${m.name} è¢«ç¯å¢ƒç¦ç”¨ï¼ŒæŒ‰é’®å˜ç°`);
                    }
                }
                // è·å–æ˜¾ç¤ºåç§°å’Œç±»å‹
                let displayName = m.cn || m.name;
                let displayType = m.type || 'Normal';
                if (showZStyle) {
                    // Z æ‹›å¼æ ·å¼
                    displayName = (window.Locale) ? window.Locale.get(zTarget.name) : zTarget.name;
                    displayType = zTarget.type;
                } else if (showMaxStyle) {
                    // Max æ‹›å¼æ ·å¼
                    displayName = (window.Locale) ? window.Locale.get(maxTarget.name) : maxTarget.name;
                    displayType = maxTarget.type;
                }
                // =========================================================
                // ã€å¿ƒçœ¼ç³»ç»Ÿã€‘å±æ€§å…‹åˆ¶æç¤º (enable_insight)
                // æ˜¾ç¤º â–²(æ•ˆæœç»ä½³) / â–¼(æ•ˆæœä¸å¥½) / Ã—(æ— æ•ˆ)
                // =========================================================
                let insightHint = '';
                const insightUnlocked = battle.playerUnlocks && battle.playerUnlocks.enable_insight !== false;
                if (insightUnlocked && e && e.types) {
                    const moveType = displayType || m.type || 'Normal';
                    const eff = window.getTypeEffectiveness ? 
                        window.getTypeEffectiveness(moveType, e.types) : 1;
                    if (eff === 0) {
                        insightHint = '<span class="insight-hint insight-immune" title="æ— æ•ˆ">Ã—</span>';
                    } else if (eff >= 2) {
                        insightHint = '<span class="insight-hint insight-super" title="æ•ˆæœç»ä½³">â–²</span>';
                    } else if (eff <= 0.5) {
                        insightHint = '<span class="insight-hint insight-resist" title="æ•ˆæœä¸å¥½">â–¼</span>';
                    }
                }
                // è·å–å±æ€§å¯¹åº”çš„SVGå›¾æ ‡è·¯å¾„å’Œç±»å‹åç§°
                const typeKey = (displayType || 'normal').toLowerCase();
                const typeSvgPath = `./data/svg/${typeKey}.svg`;
                const typeNameEN = displayType; // ç›´æ¥ä½¿ç”¨è‹±æ–‡å±æ€§å
                // è®¾ç½® data-type å±æ€§ç”¨äºCSSå˜é‡
                btn.setAttribute('data-type', typeKey);
                if (showZStyle || showMaxStyle) {
                    // åº”ç”¨ç‰¹æ®Šæ ·å¼
                    if (showZStyle) {
                        btn.classList.add('z-move-btn');
                    } else {
                        btn.classList.add('max-move-btn');
                    }
                    if (isDisabled) {
                        btn.classList.add('z-move-used');
                    }
                    const labelText = showZStyle ? 'Z' : '';
                    btn.innerHTML = `
                        <div class="deco-bar"></div>
                        <div class="content-unskew">
                            <div class="z-badge-icon">${labelText}</div>
                            <div class="icon-circle">
                                <img src="${typeSvgPath}" alt="${typeKey}">
                            </div>
                            <div class="text-group">
                                <span class="move-name">${displayName}${insightHint}</span>
                                <span class="move-type-name">${typeNameEN.toUpperCase()}</span>
                            </div>
                            <div class="bg-watermark">
                                <img src="${typeSvgPath}">
                            </div>
                        </div>
                    `;
                } else {
                    // æ™®é€šæŠ€èƒ½
                    btn.innerHTML = `
                        <div class="deco-bar"></div>
                        <div class="content-unskew">
                            <div class="icon-circle">
                                <img src="${typeSvgPath}" alt="${typeKey}">
                            </div>
                            <div class="text-group">
                                <span class="move-name">${displayName}${insightHint}</span>
                                <span class="move-type-name">${typeNameEN.toUpperCase()}</span>
                            </div>
                            <div class="bg-watermark">
                                <img src="${typeSvgPath}">
                            </div>
                        </div>
                    `;
                }
                // äº¤äº’äº‹ä»¶
                if (isDisabled) {
                    btn.disabled = true;
                    btn.onclick = null;
                } else {
                    btn.disabled = false;
                    // å¦‚æœæ˜¯ Z æ‹›å¼æ¨¡å¼ï¼Œä¼ é€’ useZ æ ‡è®°å’Œæ¨å¯¼ç»“æœ
                    if (showZStyle) {
                        btn.onclick = () => handleAttack(i, { useZ: true, zTarget: zTarget });
                    } else {
                        btn.onclick = () => handleAttack(i);
                    }
                }
                btn.style.visibility = 'visible';
            } else {
                btn.disabled = true;
                btn.style.visibility = 'hidden';
                btn.innerHTML = '<span class="move-name">---</span><span class="move-type">---</span>';
            }
        });
        // ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æŠ€èƒ½éƒ½è¢«ç¦ç”¨ï¼Œå¦‚æœæ˜¯åˆ™å¯ç”¨"æŒ£æ‰"
        const allBtns = btnIds.map(id => document.getElementById(id)).filter(b => b);
        const allDisabled = allBtns.every(btn => btn.disabled || btn.style.visibility === 'hidden');
        if (allDisabled && p.moves.length > 0) {
            // å¯ç”¨ç¬¬ä¸€ä¸ªæŒ‰é’®ä½œä¸º"æŒ£æ‰"
            const struggleBtn = allBtns[0];
            if (struggleBtn) {
                struggleBtn.disabled = false;
                struggleBtn.style.visibility = 'visible';
                struggleBtn.style.opacity = '0.7';
                struggleBtn.setAttribute('data-type', 'normal');
                struggleBtn.innerHTML = `
                    <div class="deco-bar"></div>
                    <div class="content-unskew">
                        <div class="icon-circle">
                            <img src="./data/svg/normal.svg" alt="normal">
                        </div>
                        <div class="text-group">
                            <span class="move-name" style="color:#ef4444">æŒ£æ‰</span>
                            <span class="move-type-name">NORMAL</span>
                        </div>
                        <div class="bg-watermark">
                            <img src="./data/svg/normal.svg">
                        </div>
                    </div>
                `;
                struggleBtn.onclick = () => handleStruggle();
                console.log('[ENV BAN] æ‰€æœ‰æŠ€èƒ½è¢«ç¦ç”¨ï¼Œå¯ç”¨æŒ£æ‰');
            }
        }
    }
    // 6. æ›´æ–°è¿›åŒ–æŒ‰é’®å¯è§æ€§
    if (typeof updateEvolutionButtonVisuals === 'function') {
        updateEvolutionButtonVisuals();
    }
    // 7. ã€å¯¹å†²ç³»ç»Ÿã€‘æ›´æ–° Insight Bar
    if (typeof window.updateInsightBar === 'function' && window.GAME_SETTINGS?.enableClash !== false) {
        window.updateInsightBar(p);
        // å¦‚æœç©å®¶æœ‰ Insight AVsï¼Œæ˜¾ç¤º Insight Bar
        const insightBar = document.getElementById('insight-bar');
        if (insightBar) {
            const hasInsight = p.isAce && p.avs && (p.avs.insight > 0 || (typeof p.getEffectiveAVs === 'function' && p.getEffectiveAVs('insight') > 0));
            insightBar.classList.toggle('active', hasInsight);
        }
    }
}
// ============================================
// ã€å·²è¿ç§»ã€‘ç²¾çµå›¾åŠ è½½ -> ui/ui-sprites.js
// ã€å·²è¿ç§»ã€‘è¡€æ¡/ç²¾çµçƒæ§½æ¸²æŸ“ -> ui/ui-renderer.js
// ============================================
/**
 * å¤„ç†"æŒ£æ‰"æŠ€èƒ½ï¼ˆå½“æ‰€æœ‰æŠ€èƒ½è¢«ç¦ç”¨æ—¶ï¼‰
 */
async function handleStruggle() {
    if (typeof window.playSFX === 'function') window.playSFX('CONFIRM');
    if (battle.locked) return;
    battle.locked = true;
    showMainMenu();
    const p = battle.getPlayer();
    const e = battle.getEnemy();
    // æŒ£æ‰æŠ€èƒ½æ•°æ®
    const struggleMove = { 
        name: 'Struggle', 
        cn: 'æŒ£æ‰', 
        power: 50, 
        type: 'Normal', 
        cat: 'phys',
        accuracy: 100,
        flags: { contact: 1 }
    };
    log(`<span style="color:#ef4444">ğŸŒ ${p.cnName} è¢«ç¯å¢ƒå‹åˆ¶ï¼Œæ— æŠ€å¯ç”¨ï¼Œåªèƒ½æŒ£æ‰!</span>`);
    // æ‰§è¡ŒæŒ£æ‰æ”»å‡»
    if (typeof window.executePlayerTurn === 'function') {
        await window.executePlayerTurn(p, e, struggleMove);
    }
    // æŒ£æ‰åä¼¤ï¼šæ‰£é™¤è‡ªèº« 1/4 æœ€å¤§ HP
    const recoil = Math.floor(p.maxHp / 4);
    p.takeDamage(recoil);
    log(`<span style="color:#e74c3c">${p.cnName} å› æŒ£æ‰å—åˆ°äº† ${recoil} ç‚¹åä½œç”¨åŠ›ä¼¤å®³!</span>`);
    updateAllVisuals();
    // æ£€æŸ¥æˆ˜æ–—ç»“æŸ
    if (battle.checkBattleEnd()) {
        battle.locked = false;
        return;
    }
    // AI å›åˆ
    if (typeof window.handleAITurn === 'function') {
        await window.handleAITurn();
    }
    // å›åˆç»“æŸé˜¶æ®µ
    if (typeof window.executeEndPhase === 'function') {
        await window.executeEndPhase();
    }
    battle.locked = false;
    showMovesMenu();
}
/**
 * æ ¸å¿ƒé€»è¾‘ï¼šå‘èµ·æ”»å‡»å¤„ç† (æ”¯æŒå…ˆåˆ¶æŠ€ä¼˜å…ˆçº§)
 * @param {number} moveIndex æ‹›å¼ç´¢å¼•
 * @param {object} options å¯é€‰å‚æ•° { useZ: boolean, zConfig: object }
 */
async function handleAttack(moveIndex, options = {}) {
    if (typeof window.playSFX === 'function') window.playSFX('CONFIRM');
    if (battle.locked) return;
    battle.locked = true;
    // ã€ç»Ÿä¸€å›åˆå¼€å§‹å¤„ç†ã€‘è°ƒç”¨ battle-turns.js ä¸­çš„ onTurnStart
    if (typeof window.onTurnStart === 'function') {
        window.onTurnStart();
    }
    // ã€Commander Systemã€‘è§¦å‘å·²è£…å¡«çš„æŒ‡ä»¤
    if (typeof window.triggerArmedCommand === 'function') {
        window.triggerArmedCommand();
    }
    // ã€Evolution Systemã€‘è§¦å‘å·²è£…å¡«çš„è¿›åŒ–
    const evoArmedThisTurn = battle.evoArmed;
    if (evoArmedThisTurn) {
        battle.evoArmed = null; // æ¸…é™¤è£…å¡«çŠ¶æ€
    }
    // ä¿å­˜ Mega é¢„å¤‡çŠ¶æ€ï¼ˆåœ¨ showMainMenu é‡ç½®ä¹‹å‰ï¼‰
    const megaArmedThisTurn = battle.playerMegaArmed;
    // æ”»å‡»åè¿”å›ä¸»èœå•
    showMainMenu();
    let p = battle.getPlayer();  // ä½¿ç”¨ letï¼Œå› ä¸º pivot æ¢äººæ—¶éœ€è¦æ›´æ–°å¼•ç”¨
    let e = battle.getEnemy();   // ä½¿ç”¨ letï¼Œå› ä¸º AI æ¢äººæ—¶éœ€è¦æ›´æ–°å¼•ç”¨
    let playerMove = p.moves[moveIndex];
    // === ã€ä¿®å¤ã€‘æ£€æŸ¥ Taunt ç­‰ Volatile çŠ¶æ€æ˜¯å¦é˜»æ­¢ä½¿ç”¨è¯¥æŠ€èƒ½ ===
    if (typeof MoveEffects !== 'undefined' && MoveEffects.canUseMove) {
        const canUseResult = MoveEffects.canUseMove(p, playerMove);
        if (!canUseResult.canUse) {
            log(`<span style="color:#e74c3c">${canUseResult.reason}</span>`);
            battle.locked = false;
            return;
        }
    }
    // === ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘æ£€æŸ¥æŠ€èƒ½æ˜¯å¦è¢«ç¯å¢ƒç¦ç”¨ ===
    if (typeof window.envOverlay !== 'undefined' && window.envOverlay.isMoveBanned) {
        if (window.envOverlay.isMoveBanned(p, playerMove)) {
            log(`<span style="color:#a855f7">ğŸŒ ${playerMove.cn || playerMove.name} åœ¨å½“å‰ç¯å¢ƒä¸‹æ— æ³•ä½¿ç”¨ï¼</span>`);
            battle.locked = false;
            return;
        }
    }
    // =========================================================
    // ã€BUGä¿®å¤ã€‘Choice é“å…·é”æ‹›å¼ºåˆ¶æ£€æŸ¥
    // å¦‚æœç©å®¶æŒæœ‰ Choice é“å…·ä¸”å·²é”å®šæŠ€èƒ½ï¼Œå¿…é¡»ä½¿ç”¨é”å®šçš„æŠ€èƒ½
    // å¦‚æœå°šæœªé”å®šï¼Œåˆ™åœ¨æ­¤å¤„é”å®šï¼ˆåœ¨å¯¹å†²é€»è¾‘ä¹‹å‰ï¼‰
    // =========================================================
    const pItem = p.item || '';
    const pIsChoiceItem = pItem.includes('Choice') || pItem.includes('è®²ç©¶');
    if (pIsChoiceItem) {
        if (p.choiceLockedMove) {
            // å·²é”å®šï¼šå¼ºåˆ¶ä½¿ç”¨é”å®šçš„æŠ€èƒ½
            const lockedMoveObj = p.moves.find(m => m.name === p.choiceLockedMove);
            if (lockedMoveObj && playerMove.name !== p.choiceLockedMove) {
                console.log(`[CHOICE ENFORCE] ç©å®¶è¯•å›¾ä½¿ç”¨ ${playerMove.name}ï¼Œä½†è¢« ${pItem} é”å®šåœ¨ ${p.choiceLockedMove}`);
                log(`<span style="color:#e74c3c">${p.cnName} è¢« ${pItem} é”å®šï¼Œåªèƒ½ä½¿ç”¨ ${lockedMoveObj.cn || p.choiceLockedMove}ï¼</span>`);
                playerMove = lockedMoveObj;
            }
        } else {
            // å°šæœªé”å®šï¼šåœ¨é€‰æ‹©æ‹›å¼æ—¶ç«‹å³é”å®šï¼ˆä¸ç®¡å¯¹å†²ç»“æœå¦‚ä½•ï¼‰
            p.choiceLockedMove = playerMove.name;
            console.log(`[CHOICE LOCK] ${p.name} è¢« ${pItem} é”å®šåœ¨ ${playerMove.name}`);
        }
    }
    // =========================================================
    // Z-Move è½¬æ¢é€»è¾‘ï¼šä½¿ç”¨è‡ªåŠ¨æ¨å¯¼ç³»ç»Ÿ
    // ã€äº’æ–¥æ£€æŸ¥ã€‘Mega/æå·¨åŒ–çŠ¶æ€ä¸‹ç¦æ­¢ä½¿ç”¨ Z æ‹›å¼
    // ã€Ultra Burstã€‘æ—¥/æœˆéª¡å­ä½¿ç”¨ Z æ‹›å¼æ—¶å…ˆè§¦å‘ Ultra Burst
    // =========================================================
    if (options.useZ && options.zTarget && !battle.playerZUsed) {
        // ã€å®‰å…¨æ£€æŸ¥ã€‘å¦‚æœå·²ç» Mega æˆ–æå·¨åŒ–ï¼Œç¦æ­¢ä½¿ç”¨ Z æ‹›å¼
        if (p.isMega || p.isDynamaxed || p.hasBondResonance) {
            console.warn(`[CHEAT BLOCK] è¯•å›¾åœ¨ Mega/æå·¨åŒ– çŠ¶æ€ä¸‹ä½¿ç”¨ Z æ‹›å¼ï¼å·²å¼ºåˆ¶æ‹¦æˆªã€‚`);
            log(`<b style="color:#aaa">...ä½†åœ¨ç›®å‰çš„å½¢æ€ä¸‹æ— æ³•å¼•å‡º Z åŠ›é‡ï¼</b>`);
            // ä¸è½¬æ¢ï¼Œä½¿ç”¨åŸå§‹æ‹›å¼
        } else {
            // =========================================================
            // ã€Ultra Burstã€‘æ—¥/æœˆéª¡å­ â†’ ç©¶æå¥ˆå…‹æ´›å…¹ç›
            // ä½¿ç”¨ä¸“å± Z æ‹›å¼ "Light That Burns the Sky" æ—¶è§¦å‘
            // =========================================================
            if (typeof canUltraBurst === 'function' && canUltraBurst(p)) {
                const burstResult = executeUltraBurst(p);
                if (burstResult.success) {
                    burstResult.logs.forEach(msg => log(msg));
                    updateAllVisuals('player');
                    await wait(800);
                    // æ›´æ–°å¼•ç”¨ï¼ˆå˜èº«åå±æ€§å¯èƒ½æ”¹å˜ï¼‰
                    p = battle.getPlayer();
                }
            }
            const zTarget = options.zTarget;
            const zMoveId = zTarget.name.toLowerCase().replace(/[^a-z0-9]/g, '');
            const zMoveData = (typeof MOVES !== 'undefined' && MOVES[zMoveId]) ? MOVES[zMoveId] : {};
            // ä½¿ç”¨è‡ªåŠ¨æ¨å¯¼çš„ Z æ‹›å¼æ•°æ®
            playerMove = {
                name: zTarget.name,
                cn: zMoveData.cn || zTarget.name,
                type: zTarget.type || playerMove.type || 'Normal',
                power: zTarget.power || 180,
                basePower: zTarget.power || 180,
                accuracy: 100,
                pp: 1,
                isZ: true,
                priority: zMoveData.priority || 0,
                cat: zMoveData.category === 'Physical' ? 'phys' : 'spec',
                category: zMoveData.category || 'Special'
            };
            // === ã€Ambrosia æ—¶ç©ºé†‰ã€‘æ ‡è®°ä¸‹å›åˆæ··ä¹± ===
            if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.checkNeuroBacklash) {
                const currentWeather = battle?.weather || '';
                const neuroResult = window.WeatherEffects.checkNeuroBacklash(currentWeather, 'zmove', p, null);
                if (neuroResult.shouldTrigger) {
                    p.volatile = p.volatile || {};
                    p.volatile.neuroBacklash = true;
                    console.log(`[AMBROSIA] âš¡ æ—¶ç©ºé†‰ï¼š${p.name} ä½¿ç”¨Zæ‹›å¼åè¢«æ ‡è®°ï¼Œä¸‹å›åˆå°†æ··ä¹±`);
                    log(neuroResult.message);
                }
            }
            console.log(`[Z-MOVE] è‡ªåŠ¨æ¨å¯¼ Z æ‹›å¼: ${playerMove.name} (å¨åŠ›: ${playerMove.power})`);
        }
    }
    // =========================================================
    // ã€å¤æ­¦ç³»ç»Ÿ v2.1ã€‘åˆšçŒ›/è¿…ç–¾ é£æ ¼ä¿®æ­£ (enable_styles)
    // åŠ¨æ€è°ƒæ•´ï¼šæ ¹æ®é€Ÿåº¦ä¼˜åŠ¿å†³å®šæƒ©ç½šç¨‹åº¦
    // è¿…ç–¾ (Agile): é€Ÿåº¦å¿«æ—¶0.75x(ä¿å…ˆæ‰‹)ï¼Œé€Ÿåº¦æ…¢æ—¶0.5x(æŠ¢èŠ‚å¥)
    // åˆšçŒ› (Strong): é€Ÿåº¦å¿«æ—¶å¿…ä¸­(å–å…ˆæ‰‹)ï¼Œé€Ÿåº¦æ…¢æ—¶å‘½ä¸­0.8x(ç™½å«–)
    // ã€å¹³è¡¡æ€§æ”¹åŠ¨ã€‘ä½¿ç”¨åè¿›å…¥ 1 å›åˆå†·å´
    // =========================================================
    // ä»å…¨å±€å˜é‡è¯»å–å½“å‰é£æ ¼
    let currentMoveStyle = window.currentMoveStyle || 'normal';
    console.log(`[STYLES] å½“å‰é£æ ¼: ${currentMoveStyle}`);
    if (currentMoveStyle !== 'normal' && battle.playerUnlocks?.enable_styles) {
        // ã€Chronal Rift æ´—ç¿ æ— æ³•ã€‘æ£€æŸ¥æ˜¯å¦åœ¨æ—¶ç©ºè£‚éš™ä¸­
        let isUnboundArts = false;
        let unboundModifier = null;
        if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.getUnboundArtsModifier) {
            const weather = battle?.weather || battle?.environmentWeather || '';
            unboundModifier = window.WeatherEffects.getUnboundArtsModifier(weather, currentMoveStyle, p, e);
            isUnboundArts = unboundModifier.active;
        }
        // ã€å†·å´æ£€æŸ¥ã€‘å¦‚æœåœ¨å†·å´ä¸­ä¸”ä¸æ˜¯æ´—ç¿ æ— æ³•ï¼Œå¼ºåˆ¶ä½¿ç”¨æ™®é€šé£æ ¼
        if (battle.playerStyleCooldown > 0 && !isUnboundArts) {
            log(`<span style="color:#aaa">é£æ ¼ç³»ç»Ÿå†·å´ä¸­ï¼Œæœ¬å›åˆåªèƒ½ä½¿ç”¨æ™®é€šé£æ ¼</span>`);
            currentMoveStyle = 'normal';
        } else {
            const originalPower = playerMove.basePower || playerMove.power || 0;
            const originalPriority = playerMove.priority || 0;
            const originalAccuracy = playerMove.accuracy;
            const isStatus = (playerMove.category === 'Status' || playerMove.cat === 'status' || originalPower === 0);
            // ã€v2.1ã€‘è®¡ç®—æœ‰æ•ˆé€Ÿåº¦ï¼Œåˆ¤æ–­é€Ÿåº¦ä¼˜åŠ¿
            let mySpe = (typeof p.getStat === 'function') ? p.getStat('spe') : (p.spe || 100);
            let enemySpe = (typeof e.getStat === 'function') ? e.getStat('spe') : (e.spe || 100);
            // éº»ç—¹å‡é€Ÿ
            if (p.status === 'par') mySpe = Math.floor(mySpe * 0.5);
            if (e.status === 'par') enemySpe = Math.floor(enemySpe * 0.5);
            // æˆæ³•ç©ºé—´åˆ¤å®š
            const isTrickRoom = battle.field && battle.field.trickRoom > 0;
            let haveSpeedAdvantage = false;
            if (isTrickRoom) {
                haveSpeedAdvantage = mySpe < enemySpe; // ç©ºé—´ä¸‹ï¼šæ…¢å°±æ˜¯å¿«
            } else {
                haveSpeedAdvantage = mySpe > enemySpe; // æ­£å¸¸ï¼šå¿«å°±æ˜¯å¿«
            }
            // ============================================
            // ã€Chronal Rift æ´—ç¿ æ— æ³•ã€‘æ—¶ç©ºè£‚éš™ä¸­çš„å¤æ­¦è§„åˆ™
            // ============================================
            if (isUnboundArts && unboundModifier) {
                playerMove = { ...playerMove };
                playerMove.styleUsed = currentMoveStyle;
                if (currentMoveStyle === 'agile') {
                    // è¿…ç–¾ãƒ»ç¬èº«æ¨¡å¼ï¼šä¼˜å…ˆåº¦+1ï¼Œé€Ÿåº¦å¿«æ— æŸ/é€Ÿåº¦æ…¢å¨åŠ›x0.9
                    playerMove.priority = originalPriority + unboundModifier.priorityMod;
                    playerMove.basePower = Math.floor(originalPower * unboundModifier.damageMultiplier);
                    playerMove.power = playerMove.basePower;
                    log(unboundModifier.message);
                    console.log(`[CHRONAL RIFT] æ´—ç¿ æ— æ³•ãƒ»è¿…ç–¾: priority +${unboundModifier.priorityMod}, power x${unboundModifier.damageMultiplier}`);
                } else if (currentMoveStyle === 'strong') {
                    // åˆšçŒ›ãƒ»ç ´åç¥æ¨¡å¼ï¼šä¼¤å®³x1.5ï¼Œå‘½ä¸­x0.85ï¼Œä¼˜å…ˆåº¦-1
                    playerMove.priority = originalPriority + unboundModifier.priorityMod;
                    playerMove.basePower = Math.floor(originalPower * unboundModifier.damageMultiplier);
                    playerMove.power = playerMove.basePower;
                    playerMove.breaksProtect = true;
                    const oldAcc = (typeof originalAccuracy === 'number') ? originalAccuracy : 100;
                    // å¿…ä¸­æŠ€æ— è§†å‘½ä¸­æƒ©ç½š
                    if (originalAccuracy !== true && oldAcc < 101) {
                        playerMove.accuracy = Math.floor(oldAcc * unboundModifier.accuracyMultiplier);
                    }
                    log(unboundModifier.message);
                    console.log(`[CHRONAL RIFT] æ´—ç¿ æ— æ³•ãƒ»åˆšçŒ›: power x${unboundModifier.damageMultiplier}, acc x${unboundModifier.accuracyMultiplier}`);
                }
                // æ´—ç¿ æ— æ³•æ— å†·å´
            }
            // ============================================
            // âš¡ è¿…ç–¾é£æ ¼ (Agile Style) - æ™®é€šæ¨¡å¼
            // ============================================
            else if (currentMoveStyle === 'agile') {
                // ã€å¹³è¡¡æ€§æ”¹åŠ¨ã€‘å˜åŒ–æŠ€ç¦æ­¢ä½¿ç”¨è¿…ç–¾
                if (isStatus) {
                    log(`<span style="color:#aaa">å˜åŒ–ç±»æ‹›å¼æ— æ³•ä½¿ç”¨è¿…ç–¾é£æ ¼ï¼(è‡ªåŠ¨åˆ‡æ¢å›æ™®é€š)</span>`);
                    currentMoveStyle = 'normal';
                } else {
                    playerMove = { ...playerMove };
                    playerMove.priority = originalPriority + 1;
                    playerMove.styleUsed = 'agile';
                    const oldAcc = (typeof originalAccuracy === 'number') ? originalAccuracy : 100;
                    if (haveSpeedAdvantage) {
                        // åœºæ™¯ A: æ‹¥æœ‰é€Ÿåº¦ä¼˜åŠ¿ - ä¹°ä¿é™©æ±‚ç¨³ï¼Œé˜²å…ˆåˆ¶
                        playerMove.basePower = Math.floor(originalPower * 0.75);
                        playerMove.accuracy = Math.floor(oldAcc * 0.9); // å‘½ä¸­ç‡ 0.9x
                        log(`<span style="color:#3b82f6">âš¡ è¿…ç–¾Â·åˆ¶å˜ï¼šé€Ÿåº¦å‹åˆ¶ä¸‹ç¡®ä¿å…ˆæ‰‹ - å¨åŠ›Ã—0.75ï¼Œå‘½ä¸­Ã—0.9</span>`);
                        console.log(`[STYLES] è¿…ç–¾(å¿«): power 0.75x, acc 0.9x (${mySpe} vs ${enemySpe})`);
                    } else {
                        // åœºæ™¯ B: æ²¡æœ‰é€Ÿåº¦ä¼˜åŠ¿ - ç»åœ°åå‡»ï¼Œå·å›åˆ
                        playerMove.basePower = Math.floor(originalPower * 0.50);
                        playerMove.accuracy = Math.floor(oldAcc * 0.85); // å‘½ä¸­ç‡ 0.85x
                        log(`<span style="color:#60a5fa">âš¡ è¿…ç–¾Â·ç¥é€Ÿï¼šé€†è½¬è¡ŒåŠ¨é¡ºä½ - å¨åŠ›Ã—0.50ï¼Œå‘½ä¸­Ã—0.85</span>`);
                        console.log(`[STYLES] è¿…ç–¾(æ…¢): power 0.5x, acc 0.85x (${mySpe} vs ${enemySpe})`);
                    }
                    playerMove.power = playerMove.basePower;
                    // ã€å†·å´ v3ã€‘åŸºäºç†Ÿç»ƒåº¦çš„åŠ¨æ€å†·å´
                    const proficiency = battle.trainerProficiency ?? 0;
                    const styleCooldown = getStyleCooldown(proficiency);
                    battle.playerStyleCooldown = styleCooldown;
                    if (styleCooldown > 0) {
                        console.log(`[STYLES v3] è¿›å…¥ä¼‘æ†©: ${styleCooldown}å›åˆ (ç†Ÿç»ƒåº¦: ${proficiency})`);
                    } else {
                        console.log(`[STYLES v3] æ°”è„‰è´¯é€šï¼Œæ— éœ€ä¼‘æ†© (ç†Ÿç»ƒåº¦: ${proficiency})`);
                    }
                }
            } 
            // ============================================
            // ğŸ’ª åˆšçŒ›é£æ ¼ (Strong Style) - æ™®é€šæ¨¡å¼
            // ============================================
            else if (currentMoveStyle === 'strong') {
                playerMove = { ...playerMove };
                playerMove.priority = originalPriority - 1;
                playerMove.basePower = Math.floor(originalPower * 1.30);
                playerMove.power = playerMove.basePower;
                playerMove.breaksProtect = true; // å¯ç©¿é€å®ˆä½
                playerMove.styleUsed = 'strong';
                if (!haveSpeedAdvantage) {
                    // åœºæ™¯ A: é€Ÿåº¦åŠ£åŠ¿ (æœ¬æ¥å°±æ…¢) - æ²¡ä»˜å‡ºä»£ä»·ï¼Œé™å‘½ä¸­
                    const oldAcc = (typeof originalAccuracy === 'number') ? originalAccuracy : 100;
                    playerMove.accuracy = Math.floor(oldAcc * 0.8);
                    log(`<span style="color:#ef4444">ğŸ’ª åˆšçŒ›Â·èˆèº«ï¼šé€Ÿåº¦åŠ£åŠ¿ä¸‹çš„å¼ºæ”» - å¨åŠ›Ã—1.3ï¼Œå‘½ä¸­Ã—0.8</span>`);
                    console.log(`[STYLES] åˆšçŒ›(æ…¢): power 1.3x, acc 0.8x (${mySpe} vs ${enemySpe})`);
                } else {
                    // åœºæ™¯ B: é€Ÿåº¦ä¼˜åŠ¿ (æœ¬æ¥è¯¥æˆ‘å…ˆ) - å–å…ˆæ‰‹æ¢ä¼¤å®³ï¼Œä¸ä¿®æ­£å‘½ä¸­
                    // ã€v2.3ã€‘ä¸å†å¿…ä¸­ï¼Œä¿æŒåŸå‘½ä¸­ç‡
                    log(`<span style="color:#b91c1c">ğŸ’ª åˆšçŒ›Â·è“„åŠ›ï¼šæ”¾å¼ƒå…ˆæ‰‹ï¼Œå…¨åŠ›ä¸€å‡»ï¼(å¨åŠ›Ã—1.3ï¼Œè´¯ç©¿å®ˆä½)</span>`);
                    console.log(`[STYLES] åˆšçŒ›(å¿«): power 1.3x, acc unchanged (${mySpe} vs ${enemySpe})`);
                }
                // ã€å†·å´ v3ã€‘åŸºäºç†Ÿç»ƒåº¦çš„åŠ¨æ€å†·å´
                const proficiency = battle.trainerProficiency ?? 0;
                const styleCooldown = getStyleCooldown(proficiency);
                battle.playerStyleCooldown = styleCooldown;
                if (styleCooldown > 0) {
                    console.log(`[STYLES v3] è¿›å…¥ä¼‘æ†©: ${styleCooldown}å›åˆ (ç†Ÿç»ƒåº¦: ${proficiency})`);
                } else {
                    console.log(`[STYLES v3] æ°”è„‰è´¯é€šï¼Œæ— éœ€ä¼‘æ†© (ç†Ÿç»ƒåº¦: ${proficiency})`);
                }
            }
            // ============================================
            // ğŸ¯ å‡ç¥é£æ ¼ (Focus Style) - å¿…ä¸­æ¨¡å¼
            // ç»å¯¹ä¸“æ³¨çš„å¿ƒæµçŠ¶æ€ï¼Œæ‘’å¼ƒæ‚å¿µçš„å¿…ç„¶ä¸€å‡»
            // ä¿®æ­£ï¼šæ‹›å¼è·å¾—ã€å¿…ä¸­ã€‘æ•ˆæœï¼Œå¨åŠ›ä¿æŒ x1.0
            // ============================================
            else if (currentMoveStyle === 'focus') {
                // ã€å¹³è¡¡æ€§æ”¹åŠ¨ã€‘å˜åŒ–æŠ€ç¦æ­¢ä½¿ç”¨å‡ç¥
                if (isStatus) {
                    log(`<span style="color:#aaa">å˜åŒ–ç±»æ‹›å¼æ— æ³•ä½¿ç”¨å‡ç¥é£æ ¼ï¼(è‡ªåŠ¨åˆ‡æ¢å›æ™®é€š)</span>`);
                    currentMoveStyle = 'normal';
                } else {
                    playerMove = { ...playerMove };
                    playerMove.styleUsed = 'focus';
                    // å¿…ä¸­æ•ˆæœï¼šè®¾ç½® accuracy ä¸º trueï¼ˆå¿…ä¸­æ ‡è®°ï¼‰
                    playerMove.accuracy = true;
                    playerMove.bypassAccuracyCheck = true; // é¢å¤–æ ‡è®°ï¼Œç¡®ä¿ç»•è¿‡å‘½ä¸­æ£€å®š
                    log(`<span style="color:#a855f7">ğŸ¯ å‡ç¥Â·å¿ƒçœ¼ï¼šç»å¯¹ä¸“æ³¨ï¼Œå¿…ç„¶å‘½ä¸­ï¼</span>`);
                    console.log(`[STYLES] å‡ç¥: å¿…ä¸­æ•ˆæœ (åŸå‘½ä¸­: ${originalAccuracy})`);
                    // ã€å†·å´ v3ã€‘åŸºäºç†Ÿç»ƒåº¦çš„åŠ¨æ€å†·å´
                    const proficiency = battle.trainerProficiency ?? 0;
                    const styleCooldown = getStyleCooldown(proficiency);
                    battle.playerStyleCooldown = styleCooldown;
                    if (styleCooldown > 0) {
                        console.log(`[STYLES v3] è¿›å…¥ä¼‘æ†©: ${styleCooldown}å›åˆ (ç†Ÿç»ƒåº¦: ${proficiency})`);
                    } else {
                        console.log(`[STYLES v3] æ°”è„‰è´¯é€šï¼Œæ— éœ€ä¼‘æ†© (ç†Ÿç»ƒåº¦: ${proficiency})`);
                    }
                }
            }
        }
        // ä½¿ç”¨åé‡ç½®ä¸ºæ™®é€šé£æ ¼
        window.currentMoveStyle = 'normal';
        if (typeof setMoveStyle === 'function') {
            setMoveStyle('normal');
        }
        // åˆ·æ–°æ‚¬æµ®çª—çŠ¶æ€
        if (typeof window.refreshCommanderBubble === 'function') {
            window.refreshCommanderBubble();
        }
    }
    // === å›åˆå¼€å§‹ï¼šæ¸…é™¤åŒæ–¹çš„ Protect çŠ¶æ€ï¼ˆæ–°å›åˆå¼€å§‹ï¼Œå®ˆä½å¤±æ•ˆï¼‰===
    if (p.volatile) p.volatile.protect = false;
    if (e.volatile) e.volatile.protect = false;
    // === Mega/Dynamax è¿›åŒ–å¤„ç† (å›åˆå¼€å§‹æ—¶ï¼Œå‡ºæ‹›å‰) ===
    // ç©å®¶ Mega/Dynamax è¿›åŒ– - ä½¿ç”¨ä¿å­˜çš„çŠ¶æ€ï¼ˆå› ä¸º showMainMenu ä¼šé‡ç½® battle.playerMegaArmedï¼‰
    const canMegaEvolveFunc = window.canMegaEvolve;
    const performMegaEvolutionFunc = window.performMegaEvolution;
    // æ£€æŸ¥æ˜¯å¦æ˜¯æå·¨åŒ–æ¨¡å¼
    // ã€ä¿®å¤ã€‘mechanic å­—æ®µæ˜¯æœ€é«˜æƒå¨ï¼Œå¦‚æœ mechanic === 'mega'ï¼Œåˆ™ä¸åº”è§¦å‘æå·¨åŒ–
    const isDynamaxMode = p && p.mechanic !== 'mega' && (p.canDynamax || (p.megaTargetId && p.megaTargetId.toLowerCase().includes('gmax')));
    if (megaArmedThisTurn && isDynamaxMode && !battle.playerMaxUsed && !p.isDynamaxed) {
        // === æå·¨åŒ–å¤„ç† ===
        battle.playerMegaArmed = false;
        battle.playerMaxUsed = true;
        const oldName = p.cnName;
        const oldMaxHp = p.maxHp;
        const oldCurrHp = p.currHp;
        log(`<div style="border-bottom: 2px solid #e11d48; margin-bottom: 5px;"></div>`);
        log(`<b style="font-size:1.2em; color:#e11d48">â–‚â–ƒâ–…â–†â–‡ DYNAMAX !!! â–‡â–†â–…â–ƒâ–‚</b>`);
        log(`${oldName} çš„èº«ä½“å¼€å§‹æ€¥å‰§è†¨èƒ€ï¼ä»¿ä½›è¦å†²ç ´å¤©é™…ï¼`);
        await wait(600);
        // æ’­æ”¾æå·¨åŒ–çˆ†å‘åŠ¨ç”»
        await playDynamaxAnimation(p, true);
        // ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æœ‰ G-Max å½¢æ€ï¼Œåˆ‡æ¢ç²¾çµå›¾
        // ã€å…³é”®ã€‘é€šç”¨æå·¨åŒ– (isGenericDynamax) ä¸åˆ‡æ¢å›¾ç‰‡ï¼Œåªç”¨ CSS æ”¾å¤§
        const gmaxFormId = p.megaTargetId;
        if (gmaxFormId && gmaxFormId.includes('gmax') && !p.isGenericDynamax) {
            // ä¿å­˜åŸå§‹åç§°ï¼Œç”¨äºå›é€€
            p.originalName = p.name;
            // [BUG FIX] æ ¼å¼è½¬æ¢ï¼šcharizardgmax -> Charizard-Gmax
            const baseName = gmaxFormId.replace(/gmax$/i, '');
            const formattedName = baseName.charAt(0).toUpperCase() + baseName.slice(1) + '-Gmax';
            p.name = formattedName;
            // ã€å¼ºåˆ¶ä¿®æ­£ã€‘G-Max å½¢æ€ä¸­æ–‡åï¼šä¼˜å…ˆç¿»è¯‘ï¼Œå›é€€æ—¶å¼ºåˆ¶åŠ "è¶…æå·¨"å‰ç¼€
            if (window.Locale) {
                const translatedName = window.Locale.get(formattedName);
                // æ£€æŸ¥æ˜¯å¦æˆåŠŸç¿»è¯‘ï¼ˆç¿»è¯‘åä¸ç­‰äºåŸåï¼Œä¸”ä¸ç­‰äºåŸºç¡€å½¢æ€åï¼‰
                const baseTranslated = window.Locale.get(baseName.charAt(0).toUpperCase() + baseName.slice(1));
                if (translatedName !== formattedName && translatedName !== baseTranslated) {
                    // æˆåŠŸç¿»è¯‘åˆ° G-Max å½¢æ€ï¼ˆå¦‚ "è¶…æå·¨å–·ç«é¾™"ï¼‰
                    p.cnName = translatedName;
                } else {
                    // ç¿»è¯‘å¤±è´¥ï¼Œå¼ºåˆ¶æ·»åŠ "è¶…æå·¨"å‰ç¼€
                    p.cnName = 'è¶…æå·¨' + baseTranslated;
                }
            } else {
                p.cnName = formattedName;
            }
            // G-Max ç²¾çµå›¾æ ¼å¼: laprasgmax -> lapras-gmax (å¸¦æ¨ªæ )
            const gmaxSpriteId = gmaxFormId.replace(/gmax$/i, '-gmax');
            const gmaxSpriteUrl = `https://play.pokemonshowdown.com/sprites/ani-back/${gmaxSpriteId}.gif`;
            smartLoadSprite('player-sprite', gmaxSpriteUrl, true);
            console.log(`[DYNAMAX] åˆ‡æ¢ç©å®¶ç²¾çµå›¾: ${gmaxSpriteUrl}`);
        } else if (p.isGenericDynamax) {
            console.log(`[DYNAMAX] é€šç”¨æå·¨åŒ–ï¼Œä¿æŒåŸå§‹ç²¾çµå›¾: ${p.name}`);
        }
        // HP å€ç‡ x1.5
        const hpMultiplier = 1.5;
        p.maxHp = Math.floor(oldMaxHp * hpMultiplier);
        p.currHp = Math.floor(oldCurrHp * hpMultiplier);
        // è®¾ç½®æå·¨åŒ–çŠ¶æ€
        p.isDynamaxed = true;
        p.dynamaxTurns = 3; // 3 å›åˆåå˜å›
        p.preDynamaxMaxHp = oldMaxHp;
        p.preDynamaxCurrHp = oldCurrHp;
        // ç©å®¶æå·¨åŒ–æ˜¯åœ¨è‡ªå·±å›åˆæ¿€æ´»çš„ï¼Œä¸éœ€è¦ justActivated æ ‡è®°
        // å› ä¸ºæ¿€æ´»åä¼šç«‹å³è¡ŒåŠ¨ï¼Œç„¶åå›åˆç»“æŸæ—¶æ­£å¸¸ tick
        // ã€å…³é”®ã€‘æ‹›å¼è½¬æ¢ä¸ºæå·¨æ‹›å¼
        applyDynamaxState(p, true);
        // ã€ä¿®å¤ã€‘é‡æ–°è·å–å½“å‰å›åˆçš„æ‹›å¼ï¼ˆå› ä¸ºæ‹›å¼åˆ—è¡¨å·²ç»è¢«æ›¿æ¢ï¼‰
        playerMove = p.moves[moveIndex];
        log(`<b style="color:#e11d48">${oldName} æå·¨åŒ–äº†ï¼(HP x${hpMultiplier})</b>`);
        log(`<span style="color:#ff6b8a">[æå·¨åŒ–å‰©ä½™å›åˆ: ${p.dynamaxTurns}]</span>`);
        updateAllVisuals('player');
        await wait(800);
        // ã€Commander System V2ã€‘è¿›åŒ–è§¦å‘ååˆ·æ–°æ‚¬æµ®çª—å›åˆ°è½®æ’­
        if (typeof window.refreshCommanderBubble === 'function') {
            window.refreshCommanderBubble();
        }
    } else if (megaArmedThisTurn && canMegaEvolveFunc && canMegaEvolveFunc(p) && !battle.playerMegaUsed && p.mechanic !== 'tera') {
        // === æ™®é€š Mega è¿›åŒ–å¤„ç† ===
        // ã€ä¿®å¤ã€‘å¿…é¡»æ’é™¤ mechanic='tera' çš„å®å¯æ¢¦ï¼Œé¿å…ä¸å¤ªæ™¶åŒ–å†²çª
        battle.playerMegaArmed = false;
        battle.playerMegaUsed = true;
        const oldName = p.cnName;
        log(`<div style="border-bottom: 2px solid #c084fc; margin-bottom: 5px;"></div>`);
        log(`${oldName} çš„è¿›åŒ–çŸ³å¯¹ ${battle.playerName || 'è®­ç»ƒå®¶'} çš„é’¥çŸ³äº§ç”Ÿäº†ååº”ï¼`);
        await wait(600);
        const megaResult = performMegaEvolutionFunc(p);
        if (megaResult) {
            await playMegaEvolutionAnimation(p, true);
            log(`<b style="color:#d8b4fe">${oldName} Mega è¿›åŒ–æˆäº† ${megaResult.newName}ï¼</b>`);
            if (megaResult.typeChanged) {
                log(`<span style="font-size:0.9em; color:#9ca3af;">${megaResult.newName} å˜æˆäº† ${megaResult.newTypes.join('/')} å±æ€§ï¼</span>`);
            }
            if (megaResult.abilityChanged && megaResult.newAbility) {
                log(`<span style="font-size:0.9em; color:#9ca3af;">è·å¾—äº†ç‰¹æ€§ <b>${megaResult.newAbility}</b>ï¼</span>`);
                triggerEntryAbilities(p, e);
            }
        }
        updateAllVisuals('player');
        await wait(800);
        // ã€Commander System V2ã€‘Megaè¿›åŒ–è§¦å‘ååˆ·æ–°æ‚¬æµ®çª—å›åˆ°è½®æ’­
        if (typeof window.refreshCommanderBubble === 'function') {
            window.refreshCommanderBubble();
        }
    } else if (megaArmedThisTurn && p.mechanic === 'tera' && p.canTera && !battle.playerTeraUsed && !p.isTerastallized) {
        // === å¤ªæ™¶åŒ–å¤„ç† ===
        battle.playerMegaArmed = false;
        battle.playerTeraUsed = true;
        const oldName = p.cnName;
        const oldTypes = [...p.types];
        const teraType = p.teraType;
        log(`<div style="border-bottom: 2px solid #22d3ee; margin-bottom: 5px;"></div>`);
        log(`<b style="font-size:1.2em; color:#22d3ee">ğŸ’ TERASTALLIZE !!! ğŸ’</b>`);
        log(`${oldName} çš„èº«ä½“å¼€å§‹ç»“æ™¶åŒ–ï¼é—ªè€€ç€ ${teraType} å±æ€§çš„å…‰èŠ’ï¼`);
        await wait(600);
        // æ’­æ”¾å¤ªæ™¶åŒ–åŠ¨ç”»
        const playerSprite = document.getElementById('player-sprite');
        if (playerSprite) {
            // æ·»åŠ å±æ€§é¢œè‰²ç±»
            playerSprite.classList.add('tera-burst', `tera-type-${teraType.toLowerCase()}`);
            await wait(800);
            playerSprite.classList.remove('tera-burst');
            playerSprite.classList.add('state-terastal');
        }
        // æ‰§è¡Œå¤ªæ™¶åŒ–ï¼šå±æ€§å˜æ›´
        p.isTerastallized = true;
        p.originalTypes = oldTypes; // ä¿å­˜åŸå§‹å±æ€§ï¼ˆç”¨äº STAB å›æº¯ï¼‰
        p.types = [teraType]; // å±æ€§å˜ä¸ºå•ä¸€å¤ªæ™¶å±æ€§
        // === ã€Ambrosia æ—¶ç©ºé†‰ã€‘æ ‡è®°ä¸‹å›åˆæ··ä¹± ===
        if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.checkNeuroBacklash) {
            const currentWeather = battle?.weather || '';
            const neuroResult = window.WeatherEffects.checkNeuroBacklash(currentWeather, 'terastal', p, null);
            if (neuroResult.shouldTrigger) {
                p.volatile = p.volatile || {};
                p.volatile.neuroBacklash = true;
                console.log(`[AMBROSIA] âš¡ æ—¶ç©ºé†‰ï¼š${p.name} å¤ªæ™¶åŒ–åè¢«æ ‡è®°ï¼Œä¸‹å›åˆå°†æ··ä¹±`);
                log(neuroResult.message);
            }
        }
        log(`<b style="color:#22d3ee">${oldName} å¤ªæ™¶åŒ–äº†ï¼</b>`);
        log(`<span style="color:#67e8f9">å±æ€§å˜åŒ–: ${oldTypes.join('/')} â†’ <b>${teraType}</b></span>`);
        updateAllVisuals('player');
        await wait(800);
        // ã€Commander System V2ã€‘å¤ªæ™¶åŒ–è§¦å‘ååˆ·æ–°æ‚¬æµ®çª—å›åˆ°è½®æ’­
        if (typeof window.refreshCommanderBubble === 'function') {
            window.refreshCommanderBubble();
        }
    }
    // =====================================================
    // === ç©å®¶è¿›åŒ–è§¦å‘é€»è¾‘ï¼ˆè£…å¡«æ¨¡å¼ï¼‰===
    // =====================================================
    if (evoArmedThisTurn && typeof window.triggerBattleEvolution === 'function') {
        await window.triggerBattleEvolution();
        // è¿›åŒ–ååˆ·æ–°æ‚¬æµ®çª—
        if (typeof window.refreshCommanderBubble === 'function') {
            window.refreshCommanderBubble();
        }
    }
    // =====================================================
    // === æ•Œæ–¹ AI Mega/Dynamax/Tera è§¦å‘é€»è¾‘ ===
    // =====================================================
    // ã€ä¿®å¤ã€‘ä¸‰ç§æœºåˆ¶ç‹¬ç«‹è®¡æ•°ï¼Œä¸å†å…±ç”¨ enemyMegaUsed
    // ã€è§£é”æ£€æŸ¥ã€‘å¿…é¡»æ£€æŸ¥ enemyUnlocks é…ç½®
    const enemyUnlocks = battle.enemyUnlocks || {};
    const isEnemyDynamax = (e.mechanic === 'dynamax') ||
                           (e.evolutionType === 'dynamax') || 
                           (e.canDynamax && e.mechanic !== 'mega' && e.mechanic !== 'tera') || 
                           (e.megaTargetId && e.megaTargetId.includes('gmax') && e.mechanic !== 'mega');
    // ã€è§£é”æ£€æŸ¥ã€‘Mega éœ€è¦ enable_megaï¼ŒDynamax éœ€è¦ enable_dynamax
    const canEnemyMega = enemyUnlocks.enable_mega && e.mechanic === 'mega' && (canMegaEvolveFunc && canMegaEvolveFunc(e));
    const canEnemyDynamax = enemyUnlocks.enable_dynamax && isEnemyDynamax && !e.isDynamaxed;
    // Mega è¿›åŒ–ï¼šæ£€æŸ¥ enemyMegaUsed
    // Dynamaxï¼šæ£€æŸ¥ enemyMaxUsed
    // Teraï¼šæ£€æŸ¥ enemyTeraUsedï¼ˆå·²åœ¨ä¸‹æ–¹å•ç‹¬å¤„ç†ï¼‰
    const shouldTriggerMega = canEnemyMega && !battle.enemyMegaUsed;
    const shouldTriggerDynamax = canEnemyDynamax && !battle.enemyMaxUsed;
    // === æ•Œæ–¹æå·¨åŒ–å¤„ç† ===
    if (shouldTriggerDynamax) {
        battle.enemyMaxUsed = true;
        const oldEnemyName = e.cnName;
        const oldMaxHp = e.maxHp;
        const oldCurrHp = e.currHp;
        const trainerName = battle.trainer?.name || 'å¯¹æ‰‹';
        // è¯»å–è®­ç»ƒå®¶ç‰¹æ®Šå°è¯
        if (battle.trainer && battle.trainer.lines && battle.trainer.lines.gmax_trigger) {
            log(`<i>${trainerName}: "${battle.trainer.lines.gmax_trigger}"</i>`);
        }
        log(`<div style="border-bottom: 2px solid #e11d48; margin-bottom: 5px;"></div>`);
        log(`<b style="font-size:1.2em; color:#e11d48">â–‚â–ƒâ–…â–†â–‡ DYNAMAX !!! â–‡â–†â–…â–ƒâ–‚</b>`);
        log(`${trainerName} çš„ ${oldEnemyName} å¼€å§‹æ€¥å‰§è†¨èƒ€ï¼ç©ºæ°”åœ¨éœ‡åŠ¨ï¼`);
        await wait(600);
        // ä¿å­˜åŸå§‹åç§°ï¼Œç”¨äºå›é€€
        e.originalName = e.name;
        // æ’­æ”¾æå·¨åŒ–çˆ†å‘åŠ¨ç”» + åˆ‡æ¢å›¾ç‰‡
        const spriteEl = document.getElementById('enemy-sprite');
        if (spriteEl) {
            spriteEl.classList.add('dynamax-burst');
            await wait(400);
            // æ£€æŸ¥æ˜¯å¦æœ‰ G-Max å½¢æ€ï¼ˆmegaTargetId åŒ…å« gmaxï¼‰
            // ã€å…³é”®ã€‘é€šç”¨æå·¨åŒ– (isGenericDynamax) ä¸åˆ‡æ¢å›¾ç‰‡ï¼Œåªç”¨ CSS æ”¾å¤§
            const gmaxFormId = e.megaTargetId;
            if (gmaxFormId && gmaxFormId.includes('gmax') && !e.isGenericDynamax) {
                // [BUG FIX] æ ¼å¼è½¬æ¢ï¼šcharizardgmax -> Charizard-Gmax
                const baseName = gmaxFormId.replace(/gmax$/i, '');
                const formattedName = baseName.charAt(0).toUpperCase() + baseName.slice(1) + '-Gmax';
                e.name = formattedName;
                // ã€å¼ºåˆ¶ä¿®æ­£ã€‘G-Max å½¢æ€ä¸­æ–‡åï¼šä¼˜å…ˆç¿»è¯‘ï¼Œå›é€€æ—¶å¼ºåˆ¶åŠ "è¶…æå·¨"å‰ç¼€
                if (window.Locale) {
                    const translatedName = window.Locale.get(formattedName);
                    // æ£€æŸ¥æ˜¯å¦æˆåŠŸç¿»è¯‘ï¼ˆç¿»è¯‘åä¸ç­‰äºåŸåï¼Œä¸”ä¸ç­‰äºåŸºç¡€å½¢æ€åï¼‰
                    const baseTranslated = window.Locale.get(baseName.charAt(0).toUpperCase() + baseName.slice(1));
                    if (translatedName !== formattedName && translatedName !== baseTranslated) {
                        // æˆåŠŸç¿»è¯‘åˆ° G-Max å½¢æ€ï¼ˆå¦‚ "è¶…æå·¨å–·ç«é¾™"ï¼‰
                        e.cnName = translatedName;
                    } else {
                        // ç¿»è¯‘å¤±è´¥ï¼Œå¼ºåˆ¶æ·»åŠ "è¶…æå·¨"å‰ç¼€
                        e.cnName = 'è¶…æå·¨' + baseTranslated;
                    }
                } else {
                    e.cnName = formattedName;
                }
                const gmaxSpriteId = gmaxFormId.replace(/gmax$/i, '-gmax');
                const gmaxSpriteUrl = `https://play.pokemonshowdown.com/sprites/ani/${gmaxSpriteId}.gif`;
                smartLoadSprite('enemy-sprite', gmaxSpriteUrl, false);
            } else if (e.isGenericDynamax) {
                console.log(`[DYNAMAX] æ•Œæ–¹é€šç”¨æå·¨åŒ–ï¼Œä¿æŒåŸå§‹ç²¾çµå›¾: ${e.name}`);
            }
            // å¦åˆ™ä¿æŒåŸç²¾çµå›¾ï¼Œåªåº”ç”¨æ”¾å¤§æ•ˆæœ
            await wait(400);
            spriteEl.classList.remove('dynamax-burst');
            spriteEl.classList.add('state-dynamax');
        }
        // HP å€ç‡ x1.5
        const hpMultiplier = 1.5;
        e.maxHp = Math.floor(oldMaxHp * hpMultiplier);
        e.currHp = Math.floor(oldCurrHp * hpMultiplier);
        // è®¾ç½®æå·¨åŒ–çŠ¶æ€
        e.isDynamaxed = true;
        e.dynamaxTurns = 3;
        e.preDynamaxMaxHp = oldMaxHp;
        e.preDynamaxCurrHp = oldCurrHp;
        // ã€å…³é”®ã€‘æ‹›å¼è½¬æ¢ä¸ºæå·¨æ‹›å¼
        applyDynamaxState(e, true);
        log(`<b style="color:#e11d48">${oldEnemyName} æå·¨åŒ–äº†ï¼(HP x${hpMultiplier})</b>`);
        log(`<span style="color:#ff6b8a">[æ•Œæ–¹æå·¨åŒ–å‰©ä½™å›åˆ: ${e.dynamaxTurns}]</span>`);
        updateAllVisuals('enemy');
        await wait(800);
    }
    // === æ•Œæ–¹ Mega è¿›åŒ–å¤„ç† ===
    if (shouldTriggerMega) {
        battle.enemyMegaUsed = true;
        const oldEnemyName = e.cnName;
        const trainerName = battle.trainer?.name || 'å¯¹æ‰‹';
        log(`<div style="border-bottom: 2px solid #ef4444; margin-bottom: 5px;"></div>`);
        log(`å¯¹æ‰‹çš„ ${oldEnemyName} çš„è¿›åŒ–çŸ³å¯¹ ${trainerName} çš„é’¥çŸ³äº§ç”Ÿäº†ååº”ï¼`);
        await wait(600);
        // å°è¯•æ‰§è¡Œ Mega è¿›åŒ–
        const megaResult = performMegaEvolutionFunc ? performMegaEvolutionFunc(e) : null;
        if (megaResult) {
            await playMegaEvolutionAnimation(e, false);
            log(`<b style="color:#fca5a5">å¯¹æ‰‹çš„ ${oldEnemyName} Mega è¿›åŒ–æˆäº† ${megaResult.newName}ï¼</b>`);
            if (megaResult.typeChanged) {
                log(`<span style="font-size:0.9em; color:#9ca3af;">å¯¹æ‰‹çš„ ${megaResult.newName} å˜æˆäº† ${megaResult.newTypes.join('/')} å±æ€§ï¼</span>`);
            }
            if (megaResult.abilityChanged && megaResult.newAbility) {
                log(`<span style="font-size:0.9em; color:#9ca3af;">è·å¾—äº†ç‰¹æ€§ <b>${megaResult.newAbility}</b>ï¼</span>`);
                triggerEntryAbilities(e, p);
            }
        } else {
            // mechanic è®¾ç½®ä¸º mega ä½†æ²¡æœ‰å®é™… Mega æ•°æ®ï¼Œè·³è¿‡æ¼”å‡º
            console.warn(`[MEGA] ${e.name} è®¾ç½®äº† mechanic: 'mega' ä½†æ²¡æœ‰ Mega å½¢æ€æ•°æ®ï¼Œè·³è¿‡`);
            battle.enemyMegaUsed = false; // å›æ»šä½¿ç”¨æ ‡è®°
        }
        updateAllVisuals('enemy');
        await wait(800);
    }
    // === æ•Œæ–¹ AI å¤ªæ™¶åŒ–å¤„ç† ===
    // ã€è§£é”æ£€æŸ¥ã€‘Tera éœ€è¦ enable_tera
    if (enemyUnlocks.enable_tera && e.mechanic === 'tera' && e.canTera && !battle.enemyTeraUsed && !e.isTerastallized) {
        // AI å†³ç­–ï¼šç¬¬ä¸€å›åˆç«‹å³å¤ªæ™¶åŒ–
        battle.enemyTeraUsed = true;
        const oldEnemyName = e.cnName;
        const oldTypes = [...e.types];
        const teraType = e.teraType;
        const trainerName = battle.trainer?.name || 'å¯¹æ‰‹';
        log(`<div style="border-bottom: 2px solid #22d3ee; margin-bottom: 5px;"></div>`);
        log(`<b style="font-size:1.2em; color:#22d3ee">ğŸ’ TERASTALLIZE !!! ğŸ’</b>`);
        log(`${trainerName} çš„ ${oldEnemyName} å¼€å§‹ç»“æ™¶åŒ–ï¼é—ªè€€ç€ ${teraType} å±æ€§çš„å…‰èŠ’ï¼`);
        await wait(600);
        // æ’­æ”¾å¤ªæ™¶åŒ–åŠ¨ç”»
        const enemySprite = document.getElementById('enemy-sprite');
        if (enemySprite) {
            enemySprite.classList.add('tera-burst', `tera-type-${teraType.toLowerCase()}`);
            await wait(800);
            enemySprite.classList.remove('tera-burst');
            enemySprite.classList.add('state-terastal');
        }
        // æ‰§è¡Œå¤ªæ™¶åŒ–ï¼šå±æ€§å˜æ›´
        e.isTerastallized = true;
        e.originalTypes = oldTypes;
        e.types = [teraType];
        // === ã€Ambrosia æ—¶ç©ºé†‰ã€‘æ ‡è®°ä¸‹å›åˆæ··ä¹± ===
        if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.checkNeuroBacklash) {
            const currentWeather = battle?.weather || '';
            const trainer = battle?.enemyTrainer || battle?.trainer;
            const neuroResult = window.WeatherEffects.checkNeuroBacklash(currentWeather, 'terastal', e, trainer);
            if (neuroResult.shouldTrigger) {
                e.volatile = e.volatile || {};
                e.volatile.neuroBacklash = true;
                console.log(`[AMBROSIA] âš¡ æ—¶ç©ºé†‰ï¼š${e.name} å¤ªæ™¶åŒ–åè¢«æ ‡è®°ï¼Œä¸‹å›åˆå°†æ··ä¹±`);
                log(neuroResult.message);
            }
        }
        log(`<b style="color:#22d3ee">${trainerName} çš„ ${oldEnemyName} å¤ªæ™¶åŒ–äº†ï¼</b>`);
        log(`<span style="color:#67e8f9">å±æ€§å˜åŒ–: ${oldTypes.join('/')} â†’ <b>${teraType}</b></span>`);
        updateAllVisuals('enemy');
        await wait(800);
    }
    // =====================================================
    // === æ•Œæ–¹ AI ç¾ç»Šå…±é¸£ (Bond Resonance) è§¦å‘é€»è¾‘ ===
    // =====================================================
    // ã€å…¨å±€å¼€å…³ã€‘EVO ç³»ç»Ÿå…³é—­æ—¶ä¸è§¦å‘
    // ã€è§£é”æ£€æŸ¥ã€‘Bond éœ€è¦ enable_bond
    // ã€å…¨å±€é™åˆ¶ã€‘æ¯åœºæˆ˜æ–—åªèƒ½ä½¿ç”¨ä¸€æ¬¡ Bond Resonance
    if (window.GAME_SETTINGS?.enableEVO !== false && enemyUnlocks.enable_bond && e.isAce && !battle.enemyBondUsed && !e.hasBondResonance && !e.hasEvolvedThisBattle) {
        // æ£€æŸ¥æ˜¯å¦æ»¡è¶³è§¦å‘æ¡ä»¶
        const eHpRatio = e.currHp / e.maxHp;
        const eAvs = e.avs || { trust: 0, passion: 0, insight: 0, devotion: 0 };
        const eTotalAVs = (e.getEffectiveAVs?.('trust') || eAvs.trust || 0) + 
                         (e.getEffectiveAVs?.('passion') || eAvs.passion || 0) + 
                         (e.getEffectiveAVs?.('insight') || eAvs.insight || 0) + 
                         (e.getEffectiveAVs?.('devotion') || eAvs.devotion || 0);
        // æ¡ä»¶ï¼šAce å®å¯æ¢¦ + AVs >= 300
        const meetsAVsReq = eTotalAVs >= 300;
        // ã€ä¸¥æ ¼åŠ£åŠ¿åˆ¤æ–­ã€‘
        // è®¡ç®—åŒæ–¹æ€»è¡€é‡
        let enemyTotalHp = 0, enemyTotalMaxHp = 0;
        let playerTotalHp = 0, playerTotalMaxHp = 0;
        battle.enemyParty.forEach(ep => {
            if (ep && typeof ep.isAlive === 'function') {
                enemyTotalMaxHp += ep.maxHp || 0;
                enemyTotalHp += Math.max(0, ep.currHp || 0);
            }
        });
        battle.playerParty.forEach(pp => {
            if (pp && typeof pp.isAlive === 'function') {
                playerTotalMaxHp += pp.maxHp || 0;
                playerTotalHp += Math.max(0, pp.currHp || 0);
            }
        });
        const aliveEnemies = battle.enemyParty.filter(ep => ep && typeof ep.isAlive === 'function' && ep.isAlive()).length;
        const alivePlayers = battle.playerParty.filter(pp => pp && typeof pp.isAlive === 'function' && pp.isAlive()).length;
        const isLastStand = aliveEnemies === 1;
        // ã€ä¸¥æ ¼åŠ£åŠ¿æ¡ä»¶ã€‘
        // æ ¸å¿ƒæ¡ä»¶ï¼šå¿…é¡»æ˜¯æœ€åä¸€åªå®å¯æ¢¦ ä¸” HP <= 50%
        // å°è§„æ¨¡æˆ˜æ–—ï¼ˆåŒæ–¹å„ <= 2 åªï¼‰æ—¶ï¼Œå…è®¸è¡€é‡åŠ£åŠ¿è§¦å‘
        const currentPokemonCritical = eHpRatio <= 0.50;
        const isSmallBattle = (battle.enemyParty.length <= 2 && battle.playerParty.length <= 2);
        const isHpDisadvantage = enemyTotalHp < playerTotalHp * 0.5;
        // è§¦å‘æ¡ä»¶ï¼š
        // 1. æœ€åä¸€åªå®å¯æ¢¦ + HP <= 50%
        // 2. æˆ–è€… å°è§„æ¨¡æˆ˜æ–— + è¡€é‡åŠ£åŠ¿ + HP <= 50%
        const canTriggerBond = meetsAVsReq && currentPokemonCritical && (isLastStand || (isSmallBattle && isHpDisadvantage));
        if (canTriggerBond) {
            e.hasBondResonance = true;
            battle.enemyBondUsed = true; // ã€å…¨å±€é™åˆ¶ã€‘æ ‡è®°å·²ä½¿ç”¨
            const trainerName = battle.trainer?.name || 'å¯¹æ‰‹';
            log(`<div style="border-top: 2px solid #ef4444; border-bottom: 2px solid #ef4444; padding: 8px; text-align: center; margin: 10px 0; background: linear-gradient(90deg, rgba(239,68,68,0.1), rgba(239,68,68,0.3), rgba(239,68,68,0.1));">`);
            log(`<b style="font-size:1.4em; color:#ef4444; text-shadow: 0 0 10px #dc2626;">âˆ BOND RESONANCE âˆ</b>`);
            log(`</div>`);
            await wait(500);
            log(`${trainerName} ä¸ ${e.cnName} çš„å¿ƒè·³å®Œå…¨é‡åˆäº†â€¦â€¦`);
            await wait(400);
            log(`ä¸ºäº†å›åº”å½»åº•çš„ä¿¡èµ– <span style="color:#facc15">(Total AVs: ${eTotalAVs})</span>ï¼Œæ²‰ç¡åœ¨ä½“å†…çš„ç•Œé™è¢«æ‰“ç ´äº†ï¼`);
            // åŠ¨ç”»ï¼šçº¢è‰²å…‰æ™•çˆ†å‘
            const enemySprite = document.getElementById('enemy-sprite');
            if (enemySprite) {
                enemySprite.classList.add('evo-burst');
                enemySprite.style.filter = 'brightness(3) drop-shadow(0 0 20px #ef4444)';
            }
            await wait(400);
            if (enemySprite) {
                enemySprite.classList.remove('evo-burst');
                enemySprite.classList.add('evo-finish');
                enemySprite.style.filter = 'drop-shadow(0 0 15px #ef4444) brightness(1.15) saturate(1.2)';
            }
            await wait(600);
            if (enemySprite) {
                enemySprite.classList.remove('evo-finish');
                enemySprite.classList.add('bond-resonance');
            }
            // æ•°æ®å˜æ›´
            // 1. HP å›å¤ +60%
            const healAmount = Math.floor(e.maxHp * 0.6);
            e.currHp = Math.min(e.currHp + healAmount, e.maxHp);
            // 2. æ¸…é™¤å¼‚å¸¸
            e.status = null;
            // 3. å…¨èƒ½åŠ›+1
            if (typeof e.applyBoost === 'function') {
                e.applyBoost('atk', 1);
                e.applyBoost('def', 1);
                e.applyBoost('spa', 1);
                e.applyBoost('spd', 1);
                e.applyBoost('spe', 1);
            }
            log(`<b style="color:#ef4444">âœ¦ ${trainerName} çš„ ${e.cnName} æ½œèƒ½è¢«å”¤é†’! å…¨å±æ€§æå¤§å¹…æå‡!</b>`);
            log(`<span style="color:#60a5fa">âœ¦ æ°”åŠ¿(HP)å¤§å¹…å›å¤ï¼(+${healAmount})</span>`);
            if (isLastStand) {
                log(`<span style="color:#f87171; font-style:italic;">ã€Œ${trainerName}: è¿™æ˜¯æˆ‘ä»¬æœ€åçš„åå‡»ï¼ã€</span>`);
            }
            updateAllVisuals('enemy');
            await wait(800);
        }
    }
    // === è·å–æ•Œæ–¹ AI å†³ç­– (æ”¯æŒæ¢äºº) ===
    let enemyMove = null;
    let enemyAction = null;
    let enemyWillSwitch = false;
    let switchTargetIndex = -1;
    // ä¼˜å…ˆä½¿ç”¨æ–°çš„ AI å¼•æ“
    if (typeof window.getAiAction === 'function') {
        enemyAction = window.getAiAction(e, p, battle.aiDifficulty || 'normal', battle.enemyParty, {
            turnCount: battle.turnCount || 1
        });
    }
    // æ£€æŸ¥ AI æ˜¯å¦å†³å®šæ¢äºº
    if (enemyAction && enemyAction.type === 'switch' && typeof enemyAction.index === 'number') {
        const switchTarget = battle.enemyParty[enemyAction.index];
        // ä¸¥æ ¼æ£€æŸ¥ï¼šç›®æ ‡å¿…é¡»å­˜åœ¨ã€å­˜æ´»ã€ä¸æ˜¯å½“å‰å®å¯æ¢¦ã€HP > 0
        const targetIsValid = switchTarget && 
            typeof switchTarget.isAlive === 'function' && 
            switchTarget.isAlive() && 
            switchTarget.currHp > 0 &&
            switchTarget !== e;
        // ã€æŠ“äººæœºåˆ¶ã€‘æ£€æŸ¥æ•Œæ–¹æ˜¯å¦è¢«å›°ä½
        let enemyCanSwitch = true;
        if (typeof window.canEnemySwitch === 'function') {
            const switchCheck = window.canEnemySwitch();
            if (!switchCheck.canSwitch) {
                enemyCanSwitch = false;
                console.log(`[AI] Enemy cannot switch: ${switchCheck.reason}`);
            }
        }
        if (targetIsValid && enemyCanSwitch) {
            enemyWillSwitch = true;
            switchTargetIndex = enemyAction.index;
            if (enemyAction.reasoning) {
                console.log(`[AI] Switch reasoning: ${enemyAction.reasoning}`);
            }
        }
    }
    // è·å–æ•Œæ–¹æ”»å‡»æ‹›å¼ï¼ˆå¦‚æœä¸æ¢äººï¼‰
    if (!enemyWillSwitch) {
        if (enemyAction && enemyAction.move) {
            enemyMove = enemyAction.move;
            if (enemyAction.reasoning) {
                console.log(`[AI] Move reasoning: ${enemyAction.reasoning}`);
            }
        }
        // å›é€€åˆ°æ—§ AI
        if (!enemyMove && typeof window.getAiMove === 'function') {
            enemyMove = window.getAiMove(e, p, battle.aiDifficulty || 'normal');
        }
        if (!enemyMove) {
            enemyMove = e.moves[Math.floor(Math.random() * e.moves.length)];
        }
        // === ã€ä¿®å¤ã€‘æ£€æŸ¥ Taunt ç­‰ Volatile çŠ¶æ€æ˜¯å¦é˜»æ­¢ AI ä½¿ç”¨è¯¥æŠ€èƒ½ ===
        if (typeof MoveEffects !== 'undefined' && MoveEffects.canUseMove && enemyMove) {
            const canUseResult = MoveEffects.canUseMove(e, enemyMove);
            if (!canUseResult.canUse) {
                log(`<span style="color:#e74c3c">${canUseResult.reason}</span>`);
                // å°è¯•é€‰æ‹©å…¶ä»–å¯ç”¨æŠ€èƒ½
                const availableMoves = e.moves.filter(m => {
                    const check = MoveEffects.canUseMove(e, m);
                    return check.canUse;
                });
                if (availableMoves.length > 0) {
                    enemyMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                    console.log(`[AI] Taunt é˜»æ­¢äº†åŸæŠ€èƒ½ï¼Œæ”¹ç”¨: ${enemyMove.name}`);
                } else {
                    // æ²¡æœ‰å¯ç”¨æŠ€èƒ½ï¼Œä½¿ç”¨æŒ£æ‰
                    enemyMove = { name: 'Struggle', cn: 'æŒ£æ‰', power: 50, type: 'Normal', cat: 'phys' };
                    log(`<span style="color:#aaa">${e.cnName} æ— æŠ€å¯ç”¨ï¼Œåªèƒ½æŒ£æ‰!</span>`);
                }
            }
        }
        // =====================================================
        // === ã€AI Z æ‹›å¼æ¨å¯¼ã€‘ ===
        // =====================================================
        // å¦‚æœæ•Œæ–¹é…ç½®äº† mechanic='zmove' ä¸”è¿˜æ²¡ç”¨è¿‡ Z æ‹›å¼
        // ã€è§£é”æ£€æŸ¥ã€‘Z æ‹›å¼éœ€è¦ enable_z_move
        // ä¼˜å…ˆå¯»æ‰¾èƒ½è§¦å‘ä¸“å± Z çš„æ‹›å¼ï¼Œå¦åˆ™å°è¯•è½¬æ¢å½“å‰æ‹›å¼
        // ã€Ultra Burstã€‘æ—¥/æœˆéª¡å­ä½¿ç”¨ Z æ‹›å¼æ—¶å…ˆè§¦å‘ Ultra Burst
        const enemyUnlocksForZ = battle.enemyUnlocks || {};
        if (enemyUnlocksForZ.enable_z_move && e.mechanic === 'zmove' && !battle.enemyZUsed && enemyMove) {
            let zTarget = null;
            let zBaseMove = null;
            // 1. ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰èƒ½è§¦å‘ä¸“å± Z çš„æ‹›å¼
            for (const move of e.moves) {
                const potentialZ = typeof getZMoveTarget === 'function' 
                    ? getZMoveTarget(move, e) 
                    : null;
                if (potentialZ && potentialZ.isExclusive) {
                    // æ‰¾åˆ°ä¸“å± Z æ‹›å¼ï¼
                    zTarget = potentialZ;
                    zBaseMove = move;
                    console.log(`[AI Z-MOVE] æ‰¾åˆ°ä¸“å± Z æ‹›å¼: ${move.name} -> ${potentialZ.name}`);
                    break;
                }
            }
            // 2. å¦‚æœæ²¡æœ‰ä¸“å± Zï¼Œå°è¯•ç”¨å½“å‰é€‰ä¸­çš„æ‹›å¼è½¬æ¢
            if (!zTarget) {
                zTarget = typeof getZMoveTarget === 'function' 
                    ? getZMoveTarget(enemyMove, e) 
                    : null;
                zBaseMove = enemyMove;
            }
            if (zTarget) {
                // =========================================================
                // ã€æ•Œæ–¹ Ultra Burstã€‘æ—¥/æœˆéª¡å­ â†’ ç©¶æå¥ˆå…‹æ´›å…¹ç›
                // =========================================================
                if (typeof canUltraBurst === 'function' && canUltraBurst(e)) {
                    const burstResult = executeUltraBurst(e);
                    if (burstResult.success) {
                        burstResult.logs.forEach(msg => log(msg));
                        updateAllVisuals('enemy');
                        await wait(800);
                        // æ›´æ–°å¼•ç”¨
                        e = battle.getEnemy();
                    }
                }
                console.log(`[AI Z-MOVE] æ•Œæ–¹ AI æ¨å¯¼ Z æ‹›å¼: ${zBaseMove.name} -> ${zTarget.name} (å¨åŠ›: ${zTarget.power})`);
                // åˆ›å»º Z æ‹›å¼å¯¹è±¡
                enemyMove = {
                    name: zTarget.name,
                    type: zTarget.type || zBaseMove.type,
                    power: zTarget.power,
                    cat: zBaseMove.cat || 'phys',
                    accuracy: true, // Z æ‹›å¼å¿…ä¸­
                    isZ: true,
                    baseMove: zBaseMove.name // ä¿ç•™åŸå§‹æ‹›å¼å
                };
                // === ã€Ambrosia æ—¶ç©ºé†‰ã€‘æ ‡è®°ä¸‹å›åˆæ··ä¹± ===
                if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.checkNeuroBacklash) {
                    const currentWeather = battle?.weather || '';
                    const trainer = battle?.enemyTrainer || battle?.trainer;
                    const neuroResult = window.WeatherEffects.checkNeuroBacklash(currentWeather, 'zmove', e, trainer);
                    if (neuroResult.shouldTrigger) {
                        e.volatile = e.volatile || {};
                        e.volatile.neuroBacklash = true;
                        console.log(`[AMBROSIA] âš¡ æ—¶ç©ºé†‰ï¼š${e.name} ä½¿ç”¨Zæ‹›å¼åè¢«æ ‡è®°ï¼Œä¸‹å›åˆå°†æ··ä¹±`);
                        log(neuroResult.message);
                    }
                }
            }
        }
        // =====================================================
        // === ã€AI åˆšçŒ›/è¿…ç–¾é£æ ¼ v2.1ã€‘ (enable_styles) ===
        // =====================================================
        // åŠ¨æ€è°ƒæ•´ï¼šæ ¹æ®é€Ÿåº¦ä¼˜åŠ¿å†³å®šæƒ©ç½šç¨‹åº¦
        // è¿…ç–¾ (Agile): é€Ÿåº¦å¿«æ—¶0.75x(ä¿å…ˆæ‰‹)ï¼Œé€Ÿåº¦æ…¢æ—¶0.5x(æŠ¢èŠ‚å¥)
        // åˆšçŒ› (Strong): é€Ÿåº¦å¿«æ—¶å¿…ä¸­(å–å…ˆæ‰‹)ï¼Œé€Ÿåº¦æ…¢æ—¶å‘½ä¸­0.8x(ç™½å«–)
        // ã€å¹³è¡¡æ€§æ”¹åŠ¨ã€‘ä½¿ç”¨åè¿›å…¥ 1 å›åˆå†·å´
        const enemyUnlocksForStyles = battle.enemyUnlocks || {};
        if (enemyUnlocksForStyles.enable_styles && enemyMove && !enemyMove.isZ) {
            // ã€Chronal Rift æ´—ç¿ æ— æ³•ã€‘æ£€æŸ¥æ˜¯å¦åœ¨æ—¶ç©ºè£‚éš™ä¸­
            let isEnemyUnboundArts = false;
            let enemyUnboundModifier = null;
            if (typeof window.WeatherEffects !== 'undefined' && window.WeatherEffects.getUnboundArtsModifier) {
                const weather = battle?.weather || battle?.environmentWeather || '';
                // é¢„æ£€æŸ¥æ˜¯å¦ä¼šä½¿ç”¨é£æ ¼
                const potentialStyle = (enemyAction && enemyAction.style) ? enemyAction.style : 'normal';
                if (potentialStyle !== 'normal') {
                    enemyUnboundModifier = window.WeatherEffects.getUnboundArtsModifier(weather, potentialStyle, e, p);
                    isEnemyUnboundArts = enemyUnboundModifier.active;
                }
            }
            // ã€å†·å´æ£€æŸ¥ã€‘å¦‚æœåœ¨å†·å´ä¸­ä¸”ä¸æ˜¯æ´—ç¿ æ— æ³•ï¼ŒAI ä¸ä½¿ç”¨é£æ ¼
            if (battle.enemyStyleCooldown > 0 && !isEnemyUnboundArts) {
                console.log(`[AI STYLES] æ•Œæ–¹é£æ ¼ç³»ç»Ÿå†·å´ä¸­ï¼Œæœ¬å›åˆä½¿ç”¨æ™®é€šé£æ ¼`);
            } else {
                const originalPower = enemyMove.basePower || enemyMove.power || 0;
                const originalPriority = enemyMove.priority || 0;
                const originalAccuracy = enemyMove.accuracy;
                const isStatus = (enemyMove.category === 'Status' || enemyMove.cat === 'status' || originalPower === 0);
                // ã€v2.1ã€‘è®¡ç®—æœ‰æ•ˆé€Ÿåº¦ï¼Œåˆ¤æ–­é€Ÿåº¦ä¼˜åŠ¿
                let aiSpe = (typeof e.getStat === 'function') ? e.getStat('spe') : (e.spe || 100);
                let playerSpe = (typeof p.getStat === 'function') ? p.getStat('spe') : (p.spe || 100);
                // éº»ç—¹å‡é€Ÿ
                if (e.status === 'par') aiSpe = Math.floor(aiSpe * 0.5);
                if (p.status === 'par') playerSpe = Math.floor(playerSpe * 0.5);
                // æˆæ³•ç©ºé—´åˆ¤å®š
                const isTrickRoom = battle.field && battle.field.trickRoom > 0;
                let aiHasSpeedAdvantage = false;
                if (isTrickRoom) {
                    aiHasSpeedAdvantage = aiSpe < playerSpe; // ç©ºé—´ä¸‹ï¼šæ…¢å°±æ˜¯å¿«
                } else {
                    aiHasSpeedAdvantage = aiSpe > playerSpe; // æ­£å¸¸ï¼šå¿«å°±æ˜¯å¿«
                }
                // ã€v2.1ã€‘ä¼˜å…ˆä½¿ç”¨ AI å¼•æ“è¿”å›çš„é£æ ¼é€‰æ‹©
                let aiStyle = 'normal';
                if (enemyAction && enemyAction.style) {
                    aiStyle = enemyAction.style;
                    console.log(`[AI STYLES] ä½¿ç”¨ AI å¼•æ“æ¨èçš„é£æ ¼: ${aiStyle}`);
                }
                // ============================================
                // ã€Chronal Rift æ´—ç¿ æ— æ³•ã€‘æ—¶ç©ºè£‚éš™ä¸­çš„å¤æ­¦è§„åˆ™
                // ============================================
                if (isEnemyUnboundArts && enemyUnboundModifier) {
                    enemyMove = { ...enemyMove };
                    enemyMove.styleUsed = aiStyle;
                    if (aiStyle === 'agile') {
                        // è¿…ç–¾ãƒ»ç¬èº«æ¨¡å¼ï¼šä¼˜å…ˆåº¦+1ï¼Œé€Ÿåº¦å¿«æ— æŸ/é€Ÿåº¦æ…¢å¨åŠ›x0.9
                        enemyMove.priority = originalPriority + enemyUnboundModifier.priorityMod;
                        enemyMove.basePower = Math.floor(originalPower * enemyUnboundModifier.damageMultiplier);
                        enemyMove.power = enemyMove.basePower;
                        log(enemyUnboundModifier.message.replace('æ´—ç¿ æ— æ³•', 'æ•Œæ–¹æ´—ç¿ æ— æ³•'));
                        console.log(`[CHRONAL RIFT] æ•Œæ–¹æ´—ç¿ æ— æ³•ãƒ»è¿…ç–¾: priority +${enemyUnboundModifier.priorityMod}, power x${enemyUnboundModifier.damageMultiplier}`);
                    } else if (aiStyle === 'strong') {
                        // åˆšçŒ›ãƒ»ç ´åç¥æ¨¡å¼ï¼šä¼¤å®³x1.5ï¼Œå‘½ä¸­x0.85ï¼Œä¼˜å…ˆåº¦-1
                        enemyMove.priority = originalPriority + enemyUnboundModifier.priorityMod;
                        enemyMove.basePower = Math.floor(originalPower * enemyUnboundModifier.damageMultiplier);
                        enemyMove.power = enemyMove.basePower;
                        enemyMove.breaksProtect = true;
                        const oldAcc = (typeof originalAccuracy === 'number') ? originalAccuracy : 100;
                        if (originalAccuracy !== true && oldAcc < 101) {
                            enemyMove.accuracy = Math.floor(oldAcc * enemyUnboundModifier.accuracyMultiplier);
                        }
                        log(enemyUnboundModifier.message.replace('æ´—ç¿ æ— æ³•', 'æ•Œæ–¹æ´—ç¿ æ— æ³•'));
                        console.log(`[CHRONAL RIFT] æ•Œæ–¹æ´—ç¿ æ— æ³•ãƒ»åˆšçŒ›: power x${enemyUnboundModifier.damageMultiplier}, acc x${enemyUnboundModifier.accuracyMultiplier}`);
                    }
                    // æ´—ç¿ æ— æ³•æ— å†·å´
                }
                // ============================================
                // âš¡ AI è¿…ç–¾é£æ ¼ (Agile Style) - æ™®é€šæ¨¡å¼
                // ============================================
                else if (aiStyle === 'agile') {
                    // ã€å¹³è¡¡æ€§æ”¹åŠ¨ã€‘å˜åŒ–æŠ€ç¦æ­¢ä½¿ç”¨è¿…ç–¾
                    if (isStatus) {
                        console.log(`[AI STYLES] å˜åŒ–æŠ€æ— æ³•ä½¿ç”¨è¿…ç–¾ï¼Œæ”¹ç”¨æ™®é€šé£æ ¼`);
                    } else {
                        enemyMove = { ...enemyMove };
                        enemyMove.priority = originalPriority + 1;
                        enemyMove.styleUsed = 'agile';
                        const oldAcc = (typeof originalAccuracy === 'number') ? originalAccuracy : 100;
                        if (aiHasSpeedAdvantage) {
                            // åœºæ™¯ A: æ‹¥æœ‰é€Ÿåº¦ä¼˜åŠ¿ - ä¹°ä¿é™©æ±‚ç¨³ï¼Œé˜²å…ˆåˆ¶
                            enemyMove.basePower = Math.floor(originalPower * 0.75);
                            enemyMove.accuracy = Math.floor(oldAcc * 0.9); // å‘½ä¸­ç‡ 0.9x
                            log(`<span style="color:#3b82f6">âš¡ æ•Œæ–¹è¿…ç–¾Â·åˆ¶å˜ï¼šé€Ÿåº¦å‹åˆ¶ä¸‹ç¡®ä¿å…ˆæ‰‹ - å¨åŠ›Ã—0.75ï¼Œå‘½ä¸­Ã—0.9</span>`);
                            console.log(`[AI STYLES] è¿…ç–¾(å¿«): power 0.75x, acc 0.9x (${aiSpe} vs ${playerSpe})`);
                        } else {
                            // åœºæ™¯ B: æ²¡æœ‰é€Ÿåº¦ä¼˜åŠ¿ - ç»åœ°åå‡»ï¼Œå·å›åˆ
                            enemyMove.basePower = Math.floor(originalPower * 0.50);
                            enemyMove.accuracy = Math.floor(oldAcc * 0.85); // å‘½ä¸­ç‡ 0.85x
                            log(`<span style="color:#60a5fa">âš¡ æ•Œæ–¹è¿…ç–¾Â·ç¥é€Ÿï¼šé€†è½¬è¡ŒåŠ¨é¡ºä½ - å¨åŠ›Ã—0.50ï¼Œå‘½ä¸­Ã—0.85</span>`);
                            console.log(`[AI STYLES] è¿…ç–¾(æ…¢): power 0.5x, acc 0.85x (${aiSpe} vs ${playerSpe})`);
                        }
                        enemyMove.power = enemyMove.basePower;
                        // ã€å†·å´ v3ã€‘åŸºäºæ•Œæ–¹ç†Ÿç»ƒåº¦çš„åŠ¨æ€å†·å´
                        const enemyProf = battle.enemyTrainerProficiency ?? 0;
                        battle.enemyStyleCooldown = getStyleCooldown(enemyProf);
                        console.log(`[AI STYLES v3] è¿›å…¥ä¼‘æ†©: ${battle.enemyStyleCooldown}å›åˆ (æ•Œæ–¹ç†Ÿç»ƒåº¦: ${enemyProf})`);
                    }
                } 
                // ============================================
                // ğŸ’ª AI åˆšçŒ›é£æ ¼ (Strong Style) - æ™®é€šæ¨¡å¼
                // ============================================
                else if (aiStyle === 'strong') {
                    enemyMove = { ...enemyMove };
                    enemyMove.priority = originalPriority - 1;
                    enemyMove.basePower = Math.floor(originalPower * 1.30);
                    enemyMove.power = enemyMove.basePower;
                    enemyMove.breaksProtect = true; // å¯ç©¿é€å®ˆä½
                    enemyMove.styleUsed = 'strong';
                    if (!aiHasSpeedAdvantage) {
                        // åœºæ™¯ A: é€Ÿåº¦åŠ£åŠ¿ (æœ¬æ¥å°±æ…¢) - æ²¡ä»˜å‡ºä»£ä»·ï¼Œé™å‘½ä¸­
                        const oldAcc = (typeof originalAccuracy === 'number') ? originalAccuracy : 100;
                        enemyMove.accuracy = Math.floor(oldAcc * 0.8);
                        log(`<span style="color:#ef4444">ğŸ’ª æ•Œæ–¹åˆšçŒ›Â·èˆèº«ï¼šé€Ÿåº¦åŠ£åŠ¿ä¸‹çš„å¼ºæ”» - å¨åŠ›Ã—1.3ï¼Œå‘½ä¸­Ã—0.8</span>`);
                        console.log(`[AI STYLES] åˆšçŒ›(æ…¢): power 1.3x, acc 0.8x (${aiSpe} vs ${playerSpe})`);
                    } else {
                        // åœºæ™¯ B: é€Ÿåº¦ä¼˜åŠ¿ (æœ¬æ¥è¯¥AIå…ˆ) - å–å…ˆæ‰‹æ¢ä¼¤å®³ï¼Œä¸ä¿®æ­£å‘½ä¸­
                        // ã€v2.3ã€‘ä¸å†å¿…ä¸­ï¼Œä¿æŒåŸå‘½ä¸­ç‡
                        log(`<span style="color:#b91c1c">ğŸ’ª æ•Œæ–¹åˆšçŒ›Â·è“„åŠ›ï¼šæ”¾å¼ƒå…ˆæ‰‹ï¼Œå…¨åŠ›ä¸€å‡»ï¼(å¨åŠ›Ã—1.3ï¼Œè´¯ç©¿å®ˆä½)</span>`);
                        console.log(`[AI STYLES] åˆšçŒ›(å¿«): power 1.3x, acc unchanged (${aiSpe} vs ${playerSpe})`);
                    }
                    // ã€å†·å´ v3ã€‘åŸºäºæ•Œæ–¹ç†Ÿç»ƒåº¦çš„åŠ¨æ€å†·å´
                    const enemyProf = battle.enemyTrainerProficiency ?? 0;
                    battle.enemyStyleCooldown = getStyleCooldown(enemyProf);
                    console.log(`[AI STYLES v3] è¿›å…¥ä¼‘æ†©: ${battle.enemyStyleCooldown}å›åˆ (æ•Œæ–¹ç†Ÿç»ƒåº¦: ${enemyProf})`);
                }
                // ============================================
                // ğŸ¯ AI å‡ç¥é£æ ¼ (Focus Style) - å¿…ä¸­æ¨¡å¼
                // ============================================
                else if (aiStyle === 'focus') {
                    // ã€å¹³è¡¡æ€§æ”¹åŠ¨ã€‘å˜åŒ–æŠ€ç¦æ­¢ä½¿ç”¨å‡ç¥
                    if (isStatus) {
                        console.log(`[AI STYLES] å˜åŒ–æŠ€æ— æ³•ä½¿ç”¨å‡ç¥ï¼Œæ”¹ç”¨æ™®é€šé£æ ¼`);
                    } else {
                        enemyMove = { ...enemyMove };
                        enemyMove.styleUsed = 'focus';
                        // å¿…ä¸­æ•ˆæœï¼šè®¾ç½® accuracy ä¸º trueï¼ˆå¿…ä¸­æ ‡è®°ï¼‰
                        enemyMove.accuracy = true;
                        enemyMove.bypassAccuracyCheck = true;
                        log(`<span style="color:#a855f7">ğŸ¯ æ•Œæ–¹å‡ç¥Â·å¿ƒçœ¼ï¼šç»å¯¹ä¸“æ³¨ï¼Œå¿…ç„¶å‘½ä¸­ï¼</span>`);
                        console.log(`[AI STYLES] å‡ç¥: å¿…ä¸­æ•ˆæœ (${enemyMove.name})`);
                        // ã€å†·å´ v3ã€‘åŸºäºæ•Œæ–¹ç†Ÿç»ƒåº¦çš„åŠ¨æ€å†·å´
                        const enemyProf = battle.enemyTrainerProficiency ?? 0;
                        battle.enemyStyleCooldown = getStyleCooldown(enemyProf);
                        console.log(`[AI STYLES v3] è¿›å…¥ä¼‘æ†©: ${battle.enemyStyleCooldown}å›åˆ (æ•Œæ–¹ç†Ÿç»ƒåº¦: ${enemyProf})`);
                    }
                }
            }
        }
    }
    // ========================================
    // å›åˆæ‰§è¡Œé¡ºåºï¼ˆæ­£ç¡®çš„å®å¯æ¢¦æˆ˜æ–—æµç¨‹ï¼‰ï¼š
    // 1. æ¢äººå…ˆæ‰§è¡Œï¼ˆæ¢äººä¼˜å…ˆçº§æœ€é«˜ï¼Œåœ¨æ”»å‡»ä¹‹å‰ï¼‰
    // 2. ç„¶åæŒ‰é€Ÿåº¦/ä¼˜å…ˆçº§æ‰§è¡Œæ”»å‡»
    // ========================================
    // === é˜¶æ®µ 1ï¼šæ•Œæ–¹æ¢äººï¼ˆåœ¨ç©å®¶æ”»å‡»ä¹‹å‰ï¼‰ ===
    if (enemyWillSwitch) {
        log(`<span style="color:#ef4444">æ•Œæ–¹æ”¶å›äº† ${e.cnName}ï¼</span>`);
        // ã€ä¿®å¤ã€‘æ¸…é™¤ Choice é”æ‹›çŠ¶æ€ï¼ˆæ¢äººè§£é™¤é”æ‹›ï¼‰
        if (e.choiceLockedMove) {
            console.log(`[CHOICE] ${e.name} æ¢ä¸‹ï¼Œè§£é™¤ ${e.choiceLockedMove} é”å®š`);
            delete e.choiceLockedMove;
        }
        // é‡ç½®å½“å‰å®å¯æ¢¦èƒ½åŠ›ç­‰çº§
        if (typeof e.resetBoosts === 'function') {
            e.resetBoosts();
        }
        battle.enemyActive = switchTargetIndex;
        const newE = battle.getEnemy();
        log(`<span style="color:#ef4444">æ•Œæ–¹æ´¾å‡ºäº† ${newE.cnName}ï¼</span>`);
        // ã€æ ‡è®°æ¢äººã€‘ç”¨äºé‡å¤ç²¾çµå›¾ä¿®å¤
        if (typeof window.markEnemySwitch === 'function') {
            window.markEnemySwitch();
        }
        // æ£€æŸ¥è¿›åœºå˜å½¢
        const checkInitTransformFunc = typeof window.checkInitTransform === 'function' ? window.checkInitTransform : null;
        if (checkInitTransformFunc && newE.needsInitTransform) {
            const result = checkInitTransformFunc(newE);
            if (result) {
                log(`<span style="color:#ef4444">âœ¦ æ•Œæ–¹ ${result.oldName} å˜ä¸º ${result.newName}ï¼</span>`);
            }
        }
        updateAllVisuals('enemy');
        await wait(500);
        triggerEntryAbilities(newE, p);
        // === ç»“ç®—æ•Œæ–¹åœºåœ°é’‰å­ä¼¤å®³ ===
        if (typeof MoveEffects !== 'undefined' && MoveEffects.applyEntryHazards) {
            const hazardLogs = MoveEffects.applyEntryHazards(newE, false, battle);
            hazardLogs.forEach(msg => log(msg));
            if (hazardLogs.length > 0) updateAllVisuals();
        }
        // æ›´æ–°æ•Œæ–¹å¼•ç”¨ä¸ºæ–°å®å¯æ¢¦
        e = newE;
    }
    // === é˜¶æ®µ 2ï¼šæ‰§è¡Œæ”»å‡»ï¼ˆæŒ‰é€Ÿåº¦/ä¼˜å…ˆçº§é¡ºåºï¼‰ ===
    // å¦‚æœæ•Œæ–¹æ¢äººäº†ï¼Œå®ƒè¿™å›åˆä¸æ”»å‡»ï¼Œåªæœ‰ç©å®¶æ”»å‡»
    if (enemyWillSwitch) {
        console.log('[handleAttack] Enemy switched, player attacks only');
        // ç©å®¶æ”»å‡»æ¢å…¥çš„å®å¯æ¢¦
        const playerResult = await executePlayerTurn(p, e, playerMove);
        // ã€BUGä¿®å¤ã€‘æ£€æŸ¥ç©å®¶æ˜¯å¦å› åä¼¤å€’ä¸‹ï¼ˆé—ªç„°å†²é”‹/å‹‡é¸Ÿ/ç–¯ç‹‚ä¼ç‰¹ç­‰ï¼‰
        if (!p.isAlive()) {
            console.log('[handleAttack] Player fainted from recoil in enemySwitch branch');
            // å…ˆæ£€æŸ¥æ˜¯å¦åŒæ–¹åŒæ—¶å€’ä¸‹
            if (!e.isAlive()) {
                await handleEnemyFainted(e);
            }
            await handlePlayerFainted(p);
            return;
        }
        if (!e.isAlive()) {
            await handleEnemyFainted(e);
            return;
        }
        // ç©å®¶ä½¿ç”¨äº† pivot æŠ€èƒ½ï¼Œè§¦å‘æ¢äºº
        if (playerResult?.pivot && hasAliveSwitch(battle.playerParty, battle.playerActive)) {
            console.log('[handleAttack] Player pivot in enemySwitch branch, calling handlePlayerPivot...');
            try {
                await handlePlayerPivot();
                console.log('[handleAttack] handlePlayerPivot Promise resolved successfully');
            } catch (err) {
                console.error('[handleAttack] handlePlayerPivot error:', err);
            }
        }
        // å›åˆæœ«ç»“ç®—
        console.log('[handleAttack] Calling executeEndPhase...');
        const currentP = battle.getPlayer();
        const currentE = battle.getEnemy();
        await executeEndPhase(currentP, currentE);
        console.log('[handleAttack] executeEndPhase returned');
        return;
    }
    // === é˜¶æ®µ 2bï¼šåŒæ–¹éƒ½æ”»å‡»ï¼ŒæŒ‰é€Ÿåº¦/ä¼˜å…ˆçº§é¡ºåº ===
    // =====================================================
    // === ã€å¯¹å†²ç³»ç»Ÿã€‘Phase 1: æ€æ„æ„ŸçŸ¥ (Insight Check) ===
    // =====================================================
    // === ã€å¯¹å†²ç³»ç»Ÿã€‘Phase 2: å¯¹å†²æ£€æµ‹ (Clash Detection) ===
    // =====================================================
    // æ£€æŸ¥æ˜¯å¦æ»¡è¶³å¯¹å†²è§¦å‘æ¡ä»¶ï¼ˆåæ‰‹å¯¹å†²ï¼šåªæœ‰é€Ÿåº¦æ…¢çš„ä¸€æ–¹æ‰èƒ½å‘èµ·ï¼‰
    let clashTriggered = false;
    let clashResult = null;
    if (typeof window.canTriggerClash === 'function' && window.GAME_SETTINGS?.enableClash !== false) {
        // è®¡ç®—é€Ÿåº¦ï¼Œåˆ¤æ–­è°æ˜¯"ä½é€Ÿæ–¹"
        let playerSpeed = (typeof p.getStat === 'function') ? p.getStat('spe') : (p.spe || 100);
        let enemySpeed = (typeof e.getStat === 'function') ? e.getStat('spe') : (e.spe || 100);
        // éº»ç—¹å‡é€Ÿ
        if (p.status === 'par') playerSpeed = Math.floor(playerSpeed * 0.5);
        if (e.status === 'par') enemySpeed = Math.floor(enemySpeed * 0.5);
        // æˆæ³•ç©ºé—´åˆ¤å®š
        const isTrickRoom = battle.field && battle.field.trickRoom > 0;
        // åˆ¤æ–­ç©å®¶æ˜¯å¦æ˜¯ä½é€Ÿæ–¹ï¼ˆåªæœ‰åæ‰‹æ‰èƒ½å‘èµ·å¯¹å†²ï¼‰
        const playerIsSlower = isTrickRoom ? (playerSpeed > enemySpeed) : (playerSpeed < enemySpeed);
        // é€Ÿåº¦æ¯”ä¾‹æ£€æŸ¥ï¼šåªè¦ç©å®¶åæ‰‹å°±å¯ä»¥å¯¹å†²
        const speedRatio = playerSpeed / enemySpeed;
        const meetsSpeedThreshold = speedRatio < 1.0; // åªè¦åæ‰‹å°±å¯ä»¥å¯¹å†²
        console.log(`[CLASH] é€Ÿåº¦æ£€æµ‹: ç©å®¶${playerSpeed} vs æ•Œæ–¹${enemySpeed}, æ¯”ä¾‹=${Math.round(speedRatio * 100)}%, åæ‰‹=${playerIsSlower}, æ»¡è¶³é˜ˆå€¼=${meetsSpeedThreshold}`);
        if (playerIsSlower && meetsSpeedThreshold) {
            const clashCheck = window.canTriggerClash(p, e, playerMove, enemyMove);
            console.log(`[CLASH] å¯¹å†²æ£€æµ‹: ${clashCheck.canTrigger ? 'å¯è§¦å‘' : clashCheck.reason}`);
            if (clashCheck.canTrigger && typeof window.showClashOption === 'function') {
                // ã€æ”¹è¿›ã€‘å¦‚æœ Insight é¢„è­¦å·²è§¦å‘ï¼Œå¯¹å†²å¿…å®šå¯ç”¨ï¼›å¦åˆ™èµ°ç†Ÿç»ƒåº¦æ¦‚ç‡
                let clashAvailable = false;
                if (battle.insightTriggeredThisTurn) {
                    console.log(`[CLASH] Insight å·²è§¦å‘ï¼Œå¯¹å†²å¿…å®šå¯ç”¨`);
                    clashAvailable = true;
                } else {
                    // æ²¡æœ‰ Insight æ—¶ï¼ŒåŸºäºè®­ç»ƒå®¶ç†Ÿç»ƒåº¦æ¦‚ç‡åˆ¤å®š
                    const proficiency = battle.trainerProficiency ?? 0;
                    const triggerRoll = window.rollClashTrigger ? window.rollClashTrigger(proficiency) : { success: true };
                    clashAvailable = triggerRoll.success;
                    if (!clashAvailable) {
                        console.log(`[CLASH] è§¦å‘å¤±è´¥ï¼Œè·³è¿‡å¯¹å†²é€‰é¡¹`);
                    }
                }
                // é‡ç½®æ ‡è®°
                battle.insightTriggeredThisTurn = false;
                if (!clashAvailable) {
                    // è§¦å‘å¤±è´¥ï¼Œä¸æ˜¾ç¤ºå¯¹å†²é€‰é¡¹ï¼Œç»§ç»­æ­£å¸¸å›åˆ
                } else {
                    // æ˜¾ç¤ºå¯¹å†²é€‰é¡¹ UI
                    const clashChoice = await window.showClashOption(playerMove, enemyMove);
                    if (clashChoice === 'clash' && typeof window.resolveClash === 'function') {
                        // === ã€å¯¹å†²ç³»ç»Ÿã€‘Phase 3: å¯¹å†²ç»“ç®— ===
                        clashTriggered = true;
                        clashResult = window.resolveClash(playerMove, enemyMove, p, e, { applySpeedModifier: true });
                        if (clashResult) {
                            console.log(`[CLASH] å¯¹å†²ç»“æœ: ${clashResult.resultType}`);
                            // ã€ä¿®å¤ã€‘æ’­æ”¾å¯¹å†²éŸ³æ•ˆ
                            if (typeof window.playSFX === 'function') window.playSFX('CLASH');
                            // æ˜¾ç¤ºå¯¹å†²åŠ¨ç”»å’Œæ—¥å¿—
                            log(`<div style="border: 2px solid #f59e0b; padding: 10px; margin: 10px 0; background: linear-gradient(90deg, rgba(245,158,11,0.1), rgba(245,158,11,0.2), rgba(245,158,11,0.1));">`);
                            clashResult.logs.forEach(msg => log(msg));
                            log(`</div>`);
                            // æ’­æ”¾ç¢°æ’ç‰¹æ•ˆï¼šåŒæ–¹ç²¾çµéœ‡åŠ¨ + ä¸­å¤®çˆ†ç‚¸åœˆ
                            const battleStage = document.querySelector('.battle-stage');
                            if (battleStage) {
                                // 1. åŒæ–¹ç²¾çµéœ‡åŠ¨
                                const playerSprite = document.getElementById('player-sprite');
                                const enemySprite = document.getElementById('enemy-sprite');
                                if (playerSprite) {
                                    playerSprite.classList.add('clash-shake');
                                    setTimeout(() => playerSprite.classList.remove('clash-shake'), 500);
                                }
                                if (enemySprite) {
                                    enemySprite.classList.add('clash-shake');
                                    setTimeout(() => enemySprite.classList.remove('clash-shake'), 500);
                                }
                                // 2. ä¸­å¤®çˆ†ç‚¸åœˆ
                                const impact = document.createElement('div');
                                impact.className = 'clash-impact';
                                battleStage.appendChild(impact);
                                setTimeout(() => impact.remove(), 800);
                            }
                            await wait(1000);
                            // æ ¹æ®å¯¹å†²ç»“æœåº”ç”¨ä¼¤å®³
                            // ã€ä¿®æ­£ã€‘ç©å®¶æ˜¯åæ‰‹å‘èµ·å¯¹å†²ï¼Œæ•Œæ–¹æ˜¯å…ˆæ‰‹è¢«å¯¹å†²
                            // å¯¹å†²ååº”ä¿æŒåŸé€Ÿåº¦é¡ºåºï¼šæ•Œæ–¹ï¼ˆå…ˆæ‰‹Bï¼‰å…ˆæ”»å‡»ï¼Œç©å®¶ï¼ˆåæ‰‹Aï¼‰åæ”»å‡»
                            if (clashResult.damageMultiplierB > 0) {
                                // æ•Œæ–¹æ‹›å¼å‘½ä¸­ï¼ˆå…ˆæ‰‹ï¼Œå¯èƒ½æ˜¯å‰Šå‡åçš„ï¼‰
                                const modifiedEnemyMove = { ...enemyMove };
                                modifiedEnemyMove.clashDamageMultiplier = clashResult.damageMultiplierB;
                                const enemyResult = await executeEnemyTurn(e, p, modifiedEnemyMove);
                                if (!p.isAlive()) {
                                    if (!e.isAlive()) {
                                        await handleEnemyFainted(e);
                                    }
                                    await handlePlayerFainted(p);
                                    return;
                                }
                                if (!e.isAlive()) {
                                    await handleEnemyFainted(e);
                                    return;
                                }
                            }
                            if (clashResult.damageMultiplierA > 0) {
                                // ç©å®¶æ‹›å¼å‘½ä¸­ï¼ˆåæ‰‹ï¼Œå¯èƒ½æ˜¯å‰Šå‡åçš„ï¼‰
                                const modifiedPlayerMove = { ...playerMove };
                                modifiedPlayerMove.clashDamageMultiplier = clashResult.damageMultiplierA;
                                const playerResult = await executePlayerTurn(p, e, modifiedPlayerMove);
                                // ã€ä¿®å¤ã€‘æ£€æŸ¥ç©å®¶æ˜¯å¦å› åä¼¤å€’ä¸‹ï¼ˆç²—ç³™çš®è‚¤/é“åˆºç­‰ï¼‰
                                if (!p.isAlive()) {
                                    console.log('[CLASH] Player fainted from recoil damage after clash attack');
                                    if (!e.isAlive()) {
                                        await handleEnemyFainted(e);
                                    }
                                    await handlePlayerFainted(p);
                                    return;
                                }
                                if (!e.isAlive()) {
                                    await handleEnemyFainted(e);
                                    return;
                                }
                            }
                            // å¯¹å†²å®Œæˆï¼Œè·³è¿‡æ­£å¸¸å›åˆæ‰§è¡Œ
                            const currentP = battle.getPlayer();
                            const currentE = battle.getEnemy();
                            await executeEndPhase(currentP, currentE);
                            return;
                        }
                    }
                }
            }
        }
    }
    // === è®¡ç®—è¡ŒåŠ¨é¡ºåº (Priority + Speed) ===
    // æ³¨æ„ï¼šGen7+ è§„åˆ™ï¼ŒMega è¿›åŒ–åé€Ÿåº¦ç«‹å³ç”Ÿæ•ˆ
    const playerPriority = typeof window.getMovePriority === 'function' 
        ? window.getMovePriority(playerMove) : 0;
    const enemyPriority = typeof window.getMovePriority === 'function' 
        ? window.getMovePriority(enemyMove) : 0;
    let playerFirst = true;
    if (playerPriority !== enemyPriority) {
        // ä¼˜å…ˆçº§ä¸åŒï¼Œé«˜ä¼˜å…ˆçº§å…ˆåŠ¨
        playerFirst = playerPriority > enemyPriority;
        console.log(`[Speed Check] Priority differs: P(${playerMove?.name || playerMove?.cn}) prio=${playerPriority} vs E(${enemyMove?.name || enemyMove?.cn}) prio=${enemyPriority} => PlayerFirst? ${playerFirst}`);
    } else {
        // ä¼˜å…ˆçº§ç›¸åŒï¼Œæ¯”è¾ƒé€Ÿåº¦
        let playerSpeed = p.getStat('spe');
        let enemySpeed = e.getStat('spe');
        // =========================================================
        // åœºåœ°çŠ¶æ€å¯¹é€Ÿåº¦çš„å½±å“
        // =========================================================
        // Tailwind (é¡ºé£): é€Ÿåº¦ç¿»å€
        if (battle.playerSide && battle.playerSide.tailwind > 0) {
            playerSpeed *= 2;
            console.log(`[Speed Check] Player has Tailwind! Speed doubled.`);
        }
        if (battle.enemySide && battle.enemySide.tailwind > 0) {
            enemySpeed *= 2;
            console.log(`[Speed Check] Enemy has Tailwind! Speed doubled.`);
        }
        console.log(`[Speed Check] ${p.cnName}(base spe=${p.spe}, effective=${playerSpeed}) vs ${e.cnName}(base spe=${e.spe}, effective=${enemySpeed})`);
        // Trick Room (æˆæ³•ç©ºé—´): é€Ÿåº¦æ…¢çš„å…ˆåŠ¨
        const isTrickRoom = battle.field && battle.field.trickRoom > 0;
        if (playerSpeed !== enemySpeed) {
            if (isTrickRoom) {
                // ç©ºé—´ä¸‹ï¼šæ…¢çš„å…ˆåŠ¨
                playerFirst = playerSpeed < enemySpeed;
                console.log(`[Speed Check] TRICK ROOM active! Slower moves first. PlayerFirst? ${playerFirst}`);
            } else {
                // æ­£å¸¸ï¼šå¿«çš„å…ˆåŠ¨
                playerFirst = playerSpeed > enemySpeed;
            }
        } else {
            // é€Ÿåº¦ç›¸åŒï¼Œéšæœºå†³å®š
            playerFirst = Math.random() < 0.5;
            console.log(`[Speed Check] Same speed, random result: PlayerFirst? ${playerFirst}`);
        }
        console.log(`[Speed Check] Result: PlayerFirst? ${playerFirst}${isTrickRoom ? ' (Trick Room)' : ''}`);
    }
    // === æ‰§è¡Œå›åˆ ===
    // æ­£ç¡®çš„ Pivot æ—¶åºï¼šå…ˆæ‰‹æ”»å‡» -> å…ˆæ‰‹ Pivot æ¢äºº -> åæ‰‹æ”»å‡»æ‰“æ–°æ€ª -> åæ‰‹ Pivot æ¢äºº
    if (playerFirst) {
        // ========== ç©å®¶å…ˆåŠ¨ ==========
        console.log('[handleAttack] Player moves first');
        // =====================================================
        // === ã€å¯¹å†²ç³»ç»Ÿã€‘æ•Œæ–¹åæ‰‹å¯¹å†²æ£€æµ‹ (åœ¨ç©å®¶æ”»å‡»ä¹‹å‰) ===
        // =====================================================
        let enemyClashTriggered = false;
        if (typeof window.aiDecideClash === 'function' && window.GAME_SETTINGS?.enableClash !== false) {
            let pSpeed = (typeof p.getStat === 'function') ? p.getStat('spe') : (p.spe || 100);
            let eSpeed = (typeof e.getStat === 'function') ? e.getStat('spe') : (e.spe || 100);
            if (p.status === 'par') pSpeed = Math.floor(pSpeed * 0.5);
            if (e.status === 'par') eSpeed = Math.floor(eSpeed * 0.5);
            const speedRatio = eSpeed / pSpeed;
            // ã€ä¿®å¤ã€‘æ”¾å®½æ•Œæ–¹ AI å¯¹å†²é˜ˆå€¼ï¼šåªè¦æ•Œæ–¹åæ‰‹ï¼ˆé€Ÿåº¦æ¯” < 1.0ï¼‰å°±å¯ä»¥è€ƒè™‘å¯¹å†²
            // ä¹‹å‰æ˜¯ 0.70 å¤ªä¸¥æ ¼ï¼Œå¯¼è‡´æ•Œæ–¹å‡ ä¹ä¸ä¼šè§¦å‘å¯¹å†²
            const meetsSpeedThreshold = speedRatio < 1.0;
            console.log(`[AI CLASH PRE] æ•Œæ–¹é€Ÿåº¦æ£€æµ‹: ${eSpeed} vs ${pSpeed}, æ¯”ä¾‹=${Math.round(speedRatio * 100)}%, æ»¡è¶³é˜ˆå€¼=${meetsSpeedThreshold}`);
            if (meetsSpeedThreshold) {
                // =====================================================
                // ã€Expert AI è§æ‹›æ‹†æ‹›ã€‘AI åæ‰‹æ—¶é‡æ–°å†³ç­–æœ€ä¼˜æ‹›å¼
                // åªå¯¹ expert éš¾åº¦ç”Ÿæ•ˆï¼Œå…¶ä»–éš¾åº¦ä¸æ”¹å˜æ‹›å¼
                // =====================================================
                let finalEnemyMove = enemyMove;
                if (battle.aiDifficulty === 'expert' && typeof window.getHardAiMove === 'function') {
                    // AI çŸ¥é“ç©å®¶é€‰äº†ä»€ä¹ˆæ‹›å¼ï¼Œé‡æ–°è®¡ç®—æœ€ä¼˜å¯¹å†²æ‹›å¼
                    const recalcMove = window.getHardAiMove(e, p, battle.enemyParty);
                    if (recalcMove && recalcMove.name !== enemyMove.name) {
                        // ã€ä¿®å¤ã€‘æ£€æŸ¥æ•Œæ–¹æ–°æ‹›å¼æ˜¯å¦èƒ½å¯¹å†²ç©å®¶æ‹›å¼
                        // å‚æ•°é¡ºåºï¼š(æ•Œæ–¹, ç©å®¶, æ•Œæ–¹æ‹›å¼, ç©å®¶æ‹›å¼)
                        const newClashCheck = window.canTriggerClash(e, p, recalcMove, playerMove);
                        if (newClashCheck && newClashCheck.canTrigger) {
                            console.log(`[AI COUNTER] Expert AI è§æ‹›æ‹†æ‹›: ${enemyMove.cn || enemyMove.name} â†’ ${recalcMove.cn || recalcMove.name}`);
                            // ã€ä¿®å¤ã€‘ç»§æ‰¿åŸæ‹›å¼çš„ Style ä¿®æ­£åˆ°æ–°æ‹›å¼
                            if (enemyMove.styleUsed) {
                                const styleMod = enemyMove.styleUsed === 'strong' ? 1.30 : (enemyMove.styleUsed === 'agile' ? 0.50 : 1.0);
                                recalcMove.basePower = Math.floor((recalcMove.basePower || recalcMove.power || 0) * styleMod);
                                recalcMove.power = recalcMove.basePower;
                                recalcMove.styleUsed = enemyMove.styleUsed;
                                recalcMove.priority = enemyMove.priority;
                                console.log(`[AI COUNTER] ç»§æ‰¿ Style ä¿®æ­£: ${enemyMove.styleUsed}, å¨åŠ› â†’ ${recalcMove.basePower}`);
                            }
                            finalEnemyMove = recalcMove;
                            enemyMove = recalcMove; // æ›´æ–°å…¨å±€æ•Œæ–¹æ‹›å¼
                        } else {
                            console.log(`[AI COUNTER] Expert AI é‡ç®—æ‹›å¼ ${recalcMove.cn || recalcMove.name} æ— æ³•å¯¹å†² (${newClashCheck?.reason})ï¼Œä¿æŒåŸæ‹›å¼`);
                        }
                    }
                }
                const aiDecision = window.aiDecideClash(e, p, finalEnemyMove, playerMove);
                console.log(`[AI CLASH PRE] ${aiDecision.reason}`);
                if (aiDecision.shouldClash && typeof window.resolveClash === 'function') {
                    // ã€ä¿®å¤ã€‘ä» JSON è¯»å–æ•Œæ–¹è®­ç»ƒå®¶ç†Ÿç»ƒåº¦ï¼Œå¦‚æœæœªè®¾ç½®åˆ™é»˜è®¤ 0
                    const enemyProficiency = battle.enemyTrainerProficiency ?? 0;
                    const enemyTriggerRoll = window.rollClashTrigger ? window.rollClashTrigger(enemyProficiency) : { success: true };
                    if (!enemyTriggerRoll.success) {
                        console.log(`[AI CLASH PRE] æ•Œæ–¹è§¦å‘å¤±è´¥ï¼Œæ”¾å¼ƒå¯¹å†²`);
                        // è§¦å‘å¤±è´¥ï¼Œä¸è¿›è¡Œå¯¹å†²
                    } else {
                        enemyClashTriggered = true;
                    // æ•Œæ–¹å‘èµ·å¯¹å†²ï¼Œå‚æ•°é¡ºåºï¼šæ•Œæ–¹æ‹›å¼ vs ç©å®¶æ‹›å¼ï¼ˆä½¿ç”¨å¯èƒ½è¢«ç¯¡æ”¹çš„æ‹›å¼ï¼‰
                    const clashResult = window.resolveClash(finalEnemyMove, playerMove, e, p);
                    if (clashResult) {
                        console.log(`[AI CLASH PRE] å¯¹å†²ç»“æœ: ${clashResult.resultType}`);
                        // ã€ä¿®å¤ã€‘æ’­æ”¾å¯¹å†²éŸ³æ•ˆ
                        if (typeof window.playSFX === 'function') window.playSFX('CLASH');
                        // ã€ä¿®å¤ã€‘ç»Ÿä¸€ä½¿ç”¨ clashResult.logs æ ¼å¼åŒ–æ—¥å¿—
                        log(`<div style="border: 2px solid #f59e0b; padding: 10px; margin: 10px 0; background: linear-gradient(90deg, rgba(245,158,11,0.1), rgba(245,158,11,0.2), rgba(245,158,11,0.1));">`);
                        clashResult.logs.forEach(msg => log(msg));
                        log(`</div>`);
                        // æ’­æ”¾ç¢°æ’ç‰¹æ•ˆï¼šåŒæ–¹ç²¾çµéœ‡åŠ¨ + ä¸­å¤®çˆ†ç‚¸åœˆ
                        const battleStage = document.querySelector('.battle-stage');
                        if (battleStage) {
                            const playerSprite = document.getElementById('player-sprite');
                            const enemySprite = document.getElementById('enemy-sprite');
                            if (playerSprite) {
                                playerSprite.classList.add('clash-shake');
                                setTimeout(() => playerSprite.classList.remove('clash-shake'), 500);
                            }
                            if (enemySprite) {
                                enemySprite.classList.add('clash-shake');
                                setTimeout(() => enemySprite.classList.remove('clash-shake'), 500);
                            }
                            const impact = document.createElement('div');
                            impact.className = 'clash-impact';
                            battleStage.appendChild(impact);
                            setTimeout(() => impact.remove(), 800);
                        }
                        await wait(1000);
                        // æ ¹æ®å¯¹å†²ç»“æœæ‰§è¡Œæ”»å‡»ï¼ˆåªæœ‰ damageMultiplier > 0 æ‰æ‰§è¡Œï¼‰
                        // ç©å®¶å…ˆåŠ¨ï¼Œæ‰€ä»¥ç©å®¶å…ˆæ”»å‡»ï¼ˆå¦‚æœæœ‰ä¼¤å®³ï¼‰
                        if (clashResult.damageMultiplierB > 0) {
                            const modifiedPlayerMove = { ...playerMove };
                            modifiedPlayerMove.clashDamageMultiplier = clashResult.damageMultiplierB;
                            await executePlayerTurn(p, e, modifiedPlayerMove);
                            // ã€ä¿®å¤ã€‘æ£€æŸ¥ç©å®¶æ˜¯å¦å› åä¼¤å€’ä¸‹ï¼ˆç²—ç³™çš®è‚¤/é“åˆºç­‰ï¼‰
                            if (!p.isAlive()) {
                                console.log('[CLASH] Player fainted from recoil damage after clash attack');
                                // å…ˆæ£€æŸ¥æ˜¯å¦åŒæ–¹åŒæ—¶å€’ä¸‹
                                if (!e.isAlive()) {
                                    await handleEnemyFainted(e);
                                }
                                await handlePlayerFainted(p);
                                return;
                            }
                            if (!e.isAlive()) {
                                await handleEnemyFainted(e);
                                return;
                            }
                        }
                        // æ•Œæ–¹æ”»å‡»ï¼ˆå¦‚æœæœ‰ä¼¤å®³ï¼‰
                        if (clashResult.damageMultiplierA > 0) {
                            const modifiedEnemyMove = { ...enemyMove };
                            modifiedEnemyMove.clashDamageMultiplier = clashResult.damageMultiplierA;
                            await executeEnemyTurn(e, p, modifiedEnemyMove);
                            if (!p.isAlive()) {
                                await handlePlayerFainted(p);
                                return;
                            }
                        }
                        // å¯¹å†²å®Œæˆï¼Œæ‰§è¡Œå›åˆæœ«ç»“ç®—
                        const currentP = battle.getPlayer();
                        const currentE = battle.getEnemy();
                        await executeEndPhase(currentP, currentE);
                        return;
                    }
                    }
                }
            }
        }
        // === æ­£å¸¸æ‰§è¡Œç©å®¶æ”»å‡»ï¼ˆæ²¡æœ‰å¯¹å†²æ—¶ï¼‰===
        const playerResult = await executePlayerTurn(p, e, playerMove);
        // ã€ä¿®å¤ã€‘Post-Move Check: ç©å®¶ä½¿ç”¨è‡ªæ€æ‹›å¼åç«‹å³å¤„ç†å€’ä¸‹
        if (!p.isAlive()) {
            console.log('[handleAttack] Player fainted after self-KO move in player-first branch');
            await handlePlayerFainted(p);
            // ã€ä¿®å¤ã€‘ç©å®¶è‡ªæ€æ‹›å¼åå€’ä¸‹ï¼Œä»éœ€æ‰§è¡Œå›åˆæœ«ç»“ç®—ï¼ˆæ•Œæ–¹æå·¨åŒ– tick ç­‰ï¼‰
            const newP = battle.getPlayer();
            const currentE = battle.getEnemy();
            if (newP && newP.isAlive() && currentE && currentE.isAlive()) {
                await executeEndPhase(newP, currentE);
            }
            return;
        }
        // ã€ä¿®å¤ã€‘U-turn/Volt Switch æ—¶åºï¼šå…ˆå¤„ç† Pivot æ¢äººï¼Œå†å¤„ç†æ•Œæ–¹å€’ä¸‹
        // æ­£ä½œé€»è¾‘ï¼šå³ä½¿å‡»æ€å¯¹æ‰‹ï¼Œä½¿ç”¨è€…ä¹Ÿå¿…é¡»å…ˆæ¢äºº
        if (playerResult?.pivot && hasAliveSwitch(battle.playerParty, battle.playerActive)) {
            const oldP = battle.getPlayer();
            const moveName = playerMove?.name || '';
            if (moveName === 'Volt Switch') {
                log(`${oldP.cnName} ä¼ç‰¹æ›¿æ¢ï¼Œè¿…é€Ÿæ’¤é€€äº†!`);
            } else if (moveName === 'Flip Turn') {
                log(`${oldP.cnName} å¿«é€Ÿç¿»è½¬ï¼Œæ’¤é€€äº†!`);
            } else {
                log(`${oldP.cnName} æ‰“å®Œåæ€¥é€ŸæŠ˜è¿”å›æ¥äº†!`);
            }
            console.log('[handleAttack] Player pivot triggered, waiting for switch...');
            await handlePlayerPivot();
            p = battle.getPlayer();
            console.log('[handleAttack] Player pivot complete, new pokemon:', p?.cnName);
        } else if (playerResult?.pivot) {
            log(`<span style="color:#999">ä½†æ˜¯æ²¡æœ‰å¯ä»¥æ¢å…¥çš„å®å¯æ¢¦äº†!</span>`);
        }
        // æ•Œæ–¹å€’ä¸‹åˆ¤å®šï¼ˆåœ¨ pivot æ¢äººä¹‹åï¼‰
        // ã€å…³é”®ä¿®å¤ã€‘åŒæ—¶æ£€æŸ¥ç©å®¶æ˜¯å¦ä¹Ÿå€’ä¸‹ï¼ˆç²—ç³™çš®è‚¤/é“åˆºç­‰æ¥è§¦ä¼¤å®³å¯¼è‡´åŒæ–¹åŒæ—¶å€’ä¸‹ï¼‰
        if (!e.isAlive()) {
            // å…ˆæ£€æŸ¥ç©å®¶æ˜¯å¦ä¹Ÿå€’ä¸‹
            if (!p.isAlive()) {
                console.log('[handleAttack] DOUBLE KO after player attack (Rough Skin/Iron Barbs)!');
                await handleEnemyFainted(e);
                await handlePlayerFainted(p);
                return;
            }
            await handleEnemyFainted(e);
            // ã€ä¿®å¤ã€‘æ•Œæ–¹å€’ä¸‹æ¢äººåï¼Œä»éœ€æ‰§è¡Œå›åˆæœ«ç»“ç®—ï¼ˆG-Max DOT ç­‰ï¼‰
            const newE = battle.getEnemy();
            if (newE && newE.isAlive()) {
                await executeEndPhase(p, newE);
            }
            return;
        }
        // ========== æ•Œæ–¹ååŠ¨ï¼ˆæ”»å‡»æ–°æ¢å…¥çš„å®å¯æ¢¦ï¼‰ ==========
        // ã€ä¿®å¤ã€‘Pre-Move Check: æ£€æŸ¥æ•Œæ–¹è‡ªå·±æ˜¯å¦è¿˜æ´»ç€ï¼ˆä¸´åˆ«ç¤¼ç‰©/å¤§çˆ†ç‚¸ç­‰è‡ªæ€æ‹›å¼ï¼‰
        if (!e.isAlive()) {
            console.log('[handleAttack] Enemy already fainted (self-KO move like Memento), skipping enemy turn');
            log(`<span style="color:#999">ä½†æ˜¯ ${e.cnName} å·²ç»å€’ä¸‹äº†...</span>`);
            await handleEnemyFainted(e);
            return;
        }
        // ã€æ³¨æ„ã€‘å¯¹å†²æ£€æµ‹å·²ç§»åˆ°ç©å®¶æ”»å‡»ä¹‹å‰ï¼Œè¿™é‡Œç›´æ¥æ‰§è¡Œæ•Œæ–¹æ”»å‡»
        console.log('[handleAttack] Enemy turn starting, move:', enemyMove?.name || enemyMove?.cn);
        const enemyResult = await executeEnemyTurn(e, p, enemyMove);
        console.log('[handleAttack] Enemy turn complete');
        // ã€ä¿®å¤ã€‘Post-Move Check: æ•Œæ–¹ä½¿ç”¨è‡ªæ€æ‹›å¼åç«‹å³å¤„ç†å€’ä¸‹
        // ã€å…³é”®ä¿®å¤ã€‘åŒæ—¶æ£€æŸ¥ç©å®¶æ˜¯å¦ä¹Ÿå€’ä¸‹ï¼ˆåä¼¤/ç²—ç³™çš®è‚¤ç­‰å¯¼è‡´åŒæ–¹åŒæ—¶å€’ä¸‹ï¼‰
        if (!e.isAlive()) {
            console.log('[handleAttack] Enemy fainted after self-KO move (Memento/Explosion/Recoil)');
            // å…ˆæ£€æŸ¥ç©å®¶æ˜¯å¦ä¹Ÿå€’ä¸‹
            if (!p.isAlive()) {
                console.log('[handleAttack] DOUBLE KO: Both player and enemy fainted!');
                // åŒæ–¹åŒæ—¶å€’ä¸‹ï¼šå…ˆå¤„ç†æ•Œæ–¹ï¼Œå†å¤„ç†ç©å®¶æ¢äºº
                await handleEnemyFainted(e);
                await handlePlayerFainted(p);
                return;
            }
            await handleEnemyFainted(e);
            return;
        }
        // ã€ä¿®å¤ã€‘æ•Œæ–¹ Pivot ä¹Ÿè¦å…ˆå¤„ç†ï¼Œå†åˆ¤å®šç©å®¶å€’ä¸‹
        if (enemyResult?.pivot && hasAliveSwitch(battle.enemyParty, battle.enemyActive)) {
            const oldE = battle.getEnemy();
            const moveName = enemyMove?.name || '';
            if (moveName === 'Volt Switch') {
                log(`${oldE.cnName} ä¼ç‰¹æ›¿æ¢ï¼Œè¿…é€Ÿæ’¤é€€äº†!`);
            } else if (moveName === 'Flip Turn') {
                log(`${oldE.cnName} å¿«é€Ÿç¿»è½¬ï¼Œæ’¤é€€äº†!`);
            } else if (moveName === 'Baton Pass') {
                log(`${oldE.cnName} ä½¿ç”¨æ¥åŠ›æ£’æ’¤é€€äº†!`);
            } else {
                log(`${oldE.cnName} æ‰“å®Œåæ€¥é€ŸæŠ˜è¿”å›æ¥äº†!`);
            }
            await handleEnemyPivot(enemyResult?.passBoosts || false);
            e = battle.getEnemy();
        }
        if (!p.isAlive()) {
            await handlePlayerFainted(p);
            // ã€ä¿®å¤ã€‘ç©å®¶å…ˆåŠ¨åˆ†æ”¯ä¸­ï¼Œæ•Œæ–¹æ”»å‡»åç©å®¶å€’ä¸‹ï¼Œä»éœ€æ‰§è¡Œå›åˆæœ«ç»“ç®—ï¼ˆæ•Œæ–¹æå·¨åŒ– tick ç­‰ï¼‰
            const newP = battle.getPlayer();
            const currentE = battle.getEnemy();
            if (newP && newP.isAlive() && currentE && currentE.isAlive()) {
                await executeEndPhase(newP, currentE);
            }
            return;
        }
    } else {
        // ========== æ•Œæ–¹å…ˆåŠ¨ ==========
        const enemyResult = await executeEnemyTurn(e, p, enemyMove);
        // ã€ä¿®å¤ã€‘Post-Move Check: æ•Œæ–¹ä½¿ç”¨è‡ªæ€æ‹›å¼åç«‹å³å¤„ç†å€’ä¸‹
        // ã€å…³é”®ä¿®å¤ã€‘åŒæ—¶æ£€æŸ¥ç©å®¶æ˜¯å¦ä¹Ÿå€’ä¸‹ï¼ˆåä¼¤/ç²—ç³™çš®è‚¤ç­‰å¯¼è‡´åŒæ–¹åŒæ—¶å€’ä¸‹ï¼‰
        if (!e.isAlive()) {
            console.log('[handleAttack] Enemy fainted after self-KO move in enemy-first branch');
            // å…ˆæ£€æŸ¥ç©å®¶æ˜¯å¦ä¹Ÿå€’ä¸‹
            if (!p.isAlive()) {
                console.log('[handleAttack] DOUBLE KO in enemy-first branch!');
                await handleEnemyFainted(e);
                await handlePlayerFainted(p);
                return;
            }
            await handleEnemyFainted(e);
            return;
        }
        // ã€ä¿®å¤ã€‘æ•Œæ–¹ Pivot å…ˆå¤„ç†ï¼Œå†åˆ¤å®šç©å®¶å€’ä¸‹
        if (enemyResult?.pivot && hasAliveSwitch(battle.enemyParty, battle.enemyActive)) {
            const oldE = battle.getEnemy();
            const moveName = enemyMove?.name || '';
            if (moveName === 'Volt Switch') {
                log(`${oldE.cnName} ä¼ç‰¹æ›¿æ¢ï¼Œè¿…é€Ÿæ’¤é€€äº†!`);
            } else if (moveName === 'Flip Turn') {
                log(`${oldE.cnName} å¿«é€Ÿç¿»è½¬ï¼Œæ’¤é€€äº†!`);
            } else if (moveName === 'Baton Pass') {
                log(`${oldE.cnName} ä½¿ç”¨æ¥åŠ›æ£’æ’¤é€€äº†!`);
            } else {
                log(`${oldE.cnName} æ‰“å®Œåæ€¥é€ŸæŠ˜è¿”å›æ¥äº†!`);
            }
            await handleEnemyPivot(enemyResult?.passBoosts || false);
            e = battle.getEnemy();
        }
        if (!p.isAlive()) {
            await handlePlayerFainted(p);
            // ã€ä¿®å¤ã€‘ç©å®¶å€’ä¸‹æ¢äººåï¼Œä»éœ€æ‰§è¡Œå›åˆæœ«ç»“ç®—ï¼ˆæ•Œæ–¹æå·¨åŒ– tick ç­‰ï¼‰
            const newP = battle.getPlayer();
            const currentE = battle.getEnemy();
            if (newP && newP.isAlive() && currentE && currentE.isAlive()) {
                await executeEndPhase(newP, currentE);
            }
            return;
        }
        // ========== ç©å®¶ååŠ¨ï¼ˆæ”»å‡»æ–°æ¢å…¥çš„å®å¯æ¢¦ï¼‰ ==========
        // ã€ä¿®å¤ã€‘Pre-Move Check: æ£€æŸ¥ç©å®¶è‡ªå·±æ˜¯å¦è¿˜æ´»ç€ï¼ˆä¸´åˆ«ç¤¼ç‰©/å¤§çˆ†ç‚¸ç­‰è‡ªæ€æ‹›å¼ï¼‰
        if (!p.isAlive()) {
            console.log('[handleAttack] Player already fainted (self-KO move), skipping player turn');
            log(`<span style="color:#999">ä½†æ˜¯ ${p.cnName} å·²ç»å€’ä¸‹äº†...</span>`);
            await handlePlayerFainted(p);
            // ã€ä¿®å¤ã€‘ç©å®¶å€’ä¸‹æ¢äººåï¼Œä»éœ€æ‰§è¡Œå›åˆæœ«ç»“ç®—
            const newP2 = battle.getPlayer();
            const currentE2 = battle.getEnemy();
            if (newP2 && newP2.isAlive() && currentE2 && currentE2.isAlive()) {
                await executeEndPhase(newP2, currentE2);
            }
            return;
        }
        // ã€ä¿®å¤ã€‘Pre-Move Check: æ£€æŸ¥ç›®æ ‡æ˜¯å¦è¿˜æ´»ç€ï¼ˆæ•Œæ–¹å¯èƒ½ç”¨äº†è‡ªæ€æ‹›å¼ï¼‰
        if (!e.isAlive()) {
            console.log('[handleAttack] Enemy already fainted before player turn, skipping to faint handling');
            log(`<span style="color:#999">ä½†æ˜¯æ²¡æœ‰ç›®æ ‡äº†...</span>`);
            await handleEnemyFainted(e);
            return;
        }
        // ã€ä¿®å¤ã€‘æ•Œæ–¹å…ˆåŠ¨åï¼Œç©å®¶ååŠ¨å‰å†æ¬¡æ£€æŸ¥ Taunt ç­‰ Volatile çŠ¶æ€
        // å› ä¸ºæ•Œæ–¹å¯èƒ½åœ¨è¿™å›åˆä½¿ç”¨äº†æŒ‘è¡…ï¼Œé˜»æ­¢ç©å®¶ä½¿ç”¨å˜åŒ–æŠ€
        if (typeof MoveEffects !== 'undefined' && MoveEffects.canUseMove) {
            const canUseResult = MoveEffects.canUseMove(p, playerMove);
            if (!canUseResult.canUse) {
                log(`<span style="color:#e74c3c">${canUseResult.reason}</span>`);
                await wait(500);
                // è·³è¿‡ç©å®¶è¡ŒåŠ¨ï¼Œç›´æ¥è¿›å…¥å›åˆç»“ç®—
                await executeEndPhase(p, e);
                battle.locked = false;
                return;
            }
        }
        const playerResult = await executePlayerTurn(p, e, playerMove);
        // ã€ä¿®å¤ã€‘Post-Move Check: ç©å®¶ä½¿ç”¨è‡ªæ€æ‹›å¼åç«‹å³å¤„ç†å€’ä¸‹
        if (!p.isAlive()) {
            console.log('[handleAttack] Player fainted after self-KO move in enemy-first branch');
            await handlePlayerFainted(p);
            // ã€ä¿®å¤ã€‘ç©å®¶è‡ªæ€æ‹›å¼åå€’ä¸‹ï¼Œä»éœ€æ‰§è¡Œå›åˆæœ«ç»“ç®—ï¼ˆæ•Œæ–¹æå·¨åŒ– tick ç­‰ï¼‰
            const newP = battle.getPlayer();
            const currentE = battle.getEnemy();
            if (newP && newP.isAlive() && currentE && currentE.isAlive()) {
                await executeEndPhase(newP, currentE);
            }
            return;
        }
        // ã€ä¿®å¤ã€‘ç©å®¶ Pivot å…ˆå¤„ç†ï¼Œå†åˆ¤å®šæ•Œæ–¹å€’ä¸‹
        if (playerResult?.pivot && hasAliveSwitch(battle.playerParty, battle.playerActive)) {
            const oldP = battle.getPlayer();
            const moveName = playerMove?.name || '';
            if (moveName === 'Volt Switch') {
                log(`${oldP.cnName} ä¼ç‰¹æ›¿æ¢ï¼Œè¿…é€Ÿæ’¤é€€äº†!`);
            } else if (moveName === 'Flip Turn') {
                log(`${oldP.cnName} å¿«é€Ÿç¿»è½¬ï¼Œæ’¤é€€äº†!`);
            } else {
                log(`${oldP.cnName} æ‰“å®Œåæ€¥é€ŸæŠ˜è¿”å›æ¥äº†!`);
            }
            await handlePlayerPivot();
            p = battle.getPlayer();
        } else if (playerResult?.pivot) {
            log(`<span style="color:#999">ä½†æ˜¯æ²¡æœ‰å¯ä»¥æ¢å…¥çš„å®å¯æ¢¦äº†!</span>`);
        }
        // ã€å…³é”®ä¿®å¤ã€‘åŒæ—¶æ£€æŸ¥ç©å®¶æ˜¯å¦ä¹Ÿå€’ä¸‹ï¼ˆç²—ç³™çš®è‚¤/é“åˆºç­‰æ¥è§¦ä¼¤å®³å¯¼è‡´åŒæ–¹åŒæ—¶å€’ä¸‹ï¼‰
        if (!e.isAlive()) {
            // å…ˆæ£€æŸ¥ç©å®¶æ˜¯å¦ä¹Ÿå€’ä¸‹
            if (!p.isAlive()) {
                console.log('[handleAttack] DOUBLE KO after player attack in enemy-first branch!');
                await handleEnemyFainted(e);
                await handlePlayerFainted(p);
                return;
            }
            await handleEnemyFainted(e);
            // ã€ä¿®å¤ã€‘æ•Œæ–¹å€’ä¸‹æ¢äººåï¼Œä»éœ€æ‰§è¡Œå›åˆæœ«ç»“ç®—ï¼ˆG-Max DOT ç­‰ï¼‰
            const newE = battle.getEnemy();
            if (newE && newE.isAlive()) {
                await executeEndPhase(p, newE);
            }
            return;
        }
    }
    // === å›åˆæœ«ç»“ç®— ===
    // é‡æ–°è·å–æœ€æ–°å¼•ç”¨ï¼ˆpivot æ¢äººåå¯èƒ½å·²å˜åŒ–ï¼‰
    const currentP = battle.getPlayer();
    const currentE = battle.getEnemy();
    await executeEndPhase(currentP, currentE);
}
// ============================================
// ã€å·²è¿ç§»ã€‘å›åˆæ‰§è¡Œ -> battle/battle-turns.js
// ============================================
// ============================================
// ã€å·²è¿ç§»ã€‘æ¢äººç³»ç»Ÿ -> battle/battle-switch.js
// ============================================
// ã€å·²è¿ç§»ã€‘handleEnemyFainted -> battle/battle-switch.js
// ã€å·²è¿ç§»ã€‘handlePlayerFainted -> battle/battle-switch.js
// ã€å·²è¿ç§»ã€‘enemyTurn -> battle/battle-turns.js
// ã€å·²è¿ç§»ã€‘triggerEntryAbilities -> battle/battle-switch.js
/**
 * å›åˆæœ«ç»“ç®—
 */
async function executeEndPhase(p, e) {
    console.log('[executeEndPhase] Starting with:', p?.cnName, 'vs', e?.cnName);
    try {
        await wait(300);
        // å®‰å…¨æ£€æŸ¥
        if (!p || !e) {
            console.warn('[executeEndPhase] Invalid pokemon reference:', { p, e });
            battle.locked = false;
            return;
        }
        if (typeof window.getEndTurnStatusLogs === 'function') {
        // ç»“ç®—ç©å®¶çš„çŠ¶æ€ä¼¤å®³ï¼ˆisPlayerPoke = trueï¼ŒAVs æ•ˆæœç”Ÿæ•ˆï¼‰
        if (p.isAlive()) {
            const pLogs = window.getEndTurnStatusLogs(p, e, true);
            if (pLogs.length > 0) {
                pLogs.forEach(txt => {
                    // Devotion æ²»æ„ˆæ—¥å¿—å·²ç»æœ‰æ ·å¼ï¼Œç›´æ¥è¾“å‡º
                    if (txt.includes('Devotion')) {
                        log(txt);
                    } else {
                        log(`<span style="color:#d35400">${txt}</span>`);
                    }
                });
                updateAllVisuals();
                await wait(400);
                if (!p.isAlive()) {
                    await handlePlayerFainted(p);
                    return;
                }
            }
        }
        // ç»“ç®—æ•Œæ–¹çš„çŠ¶æ€ä¼¤å®³ï¼ˆisPlayerPoke = falseï¼ŒAVs æ•ˆæœä¸ç”Ÿæ•ˆï¼‰
        if (e.isAlive()) {
            const eLogs = window.getEndTurnStatusLogs(e, p, false);
            if (eLogs.length > 0) {
                eLogs.forEach(txt => {
                    // Devotion æ²»æ„ˆæ—¥å¿—å·²ç»æœ‰æ ·å¼ï¼Œç›´æ¥è¾“å‡º
                    if (txt.includes('Devotion')) {
                        log(txt);
                    } else {
                        log(`<span style="color:#d35400">${txt}</span>`);
                    }
                });
                updateAllVisuals();
                await wait(400);
                if (!e.isAlive()) {
                    await handleEnemyFainted(e);
                    return;
                }
            }
        }
    }
    // =========================================================
    // G-Max æŒç»­ä¼¤å®³æ•ˆæœ (Wildfire/Vine Lash/Cannonade/Volcalith)
    // =========================================================
    const applyGMaxDOT = async (pokemon, side, isPlayer) => {
        if (!pokemon || !pokemon.isAlive() || !side) return;
        const types = pokemon.types || [];
        const dotDamage = Math.max(1, Math.floor(pokemon.maxHp / 6));
        // G-Max Wildfire (ç«) - éç«å±æ€§å—ä¼¤
        if (side.gmaxWildfire && side.gmaxWildfire.turns > 0) {
            if (!types.includes('Fire')) {
                pokemon.currHp = Math.max(0, pokemon.currHp - dotDamage);
                log(`<span style="color:#ef4444">ğŸ”¥ ${pokemon.cnName} è¢«åœ°ç‹±ç­ç„°ç¼çƒ§ï¼(-${dotDamage})</span>`);
                updateAllVisuals();
                await wait(300);
            }
            side.gmaxWildfire.turns--;
            if (side.gmaxWildfire.turns <= 0) {
                log(`<span style="color:#94a3b8">ğŸ”¥ åœ°ç‹±ç­ç„°æ¶ˆæ•£äº†ã€‚</span>`);
                delete side.gmaxWildfire;
            }
        }
        // G-Max Vine Lash (è‰) - éè‰å±æ€§å—ä¼¤
        if (side.gmaxVineLash && side.gmaxVineLash.turns > 0) {
            if (!types.includes('Grass')) {
                pokemon.currHp = Math.max(0, pokemon.currHp - dotDamage);
                log(`<span style="color:#22c55e">ğŸŒ¿ ${pokemon.cnName} è¢«è—¤è”“ç¼ ç»•ï¼(-${dotDamage})</span>`);
                updateAllVisuals();
                await wait(300);
            }
            side.gmaxVineLash.turns--;
            if (side.gmaxVineLash.turns <= 0) {
                log(`<span style="color:#94a3b8">ğŸŒ¿ ç°é£é­ç­æ¶ˆæ•£äº†ã€‚</span>`);
                delete side.gmaxVineLash;
            }
        }
        // G-Max Cannonade (æ°´) - éæ°´å±æ€§å—ä¼¤
        if (side.gmaxCannonade && side.gmaxCannonade.turns > 0) {
            if (!types.includes('Water')) {
                pokemon.currHp = Math.max(0, pokemon.currHp - dotDamage);
                log(`<span style="color:#3b82f6">ğŸ’§ ${pokemon.cnName} è¢«æ¿€æµå†²å‡»ï¼(-${dotDamage})</span>`);
                updateAllVisuals();
                await wait(300);
            }
            side.gmaxCannonade.turns--;
            if (side.gmaxCannonade.turns <= 0) {
                log(`<span style="color:#94a3b8">ğŸ’§ æ°´ç‚®è½°ç­æ¶ˆæ•£äº†ã€‚</span>`);
                delete side.gmaxCannonade;
            }
        }
        // G-Max Volcalith (å²©) - éå²©å±æ€§å—ä¼¤
        if (side.gmaxVolcalith && side.gmaxVolcalith.turns > 0) {
            if (!types.includes('Rock')) {
                pokemon.currHp = Math.max(0, pokemon.currHp - dotDamage);
                log(`<span style="color:#f97316">ï¿½ite ${pokemon.cnName} è¢«ç‚½çƒ­å²©çŸ³ç¼ä¼¤ï¼(-${dotDamage})</span>`);
                updateAllVisuals();
                await wait(300);
            }
            side.gmaxVolcalith.turns--;
            if (side.gmaxVolcalith.turns <= 0) {
                log(`<span style="color:#94a3b8">ğŸª¨ ç‚çŸ³å–·å‘æ¶ˆæ•£äº†ã€‚</span>`);
                delete side.gmaxVolcalith;
            }
        }
        // æ£€æŸ¥æ˜¯å¦å›  DOT å€’ä¸‹
        if (!pokemon.isAlive()) {
            if (isPlayer) {
                await handlePlayerFainted(pokemon);
            } else {
                await handleEnemyFainted(pokemon);
            }
            return true; // è¡¨ç¤ºæœ‰å®å¯æ¢¦å€’ä¸‹
        }
        return false;
    };
    // ç©å®¶åœºåœ°çš„ G-Max DOT (æ•Œæ–¹æ–½åŠ çš„æ•ˆæœä½œç”¨äºç©å®¶)
    if (p && p.isAlive() && battle.playerSide) {
        const fainted = await applyGMaxDOT(p, battle.playerSide, true);
        if (fainted) return;
    }
    // æ•Œæ–¹åœºåœ°çš„ G-Max DOT (ç©å®¶æ–½åŠ çš„æ•ˆæœä½œç”¨äºæ•Œæ–¹)
    if (e && e.isAlive() && battle.enemySide) {
        const fainted = await applyGMaxDOT(e, battle.enemySide, false);
        if (fainted) return;
    }
    // å¢åŠ åŒæ–¹ä¸Šåœºå›åˆæ•°ï¼ˆç”¨äº Fake Out ç­‰é¦–å›åˆé™åˆ¶æŠ€èƒ½ï¼‰
    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºå®ˆä½ç±»æŠ€èƒ½ï¼ˆæ•°æ®é©±åŠ¨ï¼‰
    const isProtectMove = (moveName) => {
        if (!moveName) return false;
        const moveId = moveName.toLowerCase().replace(/[^a-z0-9]/g, '');
        const moveData = (typeof MOVES !== 'undefined' && MOVES[moveId]) ? MOVES[moveId] : null;
        return moveData?.stallingMove || false;
    };
    if (p && p.isAlive()) {
        p.turnsOnField = (p.turnsOnField || 0) + 1;
        // é‡ç½®å®ˆä½è®¡æ•°å™¨ï¼ˆå¦‚æœä¸Šå›åˆæ²¡ç”¨å®ˆä½ç±»æŠ€èƒ½ï¼‰
        if (!isProtectMove(p.lastMoveUsed)) {
            p.protectCounter = 0;
        }
        // === ã€ä¿®å¤ã€‘é€’å‡ Volatile çŠ¶æ€è®¡æ•°å™¨ (Taunt, Disable ç­‰) ===
        if (typeof MoveEffects !== 'undefined' && MoveEffects.tickVolatileStatus) {
            const volatileLogs = MoveEffects.tickVolatileStatus(p);
            volatileLogs.forEach(txt => log(txt));
            // ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥ç­äº¡ä¹‹æ­Œç­‰æ•ˆæœæ˜¯å¦å¯¼è‡´ç©å®¶å€’ä¸‹
            if (!p.isAlive()) {
                updateAllVisuals();
                await handlePlayerFainted(p);
                return; // ç©å®¶å€’ä¸‹ï¼Œç»ˆæ­¢å›åˆæœ«ç»“ç®—
            }
        }
        // === ã€æ–°å¢ã€‘é“å…·å›åˆæœ«æ•ˆæœ (å‰§æ¯’å®ç ã€ç«ç„°å®ç ã€å‰©é¥­ç­‰) ===
        if (typeof MoveEffects !== 'undefined' && MoveEffects.processEndTurnItemEffects) {
            const itemLogs = MoveEffects.processEndTurnItemEffects(p);
            itemLogs.forEach(txt => log(txt));
            if (itemLogs.length > 0) updateAllVisuals();
        }
    }
    if (e && e.isAlive()) {
        e.turnsOnField = (e.turnsOnField || 0) + 1;
        // é‡ç½®å®ˆä½è®¡æ•°å™¨ï¼ˆå¦‚æœä¸Šå›åˆæ²¡ç”¨å®ˆä½ç±»æŠ€èƒ½ï¼‰
        if (!isProtectMove(e.lastMoveUsed)) {
            e.protectCounter = 0;
        }
        // === ã€ä¿®å¤ã€‘é€’å‡ Volatile çŠ¶æ€è®¡æ•°å™¨ (Taunt, Disable ç­‰) ===
        if (typeof MoveEffects !== 'undefined' && MoveEffects.tickVolatileStatus) {
            const volatileLogs = MoveEffects.tickVolatileStatus(e);
            volatileLogs.forEach(txt => log(txt));
            // ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥ç­äº¡ä¹‹æ­Œç­‰æ•ˆæœæ˜¯å¦å¯¼è‡´æ•Œæ–¹å€’ä¸‹
            if (!e.isAlive()) {
                updateAllVisuals();
                await handleEnemyFainted(e);
                return; // æ•Œæ–¹å€’ä¸‹ï¼Œç»ˆæ­¢å›åˆæœ«ç»“ç®—
            }
        }
        // === ã€æ–°å¢ã€‘é“å…·å›åˆæœ«æ•ˆæœ (å‰§æ¯’å®ç ã€ç«ç„°å®ç ã€å‰©é¥­ç­‰) ===
        if (typeof MoveEffects !== 'undefined' && MoveEffects.processEndTurnItemEffects) {
            const itemLogs = MoveEffects.processEndTurnItemEffects(e);
            itemLogs.forEach(txt => log(txt));
            if (itemLogs.length > 0) updateAllVisuals();
        }
    }
    // =========================================================
    // ç‰¹æ€§å›åˆæœ«æ•ˆæœ (Speed Boost, Slow Start ç­‰)
    // =========================================================
    if (typeof AbilityHandlers !== 'undefined') {
        // ç©å®¶ç‰¹æ€§å›åˆæœ«æ•ˆæœ
        if (p && p.isAlive() && p.ability) {
            const pAbilityHandler = AbilityHandlers[p.ability];
            if (pAbilityHandler && pAbilityHandler.onEndTurn) {
                const abilityLogs = [];
                pAbilityHandler.onEndTurn(p, abilityLogs);
                abilityLogs.forEach(txt => log(txt));
                if (abilityLogs.length > 0) updateAllVisuals();
            }
        }
        // æ•Œæ–¹ç‰¹æ€§å›åˆæœ«æ•ˆæœ
        if (e && e.isAlive() && e.ability) {
            const eAbilityHandler = AbilityHandlers[e.ability];
            if (eAbilityHandler && eAbilityHandler.onEndTurn) {
                const abilityLogs = [];
                eAbilityHandler.onEndTurn(e, abilityLogs);
                abilityLogs.forEach(txt => log(txt));
                if (abilityLogs.length > 0) updateAllVisuals();
            }
        }
    }
    // =========================================================
    // HP é˜ˆå€¼å½¢æ€å˜åŒ– (Zen Mode, Schooling, Power Construct ç­‰)
    // =========================================================
    if (typeof window.checkHPThresholdTransform === 'function') {
        // ç©å®¶ HP é˜ˆå€¼å˜èº«
        if (p && p.isAlive()) {
            const pFormResult = window.checkHPThresholdTransform(p);
            if (pFormResult && pFormResult.success) {
                const formName = pFormResult.newName || p.cnName;
                log(`<span style="color:#f59e0b">ğŸ”„ ${formName} çš„å½¢æ€å‘ç”Ÿäº†å˜åŒ–ï¼</span>`);
                updateAllVisuals();
                await wait(500);
            }
        }
        // æ•Œæ–¹ HP é˜ˆå€¼å˜èº«
        if (e && e.isAlive()) {
            const eFormResult = window.checkHPThresholdTransform(e);
            if (eFormResult && eFormResult.success) {
                const formName = eFormResult.newName || e.cnName;
                log(`<span style="color:#f59e0b">ğŸ”„ ${formName} çš„å½¢æ€å‘ç”Ÿäº†å˜åŒ–ï¼</span>`);
                updateAllVisuals();
                await wait(500);
            }
        }
    }
    // ã€å¤æ­¦ç³»ç»Ÿã€‘é£æ ¼å†·å´å·²ç§»è‡³ handleAttack å¼€å§‹æ—¶é€’å‡ï¼Œæ­¤å¤„ä¸å†å¤„ç†
    // =========================================================
    // æå·¨åŒ–å›åˆå€’è®¡æ—¶ (Dynamax Turn Tick) - ç»Ÿä¸€è°ƒç”¨ dynamax.js
    // =========================================================
    // ç©å®¶æå·¨åŒ–
    if (p && p.isAlive() && p.isDynamaxed && p.dynamaxTurns > 0) {
        const result = await processDynamaxEndTurn(p, true, log);
        result.logs.forEach(msg => log(msg));
        if (result.ended) {
            await endDynamaxAnimation(p, true);
            const originalSpriteUrl = p.getSprite(true);
            smartLoadSprite('player-sprite', originalSpriteUrl, true);
            updateAllVisuals();
            await wait(500);
        }
    }
    // æ•Œæ–¹æå·¨åŒ–
    if (e && e.isAlive() && e.isDynamaxed && e.dynamaxTurns > 0) {
        const result = await processDynamaxEndTurn(e, false, log);
        result.logs.forEach(msg => log(msg));
        if (result.ended) {
            await endDynamaxAnimation(e, false);
            const originalSpriteUrl = e.getSprite(false);
            smartLoadSprite('enemy-sprite', originalSpriteUrl, false);
            updateAllVisuals();
            await wait(500);
        }
    }
    // =========================================================
    // åœºåœ°çŠ¶æ€å€’è®¡æ—¶ (Field Condition Tick)
    // =========================================================
    if (battle.tickFieldConditions) {
        const fieldLogs = battle.tickFieldConditions();
        if (fieldLogs && fieldLogs.length > 0) {
            for (const txt of fieldLogs) {
                log(`<span style="color:#a78bfa">${txt}</span>`);
            }
            await wait(300);
        }
    }
    // =========================================================
    // ã€SåŒºç‰¹æ•ˆã€‘Defog æ¸…é™¤è¿·é›¾æ•ˆæœå€’è®¡æ—¶ - 3å›åˆåæ¢å¤
    // =========================================================
    if (battle.defogCleanse && battle.defogCleanse.turnsRemaining > 0) {
        battle.defogCleanse.turnsRemaining--;
        if (battle.defogCleanse.turnsRemaining <= 0) {
            // æ¢å¤è¿·é›¾å¤©æ°”
            battle.weather = battle.defogCleanse.originalWeather || 'fog';
            battle.weatherTurns = 0; // ç¯å¢ƒå¤©æ°”æ— é™æŒç»­
            delete battle.defogCleanse;
            log(`<span style="color:#6b7280">ğŸŒ«ï¸ æš—å½±å†æ¬¡å‡èš...è¿·é›¾é‡æ–°ç¬¼ç½©äº†æˆ˜åœºï¼</span>`);
            // æ›´æ–°å¤©æ°”è§†è§‰æ•ˆæœ
            if (typeof setWeatherVisuals === 'function') {
                setWeatherVisuals('fog');
            }
            await wait(500);
        } else {
            log(`<span style="color:#94a3b8">ï¼ˆè¿·é›¾å°†åœ¨ ${battle.defogCleanse.turnsRemaining} å›åˆåæ¢å¤...ï¼‰</span>`);
        }
    }
    // ã€æˆ˜æœ¯æŒ‡æŒ¥ç³»ç»Ÿã€‘å›åˆç»“æŸæ—¶æ¸…ç†æŒ‡ä»¤çŠ¶æ€
    if (typeof clearCommandEffects === 'function') {
        clearCommandEffects();
    }
    battle.locked = false;
    console.log('[executeEndPhase] Complete, battle.locked = false');
    } catch (err) {
        console.error('[executeEndPhase] Error:', err);
        battle.locked = false;
    }
}
// å¯¼å‡º executeEndPhase ä¾› battle-switch.js è°ƒç”¨
window.executeEndPhase = executeEndPhase;
// ============================================
// ã€å·²è¿ç§»ã€‘ä¼¤å®³ç³»ç»Ÿ -> battle/battle-damage.js
// ============================================
/**
 * ===========================================
 * Part C: Switch System (Manual & Forced)
 * ===========================================
 */
function checkPlayerDefeatOrForceSwitch() {
    // ã€é˜²æ­¢é‡å¤åˆ¤å®šã€‘å¦‚æœå·²ç»åˆ¤å®šè¿‡èƒœè´Ÿï¼Œç›´æ¥è¿”å›
    if (battle.battleEndDetermined) {
        console.log('[checkPlayerDefeatOrForceSwitch] èƒœè´Ÿå·²åˆ¤å®šï¼Œè·³è¿‡');
        return Promise.resolve('already_determined');
    }
    const battleEnd = battle.checkBattleEnd();
    if (battleEnd === 'loss') {
        battle.battleEndDetermined = true;
        log(" <b style='color:#e74c3c'>... ä½ è¾“äº†.</b>");
        if (battle.trainer && battle.trainer.id !== 'wild' && battle.trainer.lines?.win) {
            log(`<i>${battle.trainer.name}: "${battle.trainer.lines.win}"</i>`);
        } else if (battle.scriptedResult === 'loss' && battle.trainer) {
            log(`<i>"æ­£å¦‚æˆ‘æ‰€é¢„æ–™çš„..." ${battle.trainer.name}è½»å£°è¯´é“ã€‚</i>`);
        }
        setTimeout(() => battleEndSequence('loss'), 2000);
        return Promise.resolve('loss');
    } else if (battleEnd === 'win') {
        // ã€åŒå‘½åŒæ€ã€‘å¯èƒ½åœ¨è¿™é‡Œè§¦å‘ï¼ˆç©å®¶å€’ä¸‹ä½†æ•Œæ–¹ä¹Ÿå…¨ç­ï¼Œä¸”åŒå‘½è€…æ˜¯æ•Œæ–¹ï¼‰
        battle.battleEndDetermined = true;
        log("ğŸ† <b style='color:#27ae60'>æ•Œæ–¹å…¨éƒ¨æˆ˜è´¥ï¼ä½ èµ¢äº†ï¼</b>");
        const t = battle.trainer;
        if (t && t.id !== 'wild' && t.lines?.lose) {
            log(`<i>${t.name}: "${t.lines.lose}"</i>`);
        }
        setTimeout(() => battleEndSequence('win'), 2000);
        return Promise.resolve('win');
    }
    // å¼ºåˆ¶æ¢äºº - è¿”å› Promise ç­‰å¾…ç©å®¶é€‰æ‹©
    battle.phase = 'force_switch';
    renderSwitchMenu(false);
    // ã€å…³é”®ä¿®å¤ã€‘è¿”å› Promiseï¼Œç­‰å¾…ç©å®¶å®Œæˆæ¢äºº
    return new Promise((resolve) => {
        battle.forceSwitchResolve = resolve;
    });
}
// æ¸²æŸ“åˆ‡æ¢åˆ—è¡¨
function renderSwitchMenu(allowCancel = true) {
    if (battle.locked && battle.phase !== 'force_switch' && battle.phase !== 'pivot_switch') return;
    // ã€æŠ“äººæœºåˆ¶ã€‘æ£€æŸ¥æ˜¯å¦è¢«å›°ä½ï¼ˆå¼ºåˆ¶æ¢äººå’Œ Pivot æ¢äººé™¤å¤–ï¼‰
    if (allowCancel && battle.phase !== 'force_switch' && battle.phase !== 'pivot_switch') {
        if (typeof window.canPlayerSwitch === 'function') {
            const switchCheck = window.canPlayerSwitch();
            if (!switchCheck.canSwitch) {
                log(`<span style="color:#ef4444">${switchCheck.reason}</span>`);
                return;
            }
        }
    }
    const layer = document.getElementById('switch-menu-layer');
    layer.className = 'overlay-modal modern-layer';
    layer.classList.remove('hidden');
    layer.style.display = 'flex';
    layer.innerHTML = '';
    const container = document.createElement('div');
    container.className = 'switch-container-modern';
    const header = document.createElement('div');
    header.className = 'switch-header-modern';
    const actionColor = !allowCancel ? 'var(--primary-pink)' : 'var(--accent-blue)';
    header.innerHTML = `
        <div style="width:6px; height:40px; background:${actionColor}; border-radius:10px;"></div>
        <div>
            <h2>pokÃ©mon</h2>
            <div class="switch-header-subtitle">
                ${!allowCancel ? 'Choose a replacement (Must Switch)' : 'Select a partner to switch in'}
            </div>
        </div>
    `;
    const grid = document.createElement('div');
    grid.className = 'party-grid-modern';
    battle.playerParty.forEach((pm, idx) => {
        const card = document.createElement('div');
        const isCurrent = (idx === battle.playerActive);
        const isDead = (pm.currHp <= 0);
        const hpRatio = pm.maxHp ? (pm.currHp / pm.maxHp) : 0;
        card.className = 'party-card-modern';
        card.style.animationDelay = `${idx * 0.05}s`;
        if (isCurrent) card.classList.add('current');
        if (isDead) card.classList.add('dead');
        if (!allowCancel && isDead) card.classList.add('disabled');
        let hpColor = '#4fd1c5';
        if (hpRatio < 0.5) hpColor = '#fbc63e';
        if (hpRatio <= 0.2) hpColor = '#ff6b6b';
        // =========================================================
        // æ•°æ®é©±åŠ¨çš„ Sprite URL ç”Ÿæˆ
        // ä½¿ç”¨ pokedex-data.js ä¸­çš„ forme å­—æ®µåˆ¤æ–­å½¢æ€ç±»å‹
        // =========================================================
        const seedIdWithHyphen = pm.name.toLowerCase().replace(/[^a-z0-9-]/g, '');
        const seedIdCompact = pm.name.toLowerCase().replace(/[^a-z0-9]/g, '');
        // ä» pokedex-data.js è·å–å®å¯æ¢¦æ•°æ®
        const pokeData = (typeof POKEDEX !== 'undefined' && POKEDEX[seedIdCompact]) 
            ? POKEDEX[seedIdCompact] : null;
        const forme = pokeData?.forme || '';
        const baseSpecies = pokeData?.baseSpecies || '';
        // åŸºç¡€å½¢æ€ IDï¼ˆç”¨äº fallbackï¼‰
        const baseId = baseSpecies ? baseSpecies.toLowerCase().replace(/[^a-z0-9]/g, '') : seedIdCompact;
        const fallbackId = typeof getFallbackSpriteId === 'function' 
            ? getFallbackSpriteId(pm.name) 
            : baseId;
        // =========================================================
        // å½¢æ€ç±»å‹æ£€æµ‹ï¼ˆæ•°æ®é©±åŠ¨ + åç§°æ£€æµ‹åŒä¿é™©ï¼‰
        // =========================================================
        const formeLower = forme.toLowerCase();
        // åœ°åŒºå½¢æ€ï¼šAlola, Galar, Hisui, Paldea
        const regionalForms = ['alola', 'galar', 'hisui', 'paldea'];
        const isRegionalForm = regionalForms.some(r => formeLower.includes(r)) ||
            regionalForms.some(r => seedIdWithHyphen.includes(`-${r}`));
        // Mega å½¢æ€
        const isMegaForm = formeLower.includes('mega') || seedIdWithHyphen.includes('-mega');
        // åŸå§‹å›å½’å½¢æ€
        const isPrimalForm = formeLower === 'primal' || seedIdWithHyphen.includes('-primal');
        // ç‹å† å½¢æ€ï¼ˆZacian/Zamazentaï¼‰
        const isCrownedForm = formeLower === 'crowned' || seedIdWithHyphen.includes('-crowned');
        // ç©¶æå½¢æ€ï¼ˆNecrozmaï¼‰
        const isUltraForm = formeLower === 'ultra' || seedIdWithHyphen.includes('-ultra');
        // ç‰¹æ®Šå½¢æ€ï¼šRotom, Necrozma åˆä½“, Calyrex éª‘ä¹˜, Darmanitan Zen ç­‰
        const specialForms = ['wash', 'heat', 'mow', 'frost', 'fan', // Rotom
            'dusk-mane', 'dawn-wings', // Necrozma
            'ice', 'shadow', // Calyrex
            'zen', 'therian', 'origin', 'sky', 'attack', 'defense', 'speed', // å„ç§å½¢æ€
            'combat', 'blaze', 'aqua']; // Tauros-Paldea
        const isOtherSpecialForm = specialForms.some(f => formeLower.includes(f)) ||
            specialForms.some(f => seedIdWithHyphen.includes(`-${f}`));
        // å¸½å­çš®å¡ä¸˜ç‰¹æ®Šå¤„ç†ï¼ˆpokesprite icons ç›®å½•ï¼‰
        const pikachuCapForms = ['original', 'hoenn', 'sinnoh', 'unova', 'kalos', 'alola', 'partner', 'world'];
        const isPikachuCap = baseSpecies === 'Pikachu' && pikachuCapForms.includes(formeLower);
        // Cosplay çš®å¡ä¸˜
        const pikachuCosplayForms = ['cosplay', 'rock-star', 'belle', 'pop-star', 'phd', 'libre'];
        const isPikachuCosplay = baseSpecies === 'Pikachu' && pikachuCosplayForms.some(f => formeLower.includes(f));
        // æ˜¯å¦éœ€è¦ä½¿ç”¨ pokesprite å›¾åº“
        const needsPokesprite = isRegionalForm || isMegaForm || isPrimalForm || isUltraForm || isOtherSpecialForm;
        // =========================================================
        // ç”Ÿæˆ Sprite URL
        // =========================================================
        let imgSrc;
        if (isPikachuCap) {
            // å¸½å­çš®å¡ä¸˜ä½¿ç”¨ pokesprite icons ç›®å½•
            const capName = `pikachu-${formeLower}-cap`;
            imgSrc = `https://raw.githubusercontent.com/msikma/pokesprite/master/icons/pokemon/regular/${capName}.png`;
        } else if (isPikachuCosplay) {
            // Cosplay çš®å¡ä¸˜
            imgSrc = `https://raw.githubusercontent.com/msikma/pokesprite/master/icons/pokemon/regular/${seedIdWithHyphen}.png`;
        } else if (isCrownedForm) {
            // Crowned å½¢æ€ä½¿ç”¨ pokespriteï¼ˆzacian-crowned, zamazenta-crownedï¼‰
            imgSrc = `https://raw.githubusercontent.com/msikma/pokesprite/master/pokemon-gen8/regular/${seedIdWithHyphen}.png`;
        } else if (needsPokesprite) {
            // å…¶ä»–ç‰¹æ®Šå½¢æ€ä½¿ç”¨ pokesprite
            let pokespriteId = seedIdWithHyphen;
            // Mega X/Y æ ¼å¼ä¿®æ­£
            if (isMegaForm && !pokespriteId.includes('-mega')) {
                pokespriteId = pokespriteId.replace(/mega([xy])$/i, '-mega-$1');
                if (!pokespriteId.includes('-mega')) {
                    pokespriteId = pokespriteId.replace(/mega$/i, '-mega');
                }
            }
            // Primal æ ¼å¼ä¿®æ­£
            if (isPrimalForm && !pokespriteId.includes('-primal')) {
                pokespriteId = pokespriteId.replace(/primal$/i, '-primal');
            }
            // Necrozma ç‰¹æ®Šå½¢æ€æ ¼å¼ä¿®æ­£ (pokesprite ä½¿ç”¨ç®€åŒ–æ ¼å¼)
            // necrozma-dusk-mane -> necrozma-dusk
            // necrozma-dawn-wings -> necrozma-dawn
            pokespriteId = pokespriteId.replace(/-dusk-mane$/, '-dusk');
            pokespriteId = pokespriteId.replace(/-dawn-wings$/, '-dawn');
            imgSrc = `https://raw.githubusercontent.com/msikma/pokesprite/master/pokemon-gen8/regular/${pokespriteId}.png`;
        } else {
            // æ™®é€šå½¢æ€ä½¿ç”¨ Showdown spritesï¼ˆä¸å¸¦æ¨ªæ ï¼‰
            imgSrc = `https://play.pokemonshowdown.com/sprites/gen5/${seedIdCompact}.png`;
        }
        const fallbackSrc = `https://play.pokemonshowdown.com/sprites/gen5/${fallbackId}.png`;
        card.innerHTML = `
            ${isCurrent ? '<div class="current-tag">ACTIVE</div>' : ''}
            <div class="card-icon-modern">
                <img class="${isMegaForm ? 'mega-icon' : ''}" src="${imgSrc}" onerror="if(this.src!=='${fallbackSrc}'){this.src='${fallbackSrc}'}else{this.style.display='none'}">
            </div>
            <div class="card-info-modern">
                <div class="card-top-row">
                    <span class="card-name">${pm.cnName}</span>
                    <span class="card-lv">Lv.<span style="color:#2d3436;margin-left:2px">${pm.level}</span></span>
                </div>
                <div class="card-hp-nums">
                    ${pm.currHp} <span style="color:#b2bec3;font-weight:400">/ ${pm.maxHp}</span>
                </div>
                <div class="modern-hp-track">
                    <div class="modern-hp-fill" style="width:${hpRatio * 100}%; background:${hpColor}"></div>
                </div>
            </div>
            ${isDead ? '<div class="status-tag">FANT</div>' : ''}
        `;
        if (!isDead && !isCurrent) {
            card.onclick = () => {
                console.log('[renderSwitchMenu] Card clicked, calling performSwitch with index:', idx);
                layer.classList.add('hidden');
                layer.style.display = '';
                layer.className = 'overlay-modal hidden';
                performSwitch(idx);
            };
        }
        grid.appendChild(card);
    });
    container.appendChild(header);
    container.appendChild(grid);
    if (allowCancel) {
        const footer = document.createElement('div');
        footer.className = 'switch-footer';
        footer.innerHTML = `
            <button class="btn-close-modern">
                <span class="key-hint">Ã—</span> CANCEL
            </button>
        `;
        footer.querySelector('button').onclick = () => {
            layer.classList.add('hidden');
            layer.style.display = '';
            layer.className = 'overlay-modal hidden';
        };
        container.appendChild(footer);
    }
    layer.appendChild(container);
    if (allowCancel) {
        layer.onclick = (e) => {
            if (e.target === layer) {
                layer.classList.add('hidden');
                layer.style.display = '';
                layer.className = 'overlay-modal hidden';
            }
        };
    } else {
        layer.onclick = null;
    }
}
async function performSwitch(newIndex) {
    console.log('[performSwitch] Called with index:', newIndex);
    console.log('[performSwitch] battle.phase:', battle.phase);
    console.log('[performSwitch] battle.pivotResolve:', !!battle.pivotResolve);
    console.log('[performSwitch] battle.locked:', battle.locked);
    document.getElementById('switch-menu-layer').classList.add('hidden');
    const oldP = battle.getPlayer();
    const isForced = !oldP.isAlive();
    const isPivot = battle.phase === 'pivot_switch';
    const newPoke = battle.playerParty[newIndex];
    console.log('[performSwitch] isPivot:', isPivot, 'isForced:', isForced, 'hasPivotResolve:', !!battle.pivotResolve);
    // æ¢ä¸‹åœºçš„å®å¯æ¢¦é‡ç½®èƒ½åŠ›ç­‰çº§
    if (oldP.isAlive()) {
        // ã€ä¿®å¤ã€‘å¦‚æœæ¢ä¸‹çš„å®å¯æ¢¦å¤„äºæå·¨åŒ–çŠ¶æ€ï¼Œæ¢å¤æ‹›å¼
        if (oldP.isDynamaxed) {
            console.log(`[SWITCH] Player ${oldP.name} was Dynamaxed, restoring moves`);
            applyDynamaxState(oldP, false);
        }
        oldP.resetBoosts();
        // ã€ç‰¹æ€§é’©å­ã€‘è§¦å‘é€€åœºç‰¹æ€§ (Regenerator, Natural Cure, Zero to Hero ç­‰)
        if (typeof AbilityHandlers !== 'undefined' && oldP.ability) {
            const handler = AbilityHandlers[oldP.ability];
            if (handler && handler.onSwitchOut) {
                handler.onSwitchOut(oldP);
                console.log(`[ABILITY] ${oldP.cnName} è§¦å‘é€€åœºç‰¹æ€§: ${oldP.ability}`);
            }
        }
    }
    // ã€å“ˆæ¬ ä¿®å¤ã€‘æ¢äººæ—¶æ¸…é™¤å“ˆæ¬ çŠ¶æ€ï¼ˆå®˜æ–¹æœºåˆ¶ï¼šæ¢äººå¯ä»¥èº²é¿å“ˆæ¬ ï¼‰
    if (oldP.volatile && oldP.volatile.yawn) {
        console.log(`[YAWN] ${oldP.cnName} æ¢ä¸‹ï¼Œæ¸…é™¤å“ˆæ¬ çŠ¶æ€`);
        delete oldP.volatile.yawn;
    }
    // ã€åµé—¹ä¿®å¤ã€‘æ¢äººæ—¶æ¸…é™¤åµé—¹çŠ¶æ€ï¼ˆå®˜æ–¹æœºåˆ¶ï¼šä½¿ç”¨è€…ç¦»åœºåˆ™åµé—¹ç»“æŸï¼‰
    if (oldP.volatile && oldP.volatile.uproar) {
        console.log(`[UPROAR] ${oldP.cnName} æ¢ä¸‹ï¼Œåµé—¹çŠ¶æ€ç»“æŸ`);
        delete oldP.volatile.uproar;
    }
    // ã€Choice é”æ‹›ä¿®å¤ã€‘æ¢äººæ—¶æ¸…é™¤é”æ‹›çŠ¶æ€ï¼ˆå®˜æ–¹æœºåˆ¶ï¼šæ¢äººè§£é™¤é”æ‹›ï¼‰
    if (oldP.choiceLockedMove) {
        console.log(`[CHOICE] ${oldP.cnName} æ¢ä¸‹ï¼Œè§£é™¤ ${oldP.choiceLockedMove} é”å®š`);
        delete oldP.choiceLockedMove;
    }
    // Pivot æ¢äººä½¿ç”¨ä¸åŒçš„æ—¥å¿—
    if (isPivot) {
        log(`${oldP.cnName} æ’¤å›ï¼${newPoke.cnName} ç™»åœºï¼`);
    } else {
        log(isForced 
            ? `å»å§! ${newPoke.cnName}!` 
            : `å›æ¥å§ ${oldP.cnName}! ${newPoke.cnName}, ä¸Š!`);
    }
    // === æ’­æ”¾æ–°ä¸Šåœºå®å¯æ¢¦å«å£° ===
    if (typeof window.playPokemonCry === 'function') {
        window.playPokemonCry(newPoke.name);
    }
    // === è§¦å‘å…¥åœºç‰¹æ€§ (å¨å“ã€å¤©æ°”ç­‰) ===
    // æ³¨æ„ï¼šåœ¨è®¾ç½® playerActive ä¹‹å‰å…ˆè§¦å‘ç‰¹æ€§ï¼Œé¿å…æ’’è±å‡»å€’æ—¶ç´¢å¼•é”™è¯¯
    triggerEntryAbilities(newPoke, battle.getEnemy());
    // === ç»“ç®—åœºåœ°é’‰å­ä¼¤å®³ ===
    if (typeof MoveEffects !== 'undefined' && MoveEffects.applyEntryHazards) {
        const hazardLogs = MoveEffects.applyEntryHazards(newPoke, true, battle);
        hazardLogs.forEach(msg => log(msg));
        // å¦‚æœé’‰å­ä¼¤å®³å¯¼è‡´å®å¯æ¢¦å€’ä¸‹ï¼Œéœ€è¦å¼ºåˆ¶æ¢äºº
        if (newPoke.currHp <= 0) {
            log(`ç³Ÿç³•! ${newPoke.cnName} è¢«åœºåœ°ä¼¤å®³å‡»å€’äº†!`);
            updateAllVisuals();
            // ã€å…³é”®ä¿®å¤ã€‘ç­‰å¾…å¼ºåˆ¶æ¢äººå®Œæˆ
            await checkPlayerDefeatOrForceSwitch();
            return;
        }
    }
    // åªæœ‰åœ¨å®å¯æ¢¦å­˜æ´»çš„æƒ…å†µä¸‹æ‰è®¾ç½®ä¸ºå½“å‰æ´»è·ƒå®å¯æ¢¦
    battle.playerActive = newIndex;
    // ã€Commander System V2ã€‘åˆ‡æ¢å®å¯æ¢¦ååˆ·æ–°æ‚¬æµ®çª—ï¼ˆè¯»å–æ–°å®å¯æ¢¦çš„é…ç½®ï¼‰
    window.currentMoveStyle = 'normal'; // é‡ç½®é£æ ¼
    if (typeof window.refreshCommanderBubble === 'function') {
        window.refreshCommanderBubble();
    }
    // === ç¾ç»Šå…±é¸£çŠ¶æ€æ¢å¤ ===
    // å¦‚æœæ¢ä¸Šåœºçš„å®å¯æ¢¦æœ‰ç¾ç»Šå…±é¸£æ ‡è®°ï¼Œé‡æ–°åº”ç”¨èƒ½åŠ›æå‡
    if (newPoke.hasBondResonance && typeof newPoke.applyBoost === 'function') {
        // ã€å¹³è¡¡è°ƒæ•´ã€‘å…±é¸£æ€å…¨èƒ½åŠ› +1ï¼ˆåŸ +2ï¼‰
        newPoke.applyBoost('atk', 1);
        newPoke.applyBoost('def', 1);
        newPoke.applyBoost('spa', 1);
        newPoke.applyBoost('spd', 1);
        newPoke.applyBoost('spe', 1);
        log(`<span style="color:#4ade80"><b>${newPoke.cnName} çš„ç¾ç»Šå…±é¸£ä»åœ¨å»¶ç»­ï¼Œå…¨å±æ€§ç»´æŒæå‡!</b></span>`);
    }
    // Pivot æ¢äººï¼šresolve Promise å¹¶è¿”å›ï¼Œä¸è§¦å‘æ•Œæ–¹æ”»å‡»
    if (isPivot) {
        console.log('[performSwitch] Pivot switch detected');
        battle.phase = 'battle';
        updateAllVisuals();
        battle.locked = false;
        if (battle.pivotResolve) {
            console.log('[performSwitch] Resolving pivot Promise');
            const resolve = battle.pivotResolve;
            battle.pivotResolve = null;
            battle.pivotSide = null;
            console.log('[performSwitch] Calling resolve()');
            resolve();
            console.log('[performSwitch] resolve() called');
        }
        console.log('[performSwitch] Pivot handling complete, returning');
        return;
    }
    battle.phase = 'battle';
    if (!isForced) {
        // ä¸»åŠ¨æ¢äººè¦æŒ¨æ‰“
        log("ç”±äºäº¤æ¢å®å¯æ¢¦ï¼Œæ•Œæ–¹å‘èµ·äº†æ”»å‡»ï¼");
        battle.locked = true;
        await enemyTurn();
        // ã€ä¿®å¤ã€‘æ•Œæ–¹æ”»å‡»ç»“æŸåï¼ˆåŒ…æ‹¬è¢«ç²¾ç¥åœºåœ°é˜»æ­¢çš„æƒ…å†µï¼‰ï¼Œæ˜¾ç¤ºæ‹›å¼èœå•
        const currentP = battle.getPlayer();
        const currentE = battle.getEnemy();
        if (currentP && currentP.isAlive() && currentE && currentE.isAlive()) {
            updateAllVisuals();
            showMovesMenu();
        }
    } else {
        // å¼ºåˆ¶æ¢äººå®Œæˆåï¼Œåˆ·æ–°ç•Œé¢å¹¶è§£é”
        updateAllVisuals();
        // ã€åŒæ€åœºæ™¯ä¿®å¤ã€‘å¦‚æœæ•Œæ–¹ä¹Ÿåˆšæ¢äººï¼ˆåŒæ€åœºæ™¯ï¼‰ï¼Œè§¦å‘æ•Œæ–¹å…¥åœºç‰¹æ€§
        if (battle.enemyJustSwitchedInDoubleKO) {
            const newP = battle.getPlayer();
            const currentE = battle.getEnemy();
            if (newP && newP.isAlive() && currentE && currentE.isAlive()) {
                // è§¦å‘æ•Œæ–¹å…¥åœºç‰¹æ€§ï¼ˆå¦‚å¨å“ç­‰ï¼‰
                if (typeof triggerEntryAbilities === 'function') {
                    triggerEntryAbilities(currentE, newP);
                }
            }
            // æ¸…é™¤æ ‡è®°
            battle.enemyJustSwitchedInDoubleKO = false;
        }
        battle.locked = false;
        // ã€å…³é”®ä¿®å¤ã€‘resolve å¼ºåˆ¶æ¢äºº Promiseï¼Œé€šçŸ¥ handlePlayerFainted æ¢äººå·²å®Œæˆ
        if (battle.forceSwitchResolve) {
            console.log('[performSwitch] Resolving forceSwitchResolve');
            const resolve = battle.forceSwitchResolve;
            battle.forceSwitchResolve = null;
            resolve('switched');
        }
    }
}
// è¾…åŠ© LOG
function log(msg) {
    const box = document.getElementById('log-box');
    let formatMsg = msg;
    formatMsg = formatMsg.replace(/(\d+)\s*(ä¼¤å®³)/g, '<span class="hl-dmg">$1</span> <span style="font-size:0.9em;color:#888">$2</span>');
    formatMsg = formatMsg.replace(/(æ•ˆæœæ‹”ç¾¤|æ•ˆæœç»ä½³!|Super Effective!)/gi, '<span class="hl-sup">æ•ˆæœç»ä½³</span>');
    formatMsg = formatMsg.replace(/(æ•ˆæœä¸å¥½|æ”¶æ•ˆç”šå¾®|Not Very Effective\.\.\.)/gi, '<span class="hl-res">æ•ˆæœä¸å¥½</span>');
    formatMsg = formatMsg.replace(/(ä¼šå¿ƒä¸€å‡»!|Critical Hit!)/gi, '<span class="hl-crit">CRITICAL HIT!!</span>');
    formatMsg = formatMsg.replace(/(å€’ä¸‹äº†|å¤±å»æˆ˜æ–—èƒ½åŠ›)/gi, '<b style="color:#e11d48; text-decoration:underline; text-decoration-color:rgba(225,29,72,0.4)">$1</b>');
    const div = document.createElement('div');
    div.className = 'log-entry';
    div.innerHTML = formatMsg;
    box.appendChild(div);
    requestAnimationFrame(() => {
        box.scrollTop = box.scrollHeight;
    });
}
function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
// =========================================
// ã€å·²è¿ç§»ã€‘èœå•åˆ‡æ¢ -> ui/ui-menus.js
// ã€å·²è¿ç§»ã€‘Mega/Dynamax æŒ‰é’®æ§åˆ¶ -> ui/ui-menus.js
// ã€å·²è¿ç§»ã€‘è¿›åŒ–åŠ¨ç”» -> ui/ui-menus.js
// =========================================
// é€ƒè·‘åŠŸèƒ½
function tryRun() {
    if (battle.locked && battle.phase !== 'battle') return;
    const playerLabel = battle.playerName || 'ç©å®¶';
    if (battle.trainer && battle.trainer.id !== 'wild') {
        log(`é¢å¯¹å¼ºæ•Œï¼Œ${playerLabel} é€‰æ‹©äº†æˆ˜ç•¥æ€§æ’¤é€€ï¼ (æŠ•é™)`);
        const escapeLine = battle.trainer.lines?.escape || battle.trainer.lines?.win;
        if (escapeLine) {
            log(`<i>${battle.trainer.name}: "${escapeLine}"</i>`);
        }
    } else {
        log(`${playerLabel} å¸¦ç€åŒä¼´æˆåŠŸé€ƒç¦»äº†æˆ˜åœºï¼`);
    }
    battle.phase = 'ended';
    battle.locked = true;
    setTimeout(() => battleEndSequence('escape'), 600);
}
// =========================================================
// ã€å·²è¿ç§»ã€‘æ•è·ç³»ç»Ÿ -> systems/catch-system.js
// =========================================================
// ä¾› HTML inline handler è°ƒç”¨
// æ³¨ï¼šéƒ¨åˆ†å‡½æ•°å·²è¿ç§»åˆ°ç‹¬ç«‹æ¨¡å—ï¼Œé€šè¿‡æ¨¡å—è‡ªèº«å¯¼å‡ºåˆ° window
window.initGame = initGame;
window.handleAttack = handleAttack;
window.renderSwitchMenu = renderSwitchMenu;
window.tryRun = tryRun;
window.log = log;
window.updateAllVisuals = updateAllVisuals;
window.executeEndPhase = executeEndPhase;
window.checkPlayerDefeatOrForceSwitch = checkPlayerDefeatOrForceSwitch;
window.performSwitch = performSwitch;
window.battleEndSequence = battleEndSequence;
window.showCommanderMenu = showCommanderMenu;
window.closeCommanderMenu = closeCommanderMenu;
window.updateCommanderButtons = updateCommanderButtons;
window.applyCommandEffect = applyCommandEffect;
window.clearCommandEffects = clearCommandEffects;
/* ===========================================
   æ–°å¢åŠŸèƒ½ï¼šæˆ˜æ–—ç»“ç®—ä¸æ€»ç»“ç”Ÿæˆ
=========================================== */
function battleEndSequence(result) {
    battle.phase = 'ended';
    battle.locked = true;
    // === BGM å¤„ç† ===
    const isTrainer = battle.trainer && battle.trainer.id !== 'wild';
    // èƒœåˆ©æ—¶æ’­æ”¾èƒœåˆ©éŸ³ä¹ (win/caught)
    if (result === 'win' || result === 'caught') {
        if (typeof playVictoryBgm === 'function') {
            playVictoryBgm(isTrainer);
        }
    } else {
        // å¤±è´¥/é€ƒè·‘æ—¶åœæ­¢BGM
        if (typeof stopBgm === 'function') {
            stopBgm(500);
        }
    }
    const analysis = generateBattleReport(result);
    const overlay = document.getElementById('result-overlay');
    const card = document.getElementById('res-card-bg');
    const titleEl = document.getElementById('res-title');
    const rankLetterEl = document.getElementById('res-grade-letter');
    const rankSubEl = document.getElementById('res-grade-sub');
    const statusEl = document.getElementById('col-status');
    const descEl = document.getElementById('col-desc');
    const reasonEl = document.getElementById('col-reason');
    const dotsEl = document.getElementById('res-party-viz');
    const clipEl = document.getElementById('res-clipboard-text');
    if (!overlay || !card) return;
    overlay.classList.remove('active');
    card.classList.remove('theme-win', 'theme-loss', 'theme-escape');
    const enemyName = analysis.enemyName || 'Opponent';
    let titleCopy = 'VICTORY';
    let statusCopy = `Victory vs. ${enemyName}`;
    let themeClass = 'theme-win';
    if (result === 'loss') {
        titleCopy = 'DEFEATED';
        statusCopy = `Overwhelmed by ${enemyName}`;
        themeClass = 'theme-loss';
    } else if (result === 'escape') {
        titleCopy = 'ESCAPED';
        statusCopy = `Retreated from ${enemyName}`;
        themeClass = 'theme-escape';
    } else if (result === 'caught') {
        titleCopy = 'CAPTURED';
        statusCopy = `Captured ${enemyName}`;
        themeClass = 'theme-win';
    }
    card.classList.add(themeClass);
    if (titleEl) titleEl.textContent = titleCopy;
    if (statusEl) statusEl.textContent = statusCopy;
    const rankMatch = typeof analysis.rank === 'string'
        ? analysis.rank.match(/^([A-Z][A-Z\+\-]*)\s*(?:\((.+)\))?/i)
        : null;
    const rankLetter = rankMatch ? rankMatch[1] : analysis.rank || '?';
    const rankDescriptor = rankMatch && rankMatch[2] ? rankMatch[2] : 'RANK';
    if (rankLetterEl) rankLetterEl.textContent = rankLetter.toUpperCase();
    if (rankSubEl) rankSubEl.textContent = rankDescriptor;
    if (reasonEl) reasonEl.textContent = rankDescriptor;
    if (descEl) descEl.textContent = analysis.description || 'æš‚æ— æˆ˜å†µæè¿°ã€‚';
    if (dotsEl) {
        dotsEl.innerHTML = '';
        battle.playerParty.forEach(p => {
            const dot = document.createElement('div');
            const ratio = p.maxHp > 0 ? p.currHp / p.maxHp : 0;
            let state = 'hp-low';
            if (p.currHp <= 0) state = 'hp-dead';
            else if (ratio > 0.6) state = 'hp-100';
            else if (ratio > 0.25) state = 'hp-mid';
            dot.className = `mini-dot ${state}`;
            dotsEl.appendChild(dot);
        });
    }
    if (clipEl) {
        clipEl.value = analysis.fullReport;
    }
    let endLine = '';
    const lines = battle.trainer?.lines || {};
    if (result === 'win') {
        endLine = lines.lose;
    } else if (result === 'escape') {
        endLine = lines.escape || lines.win || lines.lose || '';
    } else {
        // result === 'loss'
        endLine = lines.win;
    }
    if (battle.trainer && battle.trainer.id !== 'wild' && endLine) {
        setTimeout(() => playCutIn(endLine, 4500), 100);
    }
    overlay.classList.remove('hidden');
    void overlay.offsetWidth;
    overlay.classList.add('active');
}
function generateBattleReport(result) {
    const pParty = battle.playerParty;
    const eParty = battle.enemyParty;
    const pName = battle.playerName || "Player";
    const activeEnemy = typeof battle.getEnemy === 'function'
        ? battle.getEnemy()
        : (eParty[battle.enemyActive ?? 0] || eParty[0] || null);
    const fallbackEnemyName = activeEnemy?.cnName || activeEnemy?.name || "Wild Pokemon";
    let eName = fallbackEnemyName || "Enemy";
    if (battle.trainer) {
        if (battle.trainer.id !== 'wild') {
            eName = battle.trainer.name || battle.trainer.title || battle.trainer.id || fallbackEnemyName || "Enemy";
        } else {
            eName = battle.trainer.name?.trim()
                || fallbackEnemyName
                || (battle.trainer.title && battle.trainer.title.toLowerCase() !== 'wild' ? battle.trainer.title : '')
                || "Wild Pokemon";
        }
    }
    const survivors = pParty.filter(p => p.currHp > 0);
    const fallen = pParty.filter(p => p.currHp <= 0);
    const survivorTxt = survivors.length > 0
        ? survivors.map(p => `${p.cnName}(${Math.round((p.currHp / Math.max(1, p.maxHp)) * 100)}%)`).join(', ')
        : "æ¿’æ­»ä¸­æ’¤èµ°";
    const avgLevel = party => party.length
        ? party.reduce((sum, poke) => sum + (poke.level || poke.lv || 1), 0) / party.length
        : 0;
    let pTotalHpPct = 0;
    pParty.forEach(p => pTotalHpPct += (p.maxHp > 0 ? p.currHp / p.maxHp : 0));
    const pHpHealth = pParty.length > 0 ? Math.floor((pTotalHpPct / pParty.length) * 100) : 0;
    const eFallen = eParty.filter(p => p.currHp <= 0);
    let eTotalHpPct = 0;
    eParty.forEach(p => eTotalHpPct += (p.maxHp > 0 ? p.currHp / p.maxHp : 0));
    const eHpHealth = eParty.length > 0 ? Math.floor((eTotalHpPct / eParty.length) * 100) : 0;
    const avgPLv = avgLevel(pParty);
    const avgELv = avgLevel(eParty);
    const levelDiff = avgELv - avgPLv;
    const isTrainer = battle.trainer && battle.trainer.id !== 'wild';
    let rank = 'C';
    let desc = '';
    let resultTextDisplay = result === 'win' ? 'ã€ç©å®¶èƒœåˆ©ã€‘' : 'ã€ç©å®¶å¤±è´¥ã€‘';
    if (result === 'escape') {
        if (levelDiff > 30) {
            rank = 'B (æˆ˜æœ¯æ’¤é€€)';
            desc = 'é¢å¯¹ä¸å¯èƒ½æˆ˜èƒœçš„é‡çº§å·®è·ï¼Œç†æ™ºåœ°é€‰æ‹©ä¿å…¨é˜Ÿä¼ã€‚æ´»ä¸‹å»æ¯”ä»€ä¹ˆéƒ½é‡è¦ã€‚';
        } else if (levelDiff > 10) {
            rank = 'C (è°¨æ…å›é¿)';
            desc = 'æ„è¯†åˆ°å¯¹æ‰‹çš„éš¾ç¼ ï¼Œåœ¨æ²¡æœ‰æŠŠæ¡çš„æƒ…å†µä¸‹é€‰æ‹©ä¸ç¡¬ç¢°ç¡¬ã€‚';
        } else if (survivors.length === 0) {
            rank = 'D (æºƒé€ƒ)';
            desc = 'å…¨çº¿å´©æºƒçš„è¾¹ç¼˜å¼ºè¡Œè„±ç¦»æˆ˜åœºã€‚';
        } else {
            rank = 'D (è„±ç¦»æˆ˜åœº)';
            desc = isTrainer
                ? 'é¢å¯¹è®­ç»ƒå®¶çš„æŒ‘æˆ˜é€‰æ‹©äº†å›é¿ï¼ˆæŠ•é™ï¼‰ã€‚'
                : 'æˆåŠŸä»é‡ç”Ÿå®å¯æ¢¦é¢å‰è„±èº«ã€‚';
        }
        resultTextDisplay = 'ã€æ’¤é€€ / ä¸­æ–­ã€‘';
} else if (result === 'caught') {
    rank = 'CAPTURE (æ•è·æˆåŠŸ)';  // æŠŠ GET æ”¹ä¸º CAPTURE æ›´å…·ç³»ç»Ÿæ„Ÿï¼Œæˆ–è€…ä¿ç•™ GET ä¹Ÿè¡Œ
    desc = 'ä¼´éšç€çƒä½“æŒ‡ç¤ºç¯åœæ­¢æ‘‡æ™ƒï¼Œä¸­å¤®å‘å‡ºäº†æ¸…è„†çš„é”å®šéŸ³ã€‚ç›®æ ‡æ•æ‰å®Œæ¯•ã€‚'; 
    resultTextDisplay = 'ã€æ”¶æœç¡®è®¤ã€‘';
    if (eHpHealth > 70) {
        // æ»¡è¡€æ•è·ï¼šä¸å†è¯´æ˜¯â€œå¥‡è¿¹â€ï¼Œå¼ºè°ƒâ€œå¼ºè¿â€æˆ–â€œä¸€å‘å…¥é­‚â€
        desc += ' ç«Ÿç„¶åœ¨æœªå‰Šå‡ä½“åŠ›çš„çŠ¶æ€ä¸‹åªæœ‰ä¸€çƒï¼Ÿç»ä½³çš„ã€Critical Captureã€‘ã€‚';
    } else if (eHpHealth < 10) {
        // çº¢è¡€æ•è·ï¼šä¸å†è¯´æ˜¯â€œæŒæ§â€ï¼Œå¼ºè°ƒâ€œå‹åˆ¶â€å’Œâ€œç²¾å‡†â€
        desc += ' å°†ä½“åŠ›å‹åˆ¶åˆ°äº†æé™çš„çº¢è‰²åŒºåŸŸï¼Œæ•™ç§‘ä¹¦èˆ¬ç²¾å‡†çš„æ”¶æœä½œä¸š!';
    }
    } else if (result === 'win') {
        const deadCount = fallen.length;
        if (deadCount === 0) {
            if (pHpHealth >= 95) { rank = 'S+ (æ— ä¼¤)'; desc = 'æœªå—åˆ°å®è´¨æ€§ä¼¤å®³çš„å®Œç¾èƒœåˆ©ã€‚'; }
            else if (pHpHealth >= 80) { rank = 'S (å®Œèƒœ)'; desc = 'æŒæ§äº†èŠ‚å¥ï¼Œæ¯«æ— æ‚¬å¿µçš„å‹å€’æ€§èƒœåˆ©ã€‚'; }
            else if (pHpHealth >= 60) { rank = 'A+ (è½»å–)'; desc = 'è™½æœ‰äº¤é”‹ï¼Œä½†å§‹ç»ˆå æ®ç€ä¸»å¯¼æƒã€‚'; }
            else { rank = 'A (ä¼˜èƒœ)'; desc = 'å¯¹æ‰‹ä¹Ÿæœ‰å¤‡è€Œæ¥ï¼Œä½†è¿˜æ˜¯æŠ€é«˜ä¸€ç­¹ã€‚'; }
        } else {
            const deadRatio = pParty.length > 0 ? deadCount / pParty.length : 1;
            if (deadRatio < 0.5) { rank = 'B (è‹¦æˆ˜)'; desc = 'ä»˜å‡ºäº†åŒä¼´å€’ä¸‹çš„ä»£ä»·ï¼Œæ‰æ‹¿ä¸‹çš„è‰°éš¾èƒœåˆ©ã€‚'; }
            else if (deadRatio < 0.9) { rank = 'C (æ­»æ–—)'; desc = 'é™¤äº†ç«™åˆ°æœ€åçš„è‹±é›„ï¼Œå…¶ä»–åŒä¼´éƒ½å·²å€’ä¸‹â€¦â€¦'; }
            else { rank = 'C- (ç»å¢ƒåæ€)'; desc = 'ä»…å‰©æœ€åçš„ä¸€ä¸çº¢è¡€â€¦â€¦å¥‡è¿¹èˆ¬çš„æé™ç¿»ç›˜ã€‚'; }
        }
    } else {
        if (eFallen.length === 0) {
            if (eHpHealth >= 90) { rank = 'F (ç¢¾å‹)'; desc = 'æ¯«æ— è¿˜æ‰‹ä¹‹åŠ›â€¦â€¦é‚£æ˜¯æ¬¡å…ƒçº§çš„æˆ˜åŠ›å·®è·ã€‚'; }
            else if (eHpHealth >= 70) { rank = 'E (å®Œè´¥)'; desc = 'æ²¡èƒ½å¯¹æ•Œäººé€ æˆæœ‰æ•ˆå¨èƒï¼Œé—æ†¾è½è´¥ã€‚'; }
            else if (eHpHealth >= 40) { rank = 'D (ä¸‹é£)'; desc = 'è™½ç„¶å°½åŠ›åå‡»ï¼Œä½†ä»è¢«å¯¹æ–¹å‹åˆ¶ã€‚'; }
            else if (eHpHealth >= 15) { rank = 'C (æŠ—è¡¡)'; desc = 'æœ‰æ¥æœ‰å›çš„æ¿€æˆ˜ï¼Œåªå·®ä¸€å£æ°”å°±èƒ½æ‰­è½¬å±€åŠ¿ã€‚'; }
            else { rank = 'C+ (æƒœè´¥)'; desc = 'æŠŠå¯¹æ‰‹é€¼å…¥ç»å¢ƒï¼æ˜æ˜åªå·®æœ€åä¸€ä¸‹â€¦â€¦'; }
        } else {
            const killRatio = eParty.length > 0 ? (eFallen.length / eParty.length) : 0;
            if (killRatio > 0.6) {
                rank = 'B- (æ¯å¤©ç­åœ°)';
                desc = 'åŒæ–¹éƒ½å·²æ‹¼å°½å…¨åŠ›ï¼Œè™½ç„¶è¾“äº†ï¼Œä½†è¿™ç»å¯¹æ˜¯ä¸€åœºå€¼å¾—èµ¢å¾—å°Šé‡çš„æˆ˜æ–—ã€‚';
            } else {
                rank = 'D+ (æ··æˆ˜)';
                desc = 'è™½ç„¶é‡åˆ›äº†å¯¹æ‰‹ï¼Œä½†æœ€ç»ˆè¿˜æ˜¯æ²¡èƒ½åšæŒåˆ°æœ€åã€‚';
            }
        }
    }
    const rows = [];
    let summaryLine;
    if (result === 'escape') {
        summaryLine = `- ç»¼è¿°ï¼š${pName} åœ¨é¢å¯¹ ${eName} æ—¶é€‰æ‹©äº†ã€è®¤è¾“/æŠ•é™ã€‘ã€‚`;
    } else if (result === 'caught') {
        summaryLine = `- ç»¼è¿°ï¼š${pName} æˆåŠŸåœ¨é‡å¤–æ”¶æœäº† ${eName}ã€‚`;
    } else {
        summaryLine = `- ç»¼è¿°ï¼š${pName} å¯¹é˜µ ${eName}ï¼Œ${result === 'win' ? 'è·å¾—èƒœåˆ©' : 'é—æ†¾è½è´¥'}ã€‚`;
    }
    rows.push(`- äº¤äº’ç»“æœï¼š${resultTextDisplay}`);
    rows.push(`- è¯„çº§ï¼š${rank}`);
    rows.push(summaryLine);
    rows.push(`- å±€åŠ¿è¯´æ˜ï¼š${desc}`);
    if (result === 'win' && battle.trainer?.lines?.lose) {
        rows.push(`- æ•Œæ–¹è´¥é€€å°è¯ï¼š"${battle.trainer.lines.lose}"`);
    } else if (result === 'escape' && battle.trainer?.lines?.escape) {
        rows.push(`- æ•Œæ–¹ç¦»åœºèµ è¨€ï¼š"${battle.trainer.lines.escape}"`);
    } else if (result === 'loss' && battle.trainer?.lines?.win) {
        rows.push(`- æ•Œæ–¹èƒœåˆ©/å˜²è®½å°è¯ï¼š"${battle.trainer.lines.win}"`);
    }
    const formatEnemyName = poke => (poke?.cnName || poke?.name || '???');
    const enemyStatusLine = eParty.length > 0
        ? eParty.map((poke, idx) => {
            const pct = poke.maxHp > 0 ? Math.round((Math.max(0, poke.currHp) / poke.maxHp) * 100) : 0;
            const state = poke.currHp <= 0 ? 'å€’ä¸‹' : `${pct}%`;
            const marker = idx === (battle.enemyActive ?? 0) ? '*' : '';
            return `${marker}${formatEnemyName(poke)}(${state})`;
        }).join(' / ')
        : 'æœªçŸ¥';
    rows.push(`- æˆ‘æ–¹å¸¦å‡ºæˆ˜åœºï¼š${survivorTxt}`);
    rows.push(`- æ•Œæ–¹çŠ¶æ€ï¼š${enemyStatusLine}`);
    if (result !== 'escape' && fallen.length > 0) {
        rows.push(`- æ¿’æ­»åå•ï¼š${fallen.map(p => p.cnName).join(', ')}`);
    } else if (result === 'escape' && fallen.length > 0) {
        rows.push(`- å€’ä¸‹éœ€æ²»ç–—ï¼š${fallen.map(p => p.cnName).join(', ')}`);
    }
    // =========================================================
    // ã€æˆé•¿å»ºè®®ç³»ç»Ÿã€‘åŠ¨æ¼«é£æ ¼ç­‰çº§å»ºè®®
    // =========================================================
    let growthData = null;
    if (typeof window.calculateAnimeGrowth === 'function') {
        growthData = window.calculateAnimeGrowth({
            rank: rank,
            hpHealth: pHpHealth,
            levelDiff: levelDiff,
            resultLabel: resultTextDisplay
        }, result);
        if (typeof window.formatGrowthReport === 'function') {
            const growthRows = window.formatGrowthReport(growthData);
            growthRows.forEach(row => rows.push(row));
        }
    }
    return {
        rank,
        description: desc,
        playerName: pName,
        enemyName: eName,
        resultLabel: resultTextDisplay,
        summaryLine,
        fullReport: rows.join('\n'),
        fallenCount: fallen.length,
        survivorCount: survivors.length,
        hpHealth: pHpHealth,
        growth: growthData
    };
}
window.restartBattle = function() {
    document.getElementById('result-overlay').classList.add('hidden');
    const logBox = document.getElementById('log-box');
    if (logBox) {
        logBox.innerHTML = '';
    }
    battle = new BattleState();
    window.battle = battle;  // ã€ä¿®å¤ã€‘åŒæ­¥æ›´æ–°å…¨å±€å¼•ç”¨
    // åœæ­¢å½“å‰ BGM (ç«‹å³åœæ­¢ï¼Œä¸æ·¡å‡º)
    if (typeof stopBgm === 'function') {
        stopBgm(0);
    }
    log("=== é‡ç½®æˆ˜æ–— ===");
    initGame();
};
window.copyResultOnly = function() {
    const summary = document.getElementById('res-clipboard-text').value;
    copyToAndClose(summary);
};
window.copyFullProcess = function() {
    const summary = document.getElementById('res-clipboard-text').value;
    const processLog = extractBattleLog();
    // æ ¹æ®æ—¥å¿—æ¡ç›®æ•°é‡æ¨èå­—æ•°ï¼ˆ500-4000å­—ï¼‰
    const logBox = document.getElementById('log-box');
    const entryCount = logBox ? logBox.querySelectorAll('.log-entry').length : 0;
    const recommendedWords = Math.min(4000, Math.max(500, Math.round(entryCount * 40)));
    const wordRangeMin = Math.max(500, recommendedWords - 200);
    const wordRangeMax = Math.min(4000, recommendedWords + 200);
    const wordRequirement = `ğŸ“Š ã€å­—æ•°è¦æ±‚ã€‘æœ¬æ¬¡æˆ˜æ–—å…± ${entryCount} æ¡æ—¥å¿—ï¼Œæ¨èæ­£æ–‡å­—æ•°ï¼š**${wordRangeMin}~${wordRangeMax} å­—**ï¼ˆä¸å°‘äº ${wordRangeMin} å­—ï¼‰`;
    const finalContent = [
        '<CORE_TASK>',
        'ğŸ›‘ [SYSTEM COMMAND // å¼ºåˆ¶æ‰§è¡Œ] ğŸ›‘',
        'ğŸš« DO NOT ADVANCE THE PLOT! (ç¦æ­¢æ¨è¿›åç»­å‰§æƒ…)',
        'ğŸš« DO NOT SKIP BATTLE DETAILS! (ç¦æ­¢è·³è¿‡æˆ˜æ–—ç»†èŠ‚)',
        'âš ï¸ æ ¸å¿ƒä»»åŠ¡ (CORE TASK):',
        'ä½ ç°åœ¨çš„èº«ä»½æ˜¯ã€ç²¾çµå®å¯æ¢¦åŠ¨ç”»ç¼–å‰§ã€‘ã€‚è¯·åŸºäºä¸‹æ–¹çš„ã€Œæˆ˜æ–—æ—¥å¿—ã€ä¸ã€Œç»“æœã€ï¼Œå°†æ¯ç‡¥çš„æ•°æ®é‡æ„ä¸ºå……æ»¡ç”»é¢æ„Ÿçš„**å°è¯´çº§å®å†µæ¼”å‡º**ã€‚',
        'ä¸ä»…è¦åŸºäºä¸‹æ–¹çš„ã€Œå›åˆåˆ¶æ—¥å¿— (Log)ã€ä¸ã€Œæœ€ç»ˆç»“ç®— (Result)ã€ï¼Œæ’°å†™ä¸€åœº**å­—æ•°å……è¶³**çš„å®Œæ•´æˆ˜æ–—è¿‡ç¨‹ã€‚',
        '',
        wordRequirement,
        '',
        'ã€æ ¸å¿ƒåŸåˆ™ // CORE RULESã€‘',
        '1. é£æ ¼è‡ªé€‚åº”ï¼šè¯·è‡ªåŠ¨è¯†åˆ«å¯¹æˆ˜çº§åˆ«å¹¶åˆ‡æ¢ç”»é£ï¼š',
        '   - é«˜å¼ºåº¦å¯¹å†³ï¼ˆç¥å…½/æ»¡çº§/Mega/ZæŠ€ï¼‰ï¼šé‡‡ç”¨ç‹é“çƒ­è¡€é£',
        '   - ä½é¢‘/è¶£å‘³å±€ï¼ˆå¹¼å´½/æ›´æ›¿è¡£æœ/éšæœºæŒ¥æŒ‡ï¼‰ï¼šé‡‡ç”¨è½»æ¾æ¬¢å¿«é£ï¼Œæå†™è¦ç”ŸåŠ¨ç›¸å¯¹å¯çˆ±ã€‚',
        '2. ç»å¯¹å…¨å¹´é¾„ï¼š',
        '   - âŒ ä¸¥ç¦é»‘æ®‹æ·±ï¼šç¦æ­¢å‡ºç°è‚¢ä½“æ®‹ç¼ºã€ç—›è‹¦ç»æœ›ã€è¡€è…¥æå†™ã€‚',
        '   - âœ… è§†æ•ˆè½¬åŒ–ï¼šå°†â€œé‡ä¼¤â€å†™ä¸ºä½“åŠ›é€æ”¯æˆ–æˆ˜æŸï¼ˆæ±¡æ¸/æ“¦ä¼¤ï¼‰ï¼›â€œå€’ä¸‹â€å³ä¸ºåœˆåœˆçœ¼æˆ–ä½“é¢é€€åœºã€‚',
        '3. å»æ•°æ®åŒ–ä¸å»å›åˆåˆ¶ï¼š',
        '   - **ä¸¥ç¦**ä½¿ç”¨â€œç¬¬Xå›åˆâ€ã€â€œé€ æˆXXç‚¹ä¼¤å®³â€ç­‰æ¸¸æˆæœ¯è¯­ã€‚',
        '   - å¿…é¡»é€šè¿‡ç”±äºä¼¤å®³é€ æˆçš„â€œåœ°å½¢ç ´åâ€ã€â€œè¡¨æƒ…ç—›æ¥šâ€ã€â€œåŠ¨ä½œè¿Ÿç¼“â€æ¥ä½“ç°æ•°å€¼å˜åŒ–ã€‚',
        '   - åŠ¨ä½œå¿…é¡»æµç•…è¡”æ¥ï¼Œä¸å‡†è®°æµæ°´è´¦ï¼Œé“å…·ä¸ç‰¹æ€§å‘åŠ¨è¦è‡ªç„¶èå…¥æˆ˜æ–—æè¿°ä¸­ï¼Œç»“åˆç¯å¢ƒä¾æ®æˆ˜æ–—æ–‡æœ¬è¿›è¡Œçµæ´»åˆ›æ„æ€§æ”¹ç¼–ã€‚',
        '</CORE_TASK>',
        '',
        '<BATTLE_LOG>',
        processLog,
        '</BATTLE_LOG>',
        '',
        '<BATTLE_RESULT>',
        'ç»“æœç»Ÿè®¡ï¼ˆä½œä¸ºç»“å±€çš„å‚è€ƒï¼‰ï¼š',
        summary.replace('[ç³»ç»Ÿæç¤ºï¼šå®å¯æ¢¦å¯¹æˆ˜ç»“æœç»“ç®—]\n', ''),
        '</BATTLE_RESULT>',
        '',
        '<WRITING_INSTRUCTION>',
        `è¯·ç«‹å³ç”Ÿæˆ ${wordRangeMin}~${wordRangeMax} å­—çš„æˆ˜æ–—å®å†µæ–‡æ¡ˆï¼ˆæœ€ä½ä¸å°‘äº ${wordRangeMin} å­—ï¼‰`,
        '</WRITING_INSTRUCTION>'
    ].join('\n');
    copyToAndClose(finalContent);
};
// ...
function extractBattleLog() {
    const logBox = document.getElementById('log-box');
    if (!logBox) return '';
    const entries = [];
    logBox.querySelectorAll('.log-entry').forEach(entry => {
        const text = entry.innerText.trim();
        if (text) entries.push(`> ${text}`);
    });
    return entries.join('\n');
}
function copyToAndClose(textStr) {
    const fallbackCopy = () => {
        const el = document.createElement('textarea');
        el.value = textStr;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        endGameCleanup();
    };
    if (navigator.clipboard) {
        navigator.clipboard.writeText(textStr).then(() => {
            endGameCleanup();
        }).catch(fallbackCopy);
    } else {
        fallbackCopy();
    }
}
function endGameCleanup() {
    setTimeout(() => {
        if (window.parent) {
            window.parent.postMessage({ type: 'pkm-battle-close' }, '*');
        }
        document.getElementById('ui-root').style.filter = "grayscale(1) brightness(0.2)";
        document.body.innerHTML = "<div style='color:white;text-align:center;margin-top:20%'><h1>SESSION ENDED</h1><p>å·²å¤åˆ¶ç»“æœï¼Œè¯·åœ¨å¯¹è¯æ¡†ç²˜è´´ã€‚</p></div>";
    }, 600);
}
/**
 * =========================================================
 * BATTLE EVOLUTION SYSTEM V2 (ä¸´åœºè¿›åŒ–ç³»ç»Ÿ)
 * =========================================================
 * åŒè½¨è®¾è®¡ï¼š
 * 1. ç”Ÿå‘½è¿›åŒ– (Bio): ä¸€äºŒé˜¶æ®µå±æœºæ—¶è¿›åŒ–çªç ´
 * 2. çµé­‚å…±é¸£ (Bond): æœ€ç»ˆå½¢æ€ç»å¢ƒçˆ†å‘
 * =========================================================
 * ä¾èµ–: POKEDEX (data layer), calcStats (battle-engine.js)
 */
window.EvolutionSystem = {
    /**
     * è®¡ç®—å·±æ–¹ä¸æ•Œæ–¹çš„æ€»è¡€é‡æ¯”ï¼Œåˆ¤æ–­æ˜¯å¦å¤„äºæ˜æ˜¾åŠ£åŠ¿
     * @returns {boolean}
     */
    checkDisadvantage: function() {
        if (!battle || !battle.playerParty || !battle.enemyParty) return false;
        // è®¡ç®—å·±æ–¹æ€»è¡€é‡æ¯”
        let pTotalNow = 0, pTotalMax = 0;
        battle.playerParty.forEach(p => { 
            if (p && typeof p.currHp === 'number') {
                pTotalNow += Math.max(0, p.currHp); 
                pTotalMax += p.maxHp || 1;
            }
        });
        const playerRatio = pTotalNow / Math.max(1, pTotalMax);
        // è®¡ç®—æ•Œæ–¹æ€»è¡€é‡æ¯”
        let eTotalNow = 0, eTotalMax = 0;
        battle.enemyParty.forEach(e => { 
            if (e && typeof e.currHp === 'number') {
                eTotalNow += Math.max(0, e.currHp); 
                eTotalMax += e.maxHp || 1;
            }
        });
        const enemyRatio = eTotalNow / Math.max(1, eTotalMax);
        // å­˜æ´»æ•°é‡
        const alivePlayer = battle.playerParty.filter(p => p && typeof p.isAlive === 'function' && p.isAlive()).length;
        const aliveEnemy = battle.enemyParty.filter(e => e && typeof e.isAlive === 'function' && e.isAlive()).length;
        // ã€æè‡´æ”¶ç´§ã€‘çœŸÂ·ç»å¢ƒåˆ¤å®šï¼š
        // 1. ç»å¯¹æœ€åä¸€äºº + è¡€é‡å±æœºï¼ˆLast Man Standing + HP Crisisï¼‰
        //    ã€ä¿®å¤ã€‘1v1 æ»¡è¡€ä¸åº”è§¦å‘ï¼Œå¿…é¡»åŒæ—¶æ»¡è¶³"æœ€åä¸€åª"ä¸”"è¡€é‡ â‰¤ 40%"
        const isAbsoluteLastOne = (alivePlayer === 1) && (playerRatio <= 0.40);
        // 2. å…¨é˜Ÿæ¿’æ­»ï¼ˆå…¨é˜Ÿæ€»HP â‰¤ 10%ï¼Œå³ä½¿æœ‰å¤šåªå­˜æ´»ä¹Ÿéƒ½æ˜¯æ®‹è¡€ï¼‰
        const isNearWipeout = playerRatio <= 0.10;
        // 3. å·±æ–¹åªå‰©1åªï¼Œæ•Œæ–¹è¿˜æœ‰2åªä»¥ä¸Šï¼ˆçœŸæ­£çš„1vNåŠ£åŠ¿ï¼‰
        //    è¿™ç§æƒ…å†µä¸éœ€è¦è¡€é‡æ£€æŸ¥ï¼Œå› ä¸ºæ•°é‡åŠ£åŠ¿æœ¬èº«å°±æ˜¯ç»å¢ƒ
        const isOneVsMany = (alivePlayer === 1) && (aliveEnemy >= 2);
        return isAbsoluteLastOne || isNearWipeout || isOneVsMany;
    },
    /**
     * æ£€æŸ¥å½“å‰æ´»è·ƒç©å®¶ç²¾çµæ˜¯å¦æ»¡è¶³è¿›åŒ–/å…±é¸£æ¡ä»¶
     * @param {Pokemon} pokemon - è¦æ£€æŸ¥çš„å®å¯æ¢¦
     * @returns {Object|null} è¿›åŒ–ä¿¡æ¯æˆ– null
     */
    checkEligibility: function(pokemon) {
        // ã€å…¨å±€å¼€å…³ã€‘EVO ç³»ç»Ÿå…³é—­æ—¶ä¸è§¦å‘
        if (window.GAME_SETTINGS && !window.GAME_SETTINGS.enableEVO) return null;
        // åŸºç¡€æ£€æŸ¥
        if (!pokemon || pokemon.currHp <= 0) return null;
        if (pokemon.hasEvolvedThisBattle || pokemon.hasBondResonance) return null;
        // è®¡ç®— AVs æ€»å’Œï¼ˆä½¿ç”¨æœ‰æ•ˆå€¼ï¼Œè€ƒè™‘ enable_insight è§£é”é™åˆ¶ï¼‰
        const avs = pokemon.avs || { trust: 0, passion: 0, insight: 0, devotion: 0 };
        const totalAVs = (pokemon.getEffectiveAVs('trust') || 0) + 
                         (pokemon.getEffectiveAVs('passion') || 0) + 
                         (pokemon.getEffectiveAVs('insight') || 0) + 
                         (pokemon.getEffectiveAVs('devotion') || 0);
        const baseId = pokemon.name.toLowerCase().replace(/[^a-z0-9]/g, '');
        const data = typeof POKEDEX !== 'undefined' ? POKEDEX[baseId] : null;
        if (!data) return null;
        const hpRatio = pokemon.currHp / pokemon.maxHp;
        // ============================================
        // è·¯å¾„ A: ç”Ÿå‘½è¿›åŒ– (Biological Evolution)
        // é€‚ç”¨ï¼šæœªå®Œå…¨è¿›åŒ–çš„å®å¯æ¢¦ï¼Œå±æœºæ—¶çªç ´
        // ============================================
        if (data.evos && data.evos.length > 0) {
            // å·² Mega æˆ–å·²å˜èº«çš„ä¸èƒ½å†è¿›åŒ–
            if (pokemon.isMega || pokemon.isTransformed) return null;
            const nextFormName = data.evos[0];
            const nextId = nextFormName.toLowerCase().replace(/[^a-z0-9]/g, '');
            const nextData = typeof POKEDEX !== 'undefined' ? POKEDEX[nextId] : null;
            if (!nextData) return null;
            // ã€ç‰¹æ®Šè¿›åŒ–æ£€æŸ¥ã€‘åªæœ‰ç­‰çº§è¿›åŒ–æˆ–äº²å¯†åº¦è¿›åŒ–æ‰èƒ½è§¦å‘æˆ˜æ–—EVO
            // é“å…·è¿›åŒ–(useItem)ã€äº¤æ¢è¿›åŒ–(trade)ã€ç‰¹æ®Šæ¡ä»¶è¿›åŒ–ç­‰ä¸è§¦å‘
            // ä¾‹å¦‚ï¼šä¼Šå¸ƒéœ€è¦é“å…·è¿›åŒ–ï¼Œä¸åº”è§¦å‘æˆ˜æ–—EVO
            const allowedEvoTypes = [undefined, 'levelFriendship'];
            if (!allowedEvoTypes.includes(nextData.evoType)) return null;
            // 1. ç­‰çº§é” (å…è®¸è¶Šçº§3çº§)
            const reqLevel = Math.max(1, (nextData.evoLevel || 1) - 3);
            if (pokemon.level < reqLevel) return null;
            // 2. AVs é˜ˆå€¼ï¼š
            // ä¸€é˜¶(æ— prevo): 80
            // äºŒé˜¶(æœ‰prevo): 160
            // åªæœ‰ä¸€æ¬¡è¿›åŒ–(æœ‰prevoä½†è¿›åŒ–å‹æ— evos): 140
            const isFirstStage = !data.prevo;
            const nextHasEvos = nextData.evos && nextData.evos.length > 0;
            let reqAVs;
            if (isFirstStage) {
                reqAVs = 80;  // ä¸€é˜¶æ®µ
            } else if (!nextHasEvos) {
                reqAVs = 140; // åªæœ‰ä¸€æ¬¡å‡çº§ï¼ˆäºŒé˜¶è¿›åŒ–åˆ°æœ€ç»ˆå½¢æ€ï¼‰
            } else {
                reqAVs = 160; // äºŒé˜¶æ®µï¼ˆè¿˜èƒ½ç»§ç»­è¿›åŒ–ï¼‰
            }
            if (totalAVs < reqAVs) return null;
            // 3. å±æœºé” (HP 35% ä»¥ä¸‹) æˆ– Ace å®å¯æ¢¦ 60% ä»¥ä¸‹
            const isCrisis = hpRatio <= 0.45;
            const isAceMoment = pokemon.isAce && hpRatio <= 0.6;
            if (isCrisis || isAceMoment) {
                return {
                    type: 'bio',
                    currentName: pokemon.cnName,
                    targetName: nextFormName,
                    targetId: nextId,
                    nextData: nextData,
                    totalAVs: totalAVs,
                    reqAVs: reqAVs
                };
            }
        }
        // ============================================
        // è·¯å¾„ B: çµé­‚å…±é¸£ (Bond Resonance)
        // é€‚ç”¨ï¼šæœ€ç»ˆå½¢æ€ï¼Œç»å¢ƒæ—¶çš„æœ€ååæ‰‘
        // ============================================
        else {
            // ã€è§£é”æ£€æŸ¥ã€‘ç»¿è‰²ç¾ç»Šå…±é¸£éœ€è¦ enable_bond è§£é”
            const unlocks = battle.playerUnlocks || {};
            if (unlocks.enable_bond === false) return null;
            // ã€å…¨å±€é™åˆ¶ã€‘æ¯åœºæˆ˜æ–—åªèƒ½ä½¿ç”¨ä¸€æ¬¡ Bond Resonance
            if (battle.playerBondUsed) return null;
            // æœ€ç»ˆå½¢æ€ (æ— è¿›åŒ–å‹)
            // 1. AVs ç»å¯¹é˜ˆå€¼ï¼ˆæ”¾å®½è‡³ 220ï¼‰
            if (totalAVs < 220) return null;
            // 2. å¿…é¡»æ˜¯ Ace å®å¯æ¢¦
            if (!pokemon.isAce) return null;
            // 3. ã€ä¸¥æ ¼åŠ£åŠ¿åˆ¤æ–­ã€‘ä¸ AI ä¸€è‡´
            //    è®¡ç®—åŒæ–¹æ€»è¡€é‡
            let playerTotalHp = 0, enemyTotalHp = 0;
            battle.playerParty.forEach(pp => {
                if (pp && typeof pp.isAlive === 'function') {
                    playerTotalHp += Math.max(0, pp.currHp || 0);
                }
            });
            battle.enemyParty.forEach(ep => {
                if (ep && typeof ep.isAlive === 'function') {
                    enemyTotalHp += Math.max(0, ep.currHp || 0);
                }
            });
            const aliveCount = battle.playerParty.filter(p => p && typeof p.isAlive === 'function' && p.isAlive()).length;
            const isLastStand = aliveCount === 1;
            // ã€ä¸¥æ ¼åŠ£åŠ¿æ¡ä»¶ã€‘
            // æ ¸å¿ƒæ¡ä»¶ï¼šå¿…é¡»æ˜¯æœ€åä¸€åªå®å¯æ¢¦ ä¸” HP <= 50%
            // å°è§„æ¨¡æˆ˜æ–—ï¼ˆåŒæ–¹å„ <= 2 åªï¼‰æ—¶ï¼Œå…è®¸è¡€é‡åŠ£åŠ¿è§¦å‘
            const currentPokemonCritical = hpRatio <= 0.50;
            const isSmallBattle = (battle.playerParty.length <= 2 && battle.enemyParty.length <= 2);
            const isHpDisadvantage = playerTotalHp < enemyTotalHp * 0.5;
            // è§¦å‘æ¡ä»¶ï¼š
            // 1. æœ€åä¸€åªå®å¯æ¢¦ + HP <= 50%
            // 2. æˆ–è€… å°è§„æ¨¡æˆ˜æ–— + è¡€é‡åŠ£åŠ¿ + HP <= 50%
            const canTriggerBond = currentPokemonCritical && (isLastStand || (isSmallBattle && isHpDisadvantage));
            if (canTriggerBond) {
                return {
                    type: 'bond',
                    currentName: pokemon.cnName,
                    targetName: `ç¾ç»ŠÂ·${pokemon.cnName}`,
                    totalAVs: totalAVs,
                    isLastStand: isLastStand,
                    isHpDisadvantage: isHpDisadvantage
                };
            }
        }
        return null;
    }
};
/**
 * æ›´æ–°è¿›åŒ–æŒ‰é’®å¯è§æ€§
 * åœ¨ updateAllVisuals ä¸­è°ƒç”¨
 */
function updateEvolutionButtonVisuals() {
    const btn = document.getElementById('btn-evolved');
    if (!btn) return;
    const p = battle.getPlayer();
    if (!p) {
        btn.classList.add('hidden');
        return;
    }
    const evoInfo = window.EvolutionSystem.checkEligibility(p);
    if (evoInfo) {
        btn.classList.remove('hidden');
        // æ ¹æ®ç±»å‹æ›´æ–°æŒ‰é’®æ ·å¼
        if (evoInfo.type === 'bond') {
            btn.classList.add('bond-mode');
            btn.title = 'ç¾ç»Šå…±é¸£ (Bond Resonance)';
        } else {
            btn.classList.remove('bond-mode');
            btn.title = 'è¿›åŒ– (Evolution)';
        }
        // æ˜¾ç¤ºæç¤ºæ—¥å¿—ï¼ˆæ¯ç§ç±»å‹åªæç¤ºä¸€æ¬¡ï¼‰
        if (evoInfo.type === 'bio' && !p._evoHintLogged) {
            log(`<span style="color:#d4ac0d; text-shadow:0 0 5px gold;">âœ¨ ${p.cnName} çš„å‘¨èº«æ¶ŒåŠ¨ç€è¿›åŒ–çš„å…‰èŠ’...å®ƒåœ¨å›åº”ä½ çš„æ„å¿—ï¼</span>`);
            p._evoHintLogged = true;
            // ã€Commander System V2ã€‘æç¤ºæ—¥å¿—å¼¹å‡ºååˆ·æ–°æ‚¬æµ®çª—
            if (typeof window.refreshCommanderBubble === 'function') {
                window.refreshCommanderBubble();
            }
        } else if (evoInfo.type === 'bond' && !p._bondHintLogged) {
            log(`<span style="color:#4ade80; text-shadow:0 0 8px #22c55e;">âˆ ${p.cnName} ä¸è®­ç»ƒå®¶çš„å¿ƒè·³å¼€å§‹åŒæ­¥...ç¾ç»Šæ­£åœ¨è§‰é†’ï¼</span>`);
            p._bondHintLogged = true;
            // ã€Commander System V2ã€‘æç¤ºæ—¥å¿—å¼¹å‡ºååˆ·æ–°æ‚¬æµ®çª—
            if (typeof window.refreshCommanderBubble === 'function') {
                window.refreshCommanderBubble();
            }
        }
    } else {
        btn.classList.add('hidden');
    }
}
/**
 * è§¦å‘æˆ˜æ–—ä¸­è¿›åŒ–/ç¾ç»Šå…±é¸£
 * ç‚¹å‡» EVO æŒ‰é’®æ—¶è°ƒç”¨
 */
window.triggerBattleEvolution = async function() {
    const btn = document.getElementById('btn-evolved');
    const p = battle.getPlayer();
    if (!p) return;
    const evoInfo = window.EvolutionSystem.checkEligibility(p);
    if (!evoInfo) return;
    battle.locked = true;
    btn.classList.add('hidden');
    const spriteRef = document.getElementById('player-sprite');
    // ============================================
    // è·¯å¾„ A: ç”Ÿå‘½è¿›åŒ– (Biological Evolution)
    // ============================================
    if (evoInfo.type === 'bio') {
        p.hasEvolvedThisBattle = true;
        const oldName = p.cnName;
        log(`<div class="log-evo-intro">âœ¨ å®å¯æ¢¦è¿›åŒ– âœ¨</div>`);
        log(`${oldName} çš„æ ·å­â€¦â€¦ï¼`);
        await wait(300);
        // åŠ¨ç”»ï¼šæ™®é€šè¿›åŒ–ç™½å…‰ï¼ˆä¸ Mega åŒºåˆ†ï¼‰
        if (spriteRef) {
            spriteRef.classList.add('bio-evo-glow');
        }
        await wait(800);
        // æ•°æ®å˜æ›´
        const newData = evoInfo.nextData;
        p.name = newData.name;
        p.cnName = newData.name;
        p.types = newData.types || p.types;
        p.baseStats = newData.baseStats;
        const stats = calcStats(p.baseStats, p.level, {
            ivs: p.statsMeta?.ivs || { hp: 31, atk: 31, def: 31, spa: 31, spd: 31, spe: 31 },
            ev_level: p.statsMeta?.ev_level || 0,
            nature: p.nature
        });
        p.maxHp = stats.hp;
        p.atk = stats.atk;
        p.def = stats.def;
        p.spa = stats.spa;
        p.spd = stats.spd;
        p.spe = stats.spe;
        // å…¨å›å¤ + æ¸…çŠ¶æ€
        p.currHp = p.maxHp;
        p.status = null;
        // å…¨èƒ½åŠ›+1
        if (typeof p.applyBoost === 'function') {
            p.applyBoost('atk', 1);
            p.applyBoost('def', 1);
            p.applyBoost('spa', 1);
            p.applyBoost('spd', 1);
            p.applyBoost('spe', 1);
        }
        // ç™½å…‰çˆ†å‘ + æ¢å›¾
        if (spriteRef) {
            spriteRef.classList.remove('bio-evo-glow');
            spriteRef.classList.add('bio-evo-burst');
            const newSrc = p.getSprite(true);
            if (typeof smartLoadSprite === 'function') {
                delete spriteRequestedUrls['player-sprite'];
                smartLoadSprite('player-sprite', newSrc, false);
                spriteRequestedUrls['player-sprite'] = newSrc;
            }
        }
        await wait(400);
        // å†·å´åŠ¨ç”»
        if (spriteRef) {
            spriteRef.classList.remove('bio-evo-burst');
            spriteRef.classList.add('bio-evo-finish');
        }
        await wait(600);
        // æ¸…ç†åŠ¨ç”»ç±»ï¼ˆä¿ç•™ player-scale ç±»ï¼‰
        if (spriteRef) {
            spriteRef.classList.remove('bio-evo-silhouette', 'bio-evo-burst', 'bio-evo-finish');
            if (!spriteRef.classList.contains('loaded')) {
                spriteRef.classList.add('loaded');
            }
        }
        log(`â€¦â€¦${oldName} å…¨èº«åŒ…å›´äº†è€€çœ¼çš„å…‰èŠ’ï¼`);
        log(`<b style="color:#a855f7">æ­å–œï¼${oldName} è¿›åŒ–æˆäº† ${p.cnName}ï¼</b>`);
        log(`<span style="color:#4ade80">ä½“èƒ½å®Œå…¨æ¢å¤ï¼å…¨èƒ½åŠ›æå‡äº†ï¼</span>`);
        // AVs æ•ˆæœç¿»å€
        if (p.avs) {
            p.avsEvolutionBoost = true;
            log(`<span style="color:#ff6b9d">ğŸ’– è¿›åŒ–æ¿€å‘äº†æ½œåœ¨çš„æƒ…æ„ŸåŠ›é‡ï¼AVs æ•ˆæœç¿»å€ï¼</span>`);
        }
    }
    // ============================================
    // è·¯å¾„ B: çµé­‚å…±é¸£ (Bond Resonance)
    // ============================================
    else if (evoInfo.type === 'bond') {
        p.hasBondResonance = true;
        battle.playerBondUsed = true; // ã€å…¨å±€é™åˆ¶ã€‘æ ‡è®°å·²ä½¿ç”¨
        const oldName = p.cnName;
        const avs = p.avs || {};
        const totalAVs = (avs.trust || 0) + (avs.passion || 0) + (avs.insight || 0) + (avs.devotion || 0);
        // æ ‡é¢˜
        log(`<div style="border-top: 2px solid #4ade80; border-bottom: 2px solid #4ade80; padding: 8px; text-align: center; margin: 10px 0; background: linear-gradient(90deg, rgba(74,222,128,0.1), rgba(74,222,128,0.3), rgba(74,222,128,0.1));">`);
        log(`<b style="font-size:1.4em; color:#4ade80; text-shadow: 0 0 10px #22c55e;">âˆ BOND RESONANCE âˆ</b>`);
        log(`</div>`);
        await wait(500);
        log(`ä¸¤äººçš„å¿ƒè·³å®Œå…¨é‡åˆäº†â€¦â€¦`);
        await wait(400);
        log(`ä¸ºäº†å›åº”å½»åº•çš„ä¿¡èµ– <span style="color:#facc15">(Total AVs: ${totalAVs})</span>ï¼Œæ²‰ç¡åœ¨ä½“å†…çš„ç•Œé™è¢«æ‰“ç ´äº†ï¼`);
        // åŠ¨ç”»ï¼šé‡‘è‰²å…‰æ™•çˆ†å‘ï¼ˆä¸æ¢å›¾ï¼‰
        if (spriteRef) {
            spriteRef.classList.add('evo-burst');
            spriteRef.style.filter = 'brightness(3) drop-shadow(0 0 20px gold)';
        }
        await wait(400);
        if (spriteRef) {
            spriteRef.classList.remove('evo-burst');
            spriteRef.classList.add('evo-finish');
            // ä¿æŒé‡‘è‰²å…‰æ™•
            spriteRef.style.filter = 'drop-shadow(0 0 15px gold) brightness(1.15) saturate(1.2)';
        }
        await wait(600);
        if (spriteRef) {
            spriteRef.classList.remove('evo-finish');
            // æ·»åŠ ç¾ç»ŠçŠ¶æ€æ ‡è®°
            spriteRef.classList.add('bond-resonance');
        }
        // æ•°æ®å˜æ›´ï¼šä¸æ”¹å˜å½¢æ€ï¼Œä½†å¤§å¹… buff
        // 1. HP å›å¤ +60%ï¼ˆä¸æº¢å‡ºä¸Šé™ï¼‰
        const healAmount = Math.floor(p.maxHp * 0.6);
        p.currHp = Math.min(p.currHp + healAmount, p.maxHp);
        // 2. æ¸…é™¤æ‰€æœ‰å¼‚å¸¸
        p.status = null;
        // 3. å…¨èƒ½åŠ›+1ï¼ˆå¹³è¡¡è°ƒæ•´ï¼ŒåŸ +2ï¼‰
        if (typeof p.applyBoost === 'function') {
            p.applyBoost('atk', 1);
            p.applyBoost('def', 1);
            p.applyBoost('spa', 1);
            p.applyBoost('spd', 1);
            p.applyBoost('spe', 1);
            // è‹¥æœ‰ç‰¹æ®Šçš„ç¾ç»ŠæŒ‡æ ‡ï¼Œå¯ä»¥é™„åŠ é¢å¤–åŠ æˆ
            log(`<b style="color:#4ade80">âœ¦ ${p.cnName} çš„æ½œèƒ½è¢«å”¤é†’! æ”»é˜²ç‰¹æ”»ç‰¹é˜²é€Ÿåº¦å…¨é¢æå‡!</b>`);
        }
        await wait(300);
        log(`è¿™å¹¶éè¿›åŒ–â€¦â€¦è€Œæ˜¯è¶…è¶Šè¿›åŒ–çš„ <b style="color:#facc15">å…±é¸£å½¢æ€</b>ï¼`);
        log(`<span style="color:#4ade80">âœ¦ å…¨å±æ€§æå¤§å¹…æå‡ï¼</span>`);
        log(`<span style="color:#60a5fa">âœ¦ æ°”åŠ¿(HP)å¤§å¹…å›å¤ï¼(+${healAmount})</span>`);
        log(`<span style="color:#ff6b9d">âœ¦ AVs æ•ˆæœç¿»å€ï¼</span>`);
        if (evoInfo.isLastStand) {
            log(`<span style="color:#f87171; font-style:italic;">ã€Œå“ªæ€•åªå‰©æœ€åä¸€å£æ°”â€¦â€¦ä¹Ÿç»ä¸ä¼šæ”¾å¼ƒï¼ã€</span>`);
        }
    }
    updateAllVisuals();
    battle.locked = false;
    // ã€Commander System V2ã€‘è¿›åŒ–å®Œæˆåå¼ºåˆ¶åˆ·æ–°æ‚¬æµ®çª—
    if (typeof window.refreshCommanderBubble === 'function') {
        window.refreshCommanderBubble();
    }
};
// =========================================================
// COMMANDER SYSTEM (æˆ˜æœ¯æŒ‡æŒ¥ç³»ç»Ÿ)
// =========================================================
// è®­ç»ƒå®¶ç†Ÿç»ƒåº¦å†³å®šæŒ‡æŒ¥èœå•å¼¹å‡ºé¢‘ç‡
// æŒ‡ä»¤æ˜ å°„åˆ° AVS å››ç»´ï¼Œæä¾›å¼ºåŠ›çš„å³æ—¶å¢ç›Š
/**
 * åˆå§‹åŒ–æˆ˜æœ¯æŒ‡æŒ¥ç³»ç»Ÿ
 * åœ¨æˆ˜æ–—å¼€å§‹æ—¶è°ƒç”¨
 */
function initCommanderSystem() {
    // è®­ç»ƒå®¶ç†Ÿç»ƒåº¦ (0-255)ï¼Œå½±å“è§¦å‘æ¦‚ç‡
    // ä» JSON è¯»å–ï¼Œé»˜è®¤ 0ï¼ˆæ–°æ‰‹è®­ç»ƒå®¶ï¼‰
    // JSON æ ¼å¼: player.trainerProficiency
    // æ³¨æ„ï¼šä½¿ç”¨ ?? è€Œä¸æ˜¯ ||ï¼Œé¿å… 0 è¢«å½“ä½œ falsy å€¼
    battle.trainerProficiency = battle.trainerProficiency ?? 0;
    // å½“å‰å›åˆçš„æ´»è·ƒæŒ‡ä»¤
    battle.activeCommand = null;
    // æœ¬åœºæˆ˜æ–—æŒ‡ä»¤ä½¿ç”¨æ¬¡æ•°ï¼ˆå…¨å±€è®¡æ•°ï¼‰
    // æ–°è§„åˆ™ï¼šdodge/crit æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€ä¸é™ï¼ˆæœ€å¤š6æ¬¡ï¼‰
    //        cure/endure æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€é™åˆ¶2æ¬¡
    battle.commandUsage = {
        dodge: 0,    // DODGE! (Insight) - æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€ä¸é™
        crit: 0,     // FOCUS! (Passion) - æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€ä¸é™
        cure: 0,     // LISTEN! (Devotion) - æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€2æ¬¡
        endure: 0    // ENDURE! (Trust) - æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€2æ¬¡
    };
    // æ¯ç§æŒ‡ä»¤çš„æœ€å¤§ä½¿ç”¨æ¬¡æ•°ï¼ˆå…¨å±€ï¼‰
    battle.commandLimits = {
        dodge: 99,   // æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€ä¸é™ï¼ˆç”±å®å¯æ¢¦æ ‡è®°æ§åˆ¶ï¼‰
        crit: 99,    // æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€ä¸é™ï¼ˆç”±å®å¯æ¢¦æ ‡è®°æ§åˆ¶ï¼‰
        cure: 2,     // å…¨å±€ 2 æ¬¡
        endure: 2    // å…¨å±€ 2 æ¬¡
    };
    // æŒ‡ä»¤å†·å´ï¼ˆå›åˆæ•°ï¼‰
    // ã€åˆå§‹å†·å´ã€‘Commander Score < 120 æ—¶ï¼Œæˆ˜æ–—å¼€å§‹å°±æœ‰å†·å´
    const p = battle.getPlayer?.();
    const initSyncScore = p ? getCommanderSyncScore(battle.trainerProficiency ?? 0, p) : 0;
    if (initSyncScore < 120) {
        // ä½åŒæ­¥ç‡ï¼šæˆ˜æ–—å¼€å§‹æ—¶æœ‰åˆå§‹å†·å´
        battle.commandCooldown = getCommanderCooldown(initSyncScore);
        if (battle.commandCooldown < 0) battle.commandCooldown = 0; // ä¸å¯ç”¨æ—¶è®¾ä¸º0
        console.log(`[COMMANDER v2] åˆå§‹å†·å´: ${battle.commandCooldown}å›åˆ (åŒæ­¥ç‡: ${initSyncScore} < 120)`);
    } else {
        // é«˜åŒæ­¥ç‡(120+)ï¼šæ— åˆå§‹å†·å´ï¼Œç¬¬ä¸€å›åˆå³å¯ä½¿ç”¨
        battle.commandCooldown = 0;
        console.log(`[COMMANDER v2] æ— åˆå§‹å†·å´ (åŒæ­¥ç‡: ${initSyncScore} >= 120)`);
    }
    // ã€Styles åˆå§‹å†·å´ã€‘ç†Ÿç»ƒåº¦ < 101 æ—¶ï¼Œæˆ˜æ–—å¼€å§‹å°±æœ‰å†·å´
    const proficiency = battle.trainerProficiency ?? 0;
    if (proficiency < 101) {
        // ä½ç†Ÿç»ƒåº¦ï¼šæˆ˜æ–—å¼€å§‹æ—¶æœ‰åˆå§‹å†·å´
        battle.playerStyleCooldown = getStyleCooldown(proficiency);
        console.log(`[STYLES v3] åˆå§‹å†·å´: ${battle.playerStyleCooldown}å›åˆ (ç†Ÿç»ƒåº¦: ${proficiency} < 101)`);
    } else {
        // é«˜ç†Ÿç»ƒåº¦(101+)ï¼šæ— åˆå§‹å†·å´ï¼Œç¬¬ä¸€å›åˆå³å¯ä½¿ç”¨
        battle.playerStyleCooldown = 0;
        console.log(`[STYLES v3] æ— åˆå§‹å†·å´ (ç†Ÿç»ƒåº¦: ${proficiency} >= 101)`);
    }
    console.log(`[COMMANDER v2] System initialized. Proficiency: ${proficiency}, SyncScore: ${initSyncScore}`);
}
/**
 * æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºæŒ‡æŒ¥èœå•
 * ã€v2ã€‘æ”¹ä¸ºå›ºå®šè§¦å‘ + åŸºäºåŒæ­¥ç‡çš„åŠ¨æ€å†·å´
 * åœ¨ showMovesMenu æ—¶è°ƒç”¨
 * @returns {boolean}
 */
function shouldShowCommanderMenu() {
    // ã€å…¨å±€å¼€å…³ã€‘Commander ç³»ç»Ÿå…³é—­æ—¶ä¸æ˜¾ç¤º
    if (window.GAME_SETTINGS && !window.GAME_SETTINGS.enableCommander) return false;
    if (!battle || battle.locked) return false;
    const p = battle.getPlayer();
    if (!p || !p.isAce || p.currHp <= 0) return false;
    // ã€v2ã€‘è®¡ç®—åŒæ­¥ç‡
    const proficiency = battle.trainerProficiency ?? 0;
    const syncScore = getCommanderSyncScore(proficiency, p);
    const requiredCooldown = getCommanderCooldown(syncScore);
    // åŒæ­¥ç‡ä¸è¶³ï¼Œæ— æ³•ä½¿ç”¨æŒ‡æŒ¥ç³»ç»Ÿ
    if (requiredCooldown < 0) {
        console.log(`[COMMANDER v2] åŒæ­¥ç‡ä¸è¶³ (${syncScore}), æ— æ³•ä½¿ç”¨æŒ‡æŒ¥ç³»ç»Ÿ`);
        return false;
    }
    // å†·å´ä¸­
    if (battle.commandCooldown > 0) {
        console.log(`[COMMANDER v2] å†·å´ä¸­: ${battle.commandCooldown}å›åˆ (åŒæ­¥ç‡: ${syncScore})`);
        return false;
    }
    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¯ç”¨æŒ‡ä»¤
    // dodge/crit: æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€ä¸é™
    // cure/endure: æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€é™åˆ¶2æ¬¡
    const dodgeAvailable = !p.commandDodgeUsed;
    const critAvailable = !p.commandCritUsed;
    const cureAvailable = !p.commandCureUsed && battle.commandUsage.cure < battle.commandLimits.cure;
    const endureAvailable = !p.commandEndureUsed && battle.commandUsage.endure < battle.commandLimits.endure;
    const hasAvailableCommand = dodgeAvailable || critAvailable || cureAvailable || endureAvailable;
    if (!hasAvailableCommand) {
        console.log(`[COMMANDER v2] ${p.cnName} æ— å¯ç”¨æŒ‡ä»¤`);
        return false;
    }
    // ã€v2ã€‘å›ºå®šè§¦å‘ï¼Œä¸å†éšæœº
    console.log(`[COMMANDER v2] æŒ‡æŒ¥å¯ç”¨! åŒæ­¥ç‡: ${syncScore}, å†·å´å‘¨æœŸ: ${requiredCooldown}å›åˆ`);
    return true;
}
/**
 * æ˜¾ç¤ºæŒ‡æŒ¥èœå•
 */
function showCommanderMenu() {
    const overlay = document.getElementById('commander-overlay');
    if (!overlay) return;
    // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆç¦ç”¨å·²ç”¨å®Œçš„æŒ‡ä»¤ï¼‰
    updateCommanderButtons();
    overlay.classList.remove('hidden');
    // æ’­æ”¾éŸ³æ•ˆ
    if (typeof window.playSFX === 'function') {
        window.playSFX('CONFIRM');
    }
    // æ—¥å¿—æç¤º
    log(`<span style="color:#fbbf24; font-weight:bold;">âš¡ çµå…‰ä¸€é—ªï¼ä½ æ„Ÿå—åˆ°äº†ä¸ä¼™ä¼´çš„å¿ƒçµå…±é¸£ï¼</span>`);
    console.log(`[COMMANDER] Menu shown`);
}
/**
 * å…³é—­æŒ‡æŒ¥èœå•
 */
function closeCommanderMenu() {
    const overlay = document.getElementById('commander-overlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
    if (typeof window.playSFX === 'function') {
        window.playSFX('CANCEL');
    }
    console.log(`[COMMANDER] Menu closed (cancelled)`);
}
/**
 * æ›´æ–°æŒ‡æŒ¥æŒ‰é’®çŠ¶æ€
 */
function updateCommanderButtons() {
    const p = battle.getPlayer();
    const btnMap = {
        dodge: '.pos-top',
        cure: '.pos-left',
        crit: '.pos-right',
        endure: '.pos-bottom'
    };
    // dodge å’Œ crit: æ¯åªå®å¯æ¢¦ä¸€æ¬¡ï¼Œå…¨å±€ä¸é™
    const dodgeBtn = document.querySelector(btnMap.dodge);
    if (dodgeBtn && p) {
        if (p.commandDodgeUsed) {
            dodgeBtn.disabled = true;
            dodgeBtn.style.opacity = '0.4';
            dodgeBtn.style.pointerEvents = 'none';
        } else {
            dodgeBtn.disabled = false;
            dodgeBtn.style.opacity = '1';
            dodgeBtn.style.pointerEvents = 'auto';
        }
    }
    const critBtn = document.querySelector(btnMap.crit);
    if (critBtn && p) {
        if (p.commandCritUsed) {
            critBtn.disabled = true;
            critBtn.style.opacity = '0.4';
            critBtn.style.pointerEvents = 'none';
        } else {
            critBtn.disabled = false;
            critBtn.style.opacity = '1';
            critBtn.style.pointerEvents = 'auto';
        }
    }
    // cure å’Œ endure: æ¯åªå®å¯æ¢¦ä¸€æ¬¡ + å…¨å±€é™åˆ¶2æ¬¡
    const cureBtn = document.querySelector(btnMap.cure);
    if (cureBtn && p) {
        const cureDisabled = p.commandCureUsed || battle.commandUsage.cure >= battle.commandLimits.cure;
        if (cureDisabled) {
            cureBtn.disabled = true;
            cureBtn.style.opacity = '0.4';
            cureBtn.style.pointerEvents = 'none';
        } else {
            cureBtn.disabled = false;
            cureBtn.style.opacity = '1';
            cureBtn.style.pointerEvents = 'auto';
        }
    }
    const endureBtn = document.querySelector(btnMap.endure);
    if (endureBtn && p) {
        const endureDisabled = p.commandEndureUsed || battle.commandUsage.endure >= battle.commandLimits.endure;
        if (endureDisabled) {
            endureBtn.disabled = true;
            endureBtn.style.opacity = '0.4';
            endureBtn.style.pointerEvents = 'none';
        } else {
            endureBtn.disabled = false;
            endureBtn.style.opacity = '1';
            endureBtn.style.pointerEvents = 'auto';
        }
    }
}
/**
 * è£…å¡«æŒ‡ä»¤ï¼ˆç±»ä¼¼ MEGA çš„ armed æ¨¡å¼ï¼‰
 * æŒ‡ä»¤åœ¨é€‰æ‹©æŠ€èƒ½åçš„å›åˆç»“ç®—æ—¶æ‰ä¼šè§¦å‘
 * @param {string} command - æŒ‡ä»¤ç±»å‹: 'dodge', 'crit', 'cure', 'endure'
 */
window.armCommand = function(command) {
    const p = battle.getPlayer();
    if (!p) return;
    const commandInfo = {
        dodge: { emoji: 'ğŸ‘ï¸', label: 'DODGE!', cn: 'å¿«é¿å¼€', avs: 'Insight', color: '#00cec9' },
        crit: { emoji: 'ğŸ”¥', label: 'FOCUS!', cn: 'å‡»ä¸­è¦å®³', avs: 'Passion', color: '#ff6b6b' },
        cure: { emoji: 'ğŸ¤', label: 'LISTEN!', cn: 'å¿«æ¸…é†’', avs: 'Trust', color: '#f1c40f' },
        endure: { emoji: 'ğŸ›¡ï¸', label: 'HOLD ON!', cn: 'æ’‘ä¸‹å»', avs: 'Devotion', color: '#a55eea' }
    };
    // å¦‚æœå·²ç»è£…å¡«äº†åŒä¸€ä¸ªæŒ‡ä»¤ï¼Œåˆ™å–æ¶ˆ
    if (battle.commandArmed === command) {
        battle.commandArmed = null;
        log(`<span style="color:#94a3b8">å–æ¶ˆ ${commandInfo[command].label} æŒ‡ä»¤é¢„å¤‡ã€‚</span>`);
        console.log(`[COMMANDER] Command disarmed: ${command}`);
        return false; // è¿”å› false è¡¨ç¤ºå–æ¶ˆ
    }
    // ã€äº’æ–¥ã€‘é€‰æ‹©æŒ‡ä»¤æ—¶ï¼Œè‡ªåŠ¨å–æ¶ˆé£æ ¼é¢„å¤‡
    if (window.currentMoveStyle && window.currentMoveStyle !== 'normal') {
        log(`<span style="color:#94a3b8">å–æ¶ˆé£æ ¼é¢„å¤‡ï¼Œåˆ‡æ¢ä¸ºæŒ‡ä»¤æ¨¡å¼ã€‚</span>`);
        window.currentMoveStyle = 'normal';
        if (typeof window.setMoveStyle === 'function') {
            window.setMoveStyle('normal');
        }
    }
    // ã€äº’æ–¥ã€‘é€‰æ‹©æŒ‡ä»¤æ—¶ï¼Œè‡ªåŠ¨å–æ¶ˆè¿›åŒ–é¢„å¤‡
    if (battle.evoArmed) {
        log(`<span style="color:#94a3b8">å–æ¶ˆè¿›åŒ–é¢„å¤‡ï¼Œåˆ‡æ¢ä¸ºæŒ‡ä»¤æ¨¡å¼ã€‚</span>`);
        battle.evoArmed = null;
    }
    // æ£€æŸ¥æ¯åªå®å¯æ¢¦ä¸€æ¬¡çš„é™åˆ¶
    const usedKey = `command${command.charAt(0).toUpperCase() + command.slice(1)}Used`;
    if (p[usedKey]) {
        log(`<span style="color:#ef4444;">${p.cnName} æœ¬åœºæˆ˜æ–—å·²ç»ä½¿ç”¨è¿‡ ${commandInfo[command].label} æŒ‡ä»¤äº†ï¼</span>`);
        return false;
    }
    // æ£€æŸ¥å…¨å±€ä½¿ç”¨æ¬¡æ•°ï¼ˆcure/endure å…¨å±€é™åˆ¶2æ¬¡ï¼‰
    if ((command === 'cure' || command === 'endure') && 
        battle.commandUsage[command] >= battle.commandLimits[command]) {
        log(`<span style="color:#ef4444;">${commandInfo[command].label} æŒ‡ä»¤å…¨å±€æ¬¡æ•°å·²ç”¨å°½ï¼</span>`);
        return false;
    }
    // åˆ‡æ¢æŒ‡ä»¤ï¼šå–æ¶ˆä¹‹å‰çš„ï¼Œè®¾ç½®æ–°çš„
    if (battle.commandArmed && battle.commandArmed !== command) {
        const oldInfo = commandInfo[battle.commandArmed];
        log(`<span style="color:#94a3b8">å–æ¶ˆ ${oldInfo.label} æŒ‡ä»¤ï¼Œåˆ‡æ¢ä¸º ${commandInfo[command].label}</span>`);
    }
    // è£…å¡«æŒ‡ä»¤
    battle.commandArmed = command;
    const info = commandInfo[command];
    log(`<span style="color:${info.color}">ğŸ¯ ${info.label} æŒ‡ä»¤å°±ç»ªï¼é€‰æ‹©æ‹›å¼åå°†è§¦å‘ï¼</span>`);
    console.log(`[COMMANDER] Command armed: ${command}`);
    return true; // è¿”å› true è¡¨ç¤ºè£…å¡«æˆåŠŸ
};
/**
 * è§¦å‘å·²è£…å¡«çš„æŒ‡ä»¤ï¼ˆåœ¨å›åˆç»“ç®—æ—¶è°ƒç”¨ï¼‰
 * @returns {boolean} æ˜¯å¦è§¦å‘äº†æŒ‡ä»¤
 */
window.triggerArmedCommand = function() {
    const command = battle.commandArmed;
    if (!command) return false;
    const p = battle.getPlayer();
    if (!p) return false;
    const commandInfo = {
        dodge: { emoji: 'ğŸ‘ï¸', label: 'DODGE!', cn: 'å¿«é¿å¼€', avs: 'Insight', color: '#00cec9' },
        crit: { emoji: 'ğŸ”¥', label: 'FOCUS!', cn: 'å‡»ä¸­è¦å®³', avs: 'Passion', color: '#ff6b6b' },
        cure: { emoji: 'ğŸ¤', label: 'LISTEN!', cn: 'å¿«æ¸…é†’', avs: 'Trust', color: '#f1c40f' },
        endure: { emoji: 'ğŸ›¡ï¸', label: 'HOLD ON!', cn: 'æ’‘ä¸‹å»', avs: 'Devotion', color: '#a55eea' }
    };
    const info = commandInfo[command];
    // æ ‡è®°ä½¿ç”¨
    battle.activeCommand = command;
    battle.commandUsage[command]++;
    // æ ‡è®°æ¯åªå®å¯æ¢¦ä¸€æ¬¡çš„æŒ‡ä»¤
    const usedKey = `command${command.charAt(0).toUpperCase() + command.slice(1)}Used`;
    p[usedKey] = true;
    // ã€v2ã€‘åŸºäºåŒæ­¥ç‡çš„åŠ¨æ€å†·å´
    const proficiency = battle.trainerProficiency ?? 0;
    const syncScore = getCommanderSyncScore(proficiency, p);
    const commandCooldown = getCommanderCooldown(syncScore);
    battle.commandCooldown = Math.max(1, commandCooldown);
    console.log(`[COMMANDER v2] è®¾ç½®å†·å´: ${battle.commandCooldown}å›åˆ (åŒæ­¥ç‡: ${syncScore})`);
    // æ’­æ”¾éŸ³æ•ˆ
    if (typeof window.playSFX === 'function') {
        window.playSFX('MEGA_EVOLVE');
    }
    // æ—¥å¿—è¾“å‡º
    log(`<div style="border-left: 4px solid ${info.color}; padding-left: 10px; margin: 5px 0;">`);
    log(`<b style="color:${info.color}; font-size: 1.1em;">ğŸ—£ï¸ [æŒ‡æŒ¥] "${info.cn}ï¼"</b>`);
    log(`<span style="color:#9ca3af; font-size: 0.9em;">${p.cnName} æ„Ÿå—åˆ°äº†è®­ç»ƒå®¶çš„æ„å¿—ï¼(${info.avs})</span>`);
    log(`</div>`);
    console.log(`[COMMANDER] Command triggered: ${command} (${info.cn})`);
    // åº”ç”¨æŒ‡ä»¤æ•ˆæœ
    applyCommandEffect(command, p);
    // æ¸…é™¤è£…å¡«çŠ¶æ€
    battle.commandArmed = null;
    // åˆ·æ–°æ‚¬æµ®çª—
    if (typeof window.refreshCommanderBubble === 'function') {
        window.refreshCommanderBubble();
    }
    return true;
};
// ä¿ç•™æ—§çš„ triggerCommand ä½œä¸ºå…¼å®¹ï¼Œä½†æ”¹ä¸ºè°ƒç”¨ armCommand
window.triggerCommand = function(command) {
    window.armCommand(command);
};
/**
 * åº”ç”¨æŒ‡ä»¤æ•ˆæœ
 * @param {string} command - æŒ‡ä»¤ç±»å‹
 * @param {Pokemon} pokemon - ç›®æ ‡å®å¯æ¢¦
 */
function applyCommandEffect(command, pokemon) {
    switch (command) {
        case 'dodge':
            // é—ªé¿ï¼šæœ¬å›åˆé—ªé¿ç‡ç¿»å€ï¼ˆåœ¨ battle-calc.js ä¸­æ£€æŸ¥ï¼‰
            pokemon.commandDodgeActive = true;
            break;
        case 'crit':
            // æš´å‡»ï¼šä¸‹æ¬¡æ”»å‡»å¿…å®šæš´å‡»ï¼ˆåœ¨ battle-calc.js ä¸­æ£€æŸ¥ï¼‰
            pokemon.commandCritActive = true;
            break;
        case 'cure':
            // LISTEN! è§£æ§ï¼šæ¦‚ç‡æ¸…é™¤ç•ç¼©/æ··ä¹±/ç€è¿·
            // åŸºç¡€ 40% + Devotion AVS 50%ï¼ˆæ»¡å€¼æ—¶ 90%ï¼‰
            let listenChance = 0.40; // åŸºç¡€ 40%
            // Devotion AVS åŠ æˆï¼šæ»¡å€¼ 255 æ—¶ +50%
            // ã€å…¨å±€å¼€å…³ã€‘ä½¿ç”¨ getEffectiveAVs æ£€æŸ¥æœ‰æ•ˆå€¼
            if (pokemon.isAce && pokemon.avs) {
                const baseDevotion = pokemon.getEffectiveAVs('devotion');
                if (baseDevotion > 0) {
                    const effectiveDevotion = pokemon.avsEvolutionBoost ? baseDevotion * 2 : baseDevotion;
                    const devotionBonus = (Math.min(effectiveDevotion, 255) / 255) * 0.50;
                    listenChance += devotionBonus;
                    console.log(`[COMMANDER] LISTEN! Devotion åŠ æˆ: +${(devotionBonus * 100).toFixed(1)}% (Devotion: ${baseDevotion})`);
                }
            }
            listenChance = Math.min(listenChance, 1.0); // ä¸Šé™ 100%
            const listenRoll = Math.random();
            console.log(`[COMMANDER] LISTEN! Roll: ${(listenRoll * 100).toFixed(1)}% vs Chance: ${(listenChance * 100).toFixed(1)}%`);
            if (listenRoll < listenChance) {
                // æˆåŠŸï¼šæ¸…é™¤è´Ÿé¢çŠ¶æ€
                let cured = false;
                if (pokemon.volatile) {
                    if (pokemon.volatile.flinch) {
                        delete pokemon.volatile.flinch;
                        cured = true;
                    }
                    if (pokemon.volatile.confusion) {
                        delete pokemon.volatile.confusion;
                        delete pokemon.volatile.confusionTurns;
                        cured = true;
                    }
                    if (pokemon.volatile.attract) {
                        delete pokemon.volatile.attract;
                        cured = true;
                    }
                }
                if (cured) {
                    log(`<b style="color:#f1c40f">ğŸ’« ${pokemon.cnName} æ¢å¤äº†æ¸…é†’ï¼</b>`);
                }
                // æœ¬å›åˆæ”»å‡»ä¸å—è´Ÿé¢çŠ¶æ€å½±å“
                pokemon.commandCureActive = true;
                log(`<b style="color:#ff9f43; text-shadow:0 0 8px #ff9f43;">ğŸ¤ LISTEN! æŒ‡ä»¤æˆåŠŸï¼${pokemon.cnName} å¬ä»äº†è®­ç»ƒå®¶çš„æŒ‡æŒ¥ï¼</b>`);
            } else {
                log(`<span style="color:#ef4444;">LISTEN! æŒ‡ä»¤å¤±è´¥...${pokemon.cnName} æ²¡èƒ½å¬åˆ°è®­ç»ƒå®¶çš„å£°éŸ³...</span>`);
            }
            break;
        case 'endure':
            // æŒºä½ï¼šæœ¬å›åˆæ”¶åˆ°è‡´å‘½ä¼¤å¿…å®šä¿ç•™ 1 HPï¼ˆåœ¨ takeDamage ä¸­æ£€æŸ¥ï¼‰
            pokemon.commandEndureActive = true;
            break;
    }
}
/**
 * å›åˆç»“æŸæ—¶æ¸…ç†æŒ‡ä»¤çŠ¶æ€
 */
function clearCommandEffects() {
    const p = battle.getPlayer();
    if (p) {
        p.commandDodgeActive = false;
        p.commandCritActive = false;
        p.commandCureActive = false;
        p.commandEndureActive = false;
    }
    // æ¸…é™¤æ´»è·ƒæŒ‡ä»¤
    battle.activeCommand = null;
    // å‡å°‘å†·å´
    if (battle.commandCooldown > 0) {
        battle.commandCooldown--;
    }
}
// ============================================
// ã€ç¯å¢ƒå›¾å±‚ç³»ç»Ÿã€‘è¾…åŠ©å‡½æ•° - ç”Ÿæˆæè¿°æ–‡å­—
// ============================================
/**
 * è·å–ç›®æ ‡é€‰æ‹©å™¨çš„ä¸­æ–‡æè¿°
 * @private
 */
function _getTargetDescription(target) {
    if (!target) return 'å…¨ä½“';
    switch (target.type) {
        case 'all': return 'å…¨ä½“';
        case 'pokemonType': return `${target.value}ç³»å®å¯æ¢¦`;
        case 'moveType': return `${target.value}ç³»æŠ€èƒ½`;
        case 'moveFlag': return `${target.value}ç±»æŠ€èƒ½`;
        case 'side': return target.value === 'player' ? 'ç©å®¶æ–¹' : 'æ•Œæ–¹';
        case 'not': return `é(${_getTargetDescription(target.inner)})`;
        case 'hasAbility': return `æ‹¥æœ‰${target.value}ç‰¹æ€§`;
        case 'hasItem': return `æŒæœ‰${target.value}`;
        case 'grounded': return 'æ¥åœ°å®å¯æ¢¦';
        case 'and': 
            return target.conditions?.map(c => _getTargetDescription(c)).join('ä¸”') || 'å…¨ä½“';
        case 'or':
            return target.conditions?.map(c => _getTargetDescription(c)).join('/') || 'å…¨ä½“';
        default: return 'å…¨ä½“';
    }
}
/**
 * è·å–æ•ˆæœçš„ä¸­æ–‡æè¿°
 * @private
 */
function _getEffectsDescription(effects) {
    if (!effects) return '';
    const parts = [];
    // çŠ¶æ€åæ˜ å°„
    const statusNames = {
        'brn': 'ç¼ä¼¤', 'burn': 'ç¼ä¼¤',
        'psn': 'ä¸­æ¯’', 'poison': 'ä¸­æ¯’',
        'tox': 'å‰§æ¯’', 'toxic': 'å‰§æ¯’',
        'par': 'éº»ç—¹', 'paralysis': 'éº»ç—¹',
        'frz': 'å†°å†»', 'freeze': 'å†°å†»',
        'slp': 'ç¡çœ ', 'sleep': 'ç¡çœ ',
        'confusion': 'æ··ä¹±'
    };
    // æ•°å€¼ä¿®æ­£
    const statNames = { atk: 'æ”»å‡»', def: 'é˜²å¾¡', spa: 'ç‰¹æ”»', spd: 'ç‰¹é˜²', spe: 'é€Ÿåº¦' };
    for (const [stat, mult] of Object.entries(effects.statMods || {})) {
        const name = statNames[stat] || stat;
        if (mult > 1) parts.push(`${name}+${Math.round((mult - 1) * 100)}%`);
        else if (mult < 1) parts.push(`${name}-${Math.round((1 - mult) * 100)}%`);
    }
    // HP è·³åŠ¨
    if (effects.hpChange > 0) parts.push(`æ¯å›åˆå›å¤${Math.round(effects.hpChange * 100)}%HP`);
    if (effects.hpChange < 0) parts.push(`æ¯å›åˆæŸå¤±${Math.round(Math.abs(effects.hpChange) * 100)}%HP`);
    // ä¼¤å®³ä¿®æ­£
    if (effects.dmgMod && effects.dmgMod !== 1) {
        if (effects.dmgMod > 1) parts.push(`ä¼¤å®³+${Math.round((effects.dmgMod - 1) * 100)}%`);
        else parts.push(`ä¼¤å®³-${Math.round((1 - effects.dmgMod) * 100)}%`);
    }
    // æš´å‡»ç­‰çº§ä¿®æ­£
    if (effects.critStage && effects.critStage !== 0) {
        if (effects.critStage > 0) parts.push(`æš´å‡»ç‡+${effects.critStage}çº§`);
        else parts.push(`æš´å‡»ç‡${effects.critStage}çº§`);
    }
    // é—ªé¿ç­‰çº§ä¿®æ­£
    if (effects.evasionStage && effects.evasionStage !== 0) {
        if (effects.evasionStage > 0) parts.push(`é—ªé¿+${effects.evasionStage}çº§`);
        else parts.push(`é—ªé¿${effects.evasionStage}çº§`);
    }
    // å‘½ä¸­ä¿®æ­£
    if (effects.accMod && effects.accMod !== 1) {
        if (effects.accMod > 1) parts.push(`å‘½ä¸­+${Math.round((effects.accMod - 1) * 100)}%`);
        else parts.push(`å‘½ä¸­-${Math.round((1 - effects.accMod) * 100)}%`);
    }
    // å›å¤ä¿®æ­£
    if (effects.healMod && effects.healMod !== 1) {
        if (effects.healMod > 1) parts.push(`å›å¤+${Math.round((effects.healMod - 1) * 100)}%`);
        else parts.push(`å›å¤-${Math.round((1 - effects.healMod) * 100)}%`);
    }
    // å¸è¡€æ•ˆç‡ä¿®æ­£
    if (effects.drainMod && effects.drainMod !== 1) {
        if (effects.drainMod > 1) parts.push(`å¸è¡€+${Math.round((effects.drainMod - 1) * 100)}%`);
        else parts.push(`å¸è¡€-${Math.round((1 - effects.drainMod) * 100)}%`);
    }
    // ç¯å¢ƒåä¼¤
    if (effects.envRecoil) {
        const chance = Math.round(effects.envRecoil.chance * 100);
        const damage = Math.round(effects.envRecoil.damage * 100);
        parts.push(`${chance}%æ¦‚ç‡${damage}%åä¼¤`);
    }
    // ç¦ç”¨é“å…·
    if (effects.banItems?.length) {
        parts.push(`ç¦ç”¨${effects.banItems.join('/')}`);
    }
    // ç±»å‹æ•ˆæœ
    if (effects.immuneTypes?.length) parts.push(`å…ç–«${effects.immuneTypes.join('/')}`);
    if (effects.weakTypes?.length) parts.push(`å¼±ç‚¹${effects.weakTypes.join('/')}`);
    if (effects.banTypes?.length) parts.push(`ç¦ç”¨${effects.banTypes.join('/')}ç³»æŠ€èƒ½`);
    // çŠ¶æ€æ²»æ„ˆ
    if (effects.cureStatus?.length) {
        const cureDescs = effects.cureStatus.map(c => {
            const statusName = statusNames[c.status] || c.status;
            const chance = Math.round(c.chance * 100);
            return chance === 100 ? statusName : `${statusName}(${chance}%)`;
        });
        parts.push(`æ²»æ„ˆ${cureDescs.join('/')}`);
    }
    // çŠ¶æ€é˜»æ­¢
    if (effects.preventStatus?.length) {
        const preventNames = effects.preventStatus.map(s => statusNames[s] || s).join('/');
        parts.push(`é˜»æ­¢${preventNames}`);
    }
    // çŠ¶æ€å…ç–«
    if (effects.immuneStatus?.length) {
        const immuneNames = effects.immuneStatus.map(s => statusNames[s] || s).join('/');
        parts.push(`å…ç–«${immuneNames}`);
    }
    // çŠ¶æ€æ–½åŠ 
    if (effects.inflictStatus && effects.inflictChance > 0) {
        const statusName = statusNames[effects.inflictStatus] || effects.inflictStatus;
        const chance = Math.round(effects.inflictChance * 100);
        parts.push(`${chance}%å‡ ç‡æ–½åŠ ${statusName}`);
    }
    return parts.join(', ');
}
// å¯¼å‡ºåˆ°å…¨å±€
window.initCommanderSystem = initCommanderSystem;
window.shouldShowCommanderMenu = shouldShowCommanderMenu;
window.showCommanderMenu = showCommanderMenu;
window.closeCommanderMenu = closeCommanderMenu;
window.clearCommandEffects = clearCommandEffects;
window._getTargetDescription = _getTargetDescription;
window._getEffectsDescription = _getEffectsDescription;
]]></file>
    <file name="main.js"><![CDATA[/**
 * ===========================================
 * MAIN.JS - ES Module å…¥å£æ–‡ä»¶
 * ===========================================
 * 
 * èšåˆæ‰€æœ‰æ¨¡å—å¹¶æŒ‚è½½åˆ° window ä»¥ä¿æŒå‘åå…¼å®¹
 * 
 * ä½¿ç”¨æ–¹æ³•:
 *   <script type="module" src="./main.js"></script>
 */
// ============================================
// æ•°æ®å±‚å¯¼å…¥
// ============================================
import { POKEDEX } from './data/pokedex-data.js';
import { MOVES } from './data/moves-data.js';
import {
    TRAPPING_MOVES,
    AI_PROTECT_MOVES,
    FORM_SUFFIXES,
    FALLBACK_MOVES,
    GMAX_SPECIES_DATA,
    GENERIC_MAX_BY_TYPE,
    GENERIC_MAX_CN
} from './data/move-constants.js';
import {
    ITEMS,
    UNSWAPPABLE_ITEMS,
    ItemEffects,
    getItem,
    getItemId,
    getAllPokeballs,
    getAllBerries,
    isChoiceItem,
    isMegaStone,
    isZCrystal,
    isSwappable
} from './engine/items-data.js';
import { TRAINER_GLOBALS } from './data/trainer-data.js';
// ============================================
// å¼•æ“å±‚å¯¼å…¥ (Phase 2: çº¯å‡½æ•°)
// ============================================
import {
    TYPE_CHART,
    NATURE_MODIFIERS,
    getTypeEffectiveness,
    getPokemonData,
    getMoveData,
    calcStats,
    Pokemon,
    BattleState,
    checkCanMove,
    clearVolatileStatus,
    extractBaseFormId,
    resolveSpriteId,
    getFallbackSpriteId,
    normalizePokemonName
} from './engine/battle-engine.js';
import {
    AbilityHandlers,
    isPinching,
    moveHasFlag,
    checkCanSwitch
} from './engine/ability-handlers.js';
import {
    MoveHandlers,
    getMoveHandler,
    hasMoveHandler,
    canKnockOff
} from './engine/move-handlers.js';
import { calcDamage } from './battle/battle-calc.js';
// ============================================
// æŒ‚è½½åˆ° window (å‘åå…¼å®¹)
// ============================================
// æ•°æ®å¸¸é‡
window.POKEDEX = POKEDEX;
window.MOVES = MOVES;
window.Moves = MOVES; // åˆ«åï¼Œéƒ¨åˆ†ä»£ç ä½¿ç”¨ window.Moves
// æ‹›å¼å¸¸é‡
window.TRAPPING_MOVES = TRAPPING_MOVES;
window.AI_PROTECT_MOVES = AI_PROTECT_MOVES;
window.FORM_SUFFIXES = FORM_SUFFIXES;
window.FALLBACK_MOVES = FALLBACK_MOVES;
window.GMAX_SPECIES_DATA = GMAX_SPECIES_DATA;
window.GENERIC_MAX_BY_TYPE = GENERIC_MAX_BY_TYPE;
window.GENERIC_MAX_CN = GENERIC_MAX_CN;
window.MOVE_CONSTANTS = {
    TRAPPING_MOVES,
    AI_PROTECT_MOVES,
    FORM_SUFFIXES,
    FALLBACK_MOVES,
    GMAX_SPECIES_DATA,
    GENERIC_MAX_BY_TYPE,
    GENERIC_MAX_CN
};
// é“å…·
window.ITEMS = ITEMS;
window.UNSWAPPABLE_ITEMS = UNSWAPPABLE_ITEMS;
window.ItemEffects = ItemEffects;
window.getItem = getItem;
window.getItemId = getItemId;
window.getAllPokeballs = getAllPokeballs;
window.getAllBerries = getAllBerries;
window.isChoiceItem = isChoiceItem;
window.isMegaStone = isMegaStone;
window.isZCrystal = isZCrystal;
window.isSwappable = isSwappable;
// è®­ç»ƒå®¶æ•°æ®
window.TRAINER_GLOBALS = TRAINER_GLOBALS;
// ============================================
// å¼•æ“å±‚æŒ‚è½½ (Phase 2)
// ============================================
// å±æ€§å…‹åˆ¶
window.TYPE_CHART = TYPE_CHART;
window.NATURE_MODIFIERS = NATURE_MODIFIERS;
window.getTypeEffectiveness = getTypeEffectiveness;
// æ•°æ®æŸ¥è¯¢
window.getPokemonData = getPokemonData;
window.getMoveData = getMoveData;
window.calcStats = calcStats;
window.Pokemon = Pokemon;
// ç²¾çµå›¾è¾…åŠ©
window.extractBaseFormId = extractBaseFormId;
window.resolveSpriteId = resolveSpriteId;
window.getFallbackSpriteId = getFallbackSpriteId;
window.normalizePokemonName = normalizePokemonName;
// ç‰¹æ€§å¤„ç†å™¨
window.AbilityHandlers = AbilityHandlers;
window.isPinching = isPinching;
window.moveHasFlag = moveHasFlag;
window.checkCanSwitch = checkCanSwitch;
// æ‹›å¼å¤„ç†å™¨
window.MoveHandlers = MoveHandlers;
window.getMoveHandler = getMoveHandler;
window.hasMoveHandler = hasMoveHandler;
window.canKnockOff = canKnockOff;
// ä¼¤å®³è®¡ç®—
window.calcDamage = calcDamage;
// æˆ˜æ–—çŠ¶æ€ç®¡ç† (Phase 3)
window.BattleState = BattleState;
window.checkCanMove = checkCanMove;
window.clearVolatileStatus = clearVolatileStatus;
console.log('[ES Module] æ•°æ®å±‚æ¨¡å—åŠ è½½å®Œæˆ');
console.log('[ES Module] POKEDEX entries:', Object.keys(POKEDEX).length);
console.log('[ES Module] MOVES entries:', Object.keys(MOVES).length);
console.log('[ES Module] ITEMS entries:', Object.keys(ITEMS).length);
]]></file>
    <file name="package.json"><![CDATA[{
  "name": "pkm12",
  "version": "1.0.0",
  "description": "æœ¬é¡¹ç›® æ˜¯ä¸€ä¸ªåŸºäº Web æŠ€æœ¯çš„å®å¯æ¢¦å¯¹æˆ˜æ¨¡æ‹Ÿå¼•æ“ã€‚æœ¬é¡¹ç›®çš„å®ç°ç¦»ä¸å¼€å¼€æºç¤¾åŒºçš„æ— ç§è´¡çŒ®ã€ä¼˜ç§€çš„èµ„æºæ•´ç†è€…ä»¥åŠåŸå§‹ç‰ˆæƒæ‰€æœ‰è€…çš„åˆ›ä½œã€‚",
  "main": "index.js",
  "directories": {
    "doc": "docs"
  },
  "scripts": {
    "dev": "vite",
    "build": "vite build && cp -r data dist/",
    "preview": "vite preview",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "type": "module",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/hasheeper/pkm33.git"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "bugs": {
    "url": "https://github.com/hasheeper/pkm33/issues"
  },
  "homepage": "https://github.com/hasheeper/pkm33#readme",
  "devDependencies": {
    "vite": "^7.3.1"
  }
}
]]></file>
    <file name="README.md"><![CDATA[
# è‡´è°¢åå• (Credits & Acknowledgments)
æœ¬é¡¹ç›® æ˜¯ä¸€ä¸ªåŸºäº Web æŠ€æœ¯çš„å®å¯æ¢¦å¯¹æˆ˜æ¨¡æ‹Ÿå¼•æ“ã€‚æœ¬é¡¹ç›®çš„å®ç°ç¦»ä¸å¼€å¼€æºç¤¾åŒºçš„æ— ç§è´¡çŒ®ã€ä¼˜ç§€çš„èµ„æºæ•´ç†è€…ä»¥åŠåŸå§‹ç‰ˆæƒæ‰€æœ‰è€…çš„åˆ›ä½œã€‚
ä»¥ä¸‹æ˜¯æœ¬é¡¹ç›®å¼•ç”¨çš„èµ„æºåˆ—è¡¨åŠè‡´è°¢ã€‚
## ğŸ› ï¸ æ ¸å¿ƒæ•°æ®ä¸å¼•æ“æœºåˆ¶ / Core Data & Mechanics
æœ¬é¡¹ç›®çš„å¤§éƒ¨åˆ†æˆ˜æ–—æ•°æ®ã€ä¼¤å®³è®¡ç®—å…¬å¼åŠåŸºç¡€é€»è¾‘é«˜åº¦å‚è€ƒå¹¶ç§»æ¤è‡ª **PokÃ©mon Showdown** é¡¹ç›®ã€‚
*   **PokÃ©mon Showdown**: [https://pokemonshowdown.com/](https://pokemonshowdown.com/)
:   **Github**: [smogon/pokemon-showdown](https://github.com/smogon/pokemon-showdown)
    *   å¼•ç”¨äº† `data/` ç›®å½•ä¸‹çš„å®å¯æ¢¦ç§æ—å€¼ (Pokedex)ã€æ‹›å¼æ•°æ® (Moves)ã€ç‰¹æ€§æ•°æ® (Abilities) åŠé“å…·ä¿¡æ¯ (Items)ã€‚
    *   å‚è€ƒäº†å…¶ä¼¤å®³è®¡ç®—é€»è¾‘ (Damage Calc) ä¸çŠ¶æ€æœºåˆ¶å¤„ç†ã€‚
## ğŸ‡¨ğŸ‡³ æœ¬åœ°åŒ–ä¸ç¿»è¯‘ / Localization
æœ¬é¡¹ç›®ä½¿ç”¨çš„ä¸­æ–‡æŠ€èƒ½ã€ç‰¹æ€§åŠæè¿°æ–‡æœ¬ï¼Œç”± **PSChina (Pokemon Showdown China)** ç¤¾åŒºåŠå…¶è´¡çŒ®è€…æ•´ç†åˆ¶ä½œã€‚
*   **Showdown Translation (Tampermonkey Script)**
    *   **è„šæœ¬ä½œè€… (Author)**: Ceca3
    *   **é¡¹ç›®æ¥æº**: PSChina Server Translation (å‰‘ç›¾æµ‹è¯•å…ˆè¡Œç‰ˆ)
    *   **è´¡çŒ®**: æ ¸å¿ƒçš„â€œä¸­-è‹±â€æ˜ å°„å­—å…¸ï¼ˆæ±‰åŒ–æ•°æ®åº“ï¼‰ç›´æ¥å–æäºè¯¥é¡¹ç›®çš„ç»è¿‡ç¤¾åŒºé•¿æœŸéªŒè¯çš„ç¿»è¯‘æ•°æ®ã€‚
    *   ç‰¹åˆ«æ„Ÿè°¢ PSChina ç¤¾åŒºå¯¹å®å¯æ¢¦å¯¹æˆ˜ä¸­æ–‡åŒ–åšå‡ºçš„å“è¶Šè´¡çŒ®ã€‚
## ğŸ¨ ç¾æœ¯èµ„æº / Visual Assets
æœ¬é¡¹ç›®æ²¡æœ‰æ‰˜ç®¡åºå¤§çš„å›¾ç‰‡æ•°æ®åº“ï¼Œè€Œæ˜¯ä½¿ç”¨åŠ¨æ€åŠ è½½æŠ€æœ¯å¼•ç”¨äº†ä»¥ä¸‹ä¼˜ç§€çš„å…¬å…±èµ„æºåº“ï¼Œä»¥åŠéƒ¨åˆ† UI è®¾è®¡çµæ„Ÿå¼•ç”¨ã€‚
**ç²¾çµå›¾ä¸å›¾æ ‡ (Sprites & Icons)**
*   **PokÃ©mon Showdown Sprite Library**: [play.pokemonshowdown.com](https://play.pokemonshowdown.com/sprites/)
    *   æä¾›äº† Gen 1-5 çš„åŠ¨æ€åƒç´ å›¾ (Animated Sprites) åŠ Gen 6+ çš„é™æ€æ¨¡å‹å›¾ã€‚
*   **PkParaiso**: [pkparaiso.com](https://www.pkparaiso.com/)
    *   æä¾›äº†éƒ¨åˆ†é«˜ä¸–ä»£çš„é«˜è´¨é‡ 3D æ¨¡å‹åŠ¨æ€ GIFï¼Œç”¨äºæˆ˜æ–—æ¼”å‡ºã€‚
*   **PokÃ©Sprite**: [github.com/msikma/pokesprite](https://github.com/msikma/pokesprite)
    *   æä¾›äº†æå…¶å®Œå–„çš„å®å¯æ¢¦èœå•å›¾æ ‡ (PC Box Icons) å’Œé“å…·å›¾æ ‡æ•°æ®ã€‚
**UI è®¾è®¡ (interface Design)**
*   **é£æ ¼è‡´æ•¬**:
    *   æœ¬é¡¹ç›® UI é£æ ¼æ··åˆäº† **ã€Šå®å¯æ¢¦ï¼šå‰‘/ç›¾ (PokÃ©mon Sword & Shield)ã€‹** çš„æ‰å¹³åŒ–ç«æŠ€åœºé£æ ¼ä¸ **ã€Šå¥³ç¥å¼‚é—»å½•5 (Persona 5)ã€‹** çš„åŠ¨æ€å‰ªåˆ‡é£æ ¼ã€‚
    *   å¤æ­¦ç³»ç»Ÿ (Styles) UI è‡´æ•¬äº† **ã€Šå®å¯æ¢¦ä¼ è¯´ï¼šé˜¿å°”å®™æ–¯ (PokÃ©mon Legends: Arceus)ã€‹**ã€‚
## ğŸµ éŸ³æ•ˆä¸éŸ³ä¹ / Audio & BGM
*   **å®å¯æ¢¦å«å£° (Cries)**:
    *   éŸ³é¢‘æ–‡ä»¶åŠ¨æ€è¯·æ±‚è‡ª `play.pokemonshowdown.com/audio/cries/`ã€‚
*   **èƒŒæ™¯éŸ³ä¹ (BGM) & éŸ³æ•ˆ (SFX)**:
    *   ç‰ˆæƒå½’å±äº **Nintendo (ä»»å¤©å ‚)**, **Game Freak**, **The PokÃ©mon Company** åŠåŸä½œæ›²å®¶ï¼ˆä¸€ä¹‹æ¿‘åˆš, å¢ç”°é¡ºä¸€ç­‰ï¼‰ã€‚æœ¬é¡¹ç›®ä»…åšå­¦ä¹ ä¸æ¼”ç¤ºç”¨é€”ä½¿ç”¨ã€‚
## âš–ï¸ å…è´£å£°æ˜ / Disclaimer
**PokÃ©monÂ®**, **PokÃ©mon Character Names**, **NintendoÂ®**, **Game Freak**, and **The PokÃ©mon Company** are trademarks of **Nintendo**.
æœ¬é¡¹ç›® æ˜¯ä¸€ä¸ªéè¥åˆ©æ€§çš„ã€å¼€æºçš„ç²‰ä¸è‡ªåˆ¶é¡¹ç›® (Fan-made Project)ã€‚
*   æœ¬è½¯ä»¶å®Œå…¨å…è´¹ï¼Œä¸ç”¨äºä»»ä½•å•†ä¸šç›®çš„ã€‚
*   æ‰€æœ‰ä¸ã€Šå®å¯æ¢¦ã€‹ç›¸å…³çš„åŸæ–‡è®¾å®šã€å›¾åƒã€éŸ³é¢‘æ–‡ä»¶çš„ç‰ˆæƒå‡å½’ç‰ˆæƒæ–¹æ‰€æœ‰ã€‚
*   å¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»å¼€å‘è€…åˆ é™¤ç›¸å…³å†…å®¹ã€‚
---
*This file was generated to respect and credit the hard work of the community.*]]></file>
</pkm_project>